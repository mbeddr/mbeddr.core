// cbmc properties
ext.cbmcMajor = "0.9"
ext.cbmcMinor = "1"
ext.cbmc_groupId = "org.cprover"
ext.cbmc_artifactId_mac = "cbmc-mac"
ext.cbmc_artifactId_linux = "cbmc-linux"
ext.cbmc_artifactId_win = "cbmc-win"
ext.cbmc_version = mbeddrMajor + "." + mbeddrMinor + "-SNAPSHOT"
ext.cbmc_resolveDir = "/cbmc/"

// download jre credentials
ext.serverUser = project.hasProperty('serverUser') ? project.getProperty('serverUser') : '<user>'
ext.serverPassword = project.hasProperty('serverPassword') ? project.getProperty('serverPassword') : '<password>'

// TODO package cbmc
//    cbmcLinux group: cbmc_groupId, name: cbmc_artifactId_linux, version: cbmc_version
//    cbmcMac group: cbmc_groupId, name: cbmc_artifactId_mac, version: cbmc_version
//    cbmcWin group: cbmc_groupId, name: cbmc_artifactId_win, version: cbmc_version

configurations {
    mbeddrAllInOne {
        description = 'mbeddr allInOne'
    }

    mbeddr {
        description = 'mbeddr'
    }
    mbeddrPlatform {
        description = 'mbeddr platform distribution'
    }
    mbeddrRcp {
        description = 'mbeddr rcp'
    }
    mbeddrJre {
        description = 'jre used for rcp'
    }
    mbeddrDmg {
        description = 'mbeddr dmg for mac'
    }
    cbmcWin {
        description = 'cbmc windows'
    }
    cbmcLinux {
        description = 'cbmc linux'
    }
    cbmcMac {
        description = 'cbmc mac'
    }
    mbeddrTutorial {
        description = 'mbeddr tutorial'
    }
}



// :build:com.mbeddr.tests

import org.apache.tools.ant.taskdefs.condition.Os


def cbmc_linux_tar = "cbmc-linux.tar.gz"
def cbmc_mac_zip = "cbmc-mac.zip"
def cbmc_win_zip = "cbmc-win.zip"





task resolve_cbmc() << { }

if(Os.isFamily(Os.FAMILY_UNIX) && !Os.isFamily(Os.FAMILY_MAC)) {
    resolve_cbmc.dependsOn 'unzip_cbmcLinuxTar'
} else if(Os.isFamily(Os.FAMILY_WINDOWS)) {
    resolve_cbmc.dependsOn 'unzip_cbmcWinZip'
} else {
    resolve_cbmc.dependsOn 'unzip_cbmcMacZip'
}

task resolve_cbmcLinux(type: Copy)  {
    from {
        configurations.cbmcLinux.collect { zipTree(it) }
    }
    into rootProject.projectDir.absolutePath + cbmc_resolveDir
}

task unzip_cbmcLinuxTar(type: Copy, dependsOn: resolve_cbmcLinux)  {
    from tarTree(rootProject.projectDir.absolutePath + cbmc_resolveDir + cbmc_linux_tar)
    into file(rootProject.projectDir.absolutePath + cbmc_resolveDir)
}

task resolve_cbmcMac(type: Copy)  {
    from {
        configurations.cbmcMac.collect { zipTree(it) }
    }
    into rootProject.projectDir.absolutePath + cbmc_resolveDir
}

task unzip_cbmcMacZip(type: Copy, dependsOn: resolve_cbmcMac)  {
    from zipTree(rootProject.projectDir.absolutePath + cbmc_resolveDir + cbmc_mac_zip)
    into file(rootProject.projectDir.absolutePath + cbmc_resolveDir)
}

task resolve_cbmcWin(type: Copy)  {
    from {
        configurations.cbmcWin.collect { zipTree(it) }
    }
    into rootProject.projectDir.absolutePath + cbmc_resolveDir
}

task unzip_cbmcWinZip(type: Copy, dependsOn: resolve_cbmcWin)  {
    from zipTree(rootProject.projectDir.absolutePath + cbmc_resolveDir + cbmc_win_zip)
    into file(rootProject.projectDir.absolutePath + cbmc_resolveDir)
}

// :build:com.mbeddr.allInOne
publishing {
    publications {
        mbeddrAllInOne(MavenPublication) {
            groupId 'com.mbeddr'
            artifactId 'allInOne'
            version mbeddrBuildNumber
            artifact(publish_all_in_one) {}
        }
    }
}

publishing {
    publications {
        mbeddr(MavenPublication) {
            groupId 'com.mbeddr'
            artifactId 'mbeddr'
            version mbeddrBuildNumber
            artifact(publish_mbeddr) {}
        }
    }
}

def script_build_mbeddrAllInOne = new File(scriptsBasePath + "/com.mbeddr.allInOne/" + "build.xml")

    task build_all_in_one(type: BuildLanguages, dependsOn: ':build:com.mbeddr:platform:copy_allScripts') {
    script script_build_mbeddrAllInOne
}

task publish_all_in_one(type: Zip, dependsOn: build_all_in_one) {
    from rootProject.projectDir.absolutePath + "/artifacts/"
    include "com.mbeddr.allInOne/com.mbeddr.allInOne.zip"
}

task publish_mbeddr(type: Zip, dependsOn: build_all_in_one) {
    from rootProject.projectDir.absolutePath + "/artifacts/mbeddr"
    include "*.zip"
}

// :build:com.mbeddr.rcp
publishing {
    publications {
        mbeddrRcp(MavenPublication) {
            groupId 'com.mbeddr'
            artifactId 'rcp'
            version mbeddrBuildNumber
            artifact(publish_mbeddrRCP) {}
        }
        mbeddrJre(MavenPublication) {
            groupId 'com.mbeddr'
            artifactId 'jre'
            version mbeddrBuildNumber
            artifact(publish_JRE) {}
        }
    }
}
def script_build_mbeddrRCPMPS = new File(scriptsBasePath + "/com.mbeddr.rcp/" + "mps.xml")
def script_build_mbeddrRCPDistribution = new File(scriptsBasePath + "/com.mbeddr.rcp/" + "mpsDistribution.xml")
def script_build_mbeddrJRE = new File(rootProject.projectDir.absolutePath + "/buildUtil/" + "build.xml")

task build_mbeddrRCP(type: BuildLanguages, dependsOn: [
        ':build:com.mbeddr:platform:resolve_mps', ':build:com.mbeddr:platform:build_allScripts',
        'resolveAllInOne', 'unzipTutorial']) {
    script script_build_mbeddrRCPMPS
}

task build_mbeddrRCPDistributuion(type: RunMbeddrAntScript, dependsOn: build_mbeddrRCP) {
    script script_build_mbeddrRCPDistribution
    targets 'clean', 'assemble'
}

task publish_mbeddrRCP(type: Zip, dependsOn: build_mbeddrRCPDistributuion) {
    from rootProject.projectDir.absolutePath + "/artifacts/mpsDistribution"
    include "*.zip"
    include "*.tar.gz"
}

// invoke this task from the cmd via 'gradle download_jre -PserverUser=<user> -PserverPassword=<password>'
task download_JRE(type: Exec) {
    workingDir rootProject.projectDir
    def args = ['-Dserver.user='+serverUser, '-Dserver.password='+serverPassword, '-f', script_build_mbeddrJRE]
    commandLine('ant', *args, 'get-jdk')
}

task publish_JRE(type: Zip, dependsOn: download_JRE) {
    from rootProject.projectDir.absolutePath + "/buildUtil"
    include "jdk.zip"
    include "jdk..tar.gz"
}

// :build:com.mbeddr.release
publishing {
    publications {
        mbeddrDmg(MavenPublication) {
            groupId 'com.mbeddr'
            artifactId 'dmg'
            version mbeddrBuildNumber
            artifact(publish_mbeddr_dmg) {}
        }
        mbeddrInstaller(MavenPublication) {
            groupId 'com.mbeddr'
            artifactId 'installer'
            version mbeddrBuildNumber
            artifact(publish_installer) {}
        }
    }
}
def script_build_mbeddrDMG = new File(rootProject.projectDir.absolutePath + "/buildUtil/" + "build.xml")
def script_build_installer = new File(rootProject.projectDir.absolutePath + "/build/com.mbeddr.release/" + "build-installer.bat")


task resolveMacRCP(type: Copy) {
    from rootProject.projectDir.absolutePath + "/artifacts/mpsDistribution/"
    into rootProject.projectDir.absolutePath + "/buildUtil"
}

task package_dmg(type: Exec, dependsOn: resolveMacRCP) {
    workingDir rootProject.projectDir.absolutePath + "/buildUtil"
    def args = buildProcSpawnArgList(['ant', '-f', script_build_mbeddrDMG, 'macbuild'])
    commandLine (args)
}

task publish_mbeddr_dmg(type: Zip, dependsOn: package_dmg) {
    from rootProject.projectDir.absolutePath + "/buildUtil"
    include "*.dmg"
}

task copy_jdk(type: Copy) {
    from {
        zipTree(rootProject.projectDir.absolutePath + "/buildUtil/" + "jdk.zip")
    }
    into rootProject.projectDir.absolutePath + "/build/com.mbeddr.release/files/mbeddr/"
}

task copy_rcp(type: Copy) {
    from {
        zipTree(rootProject.projectDir.absolutePath + "/artifacts/mpsDistribution/" + "mbeddr-win.zip")
    }
    into rootProject.projectDir.absolutePath + "/build/com.mbeddr.release/files/mbeddr/"
}

task resolve_cbmcWinForInstaller(type: Copy)  {
    from {
        configurations.cbmcWin.collect { zipTree(it) }
    }
    into rootProject.projectDir.absolutePath + "/artifacts/cbmc"
}

task unzip_cbmcWinZipForInstaller(type: Copy, dependsOn: resolve_cbmcWinForInstaller)  {
    from zipTree(rootProject.projectDir.absolutePath + "/artifacts/cbmc/"+ "cbmc-win.zip")
    into file(rootProject.projectDir.absolutePath + "/build/com.mbeddr.release/files/3rd-party/cbmc")
}

task unzip_nsis(type: Copy) {
    from(zipTree(rootProject.projectDir.absolutePath + "/NSIS/NSIS.zip")) { }
    into rootProject.projectDir.absolutePath + "/build/com.mbeddr.release/NSIS/"
}

task build_installer(type: Exec, dependsOn: ['copy_jdk', 'copy_rcp', 'unzip_nsis', 'unzip_cbmcWinZipForInstaller']) {
    workingDir rootProject.projectDir.absolutePath + "/build/com.mbeddr.release"
    commandLine 'cmd', '/C', 'start', 'NSIS\\NSIS\\makensis.exe', 'mbeddr.nsi'
}

task publish_installer(type: Zip, dependsOn: build_installer) {
    from rootProject.projectDir.absolutePath + "/build/com.mbeddr.release/"
    include "*.exe"
}
// :build:com.mbeddr.analyses.cbmc
publishing {
    publications {
        cbmcMac(MavenPublication) {
            groupId cbmc_groupId
            artifactId cbmc_artifactId_mac
            version cbmc_version
            artifact(publish_cbmcMac) {}
        }
        cbmcLinux(MavenPublication) {
            groupId cbmc_groupId
            artifactId cbmc_artifactId_linux
            version cbmc_version
            artifact(publish_cbmcLinux) {}
        }
        cbmcWin(MavenPublication) {
            groupId cbmc_groupId
            artifactId cbmc_artifactId_win
            version cbmc_version
            artifact(publish_cbmcWin) {}
        }
    }
}
def script_build_cbmcWin = new File(rootProject.projectDir.absolutePath + "/build" + "/com.mbeddr.analyses.cbmc/" + "build-cbmc-win.bat")
def script_build_cbmcLinux = new File(rootProject.projectDir.absolutePath + "/build" + "/com.mbeddr.analyses.cbmc/" + "build-cbmc-linux.sh")
def script_build_cbmcMac = new File(rootProject.projectDir.absolutePath + "/build" + "/com.mbeddr.analyses.cbmc/" + "build-cbmc-mac.sh")

File cbmcSrcHome = file(rootProject.projectDir.absolutePath + "/../cbmc/src")
File cbmcHome = file(rootProject.projectDir.absolutePath + "/../cbmc/")

task build_cbmcWin(type: Exec) {
    workingDir cbmcSrcHome
    commandLine(script_build_cbmcWin)
}

task build_cbmcMac(type: Exec) {
    workingDir cbmcSrcHome
    def args = buildProcSpawnArgList([script_build_cbmcMac])
    commandLine(args)
}

task build_cbmcLinux(type: Exec) {
    workingDir cbmcSrcHome
    def args = buildProcSpawnArgList([script_build_cbmcLinux])
    commandLine(args)
}

task publish_cbmcWin(type: Zip) {
    from file(cbmcHome.absolutePath + "/" + "cbmc-win.zip")
}

task publish_cbmcMac(type: Zip) {
    from file(cbmcHome.absolutePath + "/" + "cbmc-mac.zip")
}

task publish_cbmcLinux(type: Zip) {
    from file(cbmcHome.absolutePath + "/" + "cbmc-linux.tar.gz")
}

task resolveAllInOne(type: Copy) {
    from {
        configurations.mbeddrAllInOne.collect { zipTree(it) }
    }
    into rootProject.projectDir.absolutePath + "/artifacts/"
}

task resolveTutorial(type: Copy)  {
    from {
        configurations.mbeddrTutorial.collect { zipTree(it) }
    }
    into rootProject.projectDir.absolutePath + "/artifacts"
}

task unzipTutorial(type: Copy, dependsOn: resolveTutorial)  {
    from zipTree(rootProject.projectDir.absolutePath + "/artifacts/" + "com.mbeddr.tutorial.zip")
    into file(rootProject.projectDir.absolutePath + "/artifacts/" + "com.mbeddr.tutorial")
}

def getVersionName = { ->
    def stdout = new ByteArrayOutputStream()
    exec {
        commandLine 'git', 'describe', '--tags'
        standardOutput = stdout
    }
    return stdout.toString().trim()
}

// :build:com.mbeddr.tutorial

publishing {
    publications {
        mbeddrTutorial(MavenPublication) {
            groupId 'com.mbeddr'
            artifactId 'tutorial'
            version mbeddrBuildNumber
            artifact(publish_mbeddrTutorial) {}
        }
    }
}



task package_tutorial(type: Zip) {
    from rootProject.projectDir.absolutePath + "/code/applications/tutorial"
    destinationDir  new File(rootProject.projectDir.absolutePath + "/artifacts/" + "com.mbeddr.tutorial")
    archiveName "com.mbeddr.tutorial.zip"
}

task publish_mbeddrTutorial(type: Zip, dependsOn: package_tutorial) {
    from rootProject.projectDir.absolutePath + "/artifacts/" + "com.mbeddr.tutorial"
}

// constructs the argument list that is used for spawning processes on linux/mac and windows
Iterable<String> buildProcSpawnArgList(Iterable<String> args) {
    List<String> newArguments = new ArrayList<String>()
    if(Os.isFamily(Os.FAMILY_WINDOWS)) {
        // we append the 'cmd /c' command in front
        newArguments.add(0,'cmd.exe')
        newArguments.add(1,'/c')
    }
    newArguments.addAll(args.toList())
    return newArguments
}
