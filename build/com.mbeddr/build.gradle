def userHome = System.properties['user.home']
def mpsPluginsDirPattern
def os_name = System.properties['os.name'].toLowerCase()
// calculate system-specific plugins directory (since MPS 2020.1) according to:
// https://www.jetbrains.com/help/idea/tuning-the-ide.html?_ga=2.229302868.95678467.1595072035-1152171669.1521775253#plugins-directory
if (os_name.contains('mac')) {
    mpsPluginsDirPattern = "$userHome/Library/Application Support/JetBrains/%s/plugins"
} else if (os_name.contains('win')) {
    mpsPluginsDirPattern = "${System.getenv('APPDATA')}\\JetBrains\\%s\\plugins"
} else {
    mpsPluginsDirPattern = "$userHome/.local/share/JetBrains/%s"
}

if (project.hasProperty("MPS_PATHS_SELECTOR")) {
    ext.mpsPluginsDir = sprintf(mpsPluginsDirPattern, project.getProperty("MPS_PATHS_SELECTOR"))
} else {
    ext.mpsPluginsDir = sprintf(mpsPluginsDirPattern, "MPS$mpsMajor")
}

task install() {
    // dependencies to this task are added dynamically from other scripts (com.mbeddr.platform, com.mbeddr.languages)
    description "Install the required plugins into the MPS plugin repository"
    group "Build Setup"
    doFirst {
        // check parent gradle file for definition of the variables
        println "Installing required mbeddr plugins to '$mpsPluginsDir'"
        if (!project.hasProperty("MPS_PATHS_SELECTOR")) {
            println "To change 'MPS<...>' part, pass MPS_PATHS_SELECTOR property to gradle with -PMPS_PATHS_SELECTOR=<custom path selector>"
            println "The path selector only contains the actual MPS version, for instance \"MPS2017.3\", not the full path to the user plugin directory."
        }
    }
}

// ant script locations
ext.scriptsBasePath = rootProject.file("scripts").absolutePath

ant.taskdef(name: "makeTests",
        classname: "com.mbeddr.tools.ant.MakeTestsTask",
        classpath: file(rootProject.projectDir.absolutePath + "/tools/ant/tasks/TeamcityMakeTests.jar")
)

task printVersions {
    doLast {
        println "mbeddrBuildNumber: $project.mbeddrBuildNumber"
        println "mbeddrPlatformBuildNumber: $project.mbeddrPlatformBuildNumber"
    }
}

task printRepositories {
    doLast {
        println "snapshotRepository: $snapshotRepository"
        println "releaseRepository: $releaseRepository"
        println "dependencyRepositories: $dependencyRepositories"
    }
}
