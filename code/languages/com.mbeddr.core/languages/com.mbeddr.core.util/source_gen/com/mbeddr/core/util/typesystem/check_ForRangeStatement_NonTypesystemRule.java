package com.mbeddr.core.util.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.runtime.AbstractNonTypesystemRule_Runtime;
import jetbrains.mps.lang.typesystem.runtime.NonTypesystemRule_Runtime;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import jetbrains.mps.lang.typesystem.runtime.IsApplicableStatus;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import com.mbeddr.core.base.behavior.ISuppressStaticEvalWarnings__BehaviorDescriptor;
import com.mbeddr.core.expressions.behavior.Expression__BehaviorDescriptor;
import java.math.BigInteger;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SEnumOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.errors.messageTargets.MessageTarget;
import jetbrains.mps.errors.messageTargets.NodeMessageTarget;
import jetbrains.mps.errors.IErrorReporter;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SProperty;

public class check_ForRangeStatement_NonTypesystemRule extends AbstractNonTypesystemRule_Runtime implements NonTypesystemRule_Runtime {
  public check_ForRangeStatement_NonTypesystemRule() {
  }
  public void applyRule(final SNode forRangeStatement, final TypeCheckingContext typeCheckingContext, IsApplicableStatus status) {
    SNode range = SLinkOperations.getTarget(forRangeStatement, LINKS.range$7Owi);
    SNode min = SLinkOperations.getTarget(range, LINKS.left$NBgM);
    SNode max = SLinkOperations.getTarget(range, LINKS.right$NBvN);

    boolean maxForcesSuppression = ListSequence.fromList(SNodeOperations.getNodeDescendants(max, CONCEPTS.ISuppressStaticEvalWarnings$1r, true, new SAbstractConcept[]{})).any((it) -> (boolean) ISuppressStaticEvalWarnings__BehaviorDescriptor.isSuppressionAllowed_id6ucVliiGyWC.invoke(it));
    boolean minForcesSuppression = ListSequence.fromList(SNodeOperations.getNodeDescendants(min, CONCEPTS.ISuppressStaticEvalWarnings$1r, true, new SAbstractConcept[]{})).any((it) -> (boolean) ISuppressStaticEvalWarnings__BehaviorDescriptor.isSuppressionAllowed_id6ucVliiGyWC.invoke(it));
    if ((boolean) Expression__BehaviorDescriptor.isStaticallyEvaluatable_id3ilck8Kr3zN.invoke(max) && (boolean) Expression__BehaviorDescriptor.isStaticallyEvaluatable_id3ilck8Kr3zN.invoke(min) && !(maxForcesSuppression || minForcesSuppression)) {
      Object maxVal = Expression__BehaviorDescriptor.evaluateStatically_id6OxpEKG0KPv.invoke(max);
      Object minVal = Expression__BehaviorDescriptor.evaluateStatically_id6OxpEKG0KPv.invoke(min);
      if (maxVal instanceof BigInteger && minVal instanceof BigInteger) {
        long rightValue = ((BigInteger) maxVal).longValue();
        long leftValue = ((BigInteger) minVal).longValue();
        if (SEnumOperations.isMember(SPropertyOperations.getEnum(forRangeStatement, PROPS.countBackwards$WyPw), 0x2b85e2bc8d7fc848L)) {

          if (SPropertyOperations.getBoolean(range, PROPS.leftExclude$tmTD)) {
            leftValue += 1;
          }
          if (SPropertyOperations.getBoolean(range, PROPS.rightExclude$tn8E)) {
            rightValue -= 1;
          }
          if (!(rightValue >= leftValue)) {
            final MessageTarget errorTarget = new NodeMessageTarget();
            IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(range, "right side must be bigger than left side; right: " + rightValue + ", left: " + leftValue, "r:167d778b-bddc-4b3f-a776-89718ce72b97(com.mbeddr.core.util.typesystem)", "2489357932892924973", null, errorTarget);
          }

        } else {
          if (SPropertyOperations.getBoolean(range, PROPS.leftExclude$tmTD)) {
            leftValue -= 1;
          }
          if (SPropertyOperations.getBoolean(range, PROPS.rightExclude$tn8E)) {
            rightValue += 1;
          }

          if (!(rightValue <= leftValue)) {
            final MessageTarget errorTarget = new NodeMessageTarget();
            IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(range, "right side must be smaller than left side; right: " + rightValue + ", left: " + leftValue, "r:167d778b-bddc-4b3f-a776-89718ce72b97(com.mbeddr.core.util.typesystem)", "2489357932893012380", null, errorTarget);
          }
        }
      }
    }
  }
  public SAbstractConcept getApplicableConcept() {
    return CONCEPTS.ForRangeStatement$vf;
  }
  public IsApplicableStatus isApplicableAndPattern(SNode argument) {
    return new IsApplicableStatus(argument.getConcept().isSubConceptOf(getApplicableConcept()), null);
  }
  public boolean overrides() {
    return false;
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink range$7Owi = MetaAdapterFactory.getContainmentLink(0x2693fc719b0e4b05L, 0xab13f57227d675f2L, 0x79253aa36e2e897cL, 0x79253aa36e2f306cL, "range");
    /*package*/ static final SContainmentLink left$NBgM = MetaAdapterFactory.getContainmentLink(0x2693fc719b0e4b05L, 0xab13f57227d675f2L, 0x578779f4086b789aL, 0x578779f4086b789bL, "left");
    /*package*/ static final SContainmentLink right$NBvN = MetaAdapterFactory.getContainmentLink(0x2693fc719b0e4b05L, 0xab13f57227d675f2L, 0x578779f4086b789aL, 0x578779f4086b789cL, "right");
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept ISuppressStaticEvalWarnings$1r = MetaAdapterFactory.getInterfaceConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x678ced5492b1e8dcL, "com.mbeddr.core.base.structure.ISuppressStaticEvalWarnings");
    /*package*/ static final SConcept ForRangeStatement$vf = MetaAdapterFactory.getConcept(0x2693fc719b0e4b05L, 0xab13f57227d675f2L, 0x79253aa36e2e897cL, "com.mbeddr.core.util.structure.ForRangeStatement");
  }

  private static final class PROPS {
    /*package*/ static final SProperty leftExclude$tmTD = MetaAdapterFactory.getProperty(0x2693fc719b0e4b05L, 0xab13f57227d675f2L, 0x578779f4086b789aL, 0x79253aa36e35046cL, "leftExclude");
    /*package*/ static final SProperty rightExclude$tn8E = MetaAdapterFactory.getProperty(0x2693fc719b0e4b05L, 0xab13f57227d675f2L, 0x578779f4086b789aL, 0x79253aa36e35046dL, "rightExclude");
    /*package*/ static final SProperty countBackwards$WyPw = MetaAdapterFactory.getProperty(0x2693fc719b0e4b05L, 0xab13f57227d675f2L, 0x79253aa36e2e897cL, 0x2b85e2bc8d7fc846L, "countBackwards");
  }
}
