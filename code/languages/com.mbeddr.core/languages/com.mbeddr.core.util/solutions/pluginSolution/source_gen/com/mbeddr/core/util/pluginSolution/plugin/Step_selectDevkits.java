package com.mbeddr.core.util.pluginSolution.plugin;

/*Generated by MPS */

import com.mbeddr.mpsutil.wizard.runtime.plugin.BaseProcessStep;
import jetbrains.mps.project.Solution;
import javax.swing.JComponent;
import com.mbeddr.core.base.pluginSolution.plugin.Filter;
import com.mbeddr.core.base.pluginSolution.plugin.MbeddrDevKitFilter;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.LinkedList;
import jetbrains.mps.project.DevKit;
import javax.swing.JCheckBox;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.internal.collections.runtime.LinkedListSequence;
import javax.swing.JPanel;
import java.util.List;
import javax.swing.BoxLayout;
import javax.swing.JLabel;
import javax.swing.JSeparator;
import javax.swing.Box;
import java.awt.Dimension;
import java.awt.Component;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import org.jetbrains.mps.openapi.model.SModel;
import javax.swing.SwingUtilities;
import com.mbeddr.mpsutil.smodule.runtime.lib.ModelHelper;
import com.intellij.ide.wizard.AbstractWizardStepEx;
import com.intellij.ide.wizard.CommitStepException;

public class Step_selectDevkits extends BaseProcessStep<Solution> {
  public static final String ID = "com.mbeddr.core.util.pluginSolution.plugin::createNewMbeddrSolution@selectDevkits";



  protected void createComponent(final JComponent mainpanel) {
    Filter devKitFilter = new MbeddrDevKitFilter();

    Step_selectDevkits.this.priv_devKits = ListSequence.fromList(new LinkedList<DevKit>());
    Step_selectDevkits.this.priv_devKitBoxes = ListSequence.fromList(new LinkedList<JCheckBox>());
    DevKit mbeddrCore = (DevKit) PersistenceFacade.getInstance().createModuleReference("d2a9c55c-6bdc-4cc2-97e1-4ba7552f5584(com.mbeddr.core)").resolve(((createNewMbeddrSolution_Wizard) this.wizard).input_project.getRepository());
    Step_selectDevkits.this.priv_defaultDevKits = LinkedListSequence.fromLinkedListNew(LinkedListSequence.fromListAndArray(new LinkedList<DevKit>(), new DevKit[]{mbeddrCore})).select((it) -> it.getModuleName()).toList();
    final JPanel devKitPanel = NewSolutionWizardHelper.createDevKitPanel(((createNewMbeddrSolution_Wizard) this.wizard).input_project.getRepository(), devKitFilter, Step_selectDevkits.this.priv_devKits, Step_selectDevkits.this.priv_devKitBoxes);

    // TODO using step private variables directly causes exception in the BL generator
    List<JCheckBox> devKitBoxes = Step_selectDevkits.this.priv_devKitBoxes;
    ListSequence.fromList(devKitBoxes).where((it) -> ListSequence.fromList(Step_selectDevkits.this.priv_defaultDevKits).contains(it.getText())).visitAll((it) -> it.setSelected(true));


    mainpanel.setLayout(new BoxLayout(mainpanel, BoxLayout.PAGE_AXIS));
    mainpanel.add(new JLabel("DevKits"));
    mainpanel.add(new JSeparator(JSeparator.HORIZONTAL));
    mainpanel.add(Box.createRigidArea(new Dimension(0, 5)));

    devKitPanel.setAlignmentX(Component.LEFT_ALIGNMENT);
    mainpanel.add(devKitPanel);
  }
  private List<DevKit> priv_devKits;
  private List<JCheckBox> priv_devKitBoxes;
  private List<String> priv_defaultDevKits;
  @Override
  public Solution execute(final Solution output, final ProgressMonitor progress) {
    super.execute(output, progress);
    final SModel model = ((Step_chooseSolutionName) getStep(Step_chooseSolutionName.ID)).out_createdModel;

    final List<DevKit> selectedDevKits = ListSequence.fromList(new LinkedList<DevKit>());
    // TODO using step private variables directly causes exception in the BL generator
    List<JCheckBox> devKitBoxes = Step_selectDevkits.this.priv_devKitBoxes;
    List<DevKit> devKits = Step_selectDevkits.this.priv_devKits;
    for (final JCheckBox selectedDevKitCheckBox : ListSequence.fromList(devKitBoxes).where((it) -> it.isSelected())) {
      ListSequence.fromList(selectedDevKits).addElement(ListSequence.fromList(devKits).findFirst((it) -> it.getModuleName().equals(selectedDevKitCheckBox.getText())));
    }
    SwingUtilities.invokeLater(() -> ((createNewMbeddrSolution_Wizard) Step_selectDevkits.this.wizard).input_project.getRepository().getModelAccess().executeCommand(() -> ModelHelper.addDevkits(model, selectedDevKits)));
    return output;
  }

  public Step_selectDevkits() {
    super("Used Devkits", ID);
  }

  public void commit(AbstractWizardStepEx.CommitType type) throws CommitStepException {
  }
}
