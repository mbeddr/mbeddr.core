package com.mbeddr.core.util.pluginSolution.plugin;

/*Generated by MPS */

import com.mbeddr.mpsutil.wizard.runtime.plugin.BaseProcessStep;
import jetbrains.mps.project.Project;
import javax.swing.JComponent;
import com.mbeddr.core.base.pluginSolution.plugin.Filter;
import com.mbeddr.core.base.pluginSolution.plugin.MbeddrDevKitFilter;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.LinkedList;
import jetbrains.mps.project.DevKit;
import javax.swing.JCheckBox;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.internal.collections.runtime.LinkedListSequence;
import javax.swing.JPanel;
import java.util.List;
import javax.swing.BoxLayout;
import javax.swing.JLabel;
import javax.swing.JSeparator;
import javax.swing.Box;
import java.awt.Dimension;
import java.awt.Component;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import com.intellij.openapi.application.ApplicationManager;
import jetbrains.mps.workbench.dialogs.project.newproject.ProjectFactory;
import jetbrains.mps.workbench.dialogs.project.newproject.TemplateFiller;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.project.Solution;
import com.mbeddr.mpsutil.smodule.runtime.lib.ModelHelper;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.persistence.PreinstalledModelFactoryTypes;
import java.util.ArrayList;
import org.jetbrains.mps.openapi.language.SLanguage;
import javax.swing.SwingUtilities;
import com.intellij.ide.wizard.AbstractWizardStepEx;
import com.intellij.ide.wizard.CommitStepException;

public class Step_selectDevkits2 extends BaseProcessStep<Project> {
  public static final String ID = "com.mbeddr.core.util.pluginSolution.plugin::createNewProjectWizard@selectDevkits2";



  protected void createComponent(final JComponent mainpanel) {
    Filter devKitFilter = new MbeddrDevKitFilter();

    Step_selectDevkits2.this.priv_devKits = ListSequence.fromList(new LinkedList<DevKit>());
    Step_selectDevkits2.this.priv_devKitBoxes = ListSequence.fromList(new LinkedList<JCheckBox>());
    DevKit mbeddrCore = (DevKit) PersistenceFacade.getInstance().createModuleReference("d2a9c55c-6bdc-4cc2-97e1-4ba7552f5584(com.mbeddr.core)").resolve(((createNewProjectWizard_Wizard) this.wizard).input_currentProject.getRepository());
    // FIXME why do you care to resolve mbeddr.core devkit module if all you need is module name? Use module-reference//.getModuleName() instead
    Step_selectDevkits2.this.priv_defaultDevKits = LinkedListSequence.fromLinkedListNew(LinkedListSequence.fromListAndArray(new LinkedList<DevKit>(), new DevKit[]{mbeddrCore})).select((it) -> it.getModuleName()).toList();
    final JPanel devKitPanel = NewSolutionWizardHelper.createDevKitPanel(((createNewProjectWizard_Wizard) this.wizard).input_currentProject.getRepository(), devKitFilter, Step_selectDevkits2.this.priv_devKits, Step_selectDevkits2.this.priv_devKitBoxes);

    // TODO using step private variables directly causes exception in the BL generator
    List<JCheckBox> devKitBoxes = Step_selectDevkits2.this.priv_devKitBoxes;
    ListSequence.fromList(devKitBoxes).where((it) -> ListSequence.fromList(Step_selectDevkits2.this.priv_defaultDevKits).contains(it.getText())).visitAll((it) -> it.setSelected(true));


    mainpanel.setLayout(new BoxLayout(mainpanel, BoxLayout.PAGE_AXIS));
    mainpanel.add(new JLabel("DevKits"));
    mainpanel.add(new JSeparator(JSeparator.HORIZONTAL));
    mainpanel.add(Box.createRigidArea(new Dimension(0, 5)));

    devKitPanel.setAlignmentX(Component.LEFT_ALIGNMENT);
    mainpanel.add(devKitPanel);
  }
  private List<DevKit> priv_devKits;
  private List<JCheckBox> priv_devKitBoxes;
  private List<String> priv_defaultDevKits;
  @Override
  public Project execute(final Project output, final ProgressMonitor progress) {
    super.execute(output, progress);

    // invoke later is for plugins to be ready
    ApplicationManager.getApplication().invokeLater(() -> {
      try {
        ProjectFactory factory = new ProjectFactory(((Step_chooseProjectName) getStep(Step_chooseProjectName.ID)).out_projectOptions);
        com.intellij.openapi.project.Project project = factory.createProject();
        TemplateFiller c = new TemplateFiller() {
          public void fillProjectWithModules(MPSProject project) {
            Solution solution = ModelHelper.createSolution(project, ((Step_chooseSolutionName2) getStep(Step_chooseSolutionName2.ID)).out_solutionSettings.getModuleName(), "");
            final SModel model = ModelHelper.createModel(solution, PreinstalledModelFactoryTypes.PLAIN_XML, ((Step_chooseSolutionName2) getStep(Step_chooseSolutionName2.ID)).out_solutionSettings.getModuleName() + ".model", ListSequence.fromList(new ArrayList<DevKit>()), ListSequence.fromList(new ArrayList<SLanguage>()), ListSequence.fromList(new ArrayList<SModel>()));

            final IModelTemplate template = ((Step_selectTemplate2) getStep(Step_selectTemplate2.ID)).out_selectedTemplate;
            SwingUtilities.invokeLater(() -> ((createNewProjectWizard_Wizard) wizard).input_currentProject.getRepository().getModelAccess().executeCommand(() -> template.populateModel(model)));

            final List<DevKit> selectedDevKits = ListSequence.fromList(new LinkedList<DevKit>());
            // TODO using step private variables directly causes exception in the BL generator
            List<JCheckBox> devKitBoxes = Step_selectDevkits2.this.priv_devKitBoxes;
            List<DevKit> devKits = Step_selectDevkits2.this.priv_devKits;
            for (final JCheckBox selectedDevKitCheckBox : ListSequence.fromList(devKitBoxes).where((it) -> it.isSelected())) {
              ListSequence.fromList(selectedDevKits).addElement(ListSequence.fromList(devKits).findFirst((it) -> it.getModuleName().equals(selectedDevKitCheckBox.getText())));
            }
            SwingUtilities.invokeLater(() -> ((createNewProjectWizard_Wizard) wizard).input_currentProject.getRepository().getModelAccess().executeCommand(() -> ModelHelper.addDevkits(model, selectedDevKits)));
          }
        };
        c.fillProjectWithModules(project.getComponent(MPSProject.class));
        // FIXME no idea if new frame is needed or not
        factory.activate(false);
      } catch (ProjectFactory.ProjectNotCreatedException e) {
      }
    });

    return output;
  }

  public Step_selectDevkits2() {
    super("Used Devkits", ID);
  }

  public void commit(AbstractWizardStepEx.CommitType type) throws CommitStepException {
  }
}
