package com.mbeddr.core.util.pluginSolution.plugin;

/*Generated by MPS */

import com.mbeddr.mpsutil.wizard.runtime.plugin.BaseProcessStep;
import jetbrains.mps.project.Solution;
import com.intellij.ide.wizard.AbstractWizardStepEx;
import com.intellij.ide.wizard.CommitStepException;
import javax.swing.JComponent;
import javax.swing.JRadioButton;
import javax.swing.ButtonGroup;
import javax.swing.JTextField;
import javax.swing.JLabel;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;
import java.awt.GridLayout;
import javax.swing.JPanel;
import java.awt.FlowLayout;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import com.intellij.openapi.util.AsyncResult;
import com.mbeddr.mpsutil.smodule.runtime.lib.ModelHelper;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.persistence.PreinstalledModelFactoryTypes;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.project.DevKit;
import org.jetbrains.mps.openapi.language.SLanguage;
import org.jetbrains.mps.openapi.module.SRepository;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import java.util.Collections;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SProperty;

public class Step_chooseType extends BaseProcessStep<Solution> {
  public static final String ID = "com.mbeddr.core.util.pluginSolution.plugin::createMbeddrSolution@chooseType";



  public void commit(AbstractWizardStepEx.CommitType type) throws CommitStepException {
    if (Step_chooseType.this.priv_minimalSystem.isSelected()) {
      Step_chooseType.this.out_type = ProjectType.MinimalProgram;
    } else {
      Step_chooseType.this.out_type = ProjectType.HelloWorld;
    }
  }
  protected void createComponent(final JComponent mainpanel) {
    Step_chooseType.this.priv_minimalSystem = new JRadioButton("Minimal System");
    Step_chooseType.this.priv_helloWorld = new JRadioButton("Hello World Sample");
    ButtonGroup bg = new ButtonGroup();
    Step_chooseType.this.priv_name = new JTextField();
    JLabel label = new JLabel("Solution name:");
    label.setLabelFor(Step_chooseType.this.priv_name);
    bg.add(Step_chooseType.this.priv_minimalSystem);
    bg.add(Step_chooseType.this.priv_helloWorld);

    Step_chooseType.this.priv_name.addActionListener(new ActionListener() {
      public void actionPerformed(ActionEvent p0) {
        Step_chooseType.this.triggerValidation();
      }
    });

    Step_chooseType.this.priv_helloWorld.addActionListener(new ActionListener() {
      public void actionPerformed(ActionEvent p0) {
        Step_chooseType.this.triggerValidation();
      }
    });

    Step_chooseType.this.priv_minimalSystem.addActionListener(new ActionListener() {
      public void actionPerformed(ActionEvent p0) {
        Step_chooseType.this.triggerValidation();
      }
    });

    mainpanel.setLayout(new GridLayout(0, 2));
    mainpanel.add(label);
    mainpanel.add(Step_chooseType.this.priv_name);
    mainpanel.add(new JLabel("What kind of solution do you want to create?"));
    JPanel buttonPanel = new JPanel(new FlowLayout());
    buttonPanel.add(Step_chooseType.this.priv_minimalSystem);
    buttonPanel.add(Step_chooseType.this.priv_helloWorld);
    mainpanel.add(buttonPanel);
  }
  public ProjectType out_type;
  private JRadioButton priv_minimalSystem;
  private JRadioButton priv_helloWorld;
  private JTextField priv_name;
  @Override
  public boolean isComplete() {
    return isNotEmptyString(Step_chooseType.this.priv_name.getText());
  }
  @Override
  public void updateUI() {
    super.updateUI();
    if (Step_chooseType.this.out_type == ProjectType.MinimalProgram) {
      Step_chooseType.this.priv_minimalSystem.setSelected(true);
    } else {
      Step_chooseType.this.priv_helloWorld.setSelected(true);
    }
  }
  @Override
  public Solution execute(final Solution output, final ProgressMonitor progress) {
    super.execute(output, progress);
    String text = Step_chooseType.this.priv_name.getText();
    final AsyncResult<Solution> res = new AsyncResult<Solution>();
    Solution result;
    result = ModelHelper.createSolution(((createMbeddrSolution_Wizard) this.wizard).input_project, text, "");
    final SModel model = ModelHelper.createModel(result, PreinstalledModelFactoryTypes.PLAIN_XML, text + ".code", ListSequence.fromList(new ArrayList<DevKit>()), ListSequence.fromList(new ArrayList<SLanguage>()), ListSequence.fromList(new ArrayList<SModel>()));

    final SRepository repo = ((createMbeddrSolution_Wizard) this.wizard).input_project.getRepository();
    repo.getModelAccess().executeCommandInEDT(() -> {
      DevKit mbeddrCore = (DevKit) PersistenceFacade.getInstance().createModuleReference("d2a9c55c-6bdc-4cc2-97e1-4ba7552f5584(com.mbeddr.core)").resolve(repo);
      ModelHelper.addDevkits(model, Collections.singletonList(mbeddrCore));
      switch (Step_chooseType.this.out_type) {
        case HelloWorld:
          progress.step("Creating HelloWorld");
          SNode imp = WizardHelper.makeImplModule("HelloWorld");
          SNode mf = WizardHelper.makeMainFunction();
          ListSequence.fromList(SLinkOperations.getChildren(imp, LINKS.contents$3Vmy)).addElement(mf);

          SNode bc = WizardHelper.makeBuildConfig();
          ListSequence.fromList(SLinkOperations.getChildren(bc, LINKS.binaries$R6lf)).addElement(WizardHelper.makeExecutableWithModule("HelloWorld", imp, bc));

          model.addRootNode(imp);
          model.addRootNode(bc);

          SNode table = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x2693fc719b0e4b05L, 0xab13f57227d675f2L, 0x255082a0ba0bd96dL, "com.mbeddr.core.util.structure.MessageDefinitionTable"));
          SPropertyOperations.assign(table, PROPS.name$MnvL, "messages");
          ListSequence.fromList(SLinkOperations.getChildren(imp, LINKS.contents$3Vmy)).addElement(table);

          SNode mess = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x2693fc719b0e4b05L, 0xab13f57227d675f2L, 0x255082a0ba0bd96fL, "com.mbeddr.core.util.structure.MessageDefinition"));
          SPropertyOperations.assign(mess, PROPS.name$MnvL, "HelloWorld");
          SPropertyOperations.setEnum(mess, PROPS.kind$j3ad, 0x255082a0ba0bd975L, "INFO");
          SPropertyOperations.assign(mess, PROPS.text$iX3N, "Hello, World!");
          ListSequence.fromList(SLinkOperations.getChildren(table, LINKS.messages$j3og)).addElement(mess);

          SNode report = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x2693fc719b0e4b05L, 0xab13f57227d675f2L, 0x255082a0ba0cca95L, "com.mbeddr.core.util.structure.ReportStatement"));
          SLinkOperations.setNewChild(report, LINKS.msgref$sFa, null);
          SLinkOperations.setTarget(SLinkOperations.getTarget(report, LINKS.msgref$sFa), LINKS.table$8Fdi, table);
          SLinkOperations.setTarget(SLinkOperations.getTarget(report, LINKS.msgref$sFa), LINKS.msg$8Fsj, mess);

          SNodeOperations.insertPrevSiblingChild(ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(mf, LINKS.body$1GE0), LINKS.statements$euTV)).first(), report);
          break;
        case MinimalProgram:
          SNode immo = WizardHelper.makeImplModule("main");
          SNode mainfunction = WizardHelper.makeMainFunction();
          ListSequence.fromList(SLinkOperations.getChildren(immo, LINKS.contents$3Vmy)).addElement(mainfunction);

          SNode bconf = WizardHelper.makeBuildConfig();
          ListSequence.fromList(SLinkOperations.getChildren(bconf, LINKS.binaries$R6lf)).addElement(WizardHelper.makeExecutableWithModule("main", immo, bconf));

          model.addRootNode(immo);
          model.addRootNode(bconf);
          break;
        default:
      }
    });
    res.setDone(result);
    return res.getResultSync();
  }

  public Step_chooseType() {
    super("Choose Project Type", ID);
  }

  private static boolean isNotEmptyString(String str) {
    return str != null && str.length() > 0;
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink contents$3Vmy = MetaAdapterFactory.getContainmentLink(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x595522006a5b933dL, 0x595522006a5b9351L, "contents");
    /*package*/ static final SContainmentLink binaries$R6lf = MetaAdapterFactory.getContainmentLink(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x6b1af9f9f43c2f48L, 0x46097107c8de43cbL, "binaries");
    /*package*/ static final SContainmentLink messages$j3og = MetaAdapterFactory.getContainmentLink(0x2693fc719b0e4b05L, 0xab13f57227d675f2L, 0x255082a0ba0bd96dL, 0x255082a0ba0bd977L, "messages");
    /*package*/ static final SContainmentLink msgref$sFa = MetaAdapterFactory.getContainmentLink(0x2693fc719b0e4b05L, 0xab13f57227d675f2L, 0x255082a0ba0cca95L, 0x255082a0ba0ceb99L, "msgref");
    /*package*/ static final SReferenceLink table$8Fdi = MetaAdapterFactory.getReferenceLink(0x2693fc719b0e4b05L, 0xab13f57227d675f2L, 0x255082a0ba0cca97L, 0x255082a0ba0cca98L, "table");
    /*package*/ static final SReferenceLink msg$8Fsj = MetaAdapterFactory.getReferenceLink(0x2693fc719b0e4b05L, 0xab13f57227d675f2L, 0x255082a0ba0cca97L, 0x255082a0ba0cca99L, "msg");
    /*package*/ static final SContainmentLink body$1GE0 = MetaAdapterFactory.getContainmentLink(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x595522006a5b97e1L, 0x3a16e3a9c7ad9954L, "body");
    /*package*/ static final SContainmentLink statements$euTV = MetaAdapterFactory.getContainmentLink(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x3a16e3a9c7ad9955L, 0x3a16e3a9c7ad9956L, "statements");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
    /*package*/ static final SProperty kind$j3ad = MetaAdapterFactory.getProperty(0x2693fc719b0e4b05L, 0xab13f57227d675f2L, 0x255082a0ba0bd96fL, 0x255082a0ba0bd976L, "kind");
    /*package*/ static final SProperty text$iX3N = MetaAdapterFactory.getProperty(0x2693fc719b0e4b05L, 0xab13f57227d675f2L, 0x255082a0ba0bd96fL, 0x255082a0ba0bd971L, "text");
  }
}
