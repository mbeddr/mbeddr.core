package com.mbeddr.core.modules.dataFlow;

/*Generated by MPS */

import jetbrains.mps.analyzers.runtime.framework.CustomAnalyzerRunner;
import java.util.Set;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.dataFlow.MPSProgramFactory;
import java.util.Collections;
import jetbrains.mps.lang.dataFlow.framework.IDataFlowModeId;
import jetbrains.mps.lang.dataFlow.framework.ProgramFactory;
import jetbrains.mps.lang.dataFlow.framework.NamedAnalyzerId;
import jetbrains.mps.lang.dataFlow.framework.DataFlowAnalyzerBase;
import jetbrains.mps.lang.dataFlow.framework.Program;
import java.util.List;
import java.util.HashSet;
import java.util.Iterator;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.dataFlow.framework.ProgramState;
import org.jetbrains.annotations.Nullable;
import java.util.Map;
import jetbrains.mps.lang.dataFlow.framework.instructions.Instruction;
import jetbrains.mps.lang.dataFlow.framework.instructions.ReadInstruction;
import jetbrains.mps.lang.dataFlow.framework.instructions.WriteInstruction;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.mbeddr.core.expressions.behavior.IAssignmentLike__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import com.mbeddr.core.expressions.behavior.IVariableReference__BehaviorDescriptor;
import jetbrains.mps.lang.dataFlow.framework.AnalysisDirection;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;

public class LivenessAnalyzerRunner extends CustomAnalyzerRunner<Set<VariableWrapper>> {
  private SNode myNode;
  public LivenessAnalyzerRunner(SNode node) {
    this(node, new MPSProgramFactory(Collections.<IDataFlowModeId>emptyList()));
  }
  public LivenessAnalyzerRunner(SNode node, ProgramFactory<NamedAnalyzerId> factory) {
    super(null, null);
    myNode = node;
    myAnalyzer = new LivenessAnalyzer();
    myProgram = factory.createProgram(myNode);
    factory.prepareProgram(myProgram, myNode, new NamedAnalyzerId("com.mbeddr.core.modules.dataFlow.Liveness"));
  }

  public static class LivenessAnalyzer extends DataFlowAnalyzerBase<Set<VariableWrapper>> {
    public LivenessAnalyzer() {
    }
    public Set<VariableWrapper> initial(Program program) {
      return Collections.emptySet();
    }
    public Set<VariableWrapper> merge(Program program, List<Set<VariableWrapper>> input) {
      Set<VariableWrapper> result = new HashSet<VariableWrapper>();

      Iterator<Set<VariableWrapper>> iterator = ListSequence.fromList(input).iterator();
      while (iterator.hasNext()) {
        result.addAll(iterator.next());
      }

      return result;
    }
    public Set<VariableWrapper> fun(Set<VariableWrapper> input, ProgramState state, @Nullable Map<ProgramState, Set<VariableWrapper>> stateValues) {
      Instruction instruction = state.getInstruction();

      if (instruction instanceof ReadInstruction) {
        // [[v]] = JOIN(v) U var
        ReadInstruction read = (ReadInstruction) instruction;
        SNode variable = (SNode) read.getVariable();
        if (variable != null) {
          input.add(new VariableWrapper(variable));
        }
      } else if (instruction instanceof WriteInstruction) {
        // [[v]] = JOIN(v) \ ID U VARS(RIGHT)
        WriteInstruction write = (WriteInstruction) instruction;
        SNode source = (SNode) write.getSource();
        SNode variable = (SNode) write.getVariable();

        // only remove the variable if the left hand side is not a generic dot expression
        // which accesses a member of an SU declaration
        boolean omitRemoval = false;
        if (SNodeOperations.isInstanceOf(source, CONCEPTS.IAssignmentLike$34)) {
          SNode left = IAssignmentLike__BehaviorDescriptor.getLValue_id7QxE2Vg8Hif.invoke(SNodeOperations.cast(source, CONCEPTS.IAssignmentLike$34));
          if (SNodeOperations.isInstanceOf(left, CONCEPTS.GenericDotExpression$uQ)) {
            omitRemoval = true;
          }
        }

        if (!(omitRemoval) && variable != null) {
          input.remove(new VariableWrapper(variable));
        }

        if (SNodeOperations.isInstanceOf(source, CONCEPTS.IAssignmentLike$34)) {
          SNode right = IAssignmentLike__BehaviorDescriptor.getRValue_id7QxE2Vg8Hlr.invoke(SNodeOperations.cast(source, CONCEPTS.IAssignmentLike$34));
          for (SNode ref : ListSequence.fromList(SNodeOperations.getNodeDescendants(right, CONCEPTS.IVariableReference$WR, false, new SAbstractConcept[]{}))) {
            if (IVariableReference__BehaviorDescriptor.getVariable_id1LDGRqyQFAf.invoke(ref) != null) {
              input.add(new VariableWrapper(IVariableReference__BehaviorDescriptor.getVariable_id1LDGRqyQFAf.invoke(ref)));
            }
          }
        }
      }
      return input;
    }
    public AnalysisDirection getDirection() {
      return AnalysisDirection.BACKWARD;
    }
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept IAssignmentLike$34 = MetaAdapterFactory.getInterfaceConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x4945cc205934d00L, "com.mbeddr.core.expressions.structure.IAssignmentLike");
    /*package*/ static final SConcept GenericDotExpression$uQ = MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x401df715da462c0cL, "com.mbeddr.core.expressions.structure.GenericDotExpression");
    /*package*/ static final SInterfaceConcept IVariableReference$WR = MetaAdapterFactory.getInterfaceConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x1c69b376a2dab98aL, "com.mbeddr.core.expressions.structure.IVariableReference");
  }
}
