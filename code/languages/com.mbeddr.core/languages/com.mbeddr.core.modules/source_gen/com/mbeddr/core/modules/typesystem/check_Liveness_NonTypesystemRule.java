package com.mbeddr.core.modules.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.runtime.AbstractNonTypesystemRule_Runtime;
import jetbrains.mps.lang.typesystem.runtime.NonTypesystemRule_Runtime;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import jetbrains.mps.lang.typesystem.runtime.IsApplicableStatus;
import com.mbeddr.mpsutil.suppresswarning.behavior.SuppressWarnings__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.analyzers.runtime.framework.CustomAnalyzerRunner;
import java.util.Set;
import com.mbeddr.core.modules.dataFlow.VariableWrapper;
import com.mbeddr.core.modules.dataFlow.LivenessAnalyzerRunner;
import jetbrains.mps.lang.dataFlow.framework.AnalysisResult;
import jetbrains.mps.lang.dataFlow.framework.instructions.Instruction;
import jetbrains.mps.lang.dataFlow.framework.instructions.WriteInstruction;
import com.mbeddr.core.expressions.behavior.IAssignmentLike__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.errors.messageTargets.MessageTarget;
import jetbrains.mps.errors.messageTargets.NodeMessageTarget;
import jetbrains.mps.errors.IErrorReporter;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SProperty;

public class check_Liveness_NonTypesystemRule extends AbstractNonTypesystemRule_Runtime implements NonTypesystemRule_Runtime {
  public check_Liveness_NonTypesystemRule() {
  }
  public void applyRule(final SNode statements, final TypeCheckingContext typeCheckingContext, IsApplicableStatus status) {
    if ((boolean) SuppressWarnings__BehaviorDescriptor.isSuppressed_id7U3Fobb_8EV.invoke(SNodeOperations.asSConcept(CONCEPTS.SuppressWarnings$uu), statements, CONCEPTS.SuppressDataFlowLivenessWarning$j4)) {
      return;
    }
    // Liveness analysis for unused assignments
    if (SNodeOperations.isInstanceOf(SNodeOperations.getParent(statements), CONCEPTS.IDataFlowAnalyzerEntryPoint$qk)) {
      CustomAnalyzerRunner<Set<VariableWrapper>> livenessAnalyzer = new LivenessAnalyzerRunner(statements);
      AnalysisResult<Set<VariableWrapper>> livenessAnalyzerResult = livenessAnalyzer.analyze();

      for (Instruction instruction : livenessAnalyzer.getProgram().getInstructions()) {
        if (instruction instanceof WriteInstruction) {
          WriteInstruction write = (WriteInstruction) instruction;
          VariableWrapper variable = new VariableWrapper((SNode) write.getVariable());

          SNode source = (SNode) write.getSource();

          boolean live = false;
          boolean local = false;
          boolean memberRef = false;
          boolean isStatic = false;

          if (SNodeOperations.isInstanceOf(source, CONCEPTS.IAssignmentLike$34)) {
            SNode left = IAssignmentLike__BehaviorDescriptor.getLValue_id7QxE2Vg8Hif.invoke(SNodeOperations.cast(source, CONCEPTS.IAssignmentLike$34));
            // the variable is treated as live if it is dereferenced in the assignment left hand side
            live = SNodeOperations.isInstanceOf(left, CONCEPTS.DerefExpr$1W) || SNodeOperations.isInstanceOf(left, CONCEPTS.ArrayAccessExpr$IH);
            local = ListSequence.fromList(SNodeOperations.getNodeDescendants(left, CONCEPTS.LocalVarRef$VQ, true, new SAbstractConcept[]{})).isNotEmpty() || ListSequence.fromList(SNodeOperations.getNodeDescendants(left, CONCEPTS.ArgumentRef$iE, true, new SAbstractConcept[]{})).isNotEmpty();
            memberRef = ListSequence.fromList(SNodeOperations.getNodeDescendants(left, CONCEPTS.GenericDotExpression$uQ, true, new SAbstractConcept[]{})).isNotEmpty();
            isStatic = ListSequence.fromList(SNodeOperations.getNodeDescendants(left, CONCEPTS.LocalVarRef$VQ, true, new SAbstractConcept[]{})).any((it) -> SPropertyOperations.getBoolean(SLinkOperations.getTarget(it, LINKS.var$YUyC), PROPS.static$q6vB));
          } else if (SNodeOperations.isInstanceOf(source, CONCEPTS.LocalVariableDeclaration$ft)) {
            local = true;
          }

          for (Instruction successor : SetSequence.fromSet(instruction.succ())) {
            live |= livenessAnalyzerResult.get(successor).contains(variable);
          }

          if (!(live) && local && !(memberRef) && !(isStatic)) {
            {
              final MessageTarget errorTarget = new NodeMessageTarget();
              IErrorReporter _reporter_2309309498 = typeCheckingContext.reportWarning(source, "Assigned variable is not used after this point.", "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "6240981777811911628", null, errorTarget);
            }
          }
        }
      }
    }
  }
  public SAbstractConcept getApplicableConcept() {
    return CONCEPTS.StatementList$y1;
  }
  public IsApplicableStatus isApplicableAndPattern(SNode argument) {
    return new IsApplicableStatus(argument.getConcept().isSubConceptOf(getApplicableConcept()), null);
  }
  public boolean overrides() {
    return false;
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept SuppressWarnings$uu = MetaAdapterFactory.getConcept(0xc1c2a88a323c4605L, 0xa37d9ab77a2ccbd2L, 0x7e83ad82cb948a95L, "com.mbeddr.mpsutil.suppresswarning.structure.SuppressWarnings");
    /*package*/ static final SConcept SuppressDataFlowLivenessWarning$j4 = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0xd9cc1d1d4af133fL, "com.mbeddr.core.modules.structure.SuppressDataFlowLivenessWarning");
    /*package*/ static final SInterfaceConcept IAssignmentLike$34 = MetaAdapterFactory.getInterfaceConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x4945cc205934d00L, "com.mbeddr.core.expressions.structure.IAssignmentLike");
    /*package*/ static final SConcept ArrayAccessExpr$IH = MetaAdapterFactory.getConcept(0x3bf5377ae9044dedL, 0x97545a516023bfaaL, 0x572f431af7922901L, "com.mbeddr.core.pointers.structure.ArrayAccessExpr");
    /*package*/ static final SConcept DerefExpr$1W = MetaAdapterFactory.getConcept(0x3bf5377ae9044dedL, 0x97545a516023bfaaL, 0x3e0cae5e366e2a7L, "com.mbeddr.core.pointers.structure.DerefExpr");
    /*package*/ static final SConcept LocalVarRef$VQ = MetaAdapterFactory.getConcept(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x1d0c3765e2e1d67aL, "com.mbeddr.core.statements.structure.LocalVarRef");
    /*package*/ static final SConcept ArgumentRef$iE = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x1d0c3765e2e7d0baL, "com.mbeddr.core.modules.structure.ArgumentRef");
    /*package*/ static final SConcept GenericDotExpression$uQ = MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x401df715da462c0cL, "com.mbeddr.core.expressions.structure.GenericDotExpression");
    /*package*/ static final SConcept LocalVariableDeclaration$ft = MetaAdapterFactory.getConcept(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x3a16e3a9c7ad96e6L, "com.mbeddr.core.statements.structure.LocalVariableDeclaration");
    /*package*/ static final SInterfaceConcept IDataFlowAnalyzerEntryPoint$qk = MetaAdapterFactory.getInterfaceConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x6ec6e0108c573b64L, "com.mbeddr.core.modules.structure.IDataFlowAnalyzerEntryPoint");
    /*package*/ static final SConcept StatementList$y1 = MetaAdapterFactory.getConcept(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x3a16e3a9c7ad9955L, "com.mbeddr.core.statements.structure.StatementList");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink var$YUyC = MetaAdapterFactory.getReferenceLink(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x1d0c3765e2e1d67aL, 0x1d0c3765e2e1fe27L, "var");
  }

  private static final class PROPS {
    /*package*/ static final SProperty static$q6vB = MetaAdapterFactory.getProperty(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x3a16e3a9c7ad96e6L, 0x394f433631987f7eL, "static");
  }
}
