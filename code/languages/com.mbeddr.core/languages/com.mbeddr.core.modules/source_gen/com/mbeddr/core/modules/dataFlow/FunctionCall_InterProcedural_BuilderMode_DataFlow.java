package com.mbeddr.core.modules.dataFlow;

/*Generated by MPS */

import jetbrains.mps.lang.dataFlow.DataFlowBuilder;
import jetbrains.mps.lang.dataFlow.DataFlowBuilderContext;
import java.util.List;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import com.mbeddr.mpsutil.dataflow.runtime.plugin.InterProcMapInstruction;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.mbeddr.mpsutil.dataflow.runtime.plugin.InterProceduralDataFlowGraphBuilderContext;
import com.mbeddr.mpsutil.dataflow.runtime.plugin.InterProceduralDataFlowGraphBuilder;
import com.mbeddr.mpsutil.dataflow.runtime.plugin.InterProceduralDataFlowGraph;
import com.mbeddr.mpsutil.dataflow.runtime.plugin.EntryPointInstruction;
import com.mbeddr.mpsutil.dataflow.runtime.plugin.FunctionCallInstruction;
import com.mbeddr.mpsutil.dataflow.runtime.plugin.NestedProgramInstruction;
import com.mbeddr.mpsutil.dataflow.runtime.plugin.InterProcUnmapInstruction;
import java.util.Collection;
import jetbrains.mps.lang.dataFlow.framework.IDataFlowModeId;
import java.util.Arrays;
import jetbrains.mps.lang.dataFlow.framework.ConceptDataFlowModeId;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SConcept;

public class FunctionCall_InterProcedural_BuilderMode_DataFlow extends DataFlowBuilder {
  public void build(final DataFlowBuilderContext _context) {
    List<SNode> formals = SLinkOperations.getChildren(SLinkOperations.getTarget(_context.getNode(), LINKS.function$oBh5), LINKS.arguments$6da0);
    List<SNode> actuals = SLinkOperations.getChildren(_context.getNode(), LINKS.actuals$oBJ7);
    for (int i = 0; i < Math.min(ListSequence.fromList(actuals).count(), ListSequence.fromList(formals).count()); i++) {
      SNode actual = ListSequence.fromList(actuals).getElement(i);
      SNode formal = ListSequence.fromList(formals).getElement(i);
      _context.getBuilder().build((SNode) actual);
      SNode source = createAssignmentExpr_ce361w_a0d0c0a(formal, actual);
      {
        InterProcMapInstruction instruction = new InterProcMapInstruction("r:2462c642-dc5b-476a-b684-01d77df4913e(com.mbeddr.core.modules.dataFlow)/2583851084315056425", formal, actual);
        _context.getBuilder().addInstruction(instruction, null);
        SNode source_e0c0a = source;
        if (source_e0c0a != null) {
          new IAttributeDescriptor.NodeAttribute(CONCEPTS.VirtualAttribute$US).set(source_e0c0a, SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x57416e5beba54910L, 0xade842ad18cb5f4dL, 0x378878b8f06d09faL, "com.mbeddr.mpsutil.dataflow.structure.VirtualAttribute")));
          instruction.setSource(source_e0c0a);
        }
      }
    }
    if (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(_context.getNode(), LINKS.function$oBh5), CONCEPTS.Function$K8)) {
      {
        InterProceduralDataFlowGraphBuilderContext context = (InterProceduralDataFlowGraphBuilderContext) _context;
        InterProceduralDataFlowGraphBuilder builder = (InterProceduralDataFlowGraphBuilder) context.getBuilder();
        SNode target = SLinkOperations.getTarget(_context.getNode(), LINKS.function$oBh5);
        InterProceduralDataFlowGraph parent = builder.getProgram();
        EntryPointInstruction entryPointInstruction = null;
        if (target != null) {
          entryPointInstruction = parent.getEntryPoint(target);
        }

        if (entryPointInstruction != null) {
          FunctionCallInstruction functionCallInstruction = new FunctionCallInstruction(entryPointInstruction);
          builder.addInstruction(functionCallInstruction, null);
          parent.addFunctionCall(functionCallInstruction, entryPointInstruction);
          parent.addTraceInformation(_context.getNode(), entryPointInstruction.getOwnProgram());
        } else {
          NestedProgramInstruction nestedProgramInstruction = new NestedProgramInstruction(target);
          // the instruction must be added before the current program is set
          // in order for the context sensitive program instruction lookups to work correctly
          builder.addInstruction(nestedProgramInstruction, null);
          InterProceduralDataFlowGraph current = new InterProceduralDataFlowGraphBuilder(parent, nestedProgramInstruction, builder.getProgramBuilderContext()).buildProgram(target);
          current.setTriggeringInstruction(nestedProgramInstruction);
          parent.addTraceInformation(_context.getNode(), current);
        }
      }
    }
    for (int i = 0; i < ListSequence.fromList(formals).count(); i++) {
      SNode formal = ListSequence.fromList(formals).getElement(i);
      {
        InterProcUnmapInstruction instruction = new InterProcUnmapInstruction("r:2462c642-dc5b-476a-b684-01d77df4913e(com.mbeddr.core.modules.dataFlow)/2583851084315169731", formal);
        _context.getBuilder().addInstruction(instruction, null);
      }
    }
  }
  @Override
  public Collection<IDataFlowModeId> getModes() {
    return Arrays.<IDataFlowModeId>asList(new ConceptDataFlowModeId("com.mbeddr.mpsutil.dataflow.structure.InterProcedural_BuilderMode"));
  }
  private static SNode createAssignmentExpr_ce361w_a0d0c0a(SNode p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.AssignmentExpr$mZ);
    {
      SNodeBuilder n1 = n0.forChild(LINKS.left$SkXz).init(CONCEPTS.ArgumentRef$iE);
      n1.setReferenceTarget(LINKS.arg$WIp5, p0);
    }
    n0.forChild(LINKS.right$Slc$).initNode(p1, CONCEPTS.Expression$bT, true);
    return n0.getResult();
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink function$oBh5 = MetaAdapterFactory.getReferenceLink(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x52941adca601b38cL, 0x52941adca601b38dL, "function");
    /*package*/ static final SContainmentLink arguments$6da0 = MetaAdapterFactory.getContainmentLink(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x707ac195dd5d51f2L, 0x4f39f90935e92f45L, "arguments");
    /*package*/ static final SContainmentLink actuals$oBJ7 = MetaAdapterFactory.getContainmentLink(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x52941adca601b38cL, 0x52941adca601b38fL, "actuals");
    /*package*/ static final SContainmentLink left$SkXz = MetaAdapterFactory.getContainmentLink(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x7af69e2e83a1ba34L, 0x7af69e2e83a1ba40L, "left");
    /*package*/ static final SReferenceLink arg$WIp5 = MetaAdapterFactory.getReferenceLink(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x1d0c3765e2e7d0baL, 0x1d0c3765e2e7d0bbL, "arg");
    /*package*/ static final SContainmentLink right$Slc$ = MetaAdapterFactory.getContainmentLink(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x7af69e2e83a1ba34L, 0x7af69e2e83a1ba41L, "right");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept VirtualAttribute$US = MetaAdapterFactory.getConcept(0x57416e5beba54910L, 0xade842ad18cb5f4dL, 0x378878b8f06d09faL, "com.mbeddr.mpsutil.dataflow.structure.VirtualAttribute");
    /*package*/ static final SConcept Function$K8 = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x595522006a5b97e1L, "com.mbeddr.core.modules.structure.Function");
    /*package*/ static final SConcept AssignmentExpr$mZ = MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x4e85add925440dL, "com.mbeddr.core.expressions.structure.AssignmentExpr");
    /*package*/ static final SConcept ArgumentRef$iE = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x1d0c3765e2e7d0baL, "com.mbeddr.core.modules.structure.ArgumentRef");
    /*package*/ static final SConcept Expression$bT = MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x7af69e2e83a1ba32L, "com.mbeddr.core.expressions.structure.Expression");
  }
}
