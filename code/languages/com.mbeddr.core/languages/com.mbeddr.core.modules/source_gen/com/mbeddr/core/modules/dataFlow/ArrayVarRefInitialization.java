package com.mbeddr.core.modules.dataFlow;

/*Generated by MPS */

import jetbrains.mps.lang.dataFlow.framework.DataFlowConstructor;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.dataFlow.framework.Program;
import com.mbeddr.core.expressions.behavior.IVariableDeclaration__BehaviorDescriptor;
import com.mbeddr.core.expressions.behavior.IVariableReference__BehaviorDescriptor;
import com.mbeddr.mpsutil.dataflow.runtime.plugin.InterProceduralDataFlowGraph;
import java.util.Map;
import com.mbeddr.mpsutil.dataflow.runtime.plugin.ProgramPath;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.lang.dataFlow.framework.instructions.Instruction;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class ArrayVarRefInitialization implements DataFlowConstructor {
  public boolean isApplicable(SNode node) {
    SAbstractConcept concept = SNodeOperations.getConcept(node);
    SAbstractConcept applicableConcept = getApplicableConcept();
    return concept.equals(applicableConcept) || concept.isSubConceptOf(applicableConcept);
  }
  public SAbstractConcept getApplicableConcept() {
    return CONCEPTS.IVariableReference$WR;
  }
  public void performActions(Program o, SNode node) {
    SNode type = IVariableDeclaration__BehaviorDescriptor.getDeclaredType_id1LDGRqyYkTX.invoke(IVariableReference__BehaviorDescriptor.getVariable_id1LDGRqyQFAf.invoke(node));

    if (SNodeOperations.isInstanceOf(type, CONCEPTS.ArrayType$WW)) {
      if (SNodeOperations.isInstanceOf(IVariableReference__BehaviorDescriptor.getVariable_id1LDGRqyQFAf.invoke(node), CONCEPTS.GlobalVariableDeclaration$TW)) {
        // global var treated as initialized
        // GlobalVarRefInitialization takes care of this
        if (o instanceof InterProceduralDataFlowGraph) {
          Object object = node;
          boolean before = true;
          InterProceduralDataFlowGraph graph = (InterProceduralDataFlowGraph) o;

          Map<ProgramPath, Integer> positionMap = null;

          if (before) {
            positionMap = graph.getPathAwareStart(object);
          } else {
            positionMap = graph.getPathAwareEnd(object);
          }

          if (positionMap != null) {
            for (Map.Entry<ProgramPath, Integer> position : SetSequence.fromSet(positionMap.entrySet())) {
              Instruction instruction = new defInitInstruction(IVariableReference__BehaviorDescriptor.getVariable_id1LDGRqyQFAf.invoke(node));
              instruction.setRuleReference("r:2462c642-dc5b-476a-b684-01d77df4913e(com.mbeddr.core.modules.dataFlow)/4819609382756453868");
              instruction.setSource(node);
              graph.insert(instruction, position.getValue(), true, before);
            }
          }
        } else {
          Object object = node;
          if (o.contains(object)) {
            boolean before = true;
            int position = o.getStart(node);
            Instruction instruction = new defInitInstruction(IVariableReference__BehaviorDescriptor.getVariable_id1LDGRqyQFAf.invoke(node));
            instruction.setRuleReference("r:2462c642-dc5b-476a-b684-01d77df4913e(com.mbeddr.core.modules.dataFlow)/4819609382756453868");
            instruction.setSource(node);
            o.insert(instruction, position, true, before);
          }
        }
      } else if (SLinkOperations.getTarget(SNodeOperations.cast(type, CONCEPTS.ArrayType$WW), LINKS.sizeExpr$S0Eu) != null) {
        // fixed size array created on the stack
        if (o instanceof InterProceduralDataFlowGraph) {
          Object object = node;
          boolean before = true;
          InterProceduralDataFlowGraph graph = (InterProceduralDataFlowGraph) o;

          Map<ProgramPath, Integer> positionMap = null;

          if (before) {
            positionMap = graph.getPathAwareStart(object);
          } else {
            positionMap = graph.getPathAwareEnd(object);
          }

          if (positionMap != null) {
            for (Map.Entry<ProgramPath, Integer> position : SetSequence.fromSet(positionMap.entrySet())) {
              Instruction instruction = new defInitInstruction(IVariableReference__BehaviorDescriptor.getVariable_id1LDGRqyQFAf.invoke(node));
              instruction.setRuleReference("r:2462c642-dc5b-476a-b684-01d77df4913e(com.mbeddr.core.modules.dataFlow)/2409457204344621010");
              instruction.setSource(node);
              graph.insert(instruction, position.getValue(), true, before);
            }
          }
        } else {
          Object object = node;
          if (o.contains(object)) {
            boolean before = true;
            int position = o.getStart(node);
            Instruction instruction = new defInitInstruction(IVariableReference__BehaviorDescriptor.getVariable_id1LDGRqyQFAf.invoke(node));
            instruction.setRuleReference("r:2462c642-dc5b-476a-b684-01d77df4913e(com.mbeddr.core.modules.dataFlow)/2409457204344621010");
            instruction.setSource(node);
            o.insert(instruction, position, true, before);
          }
        }
      } else if (IVariableDeclaration__BehaviorDescriptor.getInitExpression_id1LDGRqyYkU1.invoke(IVariableReference__BehaviorDescriptor.getVariable_id1LDGRqyQFAf.invoke(node)) != null) {
        // for an array in the local scope there must be an initializer
        if (o instanceof InterProceduralDataFlowGraph) {
          Object object = node;
          boolean before = true;
          InterProceduralDataFlowGraph graph = (InterProceduralDataFlowGraph) o;

          Map<ProgramPath, Integer> positionMap = null;

          if (before) {
            positionMap = graph.getPathAwareStart(object);
          } else {
            positionMap = graph.getPathAwareEnd(object);
          }

          if (positionMap != null) {
            for (Map.Entry<ProgramPath, Integer> position : SetSequence.fromSet(positionMap.entrySet())) {
              Instruction instruction = new defInitInstruction(IVariableReference__BehaviorDescriptor.getVariable_id1LDGRqyQFAf.invoke(node));
              instruction.setRuleReference("r:2462c642-dc5b-476a-b684-01d77df4913e(com.mbeddr.core.modules.dataFlow)/3105925081590517592");
              instruction.setSource(node);
              graph.insert(instruction, position.getValue(), true, before);
            }
          }
        } else {
          Object object = node;
          if (o.contains(object)) {
            boolean before = true;
            int position = o.getStart(node);
            Instruction instruction = new defInitInstruction(IVariableReference__BehaviorDescriptor.getVariable_id1LDGRqyQFAf.invoke(node));
            instruction.setRuleReference("r:2462c642-dc5b-476a-b684-01d77df4913e(com.mbeddr.core.modules.dataFlow)/3105925081590517592");
            instruction.setSource(node);
            o.insert(instruction, position, true, before);
          }
        }
      }
    }
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept IVariableReference$WR = MetaAdapterFactory.getInterfaceConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x1c69b376a2dab98aL, "com.mbeddr.core.expressions.structure.IVariableReference");
    /*package*/ static final SConcept ArrayType$WW = MetaAdapterFactory.getConcept(0x3bf5377ae9044dedL, 0x97545a516023bfaaL, 0x4ed16d83a1d30c81L, "com.mbeddr.core.pointers.structure.ArrayType");
    /*package*/ static final SConcept GlobalVariableDeclaration$TW = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x5bbe8a6d23a1b6ceL, "com.mbeddr.core.modules.structure.GlobalVariableDeclaration");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink sizeExpr$S0Eu = MetaAdapterFactory.getContainmentLink(0x3bf5377ae9044dedL, 0x97545a516023bfaaL, 0x4ed16d83a1d30c81L, 0x1429cfd56a064333L, "sizeExpr");
  }
}
