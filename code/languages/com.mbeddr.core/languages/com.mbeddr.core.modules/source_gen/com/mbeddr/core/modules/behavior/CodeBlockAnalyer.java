package com.mbeddr.core.modules.behavior;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.model.SReference;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import java.util.List;
import com.mbeddr.core.expressions.behavior.IAssignmentLike__BehaviorDescriptor;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SProperty;

public class CodeBlockAnalyer {


  protected SNode statementList;
  protected SNode contextNode;
  protected SNode outsideBoundary;

  public CodeBlockAnalyer(SNode root, SNode contextNode, SNode outsideBoundary) {
    this.statementList = root;
    this.contextNode = contextNode;
    this.outsideBoundary = outsideBoundary;
  }

  public SNode getContextNode() {
    return this.contextNode;
  }

  public SNode getOutsideBoundary() {
    return this.outsideBoundary;
  }

  public Iterable<SNode> findGenericOutsideReferences() {
    return ListSequence.fromList(SNodeOperations.getNodeDescendants(statementList, null, false, new SAbstractConcept[]{})).where((it) -> {
      Iterable<? extends SReference> references = it.getReferences();
      for (SReference ref : Sequence.fromIterable(references)) {
        SNode t = ref.getTargetNode();
        if (!(ListSequence.fromList(SNodeOperations.getNodeAncestors(t, null, true)).contains(outsideBoundary))) {
          return true;
        }
      }
      return false;
    });
  }

  public Iterable<SNode> findGlobalVarRefs() {
    return ListSequence.fromList(SNodeOperations.getNodeDescendants(statementList, CONCEPTS.GlobalVarRef$hy, false, new SAbstractConcept[]{})).where((it) -> isOutside(SLinkOperations.getTarget(it, LINKS.var$wHP5)));
  }


  public Iterable<SNode> findGlobalConstantRefs() {
    return ListSequence.fromList(SNodeOperations.getNodeDescendants(statementList, CONCEPTS.GlobalConstantRef$ML, false, new SAbstractConcept[]{})).where((it) -> isOutside(SLinkOperations.getTarget(it, LINKS.constant$aCs7)));
  }

  public Iterable<SNode> findFunctionCalls() {
    return ListSequence.fromList(SNodeOperations.getNodeDescendants(statementList, CONCEPTS.FunctionCall$4q, false, new SAbstractConcept[]{})).where((it) -> isOutside(SLinkOperations.getTarget(it, LINKS.function$oBh5)));
  }

  public Iterable<SNode> findFunctionRefs() {
    return ListSequence.fromList(SNodeOperations.getNodeDescendants(statementList, CONCEPTS.FunctionRefExpr$cC, false, new SAbstractConcept[]{})).where((it) -> isOutside(SLinkOperations.getTarget(it, LINKS.function$ZbB6)));
  }

  public Iterable<SNode> findFunctionRefCalls() {
    return SNodeOperations.getNodeDescendants(statementList, CONCEPTS.FunctionRefCallExpr$Di, false, new SAbstractConcept[]{});
  }

  public Iterable<SNode> findStaticVariables() {
    return ListSequence.fromList(SNodeOperations.getNodeDescendants(statementList, CONCEPTS.LocalVariableDeclaration$ft, false, new SAbstractConcept[]{})).where((it) -> SPropertyOperations.getBoolean(it, PROPS.static$q6vB));
  }

  public Iterable<SNode> findReturnStatements() {
    return SNodeOperations.getNodeDescendants(statementList, CONCEPTS.ReturnStatement$Kx, false, new SAbstractConcept[]{});
  }

  public Iterable<SNode> globalVarAssigns(final SNode gvd) {
    List<SNode> assigns = SNodeOperations.getNodeDescendants(statementList, CONCEPTS.IAssignmentLike$34, false, new SAbstractConcept[]{});
    return ListSequence.fromList(assigns).where((it) -> {
      return ListSequence.fromList(SNodeOperations.getNodeDescendants(IAssignmentLike__BehaviorDescriptor.getLValue_id7QxE2Vg8Hif.invoke(it), null, true, new SAbstractConcept[]{})).any(new _FunctionTypes._return_P1_E0<Boolean, SNode>() {
        public Boolean invoke(SNode it) {
          return SNodeOperations.isInstanceOf(it, CONCEPTS.GlobalVarRef$hy) && SLinkOperations.getTarget(SNodeOperations.cast(it, CONCEPTS.GlobalVarRef$hy), LINKS.var$wHP5) == gvd;
        }
      });
    });
  }

  public boolean isGlobalVarAssigned(SNode gvd) {
    return Sequence.fromIterable(globalVarAssigns(gvd)).isNotEmpty();
  }

  public Iterable<SNode> argAssigns(final SNode arg) {
    List<SNode> assigns = SNodeOperations.getNodeDescendants(statementList, CONCEPTS.IAssignmentLike$34, false, new SAbstractConcept[]{});
    return ListSequence.fromList(assigns).where((it) -> {
      return ListSequence.fromList(SNodeOperations.getNodeDescendants(IAssignmentLike__BehaviorDescriptor.getLValue_id7QxE2Vg8Hif.invoke(it), null, true, new SAbstractConcept[]{})).any(new _FunctionTypes._return_P1_E0<Boolean, SNode>() {
        public Boolean invoke(SNode it) {
          return SNodeOperations.isInstanceOf(it, CONCEPTS.ArgumentRef$iE) && SLinkOperations.getTarget(SNodeOperations.cast(it, CONCEPTS.ArgumentRef$iE), LINKS.arg$WIp5) == arg;
        }
      });
    });

  }

  public boolean isDerefedPointerArgRead(final SNode arg) {
    Iterable<SNode> all = ListSequence.fromList(SNodeOperations.getNodeDescendants(statementList, CONCEPTS.DerefExpr$1W, false, new SAbstractConcept[]{})).where((it) -> SNodeOperations.isInstanceOf(SLinkOperations.getTarget(it, LINKS.expression$PfNq), CONCEPTS.ArgumentRef$iE) && SLinkOperations.getTarget(SNodeOperations.cast(SLinkOperations.getTarget(it, LINKS.expression$PfNq), CONCEPTS.ArgumentRef$iE), LINKS.arg$WIp5) == arg);
    final List<SNode> assigns = SNodeOperations.getNodeDescendants(statementList, CONCEPTS.IAssignmentLike$34, false, new SAbstractConcept[]{});
    Iterable<SNode> nonAssigns = Sequence.fromIterable(all).where((final SNode deref) -> !(ListSequence.fromList(assigns).any((assign) -> IAssignmentLike__BehaviorDescriptor.getLValue_id7QxE2Vg8Hif.invoke(assign) == deref)));
    return Sequence.fromIterable(nonAssigns).isNotEmpty();
  }

  public boolean isPointerArgReadOrWritten(final SNode arg) {
    return ListSequence.fromList(SNodeOperations.getNodeDescendants(statementList, CONCEPTS.ArgumentRef$iE, false, new SAbstractConcept[]{})).where((it) -> !(SNodeOperations.isInstanceOf(SNodeOperations.getParent(it), CONCEPTS.DerefExpr$1W))).where((it) -> SLinkOperations.getTarget(it, LINKS.arg$WIp5) == arg).isNotEmpty();
  }

  public Iterable<SNode> derefedPointerArgAssigns(final SNode arg) {
    List<SNode> assigns = SNodeOperations.getNodeDescendants(statementList, CONCEPTS.IAssignmentLike$34, false, new SAbstractConcept[]{});
    return ListSequence.fromList(assigns).where((it) -> {
      SNode e = IAssignmentLike__BehaviorDescriptor.getLValue_id7QxE2Vg8Hif.invoke(it);
      return SNodeOperations.isInstanceOf(e, CONCEPTS.DerefExpr$1W) && SNodeOperations.isInstanceOf(SLinkOperations.getTarget(SNodeOperations.cast(e, CONCEPTS.DerefExpr$1W), LINKS.expression$PfNq), CONCEPTS.ArgumentRef$iE) && SLinkOperations.getTarget(SNodeOperations.cast(SLinkOperations.getTarget(SNodeOperations.cast(e, CONCEPTS.DerefExpr$1W), LINKS.expression$PfNq), CONCEPTS.ArgumentRef$iE), LINKS.arg$WIp5) == arg;
    });

  }

  public boolean isDerefedPointerArgAssigns(SNode arg) {
    return Sequence.fromIterable(derefedPointerArgAssigns(arg)).isNotEmpty();
  }

  public boolean isArgAssigned(SNode arg) {
    return Sequence.fromIterable(argAssigns(arg)).isNotEmpty();
  }

  protected boolean isOutside(SNode n) {
    return !(ListSequence.fromList(SNodeOperations.getNodeAncestors(n, null, false)).contains(outsideBoundary));
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept GlobalVarRef$hy = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x5bbe8a6d23a20aeaL, "com.mbeddr.core.modules.structure.GlobalVarRef");
    /*package*/ static final SConcept GlobalConstantRef$ML = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x34953142306a769bL, "com.mbeddr.core.modules.structure.GlobalConstantRef");
    /*package*/ static final SConcept FunctionCall$4q = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x52941adca601b38cL, "com.mbeddr.core.modules.structure.FunctionCall");
    /*package*/ static final SConcept FunctionRefExpr$cC = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x76ad8d576f018e43L, "com.mbeddr.core.modules.structure.FunctionRefExpr");
    /*package*/ static final SConcept FunctionRefCallExpr$Di = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x76ad8d576f01e321L, "com.mbeddr.core.modules.structure.FunctionRefCallExpr");
    /*package*/ static final SConcept LocalVariableDeclaration$ft = MetaAdapterFactory.getConcept(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x3a16e3a9c7ad96e6L, "com.mbeddr.core.statements.structure.LocalVariableDeclaration");
    /*package*/ static final SConcept ReturnStatement$Kx = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x7c747300dbd94ea5L, "com.mbeddr.core.modules.structure.ReturnStatement");
    /*package*/ static final SInterfaceConcept IAssignmentLike$34 = MetaAdapterFactory.getInterfaceConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x4945cc205934d00L, "com.mbeddr.core.expressions.structure.IAssignmentLike");
    /*package*/ static final SConcept ArgumentRef$iE = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x1d0c3765e2e7d0baL, "com.mbeddr.core.modules.structure.ArgumentRef");
    /*package*/ static final SConcept DerefExpr$1W = MetaAdapterFactory.getConcept(0x3bf5377ae9044dedL, 0x97545a516023bfaaL, 0x3e0cae5e366e2a7L, "com.mbeddr.core.pointers.structure.DerefExpr");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink var$wHP5 = MetaAdapterFactory.getReferenceLink(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x5bbe8a6d23a20aeaL, 0x5bbe8a6d23a20aebL, "var");
    /*package*/ static final SReferenceLink constant$aCs7 = MetaAdapterFactory.getReferenceLink(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x34953142306a769bL, 0x2edcb73a870a3ebaL, "constant");
    /*package*/ static final SReferenceLink function$oBh5 = MetaAdapterFactory.getReferenceLink(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x52941adca601b38cL, 0x52941adca601b38dL, "function");
    /*package*/ static final SReferenceLink function$ZbB6 = MetaAdapterFactory.getReferenceLink(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x76ad8d576f018e43L, 0x76ad8d576f018e45L, "function");
    /*package*/ static final SReferenceLink arg$WIp5 = MetaAdapterFactory.getReferenceLink(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x1d0c3765e2e7d0baL, 0x1d0c3765e2e7d0bbL, "arg");
    /*package*/ static final SContainmentLink expression$PfNq = MetaAdapterFactory.getContainmentLink(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x29b5b7c4a3763232L, 0x64ae61a4018a9c50L, "expression");
  }

  private static final class PROPS {
    /*package*/ static final SProperty static$q6vB = MetaAdapterFactory.getProperty(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x3a16e3a9c7ad96e6L, 0x394f433631987f7eL, "static");
  }
}
