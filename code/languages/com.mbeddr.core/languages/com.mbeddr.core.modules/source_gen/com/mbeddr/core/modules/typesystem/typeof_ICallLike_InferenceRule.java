package com.mbeddr.core.modules.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.runtime.AbstractInferenceRule_Runtime;
import jetbrains.mps.lang.typesystem.runtime.InferenceRule_Runtime;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import jetbrains.mps.lang.typesystem.runtime.IsApplicableStatus;
import java.util.List;
import com.mbeddr.core.modules.behavior.ICallLike__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.errors.messageTargets.MessageTarget;
import jetbrains.mps.errors.messageTargets.NodeMessageTarget;
import jetbrains.mps.errors.IErrorReporter;
import com.mbeddr.core.modules.behavior.IFunctionLike__BehaviorDescriptor;
import jetbrains.mps.typesystem.inference.EquationInfo;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class typeof_ICallLike_InferenceRule extends AbstractInferenceRule_Runtime implements InferenceRule_Runtime {
  public typeof_ICallLike_InferenceRule() {
  }
  public void applyRule(final SNode call, final TypeCheckingContext typeCheckingContext, IsApplicableStatus status) {
    final List<SNode> formals = ICallLike__BehaviorDescriptor.getFormals_id6WGVxckB065.invoke(call);
    final List<SNode> actuals = ICallLike__BehaviorDescriptor.getActuals_id6WGVxckB05Y.invoke(call);
    final int formalCount = ListSequence.fromList(formals).count();
    final int actualCount = ListSequence.fromList(actuals).count();
    if ((!((boolean) ICallLike__BehaviorDescriptor.hasEllipsis_id7$$5Stoo9at.invoke(call)) && formalCount != actualCount) || ((boolean) ICallLike__BehaviorDescriptor.hasEllipsis_id7$$5Stoo9at.invoke(call) && actualCount < formalCount)) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(call, "wrong number of arguments, expected: " + IFunctionLike__BehaviorDescriptor.signatureInfo_id7GUSN23Vq8.invoke(ICallLike__BehaviorDescriptor.getFunction_id74lwjTQiYY5.invoke(call)), "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "688756255682717084", null, errorTarget);
      }
    } else {
      final int smaller = Math.min(actualCount, formalCount);

      if (smaller == 0) {
        {
          final SNode returnType = typeCheckingContext.typeOf(ICallLike__BehaviorDescriptor.getReturnType_id7$$5Stoo8Y$.invoke(call), "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "4038282106533053686", true);
          typeCheckingContext.whenConcrete(returnType, () -> {
            {
              SNode _nodeToCheck_1029348928467 = call;
              EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "205952376338698569", 0, null);
              typeCheckingContext.createGreaterThanInequality((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "205952376338698572", true), (SNode) typeCheckingContext.getExpandedNode(returnType), false, true, _info_12389875345);
            }
          }, "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "4038282106533053678", false, false);
        }
      } else {
        for (int i = smaller - 1; i >= 0; i--) {
          final int actualIndex = i;
          final boolean isLastOne = (actualIndex == 0);

          {
            final SNode actualType = typeCheckingContext.typeOf(ListSequence.fromList(actuals).getElement(actualIndex), "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "4038282106532667892", true);
            typeCheckingContext.whenConcrete(actualType, () -> {
              final SNode formal = ListSequence.fromList(formals).getElement(actualIndex);
              final SNode actual = ListSequence.fromList(actuals).getElement(actualIndex);

              if (!(SNodeOperations.isInstanceOf(actual, CONCEPTS.IRequiresTypeToBeInferred$3C))) {
                if (!(typeCheckingContext.isSingleTypeComputation())) {
                  {
                    SNode _nodeToCheck_1029348928467 = actual;
                    EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "9116549269032603465", 0, null);
                    typeCheckingContext.createLessThanInequality((SNode) typeCheckingContext.typeOf(actual, "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "9116549269032603467", true), (SNode) typeCheckingContext.typeOf(formal, "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "9116549269032603470", true), true, true, _info_12389875345);
                  }
                }
              }

              // add when_concrete on the returnType after the last argument type is known
              if (isLastOne) {
                {
                  final SNode returnType = typeCheckingContext.typeOf(ICallLike__BehaviorDescriptor.getReturnType_id7$$5Stoo8Y$.invoke(call), "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "182845728207646093", true);
                  typeCheckingContext.whenConcrete(returnType, () -> {
                    {
                      SNode _nodeToCheck_1029348928467 = call;
                      EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "9116549269035493087", 0, null);
                      typeCheckingContext.createGreaterThanInequality((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "9116549269035493090", true), (SNode) typeCheckingContext.getExpandedNode(returnType), false, true, _info_12389875345);
                    }
                  }, "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "182845728207645191", false, false);
                }
              }
            }, "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "4038282106532667627", false, false);
          }
        }

        for (int i = smaller - 1; i >= 0; i--) {
          final SNode formal = ListSequence.fromList(formals).getElement(i);
          final SNode actual = ListSequence.fromList(actuals).getElement(i);

          if (SNodeOperations.isInstanceOf(actual, CONCEPTS.IRequiresTypeToBeInferred$3C)) {
            {
              SNode _nodeToCheck_1029348928467 = actual;
              EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "7270453972808948338", 0, null);
              typeCheckingContext.createLessThanInequality((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "7270453972808948352", true), (SNode) typeCheckingContext.typeOf(formal, "r:7b158038-abbe-4e11-b171-d5a959b4e91a(com.mbeddr.core.modules.typesystem)", "7270453972808948395", true), false, true, _info_12389875345);
            }
          }
        }
      }
    }
  }
  public SAbstractConcept getApplicableConcept() {
    return CONCEPTS.ICallLike$AL;
  }
  public IsApplicableStatus isApplicableAndPattern(SNode argument) {
    return new IsApplicableStatus(argument.getConcept().isSubConceptOf(getApplicableConcept()), null);
  }
  public boolean overrides() {
    return false;
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept IRequiresTypeToBeInferred$3C = MetaAdapterFactory.getInterfaceConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x479c34ecb3e934c3L, "com.mbeddr.core.expressions.structure.IRequiresTypeToBeInferred");
    /*package*/ static final SInterfaceConcept ICallLike$AL = MetaAdapterFactory.getInterfaceConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x6f2cee13149c017aL, "com.mbeddr.core.modules.structure.ICallLike");
  }
}
