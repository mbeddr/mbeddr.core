package com.mbeddr.core.unittest.migration;

/*Generated by MPS */

import jetbrains.mps.lang.migration.runtime.base.MigrationScriptBase;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.module.SModule;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import de.slisson.mps.richtext.behavior.RichTextUtil;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.lang.migration.runtime.base.Problem;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.lang.migration.runtime.base.MigrationScriptReference;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class migrateTestCollection extends MigrationScriptBase {
  private final String description = "migrateTestCollection";
  public String getCaption() {
    return description;
  }
  @Override
  public boolean isRerunnable() {
    return false;
  }
  public SNode execute(final SModule m) {
    doExecute(m);
    return null;
  }
  public void doExecute(final SModule m) {
    final Map<SNode, SNode> migratedFuntionts = MapSequence.fromMap(new HashMap<SNode, SNode>());
    for (SModel mdl : m.getModels()) {
      ListSequence.fromList(SModelOperations.nodes(mdl, CONCEPTS.TestCollection$pU)).visitAll((it) -> SPropertyOperations.assign(it, PROPS.entrypoint$RdMb, true));
      Iterable<SNode> relevantFunctions = ListSequence.fromList(SModelOperations.nodes(mdl, CONCEPTS.Function$K8)).where((it) -> ListSequence.fromList(SNodeOperations.getNodeDescendants(it, CONCEPTS.ExecuteTestExpression$FP, false, new SAbstractConcept[]{})).isNotEmpty());
      for (SNode func : Sequence.fromIterable(relevantFunctions)) {
        ListSequence.fromList(SNodeOperations.getNodeDescendants(func, CONCEPTS.TestCaseRef$6w, false, new SAbstractConcept[]{})).select((it) -> SLinkOperations.getTarget(it, LINKS.testcase$9iCj)).distinct().where((it) -> SPropertyOperations.getBoolean(it, PROPS.exported$V4am) == false).visitAll((it) -> SPropertyOperations.assign(it, PROPS.exported$V4am, true));
        SNode lastExecTestExpr = ListSequence.fromList(SNodeOperations.getNodeDescendants(func, CONCEPTS.ExecuteTestExpression$FP, false, new SAbstractConcept[]{})).select((it) -> SNodeOperations.getNodeAncestor(it, CONCEPTS.Statement$zV, false, false)).distinct().last();
        SNode tc = createTestCollection_2mrnhp_a0c0c0b0h(SPropertyOperations.getString(func, PROPS.name$MnvL), ListSequence.fromList(SNodeOperations.getNodeDescendants(func, CONCEPTS.TestCaseRef$6w, false, new SAbstractConcept[]{})).select((it) -> SNodeOperations.deleteNode(it)), Sequence.fromIterable(SNodeOperations.ofConcept(SNodeOperations.getPrevSiblings(lastExecTestExpr, false), CONCEPTS.Statement$zV)).where((it) -> ListSequence.fromList(SNodeOperations.getNodeDescendants(it, CONCEPTS.ExecuteTestExpression$FP, false, new SAbstractConcept[]{})).isEmpty()).select((it) -> SNodeOperations.deleteNode(it)));
        MapSequence.fromMap(migratedFuntionts).put(func, tc);
        SNodeOperations.insertPrevSiblingChild(func, tc);
      }
    }
    for (SModel mdl : m.getModels()) {
      Iterable<SNode> relevantFunctions = ListSequence.fromList(SModelOperations.nodes(mdl, CONCEPTS.Function$K8)).where((func) -> ListSequence.fromList(SNodeOperations.getNodeDescendants(func, CONCEPTS.FunctionCall$4q, false, new SAbstractConcept[]{})).any((funcCall) -> MapSequence.fromMap(migratedFuntionts).containsKey(SLinkOperations.getTarget(funcCall, LINKS.function$oBh5))));
      for (SNode func : Sequence.fromIterable(relevantFunctions)) {
        new IAttributeDescriptor.NodeAttribute(CONCEPTS.ElementDocumentation$BO).set(func, createElementDocumentation_2mrnhp_a0a0b0c0h(RichTextUtil.createTextFromSingleString("Please migrate this function manualy to a TestCollection. Please don't forget to set the 'entrypoint' flag if this is a main function.")));
        ListSequence.fromList(functionsToManuallyMigrate).addElement(func);
      }
    }
    SetSequence.fromSet(MapSequence.fromMap(migratedFuntionts).keySet()).visitAll((it) -> SNodeOperations.deleteNode(it));

  }
  @Override
  public Iterable<Problem> check(SModule m) {
    List<Problem> problems = ListSequence.fromList(new ArrayList<Problem>());
    for (SNode func : ListSequence.fromList(functionsToManuallyMigrate)) {
      ListSequence.fromList(problems).addElement(new Problem<SNode>(func) {
        public String getMessage() {
          return "Please migrate manually";
        }

        public String getCategory() {
          return "Testcollection";
        }
      });
    }
    return problems;
  }
  public MigrationScriptReference getReference() {
    return new MigrationScriptReference(MetaAdapterFactory.getLanguage(0x6d68b77b6994918L, 0x83b8857e63787800L, "com.mbeddr.core.unittest"), 2);
  }

  private List<SNode> functionsToManuallyMigrate = new ArrayList<SNode>();

  private static SNode createTestCollection_2mrnhp_a0c0c0b0h(String p0, Iterable<? extends SNode> p1, Iterable<? extends SNode> p2) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.TestCollection$pU);
    n0.setProperty(PROPS.name$MnvL, p0);
    n0.setProperty(PROPS.exported$V4am, "" + (true));
    n0.setProperty(PROPS.entrypoint$RdMb, "" + (false));
    n0.forChild(LINKS.tests$GWNl).initNodeList(p1, CONCEPTS.ICanBeExecutedAsTest$$2);
    {
      SNodeBuilder n1 = n0.forChild(LINKS.testinit$TPnj).init(CONCEPTS.StatementList$y1);
      n1.forChild(LINKS.statements$euTV).initNodeList(p2, CONCEPTS.Statement$zV);
    }
    return n0.getResult();
  }
  private static SNode createElementDocumentation_2mrnhp_a0a0b0c0h(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ElementDocumentation$BO);
    {
      SNodeBuilder n1 = n0.forChild(LINKS.text$RYxn).init(CONCEPTS.TextBlock$N8);
      n1.forChild(LINKS.text$ls7a).initNode(p0, CONCEPTS.Text$bD, true);
    }
    return n0.getResult();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept TestCollection$pU = MetaAdapterFactory.getConcept(0x6d68b77b6994918L, 0x83b8857e63787800L, 0x6e6681f47bde7c66L, "com.mbeddr.core.unittest.structure.TestCollection");
    /*package*/ static final SConcept Function$K8 = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x595522006a5b97e1L, "com.mbeddr.core.modules.structure.Function");
    /*package*/ static final SConcept ExecuteTestExpression$FP = MetaAdapterFactory.getConcept(0x6d68b77b6994918L, 0x83b8857e63787800L, 0x297d618d90ae7a5L, "com.mbeddr.core.unittest.structure.ExecuteTestExpression");
    /*package*/ static final SConcept TestCaseRef$6w = MetaAdapterFactory.getConcept(0x6d68b77b6994918L, 0x83b8857e63787800L, 0x4eeaa4ca8222cf79L, "com.mbeddr.core.unittest.structure.TestCaseRef");
    /*package*/ static final SConcept Statement$zV = MetaAdapterFactory.getConcept(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x3a16e3a9c7ad6d03L, "com.mbeddr.core.statements.structure.Statement");
    /*package*/ static final SConcept FunctionCall$4q = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x52941adca601b38cL, "com.mbeddr.core.modules.structure.FunctionCall");
    /*package*/ static final SConcept ElementDocumentation$BO = MetaAdapterFactory.getConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x3588b64556af217cL, "com.mbeddr.core.base.structure.ElementDocumentation");
    /*package*/ static final SInterfaceConcept ICanBeExecutedAsTest$$2 = MetaAdapterFactory.getInterfaceConcept(0x6d68b77b6994918L, 0x83b8857e63787800L, 0x2c8b3e16ffbade16L, "com.mbeddr.core.unittest.structure.ICanBeExecutedAsTest");
    /*package*/ static final SConcept StatementList$y1 = MetaAdapterFactory.getConcept(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x3a16e3a9c7ad9955L, "com.mbeddr.core.statements.structure.StatementList");
    /*package*/ static final SConcept TextBlock$N8 = MetaAdapterFactory.getConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x743b6d0940760196L, "com.mbeddr.core.base.structure.TextBlock");
    /*package*/ static final SConcept Text$bD = MetaAdapterFactory.getConcept(0x92d2ea165a424fdfL, 0xa676c7604efe3504L, 0x237c8da86a9e4e61L, "de.slisson.mps.richtext.structure.Text");
  }

  private static final class PROPS {
    /*package*/ static final SProperty entrypoint$RdMb = MetaAdapterFactory.getProperty(0x6d68b77b6994918L, 0x83b8857e63787800L, 0x6e6681f47bde7c66L, 0x75f299eb98bcb4deL, "entrypoint");
    /*package*/ static final SProperty exported$V4am = MetaAdapterFactory.getProperty(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x595522006a5b934fL, 0x124a1a47a69807f0L, "exported");
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink testcase$9iCj = MetaAdapterFactory.getReferenceLink(0x6d68b77b6994918L, 0x83b8857e63787800L, 0x4eeaa4ca8222cf79L, 0x4eeaa4ca8222cf7aL, "testcase");
    /*package*/ static final SReferenceLink function$oBh5 = MetaAdapterFactory.getReferenceLink(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x52941adca601b38cL, 0x52941adca601b38dL, "function");
    /*package*/ static final SContainmentLink tests$GWNl = MetaAdapterFactory.getContainmentLink(0x6d68b77b6994918L, 0x83b8857e63787800L, 0x6e6681f47bde7c66L, 0x6e6681f47bde7c69L, "tests");
    /*package*/ static final SContainmentLink testinit$TPnj = MetaAdapterFactory.getContainmentLink(0x6d68b77b6994918L, 0x83b8857e63787800L, 0x6e6681f47bde7c66L, 0x565d67a4327c0739L, "testinit");
    /*package*/ static final SContainmentLink statements$euTV = MetaAdapterFactory.getContainmentLink(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x3a16e3a9c7ad9955L, 0x3a16e3a9c7ad9956L, "statements");
    /*package*/ static final SContainmentLink text$RYxn = MetaAdapterFactory.getContainmentLink(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x3588b64556af217cL, 0x383d2215583174f3L, "text");
    /*package*/ static final SContainmentLink text$ls7a = MetaAdapterFactory.getContainmentLink(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x743b6d0940760196L, 0x743b6d0940760197L, "text");
  }
}
