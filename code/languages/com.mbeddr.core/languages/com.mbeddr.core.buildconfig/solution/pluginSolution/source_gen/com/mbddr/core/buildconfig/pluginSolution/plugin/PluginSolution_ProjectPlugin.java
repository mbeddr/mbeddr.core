package com.mbddr.core.buildconfig.pluginSolution.plugin;

/*Generated by MPS */

import com.mbeddr.mpsutil.spreferences.runtime.SPreferencesProjectPlugin;
import java.util.List;
import jetbrains.mps.plugins.prefs.BaseProjectPrefsComponent;
import com.intellij.openapi.project.Project;
import java.util.ArrayList;
import com.mbeddr.mpsutil.spreferences.runtime.SPreferencesModelFactory;
import org.jetbrains.mps.openapi.model.SModel;
import com.mbeddr.mpsutil.spreferences.runtime.PreferenceModules;
import com.mbeddr.mpsutil.spreferences.runtime.SPreferencesUtil;
import jetbrains.mps.smodel.ModuleRepositoryFacade;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.smodel.Language;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.project.Solution;
import org.jetbrains.mps.openapi.model.EditableSModel;
import com.mbeddr.core.buildconfig.plugin.PlatformTemplateProvider;
import jetbrains.mps.smodel.structure.ExtensionPoint;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import com.mbeddr.mpsutil.spreferences.runtime.SPrefererencesComponent;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SProperty;

public class PluginSolution_ProjectPlugin extends SPreferencesProjectPlugin {

  @Override
  protected List<BaseProjectPrefsComponent> createPreferencesComponents(final Project project) {
    List<BaseProjectPrefsComponent> components = new ArrayList<BaseProjectPrefsComponent>();

    SPreferencesModelFactory factory = new SPreferencesModelFactory() {
      public SModel getModel(final jetbrains.mps.project.Project mpsProject) {
        String id = "PlatformTemplates";
        String title = "Platform Templates";
        String modelName = PreferenceModules.getModelName(mpsProject, false, id);
        String folder = PreferenceModules.getFolder(mpsProject, id, false, false);
        final SModel model = PreferenceModules.getModel(folder, modelName, mpsProject);

        mpsProject.getRepository().getModelAccess().executeCommand(new Runnable() {
          public void run() {
            SPreferencesUtil.useLanguage(model, ModuleRepositoryFacade.getInstance().getModule(PersistenceFacade.getInstance().createModuleReference("2d7fadf5-33f6-4e80-a78f-0f739add2bde(com.mbeddr.core.buildconfig)"), Language.class), mpsProject);

            List<SNode> pageNodes = SModelOperations.roots(model, CONCEPTS.PlatformTemplateContainer$Oy);
            boolean isInit = pageNodes.isEmpty();
            SNode pageNode = (isInit ? null : pageNodes.get(0));
            if (isInit) {
              pageNode = SConceptOperations.createNewNode(SNodeOperations.asInstanceConcept(CONCEPTS.PlatformTemplateContainer$Oy));
              SModelOperations.addRootNode(model, pageNode);
            }

            initUpdate(isInit, pageNode, mpsProject);

            Solution solution = ((Solution) model.getModule());
            if (solution.isChanged() && !(solution.isReadOnly())) {
              solution.save();
            }

            EditableSModel editableModel = ((EditableSModel) model);
            if (editableModel.isChanged() && !(editableModel.isReadOnly())) {
              editableModel.save();
            }
          }
          public void initUpdate(boolean isInit, SNode node, jetbrains.mps.project.Project project) {
            Iterable<PlatformTemplateProvider> templateProviders = new ExtensionPoint<PlatformTemplateProvider>("com.mbeddr.core.buildconfig.PlatformTemplateProviders").getObjects();
            for (PlatformTemplateProvider tp : Sequence.fromIterable(templateProviders)) {
              final SNode template = tp.create();

              boolean alreadyExists = (ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.templates$NPrP)).findFirst((it) -> SPropertyOperations.getString(it, PROPS.name$MnvL).equals(SPropertyOperations.getString(template, PROPS.name$MnvL))) != null);

              if (!(alreadyExists)) {
                ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.templates$NPrP)).addElement(template);
              }
            }
          }
        });

        return model;
      }
    };
    components.add(new SPrefererencesComponent(project, "Platform Templates", PluginSolution_ProjectPlugin.this.getClass().getName(), factory) {
      @Override
      protected boolean enabled(jetbrains.mps.project.Project project) {
        return PluginSolution_ProjectPlugin.this.enabled(project);
      }

      protected SAbstractConcept getRootConcept() {
        return CONCEPTS.PlatformTemplateContainer$Oy;
      }
    });

    return components;
  }


  private static final class CONCEPTS {
    /*package*/ static final SConcept PlatformTemplateContainer$Oy = MetaAdapterFactory.getConcept(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x7900826ed82c4173L, "com.mbeddr.core.buildconfig.structure.PlatformTemplateContainer");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink templates$NPrP = MetaAdapterFactory.getContainmentLink(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x7900826ed82c4173L, 0x7900826ed82c4176L, "templates");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
