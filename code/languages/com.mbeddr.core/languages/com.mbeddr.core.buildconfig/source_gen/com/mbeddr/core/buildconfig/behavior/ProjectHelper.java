package com.mbeddr.core.buildconfig.behavior;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.project.Project;
import jetbrains.mps.project.SModuleOperations;
import java.io.File;
import org.apache.commons.io.FileUtils;
import java.io.IOException;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.smodel.SModelOperations;

public class ProjectHelper {

  private static String MPS_PROJECT_NAME_PATH = ".mps/.name";

  public static String getProjectName(SModel model) {
    Project project = SModuleOperations.getProjectForModule(model.getModule());
    if (project != null) {
      return project.getName();
    }

    File mpsProjectRoot = findAncestorDir(model, (File dir) -> new File(dir, MPS_PROJECT_NAME_PATH).exists());
    if (mpsProjectRoot != null) {
      try {
        return FileUtils.readFileToString(new File(mpsProjectRoot, MPS_PROJECT_NAME_PATH));
      } catch (IOException ex) {
        // Ignore exception
      }
    }

    return null;
  }

  public static String getProjectPathVariableName(SModel model, String suffix) {
    String projectName = getProjectName(model);
    if (projectName != null) {
      return projectName + "." + suffix;
    }
    return null;
  }

  public static File findAncestorDir(SModel model, _FunctionTypes._return_P1_E0<? extends Boolean, ? super File> predicate) {
    IFile outputLocation = SModelOperations.getOutputLocation(model);
    if (outputLocation != null) {
      File dir = new File(outputLocation.getPath());
      while (dir.getParentFile() != null) {
        dir = dir.getParentFile();
        if (predicate.invoke(dir)) {
          return dir;
        }
      }
    }
    return null;
  }
}
