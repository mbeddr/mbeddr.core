package com.mbeddr.core.buildconfig.behavior;

/*Generated by MPS */

import jetbrains.mps.core.aspects.behaviour.BaseBHDescriptor;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.core.aspects.behaviour.api.SMethod;
import jetbrains.mps.core.aspects.behaviour.SMethodBuilder;
import jetbrains.mps.core.aspects.behaviour.SJavaCompoundTypeImpl;
import jetbrains.mps.core.aspects.behaviour.AccessPrivileges;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.Map;
import java.util.List;
import org.jetbrains.mps.openapi.model.SModel;
import java.util.Arrays;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.internal.collections.runtime.IMapping;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import jetbrains.mps.project.PathMacros;
import com.mbeddr.core.buildconfig.plugin.BuildVariableResolver;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.structure.ExtensionPoint;
import jetbrains.mps.core.aspects.behaviour.api.SConstructor;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.core.aspects.behaviour.api.BHMethodNotFoundException;

public final class IBuildVariableProvider__BehaviorDescriptor extends BaseBHDescriptor {
  private static final SAbstractConcept CONCEPT = MetaAdapterFactory.getInterfaceConcept(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x68589b59d3d2d064L, "com.mbeddr.core.buildconfig.structure.IBuildVariableProvider");

  public static final SMethod<String> relativizeDefaultValue_id3JWussfjtXe = new SMethodBuilder<String>(new SJavaCompoundTypeImpl(String.class)).name("relativizeDefaultValue").modifiers(9, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(4322463638231048014L).languageId(0xa78f0f739add2bdeL, 0x2d7fadf533f64e80L).build2(SMethodBuilder.createJavaParameter((Class<SNode>) ((Class) Object.class), ""), SMethodBuilder.createJavaParameter(String.class, ""), SMethodBuilder.createJavaParameter((Class<Map<String, String>>) ((Class) Object.class), ""));
  public static final SMethod<List<String>> getVariableNames_id6xoAPBjOH1K = new SMethodBuilder<List<String>>(new SJavaCompoundTypeImpl((Class<List<String>>) ((Class) Object.class))).name("getVariableNames").modifiers(12, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(7518930388003246192L).languageId(0xa78f0f739add2bdeL, 0x2d7fadf533f64e80L).build2();
  public static final SMethod<String> getDefaultValue_id6xoAPBjOH2T = new SMethodBuilder<String>(new SJavaCompoundTypeImpl(String.class)).name("getDefaultValue").modifiers(8, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(7518930388003246265L).languageId(0xa78f0f739add2bdeL, 0x2d7fadf533f64e80L).build2(SMethodBuilder.createJavaParameter((Class<SModel>) ((Class) Object.class), ""), SMethodBuilder.createJavaParameter(String.class, ""));

  private static final List<SMethod<?>> BH_METHODS = Arrays.<SMethod<?>>asList(relativizeDefaultValue_id3JWussfjtXe, getVariableNames_id6xoAPBjOH1K, getDefaultValue_id6xoAPBjOH2T);

  private static void ___init___(@NotNull SNode __thisNode__) {
  }

  /*package*/ static String relativizeDefaultValue_id3JWussfjtXe(@NotNull SAbstractConcept __thisConcept__, SNode platform, String defaultValue, Map<String, String> otherVariables) {
    final Wrappers._T<String> _defaultValue = new Wrappers._T<String>(defaultValue);
    // Relativize given build variable default value wrt other build variables in case their default values match a portion of the given build variable default value 
    if (isNotEmptyString(_defaultValue.value)) {
      IMapping<String, String> greediestPrefix = MapSequence.fromMap(otherVariables).where((it) -> isNotEmptyString(it.value()) && _defaultValue.value.startsWith(it.value())).reduceLeft((a, b) -> (a.value().length() > b.value().length() ? a : b));
      if (greediestPrefix != null) {
        _defaultValue.value = Platform__BehaviorDescriptor.getBuildVariableRef_id3JWussfcuHl.invoke(platform, greediestPrefix.key()) + _defaultValue.value.substring(greediestPrefix.value().length(), _defaultValue.value.length());
      }
    }
    return _defaultValue.value;
  }
  /*package*/ static String getDefaultValue_id6xoAPBjOH2T(@NotNull SNode __thisNode__, SModel model, String variableName) {
    // First: Try to resolve build variable against MPS path variables
    String pathVariableName = BuildVariableHelper.toDottedName(variableName).toLowerCase();
    String qualifiedPathVariableName = ProjectHelper.getProjectPathVariableName(model, pathVariableName);
    if (qualifiedPathVariableName != null) {
      String defaultValue = PathMacros.getInstance().getValue(qualifiedPathVariableName);
      if (defaultValue != null) {
        return defaultValue;
      }
    } else {
      String defaultValue = PathMacros.getInstance().getValue(pathVariableName);
      if (defaultValue != null) {
        return defaultValue;
      }
    }

    // Second: Try to resolve build variable against contributed build variable resolvers
    for (BuildVariableResolver resolver : Sequence.fromIterable(new ExtensionPoint<BuildVariableResolver>("com.mbeddr.core.buildconfig.BuildVariableResolvers").getObjects())) {
      String devaultValue = resolver.resolveVariable(model, variableName);
      if (devaultValue != null) {
        return devaultValue;
      }
    }

    return null;
  }

  /*package*/ IBuildVariableProvider__BehaviorDescriptor() {
  }

  @Override
  protected void initNode(@NotNull SNode node, @NotNull SConstructor constructor, @Nullable Object[] parameters) {
    ___init___(node);
  }

  @Override
  protected <T> T invokeSpecial0(@NotNull SNode node, @NotNull SMethod<T> method, @Nullable Object[] parameters) {
    int methodIndex = BH_METHODS.indexOf(method);
    if (methodIndex < 0) {
      throw new BHMethodNotFoundException(this, method);
    }
    switch (methodIndex) {
      case 2:
        return (T) ((String) getDefaultValue_id6xoAPBjOH2T(node, (SModel) parameters[0], (String) parameters[1]));
      default:
        throw new BHMethodNotFoundException(this, method);
    }
  }

  @Override
  protected <T> T invokeSpecial0(@NotNull SAbstractConcept concept, @NotNull SMethod<T> method, @Nullable Object[] parameters) {
    int methodIndex = BH_METHODS.indexOf(method);
    if (methodIndex < 0) {
      throw new BHMethodNotFoundException(this, method);
    }
    switch (methodIndex) {
      case 0:
        return (T) ((String) relativizeDefaultValue_id3JWussfjtXe(concept, (SNode) parameters[0], (String) parameters[1], (Map<String, String>) parameters[2]));
      default:
        throw new BHMethodNotFoundException(this, method);
    }
  }

  @NotNull
  @Override
  public List<SMethod<?>> getDeclaredMethods() {
    return BH_METHODS;
  }

  @NotNull
  @Override
  public SAbstractConcept getConcept() {
    return CONCEPT;
  }
  private static boolean isNotEmptyString(String str) {
    return str != null && str.length() > 0;
  }
}
