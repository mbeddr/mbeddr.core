package com.mbeddr.core.buildconfig.typesystem;

/*Generated by MPS */

import java.util.List;
import jetbrains.mps.smodel.Language;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.LinkedList;
import jetbrains.mps.smodel.MPSModuleRepository;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import org.jetbrains.mps.openapi.language.SLanguage;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import jetbrains.mps.smodel.SModelInternal;
import org.jetbrains.mps.openapi.module.SModuleReference;
import org.jetbrains.mps.openapi.module.SModule;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class LanguagesImportChecker {

  /**
   * TODO: No usages of this class. Should it be deleted?
   * 
   * @deprecated 
   */
  @Deprecated
  public static List<Language> getLanguagesNotEnabled(SNode binary) {
    List<Language> problematicLanguages = ListSequence.fromList(new LinkedList<Language>());
    MPSModuleRepository mr = MPSModuleRepository.getInstance();

    final SModel currentModel = SNodeOperations.getModel(binary);
    Iterable<SNode> moduleReferences = SLinkOperations.getChildren(binary, LINKS.referencedModules$Su7l);
    Iterable<SNode> modules = Sequence.fromIterable(moduleReferences).select((it) -> SLinkOperations.getTarget(it, LINKS.module$6_LN));

    Iterable<SNode> modulesInOtherModel = Sequence.fromIterable(modules).where((it) -> it != null && !(SModelOperations.getModelName(SNodeOperations.getModel(it)).equals(SModelOperations.getModelName(currentModel))));
    if (Sequence.fromIterable(modulesInOtherModel).isEmpty()) {
      return problematicLanguages;
    }

    Iterable<Language> usedLanguagesInCurrentModel = getUsedLanguages(currentModel);
    Set<Language> usedLanguagesInOtherModels = SetSequence.fromSet(new HashSet<Language>());

    Iterable<SModel> dependentModels = Sequence.fromIterable(modulesInOtherModel).select((it) -> SNodeOperations.getModel(it)).distinct();
    for (SModel m : Sequence.fromIterable(dependentModels)) {
      SetSequence.fromSet(usedLanguagesInOtherModels).addSequence(Sequence.fromIterable(getUsedLanguages(m)));
    }

    Iterable<Language> languagesNotCurrentlyUsed = SetSequence.fromSet(usedLanguagesInOtherModels).subtract(Sequence.fromIterable(usedLanguagesInCurrentModel));
    Iterable<Language> languagesWithGenerators = Sequence.fromIterable(languagesNotCurrentlyUsed).where((it) -> !(it.getGenerators().isEmpty()));

    List<Language> engagedOnGenerationLanguages = ListSequence.fromList(new LinkedList<Language>());
    for (SLanguage ref : CollectionSequence.fromCollection(((SModelInternal) binary.getModel()).getLanguagesEngagedOnGeneration())) {
      SModuleReference sourceModuleReference = ref.getSourceModuleReference();
      if (sourceModuleReference != null) {
        SModule resolve = sourceModuleReference.resolve(mr);
        if (resolve instanceof Language) {
          ListSequence.fromList(engagedOnGenerationLanguages).addElement((Language) resolve);
        }
      }
    }
    return Sequence.fromIterable(languagesWithGenerators).subtract(ListSequence.fromList(engagedOnGenerationLanguages)).toList();
  }

  private static Iterable<Language> getUsedLanguages(SModel model) {
    Iterable<SLanguage> importedLanguageIds = ((SModelInternal) model).importedLanguageIds();
    return Sequence.fromIterable(importedLanguageIds).select((it) -> it.getSourceModule()).ofType(Language.class);
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink referencedModules$Su7l = MetaAdapterFactory.getContainmentLink(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x46097107c8d98c14L, 0x46097107c8d98c17L, "referencedModules");
    /*package*/ static final SReferenceLink module$6_LN = MetaAdapterFactory.getReferenceLink(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x6b1af9f9f43c2f4bL, 0x6b1af9f9f43c2f4cL, "module");
  }
}
