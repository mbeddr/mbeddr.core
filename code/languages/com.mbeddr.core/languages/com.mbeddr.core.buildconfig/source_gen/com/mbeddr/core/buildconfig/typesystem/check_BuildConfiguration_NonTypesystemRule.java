package com.mbeddr.core.buildconfig.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.runtime.AbstractNonTypesystemRule_Runtime;
import jetbrains.mps.lang.typesystem.runtime.NonTypesystemRule_Runtime;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import jetbrains.mps.lang.typesystem.runtime.IsApplicableStatus;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import java.util.List;
import com.mbeddr.core.buildconfig.behavior.Platform__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.errors.messageTargets.MessageTarget;
import jetbrains.mps.errors.messageTargets.PropertyMessageTarget;
import jetbrains.mps.errors.IErrorReporter;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.errors.messageTargets.NodeMessageTarget;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import com.mbeddr.mpsutil.genutil.plugin.GenerationHelper;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import com.mbeddr.core.base.behavior.IConfigurationItem__BehaviorDescriptor;
import jetbrains.mps.lang.core.behavior.BaseConcept__BehaviorDescriptor;
import jetbrains.mps.errors.BaseQuickFixProvider;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SConcept;

public class check_BuildConfiguration_NonTypesystemRule extends AbstractNonTypesystemRule_Runtime implements NonTypesystemRule_Runtime {
  public check_BuildConfiguration_NonTypesystemRule() {
  }
  public void applyRule(final SNode bc, final TypeCheckingContext typeCheckingContext, IsApplicableStatus status) {
    SNode platform = SLinkOperations.getTarget(bc, LINKS.platform$sQSW);
    if (platform != null) {
      List<SNode> allowedConcepts = Platform__BehaviorDescriptor.getBinaryKind_id5HxjapwgqKP.invoke(platform);
      for (SNode bin : ListSequence.fromList(SLinkOperations.getChildren(bc, LINKS.binaries$R6lf))) {
        if (!(ListSequence.fromList(allowedConcepts).contains(SNodeOperations.asNode(SNodeOperations.getConcept(bin))))) {
          {
            final MessageTarget errorTarget = new PropertyMessageTarget(PROPS.name$MnvL);
            IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(bin, SConceptOperations.conceptAlias(SNodeOperations.getConcept(bin)) + " is not allowed; possible choices are " + ListSequence.fromList(allowedConcepts).foldLeft("", (String s, SNode it) -> s + ", " + SPropertyOperations.getString(it, PROPS.conceptAlias$OL_L)), "r:3ff8d811-87f2-49a7-b8a3-5cb1e610f6d2(com.mbeddr.core.buildconfig.typesystem)", "4509600423770391118", null, errorTarget);
          }
        }
      }
    }
    if (ModelCycleChecker.hasCycle(SNodeOperations.getModel(bc))) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(bc, "model has cycles", "r:3ff8d811-87f2-49a7-b8a3-5cb1e610f6d2(com.mbeddr.core.buildconfig.typesystem)", "3900250865135257909", null, errorTarget);
      }
    }
    List<SNode> buildConfigs = SModelOperations.roots(SNodeOperations.getModel(bc), CONCEPTS.BuildConfiguration$kH);
    if (ListSequence.fromList(buildConfigs).count() > 1) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(bc, "a model can only contain one build config", "r:3ff8d811-87f2-49a7-b8a3-5cb1e610f6d2(com.mbeddr.core.buildconfig.typesystem)", "3963667026131086847", null, errorTarget);
      }
    }
    if (ListSequence.fromList(SLinkOperations.getChildren(bc, LINKS.binaries$R6lf)).count() > 1 && ListSequence.fromList(SLinkOperations.getChildren(bc, LINKS.binaries$R6lf)).any((it) -> SNodeOperations.isInstanceOf(it, CONCEPTS.Library$qy))) {
      ListSequence.fromList(SLinkOperations.getChildren(bc, LINKS.binaries$R6lf)).visitAll((it) -> {
        {
          final MessageTarget errorTarget = new NodeMessageTarget();
          IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(it, "only a single library, a single executable or many executables are allowed", "r:3ff8d811-87f2-49a7-b8a3-5cb1e610f6d2(com.mbeddr.core.buildconfig.typesystem)", "8758138335591177769", null, errorTarget);
        }
      });
    }
    if (GenerationHelper.isXModelGen(SNodeOperations.getModel(bc))) {
      Iterable<SModel> foreigModels = ListSequence.fromList(SLinkOperations.getChildren(bc, LINKS.binaries$R6lf)).translate((it) -> {
        return Sequence.fromIterable(SLinkOperations.collect(SLinkOperations.getChildren(it, LINKS.referencedModules$Su7l), LINKS.module$6_LN)).select(new _FunctionTypes._return_P1_E0<SModel, SNode>() {
          public SModel invoke(SNode it) {
            return SNodeOperations.getModel(it);
          }
        });
      }).distinct().where((it) -> it != SNodeOperations.getModel(bc));
      for (SModel mdl : Sequence.fromIterable(foreigModels).where((it) -> !(GenerationHelper.isXModelGen(it)))) {
        {
          final MessageTarget errorTarget = new NodeMessageTarget();
          IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(bc, "The model " + mdl + " isn't using cross model generation. Generation will be impossible", "r:3ff8d811-87f2-49a7-b8a3-5cb1e610f6d2(com.mbeddr.core.buildconfig.typesystem)", "615639685074909463", null, errorTarget);
        }
      }
      Iterable<SNode> downstreamConfigs = Sequence.fromIterable(foreigModels).select((it) -> ListSequence.fromList(SModelOperations.roots(it, CONCEPTS.BuildConfiguration$kH)).first());

      for (final SNode item : ListSequence.fromList(SLinkOperations.getChildren(bc, LINKS.configurationItems$HPvE))) {
        Iterable<SNode> downstreamItems = Sequence.fromIterable(downstreamConfigs).select((it) -> {
          return ListSequence.fromList(SLinkOperations.getChildren(it, LINKS.configurationItems$HPvE)).findFirst(new _FunctionTypes._return_P1_E0<Boolean, SNode>() {
            public Boolean invoke(SNode it) {
              return SNodeOperations.isInstanceOf(it, SNodeOperations.asSConcept(SNodeOperations.getConcept(item)));
            }
          });
        });
        for (SNode downstreamItem : Sequence.fromIterable(downstreamItems)) {
          if (!((boolean) IConfigurationItem__BehaviorDescriptor.isCompatible_idybcgwyxJcI.invoke(item, downstreamItem))) {
            {
              final MessageTarget errorTarget = new NodeMessageTarget();
              IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(item, "The downstream configuration item " + BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(downstreamItem) + " is not compatible", "r:3ff8d811-87f2-49a7-b8a3-5cb1e610f6d2(com.mbeddr.core.buildconfig.typesystem)", "615639685075080256", null, errorTarget);
              {
                BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("com.mbeddr.core.buildconfig.typesystem.pullUpConfig_QuickFix", "615639685075153102", false);
                intentionProvider.putArgument("self", item);
                intentionProvider.putArgument("other", downstreamItem);
                _reporter_2309309498.addIntentionProvider(intentionProvider);
              }
            }
          }
        }
        if (!((boolean) IConfigurationItem__BehaviorDescriptor.canHandleCrossModelGeneration_idybcgwyBbFy.invoke(item))) {
          {
            final MessageTarget errorTarget = new NodeMessageTarget();
            IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(item, "The configuration item " + BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(item) + " isn't compatible with cross model generation", "r:3ff8d811-87f2-49a7-b8a3-5cb1e610f6d2(com.mbeddr.core.buildconfig.typesystem)", "615639685079171749", null, errorTarget);
          }
        }
      }
    }
  }
  public SAbstractConcept getApplicableConcept() {
    return CONCEPTS.BuildConfiguration$kH;
  }
  public IsApplicableStatus isApplicableAndPattern(SNode argument) {
    return new IsApplicableStatus(argument.getConcept().isSubConceptOf(getApplicableConcept()), null);
  }
  public boolean overrides() {
    return false;
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink platform$sQSW = MetaAdapterFactory.getContainmentLink(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x6b1af9f9f43c2f48L, 0x49e1b9dfef127632L, "platform");
    /*package*/ static final SContainmentLink binaries$R6lf = MetaAdapterFactory.getContainmentLink(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x6b1af9f9f43c2f48L, 0x46097107c8de43cbL, "binaries");
    /*package*/ static final SContainmentLink referencedModules$Su7l = MetaAdapterFactory.getContainmentLink(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x46097107c8d98c14L, 0x46097107c8d98c17L, "referencedModules");
    /*package*/ static final SReferenceLink module$6_LN = MetaAdapterFactory.getReferenceLink(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x6b1af9f9f43c2f4bL, 0x6b1af9f9f43c2f4cL, "module");
    /*package*/ static final SContainmentLink configurationItems$HPvE = MetaAdapterFactory.getContainmentLink(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x3de41a718bc20029L, 0x3de41a718bc2002aL, "configurationItems");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
    /*package*/ static final SProperty conceptAlias$OL_L = MetaAdapterFactory.getProperty(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0x1103553c5ffL, 0x46ab0ad5826c74caL, "conceptAlias");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept BuildConfiguration$kH = MetaAdapterFactory.getConcept(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x6b1af9f9f43c2f48L, "com.mbeddr.core.buildconfig.structure.BuildConfiguration");
    /*package*/ static final SConcept Library$qy = MetaAdapterFactory.getConcept(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x25147963acd8c9a2L, "com.mbeddr.core.buildconfig.structure.Library");
  }
}
