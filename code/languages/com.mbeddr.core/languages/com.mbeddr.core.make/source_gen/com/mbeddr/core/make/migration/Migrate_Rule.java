package com.mbeddr.core.make.migration;

/*Generated by MPS */

import jetbrains.mps.lang.migration.runtime.base.MigrationScriptBase;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.module.SModule;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import java.util.Objects;
import jetbrains.mps.lang.core.behavior.PropertyAttribute__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.lang.migration.runtime.base.MigrationScriptReference;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class Migrate_Rule extends MigrationScriptBase {
  private final String description = "Migrate_Rule";
  public String getCaption() {
    return description;
  }
  @Override
  public boolean isRerunnable() {
    return true;
  }
  public SNode execute(final SModule m) {
    doExecute(m);
    return null;
  }
  public void doExecute(final SModule m) {
    for (SModel model : m.getModels()) {
      ListSequence.fromList(SModelOperations.nodes(model, CONCEPTS.Rule$it)).visitAll((final SNode rule) -> {
        // Migrate target property to plain text target item
        if (isNotEmptyString(trim_pm4hbc_a0a1a0a0a0a0e(SPropertyOperations.getString(rule, PROPS.target_old$b5Ne)))) {
          SNode target = createTarget_pm4hbc_a0a0b0a0a0a0a6(trim_pm4hbc_a0a0a0a1a0a0a0a0e(SPropertyOperations.getString(rule, PROPS.target_old$b5Ne)));

          SNode targetPropertyMacro = Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.getChildren(rule, LINKS.smodelAttribute$KJ43), CONCEPTS.PropertyMacro$c9)).findFirst((it) -> Objects.equals(PropertyAttribute__BehaviorDescriptor.getProperty_id1avfQ4BBzOo.invoke(it), PROPS.target_old$b5Ne));
          if ((targetPropertyMacro != null)) {
            SNode textPropertyMacro = SNodeOperations.copyNode(targetPropertyMacro);
            PropertyAttribute__BehaviorDescriptor.setProperty_id6Gg5Klvu8CV.invoke(textPropertyMacro, PROPS.text$Iv7e);
            ListSequence.fromList(SLinkOperations.getChildren(ListSequence.fromList(SLinkOperations.getChildren(target, LINKS.targetItems$Ks$I)).first(), LINKS.smodelAttribute$KJ43)).addElement(textPropertyMacro);
          }

          ListSequence.fromList(SLinkOperations.getChildren(rule, LINKS.targets$qa4e)).addElement(target);
          SPropertyOperations.assign(rule, PROPS.target_old$b5Ne, null);
          SNodeOperations.deleteNode(targetPropertyMacro);
        }

        // Migrate dependencies to prerequisites
        ListSequence.fromList(SLinkOperations.getChildren(rule, LINKS.dependencies_old$bbTC)).visitAll((dependency) -> {
          SNode prerequisiteItem = null;
          SAbstractConcept cncpt = SNodeOperations.getConcept(dependency);
          boolean noneMatched = true;
          if (noneMatched && SConceptOperations.isSubConceptOf(cncpt, CONCEPTS.ModuleRefDependency$zt)) {
            noneMatched = false;
            prerequisiteItem = createModuleRef_pm4hbc_a0a0a1a0a0e0a0a0a0a6(SLinkOperations.getTarget(SNodeOperations.cast(dependency, CONCEPTS.ModuleRefDependency$zt), LINKS.module$KY1h));
          }
          if (noneMatched && SConceptOperations.isSubConceptOf(cncpt, CONCEPTS.TargetDependency$MQ)) {
            noneMatched = false;
            prerequisiteItem = createRuleRef_pm4hbc_a0a0b1a0a0e0a0a0a0a6(SLinkOperations.getTarget(SNodeOperations.cast(dependency, CONCEPTS.TargetDependency$MQ), LINKS.target$pPZI));
          }
          if (noneMatched && SConceptOperations.isSubConceptOf(cncpt, CONCEPTS.TextDependency$Tn)) {
            noneMatched = false;
            prerequisiteItem = createPlainTextFragment_pm4hbc_a0a0c1a0a0e0a0a0a0a6(trim_pm4hbc_a0a0a1a5a0a0e0a0a0a0a4(SPropertyOperations.getString(SNodeOperations.cast(dependency, CONCEPTS.TextDependency$Tn), PROPS.text$9Tge)));

            SNode textDependencyTextPropertyMacro = Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.getChildren(dependency, LINKS.smodelAttribute$KJ43), CONCEPTS.PropertyMacro$c9)).findFirst((it) -> Objects.equals(PropertyAttribute__BehaviorDescriptor.getProperty_id1avfQ4BBzOo.invoke(it), PROPS.text$9Tge));
            if ((textDependencyTextPropertyMacro != null)) {
              SNode plainTextFragmentTextPropertyMacro = SNodeOperations.copyNode(textDependencyTextPropertyMacro);
              PropertyAttribute__BehaviorDescriptor.setProperty_id6Gg5Klvu8CV.invoke(plainTextFragmentTextPropertyMacro, PROPS.text$Iv7e);
              ListSequence.fromList(SLinkOperations.getChildren(prerequisiteItem, LINKS.smodelAttribute$KJ43)).addElement(plainTextFragmentTextPropertyMacro);
            }
          }
          SNode prerequisite = createPrerequisite_pm4hbc_a0c0a0a4a0a0a0a0g(prerequisiteItem);

          SNode dependencyNodeMacro = Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.getChildren(dependency, LINKS.smodelAttribute$KJ43), CONCEPTS.NodeMacro$qU)).first();
          if ((dependencyNodeMacro != null)) {
            SNode prerequisiteNodeMacro = SNodeOperations.copyNode(dependencyNodeMacro);
            ListSequence.fromList(SLinkOperations.getChildren(prerequisite, LINKS.smodelAttribute$KJ43)).addElement(prerequisiteNodeMacro);
          }

          ListSequence.fromList(SLinkOperations.getChildren(rule, LINKS.prerequisites$qiYO)).addElement(prerequisite);
          SNodeOperations.deleteNode(dependency);
        });

        // Migrate commands and conditional directives to recipes
        ListSequence.fromList(SLinkOperations.getChildren(rule, LINKS.recipes$lWG4)).addSequence(ListSequence.fromList(SLinkOperations.getChildren(rule, LINKS.commands_old$bc8D)));
        ListSequence.fromList(SLinkOperations.getChildren(rule, LINKS.recipes$lWG4)).addSequence(ListSequence.fromList(SLinkOperations.getChildren(rule, LINKS.conditionalDirectives_old$W_Gv)));
      });
    }
  }
  public MigrationScriptReference getReference() {
    return new MigrationScriptReference(MetaAdapterFactory.getLanguage(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, "com.mbeddr.core.make"), 5);
  }

  private static SNode createTarget_pm4hbc_a0a0b0a0a0a0a6(String p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.Target$0);
    {
      SNodeBuilder n1 = n0.forChild(LINKS.targetItems$Ks$I).init(CONCEPTS.PlainTextFragment$55);
      n1.setProperty(PROPS.text$Iv7e, p0);
    }
    return n0.getResult();
  }
  private static SNode createModuleRef_pm4hbc_a0a0a1a0a0e0a0a0a0a6(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.ModuleRef$nR);
    n0.setReferenceTarget(LINKS.module$cCwe, p0);
    return n0.getResult();
  }
  private static SNode createRuleRef_pm4hbc_a0a0b1a0a0e0a0a0a0a6(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.RuleRef$ep);
    n0.setReferenceTarget(LINKS.rule$O3Le, p0);
    return n0.getResult();
  }
  private static SNode createPlainTextFragment_pm4hbc_a0a0c1a0a0e0a0a0a0a6(String p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.PlainTextFragment$55);
    n0.setProperty(PROPS.text$Iv7e, p0);
    return n0.getResult();
  }
  private static SNode createPrerequisite_pm4hbc_a0c0a0a4a0a0a0a0g(SNode p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.Prerequisite$8Z);
    {
      SNodeBuilder n1 = n0.forChild(LINKS.prerequisiteItems$o14e).initNode(p0, CONCEPTS.IMakefileItem$6I, false);
    }
    return n0.getResult();
  }
  public static String trim_pm4hbc_a0a0a0a1a0a0a0a0e(String str) {
    return (str == null ? null : str.trim());
  }
  private static boolean isNotEmptyString(String str) {
    return str != null && str.length() > 0;
  }
  public static String trim_pm4hbc_a0a1a0a0a0a0e(String str) {
    return (str == null ? null : str.trim());
  }
  public static String trim_pm4hbc_a0a0a1a5a0a0e0a0a0a0a4(String str) {
    return (str == null ? null : str.trim());
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Rule$it = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x52941adca602a85dL, "com.mbeddr.core.make.structure.Rule");
    /*package*/ static final SConcept PropertyMacro$c9 = MetaAdapterFactory.getConcept(0xb401a68083254110L, 0x8fd384331ff25befL, 0xfd47e9f6f0L, "jetbrains.mps.lang.generator.structure.PropertyMacro");
    /*package*/ static final SConcept ModuleRefDependency$zt = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x2e3a8f3a6f9314dL, "com.mbeddr.core.make.structure.ModuleRefDependency");
    /*package*/ static final SConcept TargetDependency$MQ = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0xa591393969f19f9L, "com.mbeddr.core.make.structure.TargetDependency");
    /*package*/ static final SConcept TextDependency$Tn = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x52941adca602b363L, "com.mbeddr.core.make.structure.TextDependency");
    /*package*/ static final SConcept NodeMacro$qU = MetaAdapterFactory.getConcept(0xb401a68083254110L, 0x8fd384331ff25befL, 0xfd47ed6742L, "jetbrains.mps.lang.generator.structure.NodeMacro");
    /*package*/ static final SConcept Target$0 = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x7abf078658cd2a9fL, "com.mbeddr.core.make.structure.Target");
    /*package*/ static final SConcept PlainTextFragment$55 = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x2ed28d95c2ca1923L, "com.mbeddr.core.make.structure.PlainTextFragment");
    /*package*/ static final SConcept ModuleRef$nR = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x2e3a8f3a6f8e243L, "com.mbeddr.core.make.structure.ModuleRef");
    /*package*/ static final SConcept RuleRef$ep = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x7abf07865612f2b5L, "com.mbeddr.core.make.structure.RuleRef");
    /*package*/ static final SConcept Prerequisite$8Z = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x7abf078658cd4452L, "com.mbeddr.core.make.structure.Prerequisite");
    /*package*/ static final SInterfaceConcept IMakefileItem$6I = MetaAdapterFactory.getInterfaceConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x4d97d3d526ace831L, "com.mbeddr.core.make.structure.IMakefileItem");
  }

  private static final class PROPS {
    /*package*/ static final SProperty target_old$b5Ne = MetaAdapterFactory.getProperty(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x52941adca602a85dL, 0x52941adca602a85eL, "target_old");
    /*package*/ static final SProperty text$Iv7e = MetaAdapterFactory.getProperty(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x2ed28d95c2ca1923L, 0x2ed28d95c2ca1924L, "text");
    /*package*/ static final SProperty text$9Tge = MetaAdapterFactory.getProperty(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x52941adca602b363L, 0x52941adca602b364L, "text");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink smodelAttribute$KJ43 = MetaAdapterFactory.getContainmentLink(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x10802efe25aL, 0x47bf8397520e5942L, "smodelAttribute");
    /*package*/ static final SContainmentLink targetItems$Ks$I = MetaAdapterFactory.getContainmentLink(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x7abf078658cd2a9fL, 0x7abf078658cd2aa0L, "targetItems");
    /*package*/ static final SContainmentLink targets$qa4e = MetaAdapterFactory.getContainmentLink(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x52941adca602a85dL, 0x7abf078658da4d96L, "targets");
    /*package*/ static final SContainmentLink dependencies_old$bbTC = MetaAdapterFactory.getContainmentLink(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x52941adca602a85dL, 0x52941adca602a863L, "dependencies_old");
    /*package*/ static final SReferenceLink module$KY1h = MetaAdapterFactory.getReferenceLink(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x2e3a8f3a6f9314dL, 0x2e3a8f3a6f93167L, "module");
    /*package*/ static final SReferenceLink target$pPZI = MetaAdapterFactory.getReferenceLink(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0xa591393969f19f9L, 0xa591393969f19faL, "target");
    /*package*/ static final SContainmentLink prerequisites$qiYO = MetaAdapterFactory.getContainmentLink(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x52941adca602a85dL, 0x7abf078658da4da7L, "prerequisites");
    /*package*/ static final SContainmentLink recipes$lWG4 = MetaAdapterFactory.getContainmentLink(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x52941adca602a85dL, 0x18fb69d7d066986fL, "recipes");
    /*package*/ static final SContainmentLink commands_old$bc8D = MetaAdapterFactory.getContainmentLink(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x52941adca602a85dL, 0x52941adca602a864L, "commands_old");
    /*package*/ static final SContainmentLink conditionalDirectives_old$W_Gv = MetaAdapterFactory.getContainmentLink(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x52941adca602a85dL, 0x22c2a484f9d6ed7cL, "conditionalDirectives_old");
    /*package*/ static final SReferenceLink module$cCwe = MetaAdapterFactory.getReferenceLink(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x2e3a8f3a6f8e243L, 0x2e3a8f3a6f8e244L, "module");
    /*package*/ static final SReferenceLink rule$O3Le = MetaAdapterFactory.getReferenceLink(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x7abf07865612f2b5L, 0x7abf07865612f2b6L, "rule");
    /*package*/ static final SContainmentLink prerequisiteItems$o14e = MetaAdapterFactory.getContainmentLink(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x7abf078658cd4452L, 0x7abf078658cd4453L, "prerequisiteItems");
  }
}
