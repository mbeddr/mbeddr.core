package com.mbeddr.core.make.plugin;

/*Generated by MPS */

import org.jetbrains.annotations.NotNull;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.smodel.MPSModuleRepository;
import java.util.Iterator;
import jetbrains.mps.textgen.trace.DebugInfo;
import jetbrains.mps.textgen.trace.DefaultTraceInfoProvider;

public class TraceUtil {

  public static TracingLocation extractLocation(@NotNull String makeOutput, @NotNull String fqModelName) {
    List<String> output = Sequence.fromIterable(Sequence.fromArray(makeOutput.split(":"))).toList();
    TracingLocation location = null;
    if (ListSequence.fromList(output).count() > 3 && MakeUtil.isNumber(ListSequence.fromList(output).getElement(LogWriter.LINE_NUMBER_INDEX)) && MakeUtil.isCFile(ListSequence.fromList(output).getElement(LogWriter.FILE_NAME_INDEX))) {
      final String fileName = ListSequence.fromList(output).getElement(LogWriter.FILE_NAME_INDEX);
      final String unitName = MakeUtil.getModelName(fqModelName) + "." + Sequence.fromIterable(Sequence.fromArray(fileName.split("\\."))).first();
      final int lineNumber = Integer.parseInt(ListSequence.fromList(output).getElement(LogWriter.LINE_NUMBER_INDEX));
      location = new TracingLocation(fileName, unitName, lineNumber);
    }
    return location;
  }

  /**
   * 
   * @deprecated  FIXME denoted deprecated to get discovered easily and refactored to supply context repo and model fqname instead of unit name in TracingLocation
   */
  @Deprecated
  public static SNodeReference loadNodeFromTrace(@NotNull final TracingLocation location) {
    final Wrappers._T<SNodeReference> result = new Wrappers._T<SNodeReference>();
    final SRepository contextRepo = MPSModuleRepository.getInstance();
    contextRepo.getModelAccess().runReadAction(() -> {
      // FIXME this is the reversal of unitName from extractLocation above. Replace unitName with modelName in TracingLocation
      // to avoid unnecessary name mangling
      String modelName = location.getUnitName();
      modelName = modelName.substring(0, modelName.lastIndexOf('.'));
      for (Iterator<DebugInfo> di = new DefaultTraceInfoProvider(contextRepo).debugInfo(modelName).iterator(); di.hasNext();) {
        List<SNodeReference> tracedNodesForPosition = di.next().getTracedNodesForPosition(location.getFileName(), location.getLineNumber());
        if (!(tracedNodesForPosition.isEmpty())) {
          result.value = tracedNodesForPosition.iterator().next();
          break;
        }
      }
    });
    return result.value;
  }

}
