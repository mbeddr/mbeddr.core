package com.mbeddr.core.make.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SModel;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.baseLanguage.logging.rt.LogContext;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.smodel.language.LanguageRegistry;
import jetbrains.mps.smodel.ModelDependencyResolver;
import org.jetbrains.mps.openapi.language.SLanguage;
import java.util.stream.Collectors;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.model.SModelReference;
import jetbrains.mps.smodel.ModelImports;

public class UsedLanguageCollector {

  public static void usedLanguages(SModel m, Set<String> result) {
    usedLanguagesInternal(m, result, SetSequence.fromSet(new HashSet<SModel>()));
  }

  private static void usedLanguagesInternal(final SModel model, final Set<String> result, final Set<SModel> traversedModels) {
    if (SetSequence.fromSet(traversedModels).contains(model)) {
      LogContext.with(UsedLanguageCollector.class, new Exception(), null, null).error("Cycle detected, Languages for " + model + " already added");
      return;
    }
    SetSequence.fromSet(traversedModels).addElement(model);
    SRepository repository = model.getRepository();
    LanguageRegistry languageRegistry = LanguageRegistry.getInstance(repository);
    SetSequence.fromSet(result).addSequence(SetSequence.fromSet(new ModelDependencyResolver(languageRegistry, repository).usedLanguages(model).stream().map((SLanguage it) -> it.getQualifiedName()).collect(Collectors.<String>toSet())));
    Sequence.fromIterable(((Iterable<SModelReference>) new ModelImports(model).getImportedModels())).visitAll((it) -> usedLanguagesInternal(it.resolve(model.getRepository()), result, traversedModels));
  }

}
