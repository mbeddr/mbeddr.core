package com.mbeddr.core.make.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.runtime.AbstractNonTypesystemRule_Runtime;
import jetbrains.mps.lang.typesystem.runtime.NonTypesystemRule_Runtime;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import jetbrains.mps.lang.typesystem.runtime.IsApplicableStatus;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.errors.messageTargets.MessageTarget;
import jetbrains.mps.errors.messageTargets.NodeMessageTarget;
import jetbrains.mps.errors.IErrorReporter;
import jetbrains.mps.errors.BaseQuickFixProvider;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.baseLanguage.closures.runtime.YieldingIterator;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import java.util.Objects;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import jetbrains.mps.lang.core.behavior.BaseConcept__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import com.mbeddr.core.make.behavior.Variable__BehaviorDescriptor;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SProperty;

public class check_PlainTextFragment_NonTypesystemRule extends AbstractNonTypesystemRule_Runtime implements NonTypesystemRule_Runtime {
  public check_PlainTextFragment_NonTypesystemRule() {
  }
  public void applyRule(final SNode plainTextFragment, final TypeCheckingContext typeCheckingContext, IsApplicableStatus status) {
    // Automatic command conversions
    if (SNodeOperations.isInstanceOf(SNodeOperations.getParent(plainTextFragment), CONCEPTS.Command$kp)) {
      if (SNodeOperations.getIndexInParent(plainTextFragment) == 0) {
        if (isEmptyString(SPropertyOperations.getString(plainTextFragment, PROPS.text$Iv7e))) {
          if (ListSequence.fromList(SLinkOperations.getChildren(SNodeOperations.cast(SNodeOperations.getParent(plainTextFragment), CONCEPTS.Command$kp), LINKS.items$dnbt)).count() > 1) {
            if (!(SNodeOperations.isInstanceOf(SNodeOperations.getParent(SNodeOperations.getParent(plainTextFragment)), CONCEPTS.Rule$it))) {
              {
                final MessageTarget errorTarget = new NodeMessageTarget();
                IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(plainTextFragment, "there must not be any commands with leading empty plain text fragments", "r:b8819a61-c3aa-4469-b5b3-43fb13a35cb6(com.mbeddr.core.make.typesystem)", "1800148851696144046", null, errorTarget);
                {
                  BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("com.mbeddr.core.make.typesystem.fix_convertPlainTextToEmptyLineBefore_QuickFix", "1800148851696191726", true);
                  intentionProvider.putArgument("plainTextFragment", plainTextFragment);
                  _reporter_2309309498.addIntentionProvider(intentionProvider);
                }
              }
            }
          }
        } else if (isNotEmptyString(trim_lupudd_a0a0a0a0b0b(SPropertyOperations.getString(plainTextFragment, PROPS.text$Iv7e)))) {
          // Detect plain text directives
          SAbstractConcept foundDirectiveConcept = Sequence.fromIterable(Sequence.fromClosure(() -> {
            return (Iterable<SConcept>) () -> {
              return new YieldingIterator<SConcept>() {
                private int __CP__ = 0;
                protected boolean moveToNext() {
__loop__:
                  do {
__switch__:
                    switch (this.__CP__) {
                      case -1:
                        assert false : "Internal error";
                        return false;
                      case 2:
                        this.__CP__ = 3;
                        this.yield(CONCEPTS.Comment$ne);
                        return true;
                      case 3:
                        this.__CP__ = 4;
                        this.yield(CONCEPTS.IfDefDirective$Oo);
                        return true;
                      case 4:
                        this.__CP__ = 5;
                        this.yield(CONCEPTS.IfNDefDirective$s4);
                        return true;
                      case 5:
                        this.__CP__ = 6;
                        this.yield(CONCEPTS.IfEqDirective$1p);
                        return true;
                      case 6:
                        this.__CP__ = 7;
                        this.yield(CONCEPTS.IfNEqDirective$$8);
                        return true;
                      case 7:
                        this.__CP__ = 8;
                        this.yield(CONCEPTS.Include$KU);
                        return true;
                      case 8:
                        this.__CP__ = 1;
                        this.yield(CONCEPTS.MultiLineVariable$km);
                        return true;
                      case 0:
                        this.__CP__ = 2;
                        break;
                      default:
                        break __loop__;
                    }
                  } while (true);
                  return false;
                }
              };
            };
          })).findFirst((it) -> SPropertyOperations.getString(plainTextFragment, PROPS.text$Iv7e).startsWith(SConceptOperations.conceptAlias(it)));
          if (foundDirectiveConcept != null) {
            if (Objects.equals(SPropertyOperations.getString(plainTextFragment, PROPS.text$Iv7e), SConceptOperations.conceptAlias(foundDirectiveConcept))) {
              {
                final MessageTarget errorTarget = new NodeMessageTarget();
                IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(plainTextFragment, SConceptOperations.conceptAlias(foundDirectiveConcept) + " directive must not be declared as plain text fragment", "r:b8819a61-c3aa-4469-b5b3-43fb13a35cb6(com.mbeddr.core.make.typesystem)", "141192364194740530", null, errorTarget);
                {
                  BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("com.mbeddr.core.make.typesystem.fix_convertPlainTextToDirective_QuickFix", "141192364195035195", true);
                  intentionProvider.putArgument("plainTextFragment", plainTextFragment);
                  intentionProvider.putArgument("directiveConcept", foundDirectiveConcept);
                  _reporter_2309309498.addIntentionProvider(intentionProvider);
                }
              }
            } else {
              {
                final MessageTarget errorTarget = new NodeMessageTarget();
                IErrorReporter _reporter_2309309498 = typeCheckingContext.reportWarning(plainTextFragment, SConceptOperations.conceptAlias(foundDirectiveConcept) + " directive should not be declared as plain text fragment", "r:b8819a61-c3aa-4469-b5b3-43fb13a35cb6(com.mbeddr.core.make.typesystem)", "141192364194993529", null, errorTarget);
              }
            }
          }

          Matcher subsequentDirectiveMatcher = Pattern.compile("^(else|endif|endef)").matcher(SPropertyOperations.getString(plainTextFragment, PROPS.text$Iv7e));
          if (subsequentDirectiveMatcher.find()) {
            {
              final MessageTarget errorTarget = new NodeMessageTarget();
              IErrorReporter _reporter_2309309498 = typeCheckingContext.reportWarning(plainTextFragment, subsequentDirectiveMatcher.group() + " directive should not be declared as plain text fragment", "r:b8819a61-c3aa-4469-b5b3-43fb13a35cb6(com.mbeddr.core.make.typesystem)", "141192364195013240", null, errorTarget);
            }
          }

          // Detect plain text rules
          Matcher ruleMatcher = Pattern.compile("^[\\w. ]+:").matcher(SPropertyOperations.getString(plainTextFragment, PROPS.text$Iv7e));
          if (ruleMatcher.find()) {
            {
              final MessageTarget errorTarget = new NodeMessageTarget();
              IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(plainTextFragment, ruleMatcher.group() + " rule must not be declared as plain text fragment", "r:b8819a61-c3aa-4469-b5b3-43fb13a35cb6(com.mbeddr.core.make.typesystem)", "8844796466766321333", null, errorTarget);
              {
                BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("com.mbeddr.core.make.typesystem.fix_convertPlainTextToRule_QuickFix", "8844796466766321340", true);
                intentionProvider.putArgument("plainTextFragment", plainTextFragment);
                _reporter_2309309498.addIntentionProvider(intentionProvider);
              }
            }
          }

          // Detect plain text variables
          if (SPropertyOperations.getString(plainTextFragment, PROPS.text$Iv7e).startsWith("export")) {
            {
              final MessageTarget errorTarget = new NodeMessageTarget();
              IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(plainTextFragment, "export modifier must not be entered as plain text fragment", "r:b8819a61-c3aa-4469-b5b3-43fb13a35cb6(com.mbeddr.core.make.typesystem)", "8844796466766321351", null, errorTarget);
              {
                BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("com.mbeddr.core.make.typesystem.fix_convertPlainTextToExportedVariable_QuickFix", "8844796466766321354", true);
                intentionProvider.putArgument("plainTextFragment", plainTextFragment);
                _reporter_2309309498.addIntentionProvider(intentionProvider);
              }
            }
          }
          if (SPropertyOperations.getString(plainTextFragment, PROPS.text$Iv7e).contains("=") && (SNodeOperations.getNodeAncestor(plainTextFragment, CONCEPTS.Rule$it, false, false) == null)) {
            {
              final MessageTarget errorTarget = new NodeMessageTarget();
              IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(plainTextFragment, "variables must not be declared as plain text fragment", "r:b8819a61-c3aa-4469-b5b3-43fb13a35cb6(com.mbeddr.core.make.typesystem)", "8844796466766321365", null, errorTarget);
              {
                BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("com.mbeddr.core.make.typesystem.fix_convertPlainTextToVariable_QuickFix", "8844796466766321368", true);
                intentionProvider.putArgument("plainTextFragment", plainTextFragment);
                _reporter_2309309498.addIntentionProvider(intentionProvider);
              }
            }
          }
        }
      }
    }

    // Manual Makefile item extractions
    if (isNotEmptyString(trim_lupudd_a0a4a1(SPropertyOperations.getString(plainTextFragment, PROPS.text$Iv7e)))) {
      // Detect plain text rule references
      if (SNodeOperations.isInstanceOf(SNodeOperations.getParent(plainTextFragment), CONCEPTS.Target$0) || SNodeOperations.isInstanceOf(SNodeOperations.getParent(plainTextFragment), CONCEPTS.Prerequisite$8Z) || SNodeOperations.isInstanceOf(SNodeOperations.getParent(plainTextFragment), CONCEPTS.Variable$yJ)) {
        SNode foundRule = ListSequence.fromList(SNodeOperations.getNodeDescendants(SNodeOperations.getNodeAncestor(plainTextFragment, CONCEPTS.Makefile$aQ, false, false), CONCEPTS.Rule$it, false, new SAbstractConcept[]{})).sort((it) -> SNodeOperations.getIndexInParent(it), true).findFirst((it) -> Objects.equals(BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(it), SPropertyOperations.getString(plainTextFragment, PROPS.text$Iv7e)));
        if ((foundRule != null) && !(Objects.equals(foundRule, SNodeOperations.getParent(SNodeOperations.getParent(plainTextFragment))))) {
          {
            final MessageTarget errorTarget = new NodeMessageTarget();
            IErrorReporter _reporter_2309309498 = typeCheckingContext.reportWarning(plainTextFragment, BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(foundRule) + " rule should not be referenced with plain text fragment", "r:b8819a61-c3aa-4469-b5b3-43fb13a35cb6(com.mbeddr.core.make.typesystem)", "379360623206204857", null, errorTarget);
            {
              BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("com.mbeddr.core.make.typesystem.fix_extractRuleRefFromPlainText_QuickFix", "379360623206204865", false);
              intentionProvider.putArgument("plainTextFragment", plainTextFragment);
              intentionProvider.putArgument("referencedRule", foundRule);
              _reporter_2309309498.addIntentionProvider(intentionProvider);
            }
          }
        }
      }

      // Detect plain text macros
      // !! Important note!! Be sure to do this before dealing with plain text variable references as macros are given priority over variables.
      SConcept foundMacroConcept = ListSequence.fromList(SConceptOperations.getAllSubConcepts2(CONCEPTS.Macro$t6, SNodeOperations.getModel(plainTextFragment))).removeWhere((it) -> isEmptyString(SConceptOperations.conceptAlias(it))).findFirst((it) -> SPropertyOperations.getString(plainTextFragment, PROPS.text$Iv7e).contains(SConceptOperations.conceptAlias(it)));
      if (foundMacroConcept != null) {
        {
          final MessageTarget errorTarget = new NodeMessageTarget();
          IErrorReporter _reporter_2309309498 = typeCheckingContext.reportWarning(plainTextFragment, SConceptOperations.conceptAlias(foundMacroConcept) + " macro should not by entered as plain text fragment", "r:b8819a61-c3aa-4469-b5b3-43fb13a35cb6(com.mbeddr.core.make.typesystem)", "379360623207644029", null, errorTarget);
          {
            BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("com.mbeddr.core.make.typesystem.fix_extractMacroFromPlainText_QuickFix", "379360623207644036", false);
            intentionProvider.putArgument("plainTextFragment", plainTextFragment);
            intentionProvider.putArgument("macroConcept", foundMacroConcept);
            _reporter_2309309498.addIntentionProvider(intentionProvider);
          }
        }
      }

      // Detect plain text variable references (except for plain text variables referenced by plain text fragments inside property or node macros )
      if (Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.getChildren(plainTextFragment, LINKS.smodelAttribute$KJ43), CONCEPTS.AbstractMacro$bo)).isEmpty()) {
        SNode foundVariable = ListSequence.fromList(SModelOperations.nodes(SNodeOperations.getModel(plainTextFragment), CONCEPTS.Variable$yJ)).sort((it) -> SNodeOperations.getIndexInParent(it), true).findFirst((it) -> SPropertyOperations.getString(plainTextFragment, PROPS.text$Iv7e).contains(Variable__BehaviorDescriptor.getReferencePresentation_id7EZ1Spo0Yz_.invoke(it, SNodeOperations.getParent(plainTextFragment))));
        if ((foundVariable != null)) {
          {
            final MessageTarget errorTarget = new NodeMessageTarget();
            IErrorReporter _reporter_2309309498 = typeCheckingContext.reportWarning(plainTextFragment, SPropertyOperations.getString(foundVariable, PROPS.name$MnvL) + " variable should not be referenced with plain text fragment", "r:b8819a61-c3aa-4469-b5b3-43fb13a35cb6(com.mbeddr.core.make.typesystem)", "379360623207625961", null, errorTarget);
            {
              BaseQuickFixProvider intentionProvider = new BaseQuickFixProvider("com.mbeddr.core.make.typesystem.fix_extractVariableRefFromPlainText_QuickFix", "379360623207625969", false);
              intentionProvider.putArgument("plainTextFragment", plainTextFragment);
              intentionProvider.putArgument("referencedVariable", foundVariable);
              _reporter_2309309498.addIntentionProvider(intentionProvider);
            }
          }
        }
      }
    }
  }
  public SAbstractConcept getApplicableConcept() {
    return CONCEPTS.PlainTextFragment$55;
  }
  public IsApplicableStatus isApplicableAndPattern(SNode argument) {
    return new IsApplicableStatus(argument.getConcept().isSubConceptOf(getApplicableConcept()), null);
  }
  public boolean overrides() {
    return false;
  }
  private static boolean isEmptyString(String str) {
    return str == null || str.isEmpty();
  }
  private static boolean isNotEmptyString(String str) {
    return str != null && str.length() > 0;
  }
  public static String trim_lupudd_a0a0a0a0b0b(String str) {
    return (str == null ? null : str.trim());
  }
  public static String trim_lupudd_a0a4a1(String str) {
    return (str == null ? null : str.trim());
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Rule$it = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x52941adca602a85dL, "com.mbeddr.core.make.structure.Rule");
    /*package*/ static final SConcept Command$kp = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x52941adca602a861L, "com.mbeddr.core.make.structure.Command");
    /*package*/ static final SConcept Comment$ne = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x6968eace2ba6f02fL, "com.mbeddr.core.make.structure.Comment");
    /*package*/ static final SConcept IfDefDirective$Oo = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x4d97d3d525fa68e8L, "com.mbeddr.core.make.structure.IfDefDirective");
    /*package*/ static final SConcept IfNDefDirective$s4 = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x38c9a1d8931738d9L, "com.mbeddr.core.make.structure.IfNDefDirective");
    /*package*/ static final SConcept IfEqDirective$1p = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x22c2a484f9ccbc32L, "com.mbeddr.core.make.structure.IfEqDirective");
    /*package*/ static final SConcept IfNEqDirective$$8 = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x38c9a1d893173f7eL, "com.mbeddr.core.make.structure.IfNEqDirective");
    /*package*/ static final SConcept Include$KU = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x42c45a1d153fb7fL, "com.mbeddr.core.make.structure.Include");
    /*package*/ static final SConcept MultiLineVariable$km = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x6968eace2bbc0b79L, "com.mbeddr.core.make.structure.MultiLineVariable");
    /*package*/ static final SConcept Makefile$aQ = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x52941adca602a0dfL, "com.mbeddr.core.make.structure.Makefile");
    /*package*/ static final SConcept Variable$yJ = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x2ed28d95c2c6a756L, "com.mbeddr.core.make.structure.Variable");
    /*package*/ static final SConcept Prerequisite$8Z = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x7abf078658cd4452L, "com.mbeddr.core.make.structure.Prerequisite");
    /*package*/ static final SConcept Target$0 = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x7abf078658cd2a9fL, "com.mbeddr.core.make.structure.Target");
    /*package*/ static final SConcept Macro$t6 = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x7a0aa91b7fcd715bL, "com.mbeddr.core.make.structure.Macro");
    /*package*/ static final SInterfaceConcept AbstractMacro$bo = MetaAdapterFactory.getInterfaceConcept(0xb401a68083254110L, 0x8fd384331ff25befL, 0x11dc0f7933bL, "jetbrains.mps.lang.generator.structure.AbstractMacro");
    /*package*/ static final SConcept PlainTextFragment$55 = MetaAdapterFactory.getConcept(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x2ed28d95c2ca1923L, "com.mbeddr.core.make.structure.PlainTextFragment");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink items$dnbt = MetaAdapterFactory.getContainmentLink(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x52941adca602a861L, 0x2ed28d95c2ca191fL, "items");
    /*package*/ static final SContainmentLink smodelAttribute$KJ43 = MetaAdapterFactory.getContainmentLink(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x10802efe25aL, 0x47bf8397520e5942L, "smodelAttribute");
  }

  private static final class PROPS {
    /*package*/ static final SProperty text$Iv7e = MetaAdapterFactory.getProperty(0xf93d1dbebfd142ddL, 0x932af375fa6f5373L, 0x2ed28d95c2ca1923L, 0x2ed28d95c2ca1924L, "text");
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
