package com.mbeddr.core.runconfiguration.pluginSolution.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.vfs.IFile;
import java.io.File;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.mbeddr.mpsutil.filepicker.behavior.IOutputLocationProvider__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.project.Project;
import jetbrains.mps.project.SModuleOperations;
import jetbrains.mps.vfs.VFSManager;
import com.mbeddr.core.buildconfig.behavior.Binary__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SProperty;

public class PlatformUtil {

  public static void deleteGeneratedFiles(SNode binary) {
    IFile outputPath = getOutputPath(binary);
    if (outputPath != null) {
      File folder = new File(outputPath.getPath());
      for (File file : folder.listFiles()) {
        deleteFiles(file);
      }
    }
  }

  public static void deleteFiles(File file) {
    if (file.isDirectory()) {
      for (File content : file.listFiles()) {
        deleteFiles(content);
      }
    }
    file.delete();
  }

  public static File getFolderFQ(SNode binary) {
    IFile output = getOutputPath(binary);
    return new File(output.getPath());
  }

  public static IFile getOutputPath(final SNode binary) {
    final Wrappers._T<IFile> outputLocation = new Wrappers._T<IFile>(null);
    SNodeOperations.getModel(binary).getRepository().getModelAccess().runReadAction(() -> {
      String outputLocationString = IOutputLocationProvider__BehaviorDescriptor.getOutputLocation_id7fn1GcKTDcC.invoke(SLinkOperations.getTarget(SNodeOperations.getNodeAncestor(binary, CONCEPTS.BuildConfiguration$kH, false, false), LINKS.platform$sQSW));
      Project project = SModuleOperations.getProjectForModule(SNodeOperations.getModel(binary).getModule());
      if (project != null) {
        outputLocation.value = project.getComponent(VFSManager.class).getFileSystem(VFSManager.FILE_FS).getFile(outputLocationString);
      }
    });
    return outputLocation.value;
  }

  public static String getPackage(final SNode binary) {
    final Wrappers._T<String> packageName = new Wrappers._T<String>(null);
    SNodeOperations.getModel(binary).getRepository().getModelAccess().runReadAction(() -> packageName.value = SNodeOperations.getModel(binary).getName().getLongName());
    return packageName.value;
  }

  public static File getExecutablePathFQ(final SNode binary) {
    final Wrappers._T<String> executableName = new Wrappers._T<String>();
    SNodeOperations.getModel(binary).getRepository().getModelAccess().runReadAction(() -> executableName.value = Binary__BehaviorDescriptor.executableFileName_idDp4TemBUyu.invoke(binary));
    IFile outputPath = getOutputPath(binary);
    if (outputPath != null) {
      return new File(outputPath.getPath(), executableName.value);
    }
    return new File(executableName.value);
  }

  public static boolean generatedMakeFileExists(SNode binary) {
    boolean makeFileExists = false;
    File makeFolder = getFolderFQ(binary);
    if (makeFolder.exists()) {
      File[] children = makeFolder.listFiles();
      if (children != null) {
        for (File child : children) {
          if ("Makefile".equals(child.getName()) || "makefile".equals(child.getName())) {
            makeFileExists = true;
            break;
          }
        }
      }
    }
    return makeFolder.exists() && makeFileExists;
  }

  public static boolean compiledBinaryExists(SNode binary) {
    boolean makeFileExists = false;
    File makeFolder = getFolderFQ(binary);
    if (makeFolder.exists()) {
      File[] children = makeFolder.listFiles();
      if (children != null) {
        for (File child : children) {
          if (child.getName().equals(SPropertyOperations.getString(binary, PROPS.name$MnvL)) || child.getName().equals(SPropertyOperations.getString(binary, PROPS.name$MnvL) + ".exe")) {
            makeFileExists = true;
            break;
          }
        }
      }
    }
    return makeFolder.exists() && makeFileExists;
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept BuildConfiguration$kH = MetaAdapterFactory.getConcept(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x6b1af9f9f43c2f48L, "com.mbeddr.core.buildconfig.structure.BuildConfiguration");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink platform$sQSW = MetaAdapterFactory.getContainmentLink(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x6b1af9f9f43c2f48L, 0x49e1b9dfef127632L, "platform");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
