package com.mbeddr.core.runconfiguration.pluginSolution.plugin;

/*Generated by MPS */

import com.intellij.execution.filters.Filter;
import com.intellij.openapi.project.Project;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import java.util.regex.Pattern;
import java.util.regex.Matcher;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.SNodePointer;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.textgen.trace.TraceablePositionInfo;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.textgen.trace.TraceInfoCache;
import jetbrains.mps.baseLanguage.logging.rt.LogContext;
import jetbrains.mps.lang.traceable.behavior.UnitConcept__BehaviorDescriptor;
import com.intellij.openapi.vfs.VirtualFile;
import jetbrains.mps.ide.common.FileOpenUtil;
import com.intellij.execution.filters.HyperlinkInfo;
import jetbrains.mps.openapi.navigation.EditorNavigator;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class MbeddrStackTraceFilter implements Filter {
  private static String MODEL_ID_START = "?";
  private final Project myProject;
  public MbeddrStackTraceFilter(Project project) {
    myProject = project;
  }
  @Nullable
  public Filter.Result applyFilter(String line, int length) {
    return tryToParseLine(line, length - line.length(), myProject);
  }
  public static Filter.Result tryToParseLine(String line, int offset) {
    return tryToParseLine(line, offset, null);
  }
  public static Filter.Result tryToParseLine(final String line, final int offset, final Project project) {
    final Wrappers._T<Filter.Result> result = new Wrappers._T<Filter.Result>(null);

    String modelIDRule = "r:([a-z0-9]+)(([-]{1}([a-z0-9]+))+)\\((.+)\\)";
    String nodeIDRule = "([0-9]+)";
    String rule = "\\?" + modelIDRule + "#" + nodeIDRule;
    Pattern pattern = Pattern.compile(rule);
    Matcher matcher = pattern.matcher(line);
    final MPSProject mpsProject = ProjectHelper.fromIdeaProject(project);
    if (mpsProject == null) {
      return result.value;
    }

    try {
      while (matcher.find()) {
        final String match = matcher.group();
        Matcher modelIDMatcher = Pattern.compile(modelIDRule).matcher(match);
        final String nodeID = Sequence.fromIterable(Sequence.fromArray(match.split("#"))).last();
        if (modelIDMatcher.find() && (nodeID != null && nodeID.length() > 0)) {
          final String modelID = modelIDMatcher.group();
          mpsProject.getRepository().getModelAccess().runReadAction(() -> {
            SNodePointer pointer = new SNodePointer(modelID, nodeID);
            SNode resolve = pointer.resolve(mpsProject.getRepository());
            SNodeReference pointerToTargetNode = SNodeOperations.getPointer(resolve);
            String highligtedText = match;
            int modelIdStartIndex = line.indexOf(match) + MODEL_ID_START.length();
            if (pointerToTargetNode != null) {
              result.value = openNavigable(pointerToTargetNode, highligtedText, modelIdStartIndex, offset);
            } else if (project != null) {
              // FIXME this code is suspicious. project is likely never null of we got here,
              // FIXME while pointerToTargetNode is null here, but is resolved down in openFile
              result.value = openFile(pointerToTargetNode, highligtedText, modelIdStartIndex, offset, project);
            }
          });

        }
      }
    } catch (Exception ex) {
      System.out.println("Failed to parse line: " + line);
    }
    return result.value;
  }

  private static Filter.Result openFile(SNodeReference nodeToHighlight, String targetNodeID, int idStartIndex, int offset, Project project) {
    Filter.Result result = null;
    TraceablePositionInfo nodeTrace = null;
    SNode resolvedNodeToHighlight = nodeToHighlight.resolve(ProjectHelper.getProjectRepository(project));
    if (resolvedNodeToHighlight != null) {
      SModel model = resolvedNodeToHighlight.getModel();
      if (model != null) {
        nodeTrace = new TraceInfoCache().get(model).getPositionForNode(resolvedNodeToHighlight);
      }
    }
    if (nodeTrace == null) {
      LogContext.with(MbeddrStackTraceFilter.class, null, null, null).error("No traces for Node with ID: " + targetNodeID);
    } else {
      final String unitName = UnitConcept__BehaviorDescriptor.getUnitName_id4pl5GY7LKmR.invoke(SNodeOperations.getNodeAncestor(((SNode) resolvedNodeToHighlight), CONCEPTS.UnitConcept$1g, false, false));
      final String fileName = nodeTrace.getFileName();
      final int lineNumber = nodeTrace.getStartLine();

      final VirtualFile virtualFile = FileOpenUtil.findFile(project, unitName, fileName);
      if (virtualFile == null) {
        return null;
      }
      result = new Filter.Result(idStartIndex + offset, idStartIndex + targetNodeID.length() + offset, new HyperlinkInfo() {
        public void navigate(Project project) {
          FileOpenUtil.openFile(project, virtualFile, lineNumber);
        }
      });
    }
    return result;
  }
  public static Filter.Result openNavigable(final SNodeReference nodeToHighlight, String textToHighlight, int idStartIndex, int offset) {
    Filter.Result result = new Filter.Result(idStartIndex + offset, idStartIndex + textToHighlight.length() + offset, new HyperlinkInfo() {
      public void navigate(Project project) {
        if (nodeToHighlight != null) {
          MPSProject mpsProject = ProjectHelper.fromIdeaProject(project);
          if (mpsProject != null) {
            new EditorNavigator(mpsProject).shallFocus(true).selectIfChild().open(nodeToHighlight);
          }
        }
      }
    });
    return result;
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept UnitConcept$1g = MetaAdapterFactory.getInterfaceConcept(0x9ded098bad6a4657L, 0xbfd948636cfe8bc3L, 0x465516cf87c705a4L, "jetbrains.mps.lang.traceable.structure.UnitConcept");
  }
}
