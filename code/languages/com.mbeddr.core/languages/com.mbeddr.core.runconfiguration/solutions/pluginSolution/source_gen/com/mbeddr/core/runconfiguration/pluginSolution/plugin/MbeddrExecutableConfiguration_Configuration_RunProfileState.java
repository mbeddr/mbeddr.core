package com.mbeddr.core.runconfiguration.pluginSolution.plugin;

/*Generated by MPS */

import com.intellij.execution.configurations.RunProfileState;
import org.jetbrains.annotations.NotNull;
import com.intellij.execution.runners.ExecutionEnvironment;
import com.intellij.execution.Executor;
import com.intellij.execution.configurations.ConfigurationPerRunnerSettings;
import com.intellij.execution.configurations.RunnerSettings;
import org.jetbrains.annotations.Nullable;
import com.intellij.execution.ExecutionResult;
import com.intellij.execution.runners.ProgramRunner;
import com.intellij.execution.ExecutionException;
import com.intellij.openapi.project.Project;
import com.intellij.execution.ui.ConsoleView;
import jetbrains.mps.execution.api.configurations.ConsoleCreator;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.intellij.execution.process.ProcessHandler;
import jetbrains.mps.execution.api.configurations.DefaultExecutionResult;
import jetbrains.mps.execution.api.configurations.DefaultExecutionConsole;
import com.intellij.execution.executors.DefaultRunExecutor;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class MbeddrExecutableConfiguration_Configuration_RunProfileState implements RunProfileState {
  @NotNull
  private final MbeddrExecutableConfiguration_Configuration myRunConfiguration;
  @NotNull
  private final ExecutionEnvironment myEnvironment;

  public MbeddrExecutableConfiguration_Configuration_RunProfileState(@NotNull MbeddrExecutableConfiguration_Configuration configuration, @NotNull Executor executor, @NotNull ExecutionEnvironment environment) {
    myRunConfiguration = configuration;
    myEnvironment = environment;
  }

  public ConfigurationPerRunnerSettings getConfigurationSettings() {
    return null;
  }

  public RunnerSettings getRunnerSettings() {
    return null;
  }

  @Nullable
  public ExecutionResult execute(Executor executor, @NotNull ProgramRunner runner) throws ExecutionException {
    Project project = myEnvironment.getProject();
    //  we run execute if we're not in debug mode!
    ConsoleView console = ConsoleCreator.createConsoleView(project, false);
    final Wrappers._T<SNode> node = new Wrappers._T<SNode>(null);
    final SRepository repo = ProjectHelper.getProjectRepository(project);

    repo.getModelAccess().runReadAction(() -> node.value = SNodeOperations.cast(myRunConfiguration.getBinary().getNodeRef().resolve(repo), CONCEPTS.Binary$5T));
    Make.invokeMake(node.value, project, true);

    MbeddrStackTraceFilter filter = new MbeddrStackTraceFilter(project);
    console.addMessageFilter(filter);

    ProcessHandler process = new CProgramExecutorCommand_Command().createProcess(node.value);
    {
      ProcessHandler _processHandler = process;
      final ConsoleView _consoleView = console;
      _consoleView.attachToProcess(_processHandler);
      return new DefaultExecutionResult(_processHandler, new DefaultExecutionConsole(_consoleView.getComponent(), () -> _consoleView.dispose()));
    }
  }


  public static boolean canExecute(String executorId) {
    if (DefaultRunExecutor.EXECUTOR_ID.equals(executorId)) {
      return true;
    }
    return false;
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Binary$5T = MetaAdapterFactory.getConcept(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x46097107c8d98c14L, "com.mbeddr.core.buildconfig.structure.Binary");
  }
}
