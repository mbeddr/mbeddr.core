package com.mbeddr.core.runconfiguration.pluginSolution.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.mbeddr.core.buildconfig.behavior.IDebuggerConfig;
import com.mbeddr.core.buildconfig.behavior.Platform__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import com.mbeddr.core.buildconfig.behavior.GdbConfig;
import com.mbeddr.core.make.behavior.IMakePathProvider__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class BuildConfigHelper {

  private static boolean isApplicablePlatform(final SNode binary) {
    final Wrappers._boolean result = new Wrappers._boolean(false);
    SNodeOperations.getModel(binary).getRepository().getModelAccess().runReadAction(() -> {
      SNode bc = SNodeOperations.getNodeAncestor(binary, CONCEPTS.BuildConfiguration$kH, false, false);
      IDebuggerConfig debuggerConfig = Platform__BehaviorDescriptor.getDebuggerConfig_id7c6uq_ObEPo.invoke(SLinkOperations.getTarget(bc, LINKS.platform$sQSW));
      result.value = debuggerConfig != null && debuggerConfig instanceof GdbConfig && (boolean) IMakePathProvider__BehaviorDescriptor.canMake_id3s1LyzG6KRG.invoke(SLinkOperations.getTarget(bc, LINKS.platform$sQSW));
    });
    return result.value;
  }

  public static String getPathToGdb(final SNode binary) {
    final Wrappers._T<String> path = new Wrappers._T<String>(null);
    SNodeOperations.getModel(binary).getRepository().getModelAccess().runReadAction(() -> {
      if (!(isApplicablePlatform(binary))) {
        throw new RuntimeException("Your Build Config does not provide a path to gdb");
      }
      SNode bc = SNodeOperations.getNodeAncestor(binary, CONCEPTS.BuildConfiguration$kH, false, false);
      IDebuggerConfig debuggerConfig = Platform__BehaviorDescriptor.getDebuggerConfig_id7c6uq_ObEPo.invoke(SLinkOperations.getTarget(bc, LINKS.platform$sQSW));
      if (debuggerConfig != null) {
        path.value = ((GdbConfig) debuggerConfig).getPathToGdb();
      }
    });
    return path.value;
  }

  public static String getPathToMake(final SNode binary) {
    final Wrappers._T<String> path = new Wrappers._T<String>(null);
    SNodeOperations.getModel(binary).getRepository().getModelAccess().runReadAction(() -> {
      if (!(isApplicablePlatform(binary))) {
        throw new RuntimeException("Your Build Config does not provide a path to gdb");
      }
      SNode bc = SNodeOperations.getNodeAncestor(binary, CONCEPTS.BuildConfiguration$kH, false, false);
      path.value = IMakePathProvider__BehaviorDescriptor.getPathToMake_id3s1LyzG7eMZ.invoke(SLinkOperations.getTarget(bc, LINKS.platform$sQSW));
    });
    return path.value;
  }

  public static boolean isApplicable(SNode binary) {
    SNode microchipPlatform = getDesktopPlatform(binary);
    return (microchipPlatform != null);
  }

  public static SNode getDesktopPlatform(SNode binary) {
    SNode bc = SNodeOperations.getNodeAncestor(binary, CONCEPTS.BuildConfiguration$kH, false, false);
    if ((bc != null) && (SLinkOperations.getTarget(bc, LINKS.platform$sQSW) != null)) {
      return extractDesktopPlatform(SLinkOperations.getTarget(bc, LINKS.platform$sQSW));
    }
    return null;
  }

  private static SNode extractDesktopPlatform(SNode target) {
    if (SNodeOperations.isInstanceOf(target, CONCEPTS.PlatformReference$gD)) {
      return extractDesktopPlatform(SLinkOperations.getTarget(SLinkOperations.getTarget((SNodeOperations.cast(target, CONCEPTS.PlatformReference$gD)), LINKS.template$Zbys), LINKS.template$CzrK));
    } else if (SNodeOperations.isInstanceOf(target, CONCEPTS.DesktopPlatform$p7)) {
      return SNodeOperations.cast(target, CONCEPTS.DesktopPlatform$p7);
    }
    return null;
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept BuildConfiguration$kH = MetaAdapterFactory.getConcept(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x6b1af9f9f43c2f48L, "com.mbeddr.core.buildconfig.structure.BuildConfiguration");
    /*package*/ static final SConcept PlatformReference$gD = MetaAdapterFactory.getConcept(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x7900826ed83da11eL, "com.mbeddr.core.buildconfig.structure.PlatformReference");
    /*package*/ static final SConcept DesktopPlatform$p7 = MetaAdapterFactory.getConcept(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x49e1b9dfef12762eL, "com.mbeddr.core.buildconfig.structure.DesktopPlatform");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink platform$sQSW = MetaAdapterFactory.getContainmentLink(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x6b1af9f9f43c2f48L, 0x49e1b9dfef127632L, "platform");
    /*package*/ static final SReferenceLink template$Zbys = MetaAdapterFactory.getReferenceLink(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x7900826ed83da11eL, 0x7900826ed83da196L, "template");
    /*package*/ static final SContainmentLink template$CzrK = MetaAdapterFactory.getContainmentLink(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x7900826ed82c35ffL, 0x7900826ed82c363fL, "template");
  }
}
