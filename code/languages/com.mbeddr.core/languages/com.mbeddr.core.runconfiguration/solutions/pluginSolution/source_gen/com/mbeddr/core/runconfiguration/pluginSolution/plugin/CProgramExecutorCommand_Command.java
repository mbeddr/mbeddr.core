package com.mbeddr.core.runconfiguration.pluginSolution.plugin;

/*Generated by MPS */

import com.intellij.execution.process.ProcessHandler;
import org.jetbrains.mps.openapi.model.SNode;
import com.intellij.execution.ExecutionException;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import java.io.File;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import java.util.Objects;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import org.apache.commons.lang3.SystemUtils;
import com.mbeddr.core.buildconfig.behavior.Binary__BehaviorDescriptor;
import jetbrains.mps.execution.api.commands.ProcessHandlerBuilder;
import com.intellij.execution.process.ProcessListener;
import com.intellij.execution.process.ProcessEvent;
import com.intellij.openapi.util.Key;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import jetbrains.mps.internal.collections.runtime.IMapping;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class CProgramExecutorCommand_Command {
  public CProgramExecutorCommand_Command() {
  }

  public ProcessHandler createProcess(final SNode binary) throws ExecutionException {
    final Wrappers._T<ProcessHandler> process = new Wrappers._T<ProcessHandler>(null);

    final File[] sourceFolder = new File[1];
    final File[] resultFolder = new File[1];
    SNodeOperations.getModel(binary).getRepository().getModelAccess().runReadAction(() -> {
      boolean hasTestsAnnotation = false;
      boolean isMbeddrUnitTest = false;
      hasTestsAnnotation = (SNodeOperations.getModel(binary)).getName().getLongName().endsWith("@tests");
      isMbeddrUnitTest = ListSequence.fromList(SLinkOperations.getChildren(ListSequence.fromList(SModelOperations.roots(SNodeOperations.getModel(binary), CONCEPTS.BuildConfiguration$kH)).first(), LINKS.configurationItems$HPvE)).any((it) -> Objects.equals(SConceptOperations.conceptAlias(SNodeOperations.getConcept(it)), "unit testing"));

      sourceFolder[0] = (hasTestsAnnotation ? TestResultUtil.getTestFolder(binary) : TestResultUtil.getSourceFolder(binary));
      resultFolder[0] = TestResultUtil.getResultFolder(binary);
      String execCmd = (isMbeddrUnitTest ? "make test" : ((SystemUtils.IS_OS_WINDOWS ? "cmd /C " + Binary__BehaviorDescriptor.executableFileName_idDp4TemBUyu.invoke(binary) : "./" + Binary__BehaviorDescriptor.executableFileName_idDp4TemBUyu.invoke(binary))));

      try {
        process.value = new ProcessHandlerBuilder().cmdline(execCmd).build(PlatformUtil.getFolderFQ(binary));
      } catch (Exception ex) {
        ErrorReporter.showErrorDialog("Could not invoke C program from command line");
      }
    });

    if (process.value != null) {
      process.value.addProcessListener(new ProcessListener() {
        @Override
        public void startNotified(ProcessEvent event) {

        }

        @Override
        public void processTerminated(ProcessEvent event) {
          long timestamp = System.currentTimeMillis();
          File sourceFile = TestResultUtil.getChild(sourceFolder[0], TestResultUtil.ASSERTS_XML);
          File targetFile = TestResultUtil.getChild(resultFolder[0], TestResultUtil.ASSERTS + TestResultUtil.TIMESTAMP_SEPARATOR + timestamp + TestResultUtil.TESTRESULT_EXTENSION);
          TestResultUtil.copy(sourceFile, targetFile);
          CProgramExecutorCommand_Command.demandClean(resultFolder[0]);
        }

        @Override
        public void processWillTerminate(ProcessEvent event, boolean p1) {

        }

        @Override
        public void onTextAvailable(ProcessEvent event, Key key) {

        }
      });
    }

    return process.value;
  }


  private static void demandClean(File folder) {
    Map<Long, File> files = TestResultUtil.getTestResultFiles(folder);
    if (MapSequence.fromMap(files).count() > TestResultUtil.KEEP_TRESHOLD) {
      for (IMapping<Long, File> file : MapSequence.fromMap(files).skip(TestResultUtil.KEEP_TRESHOLD)) {
        file.value().delete();
      }
    }
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept BuildConfiguration$kH = MetaAdapterFactory.getConcept(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x6b1af9f9f43c2f48L, "com.mbeddr.core.buildconfig.structure.BuildConfiguration");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink configurationItems$HPvE = MetaAdapterFactory.getContainmentLink(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x3de41a718bc20029L, 0x3de41a718bc2002aL, "configurationItems");
  }
}
