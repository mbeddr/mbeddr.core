package com.mbeddr.core.runconfiguration.pluginSolution.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import com.intellij.openapi.project.Project;
import java.util.concurrent.atomic.AtomicReference;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.intellij.openapi.progress.ProgressManager;
import com.intellij.openapi.progress.Task;
import org.jetbrains.annotations.NotNull;
import com.intellij.openapi.progress.ProgressIndicator;
import jetbrains.mps.progress.ProgressMonitorAdapter;
import java.util.List;
import java.util.concurrent.Callable;
import jetbrains.mps.internal.collections.runtime.ListSequence;

public class Make {

  public static boolean invokeMake(final SNode myBinary, final Project project, final boolean debug) {
    if ((myBinary == null)) {
      ErrorReporter.showErrorDialog("No Binary set in Runconfiguration");
    } else {
      final AtomicReference<String> pathToMake = new AtomicReference<String>("make");
      final AtomicReference<Boolean> result = new AtomicReference<Boolean>(Boolean.FALSE);

      SNodeOperations.getModel(myBinary).getRepository().getModelAccess().runReadAction(() -> pathToMake.set(BuildConfigHelper.getPathToMake(myBinary)));

      ProgressManager.getInstance().run(new Task.Modal(project, "Building binary", false) {
        public void run(@NotNull ProgressIndicator p0) {
          final ProgressMonitorAdapter progress = new ProgressMonitorAdapter(p0);
          progress.start("Compiling binary ...", 1);
          // first, we validate our tools are installed
          boolean allToolsInstalled = true;
          try {
            List<Callable<Boolean>> validationTasks = BuildBinaryUtil.getValidationTasks(myBinary);
            for (Callable<Boolean> task : ListSequence.fromList(validationTasks)) {
              boolean toolInstalled = task.call();
              if (!(toolInstalled)) {
                allToolsInstalled = false;
              }
            }
          } catch (Exception ex) {
            ErrorReporter.showErrorDialog(ex.getMessage());
          }

          if (!(allToolsInstalled)) {
            progress.done();
            result.set(false);
          } else {
            boolean makeResult = false;
            try {
              makeResult = MakeExecutor.makeBinary(pathToMake.get(), myBinary, debug).call();
              Thread.sleep(300);
            } catch (Exception ex) {
              ex.printStackTrace();
            }

            if (!(makeResult)) {
              ErrorReporter.showErrorDialog("Make failed - try running make from the command line to get more detailed information");
            }
            progress.advance(1);
            progress.done();
            result.set(makeResult);
          }
        }
      });
      return result.get();

    }
    return false;
  }
}
