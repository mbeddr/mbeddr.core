package com.mbeddr.core.runconfiguration.pluginSolution.plugin;

/*Generated by MPS */

import javax.swing.JPanel;
import javax.swing.JFormattedTextField;
import java.awt.GridBagLayout;
import javax.swing.text.DefaultFormatter;
import javax.swing.JLabel;
import jetbrains.mps.ide.common.LayoutUtil;
import java.awt.event.KeyAdapter;
import java.beans.PropertyChangeListener;
import java.awt.Color;
import com.intellij.openapi.editor.colors.EditorColorsManager;
import java.awt.event.KeyEvent;
import java.beans.PropertyChangeEvent;
import java.text.ParseException;
import org.jetbrains.annotations.Nullable;

public class MbeddrSettingsEditor extends JPanel {

  private final JFormattedTextField myCommandTimeoutTextField;
  private final JFormattedTextField myLaunchTimeoutTextField;
  private int launchTimeout;
  private int commandTimeout;

  public MbeddrSettingsEditor() {
    super(new GridBagLayout());

    DefaultFormatter formatter = new MyDefaultFormatter();
    formatter.setAllowsInvalid(true);
    formatter.setCommitsOnValidEdit(true);
    formatter.setOverwriteMode(false);

    myCommandTimeoutTextField = new JFormattedTextField(formatter);
    MyKeyAdapter commandTimeoutListener = new MyKeyAdapter(myCommandTimeoutTextField);
    myCommandTimeoutTextField.addPropertyChangeListener("value", commandTimeoutListener);
    myCommandTimeoutTextField.addKeyListener(commandTimeoutListener);

    myLaunchTimeoutTextField = new JFormattedTextField(formatter);
    MyKeyAdapter launchTimeoutListener = new MyKeyAdapter(myLaunchTimeoutTextField);
    myLaunchTimeoutTextField.addPropertyChangeListener("value", launchTimeoutListener);
    myLaunchTimeoutTextField.addKeyListener(launchTimeoutListener);

    add(new JLabel("Launch timeout:"), LayoutUtil.createLabelConstraints(0));
    add(myLaunchTimeoutTextField, LayoutUtil.createFieldConstraints(1));
    add(new JLabel("Command timeout:"), LayoutUtil.createLabelConstraints(2));
    add(myCommandTimeoutTextField, LayoutUtil.createFieldConstraints(3));
  }
  private void updateFieldsFromUi() {
    try {
      commandTimeout = Integer.parseInt(myCommandTimeoutTextField.getText());
      launchTimeout = Integer.parseInt(myLaunchTimeoutTextField.getText());
    } catch (Exception e) {
      e.printStackTrace();
    }
  }
  private void updateUiFromFields() {
    myLaunchTimeoutTextField.setValue(launchTimeout);
    myCommandTimeoutTextField.setValue(commandTimeout);
  }

  public void reset(MbeddrSettings settings) {
    launchTimeout = settings.launchTimeout;
    commandTimeout = settings.commandTimeout;
    updateUiFromFields();
  }
  public void apply(MbeddrSettings settings) {
    settings.commandTimeout = commandTimeout;
    settings.launchTimeout = launchTimeout;
  }


  private class MyKeyAdapter extends KeyAdapter implements PropertyChangeListener {
    /*package*/ JFormattedTextField textField;
    private final Color initialForegroundColor;

    private MyKeyAdapter(JFormattedTextField textField) {
      this.textField = textField;
      this.initialForegroundColor = EditorColorsManager.getInstance().getGlobalScheme().getDefaultForeground();
    }
    @Override
    public void keyReleased(KeyEvent e) {
      updateFieldsFromUi();
      textField.setForeground((textField.isEditValid() ? initialForegroundColor : Color.RED));
    }
    @Override
    public void propertyChange(PropertyChangeEvent evt) {
      updateFieldsFromUi();
    }
  }

  private class MyDefaultFormatter extends DefaultFormatter {
    private MyDefaultFormatter() {
    }
    @Override
    public Object stringToValue(String text) throws ParseException {
      try {
        return Integer.parseInt(text);
      } catch (NumberFormatException e) {
        throw new ParseException(text, 0);
      }
    }
    @Override
    public String valueToString(@Nullable Object value) throws ParseException {
      if (value == null) {
        return null;
      }
      return Integer.toString((Integer) value);
    }
  }
}
