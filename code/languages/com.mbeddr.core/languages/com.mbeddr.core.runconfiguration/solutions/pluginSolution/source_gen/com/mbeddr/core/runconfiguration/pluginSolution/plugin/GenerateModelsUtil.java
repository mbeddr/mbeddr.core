package com.mbeddr.core.runconfiguration.pluginSolution.plugin;

/*Generated by MPS */

import java.util.List;
import org.jetbrains.mps.openapi.model.SModel;
import com.intellij.openapi.project.Project;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.make.script.IResult;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.make.MakeSession;
import jetbrains.mps.ide.make.DefaultMakeMessageHandler;
import jetbrains.mps.make.IMakeService;
import jetbrains.mps.make.MakeServiceComponent;
import jetbrains.mps.smodel.resources.ModelsToResources;
import jetbrains.mps.make.resources.IResource;
import java.util.concurrent.Future;
import java.util.concurrent.CancellationException;
import java.util.concurrent.ExecutionException;

public class GenerateModelsUtil {
  public static boolean rebuildModels(List<SModel> modelsToRebuild, Project project) {
    return generate(modelsToRebuild, project, null);
  }

  public static boolean rebuildModels(List<SModel> modelsToRebuild, Project project, _FunctionTypes._return_P1_E0<? extends Boolean, ? super SModel> canGenerateFunction) {
    return generate(modelsToRebuild, project, canGenerateFunction);
  }

  private static boolean generate(List<SModel> modelDescriptors, Project project, _FunctionTypes._return_P1_E0<? extends Boolean, ? super SModel> canGenerateFunction) {
    IResult processResult = null;
    final jetbrains.mps.project.Project mpsProject = ProjectHelper.fromIdeaProject(project);
    if (mpsProject == null) {
      return false;
    }

    MakeSession session = new MakeSession(mpsProject, new DefaultMakeMessageHandler(mpsProject), true);
    IMakeService makeService = mpsProject.getComponent(MakeServiceComponent.class).get();
    if (makeService.openNewSession(session)) {
      ModelsToResources modelToresources = new ModelsToResources(modelDescriptors);
      if (canGenerateFunction != null) {
        modelToresources.canGenerateCondition(canGenerateFunction);
      }

      Iterable<IResource> resources = modelToresources.resources();
      Future<IResult> future = makeService.make(session, resources);
      try {
        processResult = future.get();
      } catch (CancellationException ignore) {
        ignore.printStackTrace();
      } catch (InterruptedException ignore) {
        ignore.printStackTrace();
      } catch (ExecutionException ignore) {
        ignore.printStackTrace();
      }
    }
    boolean result = processResult != null && processResult.isSucessful();
    return result;
  }
}
