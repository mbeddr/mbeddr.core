package com.mbeddr.core.checks.dataFlow;

/*Generated by MPS */

import jetbrains.mps.analyzers.runtime.framework.CustomAnalyzerRunner;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.dataFlow.MPSProgramFactory;
import java.util.Collections;
import jetbrains.mps.lang.dataFlow.framework.IDataFlowModeId;
import jetbrains.mps.lang.dataFlow.framework.ProgramFactory;
import jetbrains.mps.lang.dataFlow.framework.NamedAnalyzerId;
import jetbrains.mps.lang.dataFlow.framework.DataFlowAnalyzerBase;
import jetbrains.mps.lang.dataFlow.framework.Program;
import java.util.List;
import jetbrains.mps.lang.dataFlow.framework.ProgramState;
import org.jetbrains.annotations.Nullable;
import java.util.Map;
import jetbrains.mps.lang.dataFlow.framework.instructions.Instruction;
import jetbrains.mps.lang.dataFlow.framework.instructions.WriteInstruction;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.mbeddr.core.expressions.behavior.Expression__BehaviorDescriptor;
import com.mbeddr.core.expressions.behavior.IVariableReference__BehaviorDescriptor;
import jetbrains.mps.lang.dataFlow.framework.AnalysisDirection;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;

public class ConstantPropagationAnalyzerAnalyzerRunner extends CustomAnalyzerRunner<VariableValuesMapping> {
  private SNode myNode;
  public ConstantPropagationAnalyzerAnalyzerRunner(SNode node) {
    this(node, new MPSProgramFactory(Collections.<IDataFlowModeId>emptyList()));
  }
  public ConstantPropagationAnalyzerAnalyzerRunner(SNode node, ProgramFactory<NamedAnalyzerId> factory) {
    super(null, null);
    myNode = node;
    myAnalyzer = new ConstantPropagationAnalyzerAnalyzer();
    myProgram = factory.createProgram(myNode);
    factory.prepareProgram(myProgram, myNode, new NamedAnalyzerId("com.mbeddr.core.checks.dataFlow.ConstantPropagationAnalyzer"));
  }

  public static class ConstantPropagationAnalyzerAnalyzer extends DataFlowAnalyzerBase<VariableValuesMapping> {
    public ConstantPropagationAnalyzerAnalyzer() {
    }
    public VariableValuesMapping initial(Program program) {
      return new VariableValuesMapping();
    }
    public VariableValuesMapping merge(Program program, List<VariableValuesMapping> input) {
      VariableValuesMapping result = new VariableValuesMapping();
      for (VariableValuesMapping vvm : input) {
        result.merge(vvm);
      }
      return result;
    }
    public VariableValuesMapping fun(VariableValuesMapping input, ProgramState state, @Nullable Map<ProgramState, VariableValuesMapping> stateValues) {
      Instruction instruction = state.getInstruction();
      VariableValuesMapping res = input.clone();

      if (instruction.isStart()) {
        res = new VariableValuesMapping();
      } else {
        if (instruction instanceof WriteInstruction && ((WriteInstruction) instruction).getVariable() != null) {
          WriteInstruction wi = ((WriteInstruction) instruction);
          SNode var = (SNode) wi.getVariable();
          SNode val = (SNode) wi.getValue();
          if (SNodeOperations.isInstanceOf(val, CONCEPTS.Expression$bT) && !(SNodeOperations.isInstanceOf(val, CONCEPTS.IVariableReference$WR))) {
            if ((boolean) Expression__BehaviorDescriptor.isStaticallyEvaluatable_id3ilck8Kr3zN.invoke(SNodeOperations.cast(val, CONCEPTS.Expression$bT))) {
              res.overwrite(var, Expression__BehaviorDescriptor.evaluateStatically_id6OxpEKG0KPv.invoke(SNodeOperations.cast(val, CONCEPTS.Expression$bT)));
            } else {
              res.overwrite(var, null);
            }
          } else if (SNodeOperations.isInstanceOf(val, CONCEPTS.IVariableReference$WR)) {
            SNode vRef = SNodeOperations.cast(val, CONCEPTS.IVariableReference$WR);
            res.overwrite(var, res.getPossibleValues(IVariableReference__BehaviorDescriptor.getVariable_id1LDGRqyQFAf.invoke(vRef)));
          } else if (SNodeOperations.isInstanceOf(val, CONCEPTS.FunctionCall$4q)) {
            // TODO
          }

        }
      }

      return res;
    }
    public AnalysisDirection getDirection() {
      return AnalysisDirection.FORWARD;
    }
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Expression$bT = MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x7af69e2e83a1ba32L, "com.mbeddr.core.expressions.structure.Expression");
    /*package*/ static final SInterfaceConcept IVariableReference$WR = MetaAdapterFactory.getInterfaceConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x1c69b376a2dab98aL, "com.mbeddr.core.expressions.structure.IVariableReference");
    /*package*/ static final SConcept FunctionCall$4q = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x52941adca601b38cL, "com.mbeddr.core.modules.structure.FunctionCall");
  }
}
