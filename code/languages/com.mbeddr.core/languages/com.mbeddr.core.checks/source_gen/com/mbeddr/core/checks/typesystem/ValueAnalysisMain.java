package com.mbeddr.core.checks.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.dependencies.CheckingMethod;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.analyzers.runtime.framework.CustomAnalyzerRunner;
import com.mbeddr.core.checks.dataFlow.VariableValuesMapping;
import com.mbeddr.core.checks.dataFlow.ConstantPropagationAnalyzerAnalyzerRunner;
import jetbrains.mps.lang.dataFlow.framework.AnalysisResult;
import jetbrains.mps.lang.dataFlow.framework.Program;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import java.util.List;
import com.mbeddr.core.expressions.typesystem.MeetTypeHelper;
import jetbrains.mps.typechecking.TypecheckingFacade;
import com.mbeddr.core.expressions.behavior.Type__BehaviorDescriptor;
import java.math.BigInteger;
import jetbrains.mps.errors.messageTargets.MessageTarget;
import jetbrains.mps.errors.messageTargets.NodeMessageTarget;
import jetbrains.mps.errors.IErrorReporter;
import java.util.ArrayList;
import com.mbeddr.core.expressions.behavior.Expression__BehaviorDescriptor;
import jetbrains.mps.lang.dataFlow.framework.instructions.Instruction;
import com.mbeddr.core.checks.dataFlow.DataflowUtils;
import com.mbeddr.core.expressions.behavior.IVariableReference__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class ValueAnalysisMain {

  @CheckingMethod
  public static void doCheck(final TypeCheckingContext typeCheckingContext, SNode statements) {
    CustomAnalyzerRunner<VariableValuesMapping> constantAnalyzer;
    constantAnalyzer = new ConstantPropagationAnalyzerAnalyzerRunner(statements);
    AnalysisResult<VariableValuesMapping> res = constantAnalyzer.analyze();
    Program prog = constantAnalyzer.getProgram();
    for (SNode bbae : ListSequence.fromList(SNodeOperations.getNodeDescendants(statements, CONCEPTS.BitwiseBinaryArithmaticsExpression$ws, false, new SAbstractConcept[]{}))) {
      checkBitwiseOperator(typeCheckingContext, bbae, prog, res);
    }
  }


  @CheckingMethod
  private static void checkBitwiseOperator(final TypeCheckingContext typeCheckingContext, SNode bitwiseExp, Program prog, AnalysisResult<VariableValuesMapping> analysisResult) {
    SNode rhs = SLinkOperations.getTarget(bitwiseExp, LINKS.right$Slc$);
    SNode lhs = SLinkOperations.getTarget(bitwiseExp, LINKS.left$SkXz);
    {
      final SNode bie = bitwiseExp;
      if (SNodeOperations.isInstanceOf(bie, CONCEPTS.BitwiseLeftShiftExpression$Kh)) {
        doCheckBitwiseOperator(typeCheckingContext, lhs, rhs, prog, analysisResult);
      }
    }
    {
      final SNode bie = bitwiseExp;
      if (SNodeOperations.isInstanceOf(bie, CONCEPTS.BitwiseRightShiftExpression$hf)) {
        doCheckBitwiseOperator(typeCheckingContext, lhs, rhs, prog, analysisResult);
      }
    }
  }

  @CheckingMethod
  private static void doCheckBitwiseOperator(final TypeCheckingContext typeCheckingContext, SNode shiftedValue, SNode positionsCount, Program prog, AnalysisResult<VariableValuesMapping> analysisResult) {
    List<Object> possibleValues = computePossibleValues(positionsCount, prog, analysisResult);
    SNode tpe = MeetTypeHelper.getConcreteType(SNodeOperations.cast(TypecheckingFacade.getFromContext().getTypeOf(shiftedValue), CONCEPTS.IType$a9));
    if (!(SNodeOperations.isInstanceOf(tpe, CONCEPTS.PrimitiveC99IntegralType$E_))) {
      return;
    }
    int typeSizeInBits = (int) Type__BehaviorDescriptor.getUsedBytes_id61lw97FtLtJ.invoke(SNodeOperations.cast(tpe, CONCEPTS.PrimitiveC99IntegralType$E_)) * 8;
    for (Object pv : possibleValues) {
      int val = ((BigInteger) pv).intValue();
      if (val >= typeSizeInBits || val <= 0) {
        {
          final MessageTarget errorTarget = new NodeMessageTarget();
          IErrorReporter _reporter_2309309498 = typeCheckingContext.reportWarning(SNodeOperations.getParent(positionsCount), "(MISRA-C:2004 12.8): right-hand operand of a shift operator shall lie between " + "zero and one less than the width in bits of the underlying type of the left-hand operand", "r:0bfce9a3-10ca-444a-937a-739ad39cd78b(com.mbeddr.core.checks.typesystem)", "3451033204592343684", null, errorTarget);
        }
      }
    }
  }

  /*package*/ static List<Object> computePossibleValues(SNode n, Program prog, AnalysisResult<VariableValuesMapping> analysisResult) {
    List<Object> res = ListSequence.fromList(new ArrayList<Object>());

    {
      final SNode nl = n;
      if (SNodeOperations.isInstanceOf(nl, CONCEPTS.NumberLiteral$jK)) {
        ListSequence.fromList(res).addElement(Expression__BehaviorDescriptor.evaluateStatically_id6OxpEKG0KPv.invoke(nl));
      }
    }
    {
      final SNode ume = n;
      if (SNodeOperations.isInstanceOf(ume, CONCEPTS.UnaryMinusExpression$pM)) {
        if ((boolean) Expression__BehaviorDescriptor.isStaticallyEvaluatable_id3ilck8Kr3zN.invoke(ume)) {
          ListSequence.fromList(res).addElement(Expression__BehaviorDescriptor.evaluateStatically_id6OxpEKG0KPv.invoke(ume));
        }
      }
    }
    {
      final SNode vr = n;
      if (SNodeOperations.isInstanceOf(vr, CONCEPTS.IVariableReference$WR)) {
        Instruction instruction = DataflowUtils.findReadInstruction(prog, vr);
        VariableValuesMapping vvm = analysisResult.get(instruction);
        ListSequence.fromList(res).addSequence(ListSequence.fromList(vvm.getPossibleValues(IVariableReference__BehaviorDescriptor.getVariable_id1LDGRqyQFAf.invoke(vr))));
      }
    }
    return res;
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept BitwiseBinaryArithmaticsExpression$ws = MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x152bc626296cd95cL, "com.mbeddr.core.expressions.structure.BitwiseBinaryArithmaticsExpression");
    /*package*/ static final SConcept BitwiseLeftShiftExpression$Kh = MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x7d15ed3ba56cbdbfL, "com.mbeddr.core.expressions.structure.BitwiseLeftShiftExpression");
    /*package*/ static final SConcept BitwiseRightShiftExpression$hf = MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x7d15ed3ba569dd50L, "com.mbeddr.core.expressions.structure.BitwiseRightShiftExpression");
    /*package*/ static final SInterfaceConcept IType$a9 = MetaAdapterFactory.getInterfaceConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x11f8a0774f2L, "jetbrains.mps.lang.core.structure.IType");
    /*package*/ static final SConcept PrimitiveC99IntegralType$E_ = MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x75739ed9f39c4635L, "com.mbeddr.core.expressions.structure.PrimitiveC99IntegralType");
    /*package*/ static final SConcept NumberLiteral$jK = MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x7af69e2e83a1ba67L, "com.mbeddr.core.expressions.structure.NumberLiteral");
    /*package*/ static final SConcept UnaryMinusExpression$pM = MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x373071ae5c652ee2L, "com.mbeddr.core.expressions.structure.UnaryMinusExpression");
    /*package*/ static final SInterfaceConcept IVariableReference$WR = MetaAdapterFactory.getInterfaceConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x1c69b376a2dab98aL, "com.mbeddr.core.expressions.structure.IVariableReference");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink right$Slc$ = MetaAdapterFactory.getContainmentLink(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x7af69e2e83a1ba34L, 0x7af69e2e83a1ba41L, "right");
    /*package*/ static final SContainmentLink left$SkXz = MetaAdapterFactory.getContainmentLink(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x7af69e2e83a1ba34L, 0x7af69e2e83a1ba40L, "left");
  }
}
