package com.mbeddr.core.qa.behavior;

/*Generated by MPS */

import jetbrains.mps.smodel.Language;
import jetbrains.mps.smodel.ModuleRepositoryFacade;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.project.Project;
import jetbrains.mps.project.ProjectManager;
import org.jetbrains.mps.openapi.module.SModule;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;

/**
 * Utility methods.
 */
public class Utils {

  /**
   * Returns a sequence with all languages available in the repository.
   */
  public static Iterable<Language> collectAllAvailableLanguages() {
    return ModuleRepositoryFacade.getInstance().getAllModules(Language.class);
  }

  /**
   * Returns a sequence with all languages that start with a certain prefix.
   */
  public static Iterable<Language> collectAllLanguagesStartingWithPrefix(Iterable<SNode> prefixes) {
    Set<Language> res = SetSequence.fromSet(new HashSet<Language>());
    Iterable<Language> langs = ModuleRepositoryFacade.getInstance().getAllModules(Language.class);
    Iterable<String> lanNamesPrefixes = Sequence.fromIterable(prefixes).select((it) -> SPropertyOperations.getString(it, PROPS.prefix$Q8K7));
    for (Language lan : Sequence.fromIterable(langs)) {
      final String crtLanName = lan.getModuleName();
      String pref = Sequence.fromIterable(lanNamesPrefixes).findFirst((lanPref) -> {
        boolean found;
        if (lanPref.endsWith("*")) {
          found = crtLanName.startsWith(lanPref.substring(0, lanPref.length() - 2));
        } else {
          found = crtLanName.equals(lanPref);
        }
        return found;
      });
      if ((pref != null && pref.length() > 0)) {
        SetSequence.fromSet(res).addElement(lan);
      }
    }
    return res;
  }

  /**
   * Returns all concept declared within the set of languages.
   */
  public static List<SNode> collectConceptDeclarations(Iterable<Language> allLangs) {
    List<SNode> allConcepts = new ArrayList<SNode>();
    for (Language lan : Sequence.fromIterable(allLangs)) {
      List<SNode> conceptDeclarations = lan.getConceptDeclarations();
      for (SNode n : conceptDeclarations) {
        {
          final SNode cd = n;
          if (SNodeOperations.isInstanceOf(cd, CONCEPTS.ConceptDeclaration$gH)) {
            if (!(SPropertyOperations.getBoolean(cd, PROPS.abstract$ibpT))) {
              ListSequence.fromList(allConcepts).addElement(cd);
            }
          }
        }
      }
    }
    return allConcepts;
  }

  /**
   * Returns all rules (typesystem, non-type-system, etc) declared within the set of languages.
   */
  public static List<SNode> collectAllRules(Iterable<Language> allLangs) {
    List<SNode> allRules = new ArrayList<SNode>();
    for (Language lan : Sequence.fromIterable(allLangs)) {
      for (SModel m : ListSequence.fromList(lan.getModels())) {
        for (SNode r : Sequence.fromIterable(m.getRootNodes())) {
          {
            final SNode ar = r;
            if (SNodeOperations.isInstanceOf(ar, CONCEPTS.AbstractRule$o9)) {
              ListSequence.fromList(allRules).addElement(ar);
            }
          }
        }
      }
    }
    return allRules;
  }

  /**
   * Returns the first project that is opened and that contains the module.
   */
  public static Project findFirstOpenProjectContainingModule(SModel aModelFromProject) {
    Iterable<Project> openedProjects = ProjectManager.getInstance().getOpenedProjects();
    final SModule module = aModelFromProject.getModule();
    Iterable<Project> seq = Sequence.fromIterable(openedProjects).where((it) -> it.isProjectModule(module));
    assert Sequence.fromIterable(seq).count() == 1 : "Cannot find opened project for module: " + module;
    return Sequence.fromIterable(seq).first();
  }

  private static final class PROPS {
    /*package*/ static final SProperty prefix$Q8K7 = MetaAdapterFactory.getProperty(0xc8e0d19c3cf4b31L, 0xaf77531227edbce8L, 0x4d26542081b9ea7L, 0x4d26542081b9ea8L, "prefix");
    /*package*/ static final SProperty abstract$ibpT = MetaAdapterFactory.getProperty(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0x1103553c5ffL, 0x403a32c5772c7ec2L, "abstract");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept ConceptDeclaration$gH = MetaAdapterFactory.getConcept(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0xf979ba0450L, "jetbrains.mps.lang.structure.structure.ConceptDeclaration");
    /*package*/ static final SConcept AbstractRule$o9 = MetaAdapterFactory.getConcept(0x7a5dda6291404668L, 0xab76d5ed1746f2b2L, 0x1117e7b5c73L, "jetbrains.mps.lang.typesystem.structure.AbstractRule");
  }
}
