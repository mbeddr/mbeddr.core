package com.mbeddr.core.statements.refactorings;

/*Generated by MPS */

import jetbrains.mps.refactoring.framework.BaseRefactoring;
import jetbrains.mps.refactoring.framework.IRefactoringTarget;
import jetbrains.mps.refactoring.framework.RefactoringContext;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import com.mbeddr.core.expressions.behavior.Expression__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class inlineLocalVariable extends BaseRefactoring {
  public inlineLocalVariable() {
    this.addTransientParameter("varName");
  }
  public IRefactoringTarget getRefactoringTarget() {
    return new inlineLocalVariable_Target();
  }
  public String getUserFriendlyName() {
    return "Inline Local Variable";
  }
  public void refactor(final RefactoringContext refactoringContext) {
    final SNode lvd = refactoringContext.getSelectedNode();
    SNode owningSL = SNodeOperations.getNodeAncestor(lvd, CONCEPTS.StatementList$y1, false, false);
    Iterable<SNode> refs = ListSequence.fromList(SNodeOperations.getNodeDescendants(owningSL, CONCEPTS.LocalVarRef$VQ, false, new SAbstractConcept[]{})).where((it) -> SLinkOperations.getTarget(it, LINKS.var$YUyC) == lvd);

    for (SNode ref : Sequence.fromIterable(refs)) {
      SNode copyOfInit = SNodeOperations.copyNode(SLinkOperations.getTarget(lvd, LINKS.init$$i$n));
      SNode targetCtx = SNodeOperations.getParent(ref);
      if (SNodeOperations.isInstanceOf(targetCtx, CONCEPTS.UnaryExpression$lH)) {
        SNode parens = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x4ffba68fe82dd4c7L, "com.mbeddr.core.expressions.structure.ParensExpression"));
        SLinkOperations.setTarget(parens, LINKS.expression$PfNq, copyOfInit);
        SNodeOperations.replaceWithAnother(ref, parens);
      } else if (SNodeOperations.isInstanceOf(targetCtx, CONCEPTS.BinaryExpression$cR) && SNodeOperations.isInstanceOf(copyOfInit, CONCEPTS.BinaryExpression$cR) && ((int) Expression__BehaviorDescriptor.getPriolevel_id5HxjapwgqKu.invoke(SNodeOperations.asSConcept(SNodeOperations.getConcept(SNodeOperations.cast(targetCtx, CONCEPTS.BinaryExpression$cR)))) > (int) Expression__BehaviorDescriptor.getPriolevel_id5HxjapwgqKu.invoke(SNodeOperations.asSConcept(SNodeOperations.getConcept(SNodeOperations.cast(copyOfInit, CONCEPTS.BinaryExpression$cR)))))) {
        SNode parens = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x4ffba68fe82dd4c7L, "com.mbeddr.core.expressions.structure.ParensExpression"));
        SLinkOperations.setTarget(parens, LINKS.expression$PfNq, copyOfInit);
        SNodeOperations.replaceWithAnother(ref, parens);
      } else {
        SNodeOperations.replaceWithAnother(ref, copyOfInit);
      }
    }
    SNodeOperations.deleteNode(lvd);
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept StatementList$y1 = MetaAdapterFactory.getConcept(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x3a16e3a9c7ad9955L, "com.mbeddr.core.statements.structure.StatementList");
    /*package*/ static final SConcept LocalVarRef$VQ = MetaAdapterFactory.getConcept(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x1d0c3765e2e1d67aL, "com.mbeddr.core.statements.structure.LocalVarRef");
    /*package*/ static final SConcept UnaryExpression$lH = MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x29b5b7c4a3763232L, "com.mbeddr.core.expressions.structure.UnaryExpression");
    /*package*/ static final SConcept BinaryExpression$cR = MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x7af69e2e83a1ba34L, "com.mbeddr.core.expressions.structure.BinaryExpression");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink var$YUyC = MetaAdapterFactory.getReferenceLink(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x1d0c3765e2e1d67aL, 0x1d0c3765e2e1fe27L, "var");
    /*package*/ static final SContainmentLink init$$i$n = MetaAdapterFactory.getContainmentLink(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x3a16e3a9c7ad96e6L, 0x3a16e3a9c7ae01f7L, "init");
    /*package*/ static final SContainmentLink expression$PfNq = MetaAdapterFactory.getContainmentLink(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x29b5b7c4a3763232L, 0x64ae61a4018a9c50L, "expression");
  }
}
