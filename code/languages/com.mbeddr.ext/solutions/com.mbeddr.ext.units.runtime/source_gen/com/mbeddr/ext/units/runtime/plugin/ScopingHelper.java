package com.mbeddr.ext.units.runtime.plugin;

/*Generated by MPS */

import java.util.Set;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import com.mbeddr.core.base.behavior.IVisibleElementProvider__BehaviorDescriptor;
import com.mbeddr.ext.units.behavior.IUnitDeclarationsProvider__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import com.mbeddr.core.base.behavior.GenericUnitProvider__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class ScopingHelper {

  public static Set<SNode> getVisibleUnitsFrom(SNode node) {
    Set<SNode> units = SetSequence.fromSet(new HashSet<SNode>());

    // reference to the nounit specified in the SIUnits accessory model
    SNode nounit = ListSequence.fromList(SModelOperations.nodes(PersistenceFacade.getInstance().createModelReference("r:679066bc-2da8-4932-a09c-5d2b3d47b911(com.mbeddr.ext.units.siunits)").resolve(SNodeOperations.getModel(node).getRepository()), CONCEPTS.Unit$Yt)).findFirst((it) -> SPropertyOperations.getString(it, PROPS.name$MnvL).equals("nounit"));

    boolean canUseNoUnit = (SNodeOperations.getNodeAncestor(node, CONCEPTS.ICanUseNoUnit$Rv, true, false) != null);

    for (SNode unit : Sequence.fromIterable(SNodeOperations.ofConcept(IVisibleElementProvider__BehaviorDescriptor.visibleContentsOfType_id6clJcrJXo2_.invoke(SNodeOperations.getNodeAncestor(node, CONCEPTS.IVisibleElementProvider$$O, true, false), CONCEPTS.Unit$Yt.getDeclarationNode()), CONCEPTS.Unit$Yt))) {
      if (canUseNoUnit || unit != nounit) {
        SetSequence.fromSet(units).addElement(unit);
      }
    }

    // add generic meta units
    SetSequence.fromSet(units).addSequence(SetSequence.fromSet(collectGenericUnits(node)));

    // try unit declarations provider parent
    SNode provider = SNodeOperations.getNodeAncestor(node, CONCEPTS.IUnitDeclarationsProvider$gN, true, false);
    if (provider != null && IUnitDeclarationsProvider__BehaviorDescriptor.getDeclaredUnits_id3VpMwkcjX51.invoke(provider) != null) {
      SetSequence.fromSet(units).addSequence(Sequence.fromIterable(IUnitDeclarationsProvider__BehaviorDescriptor.getDeclaredUnits_id3VpMwkcjX51.invoke(provider)));
    }

    return units;
  }

  private static Set<SNode> collectGenericUnits(SNode current) {
    Set<SNode> result = SetSequence.fromSet(new HashSet<SNode>());
    collectGenericUnits(current, result);
    return result;
  }

  private static void collectGenericUnits(SNode current, Set<SNode> accumulator) {
    if (SNodeOperations.isInstanceOf(current, CONCEPTS.GenericUnitProvider$kI)) {
      SetSequence.fromSet(accumulator).addSequence(ListSequence.fromList(SLinkOperations.getChildren(new IAttributeDescriptor.NodeAttribute(CONCEPTS.GenericUnitDeclarationAttribute$BT).get(SNodeOperations.cast(current, CONCEPTS.GenericUnitProvider$kI)), LINKS.units$UfaK)));
    }

    Iterable<SNode> providers = SNodeOperations.ofConcept(SNodeOperations.getNodeAncestors(current, null, false), CONCEPTS.GenericUnitProvider$kI);
    for (SNode provider : Sequence.fromIterable(providers)) {
      if (provider != null && new IAttributeDescriptor.NodeAttribute(CONCEPTS.GenericUnitDeclarationAttribute$BT).get(provider) != null) {
        SetSequence.fromSet(accumulator).addSequence(ListSequence.fromList(SLinkOperations.getChildren(new IAttributeDescriptor.NodeAttribute(CONCEPTS.GenericUnitDeclarationAttribute$BT).get(provider), LINKS.units$UfaK)));
      }
      if (GenericUnitProvider__BehaviorDescriptor.getProxy_id7okx9D2T19V.invoke(provider) != null && SNodeOperations.isInstanceOf(GenericUnitProvider__BehaviorDescriptor.getProxy_id7okx9D2T19V.invoke(provider), CONCEPTS.GenericUnitProvider$kI)) {
        collectGenericUnits(GenericUnitProvider__BehaviorDescriptor.getProxy_id7okx9D2T19V.invoke(provider), accumulator);
      }
    }
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Unit$Yt = MetaAdapterFactory.getConcept(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x73b48a125b0d373fL, "com.mbeddr.ext.units.structure.Unit");
    /*package*/ static final SInterfaceConcept ICanUseNoUnit$Rv = MetaAdapterFactory.getInterfaceConcept(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x65a3fdcab13f1e17L, "com.mbeddr.ext.units.structure.ICanUseNoUnit");
    /*package*/ static final SInterfaceConcept IVisibleElementProvider$$O = MetaAdapterFactory.getInterfaceConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x6315bcc6eff580a3L, "com.mbeddr.core.base.structure.IVisibleElementProvider");
    /*package*/ static final SInterfaceConcept IUnitDeclarationsProvider$gN = MetaAdapterFactory.getInterfaceConcept(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x3ed9ca050c4fd0f3L, "com.mbeddr.ext.units.structure.IUnitDeclarationsProvider");
    /*package*/ static final SConcept GenericUnitDeclarationAttribute$BT = MetaAdapterFactory.getConcept(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x427eb39fcde853b3L, "com.mbeddr.ext.units.structure.GenericUnitDeclarationAttribute");
    /*package*/ static final SInterfaceConcept GenericUnitProvider$kI = MetaAdapterFactory.getInterfaceConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x427eb39fcde2ecb3L, "com.mbeddr.core.base.structure.GenericUnitProvider");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink units$UfaK = MetaAdapterFactory.getContainmentLink(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x427eb39fcde853b3L, 0x427eb39fcde8aa6eL, "units");
  }
}
