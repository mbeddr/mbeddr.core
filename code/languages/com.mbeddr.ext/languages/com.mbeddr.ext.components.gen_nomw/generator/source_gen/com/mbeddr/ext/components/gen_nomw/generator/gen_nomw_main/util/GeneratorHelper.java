package com.mbeddr.ext.components.gen_nomw.generator.gen_nomw_main.util;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import com.mbeddr.core.base.behavior.IConfigurationContainer__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import com.mbeddr.ext.components.behavior.AbstractInstanceConfiguration__BehaviorDescriptor;
import com.mbeddr.ext.components.behavior.Port__BehaviorDescriptor;
import com.mbeddr.ext.components.behavior.Component__BehaviorDescriptor;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SProperty;

public class GeneratorHelper {
  public GeneratorHelper() {
  }
  public static Iterable<SNode> getInlinedStatements(SNode calledRunnable, List<SNode> actuals) {
    Iterable<SNode> all = ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(calledRunnable, LINKS.body$Qjc8), LINKS.statements$euTV)).where((it) -> !(SNodeOperations.isInstanceOf(it, CONCEPTS.ReturnStatement$Kx)));
    List<SNode> res = new ArrayList<SNode>();
    for (SNode s : Sequence.fromIterable(all)) {
      SNode copy = SNodeOperations.copyNode(s);
      List<SNode> arefs = SNodeOperations.getNodeDescendants(copy, CONCEPTS.ArgumentRef$iE, false, new SAbstractConcept[]{});
      for (SNode ref : ListSequence.fromList(arefs)) {
        SNode parens = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x4ffba68fe82dd4c7L, "com.mbeddr.core.expressions.structure.ParensExpression"));
        SLinkOperations.setTarget(parens, LINKS.expression$PfNq, SNodeOperations.copyNode(ListSequence.fromList(actuals).getElement(SNodeOperations.getIndexInParent(SLinkOperations.getTarget(ref, LINKS.arg$WIp5)))));
        SNodeOperations.replaceWithAnother(ref, parens);
      }
      ListSequence.fromList(res).addElement(copy);
    }
    return res;
  }
  public static SNode findStaticallyWiredRunnableForCall(SNode call) {
    final SNode port = SNodeOperations.cast(SLinkOperations.getTarget(SLinkOperations.getTarget(call, LINKS.expression$PfNq), LINKS.port$IUw8), CONCEPTS.RequiredPort$Si);
    SNode instanceConfig = SLinkOperations.getTarget(SNodeOperations.cast(SLinkOperations.getTarget(SNodeOperations.cast(IConfigurationContainer__BehaviorDescriptor.findItemOfType_id3R$6B6bL1DB.invoke(ListSequence.fromList(SModelOperations.roots(SNodeOperations.getModel(call), CONCEPTS.IConfigurationContainer$_T)).first(), CONCEPTS.ComponentsConfigItem$6o.getDeclarationNode()), CONCEPTS.ComponentsConfigItem$6o), LINKS.genStrategy$fd3B), CONCEPTS.NoMwComponentsGenStrategy$VR), LINKS.instanceConfig$6K2d);

    if ((instanceConfig == null)) {
      return null;
    }

    Iterable<SNode> seq = Sequence.fromIterable(AbstractInstanceConfiguration__BehaviorDescriptor.assemblyConnectors_id6JVEnxIhC2V.invoke(instanceConfig)).where((it) -> Port__BehaviorDescriptor.characteristicString_id58NNGt3bEdV.invoke(SLinkOperations.getTarget(SLinkOperations.getTarget(it, LINKS.source$ir30), LINKS.port$HUwa)).equals(Port__BehaviorDescriptor.characteristicString_id58NNGt3bEdV.invoke(port)));
    if (Sequence.fromIterable(seq).count() > 1) {
      final SNode component = SLinkOperations.getTarget(SLinkOperations.getTarget(SLinkOperations.getTarget(Sequence.fromIterable(seq).first(), LINKS.target$iri1), LINKS.instance$ilE8), LINKS.component$ikVC);
      if (Sequence.fromIterable(seq).any((it) -> SLinkOperations.getTarget(SLinkOperations.getTarget(SLinkOperations.getTarget(it, LINKS.target$iri1), LINKS.instance$ilE8), LINKS.component$ikVC) != component)) {
        // if we find more then one connector to that port we cannot wire statically because we need to call different operations
        return null;
      }
    }
    SNode portRef = SLinkOperations.getTarget(Sequence.fromIterable(seq).first(), LINKS.target$iri1);
    SNode targetPort = SNodeOperations.cast(SLinkOperations.getTarget(portRef, LINKS.port$HUwa), CONCEPTS.ProvidedPort$RN);
    SNode targetComp = SLinkOperations.getTarget(SLinkOperations.getTarget(portRef, LINKS.instance$ilE8), LINKS.component$ikVC);
    return (SNode) Component__BehaviorDescriptor.resolveEffectiveRunnableForOperation_idpTHqv6LhL9.invoke(targetComp, targetPort, SLinkOperations.getTarget(call, LINKS.operation$jSaZ));
  }
  public static boolean isStaticallyConnected(final SNode port, SNode callContext) {
    SNode instanceConfig = SLinkOperations.getTarget(SNodeOperations.cast(SLinkOperations.getTarget(SNodeOperations.cast(IConfigurationContainer__BehaviorDescriptor.findItemOfType_id3R$6B6bL1DB.invoke(ListSequence.fromList(SModelOperations.roots(SNodeOperations.getModel(callContext), CONCEPTS.IConfigurationContainer$_T)).first(), CONCEPTS.ComponentsConfigItem$6o.getDeclarationNode()), CONCEPTS.ComponentsConfigItem$6o), LINKS.genStrategy$fd3B), CONCEPTS.NoMwComponentsGenStrategy$VR), LINKS.instanceConfig$6K2d);

    if ((instanceConfig == null)) {
      return false;
    }

    SNode portRef = SLinkOperations.getTarget(Sequence.fromIterable(AbstractInstanceConfiguration__BehaviorDescriptor.assemblyConnectors_id6JVEnxIhC2V.invoke(instanceConfig)).findFirst((it) -> Port__BehaviorDescriptor.characteristicString_id58NNGt3bEdV.invoke(SLinkOperations.getTarget(SLinkOperations.getTarget(it, LINKS.source$ir30), LINKS.port$HUwa)).equals(Port__BehaviorDescriptor.characteristicString_id58NNGt3bEdV.invoke(port))), LINKS.target$iri1);
    return portRef != null;
  }
  public static boolean wireStatically(SNode ctx) {
    return wireStatically(SNodeOperations.getModel(ctx));
  }
  public static boolean wireStatically(SModel ctx) {
    return SPropertyOperations.getBoolean(SNodeOperations.cast(SLinkOperations.getTarget(SNodeOperations.cast(IConfigurationContainer__BehaviorDescriptor.findItemOfType_id3R$6B6bL1DB.invoke(ListSequence.fromList(SModelOperations.roots(ctx, CONCEPTS.IConfigurationContainer$_T)).first(), CONCEPTS.ComponentsConfigItem$6o.getDeclarationNode()), CONCEPTS.ComponentsConfigItem$6o), LINKS.genStrategy$fd3B), CONCEPTS.NoMwComponentsGenStrategy$VR), PROPS.wireStatically$6J$b);
  }

  public static Iterable<SNode> allInstantiatedComponents(SModel model) {
    SNode cci = SNodeOperations.cast(IConfigurationContainer__BehaviorDescriptor.findItemOfType_id3R$6B6bL1DB.invoke(ListSequence.fromList(SModelOperations.roots(model, CONCEPTS.IConfigurationContainer$_T)).first(), CONCEPTS.ComponentsConfigItem$6o.getDeclarationNode()), CONCEPTS.ComponentsConfigItem$6o);
    SNode strategy = SNodeOperations.cast(SLinkOperations.getTarget(cci, LINKS.genStrategy$fd3B), CONCEPTS.NoMwComponentsGenStrategy$VR);
    if (!(SPropertyOperations.getBoolean(strategy, PROPS.wireStatically$6J$b)) || (SLinkOperations.getTarget(strategy, LINKS.instanceConfig$6K2d) == null)) {
      return SModelOperations.nodes(model, CONCEPTS.Component$va);
    }

    Iterable<SNode> directlyInstComp = Sequence.fromIterable(AbstractInstanceConfiguration__BehaviorDescriptor.instances_id6JVEnxIhC2$.invoke(SLinkOperations.getTarget(strategy, LINKS.instanceConfig$6K2d))).select((it) -> SLinkOperations.getTarget(it, LINKS.component$ikVC));
    final Set<SNode> allUsedComponents = SetSequence.fromSet(new HashSet<SNode>());
    Sequence.fromIterable(directlyInstComp).visitAll((it) -> findUsedComponents(it, allUsedComponents));
    return allUsedComponents;
  }

  private static void findUsedComponents(SNode comp, Set<SNode> result) {
    if (SetSequence.fromSet(result).contains(comp)) {
      return;
    }

    SetSequence.fromSet(result).addElement(comp);
    if (SNodeOperations.isInstanceOf(comp, CONCEPTS.AtomicComponent$ym) && (SLinkOperations.getTarget(SNodeOperations.cast(comp, CONCEPTS.AtomicComponent$ym), LINKS.baseComponent$BwAk) != null)) {
      findUsedComponents(SLinkOperations.getTarget(SNodeOperations.cast(comp, CONCEPTS.AtomicComponent$ym), LINKS.baseComponent$BwAk), result);
    }
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink body$Qjc8 = MetaAdapterFactory.getContainmentLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4c1c6L, 0x3e5659cd94a57da3L, "body");
    /*package*/ static final SContainmentLink statements$euTV = MetaAdapterFactory.getContainmentLink(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x3a16e3a9c7ad9955L, 0x3a16e3a9c7ad9956L, "statements");
    /*package*/ static final SContainmentLink expression$PfNq = MetaAdapterFactory.getContainmentLink(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x29b5b7c4a3763232L, 0x64ae61a4018a9c50L, "expression");
    /*package*/ static final SReferenceLink arg$WIp5 = MetaAdapterFactory.getReferenceLink(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x1d0c3765e2e7d0baL, 0x1d0c3765e2e7d0bbL, "arg");
    /*package*/ static final SReferenceLink port$IUw8 = MetaAdapterFactory.getReferenceLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x707ac195dd6397aaL, 0x707ac195dd6397abL, "port");
    /*package*/ static final SContainmentLink genStrategy$fd3B = MetaAdapterFactory.getContainmentLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x1d31b29ecf3bf048L, 0x1d31b29ecf3dbc17L, "genStrategy");
    /*package*/ static final SReferenceLink instanceConfig$6K2d = MetaAdapterFactory.getReferenceLink(0xbd640b8f4be442b6L, 0x8dc02c94d1ddf606L, 0x1d31b29ecf3e58afL, 0x158fe675d002f56fL, "instanceConfig");
    /*package*/ static final SContainmentLink source$ir30 = MetaAdapterFactory.getContainmentLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4de78L, 0x3e5659cd94a4de7cL, "source");
    /*package*/ static final SReferenceLink port$HUwa = MetaAdapterFactory.getReferenceLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4de79L, 0x2fceca7612fd97fbL, "port");
    /*package*/ static final SContainmentLink target$iri1 = MetaAdapterFactory.getContainmentLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4de78L, 0x3e5659cd94a4de7dL, "target");
    /*package*/ static final SReferenceLink instance$ilE8 = MetaAdapterFactory.getReferenceLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4de79L, 0x3e5659cd94a4de7aL, "instance");
    /*package*/ static final SReferenceLink component$ikVC = MetaAdapterFactory.getReferenceLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4de76L, 0x3e5659cd94a4de77L, "component");
    /*package*/ static final SReferenceLink operation$jSaZ = MetaAdapterFactory.getReferenceLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x707ac195dd618205L, 0x707ac195dd618208L, "operation");
    /*package*/ static final SReferenceLink baseComponent$BwAk = MetaAdapterFactory.getReferenceLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4de73L, 0x3e5659cd94a5524dL, "baseComponent");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept ReturnStatement$Kx = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x7c747300dbd94ea5L, "com.mbeddr.core.modules.structure.ReturnStatement");
    /*package*/ static final SConcept ArgumentRef$iE = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x1d0c3765e2e7d0baL, "com.mbeddr.core.modules.structure.ArgumentRef");
    /*package*/ static final SConcept RequiredPort$Si = MetaAdapterFactory.getConcept(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a48fa9L, "com.mbeddr.ext.components.structure.RequiredPort");
    /*package*/ static final SInterfaceConcept IConfigurationContainer$_T = MetaAdapterFactory.getInterfaceConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x3de41a718bc20029L, "com.mbeddr.core.base.structure.IConfigurationContainer");
    /*package*/ static final SConcept ComponentsConfigItem$6o = MetaAdapterFactory.getConcept(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x1d31b29ecf3bf048L, "com.mbeddr.ext.components.structure.ComponentsConfigItem");
    /*package*/ static final SConcept NoMwComponentsGenStrategy$VR = MetaAdapterFactory.getConcept(0xbd640b8f4be442b6L, 0x8dc02c94d1ddf606L, 0x1d31b29ecf3e58afL, "com.mbeddr.ext.components.gen_nomw.structure.NoMwComponentsGenStrategy");
    /*package*/ static final SConcept ProvidedPort$RN = MetaAdapterFactory.getConcept(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a48fa8L, "com.mbeddr.ext.components.structure.ProvidedPort");
    /*package*/ static final SConcept Component$va = MetaAdapterFactory.getConcept(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a235c9L, "com.mbeddr.ext.components.structure.Component");
    /*package*/ static final SConcept AtomicComponent$ym = MetaAdapterFactory.getConcept(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4de73L, "com.mbeddr.ext.components.structure.AtomicComponent");
  }

  private static final class PROPS {
    /*package*/ static final SProperty wireStatically$6J$b = MetaAdapterFactory.getProperty(0xbd640b8f4be442b6L, 0x8dc02c94d1ddf606L, 0x1d31b29ecf3e58afL, 0x158fe675d002f56dL, "wireStatically");
  }
}
