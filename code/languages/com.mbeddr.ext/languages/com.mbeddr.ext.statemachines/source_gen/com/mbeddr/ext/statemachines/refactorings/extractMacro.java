package com.mbeddr.ext.statemachines.refactorings;

/*Generated by MPS */

import jetbrains.mps.refactoring.framework.BaseRefactoring;
import jetbrains.mps.refactoring.framework.IRefactoringTarget;
import jetbrains.mps.refactoring.framework.RefactoringContext;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import com.mbeddr.ext.statemachines.behavior.ITriggerContext__BehaviorDescriptor;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.lang.pattern.util.MatchingUtil;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SProperty;

public class extractMacro extends BaseRefactoring {
  public extractMacro() {
    this.addTransientParameter("macroName");
  }
  public IRefactoringTarget getRefactoringTarget() {
    return new extractMacro_Target();
  }
  public String getUserFriendlyName() {
    return "Extract Macro";
  }
  public void refactor(final RefactoringContext refactoringContext) {
    SNode candidate = refactoringContext.getSelectedNode();
    SNode sm = SNodeOperations.getNodeAncestor(candidate, CONCEPTS.Statemachine$h1, false, false);

    SNode macro = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x564e97d68fb741f5L, 0xbfc1c7ed376efd62L, 0x4a179cdeab8bfe40L, "com.mbeddr.ext.statemachines.structure.ConditionMacro"));
    SLinkOperations.setTarget(macro, LINKS.expr$JxQK, SNodeOperations.copyNode(candidate));
    SPropertyOperations.assign(macro, PROPS.name$MnvL, ((String) refactoringContext.getParameter("macroName")));

    if (ListSequence.fromList(SNodeOperations.getNodeDescendants(candidate, CONCEPTS.EventArgRef$dW, true, new SAbstractConcept[]{})).isNotEmpty()) {
      SLinkOperations.setTarget(macro, LINKS.trigger$Jy5L, SNodeOperations.copyNode(SNodeOperations.cast(ITriggerContext__BehaviorDescriptor.getTrigger_id4CnBdUFzcHv.invoke(SNodeOperations.getNodeAncestor(candidate, CONCEPTS.ITriggerContext$63, false, false)), CONCEPTS.Trigger$Ah)));
    }
    List<SNode> containedMacros = SNodeOperations.getNodeDescendants(candidate, CONCEPTS.MacroRef$Kr, true, new SAbstractConcept[]{});
    if (ListSequence.fromList(containedMacros).isNotEmpty()) {
      SLinkOperations.setTarget(macro, LINKS.trigger$Jy5L, SNodeOperations.copyNode(SLinkOperations.getTarget(SLinkOperations.getTarget(ListSequence.fromList(containedMacros).first(), LINKS.macro$PU2p), LINKS.trigger$Jy5L)));
    }

    List<SNode> allExpressions = SNodeOperations.getNodeDescendants(sm, CONCEPTS.Expression$bT, false, new SAbstractConcept[]{});
    List<SNode> matchedExpressions = new ArrayList<SNode>();
    for (SNode e : ListSequence.fromList(allExpressions)) {
      if (MatchingUtil.matchNodes(candidate, e)) {
        ListSequence.fromList(matchedExpressions).addElement(e);
      }
    }

    for (SNode e : ListSequence.fromList(matchedExpressions)) {
      SNode ref = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x564e97d68fb741f5L, 0xbfc1c7ed376efd62L, 0x4a179cdeab8e2273L, "com.mbeddr.ext.statemachines.structure.MacroRef"));
      SLinkOperations.setTarget(ref, LINKS.macro$PU2p, macro);
      SNodeOperations.replaceWithAnother(e, ref);
    }

    ListSequence.fromList(SLinkOperations.getChildren(sm, LINKS.contents$wkjG)).insertElement(0, macro);

  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Statemachine$h1 = MetaAdapterFactory.getConcept(0x564e97d68fb741f5L, 0xbfc1c7ed376efd62L, 0x50315072219db271L, "com.mbeddr.ext.statemachines.structure.Statemachine");
    /*package*/ static final SInterfaceConcept ITriggerContext$63 = MetaAdapterFactory.getInterfaceConcept(0x564e97d68fb741f5L, 0xbfc1c7ed376efd62L, 0x4a179cdeab8ccb5bL, "com.mbeddr.ext.statemachines.structure.ITriggerContext");
    /*package*/ static final SConcept Trigger$Ah = MetaAdapterFactory.getConcept(0x564e97d68fb741f5L, 0xbfc1c7ed376efd62L, 0x18c9c9c9dcece24bL, "com.mbeddr.ext.statemachines.structure.Trigger");
    /*package*/ static final SConcept EventArgRef$dW = MetaAdapterFactory.getConcept(0x564e97d68fb741f5L, 0xbfc1c7ed376efd62L, 0x18c9c9c9dced44d2L, "com.mbeddr.ext.statemachines.structure.EventArgRef");
    /*package*/ static final SConcept MacroRef$Kr = MetaAdapterFactory.getConcept(0x564e97d68fb741f5L, 0xbfc1c7ed376efd62L, 0x4a179cdeab8e2273L, "com.mbeddr.ext.statemachines.structure.MacroRef");
    /*package*/ static final SConcept Expression$bT = MetaAdapterFactory.getConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x7af69e2e83a1ba32L, "com.mbeddr.core.expressions.structure.Expression");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink expr$JxQK = MetaAdapterFactory.getContainmentLink(0x564e97d68fb741f5L, 0xbfc1c7ed376efd62L, 0x4a179cdeab8bfe40L, 0x4a179cdeab8bfe43L, "expr");
    /*package*/ static final SContainmentLink trigger$Jy5L = MetaAdapterFactory.getContainmentLink(0x564e97d68fb741f5L, 0xbfc1c7ed376efd62L, 0x4a179cdeab8bfe40L, 0x4a179cdeab8bfe44L, "trigger");
    /*package*/ static final SReferenceLink macro$PU2p = MetaAdapterFactory.getReferenceLink(0x564e97d68fb741f5L, 0xbfc1c7ed376efd62L, 0x4a179cdeab8e2273L, 0x4a179cdeab8e2274L, "macro");
    /*package*/ static final SContainmentLink contents$wkjG = MetaAdapterFactory.getContainmentLink(0x564e97d68fb741f5L, 0xbfc1c7ed376efd62L, 0x50315072219db271L, 0x6cbc57210905df2eL, "contents");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
