package com.mbeddr.ext.components.concurrency.util;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import com.mbeddr.core.base.behavior.IVisibleElementProvider__BehaviorDescriptor;
import com.mbeddr.ext.components.behavior.AbstractInstanceConfiguration__BehaviorDescriptor;
import java.util.Objects;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import com.mbeddr.ext.components.concurrency.behavior.IComponentInstanceReference__BehaviorDescriptor;
import java.util.List;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;

public class ComponentConcurrencyUtil {

  public static SNode findComponentInstance(SNode context, SNode type) {
    Iterable<SNode> instances = findComponentInstances(context, type);
    if (Sequence.fromIterable(instances).count() > 1) {
      throw new RuntimeException("Found multiple instances of component '" + SPropertyOperations.getString(type, PROPS.name$MnvL) + "'.");
    }
    if (Sequence.fromIterable(instances).first() == null) {
      Iterable<SNode> allCCInstances = ComponentConcurrencyUtil.getAllCCInstances(context);
      SNode innerCI = null;
      for (SNode it : Sequence.fromIterable(allCCInstances)) {
        innerCI = ComponentConcurrencyUtil.findCI(SNodeOperations.cast(SLinkOperations.getTarget(it, LINKS.component$ikVC), CONCEPTS.CompositeComponent$c8), type);
        if (innerCI != null) {
          return innerCI;
        }
      }
      return innerCI;
    } else {
      return Sequence.fromIterable(instances).first();
    }

  }


  public static Iterable<SNode> findComponentInstances(SNode context, final SNode type) {
    return Sequence.fromIterable(SNodeOperations.ofConcept(IVisibleElementProvider__BehaviorDescriptor.visibleContentsOfType_id6clJcrJXo2_.invoke(SNodeOperations.getNodeAncestor(context, CONCEPTS.IVisibleElementProvider$$O, false, false), SNodeOperations.getNode("r:9596407c-f27a-49d3-abde-3a66293c5b61(com.mbeddr.ext.components.structure)", "7780999115923942144")), CONCEPTS.AbstractInstanceConfiguration$QD)).translate((it) -> (Iterable<SNode>) AbstractInstanceConfiguration__BehaviorDescriptor.instances_id6JVEnxIhC2$.invoke(it)).where((it) -> SLinkOperations.getTarget(it, LINKS.component$ikVC) == type);
  }



  public static SNode findComponentInstance(SNode context, final String name) {
    return Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.collectMany(SNodeOperations.ofConcept(IVisibleElementProvider__BehaviorDescriptor.visibleContentsOfType_id6clJcrJXo2_.invoke(SNodeOperations.getNodeAncestor(context, CONCEPTS.IVisibleElementProvider$$O, false, false), SNodeOperations.getNode("r:9596407c-f27a-49d3-abde-3a66293c5b61(com.mbeddr.ext.components.structure)", "7780999115923942144")), CONCEPTS.AbstractInstanceConfiguration$QD), LINKS.contents$E4B8), CONCEPTS.ComponentInstance$zN)).findFirst((it) -> Objects.equals(SPropertyOperations.getString(it, PROPS.name$MnvL), name));
  }

  public static Iterable<SNode> getCalledRunnablesWithoutInterface(final SNode component) {
    return ListSequence.fromList(SModelOperations.nodes(SNodeOperations.getModel(component), CONCEPTS.ComponentInstanceRunnableCall$kj)).where((it) -> IComponentInstanceReference__BehaviorDescriptor.getComponent_id2kF1PD7dmzD.invoke(SLinkOperations.getTarget(it, LINKS.instanceRef$1B_2)) == component).select((it) -> SLinkOperations.getTarget(it, LINKS.runnable$vLSf)).distinct().where((it) -> (SLinkOperations.getTarget(it, LINKS.trigger$4EcB) == null));
  }

  public static SNode findCI(SNode cc, SNode actualComp) {
    SNode ci = null;
    List<SNode> descendants = SNodeOperations.getNodeDescendants(cc, CONCEPTS.ComponentInstance$zN, true, new SAbstractConcept[]{});
    for (SNode it : ListSequence.fromList(descendants)) {
      if (SLinkOperations.getTarget(it, LINKS.component$ikVC) == actualComp) {
        ci = it;
        return it;
      } else if (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(it, LINKS.component$ikVC), CONCEPTS.CompositeComponent$c8)) {
        ci = findCI(SNodeOperations.cast(SLinkOperations.getTarget(it, LINKS.component$ikVC), CONCEPTS.CompositeComponent$c8), actualComp);
        return ci;
      }
    }
    return ci;
  }

  public static Iterable<SNode> getAllCCInstances(SNode context) {
    return Sequence.fromIterable(SNodeOperations.ofConcept(IVisibleElementProvider__BehaviorDescriptor.visibleContentsOfType_id6clJcrJXo2_.invoke(SNodeOperations.getNodeAncestor(context, CONCEPTS.IVisibleElementProvider$$O, false, false), SNodeOperations.getNode("r:9596407c-f27a-49d3-abde-3a66293c5b61(com.mbeddr.ext.components.structure)", "7780999115923942144")), CONCEPTS.AbstractInstanceConfiguration$QD)).translate((it) -> (Iterable<SNode>) AbstractInstanceConfiguration__BehaviorDescriptor.instances_id6JVEnxIhC2$.invoke(it)).where((it) -> SNodeOperations.isInstanceOf(SLinkOperations.getTarget(it, LINKS.component$ikVC), CONCEPTS.CompositeComponent$c8));
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink component$ikVC = MetaAdapterFactory.getReferenceLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4de76L, 0x3e5659cd94a4de77L, "component");
    /*package*/ static final SContainmentLink contents$E4B8 = MetaAdapterFactory.getContainmentLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x6bfba9786e466b00L, 0x6bfba9786e467315L, "contents");
    /*package*/ static final SContainmentLink instanceRef$1B_2 = MetaAdapterFactory.getContainmentLink(0x3f445ef354ad4ae5L, 0xa22d91c3ce06375eL, 0x777ce3e934cdf41bL, 0x252b075a4731c0dcL, "instanceRef");
    /*package*/ static final SReferenceLink runnable$vLSf = MetaAdapterFactory.getReferenceLink(0x3f445ef354ad4ae5L, 0xa22d91c3ce06375eL, 0x777ce3e934cdf41bL, 0x777ce3e934cdf41fL, "runnable");
    /*package*/ static final SContainmentLink trigger$4EcB = MetaAdapterFactory.getContainmentLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4c1c6L, 0x3e5659cd94a4ca74L, "trigger");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept CompositeComponent$c8 = MetaAdapterFactory.getConcept(0x54f2a59b97bb4c09L, 0xaf92928ebf9c5966L, 0x6bfba9786e44b3b0L, "com.mbeddr.ext.compositecomponents.structure.CompositeComponent");
    /*package*/ static final SInterfaceConcept IVisibleElementProvider$$O = MetaAdapterFactory.getInterfaceConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x6315bcc6eff580a3L, "com.mbeddr.core.base.structure.IVisibleElementProvider");
    /*package*/ static final SConcept AbstractInstanceConfiguration$QD = MetaAdapterFactory.getConcept(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x6bfba9786e466b00L, "com.mbeddr.ext.components.structure.AbstractInstanceConfiguration");
    /*package*/ static final SConcept ComponentInstance$zN = MetaAdapterFactory.getConcept(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4de76L, "com.mbeddr.ext.components.structure.ComponentInstance");
    /*package*/ static final SConcept ComponentInstanceRunnableCall$kj = MetaAdapterFactory.getConcept(0x3f445ef354ad4ae5L, 0xa22d91c3ce06375eL, 0x777ce3e934cdf41bL, "com.mbeddr.ext.components.concurrency.structure.ComponentInstanceRunnableCall");
  }
}
