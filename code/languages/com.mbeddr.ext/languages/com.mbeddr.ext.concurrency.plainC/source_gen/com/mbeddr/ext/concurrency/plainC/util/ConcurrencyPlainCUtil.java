package com.mbeddr.ext.concurrency.plainC.util;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.mps.openapi.model.SNode;
import com.mbeddr.core.base.behavior.IConfigurationContainer__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.smodel.action.SNodeFactoryOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import com.mbeddr.ext.concurrency.behavior.ConcurrentQueueDeclaration__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;

public class ConcurrencyPlainCUtil {
  public static boolean isEnabled(SModel model) {
    return SNodeOperations.isInstanceOf(SLinkOperations.getTarget(getConfigItem(model), LINKS.genStrategy$1aJl), CONCEPTS.PlainCStrategy$Ag);
  }

  public static SNode getConfigItem(SModel model) {
    return SNodeOperations.cast(IConfigurationContainer__BehaviorDescriptor.findItemOfType_id3R$6B6bL1DB.invoke(ListSequence.fromList(SModelOperations.roots(model, CONCEPTS.BuildConfiguration$kH)).first(), SNodeOperations.getNode("r:8bfc0edf-00dc-40ce-9659-fb90c9bd31c8(com.mbeddr.ext.concurrency.structure)", "1199577005875952769")), CONCEPTS.ConcurrencyConfigItem$uy);
  }

  public static SNode getStrategyConfig(SModel model) {
    return SNodeOperations.cast(SLinkOperations.getTarget(getConfigItem(model), LINKS.genStrategy$1aJl), CONCEPTS.PlainCStrategy$Ag);
  }

  public static boolean requiresOwnSection(SNode stmt) {
    if (SNodeOperations.isInstanceOf(stmt, CONCEPTS.StatementList$y1)) {
      return false;
    }
    if (SNodeOperations.isInstanceOf(stmt, CONCEPTS.TaskSection$2E)) {
      return false;
    }
    if (SNodeOperations.isInstanceOf(SNodeOperations.getParent(stmt), CONCEPTS.StatementList$y1) && SNodeOperations.isInstanceOf(SNodeOperations.getParent(SNodeOperations.getParent(stmt)), CONCEPTS.TaskSection$2E) && ListSequence.fromList(SLinkOperations.getChildren(SNodeOperations.cast(SNodeOperations.getParent(stmt), CONCEPTS.StatementList$y1), LINKS.statements$euTV)).count() == 1) {
      // Has already its own section
      return false;
    }
    if (ListSequence.fromList(SNodeOperations.getNodeDescendants(stmt, CONCEPTS.TaskSection$2E, false, new SAbstractConcept[]{})).isNotEmpty()) {
      return true;
    }
    if (SNodeOperations.isInstanceOf(stmt, CONCEPTS.AwaitStatement$Qm)) {
      return true;
    }
    if (SNodeOperations.isInstanceOf(stmt, CONCEPTS.SignalStatement$wf)) {
      return true;
    }
    return false;
  }

  public static boolean requiresSections(SNode stmtList) {
    // For reducing the complexity of the generator, we always use at least one section for the task
    if (SNodeOperations.isInstanceOf(SNodeOperations.getParent(stmtList), CONCEPTS.Task$xk)) {
      return true;
    }

    return ListSequence.fromList(SLinkOperations.getChildren(stmtList, LINKS.statements$euTV)).any((it) -> requiresOwnSection(it));
  }

  public static void introduceSections(SNode stmtList) {
    ListSequence.fromList(SNodeOperations.getNodeDescendants(stmtList, CONCEPTS.StatementList$y1, false, new SAbstractConcept[]{CONCEPTS.StatementList$y1})).visitAll((it) -> introduceSections(it));

    if (!(requiresSections(stmtList))) {
      return;
    }

    List<SNode> sections = ListSequence.fromList(new ArrayList<SNode>());
    SNode section = null;

    for (SNode stmt : ListSequence.fromList(SLinkOperations.getChildren(stmtList, LINKS.statements$euTV))) {
      if (section == null) {
        section = SNodeFactoryOperations.createNewNode(CONCEPTS.TaskSection$2E, null);
        ListSequence.fromList(sections).addElement(section);
      }
      if (requiresOwnSection(stmt)) {
        if (ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(section, LINKS.body$_Mne), LINKS.statements$euTV)).isNotEmpty()) {
          section = SNodeFactoryOperations.createNewNode(CONCEPTS.TaskSection$2E, null);
          ListSequence.fromList(sections).addElement(section);
        }
        ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(section, LINKS.body$_Mne), LINKS.statements$euTV)).addElement(stmt);
        section = null;
      } else {
        ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(section, LINKS.body$_Mne), LINKS.statements$euTV)).addElement(stmt);
      }
    }

    // add goto statement
    for (int i = 0; i < ListSequence.fromList(sections).count() - 1; i++) {
      SNode gotoStmt = SNodeFactoryOperations.addNewChild(SLinkOperations.getTarget(ListSequence.fromList(sections).getElement(i), LINKS.body$_Mne), LINKS.statements$euTV, CONCEPTS.GotoSectionStatement$xD);
      SLinkOperations.setTarget(gotoStmt, LINKS.section$HQUR, ListSequence.fromList(sections).getElement(i + 1));
    }

    ListSequence.fromList(SLinkOperations.getChildren(stmtList, LINKS.statements$euTV)).addSequence(ListSequence.fromList(sections));
  }

  public static boolean canBeFlattened(SNode section) {
    return ListSequence.fromList(getFlattenedStatements(SLinkOperations.getTarget(section, LINKS.body$_Mne))).all((it) -> SNodeOperations.isInstanceOf(it, CONCEPTS.TaskSection$2E) || SNodeOperations.isInstanceOf(it, CONCEPTS.GotoSectionStatement$xD));
  }

  public static void flattenSection(SNode section) {
    List<SNode> flattenedStatements = getFlattenedStatements(SLinkOperations.getTarget(section, LINKS.body$_Mne));
    ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(section, LINKS.body$_Mne), LINKS.statements$euTV)).clear();
    ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(section, LINKS.body$_Mne), LINKS.statements$euTV)).addSequence(ListSequence.fromList(flattenedStatements));
  }

  public static List<SNode> getFlattenedStatements(SNode stmtList) {
    List<SNode> result = ListSequence.fromList(new ArrayList<SNode>());
    collectFlattenedStatements(stmtList, result);
    return result;
  }

  public static void collectFlattenedStatements(SNode stmtList, List<SNode> result) {
    for (SNode stmt : ListSequence.fromList(SLinkOperations.getChildren(stmtList, LINKS.statements$euTV))) {
      if (SNodeOperations.isInstanceOf(stmt, CONCEPTS.StatementList$y1)) {
        collectFlattenedStatements(SNodeOperations.cast(stmt, CONCEPTS.StatementList$y1), result);
      } else if (SConceptOperations.isExactly(SNodeOperations.asSConcept(SNodeOperations.getConcept(stmt)), CONCEPTS.Statement$zV)) {
      } else {
        ListSequence.fromList(result).addElement(stmt);
      }

    }
  }

  public static SNode getNextSection(SNode section) {
    if (SNodeOperations.isInstanceOf(SNodeOperations.getNextSibling(section), CONCEPTS.TaskSection$2E)) {
      return SNodeOperations.cast(SNodeOperations.getNextSibling(section), CONCEPTS.TaskSection$2E);
    }
    if (SNodeOperations.isInstanceOf(SNodeOperations.getParent(SNodeOperations.getParent(section)), CONCEPTS.TaskSection$2E) && ListSequence.fromList(SLinkOperations.getChildren(SNodeOperations.cast(SNodeOperations.getParent(section), CONCEPTS.StatementList$y1), LINKS.statements$euTV)).last() == section) {
      return getNextSection(SNodeOperations.cast(SNodeOperations.getParent(SNodeOperations.getParent(section)), CONCEPTS.TaskSection$2E));
    }
    return null;
  }

  public static List<SNode> findCrossSectionVarRefs(SNode task) {
    return ListSequence.fromList(SNodeOperations.getNodeDescendants(task, CONCEPTS.LocalVarRef$VQ, false, new SAbstractConcept[]{})).where((it) -> SNodeOperations.getNodeAncestor(it, CONCEPTS.TaskSection$2E, false, false) != SNodeOperations.getNodeAncestor(SLinkOperations.getTarget(it, LINKS.var$YUyC), CONCEPTS.TaskSection$2E, false, false)).toList();
  }

  public static boolean mustBeATaskVar(final SNode varDecl) {
    if ((SNodeOperations.getNodeAncestor(varDecl, CONCEPTS.Task$xk, false, false) == null)) {
      return false;
    }
    return ListSequence.fromList(ConcurrencyPlainCUtil.findCrossSectionVarRefs(SNodeOperations.getNodeAncestor(varDecl, CONCEPTS.Task$xk, false, false))).any((it) -> SLinkOperations.getTarget(it, LINKS.var$YUyC) == varDecl);
  }

  public static String generateQueueEventName(SNode queueVar) {
    return (String) ConcurrentQueueDeclaration__BehaviorDescriptor.genEventName_id1zeZsIbcufQ.invoke(SLinkOperations.getTarget(SNodeOperations.cast(SLinkOperations.getTarget(queueVar, LINKS.type$sXU3), CONCEPTS.ConcurrentQueueType$dt), LINKS.queue$hf3r), queueVar);
  }

  public static boolean executesGoto(SNode stmt) {
    if (SNodeOperations.isInstanceOf(stmt, CONCEPTS.IGotoSectionStatement$IT)) {
      return true;
    }
    if (SNodeOperations.isInstanceOf(stmt, CONCEPTS.TaskSection$2E)) {
      return true;
    }

    if (SNodeOperations.isInstanceOf(stmt, CONCEPTS.IfStatement$IE)) {
      SNode ifStmt = SNodeOperations.cast(stmt, CONCEPTS.IfStatement$IE);
      if ((SLinkOperations.getTarget(ifStmt, LINKS.elsePart$9DfV) == null)) {
        return false;
      }
      List<SNode> branches = ListSequence.fromList(new ArrayList<SNode>());
      ListSequence.fromList(branches).addElement(SLinkOperations.getTarget(ifStmt, LINKS.thenPart$f_ts));
      ListSequence.fromList(branches).addSequence(Sequence.fromIterable(SLinkOperations.collect(SLinkOperations.getChildren(ifStmt, LINKS.elseIfs$$74z), LINKS.body$5MZr)));
      ListSequence.fromList(branches).addElement(SLinkOperations.getTarget(SLinkOperations.getTarget(ifStmt, LINKS.elsePart$9DfV), LINKS.body$b0fg));
      if (ListSequence.fromList(branches).where((it) -> it != null).all((it) -> executesGoto(ListSequence.fromList(SLinkOperations.getChildren(it, LINKS.statements$euTV)).last()))) {
        return true;
      }
    }

    return false;
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink genStrategy$1aJl = MetaAdapterFactory.getContainmentLink(0xb879012d402b40e0L, 0x8df7e6fa93b9b711L, 0x10a5c0ee63f67c81L, 0x10a5c0ee63f6fec4L, "genStrategy");
    /*package*/ static final SContainmentLink statements$euTV = MetaAdapterFactory.getContainmentLink(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x3a16e3a9c7ad9955L, 0x3a16e3a9c7ad9956L, "statements");
    /*package*/ static final SContainmentLink body$_Mne = MetaAdapterFactory.getContainmentLink(0xd6943f8183404661L, 0x9d578fc1e2d23b36L, 0x543e5c084834f7d8L, 0x543e5c084834f819L, "body");
    /*package*/ static final SReferenceLink section$HQUR = MetaAdapterFactory.getReferenceLink(0xd6943f8183404661L, 0x9d578fc1e2d23b36L, 0x543e5c084865148aL, 0x543e5c0848651492L, "section");
    /*package*/ static final SReferenceLink var$YUyC = MetaAdapterFactory.getReferenceLink(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x1d0c3765e2e1d67aL, 0x1d0c3765e2e1fe27L, "var");
    /*package*/ static final SContainmentLink type$sXU3 = MetaAdapterFactory.getContainmentLink(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x46a2a92ac61b183L, 0x46a2a92ac61b184L, "type");
    /*package*/ static final SReferenceLink queue$hf3r = MetaAdapterFactory.getReferenceLink(0xb879012d402b40e0L, 0x8df7e6fa93b9b711L, 0x1eb2c4635ea07a33L, 0x1eb2c4635ea07a34L, "queue");
    /*package*/ static final SContainmentLink elsePart$9DfV = MetaAdapterFactory.getContainmentLink(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x5718179e5b1bb7d7L, 0x2b8026b23bc2442bL, "elsePart");
    /*package*/ static final SContainmentLink thenPart$f_ts = MetaAdapterFactory.getContainmentLink(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x5718179e5b1bb7d7L, 0x5718179e5b1bb7d9L, "thenPart");
    /*package*/ static final SContainmentLink elseIfs$$74z = MetaAdapterFactory.getContainmentLink(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x5718179e5b1bb7d7L, 0x2b8026b23bc273a3L, "elseIfs");
    /*package*/ static final SContainmentLink body$5MZr = MetaAdapterFactory.getContainmentLink(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x2b8026b23bc272a6L, 0x2b8026b23bc272a7L, "body");
    /*package*/ static final SContainmentLink body$b0fg = MetaAdapterFactory.getContainmentLink(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x14bcec604136b8e6L, 0x14bcec604136ba31L, "body");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept PlainCStrategy$Ag = MetaAdapterFactory.getConcept(0xd6943f8183404661L, 0x9d578fc1e2d23b36L, 0x694b683d192e53f2L, "com.mbeddr.ext.concurrency.plainC.structure.PlainCStrategy");
    /*package*/ static final SConcept BuildConfiguration$kH = MetaAdapterFactory.getConcept(0x2d7fadf533f64e80L, 0xa78f0f739add2bdeL, 0x6b1af9f9f43c2f48L, "com.mbeddr.core.buildconfig.structure.BuildConfiguration");
    /*package*/ static final SConcept ConcurrencyConfigItem$uy = MetaAdapterFactory.getConcept(0xb879012d402b40e0L, 0x8df7e6fa93b9b711L, 0x10a5c0ee63f67c81L, "com.mbeddr.ext.concurrency.structure.ConcurrencyConfigItem");
    /*package*/ static final SConcept StatementList$y1 = MetaAdapterFactory.getConcept(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x3a16e3a9c7ad9955L, "com.mbeddr.core.statements.structure.StatementList");
    /*package*/ static final SConcept TaskSection$2E = MetaAdapterFactory.getConcept(0xd6943f8183404661L, 0x9d578fc1e2d23b36L, 0x543e5c084834f7d8L, "com.mbeddr.ext.concurrency.plainC.structure.TaskSection");
    /*package*/ static final SConcept AwaitStatement$Qm = MetaAdapterFactory.getConcept(0xb879012d402b40e0L, 0x8df7e6fa93b9b711L, 0x7d015a9e831b178L, "com.mbeddr.ext.concurrency.structure.AwaitStatement");
    /*package*/ static final SConcept SignalStatement$wf = MetaAdapterFactory.getConcept(0xb879012d402b40e0L, 0x8df7e6fa93b9b711L, 0x7d015a9e833375aL, "com.mbeddr.ext.concurrency.structure.SignalStatement");
    /*package*/ static final SConcept Task$xk = MetaAdapterFactory.getConcept(0xb879012d402b40e0L, 0x8df7e6fa93b9b711L, 0x70ef6d442274d918L, "com.mbeddr.ext.concurrency.structure.Task");
    /*package*/ static final SConcept GotoSectionStatement$xD = MetaAdapterFactory.getConcept(0xd6943f8183404661L, 0x9d578fc1e2d23b36L, 0x543e5c084865148aL, "com.mbeddr.ext.concurrency.plainC.structure.GotoSectionStatement");
    /*package*/ static final SConcept Statement$zV = MetaAdapterFactory.getConcept(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x3a16e3a9c7ad6d03L, "com.mbeddr.core.statements.structure.Statement");
    /*package*/ static final SConcept LocalVarRef$VQ = MetaAdapterFactory.getConcept(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x1d0c3765e2e1d67aL, "com.mbeddr.core.statements.structure.LocalVarRef");
    /*package*/ static final SConcept ConcurrentQueueType$dt = MetaAdapterFactory.getConcept(0xb879012d402b40e0L, 0x8df7e6fa93b9b711L, 0x1eb2c4635ea07a33L, "com.mbeddr.ext.concurrency.structure.ConcurrentQueueType");
    /*package*/ static final SInterfaceConcept IGotoSectionStatement$IT = MetaAdapterFactory.getInterfaceConcept(0xd6943f8183404661L, 0x9d578fc1e2d23b36L, 0x409b4a45fe94f214L, "com.mbeddr.ext.concurrency.plainC.structure.IGotoSectionStatement");
    /*package*/ static final SConcept IfStatement$IE = MetaAdapterFactory.getConcept(0xa9d696470840491eL, 0xbf392eb0805d2011L, 0x5718179e5b1bb7d7L, "com.mbeddr.core.statements.structure.IfStatement");
  }
}
