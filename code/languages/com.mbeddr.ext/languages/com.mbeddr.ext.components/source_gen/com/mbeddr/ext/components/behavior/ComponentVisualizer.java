package com.mbeddr.ext.components.behavior;

/*Generated by MPS */

import com.mbeddr.mpsutil.plantuml.node.behavior.VisGraph;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.mbeddr.core.base.behavior.IVisibleElementProvider__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class ComponentVisualizer {
  public static final String CandI = "components + interfaces";
  private static final String CandIbyM = "components + interfaces (grouped)";
  private static final String CandIbyM2D = "components + interfaces (grouped, 2D)";
  private static final String CandIbyM2DPrx = "components + interfaces (grouped, proxied)";
  private static final String CandIbyM2DShort = "components + interfaces (grouped, 2D, short)";
  private static final String CandIbyM2DProxied = "components + interfaces (grouped, 2D, proxied)";
  private static final String INST = "instances";
  private static final String INST_GROUPED = "instances (grouped)";
  private static final String INST_GROUPED_SHORT = "instances (grouped, short)";
  private static String[] DIRS = new String[]{"left", "up", "right", "down"};
  public ComponentVisualizer() {
  }
  public static String[] getCategoriesForComponents() {
    return new String[]{CandI, CandIbyM, CandIbyM2D, CandIbyM2DPrx, CandIbyM2DShort, CandIbyM2DProxied};
  }
  public static String[] getCategoriesForInstances() {
    return new String[]{INST, INST_GROUPED, INST_GROUPED_SHORT};
  }
  public static String namify(String s) {
    StringBuilder sb = new StringBuilder();
    int pos = 0;
    for (char c : s.toCharArray()) {
      if (pos > 0) {
        if (Character.isUpperCase(c) && !(Character.isUpperCase(s.charAt(pos - 1)))) {
          sb.append("\\n");
        }
      }
      sb.append(c);
      pos++;
    }
    return "\"" + sb.toString() + "\"";
  }
  private static void visComponent(VisGraph g, SNode c, boolean mustBeProxied) {
    g.add("component " + namify(SPropertyOperations.getString(c, PROPS.name$MnvL)) + " as " + SPropertyOperations.getString(c, PROPS.name$MnvL));
    g.add("url of " + SPropertyOperations.getString(c, PROPS.name$MnvL) + " is " + g.createLink(c));
  }
  private static void visInterface(VisGraph g, SNode i) {
    g.add("interface " + namify(SPropertyOperations.getString(i, PROPS.name$MnvL)) + " as " + SPropertyOperations.getString(i, PROPS.name$MnvL));
    g.add("url of " + SPropertyOperations.getString(i, PROPS.name$MnvL) + " is " + g.createLink(i));
  }
  public static void visualizeComponents(final SNode module, String category, final VisGraph g) {
    final boolean proxyRequested = category.contains("proxied");
    Iterable<SNode> interfaces = Sequence.fromIterable(SNodeOperations.ofConcept(IVisibleElementProvider__BehaviorDescriptor.visibleContentsOfType_id6clJcrJXo2_.invoke(module, CONCEPTS.Interface$tq.getDeclarationNode()), CONCEPTS.Interface$tq)).distinct();
    Iterable<SNode> components = Sequence.fromIterable(SNodeOperations.ofConcept(IVisibleElementProvider__BehaviorDescriptor.visibleContentsOfType_id6clJcrJXo2_.invoke(module, CONCEPTS.Component$va.getDeclarationNode()), CONCEPTS.Component$va)).distinct();
    g.setTitle("Component and Interfaces for module " + SPropertyOperations.getString(module, PROPS.name$MnvL));
    if (category.contains("grouped")) {
      Iterable<SNode> modules = Sequence.fromIterable(components).union(Sequence.fromIterable(interfaces)).select((it) -> SNodeOperations.getNodeAncestor(it, CONCEPTS.ImplementationModule$Gy, false, false)).distinct();
      for (final SNode m : Sequence.fromIterable(modules)) {
        if (proxyRequested && m != module) {
          g.add("package " + SPropertyOperations.getString(m, PROPS.name$MnvL) + " #DDDDDD {");
        } else {
          g.add("package " + SPropertyOperations.getString(m, PROPS.name$MnvL) + " {");
        }
        Sequence.fromIterable(components).where((it) -> SNodeOperations.getNodeAncestor(it, CONCEPTS.ImplementationModule$Gy, false, false) == m).visitAll((it) -> {
          boolean mustBeProxied = proxyRequested && SNodeOperations.getNodeAncestor(it, CONCEPTS.ImplementationModule$Gy, false, false) != module;
          if (!(mustBeProxied)) {
            visComponent(g, it, mustBeProxied);
          }
        });
        Sequence.fromIterable(interfaces).where((it) -> SNodeOperations.getNodeAncestor(it, CONCEPTS.ImplementationModule$Gy, false, false) == m).visitAll((it) -> visInterface(g, it));
        g.add("}");
      }
    } else {
      Sequence.fromIterable(components).visitAll((it) -> {
        boolean mustBeProxied = proxyRequested && SNodeOperations.getNodeAncestor(it, CONCEPTS.ImplementationModule$Gy, false, false) != module;
        visComponent(g, it, mustBeProxied);
      });
      Sequence.fromIterable(interfaces).visitAll((it) -> visInterface(g, it));
    }
    for (SNode c : Sequence.fromIterable(components)) {
      boolean mustBeProxied = proxyRequested && SNodeOperations.getNodeAncestor(c, CONCEPTS.ImplementationModule$Gy, false, false) != module;
      if (!(mustBeProxied)) {
        for (SNode pp : Sequence.fromIterable(Component__BehaviorDescriptor.providedPorts_id6WCyKlekwqK.invoke(c))) {
          String direction = " --> ";
          if (category.contains("2D")) {
            int randomNumber = SPropertyOperations.getString(pp, PROPS.name$MnvL).charAt(0) + SNodeOperations.getIndexInParent(pp);
            direction = " -" + DIRS[randomNumber % (DIRS.length)] + "-> ";
          }
          String pname = (category.contains("short") ? "o" : SPropertyOperations.getString(pp, PROPS.name$MnvL));
          g.add(SPropertyOperations.getString(c, PROPS.name$MnvL) + direction + SPropertyOperations.getString(SLinkOperations.getTarget(pp, LINKS.intf$QYND), PROPS.name$MnvL) + ": " + g.createLink(pp, pname));
        }
        for (SNode rp : Sequence.fromIterable(Component__BehaviorDescriptor.requiredPorts_id6WCyKlekwqV.invoke(c))) {
          String direction = " ..> ";
          if (category.contains("2D")) {
            int randomNumber = SPropertyOperations.getString(rp, PROPS.name$MnvL).charAt(0) + SNodeOperations.getIndexInParent(rp);
            direction = " ." + DIRS[randomNumber % (DIRS.length)] + ".> ";
          }
          String pname = (category.contains("short") ? "o" : SPropertyOperations.getString(rp, PROPS.name$MnvL));
          g.add(SPropertyOperations.getString(c, PROPS.name$MnvL) + direction + SPropertyOperations.getString(SLinkOperations.getTarget(rp, LINKS.intf$QYND), PROPS.name$MnvL) + ": " + g.createLink(rp, pname));
        }
      }
    }
  }
  public static void visualizeInstances(SNode config, String category, VisGraph g) {
    g.setTitle("Instances and Wiring for instance configuration " + SPropertyOperations.getString(config, PROPS.name$MnvL));
    Iterable<SNode> components = Sequence.fromIterable(AbstractInstanceConfiguration__BehaviorDescriptor.instances_id6JVEnxIhC2$.invoke(config)).select((it) -> SLinkOperations.getTarget(it, LINKS.component$ikVC)).distinct();
    if (category.contains("grouped")) {
      for (final SNode c : Sequence.fromIterable(components)) {
        Iterable<SNode> instancesOfC = Sequence.fromIterable(AbstractInstanceConfiguration__BehaviorDescriptor.instances_id6JVEnxIhC2$.invoke(config)).where((it) -> SLinkOperations.getTarget(it, LINKS.component$ikVC) == c);
        if (Sequence.fromIterable(instancesOfC).count() > 1) {
          g.add("package " + SPropertyOperations.getString(c, PROPS.name$MnvL) + " {");
          for (SNode i : Sequence.fromIterable(instancesOfC)) {
            g.add("component \"" + SPropertyOperations.getString(i, PROPS.name$MnvL) + "\" as " + SPropertyOperations.getString(i, PROPS.name$MnvL));
            g.add("url of " + SPropertyOperations.getString(i, PROPS.name$MnvL) + " is " + g.createLink(i));
          }
          g.add("}");
        } else {
          for (SNode i : Sequence.fromIterable(instancesOfC)) {
            g.add("component \"" + SPropertyOperations.getString(i, PROPS.name$MnvL) + ":\\n" + SPropertyOperations.getString(SLinkOperations.getTarget(i, LINKS.component$ikVC), PROPS.name$MnvL) + "\" as " + SPropertyOperations.getString(i, PROPS.name$MnvL));
            g.add("url of " + SPropertyOperations.getString(i, PROPS.name$MnvL) + " is " + g.createLink(i));
          }
        }
      }
    } else {
      for (SNode i : Sequence.fromIterable(AbstractInstanceConfiguration__BehaviorDescriptor.instances_id6JVEnxIhC2$.invoke(config))) {
        g.add("component \"" + SPropertyOperations.getString(i, PROPS.name$MnvL) + ":\\n" + SPropertyOperations.getString(SLinkOperations.getTarget(i, LINKS.component$ikVC), PROPS.name$MnvL) + "\" as " + SPropertyOperations.getString(i, PROPS.name$MnvL));
        g.add("url of " + SPropertyOperations.getString(i, PROPS.name$MnvL) + " is " + g.createLink(i));
      }
    }
    for (SNode ac : Sequence.fromIterable(AbstractInstanceConfiguration__BehaviorDescriptor.assemblyConnectors_id6JVEnxIhC2V.invoke(config))) {
      if (category.contains("short")) {
        String ports = "c";
        g.add(SPropertyOperations.getString(SLinkOperations.getTarget(SLinkOperations.getTarget(ac, LINKS.source$ir30), LINKS.instance$ilE8), PROPS.name$MnvL) + " --> " + g.createLink(ac, SPropertyOperations.getString(SLinkOperations.getTarget(SLinkOperations.getTarget(ac, LINKS.target$iri1), LINKS.instance$ilE8), PROPS.name$MnvL)) + " : " + ports);
      } else {
        String ports = SPropertyOperations.getString(SLinkOperations.getTarget(SLinkOperations.getTarget(ac, LINKS.source$ir30), LINKS.port$HUwa), PROPS.name$MnvL) + "->" + SPropertyOperations.getString(SLinkOperations.getTarget(SLinkOperations.getTarget(ac, LINKS.target$iri1), LINKS.port$HUwa), PROPS.name$MnvL);
        g.add(SPropertyOperations.getString(SLinkOperations.getTarget(SLinkOperations.getTarget(ac, LINKS.source$ir30), LINKS.instance$ilE8), PROPS.name$MnvL) + " --> " + g.createLink(ac, SPropertyOperations.getString(SLinkOperations.getTarget(SLinkOperations.getTarget(ac, LINKS.target$iri1), LINKS.instance$ilE8), PROPS.name$MnvL)) + " : " + ports + " " + "\\n" + SPropertyOperations.getString(SLinkOperations.getTarget(SLinkOperations.getTarget(SLinkOperations.getTarget(ac, LINKS.source$ir30), LINKS.port$HUwa), LINKS.intf$QYND), PROPS.name$MnvL));
      }
    }
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Interface$tq = MetaAdapterFactory.getConcept(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a25d77L, "com.mbeddr.ext.components.structure.Interface");
    /*package*/ static final SConcept Component$va = MetaAdapterFactory.getConcept(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a235c9L, "com.mbeddr.ext.components.structure.Component");
    /*package*/ static final SConcept ImplementationModule$Gy = MetaAdapterFactory.getConcept(0x6d11763d483d4b2bL, 0x8efc09336c1b0001L, 0x595522006a5b934eL, "com.mbeddr.core.modules.structure.ImplementationModule");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink intf$QYND = MetaAdapterFactory.getReferenceLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a25d82L, 0x3e5659cd94a25d84L, "intf");
    /*package*/ static final SReferenceLink component$ikVC = MetaAdapterFactory.getReferenceLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4de76L, 0x3e5659cd94a4de77L, "component");
    /*package*/ static final SContainmentLink source$ir30 = MetaAdapterFactory.getContainmentLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4de78L, 0x3e5659cd94a4de7cL, "source");
    /*package*/ static final SReferenceLink instance$ilE8 = MetaAdapterFactory.getReferenceLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4de79L, 0x3e5659cd94a4de7aL, "instance");
    /*package*/ static final SContainmentLink target$iri1 = MetaAdapterFactory.getContainmentLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4de78L, 0x3e5659cd94a4de7dL, "target");
    /*package*/ static final SReferenceLink port$HUwa = MetaAdapterFactory.getReferenceLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4de79L, 0x2fceca7612fd97fbL, "port");
  }
}
