package com.mbeddr.ext.components.pluginSolution.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import com.intellij.openapi.project.Project;
import com.intellij.ui.awt.RelativePoint;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.ide.findusages.view.FindUtils;
import java.util.Set;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import com.intellij.openapi.progress.ProgressManager;
import com.intellij.openapi.progress.Task;
import org.jetbrains.annotations.NotNull;
import com.intellij.openapi.progress.ProgressIndicator;
import org.jetbrains.mps.openapi.module.SearchScope;
import jetbrains.mps.project.GlobalScope;
import java.util.List;
import jetbrains.mps.progress.ProgressMonitorAdapter;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.smodel.SNodePointer;
import jetbrains.mps.ide.editor.util.GoToContextMenuHelper;
import jetbrains.mps.ide.editor.util.renderer.DefaultMethodRenderer;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class GoToHelper_Custom {
  public static void executeFinders(final SNode referencedElement, Project project, final String finderClassName, RelativePoint relativePoint) {
    final Wrappers._T<String> methodName = new Wrappers._T<String>();
    final jetbrains.mps.project.Project mpsProject = ProjectHelper.fromIdeaProject(project);

    mpsProject.getRepository().getModelAccess().runReadAction(() -> {
      methodName.value = SPropertyOperations.getString(referencedElement, PROPS.name$MnvL);
      assert FindUtils.getFinder(finderClassName).isApplicable(referencedElement);
    });

    final Set<SNodeReference> nodes = SetSequence.fromSet(new HashSet<SNodeReference>());
    ProgressManager.getInstance().run(new Task.Modal(project, "Searching...", true) {
      @Override
      public void run(@NotNull final ProgressIndicator p) {
        mpsProject.getRepository().getModelAccess().runReadAction(() -> {
          // XXX why not mpsProject.getScope()? Generally, project scope is enough for end-user scenarios
          SearchScope scope = new GlobalScope(mpsProject.getRepository());
          List<SNode> list = FindUtils.executeFinder(finderClassName, referencedElement, scope, new ProgressMonitorAdapter(p));
          SetSequence.fromSet(nodes).addSequence(ListSequence.fromList(list).select((it) -> new SNodePointer(it)));
        });
      }
    });

    String title = "Choose implementing runnable of " + methodName.value + "() to navigate to";
    GoToContextMenuHelper.showMenu(mpsProject, title, SetSequence.fromSet(nodes).toList(), new DefaultMethodRenderer(mpsProject.getRepository()), relativePoint);
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
