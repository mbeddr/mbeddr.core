package com.mbeddr.ext.units.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.dependencies.InferenceMethod;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import org.jetbrains.mps.openapi.model.SNode;
import com.mbeddr.core.modules.behavior.ICallLike__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import java.util.Map;
import com.mbeddr.ext.units.runtime.plugin.Fraction;
import java.util.Collections;
import java.util.HashMap;
import java.util.concurrent.atomic.AtomicInteger;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import com.mbeddr.ext.units.behavior.Exponent__BehaviorDescriptor;
import com.mbeddr.ext.units.runtime.plugin.UnitConversionUtil;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import jetbrains.mps.errors.messageTargets.MessageTarget;
import jetbrains.mps.errors.messageTargets.NodeMessageTarget;
import jetbrains.mps.errors.IErrorReporter;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.IMapping;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.typesystem.inference.EquationInfo;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class typeof_ICallLike_Helper {

  @InferenceMethod
  public static void processNode(final TypeCheckingContext typeCheckingContext, final SNode callLike) {
    if (ICallLike__BehaviorDescriptor.getFunction_id74lwjTQiYY5.invoke(callLike) != null) {
      SNode genericUnitDeclaration = new IAttributeDescriptor.NodeAttribute(CONCEPTS.GenericUnitDeclarationAttribute$BT).get(ICallLike__BehaviorDescriptor.getFunction_id74lwjTQiYY5.invoke(callLike));

      if ((genericUnitDeclaration != null)) {
        final Map<SNode, Map<SNode, Fraction>> metaMapping = Collections.synchronizedMap(new HashMap<SNode, Map<SNode, Fraction>>());
        final AtomicInteger argumentCounter = new AtomicInteger(ListSequence.fromList(ICallLike__BehaviorDescriptor.getActuals_id6WGVxckB05Y.invoke(callLike)).count());

        for (int i = 0; i < Math.min(ListSequence.fromList(ICallLike__BehaviorDescriptor.getActuals_id6WGVxckB05Y.invoke(callLike)).count(), ListSequence.fromList(ICallLike__BehaviorDescriptor.getFormals_id6WGVxckB065.invoke(callLike)).count()); i++) {
          final SNode actualArgument = ListSequence.fromList(ICallLike__BehaviorDescriptor.getActuals_id6WGVxckB05Y.invoke(callLike)).getElement(i);
          final SNode formalArgument = ListSequence.fromList(ICallLike__BehaviorDescriptor.getFormals_id6WGVxckB065.invoke(callLike)).getElement(i);

          {
            final SNode actualArgumentType = typeCheckingContext.typeOf(actualArgument, "r:f5260afd-8327-4c3e-bf02-c81ea8a33729(com.mbeddr.ext.units.typesystem)", "5435176865283500764", true);
            typeCheckingContext.whenConcrete(actualArgumentType, () -> {
              // the actual argument will never contain meta units in the type annotation
              // the formal argument may contain meta units in the type annotation
              if (SNodeOperations.isInstanceOf(typeCheckingContext.getExpandedNode(actualArgumentType), CONCEPTS.AnnotatedType$I9) && SNodeOperations.isInstanceOf(SLinkOperations.getTarget(formalArgument, LINKS.type$sXU3), CONCEPTS.AnnotatedType$I9) && ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(SNodeOperations.cast(SLinkOperations.getTarget(formalArgument, LINKS.type$sXU3), CONCEPTS.AnnotatedType$I9), LINKS.specification$Q3Ej), LINKS.components$PbgL)).any((it) -> SNodeOperations.isInstanceOf(SLinkOperations.getTarget(it, LINKS.unit$ZXwJ), CONCEPTS.MetaUnit$gm) && !(SLinkOperations.getTarget(it, LINKS.exponent$ZXYL) != null && (int) Exponent__BehaviorDescriptor.getNumerator_id3j3yk3guAC3.invoke(SLinkOperations.getTarget(it, LINKS.exponent$ZXYL)) == 0))) {

                final SNode formalArgumentType = SNodeOperations.cast(SLinkOperations.getTarget(formalArgument, LINKS.type$sXU3), CONCEPTS.AnnotatedType$I9);

                argumentCounter.decrementAndGet();

                SNode metaUnitReference = ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(formalArgumentType, LINKS.specification$Q3Ej), LINKS.components$PbgL)).where((it) -> SNodeOperations.isInstanceOf(SLinkOperations.getTarget(it, LINKS.unit$ZXwJ), CONCEPTS.MetaUnit$gm)).first();

                SNode metaUnit = SNodeOperations.cast(SLinkOperations.getTarget(metaUnitReference, LINKS.unit$ZXwJ), CONCEPTS.MetaUnit$gm);
                Map<SNode, Fraction> actualArgumentUnitMap = UnitConversionUtil.getUnitMap_UnitSpecification(SLinkOperations.getTarget(SNodeOperations.cast(typeCheckingContext.getExpandedNode(actualArgumentType), CONCEPTS.AnnotatedType$I9), LINKS.specification$Q3Ej));
                Map<SNode, Fraction> formalArgumentUnitMap = UnitConversionUtil.getUnitMap_UnitSpecification(SLinkOperations.getTarget(formalArgumentType, LINKS.specification$Q3Ej));

                // remove meta unit from unit map of formal argument
                MapSequence.fromMap(formalArgumentUnitMap).removeKey(metaUnit);

                // reduce actual argument unit map with the remaining formal unit map
                Map<SNode, Fraction> metaUnitMap = UnitConversionUtil.reduceBy(actualArgumentUnitMap, formalArgumentUnitMap);

                // check if the meta unit's exponent can be matched with the computed unit mapping
                metaUnitMap = (SLinkOperations.getTarget(metaUnitReference, LINKS.exponent$ZXYL) != null && !((boolean) Exponent__BehaviorDescriptor.isOne_id5dSoB2M24Xr.invoke(SLinkOperations.getTarget(metaUnitReference, LINKS.exponent$ZXYL))) ? UnitConversionUtil.rootBy(metaUnitMap, SLinkOperations.getTarget(metaUnitReference, LINKS.exponent$ZXYL)) : metaUnitMap);

                if (metaUnitMap == null) {
                  {
                    final MessageTarget errorTarget = new NodeMessageTarget();
                    IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(callLike, "Impossible to resolve the meta units due to resulting exponents!", "r:f5260afd-8327-4c3e-bf02-c81ea8a33729(com.mbeddr.ext.units.typesystem)", "2418981108279005384", null, errorTarget);
                  }
                } else if (MapSequence.fromMap(metaMapping).containsKey(metaUnit) && !(UnitConversionUtil.matchingUnits(metaUnitMap, MapSequence.fromMap(metaMapping).get(metaUnit), false))) {
                  {
                    final MessageTarget errorTarget = new NodeMessageTarget();
                    IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(callLike, "Impossible to resolve the meta units due to inconsistent resolving!", "r:f5260afd-8327-4c3e-bf02-c81ea8a33729(com.mbeddr.ext.units.typesystem)", "688756255677495764", null, errorTarget);
                  }
                } else {
                  MapSequence.fromMap(metaMapping).put(metaUnit, metaUnitMap);
                }
              } else {
                argumentCounter.decrementAndGet();
              }

              // set the return type
              if (argumentCounter.get() == 0) {
                {
                  final SNode type = typeCheckingContext.typeOf(ICallLike__BehaviorDescriptor.getReturnType_id7$$5Stoo8Y$.invoke(callLike), "r:f5260afd-8327-4c3e-bf02-c81ea8a33729(com.mbeddr.ext.units.typesystem)", "182845728206935368", true);
                  typeCheckingContext.whenConcrete(type, () -> {

                    SNode returnType = SNodeOperations.copyNode(typeCheckingContext.getExpandedNode(type));
                    if (SNodeOperations.isInstanceOf(returnType, CONCEPTS.AnnotatedType$I9)) {
                      List<SNode> substitutions = ListSequence.fromList(new ArrayList<SNode>());
                      for (IMapping<SNode, Map<SNode, Fraction>> mapping : MapSequence.fromMap(metaMapping)) {

                        SNode specification = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x73b48a125b0d411dL, "com.mbeddr.ext.units.structure.UnitSpecification"));
                        ListSequence.fromList(SLinkOperations.getChildren(specification, LINKS.components$PbgL)).addSequence(ListSequence.fromList(UnitConversionUtil.createUnitReferences(mapping.value())));

                        SNode substitution = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x55aa7381f5dffb6L, "com.mbeddr.ext.units.structure.InferredSubstitution"));
                        SLinkOperations.setTarget(substitution, LINKS.metaUnit$5OO2, mapping.key());
                        SLinkOperations.setTarget(substitution, LINKS.realUnit$5NRY, specification);

                        ListSequence.fromList(substitutions).addElement(substitution);
                      }

                      new IAttributeDescriptor.NodeAttribute(CONCEPTS.InferredAttribute$yb).set(SNodeOperations.cast(returnType, CONCEPTS.AnnotatedType$I9), createInferredAttribute_auzg3y_a0d0c0b0a1a0a5a1a0b0d0d0c0a0b(substitutions));

                      // check if the resolved unit map evaluates to zero exponents,
                      // in this case we can replace the AnnotatedType with the wrapped inner type
                      Map<SNode, Fraction> unitMap = UnitConversionUtil.getUnitMap_UnitSpecification(SLinkOperations.getTarget(SNodeOperations.cast(returnType, CONCEPTS.AnnotatedType$I9), LINKS.specification$Q3Ej), new IAttributeDescriptor.NodeAttribute(CONCEPTS.InferredAttribute$yb).get(SNodeOperations.cast(returnType, CONCEPTS.AnnotatedType$I9)));

                      if (MapSequence.fromMap(unitMap).any((it) -> it.value().isNonZero())) {
                        List<SNode> references = UnitConversionUtil.createUnitReferences(unitMap);
                        ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(SNodeOperations.cast(returnType, CONCEPTS.AnnotatedType$I9), LINKS.specification$Q3Ej), LINKS.components$PbgL)).clear();
                        ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(SNodeOperations.cast(returnType, CONCEPTS.AnnotatedType$I9), LINKS.specification$Q3Ej), LINKS.components$PbgL)).addSequence(ListSequence.fromList(references));
                        {
                          SNode _nodeToCheck_1029348928467 = callLike;
                          EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:f5260afd-8327-4c3e-bf02-c81ea8a33729(com.mbeddr.ext.units.typesystem)", "9116549269035487576", 0, null);
                          typeCheckingContext.createGreaterThanInequality((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:f5260afd-8327-4c3e-bf02-c81ea8a33729(com.mbeddr.ext.units.typesystem)", "9116549269035487579", true), (SNode) returnType, false, true, _info_12389875345);
                        }
                      } else {
                        {
                          SNode _nodeToCheck_1029348928467 = callLike;
                          EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:f5260afd-8327-4c3e-bf02-c81ea8a33729(com.mbeddr.ext.units.typesystem)", "1958770732430104423", 0, null);
                          typeCheckingContext.createLessThanInequality((SNode) SLinkOperations.getTarget(SNodeOperations.cast(returnType, CONCEPTS.AnnotatedType$I9), LINKS.valueType$2o7e), (SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:f5260afd-8327-4c3e-bf02-c81ea8a33729(com.mbeddr.ext.units.typesystem)", "1958770732430104427", true), false, true, _info_12389875345);
                        }
                      }
                    }
                  }, "r:f5260afd-8327-4c3e-bf02-c81ea8a33729(com.mbeddr.ext.units.typesystem)", "182845728206927232", false, false);
                }
              }
            }, "r:f5260afd-8327-4c3e-bf02-c81ea8a33729(com.mbeddr.ext.units.typesystem)", "5435176865283500454", false, false);
          }
        }
      }
    }
  }
  private static SNode createInferredAttribute_auzg3y_a0d0c0b0a1a0a5a1a0b0d0d0c0a0b(Iterable<? extends SNode> p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.InferredAttribute$yb);
    n0.forChild(LINKS.substitutions$69eS).initNodeList(p0, CONCEPTS.InferredSubstitution$Ej);
    return n0.getResult();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept GenericUnitDeclarationAttribute$BT = MetaAdapterFactory.getConcept(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x427eb39fcde853b3L, "com.mbeddr.ext.units.structure.GenericUnitDeclarationAttribute");
    /*package*/ static final SConcept AnnotatedType$I9 = MetaAdapterFactory.getConcept(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x73b48a125b0f3f14L, "com.mbeddr.ext.units.structure.AnnotatedType");
    /*package*/ static final SConcept MetaUnit$gm = MetaAdapterFactory.getConcept(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x73b48a125b28a2ddL, "com.mbeddr.ext.units.structure.MetaUnit");
    /*package*/ static final SConcept InferredAttribute$yb = MetaAdapterFactory.getConcept(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x55aa7381f5dffdfL, "com.mbeddr.ext.units.structure.InferredAttribute");
    /*package*/ static final SConcept InferredSubstitution$Ej = MetaAdapterFactory.getConcept(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x55aa7381f5dffb6L, "com.mbeddr.ext.units.structure.InferredSubstitution");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink type$sXU3 = MetaAdapterFactory.getContainmentLink(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x46a2a92ac61b183L, 0x46a2a92ac61b184L, "type");
    /*package*/ static final SContainmentLink specification$Q3Ej = MetaAdapterFactory.getContainmentLink(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x73b48a125b0f3f14L, 0x73b48a125b0f3f48L, "specification");
    /*package*/ static final SContainmentLink components$PbgL = MetaAdapterFactory.getContainmentLink(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x73b48a125b0d411dL, 0x73b48a125b0dab03L, "components");
    /*package*/ static final SReferenceLink unit$ZXwJ = MetaAdapterFactory.getReferenceLink(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x73b48a125b0d4dc5L, 0x73b48a125b0daafcL, "unit");
    /*package*/ static final SContainmentLink exponent$ZXYL = MetaAdapterFactory.getContainmentLink(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x73b48a125b0d4dc5L, 0x73b48a125b0daafeL, "exponent");
    /*package*/ static final SReferenceLink metaUnit$5OO2 = MetaAdapterFactory.getReferenceLink(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x55aa7381f5dffb6L, 0x55aa7381f5dffd8L, "metaUnit");
    /*package*/ static final SContainmentLink realUnit$5NRY = MetaAdapterFactory.getContainmentLink(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x55aa7381f5dffb6L, 0x55aa7381f5dffd4L, "realUnit");
    /*package*/ static final SContainmentLink valueType$2o7e = MetaAdapterFactory.getContainmentLink(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0xa526fcd7806eb53L, 0x65d0a4755f54174cL, "valueType");
    /*package*/ static final SContainmentLink substitutions$69eS = MetaAdapterFactory.getContainmentLink(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x55aa7381f5dffdfL, 0x55aa7381f5dffecL, "substitutions");
  }
}
