package com.mbeddr.ext.components.units.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.runtime.AbstractInferenceRule_Runtime;
import jetbrains.mps.lang.typesystem.runtime.InferenceRule_Runtime;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import jetbrains.mps.lang.typesystem.runtime.IsApplicableStatus;
import java.util.List;
import com.mbeddr.core.modules.behavior.ICallLike__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import com.mbeddr.ext.components.units.behavior.GenericUnitInitializer_Helper;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import com.mbeddr.ext.units.behavior.IGenericUnitMappingProvider__BehaviorDescriptor;
import jetbrains.mps.typesystem.inference.EquationInfo;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class typeof_InterfaceOperationCallExpr_InferenceRule extends AbstractInferenceRule_Runtime implements InferenceRule_Runtime {
  public typeof_InterfaceOperationCallExpr_InferenceRule() {
  }
  public void applyRule(final SNode call, final TypeCheckingContext typeCheckingContext, IsApplicableStatus status) {
    // inferring annotated return type, if any
    typeof_InterfaceOperationCallExpr_Helper.processNode(typeCheckingContext, call);

    // handle argument checks with annotated types, if any
    final List<SNode> actuals = ICallLike__BehaviorDescriptor.getActuals_id6WGVxckB05Y.invoke(call);
    final List<SNode> formals = ICallLike__BehaviorDescriptor.getFormals_id6WGVxckB065.invoke(call);
    int actualCount = ListSequence.fromList(actuals).count();
    int formalCount = ListSequence.fromList(formals).count();

    final int smaller = Math.min(actualCount, formalCount);
    final SNode initializer = GenericUnitInitializer_Helper.getGenericUnitInitializer(call);

    if (initializer != null) {
      for (int i = 0; i < smaller; i++) {
        final SNode actual = ListSequence.fromList(actuals).getElement(i);
        final SNode formal = ListSequence.fromList(formals).getElement(i);

        if (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(formal, LINKS.type$sXU3), CONCEPTS.AnnotatedType$I9)) {
          final SNode resolved = IGenericUnitMappingProvider__BehaviorDescriptor.resolveGenericUnit_id6VYXZgFJaKW.invoke(SNodeOperations.asSConcept(CONCEPTS.IGenericUnitMappingProvider$Qd), SLinkOperations.getTarget(formal, LINKS.type$sXU3), SLinkOperations.getChildren(initializer, LINKS.unitMappings$y8Iz));

          if (SNodeOperations.isInstanceOf(actual, CONCEPTS.IRequiresTypeToBeInferred$3C)) {
            {
              final SNode actualType = typeCheckingContext.typeOf(actual, "r:39d65015-9994-4ec8-bfc1-fb277098386e(com.mbeddr.ext.components.units.typesystem)", "205952376340853184", true);
              typeCheckingContext.whenConcrete(actualType, () -> {
                if (!(typeCheckingContext.isSingleTypeComputation())) {
                  {
                    SNode _nodeToCheck_1029348928467 = actual;
                    EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:39d65015-9994-4ec8-bfc1-fb277098386e(com.mbeddr.ext.components.units.typesystem)", "205952376340853161", 0, null);
                    typeCheckingContext.createLessThanInequality((SNode) typeCheckingContext.typeOf(actual, "r:39d65015-9994-4ec8-bfc1-fb277098386e(com.mbeddr.ext.components.units.typesystem)", "205952376340853163", true), (SNode) typeCheckingContext.typeOf(resolved, "r:39d65015-9994-4ec8-bfc1-fb277098386e(com.mbeddr.ext.components.units.typesystem)", "205952376340853166", true), true, true, _info_12389875345);
                  }
                }
              }, "r:39d65015-9994-4ec8-bfc1-fb277098386e(com.mbeddr.ext.components.units.typesystem)", "205952376340853156", false, false);
            }
          } else {
            {
              SNode _nodeToCheck_1029348928467 = actual;
              EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:39d65015-9994-4ec8-bfc1-fb277098386e(com.mbeddr.ext.components.units.typesystem)", "205952376340853176", 0, null);
              typeCheckingContext.createLessThanInequality((SNode) typeCheckingContext.typeOf(actual, "r:39d65015-9994-4ec8-bfc1-fb277098386e(com.mbeddr.ext.components.units.typesystem)", "205952376340853178", true), (SNode) typeCheckingContext.typeOf(resolved, "r:39d65015-9994-4ec8-bfc1-fb277098386e(com.mbeddr.ext.components.units.typesystem)", "205952376340853181", true), false, true, _info_12389875345);
            }
          }
        }
      }
    }
  }
  public SAbstractConcept getApplicableConcept() {
    return CONCEPTS.InterfaceOperationCallExpr$vv;
  }
  public IsApplicableStatus isApplicableAndPattern(SNode argument) {
    return new IsApplicableStatus(argument.getConcept().isSubConceptOf(getApplicableConcept()), null);
  }
  public boolean overrides() {
    return false;
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept IGenericUnitMappingProvider$Qd = MetaAdapterFactory.getInterfaceConcept(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x5f072ca6a2ea1f42L, "com.mbeddr.ext.units.structure.IGenericUnitMappingProvider");
    /*package*/ static final SInterfaceConcept IRequiresTypeToBeInferred$3C = MetaAdapterFactory.getInterfaceConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x479c34ecb3e934c3L, "com.mbeddr.core.expressions.structure.IRequiresTypeToBeInferred");
    /*package*/ static final SConcept AnnotatedType$I9 = MetaAdapterFactory.getConcept(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x73b48a125b0f3f14L, "com.mbeddr.ext.units.structure.AnnotatedType");
    /*package*/ static final SConcept InterfaceOperationCallExpr$vv = MetaAdapterFactory.getConcept(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x707ac195dd618205L, "com.mbeddr.ext.components.structure.InterfaceOperationCallExpr");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink type$sXU3 = MetaAdapterFactory.getContainmentLink(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x46a2a92ac61b183L, 0x46a2a92ac61b184L, "type");
    /*package*/ static final SContainmentLink unitMappings$y8Iz = MetaAdapterFactory.getContainmentLink(0xd04a6cc773e4069L, 0xb9b011884b2ff1c8L, 0x5f072ca6a2ea1f42L, 0x5d5cf2132ba5970aL, "unitMappings");
  }
}
