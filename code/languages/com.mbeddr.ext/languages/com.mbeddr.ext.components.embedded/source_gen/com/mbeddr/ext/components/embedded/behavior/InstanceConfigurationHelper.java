package com.mbeddr.ext.components.embedded.behavior;

/*Generated by MPS */

import java.util.Map;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.baseLanguage.closures.runtime.YieldingIterator;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import java.util.ArrayList;
import com.mbeddr.ext.compositecomponents.behavior.CompositeComponent__BehaviorDescriptor;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SConcept;

public class InstanceConfigurationHelper {

  public static Map<SNode, List<SNode>> getVisibleInterruptRunnableMappings(final SNode instanceConfiguration) {

    List<SNode> instanceConfigurations = Sequence.fromIterable(Sequence.fromClosure(() -> {
      return (Iterable<SNode>) () -> {
        return new YieldingIterator<SNode>() {
          private int __CP__ = 0;
          protected boolean moveToNext() {
__loop__:
            do {
__switch__:
              switch (this.__CP__) {
                case -1:
                  assert false : "Internal error";
                  return false;
                case 2:
                  this.__CP__ = 1;
                  this.yield(instanceConfiguration);
                  return true;
                case 0:
                  this.__CP__ = 2;
                  break;
                default:
                  break __loop__;
              }
            } while (true);
            return false;
          }
        };
      };
    })).toList();
    return getVisibleInterruptRunnableMappings(instanceConfigurations);
  }

  public static Map<SNode, List<SNode>> getVisibleInterruptRunnableMappings(List<SNode> instanceConfigurations) {
    final Map<SNode, List<SNode>> visibleInterruptRunnableMappings = MapSequence.fromMap(new HashMap<SNode, List<SNode>>());
    ListSequence.fromList(instanceConfigurations).visitAll((it) -> collectVisibleInterruptRunnableMappings(it, visibleInterruptRunnableMappings));
    return visibleInterruptRunnableMappings;
  }

  protected static void collectVisibleInterruptRunnableMappings(SNode instanceConfiguration, final Map<SNode, List<SNode>> visibleInterruptRunnableMappings) {

    Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.getChildren(instanceConfiguration, LINKS.contents$E4B8), CONCEPTS.InterruptRunnableMapping$6o)).visitAll((it) -> {
      List<SNode> visibleInterruptRunnableMappingsForInterrupt = MapSequence.fromMap(visibleInterruptRunnableMappings).get(SLinkOperations.getTarget(it, LINKS.interrupt$BI4l));
      if (visibleInterruptRunnableMappingsForInterrupt == null) {
        visibleInterruptRunnableMappingsForInterrupt = ListSequence.fromList(new ArrayList<SNode>());
        MapSequence.fromMap(visibleInterruptRunnableMappings).put(SLinkOperations.getTarget(it, LINKS.interrupt$BI4l), visibleInterruptRunnableMappingsForInterrupt);
      }
      ListSequence.fromList(visibleInterruptRunnableMappingsForInterrupt).addElement(it);
    });

    Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.collect(SNodeOperations.ofConcept(SLinkOperations.getChildren(instanceConfiguration, LINKS.contents$E4B8), CONCEPTS.ComponentInstance$zN), LINKS.component$ikVC), CONCEPTS.CompositeComponent$c8)).select((it) -> (SNode) CompositeComponent__BehaviorDescriptor.innerInstanceConfig_id6JVEnxIjbYq.invoke(it)).visitAll((it) -> collectVisibleInterruptRunnableMappings(it, visibleInterruptRunnableMappings));
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink contents$E4B8 = MetaAdapterFactory.getContainmentLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x6bfba9786e466b00L, 0x6bfba9786e467315L, "contents");
    /*package*/ static final SReferenceLink interrupt$BI4l = MetaAdapterFactory.getReferenceLink(0x28899e1bfee4db6L, 0xb470ed0f9ee5f662L, 0x7f4986009ab49c73L, 0x7f4986009ab49c74L, "interrupt");
    /*package*/ static final SReferenceLink component$ikVC = MetaAdapterFactory.getReferenceLink(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4de76L, 0x3e5659cd94a4de77L, "component");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept InterruptRunnableMapping$6o = MetaAdapterFactory.getConcept(0x28899e1bfee4db6L, 0xb470ed0f9ee5f662L, 0x7f4986009ab49c73L, "com.mbeddr.ext.components.embedded.structure.InterruptRunnableMapping");
    /*package*/ static final SConcept ComponentInstance$zN = MetaAdapterFactory.getConcept(0x97d2424451db4e2eL, 0x97fc7bd73b1f5f40L, 0x3e5659cd94a4de76L, "com.mbeddr.ext.components.structure.ComponentInstance");
    /*package*/ static final SConcept CompositeComponent$c8 = MetaAdapterFactory.getConcept(0x54f2a59b97bb4c09L, 0xaf92928ebf9c5966L, 0x6bfba9786e44b3b0L, "com.mbeddr.ext.compositecomponents.structure.CompositeComponent");
  }
}
