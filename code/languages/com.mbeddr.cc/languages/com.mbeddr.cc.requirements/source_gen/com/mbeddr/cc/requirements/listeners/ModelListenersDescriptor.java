package com.mbeddr.cc.requirements.listeners;

/*Generated by MPS */

import com.mbeddr.mpsutil.modellisteners.runtime.IModelListenersDescriptor;
import com.mbeddr.mpsutil.modellisteners.runtime.IModelListener;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import com.mbeddr.mpsutil.modellisteners.runtime.ChildListener;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import com.mbeddr.cc.requirements.behavior.RequirementsKind__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import javax.swing.SwingUtilities;
import jetbrains.mps.smodel.ModelAccess;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class ModelListenersDescriptor implements IModelListenersDescriptor {
  public ModelListenersDescriptor() {
  }

  public Iterable<IModelListener> getListeners() {
    List<IModelListener> listeners = ListSequence.fromList(new ArrayList<IModelListener>());

    ListSequence.fromList(listeners).addElement(new ChildListener(CONCEPTS.Requirement$sS, LINKS.kind$XKhf) {
      @Override
      public void childAdded(final SNode instance, final SNode child) {
        Iterable<SAbstractConcept> missing = RequirementsKind__BehaviorDescriptor.getMissingDataConcepts_id2WRRjDdovig.invoke(child, instance);
        for (SAbstractConcept mc : Sequence.fromIterable(missing)) {
          ListSequence.fromList(SLinkOperations.getChildren(instance, LINKS.additionalData$Mhbk)).addElement(SNodeOperations.cast(SConceptOperations.createNewNode(SNodeOperations.asInstanceConcept(mc)), CONCEPTS.RequirementsData$Fm));
        }
      }
    });
    ListSequence.fromList(listeners).addElement(new ChildListener(CONCEPTS.Requirement$sS, LINKS.kind$XKhf) {
      @Override
      public void beforeChildRemoved(final SNode instance, final SNode child) {
        final List<SAbstractConcept> requiredDataKind = RequirementsKind__BehaviorDescriptor.getRequiredDataKind_id2AZbPfMcvYE.invoke(SNodeOperations.asSConcept(SNodeOperations.getConcept(child)));
        final List<SNode> copy = ListSequence.fromListWithValues(new ArrayList<SNode>(), SLinkOperations.getChildren(instance, LINKS.additionalData$Mhbk));

        // deletion requires delayed execution because of internal MPS reasons (node anchoring)
        SwingUtilities.invokeLater(new Runnable() {
          public void run() {
            ModelAccess.instance().executeCommand(() -> ListSequence.fromList(copy).visitAll((it) -> {
              if (ListSequence.fromList(requiredDataKind).contains(SNodeOperations.getConcept(it))) {
                SNodeOperations.deleteNode(it);
              }
            }));
          }
        });

      }
    });

    return listeners;
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Requirement$sS = MetaAdapterFactory.getConcept(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x795de87bb67288a5L, "com.mbeddr.cc.requirements.structure.Requirement");
    /*package*/ static final SConcept RequirementsData$Fm = MetaAdapterFactory.getConcept(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x795de87bb677316cL, "com.mbeddr.cc.requirements.structure.RequirementsData");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink kind$XKhf = MetaAdapterFactory.getContainmentLink(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x795de87bb67288a5L, 0x7bceab23f9071900L, "kind");
    /*package*/ static final SContainmentLink additionalData$Mhbk = MetaAdapterFactory.getContainmentLink(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x795de87bb67288a5L, 0x795de87bb6776476L, "additionalData");
  }
}
