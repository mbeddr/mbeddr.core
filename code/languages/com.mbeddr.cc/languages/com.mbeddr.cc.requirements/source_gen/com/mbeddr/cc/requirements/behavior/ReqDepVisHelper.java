package com.mbeddr.cc.requirements.behavior;

/*Generated by MPS */

import java.util.Set;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import com.mbeddr.mpsutil.plantuml.node.behavior.VisGraph;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.List;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import org.jetbrains.mps.openapi.module.SRepository;
import org.jetbrains.mps.openapi.model.SReference;
import org.jetbrains.mps.openapi.module.FindUsagesFacade;
import jetbrains.mps.FilteredGlobalScope;
import jetbrains.mps.progress.EmptyProgressMonitor;
import org.jetbrains.mps.openapi.module.SearchScope;
import org.jetbrains.mps.openapi.module.SModule;
import java.util.ArrayList;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.project.Solution;
import org.jetbrains.mps.openapi.model.SModelReference;
import org.jetbrains.mps.openapi.module.SModuleReference;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SConcept;

public class ReqDepVisHelper {

  private Set<SNode> cycleDetector = SetSequence.fromSet(new HashSet<SNode>());

  public void createClass(SNode r, String color, VisGraph g) {
    String letter = RequirementsKind__BehaviorDescriptor.getVisualizationIconLetter_id5MZGKPTcRdC.invoke(SLinkOperations.getTarget(r, LINKS.kind$XKhf));
    g.add("class " + SPropertyOperations.getString(r, PROPS.name$MnvL) + "<< (" + letter + ",#DDDDDD" + ") >> #" + color + " {");
    g.add("}");
    g.add("url of " + SPropertyOperations.getString(r, PROPS.name$MnvL) + " is " + g.createLink(r));
  }

  public void visualizeDependencies(SNode r, VisGraph g) {
    g.setTitle("Dependencies for Requirement " + SPropertyOperations.getString(r, PROPS.name$MnvL));
    g.add("hide members");
    createClass(r, "F5A9B1", g);
    this.downstreamStuff(r, g, "A9F5B3");
    this.upstreamStuff(r, g, "A9AFF5");
    g.toString();
  }

  public void dependencyGraph(SNode m, String category, final VisGraph g) {
    g.setTitle("Dependencies for Requirements Module " + SPropertyOperations.getString(m, PROPS.name$MnvL));
    g.add("hide members");

    if (Sequence.fromIterable(RequirementsModule__BehaviorDescriptor.requirementsInModule_id7_tU7IQttUA.invoke(m)).isEmpty()) {
      g.setEffectivelyEmpty(true);
      return;
    }

    boolean includeHierarchy = category.toLowerCase().contains("hierarchy");
    boolean includeDependencies = category.toLowerCase().contains("dependencies");

    if (includeHierarchy) {
      for (SNode r : Sequence.fromIterable(RequirementsModule__BehaviorDescriptor.requirementsInModule_id7_tU7IQttUA.invoke(m))) {
        createClass(r, "DDDDDD", g);
      }
      for (final SNode r : Sequence.fromIterable(RequirementsModule__BehaviorDescriptor.requirementsInModule_id7_tU7IQttUA.invoke(m))) {
        ListSequence.fromList(SLinkOperations.getChildren(r, LINKS.details$fIea)).visitAll((it) -> g.add(SPropertyOperations.getString(r, PROPS.name$MnvL) + " *-- " + SPropertyOperations.getString(it, PROPS.name$MnvL)));
      }
    }
    if (includeDependencies) {
      final Set<SNode> toBeAdded = SetSequence.fromSet(new HashSet<SNode>());
      for (final SNode r : Sequence.fromIterable(RequirementsModule__BehaviorDescriptor.requirementsInModule_id7_tU7IQttUA.invoke(m))) {
        Set<SNode> downstream = SetSequence.fromSet(new HashSet<SNode>());
        Iterable<SNode> downLinks = SNodeOperations.ofConcept(SLinkOperations.getChildren(r, LINKS.additionalData$Mhbk), CONCEPTS.RequirementsLink$sO);
        List<SNode> downWords = SNodeOperations.getNodeDescendants(SLinkOperations.getTarget(r, LINKS.doc$YgF8), CONCEPTS.AbstractReqRefWord$A2, false, new SAbstractConcept[]{});
        SetSequence.fromSet(downstream).addSequence(Sequence.fromIterable(downLinks).select((it) -> SLinkOperations.getTarget(it, LINKS.target$JUeu)));
        SetSequence.fromSet(downstream).addSequence(Sequence.fromIterable(SLinkOperations.collect(downWords, LINKS.req$4nN0)));
        Sequence.fromIterable(downLinks).visitAll((it) -> g.add(SPropertyOperations.getString(r, PROPS.name$MnvL) + " -> " + SPropertyOperations.getString(SLinkOperations.getTarget(it, LINKS.target$JUeu), PROPS.name$MnvL) + ": " + SConceptOperations.conceptAlias(SNodeOperations.getConcept(it))));
        ListSequence.fromList(downWords).visitAll((it) -> g.add(SPropertyOperations.getString(r, PROPS.name$MnvL) + " ..> " + SPropertyOperations.getString(SLinkOperations.getTarget(it, LINKS.req$4nN0), PROPS.name$MnvL)));
        if (Sequence.fromIterable(downLinks).isNotEmpty() || ListSequence.fromList(downWords).isNotEmpty()) {
          SetSequence.fromSet(toBeAdded).addElement(r);
          Sequence.fromIterable(downLinks).visitAll((it) -> SetSequence.fromSet(toBeAdded).addElement(SLinkOperations.getTarget(it, LINKS.target$JUeu)));
          ListSequence.fromList(downWords).visitAll((it) -> SetSequence.fromSet(toBeAdded).addElement(SLinkOperations.getTarget(it, LINKS.req$4nN0)));
        }
      }
      if (includeHierarchy) {
        for (SNode r : Sequence.fromIterable(RequirementsModule__BehaviorDescriptor.requirementsInModule_id7_tU7IQttUA.invoke(m))) {
          createClass(r, "DDDDDD", g);
        }
      } else {
        if (SetSequence.fromSet(toBeAdded).isEmpty()) {
          g.setEffectivelyEmpty(true);
        } else {
          for (SNode r : SetSequence.fromSet(toBeAdded)) {
            createClass(r, "DDDDDD", g);
          }
        }
      }
    }

  }


  private void upstreamStuff(final SNode r, final VisGraph g, final String color) {
    Set<SNode> s = SetSequence.fromSet(new HashSet<SNode>());
    SetSequence.fromSet(s).addElement(r);

    final SRepository repo = SNodeOperations.getModel(r).getRepository();
    assert repo != null : "non-trivial logic for a detached node?";
    Set<SReference> referencesToR = FindUsagesFacade.getInstance().findUsages(new FilteredGlobalScope(repo), s, new EmptyProgressMonitor());

    Iterable<SNode> upstreamWords = SetSequence.fromSet(referencesToR).where((it) -> SNodeOperations.isInstanceOf(((SNode) it.getSourceNode()), CONCEPTS.ReqRefWord$NF)).select((it) -> ((SNode) it.getSourceNode()));
    Iterable<SNode> upstreamLinks = SetSequence.fromSet(referencesToR).where((it) -> SNodeOperations.isInstanceOf(((SNode) it.getSourceNode()), CONCEPTS.RequirementsLink$sO)).select((it) -> ((SNode) it.getSourceNode()));
    Set<SNode> upstream = SetSequence.fromSet(new HashSet<SNode>());
    SetSequence.fromSet(upstream).addSequence(Sequence.fromIterable(upstreamWords).select((it) -> SNodeOperations.getNodeAncestor(it, CONCEPTS.Requirement$sS, false, false)));
    SetSequence.fromSet(upstream).addSequence(Sequence.fromIterable(upstreamLinks).select((it) -> SNodeOperations.getNodeAncestor(it, CONCEPTS.Requirement$sS, false, false)));
    SetSequence.fromSet(upstream).visitAll((it) -> createClass(it, color, g));

    Sequence.fromIterable(upstreamWords).visitAll((it) -> g.add(SPropertyOperations.getString(SNodeOperations.getNodeAncestor(it, CONCEPTS.Requirement$sS, false, false), PROPS.name$MnvL) + " ..> " + SPropertyOperations.getString(r, PROPS.name$MnvL)));
    Sequence.fromIterable(upstreamLinks).visitAll((it) -> g.add(SPropertyOperations.getString(SNodeOperations.getNodeAncestor(it, CONCEPTS.Requirement$sS, false, false), PROPS.name$MnvL) + " --> " + SPropertyOperations.getString(r, PROPS.name$MnvL) + ": " + SConceptOperations.conceptAlias(SNodeOperations.getConcept(it))));
  }

  private void downstreamStuff(final SNode r, final VisGraph g, final String color) {
    SetSequence.fromSet(cycleDetector).addElement(r);
    Set<SNode> downstream = SetSequence.fromSet(new HashSet<SNode>());

    Iterable<SNode> downLinks = SNodeOperations.ofConcept(SLinkOperations.getChildren(r, LINKS.additionalData$Mhbk), CONCEPTS.RequirementsLink$sO);
    List<SNode> downWords = SNodeOperations.getNodeDescendants(SLinkOperations.getTarget(r, LINKS.doc$YgF8), CONCEPTS.ReqRefWord$NF, false, new SAbstractConcept[]{});

    SetSequence.fromSet(downstream).addSequence(Sequence.fromIterable(downLinks).select((it) -> SLinkOperations.getTarget(it, LINKS.target$JUeu)));
    SetSequence.fromSet(downstream).addSequence(Sequence.fromIterable(SLinkOperations.collect(downWords, LINKS.req$4nN0)));
    SetSequence.fromSet(downstream).visitAll((it) -> createClass(it, color, g));

    Sequence.fromIterable(downLinks).visitAll((it) -> g.add(SPropertyOperations.getString(r, PROPS.name$MnvL) + " --> " + SPropertyOperations.getString(SLinkOperations.getTarget(it, LINKS.target$JUeu), PROPS.name$MnvL) + ": " + SConceptOperations.conceptAlias(SNodeOperations.getConcept(it))));
    ListSequence.fromList(downWords).visitAll((it) -> g.add(SPropertyOperations.getString(r, PROPS.name$MnvL) + " ..> " + SPropertyOperations.getString(SLinkOperations.getTarget(it, LINKS.req$4nN0), PROPS.name$MnvL)));

    for (SNode dr : SetSequence.fromSet(downstream)) {
      if (!(SetSequence.fromSet(cycleDetector).contains(dr))) {
        downstreamStuff(dr, g, color);
      }
    }
  }

  public static class FilteredScope implements SearchScope {

    private SearchScope parent;

    public FilteredScope(SearchScope parent) {
      this.parent = parent;
    }

    public Iterable<SModule> getModules() {
      List<SModule> modules = ListSequence.fromList(new ArrayList<SModule>());
      ListSequence.fromList(modules).addSequence(Sequence.fromIterable(parent.getModules()));

      return ListSequence.fromList(modules).where((it) -> !(it.isPackaged()));
    }
    public Iterable<SModel> getModels() {
      Iterable<SModel> models = ((Iterable<SModel>) parent.getModels());
      return Sequence.fromIterable(models).where((it) -> {
        SModule module = it.getModule();
        return module instanceof Solution;
      });

    }
    /**
     * 
     * @deprecated 
     */
    @Deprecated
    public SModel resolve(SModelReference reference) {
      return parent.resolve(reference);
    }
    /**
     * 
     * @deprecated 
     */
    @Deprecated
    public SModule resolve(SModuleReference reference) {
      return parent.resolve(reference);
    }
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink kind$XKhf = MetaAdapterFactory.getContainmentLink(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x795de87bb67288a5L, 0x7bceab23f9071900L, "kind");
    /*package*/ static final SContainmentLink details$fIea = MetaAdapterFactory.getContainmentLink(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x795de87bb67288a5L, 0x795de87bb672b1c5L, "details");
    /*package*/ static final SContainmentLink additionalData$Mhbk = MetaAdapterFactory.getContainmentLink(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x795de87bb67288a5L, 0x795de87bb6776476L, "additionalData");
    /*package*/ static final SContainmentLink doc$YgF8 = MetaAdapterFactory.getContainmentLink(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x795de87bb67288a5L, 0x5c64b430703e7713L, "doc");
    /*package*/ static final SReferenceLink target$JUeu = MetaAdapterFactory.getReferenceLink(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x795de87bb6773163L, 0x795de87bb677316eL, "target");
    /*package*/ static final SReferenceLink req$4nN0 = MetaAdapterFactory.getReferenceLink(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x2e853dcd8e5090d1L, 0x2e853dcd8e5090d3L, "req");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept RequirementsLink$sO = MetaAdapterFactory.getConcept(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x795de87bb6773163L, "com.mbeddr.cc.requirements.structure.RequirementsLink");
    /*package*/ static final SConcept AbstractReqRefWord$A2 = MetaAdapterFactory.getConcept(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x2e853dcd8e5090d1L, "com.mbeddr.cc.requirements.structure.AbstractReqRefWord");
    /*package*/ static final SConcept ReqRefWord$NF = MetaAdapterFactory.getConcept(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x34efa7e3ac5539c3L, "com.mbeddr.cc.requirements.structure.ReqRefWord");
    /*package*/ static final SConcept Requirement$sS = MetaAdapterFactory.getConcept(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x795de87bb67288a5L, "com.mbeddr.cc.requirements.structure.Requirement");
  }
}
