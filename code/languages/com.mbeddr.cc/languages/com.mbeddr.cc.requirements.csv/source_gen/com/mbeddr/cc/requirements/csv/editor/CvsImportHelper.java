package com.mbeddr.cc.requirements.csv.editor;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import au.com.bytecode.opencsv.CSVReader;
import java.io.FileReader;
import com.mbeddr.cc.requirements.csv.behavior.IRequirementMapper__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import com.mbeddr.cc.requirements.behavior.RequirementsModule__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.regex.Pattern;
import java.util.regex.Matcher;
import jetbrains.mps.project.PathMacros;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class CvsImportHelper {
  private SNode rm;
  private String path;
  private String separator;
  private String quoter;
  private SNode mapper;
  public CvsImportHelper(SNode rm, SNode mapper, String path, String separator, String quoter) {
    this.rm = rm;
    this.path = path;
    this.mapper = mapper;
    this.separator = separator;
    this.quoter = quoter;
  }
  public String reimport() {
    try {
      CSVReader r = new CSVReader(new FileReader(handlePathMacros(path)), this.separator.charAt(0), this.quoter.charAt(0));
      String[] line;
      do {
        line = r.readNext();
        if (line != null) {
          final String id = IRequirementMapper__BehaviorDescriptor.extractID_id4uSWKme5rV5.invoke(mapper, line, ((boolean) true));
          SNode existingReq = Sequence.fromIterable(RequirementsModule__BehaviorDescriptor.requirementsInModule_id7_tU7IQttUA.invoke(rm)).findFirst((it) -> SPropertyOperations.getString(it, PROPS.name$MnvL) != null && SPropertyOperations.getString(it, PROPS.name$MnvL).equals(id));
          if (existingReq != null) {
            IRequirementMapper__BehaviorDescriptor.map_id4uSWKme5t8$.invoke(mapper, line, existingReq);
          } else {
            SNode req = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x795de87bb67288a5L, "com.mbeddr.cc.requirements.structure.Requirement"));
            IRequirementMapper__BehaviorDescriptor.map_id4uSWKme5t8$.invoke(mapper, line, req);

            SNode parentReq = IRequirementMapper__BehaviorDescriptor.getParentRequirement_id5liZiKqPIOk.invoke(mapper, rm, req, line);
            if (parentReq == null) {
              ListSequence.fromList(SLinkOperations.getChildren(rm, LINKS.requirements$sBol)).addElement(req);
            } else {
              ListSequence.fromList(SLinkOperations.getChildren(parentReq, LINKS.details$fIea)).addElement(req);
            }
          }
        }
      } while (line != null);
    } catch (FileNotFoundException fex) {
      return "ERROR: specified file does not exist";
    } catch (IOException io) {
      return "ERROR: error reading from file";
    }

    return "Successfully imported on " + new SimpleDateFormat("yyyy/MM/dd HH:mm:ss").format(new Date());
  }
  public String handlePathMacros(String path) {
    Pattern p = Pattern.compile("\\$\\{(\\w|\\.)*\\}");
    Matcher m = p.matcher(path);
    String result = path;
    while (m.find()) {
      String match = m.group();
      if (match.length() > 2) {
        String property = match.substring(2, match.length() - 1);
        String value = PathMacros.getInstance().getValue(property);
        if (value != null && value.length() > 0) {
          result = result.replace(match, value);
        }
      }
    }
    return result;
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink requirements$sBol = MetaAdapterFactory.getContainmentLink(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x795de87bb672b3e1L, 0x795de87bb672b3e3L, "requirements");
    /*package*/ static final SContainmentLink details$fIea = MetaAdapterFactory.getContainmentLink(0xe865cad27cc8437aL, 0x951a665bcbcb8b1aL, 0x795de87bb67288a5L, 0x795de87bb672b1c5L, "details");
  }
}
