package com.mbeddr.cc.var.composition.generator.util;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import com.mbeddr.cc.var.composition.behavior.CompositionResult;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import com.mbeddr.cc.var.composition.behavior.MatchStrategy__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import com.mbeddr.cc.var.composition.behavior.CompositionContext;
import com.mbeddr.cc.var.composition.behavior.CompositionStrategy__BehaviorDescriptor;
import com.mbeddr.cc.var.composition.behavior.CompositionResultFail;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SConcept;

public class Composer {

  private SNode configItem;

  public Composer(SNode configItem) {
    this.configItem = configItem;
  }

  public Iterable<CompositionResult> run() {
    List<CompositionResult> results = ListSequence.fromList(new ArrayList<CompositionResult>());
    for (SNode cc : ListSequence.fromList(SLinkOperations.getChildren(configItem, LINKS.compositionChunks$YI1c))) {
      for (SNode matcher : ListSequence.fromList(SNodeOperations.getNodeDescendants(SLinkOperations.getTarget(cc, LINKS.chunk$RqGd), CONCEPTS.MatchAnnotation$m7, true, new SAbstractConcept[]{}))) {
        SNode matchNode = SNodeOperations.getParent(matcher);
        Iterable<SNode> targets = MatchStrategy__BehaviorDescriptor.matchedTargets_id3YyHFqO6HoC.invoke(SLinkOperations.getTarget(matcher, LINKS.matchStrategy$YiF6), SNodeOperations.getModel(matchNode));
        for (SNode target : Sequence.fromIterable(targets)) {
          if ((new IAttributeDescriptor.NodeAttribute(CONCEPTS.ComposeOnlyAnnotation$6d).get(SNodeOperations.cast(SNodeOperations.getContainingRoot(target), CONCEPTS.Chunk$sT)) != null)) {
            continue;
          }
          CompositionContext context = new CompositionContext();
          context.setTargetNode(target);
          target.putUserObject("__ctx", context);
          ListSequence.fromList(results).addElement(CompositionStrategy__BehaviorDescriptor.compose_id3YyHFqO7EVE.invoke(SLinkOperations.getTarget(matcher, LINKS.compositionStrategy$7ug9), target, matchNode, context));
        }
      }
    }
    return flattenResults(results);
  }

  private List<CompositionResult> flattenResults(List<CompositionResult> results) {
    final List<CompositionResult> flattened = ListSequence.fromList(new ArrayList<CompositionResult>());
    ListSequence.fromList(results).visitAll((it) -> flattenHelper(it, flattened));
    return flattened;
  }

  private void flattenHelper(CompositionResult r, final List<CompositionResult> flattened) {
    ListSequence.fromList(flattened).addElement(r);
    if (r instanceof CompositionResultFail) {
      ListSequence.fromList(as_v3dsww_a0a0a0a1a9(r, CompositionResultFail.class).getSubResults()).visitAll((it) -> flattenHelper(it, flattened));
    }
  }

  private static <T> T as_v3dsww_a0a0a0a1a9(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink matchStrategy$YiF6 = MetaAdapterFactory.getContainmentLink(0x21ac77a41b6644c5L, 0xaaec94e43bb86519L, 0x3fa2b6b6b4161e8bL, 0x3fa2b6b6b4161efeL, "matchStrategy");
    /*package*/ static final SContainmentLink compositionStrategy$7ug9 = MetaAdapterFactory.getContainmentLink(0x21ac77a41b6644c5L, 0xaaec94e43bb86519L, 0x3fa2b6b6b4161e8bL, 0x3fa2b6b6b41955a4L, "compositionStrategy");
    /*package*/ static final SReferenceLink chunk$RqGd = MetaAdapterFactory.getReferenceLink(0x21ac77a41b6644c5L, 0xaaec94e43bb86519L, 0x3fa2b6b6b404fd2dL, 0x3fa2b6b6b404fd2eL, "chunk");
    /*package*/ static final SContainmentLink compositionChunks$YI1c = MetaAdapterFactory.getContainmentLink(0x21ac77a41b6644c5L, 0xaaec94e43bb86519L, 0x3fa2b6b6b4011bc2L, 0x3fa2b6b6b4049eecL, "compositionChunks");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept ComposeOnlyAnnotation$6d = MetaAdapterFactory.getConcept(0x21ac77a41b6644c5L, 0xaaec94e43bb86519L, 0x3fa2b6b6b40447eeL, "com.mbeddr.cc.var.composition.structure.ComposeOnlyAnnotation");
    /*package*/ static final SConcept Chunk$sT = MetaAdapterFactory.getConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x6315bcc6effb4ea6L, "com.mbeddr.core.base.structure.Chunk");
    /*package*/ static final SConcept MatchAnnotation$m7 = MetaAdapterFactory.getConcept(0x21ac77a41b6644c5L, 0xaaec94e43bb86519L, 0x3fa2b6b6b4161e8bL, "com.mbeddr.cc.var.composition.structure.MatchAnnotation");
  }
}
