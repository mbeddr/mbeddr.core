package com.mbeddr.doc.plugin;

/*Generated by MPS */

import org.jetbrains.annotations.Nullable;
import java.io.File;
import jetbrains.mps.project.AbstractModule;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.util.MacroHelper;
import jetbrains.mps.util.MacrosFactory;
import jetbrains.mps.project.structure.modules.ModuleDescriptor;
import jetbrains.mps.project.ProjectPathUtil;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.text.TextUnit;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;

public class GenerationHelper {

  @Nullable
  public static File getOutputLocation(AbstractModule m, SModel model) {
    File docGenRoot = getDocGenFolder(m);
    if (docGenRoot == null) {
      return null;
    }
    File mdlOutputRootInGenFolder = new File(docGenRoot, model.getReference().getName().getLongName().replace(".", "/"));
    return mdlOutputRootInGenFolder;
  }

  @Nullable
  public static File getOutputLocation(AbstractModule m, SNode node) {
    File docGenRoot = getDocGenFolder(m);
    if (docGenRoot == null) {
      return null;
    }
    File mdlOutputRootInGenFolder = new File(docGenRoot, getNodeRelativeLocation(node));
    return mdlOutputRootInGenFolder;
  }

  public static String getGeneratorOutputPath(AbstractModule module) {
    MacroHelper macroHelper = MacrosFactory.forModule(module);
    ModuleDescriptor md = module.getModuleDescriptor();
    if (md == null) {
      return null;
    }
    if (md.getOutputRoot() != null) {
      return macroHelper.expandPath(md.getOutputRoot());
    }
    final String p = ProjectPathUtil._getGeneratorOutputPathPrim(md);
    return (p == null ? null : macroHelper.expandPath(p));

  }

  @Nullable
  public static File getResourceOutputLocation(AbstractModule m, SNode resource) {
    File docGenFolder = getDocGenFolder(m);
    if (docGenFolder == null) {
      return null;
    }
    File imgFile = new File(SPropertyOperations.getString(SLinkOperations.getTarget(SLinkOperations.getTarget(resource, LINKS.path$6g6j), LINKS.pathPicker$QPZE), PROPS.path$VaYg), SPropertyOperations.getString(resource, PROPS.fileName$6fRi));
    return new File(docGenFolder, imgFile.toString());
  }

  @Nullable
  public static File getDocGenFolder(AbstractModule m) {
    String generatorOutputPath = getGeneratorOutputPath(m);
    if (generatorOutputPath == null) {
      return null;
    }
    File outputRoot = new File(generatorOutputPath);
    File docGenRoot = new File(outputRoot.getParentFile(), "doc_gen");
    return docGenRoot;
  }

  private static String getNodeRelativeLocation(SNode node) {
    String location = SNodeOperations.getModel(node).getReference().getName().getLongName();
    if (isNotEmptyString(SPropertyOperations.getString(node, PROPS.virtualPackage$EkXl))) {
      location = location + "/" + SPropertyOperations.getString(node, PROPS.virtualPackage$EkXl);
    }
    return location.replace(".", "/");
  }

  public static String getToFileName(TextUnit unit) {
    SNode startNode = unit.getStartNode();
    if ((new IAttributeDescriptor.NodeAttribute(CONCEPTS.TemporaryFileName$fd).get(startNode) == null)) {
      return unit.getFileName();
    } else {
      return SPropertyOperations.getString(SNodeOperations.cast(startNode, CONCEPTS.INamedConcept$Kd), PROPS.name$MnvL).concat(getExtensionWithDot(unit.getFileName()));
    }
  }

  public static String getExtensionWithDot(String fileName) {
    int index = fileName.lastIndexOf('.');
    if (index >= 0) {
      if (fileName.indexOf('/', index) >= 0) {
        index = -1;
      }
    }
    return (index == -1 ? "" : fileName.substring(index));
  }

  private static boolean isNotEmptyString(String str) {
    return str != null && str.length() > 0;
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink path$6g6j = MetaAdapterFactory.getReferenceLink(0x2374bc907e3741f1L, 0xa9c4c2e35194c36aL, 0x58a16bfbe08f3ebfL, 0x58a16bfbe08f3ec1L, "path");
    /*package*/ static final SContainmentLink pathPicker$QPZE = MetaAdapterFactory.getContainmentLink(0x2374bc907e3741f1L, 0xa9c4c2e35194c36aL, 0x58a16bfbe08e80dbL, 0x24acfda72d7b4682L, "pathPicker");
  }

  private static final class PROPS {
    /*package*/ static final SProperty path$VaYg = MetaAdapterFactory.getProperty(0xd3a0fd26445a466cL, 0x900e10444ddfed52L, 0x55705e73a6773808L, 0x55705e73a6774a6eL, "path");
    /*package*/ static final SProperty fileName$6fRi = MetaAdapterFactory.getProperty(0x2374bc907e3741f1L, 0xa9c4c2e35194c36aL, 0x58a16bfbe08f3ebfL, 0x58a16bfbe08f3ec0L, "fileName");
    /*package*/ static final SProperty virtualPackage$EkXl = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x10802efe25aL, 0x115eca8579fL, "virtualPackage");
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept TemporaryFileName$fd = MetaAdapterFactory.getConcept(0x2374bc907e3741f1L, 0xa9c4c2e35194c36aL, 0x4efe4cec6dcd3b99L, "com.mbeddr.doc.structure.TemporaryFileName");
    /*package*/ static final SInterfaceConcept INamedConcept$Kd = MetaAdapterFactory.getInterfaceConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, "jetbrains.mps.lang.core.structure.INamedConcept");
  }
}
