package com.mbeddr.doc.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.internal.make.runtime.util.DeltaKey;
import java.io.IOException;
import java.io.File;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import com.mbeddr.core.base.pluginSolution.plugin.CellEditorScreenshooter;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SProperty;

public class MakeScreenshotRunnable implements Runnable {
  public static final String myFileFormat = "png";

  private boolean myExecuted;
  public final SNode myNode;
  public final SNode myOriginalNode;
  private String myName;
  private Iterable<String> myHints;
  private SRepository myRepository;
  private Throwable myError = null;
  private boolean myRenderInspector = false;

  private final DeltaKey myDeltaKey;

  public MakeScreenshotRunnable(SNode node, SNode originalNode, String name, SRepository repository, DeltaKey dkey, Iterable<String> hints) {
    this(node, originalNode, name, repository, dkey, hints, false);
  }

  public MakeScreenshotRunnable(SNode node, SNode originalNode, String name, SRepository repository, DeltaKey dkey, Iterable<String> hints, boolean renderInspector) {
    myNode = node;
    myOriginalNode = originalNode;
    myName = name;
    myHints = hints;
    myRepository = repository;
    myDeltaKey = dkey;
    myRenderInspector = renderInspector;
  }

  public DeltaKey getDeltaKey() {
    return myDeltaKey;
  }

  public void run() {
    try {
      takeScreenShot();
    } catch (Throwable t) {
      myError = t;
    } finally {
      synchronized (this) {
        myExecuted = true;
        notifyAll();
      }
    }
  }

  public boolean waitForExecution() {
    try {
      synchronized (this) {
        while (!(myExecuted)) {
          wait();
        }
      }
    } catch (InterruptedException e) {
      myError = e;
    }
    return myError == null;
  }

  public Throwable getError() {
    return myError;
  }

  private void takeScreenShot() throws IOException {
    File defaultImages = new File(SPropertyOperations.getString(new IAttributeDescriptor.NodeAttribute(CONCEPTS.PlaceInFolder$Xz).get(myNode), PROPS.location$9iBH));
    defaultImages.mkdirs();
    String filename = myName + "." + myFileFormat;
    File imagefile = new File(defaultImages, filename);

    CellEditorScreenshooter.ScreenshotOptions options = new CellEditorScreenshooter.ScreenshotOptions();
    options.hints = Sequence.fromIterable(myHints).toGenericArray(String.class);
    options.renderInspector = myRenderInspector;

    CellEditorScreenshooter.takeScreenshotSynchronously(myRepository, myOriginalNode, imagefile.getAbsolutePath(), options);
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept PlaceInFolder$Xz = MetaAdapterFactory.getConcept(0x2374bc907e3741f1L, 0xa9c4c2e35194c36aL, 0x231350fa086ffc77L, "com.mbeddr.doc.structure.PlaceInFolder");
  }

  private static final class PROPS {
    /*package*/ static final SProperty location$9iBH = MetaAdapterFactory.getProperty(0x2374bc907e3741f1L, 0xa9c4c2e35194c36aL, 0x231350fa086ffc77L, 0x231350fa086ffc7eL, "location");
  }
}
