package com.mbeddr.doc.pluginSolution.plugin;

/*Generated by MPS */

import javax.swing.JPanel;
import jetbrains.mps.project.Project;
import javax.swing.JComboBox;
import javax.swing.JTable;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;
import java.awt.BorderLayout;
import javax.swing.JScrollPane;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import javax.swing.DefaultComboBoxModel;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.project.Solution;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.mbeddr.doc.behavior.IWordInViewer__BehaviorDescriptor;
import jetbrains.mps.smodel.language.LanguageRegistry;
import org.jetbrains.mps.openapi.language.SLanguage;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.openapi.navigation.EditorNavigator;
import jetbrains.mps.smodel.SNodePointer;
import java.util.Objects;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class WordsViewer extends JPanel {
  private final Project project;
  private final JComboBox<Entry> wordChooser;
  private final JTable resultTable;

  public WordsViewer(Project proj) {
    this.project = proj;
    this.resultTable = new JTable();

    wordChooser = new JComboBox<Entry>();
    loadWords();
    wordChooser.addActionListener(new ActionListener() {
      public void actionPerformed(ActionEvent event) {
        search(getChosenWord());
      }
    });

    this.setLayout(new BorderLayout());
    this.add(wordChooser, BorderLayout.PAGE_START);

    JScrollPane resultScroller = new JScrollPane(resultTable, JScrollPane.VERTICAL_SCROLLBAR_ALWAYS, JScrollPane.HORIZONTAL_SCROLLBAR_AS_NEEDED);
    this.add(resultScroller, BorderLayout.CENTER);
    resultTable.addMouseListener(new MouseAdapter() {
      @Override
      public void mouseClicked(MouseEvent event) {
        if (event.getClickCount() == 2) {
          openSelectionInEditor();
        }
      }
    });
    this.setVisible(true);

  }

  public void loadWords() {
    wordChooser.setModel(new DefaultComboBoxModel<Entry>(Sequence.fromIterable(findConcepts()).select((it) -> new Entry(it)).sort((it) -> it.toString(), true).toGenericArray(Entry.class)));
  }

  public SAbstractConcept getChosenWord() {
    Entry selectedItem = (Entry) wordChooser.getSelectedItem();
    return (selectedItem != null ? selectedItem.concept : CONCEPTS.IWordInViewer$1z);
  }

  private void search(final SAbstractConcept chosenWord) {
    final List<SearchResult> result = ListSequence.fromList(new ArrayList<SearchResult>());
    project.getRepository().getModelAccess().runReadAction(new Runnable() {
      public void run() {
        for (Solution mdule : ListSequence.fromList(project.getProjectModules(Solution.class))) {
          for (SModel mdl : mdule.getModels()) {
            for (SNode iwiv : SModelOperations.nodes(mdl, SNodeOperations.asSConcept(chosenWord))) {
              ListSequence.fromList(result).addElement(new SearchResult(mdl, SNodeOperations.getPointer(iwiv), IWordInViewer__BehaviorDescriptor.TagInViewer_idl3$K9zS58p.invoke(iwiv), IWordInViewer__BehaviorDescriptor.TextInViewer_idl3$K9zS66z.invoke(iwiv), SModelOperations.getModelName(mdl)));
            }
          }
        }
      }
    });
    setTableModel(new ResultTableModel(result));

  }

  public void setTableModel(ResultTableModel tm) {
    resultTable.setModel(tm);
    resultTable.getColumnModel().getColumn(0).setMinWidth(100);
    resultTable.getColumnModel().getColumn(1).setMinWidth(300);
    resultTable.getColumnModel().getColumn(2).setMinWidth(300);
    resultTable.setAutoResizeMode(JTable.AUTO_RESIZE_ALL_COLUMNS);
    resultTable.setAutoCreateRowSorter(true);
    resultTable.invalidate();
  }


  private Iterable<SAbstractConcept> findConcepts() {
    LanguageRegistry languageRegistry = LanguageRegistry.getInstance(project.getRepository());
    Iterable<SLanguage> languages = languageRegistry.getAllLanguages();
    Iterable<SAbstractConcept> concepts = Sequence.fromIterable(languages).translate((it) -> it.getConcepts());
    Iterable<SAbstractConcept> subconcepts = Sequence.fromIterable(concepts).where((it) -> it.isSubConceptOf(CONCEPTS.IWordInViewer$1z));
    return Sequence.fromIterable(subconcepts).select((it) -> SNodeOperations.castConcept(it, CONCEPTS.IWordInViewer$1z));
  }

  private void openSelectionInEditor() {
    int selIdx = resultTable.getSelectedRow();
    if (selIdx >= 0) {
      ResultTableModel resultTM = ((ResultTableModel) resultTable.getModel());
      SNodeReference nodePointer = resultTM.getNodePointer(selIdx);
      SModel m = resultTM.getModelAt(selIdx);
      new EditorNavigator(project).shallFocus(true).shallSelect(true).open(new SNodePointer(SModelOperations.getPointer(m), nodePointer.getNodeId()));
    }
  }

  public static class Entry {
    private SAbstractConcept concept;

    public Entry(SAbstractConcept concept) {
      this.concept = concept;
    }

    @Override
    public String toString() {
      if (Objects.equals(concept, CONCEPTS.IWordInViewer$1z)) {
        return "ALL";
      }
      String alias = concept.getConceptAlias();
      return (alias != null ? alias : concept.getName());
    }

  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept IWordInViewer$1z = MetaAdapterFactory.getInterfaceConcept(0x2374bc907e3741f1L, 0xa9c4c2e35194c36aL, 0x543930263d398c5L, "com.mbeddr.doc.structure.IWordInViewer");
  }
}
