package com.mbeddr.spreadsheat.generator.template.main;

/*Generated by MPS */

import jetbrains.mps.generator.runtime.Generated;
import jetbrains.mps.generator.impl.query.QueryProviderBase;
import jetbrains.mps.generator.template.MappingScriptContext;
import java.util.Map;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import org.apache.poi.ss.usermodel.CellStyle;
import com.mbeddr.spreadsheet.behavior.Workbook__BehaviorDescriptor;
import org.apache.poi.xssf.usermodel.XSSFCellStyle;
import com.mbeddr.spreadsheet.behavior.Style__BehaviorDescriptor;
import org.apache.poi.xssf.usermodel.XSSFColor;
import com.mbeddr.spreadsheat.generator.main.util.ColorHelper;
import org.apache.poi.ss.usermodel.FillPatternType;
import org.apache.poi.ss.usermodel.BorderStyle;
import com.mbeddr.spreadsheat.generator.main.util.BorderHelper;
import com.mbeddr.spreadsheat.generator.main.util.AlignmentHelper;
import org.apache.poi.xssf.usermodel.XSSFFont;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.util.WorkbookUtil;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Cell;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.mbeddr.spreadsheet.behavior.TextCell__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SEnumOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.apache.poi.ss.util.CellRangeAddress;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.vfs.IFile;
import java.io.File;
import java.io.FileOutputStream;
import jetbrains.mps.generator.impl.query.ScriptCodeBlock;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.generator.impl.query.QueryKey;
import jetbrains.mps.generator.impl.GenerationFailureException;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SConcept;

@Generated
public class QueriesGenerated extends QueryProviderBase {
  public QueriesGenerated() {
    super(1);
  }
  public static void mappingScript_CodeBlock_1(final MappingScriptContext _context) {
    Map<String, XSSFWorkbook> excelWorkbooks = MapSequence.fromMap(new HashMap<String, XSSFWorkbook>());

    for (SNode workbook : ListSequence.fromList(SModelOperations.roots(_context.getModel(), CONCEPTS.Workbook$uR))) {
      XSSFWorkbook excelWorkbook = new XSSFWorkbook();
      MapSequence.fromMap(excelWorkbooks).put(SPropertyOperations.getString(workbook, PROPS.name$MnvL), excelWorkbook);

      Map<String, CellStyle> styles = MapSequence.fromMap(new HashMap<String, CellStyle>());
      for (SNode style : ListSequence.fromList(Workbook__BehaviorDescriptor.allStyles_id1LnB5xdKrHB.invoke(workbook))) {
        XSSFCellStyle cellStyle = excelWorkbook.createCellStyle();
        if ((Style__BehaviorDescriptor.bgColor_id1LnB5xdJeh1.invoke(style) != null)) {
          cellStyle.setFillForegroundColor(new XSSFColor(ColorHelper.handleFontColor(Style__BehaviorDescriptor.bgColor_id1LnB5xdJeh1.invoke(style)), null));
          cellStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND);
        }

        BorderStyle border = BorderHelper.borderFor((int) Style__BehaviorDescriptor.border_id1LnB5xdJeno.invoke(style));

        cellStyle.setBorderLeft(border);
        cellStyle.setBorderRight(border);
        cellStyle.setBorderTop(border);
        cellStyle.setBorderBottom(BorderHelper.borderFor((int) Style__BehaviorDescriptor.bottomBorder_id1LnB5xdJenF.invoke(style)));
        cellStyle.setAlignment(AlignmentHelper.alignmentFor((int) Style__BehaviorDescriptor.alignment_id1LnB5xdJerp.invoke(style)));

        XSSFFont font = excelWorkbook.createFont();
        if (isNotEmptyString(Style__BehaviorDescriptor.font_id1LnB5xdJes9.invoke(style))) {
          font.setFontName(Style__BehaviorDescriptor.font_id1LnB5xdJes9.invoke(style));
        }
        if ((int) Style__BehaviorDescriptor.fontSize_id7FELQjI3HCs.invoke(style) > 0) {
          font.setFontHeightInPoints(((short) (int) Style__BehaviorDescriptor.fontSize_id7FELQjI3HCs.invoke(style)));
        }
        font.setBold((boolean) Style__BehaviorDescriptor.bold_id1LnB5xdJegr.invoke(style));
        font.setItalic((boolean) Style__BehaviorDescriptor.italic_id1LnB5xdJegB.invoke(style));
        if ((Style__BehaviorDescriptor.fontColor_id1LnB5xdJehe.invoke(style) != null)) {
          XSSFColor color = new XSSFColor(ColorHelper.handleFontColor(Style__BehaviorDescriptor.fontColor_id1LnB5xdJehe.invoke(style)), null);
          font.setColor(color);
        }
        cellStyle.setFont(font);
        MapSequence.fromMap(styles).put(SPropertyOperations.getString(style, PROPS.name$MnvL), cellStyle);
      }

      for (SNode sheet : ListSequence.fromList(SLinkOperations.getChildren(workbook, LINKS.sheets$zamX))) {
        Sheet excelSheet = excelWorkbook.createSheet(WorkbookUtil.createSafeSheetName(SPropertyOperations.getString(sheet, PROPS.name$MnvL)));
        int rowcounter = 0;
        int maxColCount = 0;
        for (SNode row : ListSequence.fromList(SLinkOperations.getChildren(sheet, LINKS.rows$zoQ3))) {
          Row excelRow = excelSheet.createRow(rowcounter);
          int cellcounter = 0;
          for (SNode cell : ListSequence.fromList(SLinkOperations.getChildren(row, LINKS.cells$zCRu))) {
            Cell excelCell = excelRow.createCell(cellcounter);
            if ((SLinkOperations.getTarget(cell, LINKS.style$R99W) != null)) {
              excelCell.setCellStyle(MapSequence.fromMap(styles).get(SPropertyOperations.getString(SLinkOperations.getTarget(cell, LINKS.style$R99W), PROPS.name$MnvL)));
            }
            if (SNodeOperations.isInstanceOf(cell, CONCEPTS.TextCell$C0)) {
              SNode textcell = SNodeOperations.cast(cell, CONCEPTS.TextCell$C0);
              if (TextCell__BehaviorDescriptor.getCellType_id1LnB5xdvClY.invoke(textcell) == SEnumOperations.getMember(MetaAdapterFactory.getEnumeration(0x1d891f7bdc9342f9L, 0xa4bcb016656b14e2L, 0x1c579c584d7e852eL, "com.mbeddr.spreadsheet.structure.TextCellType"), 0x1c579c584d7e8531L, "STRING")) {
                excelCell.setCellValue(SPropertyOperations.getString(textcell, PROPS.value$zLwC));
              }
              if (TextCell__BehaviorDescriptor.getCellType_id1LnB5xdvClY.invoke(textcell) == SEnumOperations.getMember(MetaAdapterFactory.getEnumeration(0x1d891f7bdc9342f9L, 0xa4bcb016656b14e2L, 0x1c579c584d7e852eL, "com.mbeddr.spreadsheet.structure.TextCellType"), 0x1c579c584d7e8530L, "NUMBER")) {
                excelCell.setCellValue(Double.parseDouble(SPropertyOperations.getString(textcell, PROPS.value$zLwC)));
              }
              if (TextCell__BehaviorDescriptor.getCellType_id1LnB5xdvClY.invoke(textcell) == SEnumOperations.getMember(MetaAdapterFactory.getEnumeration(0x1d891f7bdc9342f9L, 0xa4bcb016656b14e2L, 0x1c579c584d7e852eL, "com.mbeddr.spreadsheet.structure.TextCellType"), 0x1c579c584d7e852fL, "BOOLEAN")) {
                excelCell.setCellValue(Boolean.getBoolean(SPropertyOperations.getString(textcell, PROPS.value$zLwC)));
              }
            }
            if (cellcounter > maxColCount) {
              maxColCount = cellcounter;
            }
            cellcounter++;
          }
          rowcounter++;
        }

        for (SNode group : ListSequence.fromList(SLinkOperations.getChildren(sheet, LINKS.groups$R5ql))) {
          if (SNodeOperations.isInstanceOf(group, CONCEPTS.ColumnGroup$Tj)) {
            excelSheet.groupColumn(SPropertyOperations.getInteger(group, PROPS.start$R5Z6) - 1, SPropertyOperations.getInteger(group, PROPS.end$R6e7) - 1);
          } else {
            excelSheet.groupRow(SPropertyOperations.getInteger(group, PROPS.start$R5Z6) - 1, SPropertyOperations.getInteger(group, PROPS.end$R6e7) - 1);
          }
        }

        if (SPropertyOperations.getBoolean(sheet, PROPS.showFilterInFirstRow$pMNr)) {
          excelSheet.setAutoFilter(new CellRangeAddress(0, ListSequence.fromList(SLinkOperations.getChildren(sheet, LINKS.rows$zoQ3)).count() - 1, 0, maxColCount));
        }

        for (int i = 0; i < maxColCount; i++) {
          excelSheet.autoSizeColumn(i);
        }
      }
    }

    // Stash Excel workbooks generated from underlying model as session object
    _context.putSessionObject(_context.getOriginalInputModel(), excelWorkbooks);
  }
  public static void mappingScript_CodeBlock_2(final MappingScriptContext _context) {
    SModel originalInputModel = _context.getOriginalInputModel();

    // Unstash Excel workbooks to serialize from session objects
    Map<String, XSSFWorkbook> excelWorkbooks = ((Map<String, XSSFWorkbook>) _context.getSessionObject(originalInputModel));
    if (excelWorkbooks == null) {
      return;
    }

    // Compute output directory
    IFile outputLocation = jetbrains.mps.smodel.SModelOperations.getOutputLocation(originalInputModel);
    if (outputLocation == null) {
      throw new RuntimeException("Output location for " + originalInputModel.getName().getLongName() + " model not found");
    }
    File outputDir = new File(outputLocation.getPath(), originalInputModel.getName().getLongName().replace('.', File.separatorChar));

    // Serialize every Excel workbook generated from underlying model
    for (String workbookName : MapSequence.fromMap(excelWorkbooks).keySet()) {
      XSSFWorkbook excelWorkbook = MapSequence.fromMap(excelWorkbooks).get(workbookName);

      File workbookFile = new File(outputDir, workbookName + ".xlsx");
      try {
        outputDir.mkdirs();
        FileOutputStream workbookOutputStream = new FileOutputStream(workbookFile);
        excelWorkbook.write(workbookOutputStream);
        workbookOutputStream.close();
      } catch (Exception ex) {
        _context.showErrorMessage(null, "Failed to save generated Excel workbook file '" + workbookFile.getPath() + "': " + ex.getMessage());
      }
    }
  }
  private final Map<String, ScriptCodeBlock> mscbMethods = new HashMap<String, ScriptCodeBlock>();
  {
    int i = 0;
    mscbMethods.put("2042272859106851345", new SCB(i++));
    mscbMethods.put("7393618274224533622", new SCB(i++));
  }
  @Override
  @NotNull
  public ScriptCodeBlock getScriptCodeBlock(@NotNull QueryKey identity) {
    ScriptCodeBlock query = identity.forTemplateNode(mscbMethods);
    return (query != null ? query : super.getScriptCodeBlock(identity));
  }
  private static class SCB implements ScriptCodeBlock {
    private final int methodKey;
    public SCB(int methodKey) {
      this.methodKey = methodKey;
    }
    @Override
    public void invoke(MappingScriptContext ctx) throws GenerationFailureException {
      switch (methodKey) {
        case 0:
          QueriesGenerated.mappingScript_CodeBlock_1(ctx);
          return;
        case 1:
          QueriesGenerated.mappingScript_CodeBlock_2(ctx);
          return;
        default:
          throw new GenerationFailureException(String.format("There's no code block with method index %d ", methodKey));
      }
    }
  }
  private static boolean isNotEmptyString(String str) {
    return str != null && str.length() > 0;
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
    /*package*/ static final SProperty value$zLwC = MetaAdapterFactory.getProperty(0x1d891f7bdc9342f9L, 0xa4bcb016656b14e2L, 0x1c579c584d7b9a60L, 0x1c579c584d7b9a6eL, "value");
    /*package*/ static final SProperty start$R5Z6 = MetaAdapterFactory.getProperty(0x1d891f7bdc9342f9L, 0xa4bcb016656b14e2L, 0x1c579c584d7e8624L, 0x1c579c584d7e8625L, "start");
    /*package*/ static final SProperty end$R6e7 = MetaAdapterFactory.getProperty(0x1d891f7bdc9342f9L, 0xa4bcb016656b14e2L, 0x1c579c584d7e8624L, 0x1c579c584d7e8626L, "end");
    /*package*/ static final SProperty showFilterInFirstRow$pMNr = MetaAdapterFactory.getProperty(0x1d891f7bdc9342f9L, 0xa4bcb016656b14e2L, 0x1c579c584d7b9a34L, 0x7aeac764ee08de78L, "showFilterInFirstRow");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink style$R99W = MetaAdapterFactory.getReferenceLink(0x1d891f7bdc9342f9L, 0xa4bcb016656b14e2L, 0x1c579c584d7c39d2L, 0x1c579c584d87735cL, "style");
    /*package*/ static final SContainmentLink cells$zCRu = MetaAdapterFactory.getContainmentLink(0x1d891f7bdc9342f9L, 0xa4bcb016656b14e2L, 0x1c579c584d7b9a47L, 0x1c579c584d7b9a61L, "cells");
    /*package*/ static final SContainmentLink rows$zoQ3 = MetaAdapterFactory.getContainmentLink(0x1d891f7bdc9342f9L, 0xa4bcb016656b14e2L, 0x1c579c584d7b9a34L, 0x1c579c584d7b9a48L, "rows");
    /*package*/ static final SContainmentLink groups$R5ql = MetaAdapterFactory.getContainmentLink(0x1d891f7bdc9342f9L, 0xa4bcb016656b14e2L, 0x1c579c584d7b9a34L, 0x1c579c584d7e8639L, "groups");
    /*package*/ static final SContainmentLink sheets$zamX = MetaAdapterFactory.getContainmentLink(0x1d891f7bdc9342f9L, 0xa4bcb016656b14e2L, 0x1c579c584d7b9a32L, 0x1c579c584d7b9a35L, "sheets");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept TextCell$C0 = MetaAdapterFactory.getConcept(0x1d891f7bdc9342f9L, 0xa4bcb016656b14e2L, 0x1c579c584d7b9a60L, "com.mbeddr.spreadsheet.structure.TextCell");
    /*package*/ static final SConcept ColumnGroup$Tj = MetaAdapterFactory.getConcept(0x1d891f7bdc9342f9L, 0xa4bcb016656b14e2L, 0x1c579c584d7e8636L, "com.mbeddr.spreadsheet.structure.ColumnGroup");
    /*package*/ static final SConcept Workbook$uR = MetaAdapterFactory.getConcept(0x1d891f7bdc9342f9L, 0xa4bcb016656b14e2L, 0x1c579c584d7b9a32L, "com.mbeddr.spreadsheet.structure.Workbook");
  }
}
