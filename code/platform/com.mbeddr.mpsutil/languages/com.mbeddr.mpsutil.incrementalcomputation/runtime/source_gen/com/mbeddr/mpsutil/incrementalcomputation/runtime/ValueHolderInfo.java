package com.mbeddr.mpsutil.incrementalcomputation.runtime;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.LinkedHashMap;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.IMapping;

public class ValueHolderInfo {

  public static final String USER_OBJECT_ID = "PARTICIPANT_INFO";

  private final SNode _valueHolder;

  private final Map<Object, ValueCache> _propagatedValueMap = MapSequence.fromMap(new LinkedHashMap<Object, ValueCache>(16, (float) 0.75, false));

  public ValueHolderInfo(SNode node) {
    _valueHolder = node;
  }

  public SNode getValueHolder() {
    return _valueHolder;
  }

  public Iterable<Tuples._2<Object, Iterable<SNode>>> getAllCycles() {
    return MapSequence.fromMap(_propagatedValueMap).where((it) -> it.value().hasCycle()).select((it) -> MultiTuple.<Object,Iterable<SNode>>from(it.key(), it.value().getCycle()));
  }

  public boolean hasCycle(Object valueSelector) {
    return getValueCache(valueSelector).hasCycle();
  }

  public Object getValue(Object valueSelector) {
    return getValueCache(valueSelector).getValue();
  }

  public void invalidate(Object valueSelector, EChangeEffectKind changeEffectKind, List<ValueHolderInfo> visitedParticipants) {
    getValueCache(valueSelector).invalidate(changeEffectKind, visitedParticipants);
  }

  public void addPropagationTarget(Object valueSelector, ValueHolderInfo other) {
    getValueCache(valueSelector).addPropagationTarget(other);
  }

  public void removePropagationTarget(Object valueSelector, ValueHolderInfo other) {
    getValueCache(valueSelector).removePropagationTarget(other);
  }

  private ValueCache getValueCache(Object valueSelector) {
    if (!(MapSequence.fromMap(_propagatedValueMap).containsKey(valueSelector))) {
      initialize(valueSelector);
    }
    return MapSequence.fromMap(_propagatedValueMap).get(valueSelector);
  }

  private void initialize(Object valueSelector) {
    MapSequence.fromMap(_propagatedValueMap).put(valueSelector, new ValueCache(this, valueSelector));
    MapSequence.fromMap(_propagatedValueMap).get(valueSelector).init();
  }

  public String getDebugInfo() {
    StringBuilder sb = new StringBuilder();
    for (IMapping<Object, ValueCache> kvp : MapSequence.fromMap(_propagatedValueMap)) {
      sb.append("----------------------------\n");
      sb.append(kvp.key() + ":\n");
      sb.append(kvp.value().getDebugInfo());
      kvp.key();
    }
    return sb.toString();
  }

}
