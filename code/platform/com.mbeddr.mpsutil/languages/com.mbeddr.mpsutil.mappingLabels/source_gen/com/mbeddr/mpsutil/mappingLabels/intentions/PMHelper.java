package com.mbeddr.mpsutil.mappingLabels.intentions;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import java.util.List;
import jetbrains.mps.typechecking.TypecheckingFacade;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SProperty;

public class PMHelper {

  public static boolean hasNodeDotGen(SNode pm) {
    SNode firstStatement = ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(SLinkOperations.getTarget(pm, LINKS.propertyValueFunction$7Sh_), LINKS.body$e68K), LINKS.statement$53DE)).first();
    if (!(SNodeOperations.isInstanceOf(firstStatement, CONCEPTS.ExpressionStatement$O8))) {
      return false;
    }
    SNode expr = SLinkOperations.getTarget(SNodeOperations.cast(firstStatement, CONCEPTS.ExpressionStatement$O8), LINKS.expression$5L7M);
    if (!(SNodeOperations.isInstanceOf(expr, CONCEPTS.DotExpression$yW))) {
      return false;
    }
    SNode call = ListSequence.fromList(SNodeOperations.getNodeDescendants(expr, CONCEPTS.Node_ConceptMethodCall$mz, false, new SAbstractConcept[]{})).first();
    if (call == null) {
      return false;
    }
    return SNodeOperations.isInstanceOf(SLinkOperations.getTarget(SLinkOperations.getTarget(SNodeOperations.cast(call, CONCEPTS.Node_ConceptMethodCall$mz), LINKS.baseMethodDeclaration$pyYw), LINKS.returnType$5xoi), CONCEPTS.StringType$uX);
  }

  public static String labelName(SNode pm) {
    SNode firstStatement = ListSequence.fromList(SLinkOperations.getChildren(SLinkOperations.getTarget(SLinkOperations.getTarget(pm, LINKS.propertyValueFunction$7Sh_), LINKS.body$e68K), LINKS.statement$53DE)).first();
    if (!(SNodeOperations.isInstanceOf(firstStatement, CONCEPTS.ExpressionStatement$O8))) {
      return null;
    }
    SNode expr = SLinkOperations.getTarget(SNodeOperations.cast(firstStatement, CONCEPTS.ExpressionStatement$O8), LINKS.expression$5L7M);
    if (!(SNodeOperations.isInstanceOf(expr, CONCEPTS.DotExpression$yW))) {
      return null;
    }
    SNode call = ListSequence.fromList(SNodeOperations.getNodeDescendants(expr, CONCEPTS.Node_ConceptMethodCall$mz, false, new SAbstractConcept[]{})).first();
    if (call == null) {
      return null;
    }
    SNode cmd = SLinkOperations.getTarget(SNodeOperations.cast(call, CONCEPTS.Node_ConceptMethodCall$mz), LINKS.baseMethodDeclaration$pyYw);
    return SPropertyOperations.getString(SLinkOperations.getTarget(SNodeOperations.getNodeAncestor(cmd, CONCEPTS.ConceptBehavior$2, false, false), LINKS.concept$u6dL), PROPS.name$MnvL) + "_" + SPropertyOperations.getString(cmd, PROPS.name$MnvL);
  }

  public static SNode mappingTargetConcept(SNode pm) {
    return SNodeOperations.getConceptDeclaration(SNodeOperations.getParent(pm));
  }

  public static SNode templateNode(SNode pm) {
    return SNodeOperations.getParent(pm);
  }

  public static SNode mappingSourceConcept(SNode pm) {
    SNode src = null;
    SNode td = SNodeOperations.getNodeAncestor(pm, CONCEPTS.TemplateDeclaration$5G, false, false);
    if ((td != null)) {
      return SLinkOperations.getTarget(td, LINKS.applicableConcept$JSvx);
    } else {
      return SLinkOperations.getTarget(SNodeOperations.getNodeAncestor(td, CONCEPTS.BaseMappingRule$O5, false, false), LINKS.applicableConcept$Hpnk);
    }
  }

  public static void createLabel(SNode pm, final String labelName, SNode mc) {

    SNode src = mappingSourceConcept(pm);

    SNode label = ListSequence.fromList(SLinkOperations.getChildren(mc, LINKS.mappingLabel$Wvfj)).findFirst((it) -> SPropertyOperations.getString(it, PROPS.name$MnvL).equals(labelName));
    boolean labelIsNew = false;
    if (label == null) {
      label = createMappingLabelDeclaration_v3x8ud_a0a0f0l(labelName, src, mappingTargetConcept(pm));
      ListSequence.fromList(SLinkOperations.getChildren(mc, LINKS.mappingLabel$Wvfj)).addElement(label);
      labelIsNew = true;
    }


    SNode nodeWithPropertyMacro = templateNode(pm);

    // if the node itself is the template fragment, attach
    // the label to it.
    SNode tf = new IAttributeDescriptor.NodeAttribute(CONCEPTS.TemplateFragment$eq).get(nodeWithPropertyMacro);
    List<SNode> nms = new IAttributeDescriptor.NodeAttribute(CONCEPTS.NodeMacro$qU).list(nodeWithPropertyMacro);
    SNode nm = ListSequence.fromList(nms).first();
    if (tf != null) {
      SLinkOperations.setTarget(tf, LINKS.labelDeclaration$ORJN, label);
    } else {
      if (nm != null) {
        SLinkOperations.setTarget(nm, LINKS.mappingLabel$jbOO, label);
      }
    }

    if (labelIsNew && SNodeOperations.isInstanceOf(nm, CONCEPTS.LoopMacro$1T)) {
      // use the type over which we iterte as the label source
      SLinkOperations.setTarget(label, LINKS.sourceConcept$RXk, SLinkOperations.getTarget(SNodeOperations.cast(SLinkOperations.getTarget(SNodeOperations.cast(TypecheckingFacade.getFromContext().getTypeOf(SLinkOperations.getTarget(SNodeOperations.cast(nm, CONCEPTS.LoopMacro$1T), LINKS.sourceNodesQuery$XjmI)), CONCEPTS.SequenceType$_s), LINKS.elementType$KpjL), CONCEPTS.SNodeType$hR), LINKS.concept$OMgE));
    }



  }

  private static SNode createMappingLabelDeclaration_v3x8ud_a0a0f0l(String p0, SNode p1, SNode p2) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.MappingLabelDeclaration$MV);
    n0.setProperty(PROPS.name$MnvL, p0);
    n0.setReferenceTarget(LINKS.sourceConcept$RXk, p1);
    n0.setReferenceTarget(LINKS.targetConcept$HW_R, p2);
    return n0.getResult();
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink propertyValueFunction$7Sh_ = MetaAdapterFactory.getContainmentLink(0xb401a68083254110L, 0x8fd384331ff25befL, 0xfd47e9f6f0L, 0x10fe3b4023fL, "propertyValueFunction");
    /*package*/ static final SContainmentLink body$e68K = MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x108bbca0f48L, 0x108bbd29b4aL, "body");
    /*package*/ static final SContainmentLink statement$53DE = MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8cc56b200L, 0xf8cc6bf961L, "statement");
    /*package*/ static final SContainmentLink expression$5L7M = MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8cc56b213L, 0xf8cc56b214L, "expression");
    /*package*/ static final SReferenceLink baseMethodDeclaration$pyYw = MetaAdapterFactory.getReferenceLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x11857355952L, 0xf8c78301adL, "baseMethodDeclaration");
    /*package*/ static final SContainmentLink returnType$5xoi = MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8cc56b1fcL, 0xf8cc56b1fdL, "returnType");
    /*package*/ static final SReferenceLink concept$u6dL = MetaAdapterFactory.getReferenceLink(0xaf65afd8f0dd4942L, 0x87d963a55f2a9db1L, 0x11d43447b1aL, 0x11d43447b1fL, "concept");
    /*package*/ static final SReferenceLink applicableConcept$JSvx = MetaAdapterFactory.getReferenceLink(0xb401a68083254110L, 0x8fd384331ff25befL, 0xfe43cb41d0L, 0x1100343ad9eL, "applicableConcept");
    /*package*/ static final SReferenceLink applicableConcept$Hpnk = MetaAdapterFactory.getReferenceLink(0xb401a68083254110L, 0x8fd384331ff25befL, 0x10fc0b64647L, 0x10fc0b6e730L, "applicableConcept");
    /*package*/ static final SContainmentLink mappingLabel$Wvfj = MetaAdapterFactory.getContainmentLink(0xb401a68083254110L, 0x8fd384331ff25befL, 0xff0bea0475L, 0x1179be725f9L, "mappingLabel");
    /*package*/ static final SReferenceLink labelDeclaration$ORJN = MetaAdapterFactory.getReferenceLink(0xb401a68083254110L, 0x8fd384331ff25befL, 0xff1b29b76cL, 0x1179c366b2fL, "labelDeclaration");
    /*package*/ static final SReferenceLink mappingLabel$jbOO = MetaAdapterFactory.getReferenceLink(0xb401a68083254110L, 0x8fd384331ff25befL, 0xfd47ed6742L, 0x1179bf24befL, "mappingLabel");
    /*package*/ static final SReferenceLink sourceConcept$RXk = MetaAdapterFactory.getReferenceLink(0xb401a68083254110L, 0x8fd384331ff25befL, 0x1179be47606L, 0x1179be4dc5eL, "sourceConcept");
    /*package*/ static final SContainmentLink sourceNodesQuery$XjmI = MetaAdapterFactory.getContainmentLink(0xb401a68083254110L, 0x8fd384331ff25befL, 0x1047ce009c3L, 0x10fef5e42d7L, "sourceNodesQuery");
    /*package*/ static final SContainmentLink elementType$KpjL = MetaAdapterFactory.getContainmentLink(0x8388864671ce4f1cL, 0x9c53c54016f6ad4fL, 0x10c260e9444L, 0x10c260ee40eL, "elementType");
    /*package*/ static final SReferenceLink concept$OMgE = MetaAdapterFactory.getReferenceLink(0x7866978ea0f04cc7L, 0x81bc4d213d9375e1L, 0x108f968b3caL, 0x1090e46ca51L, "concept");
    /*package*/ static final SReferenceLink targetConcept$HW_R = MetaAdapterFactory.getReferenceLink(0xb401a68083254110L, 0x8fd384331ff25befL, 0x1179be47606L, 0x1179bfe3866L, "targetConcept");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept ExpressionStatement$O8 = MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8cc56b213L, "jetbrains.mps.baseLanguage.structure.ExpressionStatement");
    /*package*/ static final SConcept DotExpression$yW = MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x116b46a08c4L, "jetbrains.mps.baseLanguage.structure.DotExpression");
    /*package*/ static final SConcept Node_ConceptMethodCall$mz = MetaAdapterFactory.getConcept(0x7866978ea0f04cc7L, 0x81bc4d213d9375e1L, 0x1129a43046bL, "jetbrains.mps.lang.smodel.structure.Node_ConceptMethodCall");
    /*package*/ static final SConcept StringType$uX = MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x11d47da71ecL, "jetbrains.mps.baseLanguage.structure.StringType");
    /*package*/ static final SConcept ConceptBehavior$2 = MetaAdapterFactory.getConcept(0xaf65afd8f0dd4942L, 0x87d963a55f2a9db1L, 0x11d43447b1aL, "jetbrains.mps.lang.behavior.structure.ConceptBehavior");
    /*package*/ static final SConcept TemplateDeclaration$5G = MetaAdapterFactory.getConcept(0xb401a68083254110L, 0x8fd384331ff25befL, 0xfe43cb41d0L, "jetbrains.mps.lang.generator.structure.TemplateDeclaration");
    /*package*/ static final SConcept BaseMappingRule$O5 = MetaAdapterFactory.getConcept(0xb401a68083254110L, 0x8fd384331ff25befL, 0x10fc0b64647L, "jetbrains.mps.lang.generator.structure.BaseMappingRule");
    /*package*/ static final SConcept TemplateFragment$eq = MetaAdapterFactory.getConcept(0xb401a68083254110L, 0x8fd384331ff25befL, 0xff1b29b76cL, "jetbrains.mps.lang.generator.structure.TemplateFragment");
    /*package*/ static final SConcept NodeMacro$qU = MetaAdapterFactory.getConcept(0xb401a68083254110L, 0x8fd384331ff25befL, 0xfd47ed6742L, "jetbrains.mps.lang.generator.structure.NodeMacro");
    /*package*/ static final SConcept LoopMacro$1T = MetaAdapterFactory.getConcept(0xb401a68083254110L, 0x8fd384331ff25befL, 0x1047ce009c3L, "jetbrains.mps.lang.generator.structure.LoopMacro");
    /*package*/ static final SConcept SequenceType$_s = MetaAdapterFactory.getConcept(0x8388864671ce4f1cL, 0x9c53c54016f6ad4fL, 0x10c260e9444L, "jetbrains.mps.baseLanguage.collections.structure.SequenceType");
    /*package*/ static final SConcept SNodeType$hR = MetaAdapterFactory.getConcept(0x7866978ea0f04cc7L, 0x81bc4d213d9375e1L, 0x108f968b3caL, "jetbrains.mps.lang.smodel.structure.SNodeType");
    /*package*/ static final SConcept MappingLabelDeclaration$MV = MetaAdapterFactory.getConcept(0xb401a68083254110L, 0x8fd384331ff25befL, 0x1179be47606L, "jetbrains.mps.lang.generator.structure.MappingLabelDeclaration");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
