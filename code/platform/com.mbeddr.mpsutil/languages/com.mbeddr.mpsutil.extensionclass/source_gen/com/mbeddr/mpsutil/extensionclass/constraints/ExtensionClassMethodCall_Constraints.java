package com.mbeddr.mpsutil.extensionclass.constraints;

/*Generated by MPS */

import jetbrains.mps.smodel.runtime.base.BaseConstraintsDescriptor;
import java.util.Map;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import jetbrains.mps.smodel.runtime.ReferenceConstraintsDescriptor;
import jetbrains.mps.smodel.runtime.base.BaseReferenceConstraintsDescriptor;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.smodel.runtime.ReferenceScopeProvider;
import jetbrains.mps.smodel.runtime.base.BaseScopeProvider;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.smodel.SNodePointer;
import jetbrains.mps.scope.Scope;
import jetbrains.mps.smodel.runtime.ReferenceConstraintsContext;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.smodel.SNodeUtil;
import jetbrains.mps.lang.core.behavior.BaseConcept__BehaviorDescriptor;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.baseLanguage.behavior.ClassConcept__BehaviorDescriptor;
import jetbrains.mps.typechecking.TypecheckingFacade;
import jetbrains.mps.baseLanguage.behavior.Type__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.baseLanguage.scopes.VisibilityUtil;
import java.util.HashMap;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class ExtensionClassMethodCall_Constraints extends BaseConstraintsDescriptor {
  public ExtensionClassMethodCall_Constraints() {
    super(CONCEPTS.ExtensionClassMethodCall$2B);
  }

  @Override
  protected Map<SReferenceLink, ReferenceConstraintsDescriptor> getSpecifiedReferences() {
    BaseReferenceConstraintsDescriptor d0 = new BaseReferenceConstraintsDescriptor(LINKS.baseMethodDeclaration$pyYw, this, true, false) {
      @Nullable
      @Override
      public ReferenceScopeProvider getScopeProvider() {
        return new BaseScopeProvider() {
          @Override
          public SNodeReference getSearchScopeValidatorNode() {
            return new SNodePointer("r:8bb683ff-ef97-4a17-b922-a6edd1d8518d(com.mbeddr.mpsutil.extensionclass.constraints)", "7997068947889524884");
          }
          @Override
          public Scope createScope(final ReferenceConstraintsContext _context) {
            final SNode enclosingNode = (((_context.getReferenceNode() == null) ? _context.getContextNode() : SNodeOperations.getParent(_context.getReferenceNode())));
            return new Scope() {
              public Iterable<SNode> getAvailableElements(@Nullable final String prefix) {
                return getNodes();
              }
              @Nullable
              public SNode resolve(SNode contextNode, @NotNull String refText) {
                return null;
              }
              @Nullable
              public String getReferenceText(SNode contextNode, @NotNull SNode node) {
                String resolveInfo = SNodeUtil.getResolveInfo(SNodeOperations.cast(node, CONCEPTS.IResolveInfo$$k));
                if ((resolveInfo != null && resolveInfo.length() > 0)) {
                  return resolveInfo;
                }
                return BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(node);
              }
              @NotNull
              private List<SNode> getNodes() {
                List<SNode> result = new ArrayList<SNode>();
                SNode operand = SLinkOperations.getTarget(SNodeOperations.cast(enclosingNode, CONCEPTS.DotExpression$yW), LINKS.operand$w6IR);
                for (SNode extension : ListSequence.fromList(SModelOperations.nodesIncludingImported(SNodeOperations.getModel(_context.getContextNode()), CONCEPTS.ExtensionClass$K))) {
                  for (SNode method : Sequence.fromIterable(ClassConcept__BehaviorDescriptor.staticMethods_id4_LVZ3pCeXr.invoke(SLinkOperations.getTarget(extension, LINKS.class$kmno)))) {
                    SNode operandType = TypecheckingFacade.getFromContext().getTypeOf(operand);
                    SNode looseType = Type__BehaviorDescriptor.getLooseType_id4YTQtEKnnzf.invoke(SLinkOperations.getTarget(ListSequence.fromList(SLinkOperations.getChildren(method, LINKS.parameter$5xBj)).first(), LINKS.type$a1UY), SetSequence.fromSet(new HashSet<SNode>()));
                    if (TypecheckingFacade.getFromContext().isSubtype(operandType, looseType) && VisibilityUtil.isVisible(enclosingNode, method)) {
                      ListSequence.fromList(result).addElement(method);
                    }
                  }
                }
                return ListSequence.fromListWithValues(new ArrayList<SNode>(), result);
              }

            };



          }
        };
      }
    };
    Map<SReferenceLink, ReferenceConstraintsDescriptor> references = new HashMap<SReferenceLink, ReferenceConstraintsDescriptor>();
    references.put(d0.getReference(), d0);
    return references;
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept ExtensionClassMethodCall$2B = MetaAdapterFactory.getConcept(0xf39336d3128847eeL, 0xbbfead2ea7e4504eL, 0x4f4781239a23a494L, "com.mbeddr.mpsutil.extensionclass.structure.ExtensionClassMethodCall");
    /*package*/ static final SInterfaceConcept IResolveInfo$$k = MetaAdapterFactory.getInterfaceConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x116b17c6e46L, "jetbrains.mps.lang.core.structure.IResolveInfo");
    /*package*/ static final SConcept DotExpression$yW = MetaAdapterFactory.getConcept(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x116b46a08c4L, "jetbrains.mps.baseLanguage.structure.DotExpression");
    /*package*/ static final SConcept ExtensionClass$K = MetaAdapterFactory.getConcept(0xf39336d3128847eeL, 0xbbfead2ea7e4504eL, 0x4f4781239a213505L, "com.mbeddr.mpsutil.extensionclass.structure.ExtensionClass");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink baseMethodDeclaration$pyYw = MetaAdapterFactory.getReferenceLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x11857355952L, 0xf8c78301adL, "baseMethodDeclaration");
    /*package*/ static final SContainmentLink operand$w6IR = MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x116b46a08c4L, 0x116b46a4416L, "operand");
    /*package*/ static final SContainmentLink parameter$5xBj = MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0xf8cc56b1fcL, 0xf8cc56b1feL, "parameter");
    /*package*/ static final SContainmentLink type$a1UY = MetaAdapterFactory.getContainmentLink(0xf3061a5392264cc5L, 0xa443f952ceaf5816L, 0x450368d90ce15bc3L, 0x4ed4d318133c80ceL, "type");
    /*package*/ static final SReferenceLink class$kmno = MetaAdapterFactory.getReferenceLink(0xf39336d3128847eeL, 0xbbfead2ea7e4504eL, 0x4f4781239a213505L, 0x4f4781239a213506L, "class");
  }
}
