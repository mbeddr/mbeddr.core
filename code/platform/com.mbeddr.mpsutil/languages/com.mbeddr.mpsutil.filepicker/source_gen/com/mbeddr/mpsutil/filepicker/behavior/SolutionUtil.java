package com.mbeddr.mpsutil.filepicker.behavior;

/*Generated by MPS */

import org.jetbrains.mps.openapi.module.SModule;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.extapi.model.TransientSModel;
import jetbrains.mps.generator.TransientModelsModule;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.project.AbstractModule;
import jetbrains.mps.vfs.IFile;

public class SolutionUtil {

  public static SModule getSolutionForNode(SNode node) {
    return getSolution(SNodeOperations.getModel(node));
  }

  public static SModule getSolution(SModel model) {
    SModule module = model.getModule();
    if (model instanceof TransientSModel && module instanceof TransientModelsModule) {
      String longName = model.getName().getLongName();
      SModel originalModel = PersistenceFacade.getInstance().createModelReference(longName).resolve(null);
      if (originalModel != null) {
        module = originalModel.getModule();
      }
    }
    return module;
  }

  public static String getSolutionNameForNode(SNode node) {
    SModule module = getSolutionForNode(node);
    if (module != null) {
      return module.getModuleName();
    }
    return null;
  }

  public static String getSolutionRootPathForNode(SNode node) {
    return getSolutionRootPath(SNodeOperations.getModel(node));
  }

  public static String getSolutionRootPath(SModel model) {
    SModule module = getSolution(model);
    if (module instanceof AbstractModule && ((AbstractModule) module).getModuleSourceDir() != null) {
      AbstractModule m = ((AbstractModule) module);
      IFile bundleHome = m.getModuleSourceDir().getBundleHome();
      if (m.isPackaged() && bundleHome != null) {
        IFile bundleRoot = bundleHome.getParent();
        if (bundleRoot != null) {
          return bundleRoot.getPath();
        }
      }
      return m.getModuleSourceDir().getPath();
    }
    return null;
  }

  public static String createFilenameRelativeToNodeSolution(SNode node, String name) {
    return createFilenameRelativeToSolution(SNodeOperations.getModel(node), name);
  }

  public static String createFilenameRelativeToSolution(SModel model, String name) {
    return getSolution(model) + "/" + name;
  }
}
