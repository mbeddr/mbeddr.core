package com.mbeddr.mpsutil.jung.pluginSolution.plugin;

/*Generated by MPS */

import jetbrains.mps.plugins.tool.GeneratedTool;
import javax.swing.Icon;
import com.intellij.icons.AllIcons;
import org.jetbrains.mps.openapi.model.SNode;
import com.mbeddr.mpsutil.jung.behavior.JNGraph;
import javax.swing.JPanel;
import jetbrains.mps.project.Project;
import javax.swing.JComboBox;
import java.util.Vector;
import javax.swing.JCheckBox;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import java.util.Set;
import com.mbeddr.mpsutil.jung.behavior.JNNode;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import org.jetbrains.mps.openapi.module.SRepository;
import com.intellij.openapi.wm.ToolWindowAnchor;
import jetbrains.mps.ide.project.ProjectHelper;
import java.awt.Color;
import java.awt.BorderLayout;
import java.awt.FlowLayout;
import javax.swing.JComponent;
import javax.swing.JLabel;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.openapi.navigation.EditorNavigator;
import com.mbeddr.mpsutil.jung.behavior.IJGraphProvider__BehaviorDescriptor;
import com.mbeddr.mpsutil.jung.behavior.JNLayout;
import com.mbeddr.mpsutil.jung.behavior.JNHighlightMode;
import jetbrains.mps.internal.collections.runtime.Sequence;
import edu.uci.ics.jung.graph.Graph;
import com.mbeddr.mpsutil.jung.behavior.JNEdge;
import edu.uci.ics.jung.algorithms.layout.Layout;
import edu.uci.ics.jung.visualization.VisualizationViewer;
import edu.uci.ics.jung.visualization.picking.PickedState;
import java.awt.Font;
import edu.uci.ics.jung.visualization.renderers.VertexLabelRenderer;
import java.awt.Component;
import com.mbeddr.mpsutil.jung.behavior.JNGraphLayout;
import com.mbeddr.mpsutil.jung.behavior.JNCircleLayout;
import com.mbeddr.mpsutil.jung.behavior.JNISOMLayout;
import com.mbeddr.mpsutil.jung.behavior.JNSpringLayout;
import com.mbeddr.mpsutil.jung.behavior.JNKKLayout;
import com.mbeddr.mpsutil.jung.behavior.JNFRLayout;
import jetbrains.mps.smodel.structure.ExtensionPoint;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;
import javax.swing.JButton;
import java.awt.Dimension;
import com.mbeddr.mpsutil.jung.behavior.JNForest;
import edu.uci.ics.jung.graph.DelegateForest;
import edu.uci.ics.jung.graph.SparseGraph;
import edu.uci.ics.jung.graph.util.EdgeType;
import edu.uci.ics.jung.algorithms.layout.CircleLayout;
import edu.uci.ics.jung.algorithms.layout.ISOMLayout;
import com.mbeddr.mpsutil.jung.behavior.JNTreeLayout;
import edu.uci.ics.jung.algorithms.layout.TreeLayout;
import edu.uci.ics.jung.graph.Forest;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import edu.uci.ics.jung.algorithms.layout.SpringLayout2;
import com.google.common.base.Function;
import edu.uci.ics.jung.algorithms.layout.KKLayout;
import edu.uci.ics.jung.algorithms.layout.FRLayout;
import java.awt.Shape;
import java.awt.Rectangle;
import java.awt.geom.Rectangle2D;
import java.awt.geom.Area;
import java.awt.geom.Ellipse2D;
import com.mbeddr.mpsutil.jung.behavior.ShapeFactory;
import edu.uci.ics.jung.graph.util.Context;
import com.mbeddr.mpsutil.jung.behavior.ArrowFactory;
import java.awt.Paint;
import java.awt.Stroke;
import java.awt.BasicStroke;
import edu.uci.ics.jung.visualization.control.PluggableGraphMouse;
import edu.uci.ics.jung.visualization.control.TranslatingGraphMousePlugin;
import edu.uci.ics.jung.visualization.control.ScalingGraphMousePlugin;
import edu.uci.ics.jung.visualization.control.AbsoluteCrossoverScalingControl;
import edu.uci.ics.jung.visualization.control.PickingGraphMousePlugin;
import java.awt.event.MouseEvent;
import jetbrains.mps.smodel.SNodePointer;
import java.awt.event.KeyListener;
import java.awt.event.KeyEvent;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import javax.swing.JSlider;
import javax.swing.event.ChangeListener;
import javax.swing.event.ChangeEvent;
import com.google.common.base.Predicate;

public class GraphViewer_Tool extends GeneratedTool {
  private static final Icon ICON = AllIcons.FileTypes.Diagram;
  private SNode provider;
  private JNGraph graph;
  private JPanel mainPanel;
  private JPanel graphPanel;
  private Project project;
  private int layoutSize = 500;
  private JComboBox layoutCombo = null;
  private Vector layoutOptions = new Vector();
  private JCheckBox selectOut;
  private JCheckBox selectIn;
  private JCheckBox selectNodes;
  private JCheckBox selectTansitively;
  private JComboCheckBox filtersCombo;
  private JPanel buttonPanel;
  private JPanel filterPanel;
  private Map<String, JCheckBox> filtersMap = MapSequence.fromMap(new HashMap<String, JCheckBox>());
  private JCheckBox filterByHiding;
  private Set<JNNode> collapsedNodes = SetSequence.fromSet(new HashSet<JNNode>());
  private long currentAxisOneThreshold = 0;
  private JPanel sliderPanel;
  private SRepository repo;
  public GraphViewer_Tool(com.intellij.openapi.project.Project project) {
    super(project, "Graph Viewer", null, ICON, ToolWindowAnchor.RIGHT, false);
  }
  public void init(com.intellij.openapi.project.Project project) {
    super.init(project);
    GraphViewer_Tool.this.repo = ProjectHelper.fromIdeaProject(project).getRepository();


    GraphViewer_Tool.this.mainPanel = new JPanel();
    GraphViewer_Tool.this.mainPanel.setBackground(Color.white);
    GraphViewer_Tool.this.mainPanel.setLayout(new BorderLayout());

    GraphViewer_Tool.this.buttonPanel = new JPanel();
    GraphViewer_Tool.this.mainPanel.add(GraphViewer_Tool.this.buttonPanel, BorderLayout.NORTH);
    GraphViewer_Tool.this.buttonPanel.setLayout(new FlowLayout(FlowLayout.LEFT));
    GraphViewer_Tool.this.buttonPanel.setAlignmentY(JPanel.TOP_ALIGNMENT);


    GraphViewer_Tool.this.buttonPanel.add(GraphViewer_Tool.this.sectionPanel("Drawing", GraphViewer_Tool.this.createRefreshAndResetButtons()));
    GraphViewer_Tool.this.buttonPanel.add(GraphViewer_Tool.this.sectionPanel("Size", GraphViewer_Tool.this.createSizePanel()));
    GraphViewer_Tool.this.buttonPanel.add(GraphViewer_Tool.this.sectionPanel("Selection", GraphViewer_Tool.this.createSelectionModePanel()));
    GraphViewer_Tool.this.buttonPanel.add(GraphViewer_Tool.this.sectionPanel("Layout", GraphViewer_Tool.this.createLayoutComboBox()));
    GraphViewer_Tool.this.buttonPanel.add(GraphViewer_Tool.this.sectionPanel("Filtering", GraphViewer_Tool.this.createFilterPanel()));


    GraphViewer_Tool.this.graphPanel = new JPanel();
    GraphViewer_Tool.this.graphPanel.setLayout(new BorderLayout());
    GraphViewer_Tool.this.mainPanel.add(GraphViewer_Tool.this.graphPanel, BorderLayout.CENTER);
  }
  public void dispose() {
    GraphViewer_Tool.this.mainPanel = null;
    super.dispose();
  }
  /*package*/ JPanel sectionPanel(String title, JComponent[] contents) {
    JPanel main = new JPanel();
    main.setLayout(new BorderLayout());
    JLabel titlePanel = new JLabel("   " + title);
    titlePanel.setAlignmentY(JLabel.TOP_ALIGNMENT);
    titlePanel.setVerticalAlignment(JLabel.TOP);
    main.add(titlePanel, BorderLayout.NORTH);
    JPanel contentPanel = new JPanel();
    contentPanel.setAlignmentX(JPanel.CENTER_ALIGNMENT);
    contentPanel.setAlignmentY(JPanel.CENTER_ALIGNMENT);
    contentPanel.setLayout(new FlowLayout(FlowLayout.LEFT));
    main.add(contentPanel, BorderLayout.CENTER);
    for (JComponent c : contents) {
      contentPanel.add(c);
    }
    contentPanel.add(new JLabel(" "));
    return main;
  }
  /*package*/ void selectNode(SNodeReference ptr) {
    if (ptr == null) {
      return;
    }
    new EditorNavigator(GraphViewer_Tool.this.project).shallFocus(true).shallSelect(true).open(ptr);
  }
  public void setNewGraph(SNode provider, Project project) {
    GraphViewer_Tool.this.provider = provider;
    GraphViewer_Tool.this.graph = IJGraphProvider__BehaviorDescriptor.getGraph_id5yCuRHcaxm8.invoke(provider);
    GraphViewer_Tool.this.layoutSize = GraphViewer_Tool.this.graph.getInitialSize();
    GraphViewer_Tool.this.project = project;

    GraphViewer_Tool.this.setupFilterCombo(GraphViewer_Tool.this.graph);

    GraphViewer_Tool.this.updateGraph();
    JNLayout l = GraphViewer_Tool.this.graph.getLayout();

    for (int p = 0; p < GraphViewer_Tool.this.layoutOptions.size(); p++) {
      if (GraphViewer_Tool.this.layoutOptions.get(p).getClass().equals(l.getClass())) {
        GraphViewer_Tool.this.layoutCombo.setSelectedIndex(p);
      }
    }

    JNHighlightMode hm = GraphViewer_Tool.this.graph.getHighlightMode();
    GraphViewer_Tool.this.selectIn.setSelected(hm.inEdges);
    GraphViewer_Tool.this.selectOut.setSelected(hm.outEdges);
    GraphViewer_Tool.this.selectNodes.setSelected(hm.nodesAlso);
    GraphViewer_Tool.this.selectTansitively.setSelected(hm.transitive);


  }
  private void repaintGraph() {
    GraphViewer_Tool.this.graphPanel.validate();
    GraphViewer_Tool.this.graphPanel.repaint();
  }
  public void updateGraph() {
    final JNGraph gr = GraphViewer_Tool.this.graph;

    if (Sequence.fromIterable(gr.vertices()).isEmpty()) {
      System.err.println("JUNG Graph is empty (no vertices); skipping update.");
      return;
    }

    final JNLayout jnLayout = ((JNLayout) GraphViewer_Tool.this.layoutCombo.getSelectedItem());



    Graph<JNNode, JNEdge> jungGraph = GraphViewer_Tool.this.createJungGraph(gr);
    Layout<JNNode, JNEdge> l = GraphViewer_Tool.this.setupJungLayout(jnLayout, jungGraph);


    final VisualizationViewer vv = new VisualizationViewer<JNNode, JNEdge>(l);
    final PickedState<Object> vertexPicker = vv.getPickedVertexState();
    final PickedState<Object> edgePicker = vv.getPickedEdgeState();


    final JLabel renderLabel = new JLabel();
    final Font regularFont = renderLabel.getFont();
    final Font boldFont = new Font(regularFont.getFontName(), Font.BOLD, regularFont.getSize());



    vv.getRenderContext().setVertexLabelRenderer(new VertexLabelRenderer() {
      public <T> Component getVertexLabelRendererComponent(JComponent p0, Object p1, Font p2, boolean isSelected, T vtx) {
        JNNode vertex = ((JNNode) vtx);
        if (GraphViewer_Tool.this.isNodeHidden(vertex)) {
          renderLabel.setFont(regularFont);
          renderLabel.setOpaque(false);
          renderLabel.setText("");
          return renderLabel;
        }
        String text = vertex.toString();
        renderLabel.setText(" " + text + " ");
        if (vertexPicker.isPicked(vertex)) {
          renderLabel.setFont(boldFont);
          renderLabel.setBackground(gr.getSecondarySelectionColor());
          renderLabel.setOpaque(true);
        } else {
          renderLabel.setFont(regularFont);
          renderLabel.setBackground(Color.white);
          renderLabel.setOpaque(false);
        }
        return renderLabel;
      }
    });
    vv.getRenderContext().setLabelOffset(10);
    GraphViewer_Tool.this.setupTooltips(vv);
    GraphViewer_Tool.this.setupVertexShape(gr, vv);
    GraphViewer_Tool.this.setupArrowhape(gr, vv);
    GraphViewer_Tool.this.setupVertexColor(gr, vertexPicker, vv);
    GraphViewer_Tool.this.setupEdgeStroke(vv, gr);
    GraphViewer_Tool.this.setupEdgeColor(gr, edgePicker, vv);
    GraphViewer_Tool.this.setupMouseAndKeys(gr, edgePicker, vertexPicker, vv);
    GraphViewer_Tool.this.setupFilterPredicates(vv);



    vv.setGraphLayout(l);
    vv.setBackground(Color.white);
    GraphViewer_Tool.this.getToolWindow().setTitle(gr.title());
    while (GraphViewer_Tool.this.graphPanel.getComponentCount() > 0) {
      GraphViewer_Tool.this.graphPanel.remove(0);
      GraphViewer_Tool.this.graphPanel.validate();
      GraphViewer_Tool.this.graphPanel.repaint();
    }
    GraphViewer_Tool.this.graphPanel.add(vv, BorderLayout.CENTER);
    GraphViewer_Tool.this.graphPanel.validate();
    GraphViewer_Tool.this.graphPanel.repaint();
  }
  /*package*/ JNGraphLayout getSelectedLayout() {
    return ((JNGraphLayout) GraphViewer_Tool.this.layoutCombo.getSelectedItem());
  }
  private JComponent[] createLayoutComboBox() {
    GraphViewer_Tool.this.layoutOptions.add(new JNCircleLayout());
    GraphViewer_Tool.this.layoutOptions.add(new JNISOMLayout());
    GraphViewer_Tool.this.layoutOptions.add(new JNSpringLayout());
    GraphViewer_Tool.this.layoutOptions.add(new JNKKLayout());
    GraphViewer_Tool.this.layoutOptions.add(new JNFRLayout());

    for (LayoutFactory ext : Sequence.fromIterable(new ExtensionPoint<LayoutFactory>("com.mbeddr.mpsutil.jung.pluginSolution.CustomLayouts").getObjects())) {
      GraphViewer_Tool.this.layoutOptions.add(ext.getJNLayout());
    }


    GraphViewer_Tool.this.layoutCombo = new JComboBox(GraphViewer_Tool.this.layoutOptions);
    GraphViewer_Tool.this.layoutCombo.addActionListener(new ActionListener() {
      public void actionPerformed(ActionEvent p0) {
        GraphViewer_Tool.this.updateGraph();
      }
    });
    return new JComponent[]{GraphViewer_Tool.this.layoutCombo};
  }
  private JComponent[] createFilterPanel() {
    GraphViewer_Tool.this.filterPanel = new JPanel();
    GraphViewer_Tool.this.filterPanel.setLayout(new FlowLayout(FlowLayout.LEFT));
    GraphViewer_Tool.this.filterByHiding = new JCheckBox("Hide", false);
    return new JComponent[]{GraphViewer_Tool.this.filterByHiding, GraphViewer_Tool.this.filterPanel};
  }
  private JComponent[] createRefreshAndResetButtons() {
    JComponent[] res = new JComponent[2];
    JButton refreshButton = new JButton("Refresh");
    refreshButton.addActionListener(new ActionListener() {
      public void actionPerformed(ActionEvent p0) {
        GraphViewer_Tool.this.repo.getModelAccess().runReadAction(() -> {
          GraphViewer_Tool.this.graph = IJGraphProvider__BehaviorDescriptor.getGraph_id5yCuRHcaxm8.invoke(GraphViewer_Tool.this.provider);
          GraphViewer_Tool.this.updateGraph();
        });
      }
    });
    res[0] = refreshButton;

    JButton resetButton = new JButton("Reset");
    resetButton.addActionListener(new ActionListener() {
      public void actionPerformed(ActionEvent p0) {
        GraphViewer_Tool.this.repo.getModelAccess().runReadAction(() -> GraphViewer_Tool.this.setNewGraph(GraphViewer_Tool.this.provider, GraphViewer_Tool.this.project));
      }
    });
    res[1] = resetButton;

    return res;
  }
  private JComponent[] createSizePanel() {
    JComponent[] res = new JComponent[2];

    JButton makeSmaller = new JButton("-");
    makeSmaller.addActionListener(new ActionListener() {
      public void actionPerformed(ActionEvent p0) {
        GraphViewer_Tool.this.layoutSize = ((int) (GraphViewer_Tool.this.layoutSize * 0.666));
        GraphViewer_Tool.this.updateGraph();
      }
    });
    makeSmaller.setPreferredSize(new Dimension(20, 20));
    res[0] = makeSmaller;

    JButton makeBigger = new JButton("+");
    makeBigger.addActionListener(new ActionListener() {
      public void actionPerformed(ActionEvent p0) {
        GraphViewer_Tool.this.layoutSize = ((int) (GraphViewer_Tool.this.layoutSize * 1.5));
        GraphViewer_Tool.this.updateGraph();
      }
    });
    makeBigger.setPreferredSize(new Dimension(20, 20));
    res[1] = makeBigger;

    return res;
  }
  private JComponent[] createSelectionModePanel() {
    JComponent[] res = new JComponent[4];

    GraphViewer_Tool.this.selectIn = new JCheckBox("I");
    GraphViewer_Tool.this.selectIn.setToolTipText("Select Incoming Edges");
    GraphViewer_Tool.this.selectOut = new JCheckBox("O");
    GraphViewer_Tool.this.selectOut.setToolTipText("Select Outgoing Edges");
    GraphViewer_Tool.this.selectNodes = new JCheckBox("N");
    GraphViewer_Tool.this.selectNodes.setToolTipText("Also Select In/Out Nodes");
    GraphViewer_Tool.this.selectTansitively = new JCheckBox("T");
    GraphViewer_Tool.this.selectTansitively.setToolTipText("Select Transitively");

    res[0] = GraphViewer_Tool.this.selectIn;
    res[1] = GraphViewer_Tool.this.selectOut;
    res[2] = GraphViewer_Tool.this.selectNodes;
    res[3] = GraphViewer_Tool.this.selectTansitively;

    return res;
  }
  private Graph<JNNode, JNEdge> createJungGraph(final JNGraph gr) {
    Graph<JNNode, JNEdge> jungGraph = null;
    if (gr instanceof JNForest) {
      jungGraph = new DelegateForest<JNNode, JNEdge>();
    } else {
      jungGraph = new SparseGraph<JNNode, JNEdge>();
    }

    for (JNNode v : Sequence.fromIterable(gr.vertices())) {
      jungGraph.addVertex(v);
    }
    for (JNEdge e : Sequence.fromIterable(gr.edges())) {
      JNNode vsrc = e.from();
      JNNode vdst = e.to();
      if (vsrc == null || vdst == null) {
        System.err.println("edge " + e + " cannot be drawn; source or destination not available in graph");
      } else {
        if (e.isDirected()) {
          jungGraph.addEdge(e, vsrc, vdst, EdgeType.DIRECTED);
        } else {
          jungGraph.addEdge(e, vsrc, vdst, EdgeType.UNDIRECTED);
        }
      }
    }
    return jungGraph;
  }
  private Layout<JNNode, JNEdge> setupJungLayout(JNLayout gl, Graph<JNNode, JNEdge> jungGraph) {
    Layout<JNNode, JNEdge> jl = null;

    if (gl instanceof JNCircleLayout) {
      jl = new CircleLayout<JNNode, JNEdge>(jungGraph);
    } else if (gl instanceof JNISOMLayout) {
      jl = new ISOMLayout<JNNode, JNEdge>(jungGraph);
    } else if (gl instanceof JNTreeLayout) {
      jl = new TreeLayout<JNNode, JNEdge>(((Forest<JNNode, JNEdge>) jungGraph));
    } else if (gl instanceof JNSpringLayout) {
      final _FunctionTypes._return_P1_E0<? extends Integer, ? super JNEdge> edgeLength = ((JNSpringLayout) gl).edgeLength;
      if (edgeLength == null) {
        jl = new SpringLayout2<JNNode, JNEdge>(jungGraph);
      } else {
        jl = new SpringLayout2<JNNode, JNEdge>(jungGraph, new Function<JNEdge, Integer>() {
          public Integer apply(JNEdge edge) {
            return edgeLength.invoke(edge);
          }
        });
      }
    } else if (gl instanceof JNKKLayout) {
      jl = new KKLayout<JNNode, JNEdge>(jungGraph);
    } else if (gl instanceof JNFRLayout) {
      jl = new FRLayout<JNNode, JNEdge>(jungGraph);
    } else {
      for (LayoutFactory ext : Sequence.fromIterable(new ExtensionPoint<LayoutFactory>("com.mbeddr.mpsutil.jung.pluginSolution.CustomLayouts").getObjects())) {
        jl = ext.createLayout(gl, jungGraph, GraphViewer_Tool.this.graph);
        if (jl != null) {
          break;
        }
      }
    }

    if (jl != null) {
      jl.setSize(new Dimension(GraphViewer_Tool.this.layoutSize, GraphViewer_Tool.this.layoutSize));
    } else {
      System.err.println("ERROR: no layout instantiated for layout spec " + jl);
    }


    return jl;
  }
  private void setupTooltips(final VisualizationViewer vv) {
    vv.setVertexToolTipTransformer(new Function<Object, String>() {
      public String apply(Object vertex) {
        JNNode n = ((JNNode) vertex);
        String text = n.getTooltip();
        _FunctionTypes._return_P1_E0<? extends String, ? super Long> formatter = GraphViewer_Tool.this.graph.continuousAxisOneFormatter;
        if (formatter != null && n.hasContinuousAxisOneValue()) {
          text += ("\n" + formatter.invoke(n.continuousAxisOneValue()));
        }
        return text;
      }
    });

    vv.setEdgeToolTipTransformer(new Function<Object, String>() {
      public String apply(Object edge) {
        return ((JNEdge) edge).getTooltip();
      }
    });
  }
  /*package*/ Shape markShapeAsCollapsed(JNNode node, Shape s) {
    if (SetSequence.fromSet(GraphViewer_Tool.this.collapsedNodes).contains(node)) {
      Rectangle bounds = s.getBounds();
      double w = bounds.getWidth();
      double h = bounds.getHeight();
      float off = 2;
      Rectangle2D.Double box = new Rectangle2D.Double(-w / 2 - off, -h / 2 - off, w + off, h + off);
      Area res = new Area();
      res.add(new Area(s));
      res.add(new Area(box));
      return res;
    }
    return s;
  }
  private void setupVertexShape(final JNGraph gr, final VisualizationViewer vv) {
    if (gr.vertexSize != null && gr.vertexShape == null) {
      vv.getRenderContext().setVertexShapeTransformer(new Function<Object, Shape>() {
        public Shape apply(Object node) {
          float rs = 10 + (gr.vertexSize.invoke(((JNNode) node)));
          return GraphViewer_Tool.this.markShapeAsCollapsed(((JNNode) node), new Ellipse2D.Float(-rs / 2, -rs / 2, rs, rs));
        }
      });
    } else if (gr.vertexShape != null) {
      vv.getRenderContext().setVertexShapeTransformer(new Function<Object, Shape>() {
        public Shape apply(Object object) {
          JNNode node = (JNNode) object;
          Shape shape = gr.vertexShape.invoke((node));
          if (shape == null) {
            int size = 15;
            if (gr.vertexSize != null) {
              size = gr.vertexSize.invoke(node);
            }
            shape = ShapeFactory.circle(node, size);
          }
          return GraphViewer_Tool.this.markShapeAsCollapsed(node, shape);
        }
      });
    }
  }
  private void setupArrowhape(final JNGraph gr, final VisualizationViewer vv) {
    if (gr.arrowShape != null) {
      vv.getRenderContext().setEdgeArrowTransformer(new Function<Context<Graph<Object, Object>, Object>, Shape>() {
        public Shape apply(Context<Graph<Object, Object>, Object> vtx) {
          Shape shape = gr.arrowShape.invoke(((JNEdge) vtx.element));
          if (shape == null) {
            return ArrowFactory.arrow(10, 7);
          }
          return shape;
        }
      });
    }
  }
  private boolean isNodeHidden(JNNode node) {
    if (!(GraphViewer_Tool.this.isSelectedInCategoryFilter(node.kinds()))) {
      return true;
    }
    if (node.hasContinuousAxisOneValue()) {
      long c = node.continuousAxisOneValue();
      long t = GraphViewer_Tool.this.currentAxisOneThreshold;
      if (c > t) {
        return true;
      }
    }
    for (JNNode cn : SetSequence.fromSet(GraphViewer_Tool.this.collapsedNodes)) {
      if (cn.isOutReachable(node)) {
        return true;
      }
    }
    return false;
  }
  private boolean isEdgeHidden(JNEdge edge) {
    boolean sourceOrTargetHidden = GraphViewer_Tool.this.isNodeHidden(edge.from()) || GraphViewer_Tool.this.isNodeHidden(edge.to());
    if (sourceOrTargetHidden) {
      return true;
    }
    return !(GraphViewer_Tool.this.isSelectedInCategoryFilter(edge.kinds()));
  }
  private void setupVertexColor(final JNGraph gr, final PickedState<Object> vertexPicker, final VisualizationViewer vv) {
    if (gr.vertexDrawColor != null || gr.vertexFillColor != null) {
      vv.getRenderContext().setVertexDrawPaintTransformer(new Function<Object, Paint>() {
        public Paint apply(Object n) {
          JNNode node = (JNNode) n;
          if (GraphViewer_Tool.this.isNodeHidden(node)) {
            return new Color(0.0f, 0.0f, 0.0f, 0.0f);
          }
          if (vertexPicker.isPicked(n)) {
            if (gr.isPrimarySelection((node))) {
              return gr.getPrimarSelectionColor();
            }
            return gr.getSecondarySelectionColor();
          } else {
            if (gr.vertexDrawColor != null) {
              return gr.vertexDrawColor.invoke((node));
            } else {
              return gr.vertexFillColor.invoke((node));
            }
          }
        }
      });
    }

    if (gr.vertexFillColor != null) {
      vv.getRenderContext().setVertexFillPaintTransformer(new Function<Object, Paint>() {
        public Paint apply(Object n) {
          JNNode node = (JNNode) n;
          if (GraphViewer_Tool.this.isNodeHidden(node)) {
            return new Color(0.0f, 0.0f, 0.0f, 0.0f);
          }
          return gr.vertexFillColor.invoke((node));
        }
      });
    }

    vv.getRenderContext().setVertexStrokeTransformer(new Function<Object, Stroke>() {
      public Stroke apply(Object v) {
        int strokeWidth = 3;
        if (gr.vertexSize != null) {
          strokeWidth = ((int) (gr.vertexSize.invoke(((JNNode) v)) * 0.175));
        }
        if (strokeWidth < 3) {
          strokeWidth = 3;
        }
        return new BasicStroke(strokeWidth, BasicStroke.CAP_ROUND, BasicStroke.JOIN_BEVEL, 1, null, 0.5f);
      }
    });

  }
  private void setupEdgeStroke(final VisualizationViewer vv, final JNGraph gr) {
    vv.getRenderContext().setEdgeStrokeTransformer(new Function<Object, Stroke>() {
      public Stroke apply(Object edge) {
        float width = 1.2f;
        if (gr.edgeWidth != null) {
          width = gr.edgeWidth.invoke(((JNEdge) edge));
        }
        if (gr.edgeDash != null) {
          int d = gr.edgeDash.invoke(((JNEdge) edge));
          if (d < 0) {
            return new BasicStroke(width, BasicStroke.CAP_ROUND, BasicStroke.JOIN_BEVEL, 1, null, 0.5f);
          } else {
            return new BasicStroke(width, BasicStroke.CAP_ROUND, BasicStroke.JOIN_BEVEL, 1, new float[]{d, d}, 0.5f);
          }
        } else {
          return new BasicStroke(width, BasicStroke.CAP_ROUND, BasicStroke.JOIN_BEVEL, 1, null, 0.5f);
        }
      }
    });
  }
  private void setupEdgeColor(final JNGraph gr, final PickedState<Object> edgePicker, final VisualizationViewer vv) {
    final Color gray = new Color(150, 150, 150);
    Function<Object, Paint> edgePaintTf = new Function<Object, Paint>() {
      public Paint apply(Object e) {
        JNEdge edge = (JNEdge) e;
        if (GraphViewer_Tool.this.isEdgeHidden(edge)) {
          return new Color(0.0f, 0.0f, 0.0f, 0.0f);
        }
        if (edgePicker.isPicked(e)) {
          return gr.getSecondarySelectionColor();
        } else {
          if (gr.edgeColor != null) {
            return gr.edgeColor.invoke((edge));
          } else {
            return gray;
          }
        }
      }
    };
    vv.getRenderContext().setEdgeDrawPaintTransformer(edgePaintTf);
    vv.getRenderContext().setArrowDrawPaintTransformer(edgePaintTf);
    vv.getRenderContext().setArrowFillPaintTransformer(edgePaintTf);
  }
  private boolean isCollapsed(JNNode node) {
    return SetSequence.fromSet(GraphViewer_Tool.this.collapsedNodes).contains(node);
  }
  private void collapseNode(JNNode n) {
    Set<JNNode> c = GraphViewer_Tool.this.collapsedNodes;
    if (n.hasOutEdges()) {
      SetSequence.fromSet(c).addElement(n);
    }
  }
  private void expandNode(JNNode n, boolean oneStep) {
    Set<JNNode> c = GraphViewer_Tool.this.collapsedNodes;
    if (SetSequence.fromSet(c).contains(n)) {
      if (oneStep) {
        Sequence.fromIterable(n.outNeighbors()).visitAll((it) -> GraphViewer_Tool.this.collapseNode(it));
      }
      SetSequence.fromSet(c).removeElement(n);
    }
  }
  private void setupMouseAndKeys(final JNGraph gr, final PickedState<Object> edgePicker, final PickedState<Object> vertexPicker, final VisualizationViewer vv) {
    PluggableGraphMouse pgm = new PluggableGraphMouse();

    pgm.add(new TranslatingGraphMousePlugin());
    pgm.add(new ScalingGraphMousePlugin(new AbsoluteCrossoverScalingControl(), 0, 1.1f, 0.9f));
    pgm.add(new PickingGraphMousePlugin() {
      @Override
      public void mouseClicked(MouseEvent event) {
        Object[] selVertices = vertexPicker.getSelectedObjects();
        Object[] selEdges = edgePicker.getSelectedObjects();
        if (event.getClickCount() == 1) {
          if (selVertices.length > 0) {
            JNNode n = ((JNNode) selVertices[0]);
            edgePicker.clear();
            vertexPicker.clear();
            gr.setPrimarySelectedNode(n);
            highlight(n, vertexPicker, edgePicker, gr);
            vertexPicker.pick(n, true);
          }
        }
        if (event.getClickCount() == 2) {
          if (selEdges.length > 0) {
            JNEdge n = ((JNEdge) selEdges[0]);
            SNodePointer ptr = n.getNodePtr();
            if (ptr != null) {
              GraphViewer_Tool.this.selectNode(ptr);
              return;
            }
          }
          if (selVertices.length > 0) {
            JNNode n = ((JNNode) selVertices[0]);
            GraphViewer_Tool.this.selectNode(n.getNodePtr());
          }
        }

        vv.addKeyListener(new KeyListener() {
          public void keyTyped(KeyEvent p0) {
          }
          public void keyPressed(KeyEvent evt) {
            Object[] selVertices = vertexPicker.getSelectedObjects();
            if (selVertices.length > 0) {
              Object s = selVertices[0];
              if (s instanceof JNNode) {
                JNNode node = ((JNNode) s);
                if (evt.getKeyChar() == 'c') {
                  if (GraphViewer_Tool.this.isCollapsed(node)) {
                    GraphViewer_Tool.this.expandNode(node, true);
                  } else {
                    GraphViewer_Tool.this.collapseNode(node);
                  }
                }
                if (evt.getKeyChar() == 'C') {
                  if (GraphViewer_Tool.this.isCollapsed(node)) {
                    GraphViewer_Tool.this.expandNode(node, false);
                  } else {
                    GraphViewer_Tool.this.collapseNode(node);
                  }
                }
                GraphViewer_Tool.this.repaintGraph();
              }

            }
          }
          public void keyReleased(KeyEvent p0) {
          }
        });


      }

      private void highlight(JNNode n, final PickedState<Object> vertexPicker, final PickedState<Object> edgePicker, final JNGraph gr) {
        JNHighlightMode hm = gr.getHighlightMode();
        if (GraphViewer_Tool.this.selectOut.isSelected()) {
          Sequence.fromIterable(n.outEdges()).visitAll((it) -> {
            edgePicker.pick(it, true);
            if (GraphViewer_Tool.this.selectNodes.isSelected()) {
              vertexPicker.pick(it.to(), true);
            }
            if (GraphViewer_Tool.this.selectTansitively.isSelected()) {
              highlight(it.to(), vertexPicker, edgePicker, gr);
            }
          });
        }

        if (GraphViewer_Tool.this.selectIn.isSelected()) {
          Sequence.fromIterable(n.inEdges()).visitAll((it) -> {
            edgePicker.pick(it, true);
            if (GraphViewer_Tool.this.selectNodes.isSelected()) {
              vertexPicker.pick(it.from(), true);
            }
            if (GraphViewer_Tool.this.selectTansitively.isSelected()) {
              highlight(it.from(), vertexPicker, edgePicker, gr);
            }
          });
        }
      }

    });
    vv.setGraphMouse(pgm);
  }
  /*package*/ boolean isSelectedInCategoryFilter(String[] nodeKinds) {
    if (nodeKinds == null) {
      return true;
    }
    for (String k : nodeKinds) {
      JCheckBox box = MapSequence.fromMap(GraphViewer_Tool.this.filtersMap).get(k);
      if (box == null) {
        return true;
      }
      if (!(box.isSelected())) {
        return false;
      }
    }
    return true;
  }
  private void setupFilterCombo(final JNGraph gr) {
    MapSequence.fromMap(GraphViewer_Tool.this.filtersMap).clear();
    if (GraphViewer_Tool.this.filtersCombo != null) {
      GraphViewer_Tool.this.filterPanel.remove(GraphViewer_Tool.this.filtersCombo);
    }
    List<JCheckBox> boxes = ListSequence.fromList(new ArrayList<JCheckBox>());
    Iterable<String> kinds = Sequence.fromIterable(gr.vertexKinds()).union(Sequence.fromIterable(gr.edgeKinds()));
    for (String k : kinds) {
      JCheckBox cb = new JCheckBox(k, true);
      MapSequence.fromMap(GraphViewer_Tool.this.filtersMap).put(k, cb);
      ListSequence.fromList(boxes).addElement(cb);
    }
    GraphViewer_Tool.this.filtersCombo = new JComboCheckBox(ListSequence.fromList(boxes).toGenericArray(JCheckBox.class));
    GraphViewer_Tool.this.filtersCombo.addActionListener(new ActionListener() {
      public void actionPerformed(ActionEvent p0) {
        if (GraphViewer_Tool.this.filterInvisibleOnly()) {
          GraphViewer_Tool.this.repaintGraph();
        } else {
          GraphViewer_Tool.this.updateGraph();
        }
      }
    });

    GraphViewer_Tool.this.filterPanel.add(GraphViewer_Tool.this.filtersCombo, BorderLayout.CENTER);

    if (GraphViewer_Tool.this.sliderPanel != null) {
      GraphViewer_Tool.this.filterPanel.remove(GraphViewer_Tool.this.sliderPanel);
    }

    GraphViewer_Tool.this.sliderPanel = new JPanel();
    GraphViewer_Tool.this.sliderPanel.setLayout(new BorderLayout());

    final JLabel sliderLabel = new JLabel("   --");

    final Tuples._2<Long, Long> axis = gr.continuousAxisOneValues();
    final JSlider slider = new JSlider();
    int min = (int) ((long) axis._0() / gr.continuousAxisOneCalibrationFactor);
    int max = (int) ((long) axis._1() / gr.continuousAxisOneCalibrationFactor);
    int delta = max - min;
    max = max + ((int) (delta * gr.continuousAxisOneOvermaxFactor));
    slider.setMinimum((min));
    slider.setMaximum(max);
    slider.setSize(200, 10);
    slider.addChangeListener(new ChangeListener() {
      public void stateChanged(ChangeEvent p0) {
        int sliderValue = slider.getValue();
        long mappedValue = sliderValue * gr.continuousAxisOneCalibrationFactor;
        GraphViewer_Tool.this.currentAxisOneThreshold = mappedValue;
        String formatted = gr.continuousAxisOneFormatter.invoke(mappedValue);
        sliderLabel.setText("   " + formatted);
        GraphViewer_Tool.this.repaintGraph();
      }
    });
    slider.setValue(slider.getMaximum());

    GraphViewer_Tool.this.sliderPanel.add(slider, BorderLayout.CENTER);
    GraphViewer_Tool.this.sliderPanel.add(sliderLabel, BorderLayout.SOUTH);

    GraphViewer_Tool.this.filterPanel.add(GraphViewer_Tool.this.sliderPanel, BorderLayout.EAST);

  }
  /*package*/ boolean filterInvisibleOnly() {
    return GraphViewer_Tool.this.filterByHiding.isSelected();
  }
  private void setupFilterPredicates(final VisualizationViewer vv) {
    vv.getRenderContext().setVertexIncludePredicate(new Predicate<Context<Graph<Object, Object>, Object>>() {
      public boolean apply(Context<Graph<Object, Object>, Object> object) {
        if (GraphViewer_Tool.this.filterInvisibleOnly()) {
          return true;
        }
        JNNode node = ((JNNode) object.element);
        return GraphViewer_Tool.this.isSelectedInCategoryFilter(node.kinds());
      }
    });
    vv.getRenderContext().setEdgeIncludePredicate(new Predicate<Context<Graph<Object, Object>, Object>>() {
      public boolean apply(Context<Graph<Object, Object>, Object> object) {
        if (GraphViewer_Tool.this.filterInvisibleOnly()) {
          return true;
        }
        JNEdge edge = ((JNEdge) object.element);
        return GraphViewer_Tool.this.isSelectedInCategoryFilter(edge.kinds());
      }
    });
  }
  public JComponent getComponent() {
    return GraphViewer_Tool.this.mainPanel;
  }
}
