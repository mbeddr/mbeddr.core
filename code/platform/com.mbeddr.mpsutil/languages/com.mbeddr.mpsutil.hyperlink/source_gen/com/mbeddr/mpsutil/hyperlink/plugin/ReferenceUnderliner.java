package com.mbeddr.mpsutil.hyperlink.plugin;

/*Generated by MPS */

import jetbrains.mps.nodeEditor.cells.EditorCell;
import java.lang.ref.WeakReference;
import jetbrains.mps.nodeEditor.EditorComponent;
import java.awt.event.KeyAdapter;
import com.intellij.openapi.util.SystemInfo;
import java.awt.event.KeyEvent;
import java.awt.event.MouseMotionListener;
import java.awt.event.MouseEvent;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.util.ComputeRunnable;
import jetbrains.mps.nodeEditor.cells.APICellAdapter;
import jetbrains.mps.editor.runtime.style.StyleAttributes;
import java.awt.event.FocusListener;
import java.awt.event.FocusEvent;
import java.awt.Cursor;

/**
 * copied from https://github.com/JetBrains/MPS/blob/2022.3/editor/editor-runtime/source/jetbrains/mps/nodeEditor/ReferenceUnderliner.java
 */
public class ReferenceUnderliner {
  private EditorCell myLastReferenceCell;
  private final WeakReference<EditorComponent> myEditorComponent;
  private boolean myIsActive;

  private KeyAdapter keyAdapter = new KeyAdapter() {
    private final int keyCode = (SystemInfo.isMac ? KeyEvent.VK_META : KeyEvent.VK_CONTROL);
    @Override
    public void keyPressed(KeyEvent e) {
      if (e.getKeyCode() == keyCode) {
        myIsActive = true;
        // XXX fwiw, I don't agree we have to react right on key down. IDEA doesn't change
        // cursor until mouse is moved, either.
        setControlOver();
      }
    }
    @Override
    public void keyReleased(KeyEvent e) {
      if (e.getKeyCode() == keyCode) {
        clearControlOver();
        myIsActive = false;
      }
    }
  };

  private MouseMotionListener mouseMotionListener = new MouseMotionListener() {
    @Override
    public void mouseDragged(MouseEvent e) {
    }
    @Override
    public void mouseMoved(MouseEvent e) {
      if (!(getEditorComponent().isFocusOwner())) {
        return;
      }
      if (getEditorComponent().isDisposed()) {
        myLastReferenceCell = null;
        return;
      }
      clearControlOver();
      if (!(myIsActive)) {
        myLastReferenceCell = null;
        return;
      }
      final jetbrains.mps.openapi.editor.cells.EditorCell editorCell = getEditorComponent().getRootCell().findLeaf(e.getX(), e.getY());
      if (editorCell == null) {
        myLastReferenceCell = null;
        return;
      }
      SNode snodeWRTReference;
      final ComputeRunnable<SNode> r = new ComputeRunnable<>(() -> (getEditorComponent().isInvalid() ? null : APICellAdapter.getSNodeWRTReference(editorCell)));
      getEditorComponent().getEditorContext().getRepository().getModelAccess().runReadAction(() -> r.run());
      snodeWRTReference = r.getResult();
      String url = editorCell.getStyle().get(StyleAttributes.URL);
      if (editorCell.getSNode() == snodeWRTReference && url == null) {
        myLastReferenceCell = null;
        return;
      }
      myLastReferenceCell = (EditorCell) editorCell;
      setControlOver();
    }
  };

  private FocusListener focusListener = new FocusListener() {
    @Override
    public void focusGained(FocusEvent e) {
    }
    @Override
    public void focusLost(FocusEvent e) {
      clearControlOver();
      myLastReferenceCell = null;
    }
  };

  public void dispose() {
    getEditorComponent().removeKeyListener(keyAdapter);
    getEditorComponent().removeMouseMotionListener(mouseMotionListener);
    getEditorComponent().removeFocusListener(focusListener);
  }

  public ReferenceUnderliner(EditorComponent editorComponent) {
    myEditorComponent = new WeakReference<>(editorComponent);
    getEditorComponent().addKeyListener(keyAdapter);
    getEditorComponent().addMouseMotionListener(mouseMotionListener);
    getEditorComponent().addFocusListener(focusListener);
  }

  public EditorComponent getEditorComponent() {
    return myEditorComponent.get();
  }

  public void clearControlOver() {
    if (myLastReferenceCell != null) {
      myLastReferenceCell.getStyle().set(StyleAttributes.CONTROL_OVERED_REFERENCE, false);
      getEditorComponent().setCursor(Cursor.getPredefinedCursor(Cursor.DEFAULT_CURSOR));
      getEditorComponent().repaintExternalComponent();
    }
  }

  public void setControlOver() {
    if (myLastReferenceCell != null) {
      myLastReferenceCell.getStyle().set(StyleAttributes.CONTROL_OVERED_REFERENCE, true);
      getEditorComponent().setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));
      getEditorComponent().repaintExternalComponent();
    }
  }

  public jetbrains.mps.openapi.editor.cells.EditorCell getLastReferenceCell() {
    return myLastReferenceCell;
  }

  public void setLastReferenceCell(EditorCell cell) {
    myLastReferenceCell = cell;
  }
}
