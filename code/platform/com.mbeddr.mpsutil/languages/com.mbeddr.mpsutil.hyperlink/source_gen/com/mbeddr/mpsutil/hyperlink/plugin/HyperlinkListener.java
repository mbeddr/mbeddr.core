package com.mbeddr.mpsutil.hyperlink.plugin;

/*Generated by MPS */

import java.awt.event.MouseAdapter;
import java.util.Map;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.WeakHashMap;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import java.lang.ref.WeakReference;
import java.awt.event.MouseEvent;
import com.intellij.openapi.util.SystemInfo;
import jetbrains.mps.nodeEditor.cells.EditorCell;
import com.mbeddr.mpsutil.hyperlink.runtime.HyperlinkHandler;
import org.jetbrains.mps.openapi.model.SNode;
import com.mbeddr.mpsutil.hyperlink.editor.HyperlinkStyle;
import java.util.Objects;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.nodeEditor.cells.APICellAdapter;
import com.mbeddr.mpsutil.hyperlink.runtime.HyperlinkUtil;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.workbench.MPSDataKeys;
import com.intellij.ide.DataManager;
import jetbrains.mps.openapi.navigation.EditorNavigator;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.editor.runtime.style.StyleAttributes;

public class HyperlinkListener extends MouseAdapter {

  private static Map<EditorComponent, HyperlinkListener> instances = MapSequence.fromMap(new WeakHashMap<EditorComponent, HyperlinkListener>());

  public static HyperlinkListener getOrCreateInstance(EditorComponent editorComponent) {
    HyperlinkListener instance = MapSequence.fromMap(instances).get(editorComponent);
    if (instance == null) {
      instance = new HyperlinkListener(editorComponent);
      MapSequence.fromMap(instances).put(editorComponent, instance);
    }
    return instance;
  }
  @Nullable
  public static HyperlinkListener getInstance(EditorComponent editorComponent) {
    return MapSequence.fromMap(instances).get(editorComponent);
  }

  public static void uninstallAll() {
    for (HyperlinkListener instance : ListSequence.fromListWithValues(new ArrayList<HyperlinkListener>(), MapSequence.fromMap(instances).values())) {
      instance.uninstall();
    }
  }

  private WeakReference<EditorComponent> myEditorComponent;
  private ReferenceUnderliner myReferenceUnderliner;

  public HyperlinkListener(EditorComponent editorComponent) {
    myEditorComponent = new WeakReference<EditorComponent>(editorComponent);
    myReferenceUnderliner = new ReferenceUnderliner(editorComponent);

    editorComponent.addDisposeListener(new EditorComponent.EditorDisposeListener() {
      public void editorWillBeDisposed(EditorComponent editorComponent) {
        editorComponent.removeDisposeListener(this);
        uninstall();
      }
    });
  }

  public EditorComponent getEditorComponent() {
    return myEditorComponent.get();
  }

  public void install() {
    getEditorComponent().addMouseListener(this);
    getEditorComponent().addMouseMotionListener(this);
  }

  public void uninstall() {
    getEditorComponent().removeMouseListener(this);
    getEditorComponent().removeMouseMotionListener(this);
    myReferenceUnderliner.dispose();
    MapSequence.fromMap(instances).removeKey(getEditorComponent());
  }

  @Override
  public void mouseMoved(MouseEvent e) {
    if (!(getEditorComponent().isFocusOwner()) || getEditorComponent().isDisposed()) {
      return;
    }
    boolean isCtrlDown = (SystemInfo.isMac ? e.isMetaDown() : e.isControlDown());
    EditorCell myRootCell = getEditorComponent().getRootCell();
    if (myRootCell == null) {
      return;
    }
    final jetbrains.mps.openapi.editor.cells.EditorCell cellAtCursor = myRootCell.findLeaf(e.getX(), e.getY());
    if (cellAtCursor == null) {
      return;
    }
    HyperlinkHandler hyperlinkHandler = getHyperlinkHandler(cellAtCursor);
    SNode hyperlinkNode = getHyperlinkNode(cellAtCursor);
    boolean isHyperlinkReference = isHyperlinkReference(cellAtCursor);
    HyperlinkStyle hyperlinkStyle = getHyperlinkStyle(cellAtCursor);
    if (hyperlinkHandler != null || hyperlinkNode != null || isHyperlinkReference) {
      if (Objects.equals(hyperlinkStyle, HyperlinkStyle.REFERENCE) && !(isCtrlDown)) {
        return;
      }
      final Wrappers._T<SNode> snodeWRTReference = new Wrappers._T<SNode>(null);
      getEditorComponent().getEditorContext().getRepository().getModelAccess().runReadAction(() -> snodeWRTReference.value = (getEditorComponent().isInvalid() ? null : APICellAdapter.getSNodeWRTReference(cellAtCursor)));
      if (isHyperlinkReference && cellAtCursor.getSNode() == snodeWRTReference.value) {
        return;
      }

      myReferenceUnderliner.setLastReferenceCell((EditorCell) cellAtCursor);
      myReferenceUnderliner.setControlOver();
    }
  }

  public boolean isHyperlinkReference(jetbrains.mps.openapi.editor.cells.EditorCell cell) {
    return check_ij1rpp_a0a12(check_ij1rpp_a0a0v(cell));
  }

  public HyperlinkHandler getHyperlinkHandler(jetbrains.mps.openapi.editor.cells.EditorCell cell) {
    return check_ij1rpp_a0a32(check_ij1rpp_a0a0x(cell));
  }

  public HyperlinkStyle getHyperlinkStyle(jetbrains.mps.openapi.editor.cells.EditorCell cell) {
    return check_ij1rpp_a0a52(check_ij1rpp_a0a0z(cell));
  }

  public SNode getHyperlinkNode(jetbrains.mps.openapi.editor.cells.EditorCell cell) {
    return check_ij1rpp_a0a72(check_ij1rpp_a0a0bb(cell));
  }

  public boolean getHyperLinkFocus(jetbrains.mps.openapi.editor.cells.EditorCell cell) {
    return check_ij1rpp_a0a92(check_ij1rpp_a0a0db(cell));
  }

  public boolean getHyperLinkSelect(jetbrains.mps.openapi.editor.cells.EditorCell cell) {
    return check_ij1rpp_a0a13(check_ij1rpp_a0a0fb(cell));
  }

  @Override
  public void mousePressed(MouseEvent e) {
    EditorComponent editorComponent = getEditorComponent();
    if (editorComponent == null) {
      return;
    }

    boolean ctrlDown = (SystemInfo.isMac ? e.isMetaDown() : e.isControlDown());
    jetbrains.mps.openapi.editor.cells.EditorCell cellAtCursor = editorComponent.getRootCell().findLeaf(e.getX(), e.getY());
    HyperlinkStyle hyperlinkStyle = getHyperlinkStyle(cellAtCursor);
    SNode hyperlinkNode = getHyperlinkNode(cellAtCursor);
    boolean gotoLink = (!(Objects.equals(hyperlinkStyle, HyperlinkStyle.REFERENCE)) && !(ctrlDown)) || (Objects.equals(hyperlinkStyle, HyperlinkStyle.REFERENCE) && ctrlDown);
    if (gotoLink) {
      if (cellAtCursor == null) {
        return;
      }
      boolean isHyperlink = isHyperlinkReference(cellAtCursor);
      HyperlinkHandler hyperlinkHandler = getHyperlinkHandler(cellAtCursor);
      if (isHyperlink) {
        editorComponent.goByCurrentReference();
      } else if (hyperlinkHandler != null) {
        hyperlinkHandler.open(HyperlinkUtil.INSTANCE);
      } else if (hyperlinkNode != null) {
        MPSProject mpsProject = MPSDataKeys.MPS_PROJECT.getData(DataManager.getInstance().getDataContext(editorComponent));
        if (mpsProject == null) {
          return;
        }

        new EditorNavigator(mpsProject).shallFocus(getHyperLinkFocus(cellAtCursor)).shallSelect(getHyperLinkSelect(cellAtCursor)).open(SNodeOperations.getPointer(hyperlinkNode));
      }

    }
  }
  private static Boolean check_ij1rpp_a0a12(Style checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get(StyleAttributes.getInstance().<Boolean>getAttribute("com.mbeddr.mpsutil.hyperlink", "hyperlink-reference"));
    }
    return null;
  }
  private static Style check_ij1rpp_a0a0v(jetbrains.mps.openapi.editor.cells.EditorCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getStyle();
    }
    return null;
  }
  private static HyperlinkHandler check_ij1rpp_a0a32(Style checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get(StyleAttributes.getInstance().<HyperlinkHandler>getAttribute("com.mbeddr.mpsutil.hyperlink", "hyperlink-handler"));
    }
    return null;
  }
  private static Style check_ij1rpp_a0a0x(jetbrains.mps.openapi.editor.cells.EditorCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getStyle();
    }
    return null;
  }
  private static HyperlinkStyle check_ij1rpp_a0a52(Style checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get(StyleAttributes.getInstance().<HyperlinkStyle>getAttribute("com.mbeddr.mpsutil.hyperlink", "hyperlink-style"));
    }
    return null;
  }
  private static Style check_ij1rpp_a0a0z(jetbrains.mps.openapi.editor.cells.EditorCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getStyle();
    }
    return null;
  }
  private static SNode check_ij1rpp_a0a72(Style checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get(StyleAttributes.getInstance().<SNode>getAttribute("com.mbeddr.mpsutil.hyperlink", "hyperlink-node"));
    }
    return null;
  }
  private static Style check_ij1rpp_a0a0bb(jetbrains.mps.openapi.editor.cells.EditorCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getStyle();
    }
    return null;
  }
  private static Boolean check_ij1rpp_a0a92(Style checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get(StyleAttributes.getInstance().<Boolean>getAttribute("com.mbeddr.mpsutil.hyperlink", "hyperlink-focus"));
    }
    return null;
  }
  private static Style check_ij1rpp_a0a0db(jetbrains.mps.openapi.editor.cells.EditorCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getStyle();
    }
    return null;
  }
  private static Boolean check_ij1rpp_a0a13(Style checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.get(StyleAttributes.getInstance().<Boolean>getAttribute("com.mbeddr.mpsutil.hyperlink", "hyperlink-select"));
    }
    return null;
  }
  private static Style check_ij1rpp_a0a0fb(jetbrains.mps.openapi.editor.cells.EditorCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getStyle();
    }
    return null;
  }
}
