package com.mbeddr.mpsutil.json.behavior;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import java.util.Set;
import java.util.HashSet;
import java.util.Arrays;
import java.util.List;
import org.jetbrains.mps.openapi.model.SNode;
import com.intellij.openapi.vfs.VirtualFile;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.core.JsonProcessingException;
import java.io.IOException;
import org.jetbrains.annotations.Nullable;
import com.fasterxml.jackson.databind.DeserializationFeature;
import java.util.Iterator;
import java.util.Map;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import com.mbeddr.mpsutil.json.plugin.JsonConfig;
import com.mbeddr.mpsutil.json.plugin.JsonConfigHelper;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.BooleanNode;
import com.fasterxml.jackson.databind.node.TextNode;
import com.fasterxml.jackson.databind.node.JsonNodeFactory;
import java.math.BigDecimal;
import com.fasterxml.jackson.core.JsonFactory;
import com.fasterxml.jackson.databind.ObjectWriter;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;

public class JsonHelper {
  private static final Logger LOG = Logger.getLogger(JsonHelper.class);
  private static final Set<String> EXTENTIONS = new HashSet<String>(Arrays.asList("json", ".json"));

  public static List<SNode> importDirectory(final VirtualFile dir) {
    List<SNode> importedFiles = new ArrayList<SNode>();

    for (VirtualFile file : dir.getChildren()) {
      if (file.isDirectory()) {
        List<SNode> importDirectory = importDirectory(file);
        ListSequence.fromList(importDirectory).visitAll((it) -> SPropertyOperations.assign(it, PROPS.virtualPackage$EkXl, dir.getName() + "." + SPropertyOperations.getString(it, PROPS.virtualPackage$EkXl)));
        ListSequence.fromList(importedFiles).addSequence(ListSequence.fromList(importDirectory));
      } else {
        if (isValidFile(file)) {
          SNode importFile = importFile(file);
          SPropertyOperations.assign(importFile, PROPS.virtualPackage$EkXl, dir.getName());
          ListSequence.fromList(importedFiles).addElement(importFile);
        }
      }
    }
    return importedFiles;
  }

  public static SNode importFile(VirtualFile file) {
    ObjectMapper mapper = new ObjectMapper();
    try {
      JsonNode rootNode = mapper.readTree(file.getInputStream());
      return createJsonFile_hi24x7_a1a1a4(removeFileNameExtension(file.getName()), importJsonObject(rootNode));
    } catch (JsonProcessingException e) {
      if (LOG.isErrorLevel()) {
        LOG.error("couldn't import file " + file.toString(), e);
      }
    } catch (IOException e) {
      if (LOG.isErrorLevel()) {
        LOG.error("IO exception importing file " + file.toString(), e);
      }
    }
    return null;
  }

  @Nullable
  public static SNode importJsonObject(String snippet) {
    ObjectMapper mapper = new ObjectMapper(getFactory());
    mapper.enable(DeserializationFeature.FAIL_ON_TRAILING_TOKENS);

    try {
      return importJsonObject(mapper.readTree(snippet));
    } catch (JsonProcessingException e) {
      if (LOG.isErrorLevel()) {
        LOG.error("", e);
      }
    }
    return null;
  }

  private static SNode importValue(JsonNode jsonNode) {
    if (jsonNode.isObject()) {
      return importJsonObject(jsonNode);
    } else if (jsonNode.isArray()) {
      return importJSONArray(jsonNode);
    } else if (jsonNode.isBoolean()) {
      return createBoolean_hi24x7_a0a1a0i(jsonNode.booleanValue());
    } else if (jsonNode.isNumber()) {
      return createNumber_hi24x7_a0a2a0i(jsonNode.numberValue().toString());
    } else if (jsonNode.isFloatingPointNumber()) {
      return createNumber_hi24x7_a0a3a0i(jsonNode.floatValue() + "");
    } else if (jsonNode.isTextual()) {
      return createString_hi24x7_a0a4a0i(jsonNode.asText());
    } else if (jsonNode.isNull()) {
      return createNull_hi24x7_a0a5a0i();
    } else {
      if (LOG.isErrorLevel()) {
        LOG.error("Cannot import value: " + jsonNode.toString());
      }
    }
    return null;
  }

  private static SNode importJsonObject(JsonNode jsonNode) {
    SNode jsonObject = createJSONObject_hi24x7_a0a0k();
    Iterator<Map.Entry<String, JsonNode>> fieldsIterator = jsonNode.fields();
    while (fieldsIterator.hasNext()) {
      Map.Entry<String, JsonNode> field = fieldsIterator.next();
      ListSequence.fromList(SLinkOperations.getChildren(jsonObject, LINKS.variables$MwtW)).addElement(createVariable_hi24x7_a0a1a2a01(field.getKey(), importValue(field.getValue())));
    }
    return jsonObject;
  }

  private static SNode importJSONArray(JsonNode jsonNode) {
    SNode jsonArray = createArray_hi24x7_a0a0m();
    Iterator<JsonNode> elementsIterator = jsonNode.elements();
    while (elementsIterator.hasNext()) {
      ListSequence.fromList(SLinkOperations.getChildren(jsonArray, LINKS.values$HP$x)).addElement(importValue(elementsIterator.next()));
    }
    return jsonArray;
  }

  public static String removeFileNameExtension(String fileName) {
    int lastIndex = fileName.lastIndexOf('.');
    if (lastIndex != -1) {
      fileName = fileName.substring(0, lastIndex);
    }
    return fileName;
  }

  public static boolean isValidFile(VirtualFile file) {
    return isNotEmptyString(file.getExtension()) && EXTENTIONS.contains(file.getExtension().toLowerCase());
  }

  public static JsonNode getJsonNodeFromFile(SNode file) {
    JsonConfig config = JsonConfigHelper.getConfig();

    return getJsonNodeFromValue(SLinkOperations.getTarget(file, LINKS.object$9ZCo), (config != null ? config.exportNumbersAsText() : false));
  }

  public static JsonNode getJsonNodeFromFile(SNode file, boolean numberAsText) {
    return getJsonNodeFromValue(SLinkOperations.getTarget(file, LINKS.object$9ZCo), numberAsText);
  }

  public static JsonNode getJsonNodeFromValue(SNode value) {
    JsonConfig config = JsonConfigHelper.getConfig();

    return getJsonNodeFromValue(value, (config != null ? config.exportNumbersAsText() : false));
  }

  public static JsonNode getJsonNodeFromValue(SNode value, final boolean numberAsText) {
    ObjectMapper mapper = new ObjectMapper();

    {
      final SNode obj = value;
      if (SNodeOperations.isInstanceOf(obj, CONCEPTS.JSONObject$dl)) {
        final ObjectNode jsonObject = mapper.createObjectNode();
        ListSequence.fromList(SLinkOperations.getChildren(obj, LINKS.variables$MwtW)).visitAll((variable) -> jsonObject.set(SPropertyOperations.getString(variable, PROPS.name$MnvL), getJsonNodeFromValue(SLinkOperations.getTarget(variable, LINKS.value$CK9Q), numberAsText)));
        return jsonObject;
      } else if (SNodeOperations.isInstanceOf(obj, CONCEPTS.Array$BP)) {
        final SNode array = value;

        final ArrayNode arrayNode = mapper.createArrayNode();
        ListSequence.fromList(SLinkOperations.getChildren(array, LINKS.values$HP$x)).visitAll((arrayValue) -> arrayNode.add(getJsonNodeFromValue(arrayValue, numberAsText)));
        return arrayNode;
      }
    }

    return getObjectFromLiteral(value, numberAsText);
  }


  public static JsonNode getObjectFromLiteral(SNode value, boolean numberAsText) {
    {
      final SNode booleanLiteral = value;
      if (SNodeOperations.isInstanceOf(booleanLiteral, CONCEPTS.Boolean$vU)) {
        return BooleanNode.valueOf(SPropertyOperations.getBoolean(booleanLiteral, PROPS.value$HJhx));
      } else if (SNodeOperations.isInstanceOf(booleanLiteral, CONCEPTS.Number$Fg)) {
        final SNode numberLiteral = value;

        if (numberAsText) {
          return TextNode.valueOf(SPropertyOperations.getString(numberLiteral, PROPS.value$Gd4J));
        } else {
          try {
            ObjectMapper mapper = new ObjectMapper();
            return JsonNodeFactory.instance.numberNode(mapper.readValue(SPropertyOperations.getString(numberLiteral, PROPS.value$Gd4J), BigDecimal.class));
          } catch (JsonProcessingException e) {
            return null;
          }
        }
      } else if (SNodeOperations.isInstanceOf(booleanLiteral, CONCEPTS.String$CP)) {
        final SNode stringLiteral = value;

        return TextNode.valueOf((isNotEmptyString(SPropertyOperations.getString(stringLiteral, PROPS.value$Pm4x)) ? SPropertyOperations.getString(stringLiteral, PROPS.value$Pm4x) : ""));
      } else if (SNodeOperations.isInstanceOf(booleanLiteral, CONCEPTS.Null$SO)) {
        final SNode nullLiteral = value;

        return null;
      }
    }

    return null;
  }

  public static JsonFactory getFactory() {
    JsonConfig config = JsonConfigHelper.getConfig();
    if (config != null) {
      return config.getFactory();
    } else {
      return new JsonFactory();
    }
  }

  public static String fileToString(SNode file) {
    return fileToString(file, getFactory());
  }

  public static String fileToString(SNode file, JsonFactory factory) {
    return valueToString(SLinkOperations.getTarget(file, LINKS.object$9ZCo), factory);
  }

  public static String valueToString(SNode value) {
    return valueToString(value, getFactory());
  }

  public static String valueToString(SNode value, JsonFactory factory) {
    ObjectMapper mapper = new ObjectMapper(factory);
    JsonConfig config = JsonConfigHelper.getConfig();
    ObjectWriter writer = (config != null ? config.getWriter(mapper) : mapper.writerWithDefaultPrettyPrinter());
    return valueToString(value, writer);
  }

  public static String valueToString(SNode value, ObjectWriter writer) {
    JsonNode node = JsonHelper.getJsonNodeFromValue(value);
    try {
      return writer.writeValueAsString(node);
    } catch (JsonProcessingException exception) {
      throw new RuntimeException(exception);
    }
  }

  private static SNode createJsonFile_hi24x7_a1a1a4(String p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.JsonFile$j8);
    n0.setProperty(PROPS.name$MnvL, p0);
    n0.forChild(LINKS.object$9ZCo).initNode(p1, CONCEPTS.IValue$ut, true);
    return n0.getResult();
  }
  private static SNode createBoolean_hi24x7_a0a1a0i(boolean p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.Boolean$vU);
    n0.setProperty(PROPS.value$HJhx, "" + (p0));
    return n0.getResult();
  }
  private static SNode createNumber_hi24x7_a0a2a0i(String p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.Number$Fg);
    n0.setProperty(PROPS.value$Gd4J, p0);
    return n0.getResult();
  }
  private static SNode createNumber_hi24x7_a0a3a0i(String p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.Number$Fg);
    n0.setProperty(PROPS.value$Gd4J, p0);
    return n0.getResult();
  }
  private static SNode createString_hi24x7_a0a4a0i(String p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.String$CP);
    n0.setProperty(PROPS.value$Pm4x, p0);
    return n0.getResult();
  }
  private static SNode createNull_hi24x7_a0a5a0i() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.Null$SO);
    return n0.getResult();
  }
  private static SNode createJSONObject_hi24x7_a0a0k() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.JSONObject$dl);
    return n0.getResult();
  }
  private static SNode createVariable_hi24x7_a0a1a2a01(String p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.Variable$dO);
    n0.setProperty(PROPS.name$MnvL, p0);
    n0.forChild(LINKS.value$CK9Q).initNode(p1, CONCEPTS.IValue$ut, true);
    return n0.getResult();
  }
  private static SNode createArray_hi24x7_a0a0m() {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.Array$BP);
    n0.forChild(LINKS.values$HP$x).initNull();
    return n0.getResult();
  }
  private static boolean isNotEmptyString(String str) {
    return str != null && str.length() > 0;
  }

  private static final class PROPS {
    /*package*/ static final SProperty virtualPackage$EkXl = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x10802efe25aL, 0x115eca8579fL, "virtualPackage");
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
    /*package*/ static final SProperty value$HJhx = MetaAdapterFactory.getProperty(0xb5c0bb04c5834b2aL, 0xa66e1eab92d33c68L, 0x3c445779c2b0d5eaL, 0x3c445779c2b0d5edL, "value");
    /*package*/ static final SProperty value$Gd4J = MetaAdapterFactory.getProperty(0xb5c0bb04c5834b2aL, 0xa66e1eab92d33c68L, 0x3c445779c2b0d6d0L, 0x6a20681bcbe39851L, "value");
    /*package*/ static final SProperty value$Pm4x = MetaAdapterFactory.getProperty(0xb5c0bb04c5834b2aL, 0xa66e1eab92d33c68L, 0x3c445779c2b0d6cbL, 0x3c445779c2b0d6ceL, "value");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink variables$MwtW = MetaAdapterFactory.getContainmentLink(0xb5c0bb04c5834b2aL, 0xa66e1eab92d33c68L, 0x3c445779c2b0d576L, 0x3c445779c2b0d6c9L, "variables");
    /*package*/ static final SContainmentLink values$HP$x = MetaAdapterFactory.getContainmentLink(0xb5c0bb04c5834b2aL, 0xa66e1eab92d33c68L, 0x3c445779c2b0d5efL, 0x3c445779c2b0d5f2L, "values");
    /*package*/ static final SContainmentLink object$9ZCo = MetaAdapterFactory.getContainmentLink(0xb5c0bb04c5834b2aL, 0xa66e1eab92d33c68L, 0x3c445779c2b1d3e3L, 0x3c445779c2b1d3feL, "object");
    /*package*/ static final SContainmentLink value$CK9Q = MetaAdapterFactory.getContainmentLink(0xb5c0bb04c5834b2aL, 0xa66e1eab92d33c68L, 0x3c445779c2b0d577L, 0x3c445779c2b0d5e8L, "value");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept JSONObject$dl = MetaAdapterFactory.getConcept(0xb5c0bb04c5834b2aL, 0xa66e1eab92d33c68L, 0x3c445779c2b0d576L, "com.mbeddr.mpsutil.json.structure.JSONObject");
    /*package*/ static final SConcept Array$BP = MetaAdapterFactory.getConcept(0xb5c0bb04c5834b2aL, 0xa66e1eab92d33c68L, 0x3c445779c2b0d5efL, "com.mbeddr.mpsutil.json.structure.Array");
    /*package*/ static final SConcept Boolean$vU = MetaAdapterFactory.getConcept(0xb5c0bb04c5834b2aL, 0xa66e1eab92d33c68L, 0x3c445779c2b0d5eaL, "com.mbeddr.mpsutil.json.structure.Boolean");
    /*package*/ static final SConcept Number$Fg = MetaAdapterFactory.getConcept(0xb5c0bb04c5834b2aL, 0xa66e1eab92d33c68L, 0x3c445779c2b0d6d0L, "com.mbeddr.mpsutil.json.structure.Number");
    /*package*/ static final SConcept String$CP = MetaAdapterFactory.getConcept(0xb5c0bb04c5834b2aL, 0xa66e1eab92d33c68L, 0x3c445779c2b0d6cbL, "com.mbeddr.mpsutil.json.structure.String");
    /*package*/ static final SConcept Null$SO = MetaAdapterFactory.getConcept(0xb5c0bb04c5834b2aL, 0xa66e1eab92d33c68L, 0x3c445779c2b0d6d7L, "com.mbeddr.mpsutil.json.structure.Null");
    /*package*/ static final SConcept JsonFile$j8 = MetaAdapterFactory.getConcept(0xb5c0bb04c5834b2aL, 0xa66e1eab92d33c68L, 0x3c445779c2b1d3e3L, "com.mbeddr.mpsutil.json.structure.JsonFile");
    /*package*/ static final SInterfaceConcept IValue$ut = MetaAdapterFactory.getInterfaceConcept(0xb5c0bb04c5834b2aL, 0xa66e1eab92d33c68L, 0x3c445779c2b0d5e7L, "com.mbeddr.mpsutil.json.structure.IValue");
    /*package*/ static final SConcept Variable$dO = MetaAdapterFactory.getConcept(0xb5c0bb04c5834b2aL, 0xa66e1eab92d33c68L, 0x3c445779c2b0d577L, "com.mbeddr.mpsutil.json.structure.Variable");
  }
}
