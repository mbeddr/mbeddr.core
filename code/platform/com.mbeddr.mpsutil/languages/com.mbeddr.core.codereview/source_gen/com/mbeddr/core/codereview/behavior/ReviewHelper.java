package com.mbeddr.core.codereview.behavior;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import de.itemis.mps.utils.serializer.xml.serializer.NodeSerializer;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.IAttributeDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import com.mbeddr.core.base.enumMigration.CodeState_MigrationUtils;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SProperty;

public class ReviewHelper {

  private static String getSerializedSubtreePrivate(SNode n) {
    return new NodeSerializer(n, true, "__", true).getXMLAsString();
  }

  public static String getSerializedSubtree(SNode n) {
    SNode r = null;
    if (new IAttributeDescriptor.NodeAttribute(CONCEPTS.CodeReviewData$wx).get(n) != null) {
      r = new IAttributeDescriptor.NodeAttribute(CONCEPTS.CodeReviewData$wx).get(n);
      SNodeOperations.deleteNode(new IAttributeDescriptor.NodeAttribute(CONCEPTS.CodeReviewData$wx).get(n));
    }

    String res = getSerializedSubtreePrivate(n);

    if (r != null) {
      new IAttributeDescriptor.NodeAttribute(CONCEPTS.CodeReviewData$wx).set(n, r);
    }

    return res;
  }

  public static int getSubtreeHash(SNode n) {
    return getSerializedSubtree(n).hashCode();
  }


  private static SNode findReviewedParent(SNode n) {
    SNode parent = n;

    while (parent != null) {
      if (new IAttributeDescriptor.NodeAttribute(CONCEPTS.CodeReviewData$wx).get(parent) != null) {
        return parent;
      }
      parent = SNodeOperations.getParent(parent);
    }

    return null;
  }

  public static SNode findReviewData(SNode n) {
    SNode parent = findReviewedParent(n);
    if (parent == null) {
      return null;
    }
    return new IAttributeDescriptor.NodeAttribute(CONCEPTS.CodeReviewData$wx).get(parent);
  }


  /**
   * itself or parent
   */
  public static boolean hasBeenReviewed(SNode n) {
    return findReviewData(n) != null;
  }


  /**
   * itself or parent
   */
  public static boolean hasValidReview(SNode n) {
    SNode d = findReviewData(n);
    if (d == null) {
      return false;
    }
    return SPropertyOperations.getBoolean(d, PROPS.reviewIsCurrent$axq8);
  }

  public static boolean isRaw(SNode n) {
    SNode d = findReviewData(n);
    if (d != null) {
      return CodeState_MigrationUtils.value(SPropertyOperations.getEnum(d, PROPS.codeState$2ZUe)).toString().contentEquals("raw");
    }
    return false;
  }
  public static boolean isReady(SNode n) {
    SNode d = findReviewData(n);
    if (d != null) {
      return CodeState_MigrationUtils.value(SPropertyOperations.getEnum(d, PROPS.codeState$2ZUe)).toString().contentEquals("ready");
    }
    return false;
  }
  public static boolean isReviewed(SNode n) {
    SNode d = findReviewData(n);
    if (d != null) {
      return CodeState_MigrationUtils.value(SPropertyOperations.getEnum(d, PROPS.codeState$2ZUe)).toString().contentEquals("reviewed");
    }
    return false;
  }

  public static void reevaluateReviewData(SNode n) {
    SNode parent = findReviewedParent(n);
    if (parent == null) {
      return;
    }

    int curHash = getSubtreeHash(parent);

    boolean b = SPropertyOperations.getInteger(new IAttributeDescriptor.NodeAttribute(CONCEPTS.CodeReviewData$wx).get(parent), PROPS.lastReviewHash$sE0_) == curHash;
    SPropertyOperations.assign(new IAttributeDescriptor.NodeAttribute(CONCEPTS.CodeReviewData$wx).get(parent), PROPS.reviewIsCurrent$axq8, b);
    if (!(b)) {
      SPropertyOperations.assignEnum(new IAttributeDescriptor.NodeAttribute(CONCEPTS.CodeReviewData$wx).get(parent), PROPS.lastReviewState$qgfg, SPropertyOperations.getEnum(new IAttributeDescriptor.NodeAttribute(CONCEPTS.CodeReviewData$wx).get(parent), PROPS.codeState$2ZUe));
      SPropertyOperations.assignEnum(new IAttributeDescriptor.NodeAttribute(CONCEPTS.CodeReviewData$wx).get(parent), PROPS.codeState$2ZUe, CodeState_MigrationUtils.fromValue("raw"));
    } else {
      SPropertyOperations.assignEnum(new IAttributeDescriptor.NodeAttribute(CONCEPTS.CodeReviewData$wx).get(parent), PROPS.codeState$2ZUe, SPropertyOperations.getEnum(new IAttributeDescriptor.NodeAttribute(CONCEPTS.CodeReviewData$wx).get(parent), PROPS.lastReviewState$qgfg));
    }
  }

  public static void updateReviewData(SNode n) {
    if (n == null) {
      return;
    }
    if (new IAttributeDescriptor.NodeAttribute(CONCEPTS.CodeReviewData$wx).get(n) != null) {
      SNodeOperations.deleteNode(new IAttributeDescriptor.NodeAttribute(CONCEPTS.CodeReviewData$wx).get(n));
    }
    ListSequence.fromList(SNodeOperations.getNodeDescendants(n, CONCEPTS.CodeReviewData$wx, false, new SAbstractConcept[]{})).visitAll((it) -> SNodeOperations.deleteNode(it));
    SNode d = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x7d323e6183584656L, 0xa071a2bb68438615L, 0x44050902b3ce42a4L, "com.mbeddr.core.codereview.structure.CodeReviewData"));
    SPropertyOperations.assign(d, PROPS.lastReviewHash$sE0_, getSubtreeHash(n));
    SPropertyOperations.assign(d, PROPS.lastReviewTimestamp$ssRH, System.currentTimeMillis() + "");
    SPropertyOperations.assign(d, PROPS.lastReviewReviewer$syY7, System.getProperty("user.name"));
    SPropertyOperations.assign(d, PROPS.reviewIsCurrent$axq8, true);
    new IAttributeDescriptor.NodeAttribute(CONCEPTS.CodeReviewData$wx).set(n, d);
  }

  public static void setRawCodeState(SNode n) {
    updateReviewData(n);
  }
  public static void setReadyCodeState(SNode n) {
    updateReviewData(n);
  }
  public static void setReviewedCodeState(SNode n) {
    updateReviewData(n);
  }

  public static boolean isReviewable(SNode n) {
    if (SNodeOperations.isInstanceOf(n, CONCEPTS.IEmpty$6_)) {
      return false;
    }
    if (SNodeOperations.isInstanceOf(n, CONCEPTS.Chunk$sT)) {
      return true;
    }
    if (SNodeOperations.isInstanceOf(SNodeOperations.getParent(n), CONCEPTS.Chunk$sT)) {
      return true;
    }
    return false;
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept CodeReviewData$wx = MetaAdapterFactory.getConcept(0x7d323e6183584656L, 0xa071a2bb68438615L, 0x44050902b3ce42a4L, "com.mbeddr.core.codereview.structure.CodeReviewData");
    /*package*/ static final SInterfaceConcept IEmpty$6_ = MetaAdapterFactory.getInterfaceConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0xe900768cf47dcc3L, "com.mbeddr.core.base.structure.IEmpty");
    /*package*/ static final SConcept Chunk$sT = MetaAdapterFactory.getConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x6315bcc6effb4ea6L, "com.mbeddr.core.base.structure.Chunk");
  }

  private static final class PROPS {
    /*package*/ static final SProperty reviewIsCurrent$axq8 = MetaAdapterFactory.getProperty(0x7d323e6183584656L, 0xa071a2bb68438615L, 0x44050902b3ce42a4L, 0x44050902b3d6a6d2L, "reviewIsCurrent");
    /*package*/ static final SProperty codeState$2ZUe = MetaAdapterFactory.getProperty(0x7d323e6183584656L, 0xa071a2bb68438615L, 0x44050902b3ce42a4L, 0x176971d2d0c157b7L, "codeState");
    /*package*/ static final SProperty lastReviewHash$sE0_ = MetaAdapterFactory.getProperty(0x7d323e6183584656L, 0xa071a2bb68438615L, 0x44050902b3ce42a4L, 0x44050902b3d2d810L, "lastReviewHash");
    /*package*/ static final SProperty lastReviewState$qgfg = MetaAdapterFactory.getProperty(0x7d323e6183584656L, 0xa071a2bb68438615L, 0x44050902b3ce42a4L, 0x3e105d72d415826L, "lastReviewState");
    /*package*/ static final SProperty lastReviewTimestamp$ssRH = MetaAdapterFactory.getProperty(0x7d323e6183584656L, 0xa071a2bb68438615L, 0x44050902b3ce42a4L, 0x44050902b3d2d802L, "lastReviewTimestamp");
    /*package*/ static final SProperty lastReviewReviewer$syY7 = MetaAdapterFactory.getProperty(0x7d323e6183584656L, 0xa071a2bb68438615L, 0x44050902b3ce42a4L, 0x44050902b3d2d807L, "lastReviewReviewer");
  }
}
