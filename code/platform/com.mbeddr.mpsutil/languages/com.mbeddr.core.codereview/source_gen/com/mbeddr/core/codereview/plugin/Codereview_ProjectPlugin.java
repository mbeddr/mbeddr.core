package com.mbeddr.core.codereview.plugin;

/*Generated by MPS */

import com.mbeddr.mpsutil.spreferences.runtime.SPreferencesProjectPlugin;
import java.util.List;
import jetbrains.mps.plugins.prefs.BaseProjectPrefsComponent;
import com.intellij.openapi.project.Project;
import java.util.ArrayList;
import com.mbeddr.mpsutil.spreferences.runtime.SPreferencesModelFactory;
import org.jetbrains.mps.openapi.model.SModel;
import com.mbeddr.mpsutil.spreferences.runtime.PreferenceModules;
import com.mbeddr.mpsutil.spreferences.runtime.SPreferencesUtil;
import jetbrains.mps.smodel.ModuleRepositoryFacade;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.smodel.Language;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.project.Solution;
import org.jetbrains.mps.openapi.model.EditableSModel;
import com.mbeddr.mpsutil.spreferences.runtime.SPrefererencesComponent;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class Codereview_ProjectPlugin extends SPreferencesProjectPlugin {

  @Override
  protected List<BaseProjectPrefsComponent> createPreferencesComponents(final Project project) {
    List<BaseProjectPrefsComponent> components = new ArrayList<BaseProjectPrefsComponent>();

    SPreferencesModelFactory factory = new SPreferencesModelFactory() {
      public SModel getModel(final jetbrains.mps.project.Project mpsProject) {
        String id = "CodeReviewPreferences";
        String title = "Code Review Preferences";
        String modelName = PreferenceModules.getModelName(mpsProject, false, id);
        String folder = PreferenceModules.getFolder(mpsProject, id, false, false);
        final SModel model = PreferenceModules.getModel(folder, modelName, mpsProject);

        mpsProject.getRepository().getModelAccess().executeCommand(new Runnable() {
          public void run() {
            SPreferencesUtil.useLanguage(model, ModuleRepositoryFacade.getInstance().getModule(PersistenceFacade.getInstance().createModuleReference("7d323e61-8358-4656-a071-a2bb68438615(com.mbeddr.core.codereview)"), Language.class), mpsProject);

            List<SNode> pageNodes = SModelOperations.roots(model, CONCEPTS.CodeReviewConfig$3S);
            boolean isInit = pageNodes.isEmpty();
            SNode pageNode = (isInit ? null : pageNodes.get(0));
            if (isInit) {
              pageNode = SConceptOperations.createNewNode(SNodeOperations.asInstanceConcept(CONCEPTS.CodeReviewConfig$3S));
              SModelOperations.addRootNode(model, pageNode);
            }

            initUpdate(isInit, pageNode, mpsProject);

            Solution solution = ((Solution) model.getModule());
            if (solution.isChanged() && !(solution.isReadOnly())) {
              solution.save();
            }

            EditableSModel editableModel = ((EditableSModel) model);
            if (editableModel.isChanged() && !(editableModel.isReadOnly())) {
              editableModel.save();
            }
          }
          public void initUpdate(boolean isInit, SNode node, jetbrains.mps.project.Project project) {
          }
        });

        return model;
      }
    };
    components.add(new SPrefererencesComponent(project, "Code Review Preferences", Codereview_ProjectPlugin.this.getClass().getName(), factory) {
      @Override
      protected boolean enabled(jetbrains.mps.project.Project project) {
        return Codereview_ProjectPlugin.this.enabled(project);
      }

      protected SAbstractConcept getRootConcept() {
        return CONCEPTS.CodeReviewConfig$3S;
      }
    });

    return components;
  }


  private static final class CONCEPTS {
    /*package*/ static final SConcept CodeReviewConfig$3S = MetaAdapterFactory.getConcept(0x7d323e6183584656L, 0xa071a2bb68438615L, 0x4139e20f93ffd9fL, "com.mbeddr.core.codereview.structure.CodeReviewConfig");
  }
}
