package com.mbeddr.mpsutil.rcp.runtime;

/*Generated by MPS */

import com.intellij.openapi.ui.DialogWrapper;
import jetbrains.mps.project.Project;
import jetbrains.mps.project.AbstractModule;
import org.jetbrains.mps.openapi.model.SModel;
import javax.swing.JTextField;
import javax.swing.JComboBox;
import javax.swing.JPanel;
import java.awt.BorderLayout;
import java.util.List;
import javax.swing.JCheckBox;
import java.util.ArrayList;
import java.util.Map;
import jetbrains.mps.project.DevKit;
import java.util.TreeMap;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.ide.project.ProjectHelper;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.VisibleModuleRegistry;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.Set;
import java.util.Iterator;
import com.intellij.uiDesigner.core.GridLayoutManager;
import com.intellij.uiDesigner.core.GridConstraints;
import javax.swing.DefaultComboBoxModel;
import org.jetbrains.mps.openapi.persistence.ModelRoot;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.extapi.persistence.FileBasedModelRoot;
import javax.swing.DefaultListCellRenderer;
import java.awt.Component;
import javax.swing.JList;
import java.awt.event.ItemListener;
import java.awt.event.ItemEvent;
import jetbrains.mps.persistence.DefaultModelRoot;
import java.awt.Dimension;
import javax.swing.JLabel;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;
import com.intellij.ui.ColoredListCellRenderer;
import org.jetbrains.mps.openapi.persistence.ModelFactory;
import org.jetbrains.annotations.Nullable;
import javax.swing.JComponent;
import jetbrains.mps.smodel.LanguageAspect;
import javax.lang.model.SourceVersion;
import jetbrains.mps.smodel.ModelAccessHelper;
import jetbrains.mps.util.Computable;
import org.jetbrains.mps.openapi.model.EditableSModel;
import org.jetbrains.mps.openapi.model.SModelName;
import jetbrains.mps.persistence.ModelCannotBeCreatedException;
import jetbrains.mps.smodel.ModelImports;
import jetbrains.mps.ide.ui.dialogs.properties.MPSPropertiesConfigurable;
import jetbrains.mps.ide.ui.dialogs.properties.ModelPropertiesConfigurable;
import com.intellij.openapi.options.ex.SingleConfigurableEditor;
import javax.swing.SwingUtilities;
import org.jetbrains.mps.openapi.persistence.datasource.DataSourceType;
import org.jetbrains.mps.openapi.persistence.datasource.FileExtensionDataSourceType;
import jetbrains.mps.extapi.persistence.ModelFactoryService;

public class NewModelDialogBase extends DialogWrapper {
  private Project myProject;
  private AbstractModule myModule;
  private String myNamespace;
  private SModel myResult;
  private JTextField myModelName;
  private JComboBox myModelRoots = new JComboBox();
  private JComboBox myModelStorageFormat = new JComboBox();
  private JPanel myPanel = new JPanel(new BorderLayout());
  private List<JCheckBox> myDevkitBoxes = new ArrayList<JCheckBox>();
  private Map<String, DevKit> myDevkitsByName = new TreeMap<String, DevKit>();
  private List<DevKit> myMandantoryDevKits = ListSequence.fromList(new ArrayList<DevKit>());
  private final NewModelDialogProperties myProperties;

  public NewModelDialogBase(Project project, AbstractModule module, String namespace, String stereotype, NewModelDialogProperties properties) {
    super(ProjectHelper.toIdeaProject(project));
    setTitle(properties.getCaption());
    myProject = project;
    myModule = module;
    myNamespace = namespace;
    myProperties = properties;
    init();
    initPanel();
  }

  private void initPanel() {
    JPanel mainpanel = createPanel();

    myPanel.add(mainpanel, BorderLayout.CENTER);
  }
  @Override
  protected void init() {
    super.init();
    Iterable<SModule> projectModules = getProjectModules();
    final VisibleModuleRegistry registry = VisibleModuleRegistry.getInstance();

    Iterable<DevKit> visibleDevKits = Sequence.fromIterable(projectModules).ofType(DevKit.class).where((it) -> registry.isVisible(it));

    for (DevKit devkit : Sequence.fromIterable(visibleDevKits)) {
      if (this.myProperties.getMandantoryDevKitsFilter().met(devkit)) {
        ListSequence.fromList(myMandantoryDevKits).addElement(devkit);
      } else if (this.myProperties.getOptionalDevKitsFilter() != null && this.myProperties.getOptionalDevKitsFilter().met(devkit)) {
        this.addDevKit(devkit);
      }
    }
  }

  protected void addDevKit(DevKit devkit) {
    myDevkitsByName.put(devkit.getModuleName(), devkit);
  }

  protected Set<String> getAllDevKitNames() {
    return myDevkitsByName.keySet();
  }

  protected DevKit getDevKit(String name) {
    return myDevkitsByName.get(name);
  }

  protected void addCheckBox(JCheckBox box) {
    myDevkitBoxes.add(box);
  }
  protected final Iterable<SModule> getProjectModules() {
    // return myProject.getRepository().getModules();
    // wrap into Iterable to ensure lazy construction of module sequence.
    // getModules operation requires read access, but I don't see a reason to
    // move creation of conditional sequence into a read runnable.
    return new Iterable<SModule>() {
      @Override
      public Iterator<SModule> iterator() {
        return myProject.getRepository().getModules().iterator();
      }
    };
  }

  protected JPanel createDevKitPanel() {
    JPanel devkitPanle = new JPanel(new GridLayoutManager(6, (myDevkitsByName.keySet().size() / 6) + 1));
    GridConstraints constrain = new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_NORTHWEST, GridConstraints.FILL_HORIZONTAL, GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED, null, null, null);
    int i = 0;
    for (String devkit : getAllDevKitNames()) {
      JCheckBox box = new JCheckBox(devkit);
      addCheckBox(box);
      devkitPanle.add(box, constrain);
      i++;
      constrain.setRow(i % 6);
      constrain.setColumn(i / 6);
    }
    return devkitPanle;
  }

  protected JPanel createPanel() {
    boolean rootsVisible = false;
    DefaultComboBoxModel model = new DefaultComboBoxModel();
    for (ModelRoot root : myModule.getModelRoots()) {
      if (root.canCreateModels()) {
        model.addElement(root);
      } else
      if (myModule instanceof Language && root instanceof FileBasedModelRoot) {
        // Can fix only FileBased model root (default for language)
        model.addElement(root);
      }
    }

    if (model.getSize() == 0) {
      model.addElement("<NO MODEL ROOTS FOR SELECTED NAMESPACE>");
    }
    myModelRoots.setRenderer(new DefaultListCellRenderer() {
      @Override
      public Component getListCellRendererComponent(JList list, Object object, int i, boolean b, boolean b1) {
        if (object instanceof ModelRoot) {
          object = ((ModelRoot) object).getPresentation();
        }
        return super.getListCellRendererComponent(list, object, i, b, b1);
      }
    });
    myModelRoots.addItemListener(new ItemListener() {
      @Override
      public void itemStateChanged(ItemEvent e) {
        check();
        myModelStorageFormat.setVisible(myModelRoots.getSelectedItem() instanceof DefaultModelRoot);
      }
    });
    myModelRoots.setModel(model);

    if (model.getSize() > 1) {
      rootsVisible = false;
    }


    GridConstraints constrain;
    constrain = new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_NORTHWEST, GridConstraints.FILL_HORIZONTAL, GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED, null, null, null);
    JPanel mainpanel = new JPanel(new GridLayoutManager((rootsVisible ? 8 : 6), 1));
    mainpanel.setPreferredSize(new Dimension(400, 50));
    mainpanel.add(new JLabel("Model Name:"), constrain);

    constrain.setRow(constrain.getRow() + 1);
    myModelName = new JTextField(myNamespace.length() + 20);
    myModelName.setText((myNamespace.length() == 0 ? myNamespace : myNamespace + "."));
    mainpanel.add(myModelName, constrain);
    myModelName.addKeyListener(new KeyAdapter() {
      @Override
      public void keyReleased(KeyEvent event) {
        check();
      }
    });
    constrain.setRow(constrain.getRow() + 1);
    if (hasOptionalDevKits()) {
      mainpanel.add(new JLabel("Use DevKits:"), constrain);
      constrain.setRow(constrain.getRow() + 1);
      mainpanel.add(createDevKitPanel(), constrain);
    }

    if (rootsVisible) {
      constrain.setRow(constrain.getRow() + 1);
      mainpanel.add(new JLabel("Model root:"), constrain);
      constrain.setRow(constrain.getRow() + 1);
      mainpanel.add(myModelRoots, constrain);
    }

    if (myProperties.isUserCanSelectPersistence()) {
      constrain.setRow(constrain.getRow() + 1);
      mainpanel.add(new JLabel("Storage format:"), constrain);
      constrain.setRow(constrain.getRow() + 1);
      myModelStorageFormat.setModel(new DefaultComboBoxModel(getStorageFormats()));
      myModelStorageFormat.setRenderer(new ColoredListCellRenderer() {
        protected void customizeCellRenderer(JList p0, Object p1, int p2, boolean p3, boolean p4) {
          if (!(p1 instanceof ModelFactory)) {
            return;
          }
          append(((ModelFactory) p1).getType().getFormatTitle());
        }
      });
      myModelStorageFormat.setSelectedItem(getFactoryFromProperties());
      mainpanel.add(myModelStorageFormat, constrain);
    }
    return mainpanel;
  }
  private boolean hasOptionalDevKits() {
    return myProperties.getOptionalDevKitsFilter() != null && myDevkitsByName.size() > 0;
  }
  @Nullable
  @Override
  protected JComponent createCenterPanel() {
    return myPanel;
  }

  public SModel getResult() {
    return myResult;
  }
  private boolean check() {
    Object selected = myModelRoots.getSelectedItem();
    if (!(selected instanceof ModelRoot)) {
      setErrorText("Model root is not selected");
      return false;
    }
    ModelRoot mr = ((ModelRoot) selected);
    String modelName = myModelName.getText();
    if (modelName.length() == 0) {
      setErrorText("Empty model name isn't allowed");
      return false;
    }
    if (modelName.lastIndexOf(".") == modelName.length()) {
      setErrorText("Empty model short name isn't allowed");
      return false;
    }
    if (myModule instanceof Language) {
      for (LanguageAspect aspect : LanguageAspect.values()) {
        String shortName = modelName.substring(modelName.lastIndexOf(".") + 1);
        if (shortName.equals(aspect.getName())) {
          setErrorText("This name isn't allowed because '" + shortName + "' is language aspect name");
          return false;
        }
      }
    }

    if (!(SourceVersion.isName(modelName))) {
      setErrorText("Model name should be valid Java package");
      return false;
    }
    if (!(mr.canCreateModels())) {
      setErrorText("Can't create a model under this model root");
      return false;
    }
    if (!(mr.canCreateModel(getFqName())) && !(myModule instanceof Language)) {
      setErrorText("Can't create a model with this name under this model root");
      return false;
    }
    if (!(mr.canCreateModel(getFqName())) && myModule instanceof Language && !(mr instanceof FileBasedModelRoot)) {
      setErrorText("Can't create a model with this name under this model root");
      return false;
    }
    setErrorText(null);
    return true;
  }
  @Override
  protected void doOKAction() {
    if (!(check())) {
      return;
    }

    myResult = new ModelAccessHelper(myProject.getModelAccess()).executeCommand(new Computable<SModel>() {
      @Override
      public SModel compute() {
        String fqName = getFqName();
        ModelRoot mr = (ModelRoot) myModelRoots.getSelectedItem();
        EditableSModel result;
        try {
          if (mr instanceof DefaultModelRoot) {
            ModelFactory factory;
            if (myProperties.isUserCanSelectPersistence()) {
              factory = (ModelFactory) myModelStorageFormat.getSelectedItem();
            } else {
              factory = getFactoryFromProperties();
            }
            result = ((EditableSModel) ((DefaultModelRoot) mr).createModel(new SModelName(fqName), null, null, factory.getType()));
          } else {
            result = (EditableSModel) mr.createModel(fqName);
          }
        } catch (ModelCannotBeCreatedException e) {
          return null;
        }
        final ModelImports mi = new ModelImports(result);
        for (DevKit devkit : ListSequence.fromList(myMandantoryDevKits)) {
          mi.addUsedDevKit(devkit.getModuleReference());
        }

        for (JCheckBox box : ListSequence.fromList(myDevkitBoxes)) {
          if (box.isSelected()) {
            mi.addUsedDevKit(getDevKit(box.getText()).getModuleReference());
          }
        }
        // FIXME decide if ModelsAutoImportsManager and MissingDependenciesFixer are necessary
        result.save();
        return result;
      }
    });
    assert myResult != null;

    if (myProperties.isShowModelPropertiesAfterCreation()) {
      MPSPropertiesConfigurable configurable = new ModelPropertiesConfigurable(myResult, myProject);
      final SingleConfigurableEditor configurableEditor = new SingleConfigurableEditor(ProjectHelper.toIdeaProject(myProject), configurable, "#MPSPropertiesConfigurable");
      SwingUtilities.invokeLater(new Runnable() {
        @Override
        public void run() {
          configurableEditor.show();
        }
      });
    }

    super.doOKAction();
  }


  private String getFqName() {
    String stereo = "";
    return myModelName.getText() + ((stereo != null && stereo.length() > 0 ? "@" + stereo : ""));
  }

  private ModelFactory getFactoryFromProperties() {
    DataSourceType dst = FileExtensionDataSourceType.of(myProperties.getDefaultPersistenceID());
    return myProject.getComponent(ModelFactoryService.class).getDefaultModelFactory(dst);
  }

  private ModelFactory[] getStorageFormats() {
    List<ModelFactory> list = myProject.getComponent(ModelFactoryService.class).getFactories();
    return list.toArray(new ModelFactory[list.size()]);
  }
}
