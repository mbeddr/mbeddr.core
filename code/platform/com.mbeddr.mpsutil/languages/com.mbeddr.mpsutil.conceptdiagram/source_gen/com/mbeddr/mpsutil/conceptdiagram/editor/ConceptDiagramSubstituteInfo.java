package com.mbeddr.mpsutil.conceptdiagram.editor;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.cells.SubstituteInfo;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.List;
import jetbrains.mps.openapi.editor.cells.SubstituteAction;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPointerOperations;
import jetbrains.mps.smodel.SNodePointer;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.mps.openapi.language.SLanguage;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import java.util.LinkedList;
import jetbrains.mps.lang.smodel.behavior.LanguageIdentity__BehaviorDescriptor;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;

public class ConceptDiagramSubstituteInfo implements SubstituteInfo {
  private SNode diagram;

  private String originalText;
  private List<SubstituteAction> actions = ListSequence.fromList(new ArrayList<SubstituteAction>());

  public ConceptDiagramSubstituteInfo(final SNode diagram, SRepository repository) {
    this.diagram = diagram;
    if (SPropertyOperations.getBoolean(diagram, PROPS.readonly$NiOU)) {
      return;
    }
    ListSequence.fromList(actions).addElement(new NewSubstituteAction(SPointerOperations.resolveNode(new SNodePointer("r:00000000-0000-4000-0000-011c89590292(jetbrains.mps.lang.structure.structure)", "1071489090640"), repository), diagram));
    ListSequence.fromList(actions).addElement(new NewSubstituteAction(SPointerOperations.resolveNode(new SNodePointer("r:00000000-0000-4000-0000-011c89590292(jetbrains.mps.lang.structure.structure)", "1169125989551"), repository), diagram));
    List<SNode> missingConcepts = ListSequence.fromList(SModelOperations.roots(SNodeOperations.getModel(diagram), CONCEPTS.AbstractConceptDeclaration$KA)).where((it) -> !(Sequence.fromIterable(SLinkOperations.collect(SLinkOperations.getChildren(diagram, LINKS.contents$BgwK), LINKS.concept$p3Wi)).contains(it))).toList();

    for (SLanguage l : ListSequence.fromList(getLanguages())) {
      for (SAbstractConcept concept : Sequence.fromIterable(l.getConcepts())) {
        {
          final SNode decl = concept.getDeclarationNode();
          if (SNodeOperations.isInstanceOf(decl, CONCEPTS.AbstractConceptDeclaration$KA)) {
            ListSequence.fromList(missingConcepts).addElement(decl);
          }
        }
      }
    }

    ListSequence.fromList(getMissingConcepts()).visitAll((conceptDeclaration) -> ListSequence.fromList(actions).addElement(new ExistingSubstituteAction(conceptDeclaration, diagram, ListSequence.fromList(SModelOperations.roots(SNodeOperations.getModel(diagram), null)).contains(conceptDeclaration))));
  }

  public List<SLanguage> getLanguages() {
    List<SLanguage> languages = ListSequence.fromList(new LinkedList<SLanguage>());
    for (SNode it : Sequence.fromIterable(SLinkOperations.collect(SLinkOperations.getChildren(diagram, LINKS.languagesInScope$CNV3), LINKS.languageId$xSH1))) {
      if (!(SNodeOperations.getConcept(it).isAbstract())) {
        ListSequence.fromList(languages).addElement(LanguageIdentity__BehaviorDescriptor.getLanguage_id34EJa6aIcyj.invoke(it));
      }
    }
    return languages;
  }

  public List<SNode> getMissingConcepts() {
    List<SNode> missingConcepts = ListSequence.fromList(SModelOperations.roots(SNodeOperations.getModel(diagram), CONCEPTS.AbstractConceptDeclaration$KA)).where((it) -> !(Sequence.fromIterable(SLinkOperations.collect(SLinkOperations.getChildren(diagram, LINKS.contents$BgwK), LINKS.concept$p3Wi)).contains(it))).toList();

    for (SLanguage l : ListSequence.fromList(getLanguages())) {
      for (SAbstractConcept concept : Sequence.fromIterable(l.getConcepts())) {
        {
          final SNode decl = concept.getDeclarationNode();
          if (SNodeOperations.isInstanceOf(decl, CONCEPTS.AbstractConceptDeclaration$KA)) {
            ListSequence.fromList(missingConcepts).addElement(decl);
          }
        }
      }
    }
    return missingConcepts;
  }

  public List<SubstituteAction> getMatchingActions(String pattern, boolean strict) {
    return actions;
  }
  public List<SubstituteAction> getSmartMatchingActions(String pattern, boolean strict, EditorCell cell) {
    return getMatchingActions(pattern, strict);
  }
  public void invalidateActions() {
  }
  public void setOriginalText(String text) {
    originalText = text;
  }
  public String getOriginalText() {
    return originalText;
  }
  public boolean hasExactlyNActions(String pattern, boolean strict, int n) {
    return ListSequence.fromList(actions).count() == n;
  }

  private static final class PROPS {
    /*package*/ static final SProperty readonly$NiOU = MetaAdapterFactory.getProperty(0x9d1cb9f82ae04895L, 0x91c8ff32e8afc27dL, 0x2490cbe4d990691aL, 0x6117e922fde38586L, "readonly");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept AbstractConceptDeclaration$KA = MetaAdapterFactory.getConcept(0xc72da2b97cce4447L, 0x8389f407dc1158b7L, 0x1103553c5ffL, "jetbrains.mps.lang.structure.structure.AbstractConceptDeclaration");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink contents$BgwK = MetaAdapterFactory.getContainmentLink(0x9d1cb9f82ae04895L, 0x91c8ff32e8afc27dL, 0x2490cbe4d990691aL, 0x2490cbe4d996c41cL, "contents");
    /*package*/ static final SReferenceLink concept$p3Wi = MetaAdapterFactory.getReferenceLink(0x9d1cb9f82ae04895L, 0x91c8ff32e8afc27dL, 0x2490cbe4d9d63687L, 0x2490cbe4d9d63688L, "concept");
    /*package*/ static final SContainmentLink languagesInScope$CNV3 = MetaAdapterFactory.getContainmentLink(0x9d1cb9f82ae04895L, 0x91c8ff32e8afc27dL, 0x2490cbe4d990691aL, 0x79b58a62f25e1f2fL, "languagesInScope");
    /*package*/ static final SContainmentLink languageId$xSH1 = MetaAdapterFactory.getContainmentLink(0x7866978ea0f04cc7L, 0x81bc4d213d9375e1L, 0x3e6a40ba27dd70f3L, 0x312abca18ab995e2L, "languageId");
  }
}
