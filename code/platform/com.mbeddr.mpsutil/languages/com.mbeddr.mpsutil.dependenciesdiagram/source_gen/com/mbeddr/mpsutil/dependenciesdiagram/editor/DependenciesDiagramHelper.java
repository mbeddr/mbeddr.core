package com.mbeddr.mpsutil.dependenciesdiagram.editor;

/*Generated by MPS */

import java.util.Map;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.model.SModelReference;
import org.jetbrains.mps.openapi.module.SDependency;
import org.jetbrains.mps.openapi.language.SLanguage;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.openapi.editor.EditorContext;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import java.util.Objects;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class DependenciesDiagramHelper {
  private static DependenciesDiagramHelper instance;

  private final Map<String, SModule> modules = MapSequence.fromMap(new HashMap<String, SModule>());
  private final Map<String, SModel> models = MapSequence.fromMap(new HashMap<String, SModel>());

  @NotNull
  public static DependenciesDiagramHelper getInstance() {
    if (instance == null) {
      instance = new DependenciesDiagramHelper();
    }

    return instance;
  }

  @NotNull
  public static String getId(@NotNull SModule module) {
    return module.getModuleId().toString();
  }

  @NotNull
  public static String getId(@NotNull SModel model) {
    return model.getModelId().toString();
  }

  @NotNull
  public static String getId(@NotNull SModelReference modelDependency) {
    return modelDependency.getModelId().toString();
  }

  @NotNull
  public static String getId(@NotNull SDependency moduleDependency) {
    return moduleDependency.getTargetModule().getModuleId().toString();
  }

  @NotNull
  public static String getId(@NotNull SLanguage modelUsedLanguage) {
    return modelUsedLanguage.getSourceModule().getModuleId().toString();
  }

  @Nullable
  public static String getIdModuleDependency(@NotNull Tuples._2<SModule, SDependency> moduleDependency) {
    if (moduleDependency._0() == null || moduleDependency._1() == null) {
      return null;
    }
    return getId(moduleDependency._0()) + "_to_" + getId(moduleDependency._1());
  }

  @Nullable
  public static String getIdModuleUsedLanguage(@NotNull Tuples._2<SModule, SLanguage> moduleUsedLanguage) {
    if (moduleUsedLanguage._0() == null || moduleUsedLanguage._1() == null) {
      return null;
    }
    return getId(moduleUsedLanguage._0()) + "_to_" + getId(moduleUsedLanguage._1());
  }

  @Nullable
  public static String getIdModelUsedLanguage(@NotNull Tuples._2<SModel, SLanguage> modelUsedLanguage) {
    if (modelUsedLanguage._0() == null || modelUsedLanguage._1() == null) {
      return null;
    }
    return getId(modelUsedLanguage._0()) + "_to_" + getId(modelUsedLanguage._1());
  }

  @Nullable
  public static String getIdModelDependency(@NotNull Tuples._2<SModel, SModelReference> modelDependency) {
    if (modelDependency._0() == null || modelDependency._1() == null) {
      return null;
    }
    return getId(modelDependency._0()) + "_to_" + getId(modelDependency._1());
  }

  public void reset() {
  }

  @NotNull
  public Map<String, SModule> collectModules(@NotNull EditorContext context) {
    if (MapSequence.fromMap(modules).isEmpty()) {
      for (SModule module : Sequence.fromIterable(context.getRepository().getModules())) {
        MapSequence.fromMap(this.modules).put(module.getModuleName(), module);
      }
    }

    return modules;
  }

  @NotNull
  public Map<String, SModel> collectModels(@NotNull EditorContext context) {
    if (MapSequence.fromMap(models).isEmpty()) {
      for (SModel model : Sequence.fromIterable(MapSequence.fromMap(collectModules(context)).values()).translate((it) -> it.getModels())) {
        MapSequence.fromMap(models).put(model.getModelName(), model);
      }
    }

    return models;
  }

  @Nullable
  public SModule resolveModule(@NotNull SNode moduleRef, @NotNull EditorContext context) {
    return MapSequence.fromMap(collectModules(context)).get(SPropertyOperations.getString(moduleRef, PROPS.qualifiedName$Z4hI));
  }

  @Nullable
  public SModel resolveModel(@NotNull SNode modelRef, @NotNull EditorContext context) {
    return MapSequence.fromMap(collectModels(context)).get(SPropertyOperations.getString(modelRef, PROPS.qualifiedName$331j));
  }

  @NotNull
  public Iterable<SModel> filterModelsOutsideSameModule(@NotNull final SModule module, @NotNull Iterable<SModel> models) {
    return Sequence.fromIterable(models).where((it) -> Objects.equals(it.getModule(), module));
  }

  @NotNull
  public Iterable<SModel> filterModelsOutsideDiagram(@NotNull Iterable<SModel> input, @NotNull SNode dependenciesDiagram, @NotNull EditorContext context) {
    final Iterable<SModel> models = collectModelsInDiagram(dependenciesDiagram, context);

    return Sequence.fromIterable(input).where((it) -> Sequence.fromIterable(models).contains(it));
  }

  @NotNull
  public Iterable<SModel> collectModelsInDiagram(@NotNull SNode dependenciesDiagram, @NotNull final EditorContext context) {
    return ListSequence.fromList(SLinkOperations.getChildren(dependenciesDiagram, LINKS.models$Onh_)).select((it) -> resolveModel(it, context)).where((it) -> it != null);
  }

  @NotNull
  public Iterable<SModule> filterModulesOutsideDiagram(@NotNull Iterable<SModule> input, @NotNull SNode dependenciesDiagram, @NotNull EditorContext context) {
    final Iterable<SModule> modules = collectModulesInDiagram(dependenciesDiagram, context);

    return Sequence.fromIterable(input).where((it) -> Sequence.fromIterable(modules).contains(it));
  }


  @NotNull
  public Iterable<SModule> collectModulesInDiagram(@NotNull SNode dependenciesDiagram, @NotNull final EditorContext context) {
    return ListSequence.fromList(SLinkOperations.getChildren(dependenciesDiagram, LINKS.modules$n44W)).select((it) -> resolveModule(it, context)).where((it) -> it != null);
  }

  private static final class PROPS {
    /*package*/ static final SProperty qualifiedName$Z4hI = MetaAdapterFactory.getProperty(0x86ef829012bb4ca7L, 0x947f093788f263a9L, 0x19bfb4173fb5210cL, 0x19bfb4173fb5210eL, "qualifiedName");
    /*package*/ static final SProperty qualifiedName$331j = MetaAdapterFactory.getProperty(0x86ef829012bb4ca7L, 0x947f093788f263a9L, 0x5869770da61dfe27L, 0x5869770da61dfe2eL, "qualifiedName");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink models$Onh_ = MetaAdapterFactory.getContainmentLink(0xcab214f971274f03L, 0x923ac64fb67fed05L, 0x62f0e53a3327f5beL, 0x62f0e53a332aed3eL, "models");
    /*package*/ static final SContainmentLink modules$n44W = MetaAdapterFactory.getContainmentLink(0xcab214f971274f03L, 0x923ac64fb67fed05L, 0x62f0e53a3327f5beL, 0x62f0e53a33284c93L, "modules");
  }
}
