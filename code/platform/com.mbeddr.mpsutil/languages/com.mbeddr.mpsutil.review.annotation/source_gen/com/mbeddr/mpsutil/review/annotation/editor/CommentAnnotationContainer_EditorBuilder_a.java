package com.mbeddr.mpsutil.review.annotation.editor;

/*Generated by MPS */

import jetbrains.mps.editor.runtime.descriptor.AbstractEditorBuilder;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.openapi.editor.EditorContext;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.nodeEditor.cells.EditorCell_Collection;
import jetbrains.mps.nodeEditor.cellLayout.CellLayout_Vertical;
import jetbrains.mps.nodeEditor.cellLayout.CellLayout_Horizontal;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.editor.runtime.style.StyleImpl;
import jetbrains.mps.editor.runtime.style.StyleAttributes;
import jetbrains.mps.nodeEditor.cells.EditorCell_Constant;
import jetbrains.mps.nodeEditor.MPSColors;
import jetbrains.mps.nodeEditor.cells.EditorCell_Property;
import jetbrains.mps.nodeEditor.cells.ModelAccessor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.openapi.editor.cells.CellActionType;
import jetbrains.mps.editor.runtime.cells.EmptyCellAction;
import com.mbeddr.mpsutil.review.behavior.TimeHelper;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.nodeEditor.AbstractCellProvider;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.nodeEditor.cells.EditorCell_Basic;
import java.awt.Graphics;
import jetbrains.mps.nodeEditor.cells.ParentSettings;
import java.awt.Graphics2D;
import java.awt.BasicStroke;
import java.awt.Color;
import jetbrains.mps.nodeEditor.EditorSettings;
import jetbrains.mps.nodeEditor.EditorManager;
import jetbrains.mps.openapi.editor.update.AttributeKind;
import com.mbeddr.mpsutil.margincell.runtime.MarginCellStyle;
import com.mbeddr.mpsutil.review.runtime.ReviewMarginCellStyle;
import com.mbeddr.mpsutil.margincell.runtime.MarginEditorCell;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SProperty;

/*package*/ class CommentAnnotationContainer_EditorBuilder_a extends AbstractEditorBuilder {
  @NotNull
  private SNode myNode;

  public CommentAnnotationContainer_EditorBuilder_a(@NotNull EditorContext context, @NotNull SNode node) {
    super(context);
    myNode = node;
  }

  @NotNull
  @Override
  public SNode getNode() {
    return myNode;
  }

  /*package*/ EditorCell createCell() {
    return createMarginCell_1();
  }

  private EditorCell createCollection_0() {
    EditorCell_Collection editorCell = new EditorCell_Collection(getEditorContext(), myNode, new CellLayout_Vertical());
    editorCell.setCellId("Collection_ilbaik_a0");
    editorCell.addEditorCell(createCollection_1());
    editorCell.addEditorCell(createCustom_0());
    editorCell.addEditorCell(createConstant_1());
    editorCell.addEditorCell(createAttributedNodeCell_0());
    return editorCell;
  }
  private EditorCell createCollection_1() {
    EditorCell_Collection editorCell = new EditorCell_Collection(getEditorContext(), myNode, new CellLayout_Horizontal());
    editorCell.setCellId("Collection_ilbaik_a0a");
    Style style = new StyleImpl();
    style.set(StyleAttributes.SELECTABLE, false);
    editorCell.getStyle().putAll(style);
    editorCell.addEditorCell(createConstant_0());
    editorCell.addEditorCell(createReadOnlyModelAccessor_0());
    editorCell.addEditorCell(createReadOnlyModelAccessor_1());
    return editorCell;
  }
  private EditorCell createConstant_0() {
    EditorCell_Constant editorCell = new EditorCell_Constant(getEditorContext(), myNode, "Comments:");
    editorCell.setCellId("Constant_ilbaik_a0a0");
    Style style = new StyleImpl();
    style.set(StyleAttributes.TEXT_COLOR, getStyleRegistry().getSimpleColor(MPSColors.gray));
    editorCell.getStyle().putAll(style);
    editorCell.setDefaultText("");
    return editorCell;
  }
  private EditorCell createReadOnlyModelAccessor_0() {
    EditorCell_Property editorCell = EditorCell_Property.create(getEditorContext(), new ModelAccessor.ReadOnly() {
      public String getText() {
        return ListSequence.fromList(SLinkOperations.getChildren(myNode, LINKS.comments$KPYX)).count() + " comment(s) in root.";
      }
    }, myNode);
    editorCell.setAction(CellActionType.DELETE, EmptyCellAction.getInstance());
    editorCell.setAction(CellActionType.BACKSPACE, EmptyCellAction.getInstance());
    editorCell.setCellId("ReadOnlyModelAccessor_ilbaik_b0a0");
    Style style = new StyleImpl();
    style.set(StyleAttributes.TEXT_COLOR, getStyleRegistry().getSimpleColor(MPSColors.gray));
    style.set(StyleAttributes.EDITABLE, false);
    editorCell.getStyle().putAll(style);
    return editorCell;
  }
  private EditorCell createReadOnlyModelAccessor_1() {
    EditorCell_Property editorCell = EditorCell_Property.create(getEditorContext(), new ModelAccessor.ReadOnly() {
      public String getText() {
        SNode newest = ListSequence.fromList(SLinkOperations.getChildren(myNode, LINKS.comments$KPYX)).sort((it) -> TimeHelper.transcodeToLocalTimeZoneMillis(SPropertyOperations.getString(it, PROPS.created$HbXz)), false).first();
        if ((newest == null)) {
          return "";
        }
        try {
          long currentMillis = TimeHelper.transcodeToLocalTimeZoneMillis(SPropertyOperations.getString(newest, PROPS.created$HbXz));
          String t = TimeHelper.transcodeToLocalTimeZone(SPropertyOperations.getString(newest, PROPS.created$HbXz)) + " (" + TimeHelper.asRelativeToNow(currentMillis + "") + ")";
          return "Last comment added " + t + " by " + SPropertyOperations.getString(newest, PROPS.creator$E_ot);
        } catch (Exception ex) {
          return "Last comment " + " by " + SPropertyOperations.getString(newest, PROPS.creator$E_ot);
        }
      }
    }, myNode);
    editorCell.setAction(CellActionType.DELETE, EmptyCellAction.getInstance());
    editorCell.setAction(CellActionType.BACKSPACE, EmptyCellAction.getInstance());
    editorCell.setCellId("ReadOnlyModelAccessor_ilbaik_c0a0");
    Style style = new StyleImpl();
    style.set(StyleAttributes.TEXT_COLOR, getStyleRegistry().getSimpleColor(MPSColors.gray));
    style.set(StyleAttributes.EDITABLE, false);
    editorCell.getStyle().putAll(style);
    return editorCell;
  }
  private EditorCell createCustom_0() {
    AbstractCellProvider provider = ((_FunctionTypes._return_P0_E0<AbstractCellProvider>) () -> {
      return new AbstractCellProvider(myNode) {
        @Override
        public jetbrains.mps.nodeEditor.cells.EditorCell createEditorCell(EditorContext context) {
          return new EditorCell_Basic(context, myNode) {
            public void paintContent(Graphics g_, ParentSettings parentSettings) {
              Graphics2D g = ((Graphics2D) g_.create());
              try {
                g.setStroke(new BasicStroke(2, BasicStroke.CAP_BUTT, BasicStroke.JOIN_BEVEL, 6.0f, new float[]{1.0f}, 0.6f));
                g.setColor(Color.gray);
                g.drawLine(getX(), getY() - 4, getX() + EditorSettings.getInstance().getVerticalBoundWidth(), getY() - 4);
              } finally {
                g.dispose();
              }
            }

            @Override
            public int getHeight() {
              return 1;
            }

            @Override
            public int getWidth() {
              return 300;
            }
          };
        }
      };
    }).invoke();
    EditorCell editorCell = provider.createEditorCell(getEditorContext());
    editorCell.setCellId("Custom_ilbaik_b0a");
    return editorCell;
  }
  private EditorCell createConstant_1() {
    EditorCell_Constant editorCell = new EditorCell_Constant(getEditorContext(), myNode, "");
    editorCell.setCellId("Constant_ilbaik_c0a");
    Style style = new StyleImpl();
    style.set(StyleAttributes.SELECTABLE, false);
    editorCell.getStyle().putAll(style);
    editorCell.setDefaultText("");
    return editorCell;
  }
  private EditorCell createAttributedNodeCell_0() {
    EditorManager manager = EditorManager.getInstanceFromContext(getEditorContext());
    EditorCell editorCell = getUpdateSession().getAttributedCell(AttributeKind.NODE, myNode);
    return editorCell;
  }
  private EditorCell createMarginCell_0(EditorContext editorContext, SNode node) {

    MarginCellStyle style = new ReviewMarginCellStyle();

    EditorCell_Collection editorCell = new MarginEditorCell(editorContext, node, style);
    editorCell.addEditorCell(createCollection_0());

    for (SNode child : ListSequence.fromList(SLinkOperations.getChildren(node, LINKS.comments$KPYX))) {
      editorCell.addEditorCell(editorContext.getEditorComponent().getUpdater().getCurrentUpdateSession().updateChildNodeCell(child));
    }


    editorCell.setCellId("MarginCell_ilbaik_a");
    editorCell.setBig(true);
    setCellContext(editorCell);

    return editorCell;
  }
  private EditorCell createMarginCell_1() {
    return createMarginCell_0(getEditorContext(), myNode);
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink comments$KPYX = MetaAdapterFactory.getContainmentLink(0x7a060fae09e04372L, 0xbe366696d6554c0eL, 0x7556ef16fac6bfb4L, 0x7556ef16fac6bfb5L, "comments");
  }

  private static final class PROPS {
    /*package*/ static final SProperty created$HbXz = MetaAdapterFactory.getProperty(0xc788b04620194656L, 0x8b608bb9bbb177b5L, 0x1017edaecf8ecafbL, 0x4e7335ab843dfa68L, "created");
    /*package*/ static final SProperty creator$E_ot = MetaAdapterFactory.getProperty(0xc788b04620194656L, 0x8b608bb9bbb177b5L, 0x1017edaecf8ecafbL, 0x4e7335ab843dfa57L, "creator");
  }
}
