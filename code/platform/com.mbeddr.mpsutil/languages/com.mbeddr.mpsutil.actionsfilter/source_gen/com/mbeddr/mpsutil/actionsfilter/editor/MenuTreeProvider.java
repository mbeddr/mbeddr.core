package com.mbeddr.mpsutil.actionsfilter.editor;

/*Generated by MPS */

import jetbrains.mps.nodeEditor.AbstractCellProvider;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import com.intellij.openapi.actionSystem.AnAction;
import com.intellij.openapi.actionSystem.ActionManager;
import jetbrains.mps.nodeEditor.cells.EditorCell_Error;
import org.jetbrains.annotations.Nullable;
import com.intellij.openapi.actionSystem.ActionGroup;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import jetbrains.mps.editor.runtime.style.StyleAttributes;
import com.intellij.openapi.actionSystem.Separator;
import jetbrains.mps.nodeEditor.cells.EditorCell_Constant;
import java.awt.Color;
import jetbrains.mps.plugins.actions.LabelledAnchor;
import jetbrains.mps.nodeEditor.cells.EditorCell_Property;
import jetbrains.mps.nodeEditor.cells.ModelAccessor;
import java.util.Objects;
import jetbrains.mps.openapi.editor.cells.CellActionType;
import jetbrains.mps.openapi.editor.cells.CellAction;
import com.mbeddr.mpsutil.actionsfilter.behavior.ActionsProfile__BehaviorDescriptor;
import jetbrains.mps.smodel.action.SNodeFactoryOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import com.mbeddr.mpsutil.actionsfilter.behavior.ActionBase__BehaviorDescriptor;
import com.intellij.openapi.actionSystem.DefaultActionGroup;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.NotNullWhereFilter;
import com.intellij.openapi.actionSystem.Presentation;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SProperty;

public class MenuTreeProvider extends AbstractCellProvider {

  private SNode myNode;
  private EditorContext myEditorContext;
  private String myRootActionGroupId;

  public MenuTreeProvider(SNode rootNode, EditorContext editorContext, @NotNull String rootActionGroupId) {
    super(rootNode);
    myNode = rootNode;
    myEditorContext = editorContext;
    myRootActionGroupId = rootActionGroupId;
  }

  @Override
  public EditorCell createEditorCell(EditorContext context) {
    AnAction rootAction = ActionManager.getInstance().getAction(myRootActionGroupId);
    if (rootAction != null) {
      return createEntryCell(rootAction, null);
    }
    return new EditorCell_Error(myEditorContext, myNode, "Couldn't create an entry for " + myRootActionGroupId);
  }

  protected EditorCell createEntryCell(@NotNull final AnAction action, @Nullable ActionGroup parentGroup) {
    final String id = ActionManager.getInstance().getId(action);
    String text = check_u2e1yf_a0b0j(check_u2e1yf_a0a1a9(action));

    EditorCell_Collection result = jetbrains.mps.nodeEditor.cells.EditorCell_Collection.createIndent2(myEditorContext, myNode);
    result.getStyle().set(StyleAttributes.INDENT_LAYOUT_ON_NEW_LINE, true);
    result.getStyle().set(StyleAttributes.INDENT_LAYOUT_INDENT, true);

    if (action instanceof Separator) {
      EditorCell_Constant cell = new EditorCell_Constant(myEditorContext, myNode, "----------------------------");
      cell.getStyle().set(StyleAttributes.FONT_STYLE, 0);
      cell.getStyle().set(StyleAttributes.TEXT_COLOR, Color.LIGHT_GRAY);
      result.addEditorCell(cell);
      return result;
    }
    if (action instanceof LabelledAnchor) {
      String separator = "_ActionGroup";
      String label = id;
      int pos = check_u2e1yf_a0c0i0j(label, separator);
      if (pos >= 0) {
        label = check_u2e1yf_a0a0d0i0j(label, separator, pos);
      }
      EditorCell_Constant cell = new EditorCell_Constant(myEditorContext, myNode, "#" + label);
      cell.getStyle().set(StyleAttributes.FONT_STYLE, 0);
      cell.getStyle().set(StyleAttributes.TEXT_COLOR, Color.LIGHT_GRAY);
      result.addEditorCell(cell);
      return result;
    }


    final EditorCell_Property checkbox = new EditorCell_Property(myEditorContext, new ModelAccessor() {
      public String getText() {
        if (isAlreadyReferenced(id)) {
          return "[x]";
        }
        return "[]";
      }
      public void setText(String newValue) {
        if (Objects.equals(Boolean.TRUE.toString(), newValue)) {
        } else {
        }
      }
      public boolean isValidText(String value) {
        return true;
      }

    }, myNode) {};


    checkbox.setAction(CellActionType.CLICK, new CellAction() {
      @Override
      public String getDescriptionText() {
        return "Toggle checkbox";
      }

      @Override
      public boolean executeInCommand() {
        return true;
      }

      @Override
      public boolean canExecute(EditorContext p1) {
        return true;
      }

      @Override
      public void execute(EditorContext p1) {
        if (Objects.equals(checkbox.getText(), "[]")) {
          if (!(isAlreadyReferenced(id))) {
            if ((boolean) ActionsProfile__BehaviorDescriptor.isRemoveMode_id1TS1BLORxU1.invoke(myNode)) {
              SNode removeAction = SNodeFactoryOperations.addNewChild(myNode, LINKS.actions$EqnK, CONCEPTS.RemoveAction$ss);
              SPropertyOperations.assign(removeAction, PROPS.actionId$GUAt, id);
            } else {
              SNode allowAction = SNodeFactoryOperations.addNewChild(myNode, LINKS.actions$EqnK, CONCEPTS.AllowAction$9c);
              SPropertyOperations.assign(allowAction, PROPS.actionId$JXRh, id);
            }
          }
        } else {
          ListSequence.fromList(SLinkOperations.getChildren(myNode, LINKS.actions$EqnK)).removeWhere((it) -> (boolean) ActionBase__BehaviorDescriptor.refersToActionId_id5ReuVUpdzR3.invoke(it, id));
        }
      }
    });
    checkbox.getStyle().set(StyleAttributes.READ_ONLY, true);
    result.addEditorCell(checkbox);

    if (parentGroup == null || !(parentGroup instanceof DefaultActionGroup)) {
      text = "!!! " + text;
    }
    EditorCell_Constant textCell = new EditorCell_Constant(myEditorContext, myNode, text);
    textCell.getStyle().set(StyleAttributes.FONT_STYLE, 0);
    result.addEditorCell(textCell);

    EditorCell_Constant idCell = new EditorCell_Constant(myEditorContext, myNode, "(" + id + ") " + check_u2e1yf_a2a0a32a9(check_u2e1yf_a0c0a0x0j(action)));
    idCell.getStyle().set(StyleAttributes.FONT_STYLE, 0);
    idCell.getStyle().set(StyleAttributes.TEXT_COLOR, Color.LIGHT_GRAY);
    result.addEditorCell(idCell);

    if (action instanceof DefaultActionGroup) {
      DefaultActionGroup group = (DefaultActionGroup) action;
      for (AnAction child : Sequence.fromIterable(Sequence.fromArray(group.getChildActionsOrStubs())).where(new NotNullWhereFilter())) {
        EditorCell childCell = createEntryCell(child, group);
        if (childCell != null) {
          result.addEditorCell(childCell);
        }
      }
    }

    return result;
  }
  public boolean isAlreadyReferenced(final String id) {
    return (ListSequence.fromList(SLinkOperations.getChildren(myNode, LINKS.actions$EqnK)).findFirst((it) -> (boolean) ActionBase__BehaviorDescriptor.refersToActionId_id5ReuVUpdzR3.invoke(it, id)) != null);
  }


  private static String check_u2e1yf_a0b0j(Presentation checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getText();
    }
    return null;
  }
  private static Presentation check_u2e1yf_a0a1a9(AnAction checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getTemplatePresentation();
    }
    return null;
  }
  private static int check_u2e1yf_a0c0i0j(String checkedDotOperand, String separator) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.indexOf(separator);
    }
    return 0;
  }
  private static String check_u2e1yf_a0a0d0i0j(String checkedDotOperand, String separator, Integer pos) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.substring(pos + separator.length());
    }
    return null;
  }
  private static String check_u2e1yf_a2a0a32a9(Class<?> checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getSimpleName();
    }
    return null;
  }
  private static Class<?> check_u2e1yf_a0c0a0x0j(AnAction checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getClass();
    }
    return null;
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink actions$EqnK = MetaAdapterFactory.getContainmentLink(0xc38abce14c0944cbL, 0x9ebf2a764e824bb5L, 0x5aef4be6d5b99969L, 0x5aef4be6d5b9999aL, "actions");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept RemoveAction$ss = MetaAdapterFactory.getConcept(0xc38abce14c0944cbL, 0x9ebf2a764e824bb5L, 0x5aef4be6d5b99999L, "com.mbeddr.mpsutil.actionsfilter.structure.RemoveAction");
    /*package*/ static final SConcept AllowAction$9c = MetaAdapterFactory.getConcept(0xc38abce14c0944cbL, 0x9ebf2a764e824bb5L, 0x5dce7bbe993098e5L, "com.mbeddr.mpsutil.actionsfilter.structure.AllowAction");
  }

  private static final class PROPS {
    /*package*/ static final SProperty actionId$GUAt = MetaAdapterFactory.getProperty(0xc38abce14c0944cbL, 0x9ebf2a764e824bb5L, 0x5aef4be6d5b99999L, 0x5aef4be6d5b999a0L, "actionId");
    /*package*/ static final SProperty actionId$JXRh = MetaAdapterFactory.getProperty(0xc38abce14c0944cbL, 0x9ebf2a764e824bb5L, 0x5dce7bbe993098e5L, 0x5dce7bbe99309dc6L, "actionId");
  }
}
