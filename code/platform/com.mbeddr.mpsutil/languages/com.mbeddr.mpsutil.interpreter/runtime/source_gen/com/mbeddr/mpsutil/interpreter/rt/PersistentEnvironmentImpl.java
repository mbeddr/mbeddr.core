package com.mbeddr.mpsutil.interpreter.rt;

/*Generated by MPS */

import java.util.Map;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.LinkedHashMap;
import jetbrains.mps.internal.collections.runtime.IterableUtils;
import jetbrains.mps.lang.core.behavior.BaseConcept__BehaviorDescriptor;

public class PersistentEnvironmentImpl extends EnvironmentImpl implements IPersistentEnvironment {
  private Map<SNode, IEnvironmentId> currentEnvironmentIds = MapSequence.fromMap(new LinkedHashMap<SNode, IEnvironmentId>(16, (float) 0.75, false));

  private Map<SNode, Map<IEnvironmentId, IPersistentEnvironment>> pushedEnvironments = MapSequence.fromMap(new LinkedHashMap<SNode, Map<IEnvironmentId, IPersistentEnvironment>>(16, (float) 0.75, false));

  public PersistentEnvironmentImpl() {
    super(new PersistentNodeValueCacheImpl());
  }


  public Map<SNode, IEnvironmentId> getCurrentEnvironmentIds() {
    return this.currentEnvironmentIds;
  }

  public Map<SNode, Map<IEnvironmentId, IPersistentEnvironment>> getPushedEnvironments() {
    return this.pushedEnvironments;
  }

  @Override
  public String toString() {
    return System.identityHashCode(this) + ": " + super.toString() + " parent: " + (getParentEnvironment() != null) + " currentEnvironmentIds: [" + IterableUtils.join(MapSequence.fromMap(getCurrentEnvironmentIds()).select((it) -> BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(it.key()) + " " + it.key().getNodeId() + "=" + it.value()), ", ") + "] pushedEnvironments: {" + IterableUtils.join(MapSequence.fromMap(getPushedEnvironments()).select((it) -> BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(it.key()) + MapSequence.fromMap(it.value()).count()), ", ") + "} " + getCache();
  }

  @Override
  public IPersistentEnvironment getParentEnvironment() {
    return ((IPersistentEnvironment) super.getParentEnvironment());
  }

  @Override
  public IPersistentEnvironment getRootEnvironment() {
    return ((IPersistentEnvironment) super.getRootEnvironment());
  }

  @Override
  public IPersistentEnvironment push(SNode node, Map<SNode, Object> initialEnvironment) {
    PersistentEnvironmentImpl result = ((PersistentEnvironmentImpl) super.push(node, initialEnvironment));

    IEnvironmentId environmentId = createEnvironmentId(node, initialEnvironment);
    Map<IEnvironmentId, IPersistentEnvironment> map = MapSequence.fromMap(this.getPushedEnvironments()).get(node);
    if (map == null) {
      map = MapSequence.fromMap(new LinkedHashMap<IEnvironmentId, IPersistentEnvironment>(16, (float) 0.75, false));
      MapSequence.fromMap(this.getPushedEnvironments()).put(node, map);
    }

    MapSequence.fromMap(map).put(environmentId, result);
    MapSequence.fromMap(this.getCurrentEnvironmentIds()).put(node, environmentId);

    return result;
  }


  @Override
  protected PersistentEnvironmentImpl create() {
    return new PersistentEnvironmentImpl();
  }

  protected IEnvironmentId createEnvironmentId(SNode node, Map<SNode, Object> parameters) {
    return new EnvironmentIdImpl("(" + IterableUtils.join(MapSequence.fromMap(parameters).select((it) -> BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(it.key()) + " = " + it.value()), ", ") + ")");
  }

  @Override
  public IPersistentEnvironment pop(SNode node) {
    return ((PersistentEnvironmentImpl) super.pop(node));
  }

  @Override
  public void setCache(INodeValueCache cache) {
    return;
  }

  public PersistentNodeValueCacheImpl getCache() {
    return ((PersistentNodeValueCacheImpl) super.getCache());
  }
}
