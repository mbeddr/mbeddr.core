package com.mbeddr.mpsutil.interpreter.behavior;

/*Generated by MPS */

import jetbrains.mps.core.aspects.behaviour.BaseBHDescriptor;
import jetbrains.mps.logging.Logger;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.core.aspects.behaviour.api.SMethod;
import jetbrains.mps.core.aspects.behaviour.SMethodBuilder;
import jetbrains.mps.core.aspects.behaviour.SJavaCompoundTypeImpl;
import jetbrains.mps.core.aspects.behaviour.AccessPrivileges;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.List;
import java.util.Arrays;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.lang.core.behavior.BaseConcept__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.typechecking.TypecheckingFacade;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.smodel.SNodeMatcher;
import jetbrains.mps.typesystem.inference.TypeCheckerHelper;
import jetbrains.mps.newTypesystem.context.TargetTypecheckingContext;
import jetbrains.mps.typesystem.inference.SubtypingManager;
import jetbrains.mps.typesystem.inference.TypeChecker;
import jetbrains.mps.core.aspects.behaviour.api.SConstructor;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.core.aspects.behaviour.api.BHMethodNotFoundException;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SConcept;

public final class TypedChildConstraint__BehaviorDescriptor extends BaseBHDescriptor {
  private static final Logger LOG = Logger.getLogger(TypedChildConstraint__BehaviorDescriptor.class);
  private static final SAbstractConcept CONCEPT = MetaAdapterFactory.getConcept(0x47f075a6558e4640L, 0xa6067ce0236c8023L, 0x778ee47a6de85e1bL, "com.mbeddr.mpsutil.interpreter.structure.TypedChildConstraint");

  public static final SMethod<String> getPresentation_idhEwIMiw = new SMethodBuilder<String>(new SJavaCompoundTypeImpl(String.class)).name("getPresentation").modifiers(8, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(1213877396640L).languageId(0x9b92103b95ca8c0cL, 0xceab519525ea4f22L).build2();
  public static final SMethod<Boolean> equals_id5I6_y3ZbJDX = new SMethodBuilder<Boolean>(new SJavaCompoundTypeImpl(Boolean.TYPE)).name("equals").modifiers(8, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(6595123772795058813L).languageId(0xa6067ce0236c8023L, 0x47f075a6558e4640L).build2(SMethodBuilder.createJavaParameter((Class<SNode>) ((Class) Object.class), ""));
  public static final SMethod<Integer> compareTo_id5x677oPpPUY = new SMethodBuilder<Integer>(new SJavaCompoundTypeImpl(Integer.TYPE)).name("compareTo").modifiers(8, AccessPrivileges.PUBLIC).concept(CONCEPT).baseMethodId(6360802817735089854L).languageId(0xa6067ce0236c8023L, 0x47f075a6558e4640L).build2(SMethodBuilder.createJavaParameter((Class<SNode>) ((Class) Object.class), ""));

  private static final List<SMethod<?>> BH_METHODS = Arrays.<SMethod<?>>asList(getPresentation_idhEwIMiw, equals_id5I6_y3ZbJDX, compareTo_id5x677oPpPUY);

  private static void ___init___(@NotNull SNode __thisNode__) {
  }

  /*package*/ static String getPresentation_idhEwIMiw(@NotNull SNode __thisNode__) {
    return BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(SLinkOperations.getTarget(__thisNode__, LINKS.child$VWZm)) + "[" + Util.sanitizeTypeName(TypecheckingFacade.getFromContext().getTypeOf(SLinkOperations.getTarget(__thisNode__, LINKS.type$LqL3))) + "]";
  }
  /*package*/ static boolean equals_id5I6_y3ZbJDX(@NotNull SNode __thisNode__, SNode otherConstraint) {

    if (SNodeOperations.isInstanceOf(otherConstraint, CONCEPTS.TypedChildConstraint$uD)) {
      SNode otherTypedChildConstraint = ((SNode) otherConstraint);
      SNode thisType = TypecheckingFacade.getFromContext().getTypeOf(SLinkOperations.getTarget(__thisNode__, LINKS.type$LqL3));
      SNode otherType = TypecheckingFacade.getFromContext().getTypeOf(SLinkOperations.getTarget(otherTypedChildConstraint, LINKS.type$LqL3));

      boolean childMatches = new SNodeMatcher().match(SLinkOperations.getTarget(__thisNode__, LINKS.child$VWZm), SLinkOperations.getTarget(otherTypedChildConstraint, LINKS.child$VWZm));
      boolean typeMatches = new SNodeMatcher().match(thisType, otherType);

      return childMatches && typeMatches;
    } else {
      return false;
    }
  }
  /*package*/ static int compareTo_id5x677oPpPUY(@NotNull SNode __thisNode__, SNode other) {
    if (!(SNodeOperations.isInstanceOf(other, CONCEPTS.TypedChildConstraint$uD))) {
      return ((int) AbstractConceptEvaluatorConstraint__BehaviorDescriptor.compareTo_id5x677oPpPUY.invokeSuper(__thisNode__, CONCEPTS.TypedChildConstraint$uD, other));
    }

    SNode otherTypedChildConstraint = ((SNode) other);
    boolean childMatches = new SNodeMatcher().match(SLinkOperations.getTarget(__thisNode__, LINKS.child$VWZm), SLinkOperations.getTarget(otherTypedChildConstraint, LINKS.child$VWZm));

    if (LOG.isTraceLevel()) {
      LOG.trace("thisChild: " + SNodeOperations.present(SLinkOperations.getTarget(__thisNode__, LINKS.child$VWZm)) + " otherChild: " + SLinkOperations.getTarget(otherTypedChildConstraint, LINKS.child$VWZm) + " result: " + childMatches);
    }

    if (!(childMatches)) {
      return BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(SLinkOperations.getTarget(__thisNode__, LINKS.child$VWZm)).compareTo(BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(SLinkOperations.getTarget(otherTypedChildConstraint, LINKS.child$VWZm)));
    }

    SNode thisType = TypecheckingFacade.getFromContext().getTypeOf(SLinkOperations.getTarget(__thisNode__, LINKS.type$LqL3));

    SNode otherTypeExpr = SLinkOperations.getTarget(otherTypedChildConstraint, LINKS.type$LqL3);
    SNode otherType = TypecheckingFacade.getFromContext().getTypeOf(otherTypeExpr);

    if (otherType == null) {
      // It's in a different model, ask the type checker to compute its type anyway
      TypeCheckerHelper th = TypecheckingFacade.getFromContext().getData(TypeCheckerHelper.class);
      otherType = new TargetTypecheckingContext(otherTypeExpr, th).getTypeOf_generationMode(otherTypeExpr);
      if (otherType == null) {
        // the code below wants otherType to be not null but there's nothing we can do, so just fall back to the base implementation.
        return ((int) AbstractConceptEvaluatorConstraint__BehaviorDescriptor.compareTo_id5x677oPpPUY.invokeSuper(__thisNode__, CONCEPTS.TypedChildConstraint$uD, other));
      }
    }

    boolean typeMatches = new SNodeMatcher().match(thisType, otherType);
    if (LOG.isTraceLevel()) {
      LOG.trace("thisType: " + SNodeOperations.present(thisType) + " otherType: " + otherType + " result: " + typeMatches);
    }

    if (typeMatches) {
      if (LOG.isTraceLevel()) {
        LOG.trace(SNodeOperations.present(__thisNode__) + " vs: " + otherTypedChildConstraint + ": same");
      }
      return 0;
    }

    SubtypingManager subtypingManager = TypeChecker.getInstance().getSubtypingManager();
    boolean thisToOther = subtypingManager.isSubtype(thisType, otherType);
    boolean otherToThis = subtypingManager.isSubtype(otherType, thisType);
    if (LOG.isTraceLevel()) {
      LOG.trace("subtypingManager: " + subtypingManager + " thisToOther: " + thisToOther + " otherToThis: " + otherToThis);
    }
    if (thisToOther) {
      return -1;
    } else if (otherToThis) {
      return 1;
    }

    return BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(thisType).compareTo(BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(otherType));
  }

  /*package*/ TypedChildConstraint__BehaviorDescriptor() {
  }

  @Override
  protected void initNode(@NotNull SNode node, @NotNull SConstructor constructor, @Nullable Object[] parameters) {
    ___init___(node);
  }

  @Override
  protected <T> T invokeSpecial0(@NotNull SNode node, @NotNull SMethod<T> method, @Nullable Object[] parameters) {
    int methodIndex = BH_METHODS.indexOf(method);
    if (methodIndex < 0) {
      throw new BHMethodNotFoundException(this, method);
    }
    switch (methodIndex) {
      case 0:
        return (T) ((String) getPresentation_idhEwIMiw(node));
      case 1:
        return (T) ((Boolean) equals_id5I6_y3ZbJDX(node, (SNode) parameters[0]));
      case 2:
        return (T) ((Integer) compareTo_id5x677oPpPUY(node, (SNode) parameters[0]));
      default:
        throw new BHMethodNotFoundException(this, method);
    }
  }

  @Override
  protected <T> T invokeSpecial0(@NotNull SAbstractConcept concept, @NotNull SMethod<T> method, @Nullable Object[] parameters) {
    int methodIndex = BH_METHODS.indexOf(method);
    if (methodIndex < 0) {
      throw new BHMethodNotFoundException(this, method);
    }
    switch (methodIndex) {
      default:
        throw new BHMethodNotFoundException(this, method);
    }
  }

  @NotNull
  @Override
  public List<SMethod<?>> getDeclaredMethods() {
    return BH_METHODS;
  }

  @NotNull
  @Override
  public SAbstractConcept getConcept() {
    return CONCEPT;
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink type$LqL3 = MetaAdapterFactory.getContainmentLink(0x47f075a6558e4640L, 0xa6067ce0236c8023L, 0x778ee47a6de85e1bL, 0x4976653a525f5059L, "type");
    /*package*/ static final SReferenceLink child$VWZm = MetaAdapterFactory.getReferenceLink(0x47f075a6558e4640L, 0xa6067ce0236c8023L, 0x778ee47a6de85e1bL, 0x778ee47a6de85e1eL, "child");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept TypedChildConstraint$uD = MetaAdapterFactory.getConcept(0x47f075a6558e4640L, 0xa6067ce0236c8023L, 0x778ee47a6de85e1bL, "com.mbeddr.mpsutil.interpreter.structure.TypedChildConstraint");
  }
}
