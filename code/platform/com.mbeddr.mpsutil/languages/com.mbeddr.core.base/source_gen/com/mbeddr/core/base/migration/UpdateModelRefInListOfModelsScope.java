package com.mbeddr.core.base.migration;

/*Generated by MPS */

import jetbrains.mps.lang.migration.runtime.base.MigrationScriptBase;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.module.SModule;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.smodel.ModuleRepositoryFacade;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.behavior.ModelReferenceExpression__BehaviorDescriptor;
import jetbrains.mps.lang.modelapi.behavior.ModelPointer__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.migration.runtime.base.Problem;
import java.util.Deque;
import jetbrains.mps.internal.collections.runtime.LinkedListSequence;
import java.util.LinkedList;
import org.jetbrains.mps.openapi.module.SearchScope;
import jetbrains.mps.lang.smodel.query.runtime.CommandUtil;
import jetbrains.mps.project.EditableFilteringScope;
import jetbrains.mps.lang.smodel.query.runtime.QueryExecutionContext;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import jetbrains.mps.lang.migration.runtime.base.NotMigratedNode;
import jetbrains.mps.lang.migration.runtime.base.MigrationScriptReference;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class UpdateModelRefInListOfModelsScope extends MigrationScriptBase {
  private final String description = "Replace child `models` of ListOfModelsScope from ModelReferenceExpression to ModelPointerExpression";
  public String getCaption() {
    return description;
  }
  @Override
  public boolean isRerunnable() {
    return true;
  }
  public SNode execute(final SModule m) {
    doExecute(m);
    return null;
  }
  public void doExecute(final SModule m) {
    for (final SModel mdl : m.getModels()) {
      final ModuleRepositoryFacade mrf = new ModuleRepositoryFacade(mdl.getRepository());
      ListSequence.fromList(SModelOperations.nodes(mdl, CONCEPTS.ListOfModelsScope$y)).visitAll((final SNode loms) -> ListSequence.fromList(SLinkOperations.getChildren(loms, LINKS.models_old$thV3)).visitAll((mre) -> {
        SModel modelFromExpr = mrf.getModelByName(ModelReferenceExpression__BehaviorDescriptor.getFQName_id7K4mn_BeEzv.invoke(mre));
        if (modelFromExpr != null) {
          ListSequence.fromList(SLinkOperations.getChildren(loms, LINKS.models$jnaa)).addElement(ModelPointer__BehaviorDescriptor.create_id_GDk1qZ2JP.invoke(SNodeOperations.asSConcept(CONCEPTS.ModelPointer$6N), mdl, modelFromExpr));
          SNodeOperations.deleteNode(mre);
        }
      }));
    }
  }
  @Override
  public Iterable<Problem> check(SModule m) {
    final Deque<Problem> res = LinkedListSequence.fromLinkedList(new LinkedList<Problem>());
    {
      SearchScope scope_x8j8a6_b0f = CommandUtil.createScope(m);
      final SearchScope scope_x8j8a6_b0f_0 = new EditableFilteringScope(scope_x8j8a6_b0f);
      QueryExecutionContext context = () -> scope_x8j8a6_b0f_0;
      CollectionSequence.fromCollection(CommandUtil.instances(CommandUtil.selectScope(null, context), CONCEPTS.ModelReferenceExpression$vc, false)).where((it) -> SNodeOperations.hasRole(it, LINKS.models_old$thV3)).visitAll((mre) -> {
        LinkedListSequence.fromLinkedListNew(res).addElement(new NotMigratedNode(mre) {
          @Override
          public String getMessage() {
            return "Deprecated model expression was not migrated - referenced model was not found in the repository.";
          }
        });
      });
    }
    return res;
  }
  public MigrationScriptReference getReference() {
    return new MigrationScriptReference(MetaAdapterFactory.getLanguage(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, "com.mbeddr.core.base"), 5);
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept ListOfModelsScope$y = MetaAdapterFactory.getConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x4f3a022259f10d65L, "com.mbeddr.core.base.structure.ListOfModelsScope");
    /*package*/ static final SConcept ModelPointer$6N = MetaAdapterFactory.getConcept(0x446c26eb2b7b4bf0L, 0x9b35f83fa582753eL, 0x502fe7548a0e360L, "jetbrains.mps.lang.modelapi.structure.ModelPointer");
    /*package*/ static final SConcept ModelReferenceExpression$vc = MetaAdapterFactory.getConcept(0x7866978ea0f04cc7L, 0x81bc4d213d9375e1L, 0x7c3f2da20e92b62L, "jetbrains.mps.lang.smodel.structure.ModelReferenceExpression");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink models_old$thV3 = MetaAdapterFactory.getContainmentLink(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x4f3a022259f10d65L, 0x4f3a022259f10ecaL, "models_old");
    /*package*/ static final SContainmentLink models$jnaa = MetaAdapterFactory.getContainmentLink(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x4f3a022259f10d65L, 0x837d39246e21d48L, "models");
  }
}
