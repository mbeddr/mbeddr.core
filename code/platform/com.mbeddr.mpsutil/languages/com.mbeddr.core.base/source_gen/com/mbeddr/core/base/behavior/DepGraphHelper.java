package com.mbeddr.core.base.behavior;

/*Generated by MPS */

import com.mbeddr.mpsutil.jung.behavior.JNGraph;
import com.mbeddr.mpsutil.jung.behavior.JNFRLayout;
import com.mbeddr.mpsutil.jung.behavior.JNHighlightMode;
import edu.uci.ics.jung.visualization.util.VertexShapeFactory;
import com.mbeddr.mpsutil.jung.behavior.JNNode;
import java.awt.Color;
import com.mbeddr.mpsutil.jung.behavior.ShapeFactory;
import com.mbeddr.mpsutil.jung.behavior.JNEdge;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.List;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SConcept;

public class DepGraphHelper {

  public static JNGraph createGraph(String name) {
    final JNGraph graph = new JNGraph("dependencies: " + name, new JNFRLayout(), new JNHighlightMode(true, true, false, false), 600);

    final VertexShapeFactory<JNNode> vf = new VertexShapeFactory<JNNode>();
    graph.vertexFillColor = (JNNode n) -> {
      if (n.kindIs("chunk")) {
        return new Color((int) (n.relativeEdgeNumber() * 200) + 50, 0, 0);
      }
      return Color.blue;
    };
    graph.vertexShape = (JNNode n) -> {
      if (n.kindIs("chunk")) {
        return ShapeFactory.rectangle(n, ((int) (10 + (n.relativeCharacteristicSize() * 40))));
      }
      return ShapeFactory.circle(n, 10);
    };
    graph.edgeColor = (JNEdge edge) -> {
      if (edge.kindIs("imports")) {
        return Color.black;
      }
      if (edge.kindIs("calls")) {
        return Color.blue;
      }
      return Color.gray;
    };
    graph.edgeWidth = (JNEdge edge) -> {
      if (edge.kindIs("imports")) {
        return 3.5f;
      }
      return 1.5f;
    };
    graph.edgeDash = (JNEdge edge) -> {
      if (edge.kindIs("calls")) {
        return 7;
      }
      return -1;
    };
    return graph;
  }

  public static JNNode addChunk(final SNode chunk, final JNGraph g, final Map<SNode, JNNode> cycleDetector) {
    if (MapSequence.fromMap(cycleDetector).get(chunk) != null) {
      return MapSequence.fromMap(cycleDetector).get(chunk);
    }
    final JNNode vsource = g.createVertex(chunk, SPropertyOperations.getString(chunk, PROPS.name$MnvL), Sequence.fromIterable(Chunk__BehaviorDescriptor.allReferenceableContentsInChunk_id6clJcrKmVSn.invoke(chunk)).count(), "chunk");
    Sequence.fromIterable(Chunk__BehaviorDescriptor.dependencies_id6clJcrJYPM5.invoke(chunk)).visitAll((it) -> {
      g.createDirectedEdge(SPropertyOperations.getString(chunk, PROPS.name$MnvL), SPropertyOperations.getString(IChunkDependency__BehaviorDescriptor.chunk_id6clJcrJZN1z.invoke(it), PROPS.name$MnvL), it, "imports", SPropertyOperations.getString(chunk, PROPS.name$MnvL).charAt(0));
      addChunk(IChunkDependency__BehaviorDescriptor.chunk_id6clJcrJZN1z.invoke(it), g, cycleDetector);
    });
    Sequence.fromIterable(Chunk__BehaviorDescriptor.allReferenceableContentsInChunk_id6clJcrKmVSn.invoke(chunk)).visitAll((it) -> addContent(vsource, it, g));
    MapSequence.fromMap(cycleDetector).put(chunk, vsource);
    return vsource;
  }

  public static JNNode addContent(JNNode vsource, SNode nc, JNGraph g) {
    if (SNodeOperations.isInstanceOf(nc, CONCEPTS.IEmpty$6_)) {
      return null;
    }
    if (SNodeOperations.isInstanceOf(nc, CONCEPTS.INamedConcept$Kd)) {
      JNNode v = g.createVertex(nc, SPropertyOperations.getString(SNodeOperations.cast(nc, CONCEPTS.INamedConcept$Kd), PROPS.name$MnvL), 10, "content");
      g.createDirectedEdge(vsource.getID(), v.getID(), null, "owns");
      addContentDep(SNodeOperations.cast(nc, CONCEPTS.INamedConcept$Kd), g);
      return v;
    }
    return null;
  }

  public static void addContentDep(final SNode s, final JNGraph g) {
    List<SNode> allRefs = SNodeOperations.getNodeDescendants(s, CONCEPTS.IReference$Yo, false, new SAbstractConcept[]{});
    Iterable<SNode> refsToOtherChunk = ListSequence.fromList(allRefs).where((it) -> SNodeOperations.getNodeAncestor(IReference__BehaviorDescriptor.target_id70kXLV4LLzy.invoke(it), CONCEPTS.Chunk$sT, false, false) != SNodeOperations.getNodeAncestor(it, CONCEPTS.Chunk$sT, false, false));
    Iterable<SNode> refsToNamed = Sequence.fromIterable(refsToOtherChunk).where((it) -> SNodeOperations.isInstanceOf(IReference__BehaviorDescriptor.target_id70kXLV4LLzy.invoke(it), CONCEPTS.INamedConcept$Kd));
    Iterable<SNode> withActualName = Sequence.fromIterable(refsToNamed).where((it) -> SPropertyOperations.getString(SNodeOperations.cast(IReference__BehaviorDescriptor.target_id70kXLV4LLzy.invoke(it), CONCEPTS.INamedConcept$Kd), PROPS.name$MnvL) != null);
    Iterable<SNode> toplevel = Sequence.fromIterable(withActualName).where((it) -> SNodeOperations.isInstanceOf(SNodeOperations.getParent(IReference__BehaviorDescriptor.target_id70kXLV4LLzy.invoke(it)), CONCEPTS.Chunk$sT));
    Sequence.fromIterable(toplevel).visitAll((it) -> g.createDirectedEdge(SPropertyOperations.getString(s, PROPS.name$MnvL), SPropertyOperations.getString(SNodeOperations.cast(IReference__BehaviorDescriptor.target_id70kXLV4LLzy.invoke(it), CONCEPTS.INamedConcept$Kd), PROPS.name$MnvL), it, "calls"));
  }




  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept IEmpty$6_ = MetaAdapterFactory.getInterfaceConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0xe900768cf47dcc3L, "com.mbeddr.core.base.structure.IEmpty");
    /*package*/ static final SInterfaceConcept INamedConcept$Kd = MetaAdapterFactory.getInterfaceConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, "jetbrains.mps.lang.core.structure.INamedConcept");
    /*package*/ static final SInterfaceConcept IReference$Yo = MetaAdapterFactory.getInterfaceConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x7014f71ec4c718e0L, "com.mbeddr.core.base.structure.IReference");
    /*package*/ static final SConcept Chunk$sT = MetaAdapterFactory.getConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x6315bcc6effb4ea6L, "com.mbeddr.core.base.structure.Chunk");
  }
}
