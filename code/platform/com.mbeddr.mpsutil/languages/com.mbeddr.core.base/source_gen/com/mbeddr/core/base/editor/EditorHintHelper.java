package com.mbeddr.core.base.editor;

/*Generated by MPS */

import com.intellij.openapi.project.Project;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.nodeEditor.hintsSettings.ConceptEditorHintSettings;
import jetbrains.mps.openapi.editor.descriptor.ConceptEditorHint;
import java.util.Objects;
import jetbrains.mps.smodel.language.LanguageRegistry;
import jetbrains.mps.nodeEditor.hintsSettings.ConceptEditorHintSettingsComponent;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class EditorHintHelper {

  private Project p;
  private EditorComponent comp;

  public EditorHintHelper(EditorComponent comp, Project p) {
    this.comp = comp;
    this.p = p;
  }

  public boolean hasHint(String hint) {
    if (comp == null) {
      return false;
    }
    Iterable<String> enabledHints = Sequence.fromArray(comp.getUpdater().getInitialEditorHints());
    return Sequence.fromIterable(enabledHints).contains(hint);
  }

  public boolean hasConcept(SAbstractConcept c) {
    if (comp == null) {
      return false;
    }
    SNode root = comp.getRootCell().getSNode();
    if (SNodeOperations.isInstanceOf(root, CONCEPTS.NodeAttribute$x2)) {
      root = SNodeOperations.getParent(root);
    }
    return ListSequence.fromList(SNodeOperations.getNodeDescendants(root, SNodeOperations.asSConcept(c), false, new SAbstractConcept[]{})).isNotEmpty();
  }

  public void addHint(String languageName, String newHint) {
    Set<String> enabledHints = SetSequence.fromSetWithValues(new HashSet<String>(), Sequence.fromArray(comp.getUpdater().getInitialEditorHints()));
    ConceptEditorHintSettings settings = getGlobalHintSettings();
    Set<ConceptEditorHint> allHints = settings.getHints(languageName);
    for (ConceptEditorHint h : SetSequence.fromSet(allHints)) {
      if (h.getFQName().equals(newHint)) {
        SetSequence.fromSet(enabledHints).addElement(h.getFQName());
      }
    }
    settings.updateSettings(enabledHints);
    setGlobalHints(settings.getEnabledHints());

    comp.getUpdater().setInitialEditorHints(SetSequence.fromSet(((Set<String>) settings.getEnabledHints())).toGenericArray(String.class));
    updateEditor();

  }
  public void removeHint(String languageName, String toBeRemovedHint) {
    Set<String> enabledHints = SetSequence.fromSetWithValues(new HashSet<String>(), Sequence.fromArray(comp.getUpdater().getInitialEditorHints()));
    ConceptEditorHintSettings settings = getGlobalHintSettings();
    settings.updateSettings(enabledHints);
    for (String lang : settings.getLanguagesNames()) {
      for (ConceptEditorHint hint : SetSequence.fromSet(settings.getHints(lang))) {
        if (Objects.equals(hint.getFQName(), toBeRemovedHint)) {
          settings.put(lang, hint, false);
        }
      }
    }
    setGlobalHints(settings.getEnabledHints());

    comp.getUpdater().setInitialEditorHints(SetSequence.fromSet(((Set<String>) settings.getEnabledHints())).toGenericArray(String.class));
    updateEditor();

  }
  public void updateEditor() {
    comp.getEditorContext().getRepository().getModelAccess().runReadAction(new Runnable() {
      @Override
      public void run() {
        comp.rebuildEditorContent();
      }
    });
  }

  private ConceptEditorHintSettings getGlobalHintSettings() {
    ConceptEditorHintSettings settings = new ConceptEditorHintSettings(LanguageRegistry.getInstance());
    settings.updateSettings(ConceptEditorHintSettingsComponent.getInstance(p).getState().getEnabledHints());
    return settings;
  }

  public void setGlobalHints(Set<String> enabledHints) {
    ConceptEditorHintSettingsComponent settingsComponent = ConceptEditorHintSettingsComponent.getInstance(p);
    ConceptEditorHintSettingsComponent.HintsState state = settingsComponent.getState();
    state.setEnabledHints(enabledHints);
    settingsComponent.loadState(state);
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept NodeAttribute$x2 = MetaAdapterFactory.getConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x2eb1ad060897da54L, "jetbrains.mps.lang.core.structure.NodeAttribute");
  }
}
