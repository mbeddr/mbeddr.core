package com.mbeddr.core.base.behavior;

/*Generated by MPS */

import java.util.Set;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import org.jetbrains.mps.openapi.model.SReference;
import org.jetbrains.mps.openapi.module.FindUsagesFacade;
import jetbrains.mps.project.AbstractModule;
import jetbrains.mps.progress.EmptyProgressMonitor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;

public class ReferenceFindUtil {

  public static Set<SNode> findRefsTo(SNode target, SModel m, SNode conceptFilter) {
    Set<SNode> results = SetSequence.fromSet(new HashSet<SNode>());
    SetSequence.fromSet(results).addElement(target);
    Set<SReference> resRefs = FindUsagesFacade.getInstance().findUsages(((AbstractModule) m.getModule()).getScope(), results, new EmptyProgressMonitor());
    for (SReference ref : SetSequence.fromSet(resRefs)) {
      SNode source = ref.getSourceNode();
      if (conceptFilter == null) {
        SetSequence.fromSet(results).addElement(source);
      } else {
        if (SNodeOperations.isInstanceOf(source, SNodeOperations.asSConcept(conceptFilter))) {
          SetSequence.fromSet(results).addElement(source);
        }
      }
    }
    return results;
  }


}
