package com.mbeddr.core.base.behavior;

/*Generated by MPS */

import java.awt.image.BufferedImage;

public class ImageTrimmer {
  public BufferedImage getCroppedImage(BufferedImage source, double tolerance) {
    //  Get our top-left pixel color as our "baseline" for cropping
    int baseColor = source.getRGB(0, 0);
    int width = source.getWidth();
    int height = source.getHeight();
    int topY = Integer.MAX_VALUE;
    int topX = Integer.MAX_VALUE;
    int bottomY = -1;
    int bottomX = -1;
    for (int y = 0; y < height; y++) {
      for (int x = 0; x < width; x++) {
        if (colorWithinTolerance(baseColor, source.getRGB(x, y), tolerance)) {
          if (x < topX) {
            topX = x;
          }
          if (y < topY) {
            topY = y;
          }
          if (x > bottomX) {
            bottomX = x;
          }
          if (y > bottomY) {
            bottomY = y;
          }
        }
      }
    }
    // The trimming was too eager, it cut away stuff. Correcting.
    if (topX >= 2) {
      topX -= 2;
    }
    if (topY >= 2) {
      topY -= 2;
    }
    if (width - bottomX >= 3) {
      bottomX += 3;
    }
    if (height - bottomY >= 3) {
      bottomY += 3;
    }
    BufferedImage destination = new BufferedImage((bottomX - topX), (bottomY - topY + 1), BufferedImage.TYPE_INT_ARGB);
    destination.getGraphics().drawImage(source, 0, 0, destination.getWidth(), destination.getHeight(), topX, topY, bottomX, bottomY, null);
    return destination;
  }
  private boolean colorWithinTolerance(int a, int b, double tolerance) {
    int aAlpha = (int) ((a & -16777216) >>> 24);
    //  Alpha level
    int aRed = (int) ((a & 16711680) >>> 16);
    //  Red level
    int aGreen = (int) ((a & 65280) >>> 8);
    //  Green level
    int aBlue = (int) (a & 255);
    //  Blue level
    int bAlpha = (int) ((b & -16777216) >>> 24);
    //  Alpha level
    int bRed = (int) ((b & 16711680) >>> 16);
    //  Red level
    int bGreen = (int) ((b & 65280) >>> 8);
    //  Green level
    int bBlue = (int) (b & 255);
    //  Blue level
    double distance = Math.sqrt((aAlpha - bAlpha) * (aAlpha - bAlpha) + (aRed - bRed) * (aRed - bRed) + (aGreen - bGreen) * (aGreen - bGreen) + (aBlue - bBlue) * (aBlue - bBlue));
    //  510.0 is the maximum distance between two colors
    //  (0,0,0,0 -> 255,255,255,255)
    double percentAway = distance / 510.0;
    return (percentAway > tolerance);
  }
}
