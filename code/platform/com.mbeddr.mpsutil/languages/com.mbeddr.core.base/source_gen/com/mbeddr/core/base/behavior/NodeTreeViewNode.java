package com.mbeddr.core.base.behavior;

/*Generated by MPS */

import org.jetbrains.mps.openapi.module.SRepository;
import org.jetbrains.mps.openapi.model.SNodeReference;
import org.jetbrains.mps.openapi.model.SNode;
import javax.swing.Icon;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.ide.icons.GlobalIconManager;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.smodel.ModelAccess;
import java.awt.Color;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SProperty;

public abstract class NodeTreeViewNode extends AbstractTreeViewNode {
  private SRepository repository;
  protected SNodeReference nodeptr;


  public NodeTreeViewNode(SNode n, String category, String[] allCats) {
    super(null, null, category, allCats);
    nodeptr = n.getReference();
    repository = n.getModel().getRepository();
    updateLabel(n);
    updateIcon(n);
  }

  public NodeTreeViewNode(SNode n, String label, String category, String[] allCats) {
    super(null, null, category, allCats);
    nodeptr = n.getReference();
    repository = n.getModel().getRepository();
    this.label = label;
    updateIcon(n);
  }

  public NodeTreeViewNode(SNode n, String label, Icon icon, String category, String[] allCats) {
    super(null, null, category, allCats);
    nodeptr = n.getReference();
    repository = n.getModel().getRepository();
    this.label = label;
    this.icon = icon;
  }

  public void disableSelectOnClick() {
    doubleClickSelectsNode = false;
  }

  public void updateLabel(SNode n) {
    if (SNodeOperations.isInstanceOf(n, CONCEPTS.INamedConcept$Kd)) {
      label = SPropertyOperations.getString(SNodeOperations.cast(n, CONCEPTS.INamedConcept$Kd), PROPS.name$MnvL);
    } else {
      label = "<unnamed> " + SNodeOperations.getConcept(n).getName();
    }
  }

  public void updateIcon(SNode n) {
    icon = GlobalIconManager.getInstance().getIconFor(n);
  }


  public SNode getProgramNode() {
    final Wrappers._T<SNode> node = new Wrappers._T<SNode>();
    ModelAccess.instance().runReadAction(() -> node.value = nodeptr.resolve(repository));
    return node.value;
  }

  public TreeNodeStyle getStyle() {
    if (this.getParent() != null && getProgramNode() == getRootProgramNode()) {
      return new TreeNodeStyle(Color.RED, false, false);
    }
    if (parent instanceof NodeTreeViewNode) {
      if (SNodeOperations.getModel(((NodeTreeViewNode) parent).getProgramNode()) != SNodeOperations.getModel(this.getProgramNode())) {
        return new TreeNodeStyle(Color.GRAY, false, false);
      }
    }
    return TreeNodeStyle.DEFAULT;
  }


  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept INamedConcept$Kd = MetaAdapterFactory.getInterfaceConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, "jetbrains.mps.lang.core.structure.INamedConcept");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
