package com.mbeddr.core.base.editor;

/*Generated by MPS */

import java.awt.Color;
import javax.swing.JLabel;
import org.jetbrains.mps.openapi.model.SNode;
import javax.swing.Icon;
import org.jetbrains.annotations.Nullable;
import nl.f1re.mps.editor.swing.runtime.FontHelper;
import java.awt.Dimension;
import javax.swing.SwingConstants;
import javax.swing.BorderFactory;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.workbench.MPSDataKeys;
import com.intellij.ide.DataManager;

public abstract class CommandButton {
  private static Color grey = new Color(240, 240, 240);
  private static Color dark = new Color(210, 210, 210);
  private static Color darker = new Color(120, 120, 120);
  private int buttonHeight = 9;

  public JLabel create(final SNode n, String label) {
    JLabel l = build(n, label);
    return l;
  }

  public JLabel create(final SNode n, String label, int height) {
    this.buttonHeight = height;
    JLabel l = build(n, label);
    return l;
  }

  public JLabel create(final SNode n, Icon icon) {
    JLabel l = build(n, null);
    l.setIcon(icon);
    return l;
  }

  protected JLabel build(final SNode n, @Nullable final String text) {
    int lengthInLetters = (text != null ? text.length() : 1);
    int fontSize = FontHelper.verySmall().asBold().getSize();
    int height = fontSize + this.buttonHeight;
    final JLabel l = new JLabel() {
      @Override
      public String toString() {
        return ((text != null && text.length() > 0) ? text : "");
      }
    };
    l.setMinimumSize(new Dimension(0, height));

    int factor = fontSize - 5;
    l.setPreferredSize(new Dimension(20 + factor * lengthInLetters, height));
    l.setMaximumSize(new Dimension(300, height));
    l.setHorizontalAlignment(SwingConstants.CENTER);
    l.setVerticalAlignment(SwingConstants.CENTER);
    l.setVerticalTextPosition(JLabel.CENTER);
    l.setOpaque(true);
    l.setBorder(BorderFactory.createEtchedBorder());

    l.setBackground(grey);
    l.setForeground(darker);
    l.addMouseListener(new MouseAdapter() {
      public void mousePressed(MouseEvent mouseEvent) {
        l.setBackground(dark);
      }

      public void mouseReleased(MouseEvent mouseEvent) {
        l.setBackground(grey);
        // for command execution we need a repository with ProjectAccess (models are attached to a repository with GlobalModelAccess which doesn't support running actions)
        MPSProject mpsProject = MPSDataKeys.MPS_PROJECT.getData(DataManager.getInstance().getDataContext(mouseEvent.getComponent()));
        assert mpsProject != null;
        mpsProject.getRepository().getModelAccess().executeCommand(() -> perform(n));
      }
    });

    if ((text != null && text.length() > 0)) {
      l.setText(text);
    }

    return l;
  }

  public abstract void perform(SNode n);
}
