package com.mbeddr.mpsutil.nodes_tracing.test.nodes_tracing_utils;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.List;
import java.util.ArrayList;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.smodel.MPSModuleRepository;
import jetbrains.mps.textgen.trace.DefaultTraceInfoProvider;
import jetbrains.mps.textgen.trace.DebugInfo;
import org.jetbrains.mps.openapi.model.SNodeReference;

public class NodesTracingUtils {

  private static boolean DEBUG = true;

  /**
   * Returns the first original node that is traced to a certain file and line.
   */
  public static SNode findOriginalNode(String fileName, int line) throws IllegalArgumentException {
    return ListSequence.fromList(findAllPossibleOriginalNodes(fileName, line)).first();
  }

  /**
   * Returns all possible original nodes that can be traced to a certain file and line.
   */
  public static List<SNode> findAllPossibleOriginalNodes(String file, final int line) throws IllegalArgumentException {
    final List<SNode> originalNodes = new ArrayList<SNode>();

    final String fileName = NodeUtils.getFileName(file);
    String unitName = NodeUtils.getUnitNameFromPath(file);
    final SRepository contextRepository = MPSModuleRepository.getInstance();
    new DefaultTraceInfoProvider(contextRepository).debugInfo(unitName.substring(0, unitName.lastIndexOf('.'))).forEach((DebugInfo di) -> {
      for (SNodeReference np : di.getTracedNodesForPosition(fileName, line)) {
        SNode resolved = np.resolve(contextRepository);
        if (resolved != null) {
          ListSequence.fromList(originalNodes).addElement(resolved);
        }
      }
    });

    if (DEBUG) {
      System.err.println("NODES TRACING DEBUG:\n\t path: " + file + "\n\t fileName: " + fileName + "\n\t unitName: " + unitName);
      System.err.println("\t originalNodes: " + originalNodes);
      System.err.println("<<<");
    }

    return originalNodes;
  }

}
