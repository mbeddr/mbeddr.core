package com.mbeddr.mpsutil.nodes_tracing.test.nodes_tracing_utils;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.project.AbstractModule;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.smodel.ModelAccess;
import java.io.File;
import jetbrains.mps.smodel.SModelOperations;

public class PathsUtils {

  public static String GENERATED_ARTEFACTS_FOLDER = "generated_artefacts";

  public static String computePathToGeneratedDirectory(final SModel aModel) {
    final Wrappers._T<String> computedPath = new Wrappers._T<String>();

    if (aModel.getModule().isPackaged()) {
      // we come here if the module resides in a JAR file (e.g. from JUnit tests on the build server)
      AbstractModule am = (AbstractModule) (aModel.getModule());
      IFile dir = am.getModuleSourceDir();
      final Wrappers._T<String> packageName = new Wrappers._T<String>();
      ModelAccess.instance().runReadAction(() -> {
        try {
          packageName.value = aModel.getName().getLongName().replace(".", "/");
        } catch (Exception e) {
          e.printStackTrace();
        }
      });
      String[] segments = dir.getPath().split(File.separator);
      String patchedBasePath = "";
      for (int i = 0; i < segments.length - 2; i++) {
        patchedBasePath = patchedBasePath + File.separator + segments[i];
      }
      computedPath.value = patchedBasePath + File.separator + PathsUtils.GENERATED_ARTEFACTS_FOLDER + File.separator + packageName.value;
    } else {
      ModelAccess.instance().runReadAction(() -> {
        try {
          {
            IFile outputLocation = SModelOperations.getOutputLocation(aModel);
            if (outputLocation == null) {
              throw new RuntimeException("Output location for " + aModel.getName().getLongName() + " model not found");
            }
            computedPath.value = outputLocation.getPath();
          }
        } catch (Exception e) {
          e.printStackTrace();
        }
      });
    }

    return computedPath.value;
  }

}
