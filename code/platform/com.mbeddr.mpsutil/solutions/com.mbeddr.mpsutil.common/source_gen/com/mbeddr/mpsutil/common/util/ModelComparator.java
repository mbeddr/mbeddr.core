package com.mbeddr.mpsutil.common.util;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.core.behavior.INamedConcept__BehaviorDescriptor;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.IterableUtils;
import java.util.Objects;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.mps.openapi.model.SReference;
import java.util.LinkedList;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class ModelComparator {
  public ModelComparator(SNode expected, SNode actual) {
    this.expected = expected;
    this.actual = actual;
  }

  public static String buildFqn(SNode node) {
    if (SNodeOperations.isInstanceOf(node, CONCEPTS.INamedConcept$Kd)) {
      return INamedConcept__BehaviorDescriptor.getFqName_idhEwIO9y.invoke(SNodeOperations.cast(node, CONCEPTS.INamedConcept$Kd));
    }

    List<String> elements = ListSequence.fromList(new ArrayList<String>());

    SNode currentNode = node;

    while ((currentNode != null)) {
      if (SNodeOperations.isInstanceOf(currentNode, CONCEPTS.INamedConcept$Kd)) {
        ListSequence.fromList(elements).addElement(INamedConcept__BehaviorDescriptor.getFqName_idhEwIO9y.invoke(SNodeOperations.cast(currentNode, CONCEPTS.INamedConcept$Kd)));
        break;
      } else {
        ListSequence.fromList(elements).addElement("[" + check_8skk0v_a0a0a0a0a0a0g0c(SNodeOperations.getConcept(currentNode)) + "@" + SNodeOperations.getIndexInParent(currentNode) + "]");
      }

      currentNode = SNodeOperations.getParent(currentNode);
    }

    return IterableUtils.join(ListSequence.fromList(elements).reversedList(), ".");
  }

  public boolean compare() {
    return compareNodes(this.expected, this.actual);
  }

  public List<ModelComparatorMismatch> getMismatches() {
    return this.mismatches;
  }

  protected boolean compareNodes(SNode expected, SNode actual) {

    if (!(compareConcepts(expected, actual, expected, actual, "node"))) {
      return false;
    }

    boolean result = true;

    result &= compareProperties(expected, actual);

    result &= compareReferences(expected, actual);

    result &= compareChildren(expected, actual);

    return result;
  }

  protected boolean compareConcepts(SNode expectedConceptNode, SNode actualConceptNode, SNode expected, SNode actual, String message) {
    if (Objects.equals(SNodeOperations.getConcept(expected), SNodeOperations.getConcept(actual))) {
      return true;
    } else {
      reportMismatch(expected, actual, message + "[concepts differ]", SNodeOperations.getConcept(expected), SNodeOperations.getConcept(actual));
      return false;
    }
  }


  protected boolean compareProperties(SNode expected, SNode actual) {
    List<SProperty> expectedProperties = Sequence.fromIterable(((Iterable<SProperty>) expected.getProperties())).toList();
    List<SProperty> actualProperties = Sequence.fromIterable(((Iterable<SProperty>) actual.getProperties())).toList();

    if (!(compareLists(ListSequence.fromList(expectedProperties).select((it) -> it.getName()).toList(), ListSequence.fromList(actualProperties).select((it) -> it.getName()).toList(), expected, actual, "Properties"))) {
      return false;
    }

    boolean result = true;

    for (SProperty prop : ListSequence.fromList(expectedProperties)) {
      result &= compareProperty(expected, actual, prop);
    }

    return result;

  }
  protected boolean compareProperty(SNode expected, SNode actual, SProperty prop) {
    String expectedValue = expected.getProperty(prop);
    String actualValue = actual.getProperty(prop);
    if (Objects.equals(expectedValue, actualValue)) {
      return true;
    } else {
      reportMismatch(expected, actual, "Value of property '" + prop + "' differs", expectedValue, actualValue);
      return false;
    }
  }


  protected boolean compareReferences(SNode expected, SNode actual) {
    if (!(compareLists(ListSequence.fromList(SNodeOperations.getReferences(expected)).select((it) -> SLinkOperations.getRefLink(it)).toList(), ListSequence.fromList(SNodeOperations.getReferences(actual)).select((it) -> SLinkOperations.getRefLink(it)).toList(), expected, actual, "References"))) {
      return false;
    }

    boolean result = true;

    for (SReference reference : ListSequence.fromList(SNodeOperations.getReferences(expected))) {
      result &= compareReference(expected, actual, reference);
    }

    return result;
  }
  protected boolean compareReference(SNode expected, SNode actual, SReference reference) {
    SReference expectedReference = SNodeOperations.getReference(expected, reference.getLink());
    SReference actualReference = SNodeOperations.getReference(actual, reference.getLink());

    boolean result = true;

    if (!(Objects.equals(check_8skk0v_a0f0s_0(SLinkOperations.getRefLink(expectedReference)), check_8skk0v_a0f0s(SLinkOperations.getRefLink(actualReference))))) {
      result = false;
      reportMismatch(expected, actual, "role of reference '" + reference + "' differs", check_8skk0v_d0b0f0s(SLinkOperations.getRefLink(expectedReference)), check_8skk0v_e0b0f0s(SLinkOperations.getRefLink(actualReference)));
    }

    if ((SLinkOperations.getTargetNode(expectedReference) != null) != (SLinkOperations.getTargetNode(actualReference) != null)) {
      result = false;
      reportMismatch(expected, actual, "target of reference '" + reference + "' not set at both sides", (SLinkOperations.getTargetNode(expectedReference) != null), (SLinkOperations.getTargetNode(actualReference) != null));
    }

    if ((SLinkOperations.getTargetNode(expectedReference) != null) && (SLinkOperations.getTargetNode(actualReference) != null)) {
      if (!(compareConcepts(SLinkOperations.getTargetNode(expectedReference), SLinkOperations.getTargetNode(actualReference), expected, actual, "target of reference '" + reference + "'"))) {
        result = false;
      }
    }

    return result;
  }


  protected boolean compareChildren(SNode expected, SNode actual) {
    if (!(compareLists(ListSequence.fromList(SNodeOperations.getChildren(expected)).select((it) -> check_8skk0v_a0a0a0a0a0a0a0v(SNodeOperations.getContainingLink(it)) + "[" + SNodeOperations.getIndexInParent(it) + "]").toList(), ListSequence.fromList(SNodeOperations.getChildren(actual)).select((it) -> check_8skk0v_a0a0a0a0a1a0a0v(SNodeOperations.getContainingLink(it)) + "[" + SNodeOperations.getIndexInParent(it) + "]").toList(), expected, actual, "Children"))) {
      return false;
    }

    boolean result = true;

    for (SNode child : ListSequence.fromList(SNodeOperations.getChildren(expected))) {
      result &= compareChild(expected, actual, SNodeOperations.getContainingLinkRole(child), SNodeOperations.getIndexInParent(child));
    }

    return result;
  }
  protected boolean compareChild(SNode expected, SNode actual, final String role, final int index) {
    return compareNodes(ListSequence.fromList(SNodeOperations.getChildren(expected)).findFirst((it) -> Objects.equals(check_8skk0v_a0a0a0a0a0a22(SNodeOperations.getContainingLink(it)), role) && Objects.equals(SNodeOperations.getIndexInParent(it), index)), ListSequence.fromList(SNodeOperations.getChildren(actual)).findFirst((it) -> Objects.equals(check_8skk0v_a0a0a0a1a0a22(SNodeOperations.getContainingLink(it)), role) && Objects.equals(SNodeOperations.getIndexInParent(it), index)));
  }


  protected <T> boolean compareLists(List<T> expectedList, List<T> actualList, SNode expected, SNode actual, String message) {
    if (Objects.equals(expectedList, actualList)) {
      return true;
    } else {
      if (ListSequence.fromList(expectedList).count() == ListSequence.fromList(actualList).count()) {
        for (int i = 0; i < ListSequence.fromList(expectedList).count(); i++) {
          if (!(Objects.equals(ListSequence.fromList(expectedList).getElement(i), ListSequence.fromList(actualList).getElement(i)))) {
            reportMismatch(expected, actual, message + "[" + i + "]", ListSequence.fromList(expectedList).getElement(i), ListSequence.fromList(actualList).getElement(i));
          }
        }
      } else {
        reportMismatch(expected, actual, message + "[list size differs]", ListSequence.fromList(expectedList).count(), ListSequence.fromList(actualList).count());

        List<T> expectedListClone = ListSequence.fromListWithValues(new ArrayList<T>(), expectedList);
        List<T> actualListClone = ListSequence.fromListWithValues(new ArrayList<T>(), actualList);

        for (T obj : ListSequence.fromList(expectedList)) {
          ListSequence.fromList(actualListClone).removeElement(obj);
        }

        for (T obj : ListSequence.fromList(actualList)) {
          ListSequence.fromList(expectedListClone).removeElement(obj);
        }

        if (ListSequence.fromList(expectedListClone).isNotEmpty()) {
          reportMismatch(expected, actual, message + "[missing from expected list]", expectedListClone, null);
        }
        if (ListSequence.fromList(actualListClone).isNotEmpty()) {
          reportMismatch(expected, actual, "[more than expected list]", null, actualListClone);
        }
      }

      return false;
    }
  }

  protected void reportMismatch(SNode expected, SNode actual, String message, Object expectedValue, Object actualValue) {
    ListSequence.fromList(this.getMismatches()).addElement(new ModelComparatorMismatch(expected, actual, message, expectedValue, actualValue));
  }

  private final SNode expected;
  private final SNode actual;

  private final List<ModelComparatorMismatch> mismatches = ListSequence.fromList(new LinkedList<ModelComparatorMismatch>());
  private static String check_8skk0v_a0a0a0a0a0a0g0c(SAbstractConcept checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getName();
    }
    return null;
  }
  private static String check_8skk0v_d0b0f0s(SReferenceLink checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getName();
    }
    return null;
  }
  private static String check_8skk0v_e0b0f0s(SReferenceLink checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getName();
    }
    return null;
  }
  private static String check_8skk0v_a0f0s(SReferenceLink checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getName();
    }
    return null;
  }
  private static String check_8skk0v_a0f0s_0(SReferenceLink checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getName();
    }
    return null;
  }
  private static String check_8skk0v_a0a0a0a0a0a0a0v(SContainmentLink checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getName();
    }
    return null;
  }
  private static String check_8skk0v_a0a0a0a0a1a0a0v(SContainmentLink checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getName();
    }
    return null;
  }
  private static String check_8skk0v_a0a0a0a0a0a22(SContainmentLink checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getName();
    }
    return null;
  }
  private static String check_8skk0v_a0a0a0a1a0a22(SContainmentLink checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getName();
    }
    return null;
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept INamedConcept$Kd = MetaAdapterFactory.getInterfaceConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, "jetbrains.mps.lang.core.structure.INamedConcept");
  }
}
