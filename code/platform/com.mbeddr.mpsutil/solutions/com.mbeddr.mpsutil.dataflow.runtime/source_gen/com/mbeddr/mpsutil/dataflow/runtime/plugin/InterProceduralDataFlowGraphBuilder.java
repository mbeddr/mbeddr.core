package com.mbeddr.mpsutil.dataflow.runtime.plugin;

/*Generated by MPS */

import jetbrains.mps.lang.dataFlow.MPSProgramBuilder;
import jetbrains.mps.lang.dataFlow.framework.ProgramBuilderContext;
import jetbrains.mps.lang.dataFlow.framework.Program;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.dataFlow.DataFlowBuilderContext;
import java.util.HashMap;

public class InterProceduralDataFlowGraphBuilder extends MPSProgramBuilder {

  protected InterProceduralDataFlowGraph parent;
  protected NestedProgramInstruction instruction;

  public InterProceduralDataFlowGraphBuilder() {
    super();
  }

  public InterProceduralDataFlowGraphBuilder(ProgramBuilderContext programBuilderContext) {
    this(null, null, programBuilderContext);
  }

  public InterProceduralDataFlowGraphBuilder(final InterProceduralDataFlowGraph parent, final NestedProgramInstruction instruction, ProgramBuilderContext programBuilderContext) {
    super(null, new InterProcInstructionBuilder(), programBuilderContext);
    this.parent = parent;
    this.instruction = instruction;
  }

  @Override
  protected Program createProgram() {
    InterProceduralDataFlowGraph program = new InterProceduralDataFlowGraph();
    if (parent != null) {
      program.setParent(parent);
    }
    if (instruction != null) {
      instruction.setNestedProgram(program);
      program.setTriggeringInstruction(instruction);
    }
    return program;
  }

  @Override
  public InterProceduralDataFlowGraph buildProgram(SNode node) {
    build(node);
    for (Runnable r : myInvokeLater) {
      r.run();
    }
    getProgram().init();
    getProgram().getEnd().setSource(node);
    return getProgram();
  }

  @Override
  protected DataFlowBuilderContext createContext(SNode node) {
    return new InterProceduralDataFlowGraphBuilderContext(node, this);
  }

  /**
   * Returns the ProgramBuilderContext associated with the ProgramBuilder.
   * The ProgramBuilderContext is specific to the analysis and provides information
   * about the data-flow builder modes used during the building of the DFG.
   * 
   * @return the program builder context
   */
  public ProgramBuilderContext getProgramBuilderContext() {
    return this.getBuilderContext();
  }

  public InterProceduralDataFlowGraph getProgram() {
    return (InterProceduralDataFlowGraph) super.getProgram();
  }

  public InterProceduralDataFlowGraph getRootProgram() {
    return getProgram().getRoot();
  }

  @Override
  public void emitLabel(String label) {
    if (!(myLabels.containsKey(getProgram().getCurrentSource()))) {
      myLabels.put((SNode) getProgram().getCurrentSource(), new HashMap<String, Integer>());
    }
    myLabels.get(getProgram().getCurrentSource()).put(label, getRootProgram().size());
  }

}
