package com.mbeddr.mpsutil.xmlImport.plugin;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import org.jetbrains.mps.openapi.model.SNode;
import com.intellij.openapi.vfs.VirtualFile;
import java.io.IOException;
import java.io.InputStream;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.DocumentBuilder;
import org.w3c.dom.Document;
import javax.xml.parsers.ParserConfigurationException;
import org.xml.sax.SAXException;
import java.util.List;
import java.io.ByteArrayInputStream;
import java.nio.charset.StandardCharsets;
import org.w3c.dom.Element;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.w3c.dom.NamedNodeMap;
import java.util.ArrayList;
import org.w3c.dom.Node;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.w3c.dom.Text;
import java.util.Objects;
import org.w3c.dom.CDATASection;
import jetbrains.mps.internal.collections.runtime.NotNullWhereFilter;
import org.w3c.dom.NodeList;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SConcept;

public class XmlHelper {
  private static final Logger LOG = Logger.getLogger(XmlHelper.class);
  public static SNode importFile(VirtualFile file) {
    try {
      return importFile(file.getInputStream(), file.getNameWithoutExtension());

    } catch (IOException e) {
      if (LOG.isErrorLevel()) {
        LOG.error("", e);
      }
    }
    return null;
  }
  public static SNode importFile(InputStream stream, String name) {
    DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
    try {
      DocumentBuilder builder = factory.newDocumentBuilder();
      Document doc = builder.parse(stream);
      SNode root = element2Mps(doc.getDocumentElement());
      return createXmlFile_kq1qa_a3a1a1(name, root);

    } catch (ParserConfigurationException e) {
      if (LOG.isErrorLevel()) {
        LOG.error("", e);
      }
    } catch (SAXException e) {
      if (LOG.isErrorLevel()) {
        LOG.error("", e);
      }
    } catch (IOException e) {
      if (LOG.isErrorLevel()) {
        LOG.error("", e);
      }
    }
    return null;
  }
  public static List<SNode> stringToXmlElement(String str) {
    DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
    str = "<root>" + str + "</root>";
    try {
      DocumentBuilder builder = factory.newDocumentBuilder();
      InputStream stream = new ByteArrayInputStream(str.replaceAll("\r", "").replaceAll("\n", "").getBytes(StandardCharsets.UTF_8));
      Document doc = builder.parse(stream);
      Element root = doc.getDocumentElement();
      return Sequence.fromIterable(nodeListToSeq(root.getChildNodes())).ofType(Element.class).select((it) -> element2Mps(((Element) it))).toList();
    } catch (SAXException e) {
      if (LOG.isErrorLevel()) {
        LOG.error("", e);
      }
    } catch (IOException e) {
      if (LOG.isErrorLevel()) {
        LOG.error("", e);
      }
    } catch (ParserConfigurationException e) {
      if (LOG.isErrorLevel()) {
        LOG.error("", e);
      }
    }
    return null;
  }
  public static SNode element2Mps(Element element) {
    NamedNodeMap attributes = element.getAttributes();
    List<SNode> mpsAttributes = new ArrayList<SNode>();
    for (int i = 0; i < attributes.getLength(); i++) {
      Node item = attributes.item(i);
      String nodeName = item.getNodeName();
      String nodeValue = item.getNodeValue();
      SNode attr = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x5c842a42c54b8df3L, "jetbrains.mps.core.xml.structure.XmlAttribute"));
      SPropertyOperations.assign(attr, PROPS.attrName$omjx, nodeName);
      ListSequence.fromList(SLinkOperations.getChildren(attr, LINKS.value$1h4D)).addElement(createXmlTextValue_kq1qa_a0a5a2a3(nodeValue));
      ListSequence.fromList(mpsAttributes).addElement(attr);
    }

    Iterable<Node> nodeMapToSeq = nodeListToSeq(element.getChildNodes());
    Iterable<SNode> contents = Sequence.fromIterable(nodeMapToSeq).select((it) -> {
      switch (it.getNodeType()) {
        case Node.TEXT_NODE:
          Text text = (Text) it;
          return (Objects.equals(stripStuff(text.getTextContent()), "") ? null : createXmlText_kq1qa_a0b0a0a0a0a5a3(stripStuff(text.getTextContent())));
        case Node.ELEMENT_NODE:
          return element2Mps(((Element) it));
        case Node.CDATA_SECTION_NODE:
          CDATASection data = ((CDATASection) it);
          return createXmlCDATA_kq1qa_a1a2a0a0a0f0d(data.getData());
        default:
          System.err.println("don't know how to handle XML node type: " + it.getNodeType());
          if (LOG.isWarningLevel()) {
            LOG.warning("don't know how to handle type: " + it.getNodeType());
          }
          return null;
      }
    });
    SNode result = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x5c842a42c54b10b2L, "jetbrains.mps.core.xml.structure.XmlElement"));
    ListSequence.fromList(SLinkOperations.getChildren(result, LINKS.attributes$ZouQ)).addSequence(ListSequence.fromList(mpsAttributes));
    SPropertyOperations.assign(result, PROPS.tagName$ZoHR, element.getNodeName());
    ListSequence.fromList(SLinkOperations.getChildren(result, LINKS.content$zkQy)).addSequence(Sequence.fromIterable(contents).where(new NotNullWhereFilter()));
    return result;
  }
  private static String stripStuff(String s) {
    return trim_kq1qa_a0a0e(s.replaceAll("\r", "").replaceAll("\n", "").replaceAll("\t", ""));
  }
  private static Iterable<Node> nodeMapToSeq(NamedNodeMap map) {
    List<Node> res = ListSequence.fromList(new ArrayList<Node>());
    for (int i = 0; i < map.getLength(); i++) {
      ListSequence.fromList(res).addElement(map.item(i));
    }
    return res;
  }
  private static Iterable<Node> nodeListToSeq(NodeList map) {
    List<Node> res = ListSequence.fromList(new ArrayList<Node>());
    for (int i = 0; i < map.getLength(); i++) {
      ListSequence.fromList(res).addElement(map.item(i));
    }
    return res;
  }
  private static SNode createXmlFile_kq1qa_a3a1a1(String p0, SNode p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.XmlFile$4Z);
    n0.setProperty(PROPS.name$MnvL, p0);
    {
      SNodeBuilder n1 = n0.forChild(LINKS.document$qHEv).init(CONCEPTS.XmlDocument$i8);
      n1.forChild(LINKS.rootElement$xJAG).initNode(p1, CONCEPTS.XmlBaseElement$Ns, true);
    }
    return n0.getResult();
  }
  private static SNode createXmlTextValue_kq1qa_a0a5a2a3(String p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.XmlTextValue$29);
    n0.setProperty(PROPS.text$_LaO, p0);
    return n0.getResult();
  }
  private static SNode createXmlText_kq1qa_a0b0a0a0a0a5a3(String p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.XmlText$q9);
    n0.setProperty(PROPS.value$6Orv, p0);
    return n0.getResult();
  }
  private static SNode createXmlCDATA_kq1qa_a1a2a0a0a0f0d(String p0) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.XmlCDATA$3U);
    n0.setProperty(PROPS.content$Ce5_, p0);
    return n0.getResult();
  }
  public static String trim_kq1qa_a0a0e(String str) {
    return (str == null ? null : str.trim());
  }

  private static final class PROPS {
    /*package*/ static final SProperty attrName$omjx = MetaAdapterFactory.getProperty(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x5c842a42c54b8df3L, 0x5c842a42c54b8df6L, "attrName");
    /*package*/ static final SProperty tagName$ZoHR = MetaAdapterFactory.getProperty(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x5c842a42c54b10b2L, 0x5c842a42c54b10b6L, "tagName");
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
    /*package*/ static final SProperty text$_LaO = MetaAdapterFactory.getProperty(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x5c842a42c54cfd1fL, 0x5c842a42c54cfd20L, "text");
    /*package*/ static final SProperty value$6Orv = MetaAdapterFactory.getProperty(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x16838b3fce9aa513L, 0x16838b3fce9aaa68L, "value");
    /*package*/ static final SProperty content$Ce5_ = MetaAdapterFactory.getProperty(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x5c842a42c549487aL, 0x16838b3fce9b2633L, "content");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink value$1h4D = MetaAdapterFactory.getContainmentLink(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x5c842a42c54b8df3L, 0x5c842a42c54cfd1eL, "value");
    /*package*/ static final SContainmentLink attributes$ZouQ = MetaAdapterFactory.getContainmentLink(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x5c842a42c54b10b2L, 0x5c842a42c54b10b5L, "attributes");
    /*package*/ static final SContainmentLink content$zkQy = MetaAdapterFactory.getContainmentLink(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x5c842a42c54b10b2L, 0x16838b3fce9a4922L, "content");
    /*package*/ static final SContainmentLink document$qHEv = MetaAdapterFactory.getContainmentLink(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x5c842a42c54c94c0L, 0x5c842a42c54c94c1L, "document");
    /*package*/ static final SContainmentLink rootElement$xJAG = MetaAdapterFactory.getContainmentLink(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x5e2f66f285946ac9L, 0x5c842a42c549486fL, "rootElement");
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept XmlFile$4Z = MetaAdapterFactory.getConcept(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x5c842a42c54c94c0L, "jetbrains.mps.core.xml.structure.XmlFile");
    /*package*/ static final SConcept XmlDocument$i8 = MetaAdapterFactory.getConcept(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x5e2f66f285946ac9L, "jetbrains.mps.core.xml.structure.XmlDocument");
    /*package*/ static final SConcept XmlBaseElement$Ns = MetaAdapterFactory.getConcept(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x5c842a42c549486dL, "jetbrains.mps.core.xml.structure.XmlBaseElement");
    /*package*/ static final SConcept XmlTextValue$29 = MetaAdapterFactory.getConcept(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x5c842a42c54cfd1fL, "jetbrains.mps.core.xml.structure.XmlTextValue");
    /*package*/ static final SConcept XmlText$q9 = MetaAdapterFactory.getConcept(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x16838b3fce9aa513L, "jetbrains.mps.core.xml.structure.XmlText");
    /*package*/ static final SConcept XmlCDATA$3U = MetaAdapterFactory.getConcept(0x479c7a8c02f943b5L, 0x9139d910cb22f298L, 0x5c842a42c549487aL, "jetbrains.mps.core.xml.structure.XmlCDATA");
  }
}
