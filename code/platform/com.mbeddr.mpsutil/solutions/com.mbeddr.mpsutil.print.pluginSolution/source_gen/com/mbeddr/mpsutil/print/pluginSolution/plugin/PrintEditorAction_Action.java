package com.mbeddr.mpsutil.print.pluginSolution.plugin;

/*Generated by MPS */

import jetbrains.mps.workbench.action.BaseAction;
import javax.swing.Icon;
import jetbrains.mps.ide.editor.EditorActionAccess;
import com.intellij.openapi.actionSystem.AnActionEvent;
import java.util.Map;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.ide.editor.MPSEditorDataKeys;
import jetbrains.mps.nodeEditor.cells.EditorCell;
import java.awt.print.PrinterJob;
import java.awt.print.Printable;
import java.awt.Graphics;
import java.awt.print.PageFormat;
import java.awt.print.PrinterException;
import java.awt.Graphics2D;
import jetbrains.mps.nodeEditor.EditorSettings;
import javax.swing.SwingUtilities;
import com.intellij.openapi.ui.Messages;

public class PrintEditorAction_Action extends BaseAction {
  private static final Icon ICON = null;

  public PrintEditorAction_Action() {
    super("Print Editor", "", ICON);
    this.setIsAlwaysVisible(false);
    this.setActionAccess(EditorActionAccess.UNDO_EDITOR);
  }
  @Override
  public boolean isDumbAware() {
    return true;
  }
  @Override
  public boolean isApplicable(AnActionEvent event, final Map<String, Object> _params) {
    return true;
  }
  @Override
  public void doUpdate(@NotNull AnActionEvent event, final Map<String, Object> _params) {
    this.setEnabledState(event.getPresentation(), this.isApplicable(event, _params));
  }
  @Override
  protected boolean collectActionData(AnActionEvent event, final Map<String, Object> _params) {
    if (!(super.collectActionData(event, _params))) {
      return false;
    }
    {
      EditorComponent editorComponent = event.getData(MPSEditorDataKeys.EDITOR_COMPONENT);
      if (editorComponent != null && editorComponent.isInvalid()) {
        editorComponent = null;
      }
      if (editorComponent == null) {
        return false;
      }
    }
    return true;
  }
  @Override
  public void doExecute(@NotNull final AnActionEvent event, final Map<String, Object> _params) {
    final EditorCell rootCell = event.getData(MPSEditorDataKeys.EDITOR_COMPONENT).getRootCell();

    final PrinterJob job = PrinterJob.getPrinterJob();
    job.setPrintable(new Printable() {
      public int print(Graphics g_, PageFormat format, int page) throws PrinterException {
        Graphics2D g = (Graphics2D) g_.create();

        int width = Math.max(EditorSettings.getInstance().getVerticalBoundWidth(), rootCell.getWidth() + rootCell.getX());
        double scale = format.getImageableWidth() / width;
        double offsetY = format.getImageableHeight() / scale * page;

        if (offsetY > rootCell.getHeight() + rootCell.getY()) {
          return Printable.NO_SUCH_PAGE;
        }

        g.translate(format.getImageableX(), format.getImageableY());
        if (offsetY > 0.0) {
          g.translate(0.0, -offsetY * scale);
        }
        g.scale(scale, scale);
        event.getData(MPSEditorDataKeys.EDITOR_COMPONENT).paint(g);

        g.dispose();
        return Printable.PAGE_EXISTS;
      }
    });

    SwingUtilities.invokeLater(() -> {
      try {
        boolean ok = job.printDialog();
        if (ok) {
          job.print();
        }
      } catch (PrinterException ex) {
        Messages.showErrorDialog(event.getData(MPSEditorDataKeys.EDITOR_COMPONENT), ex.getMessage());
      }
    });
  }
}
