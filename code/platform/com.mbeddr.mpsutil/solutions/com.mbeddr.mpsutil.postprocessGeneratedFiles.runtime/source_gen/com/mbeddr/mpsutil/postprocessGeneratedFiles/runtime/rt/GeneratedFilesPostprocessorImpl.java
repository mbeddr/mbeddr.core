package com.mbeddr.mpsutil.postprocessGeneratedFiles.runtime.rt;

/*Generated by MPS */

import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import org.jetbrains.mps.openapi.model.SNode;
import java.nio.file.Path;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import jetbrains.mps.lang.core.plugin.TextGenOutcomeResource;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.text.TextGenResult;
import jetbrains.mps.text.TextUnit;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.smodel.SModelOperations;
import java.nio.file.Paths;

public class GeneratedFilesPostprocessorImpl {
  public GeneratedFilesPostprocessorImpl(_FunctionTypes._void_P2_E0<? super SNode, ? super Path>... processors) {
    this.processors = processors;
  }

  private final _FunctionTypes._void_P2_E0<? super SNode, ? super Path>[] processors;

  public void process(ProgressMonitor progressMonitor, Iterable<TextGenOutcomeResource> input) {
    for (TextGenOutcomeResource res : Sequence.fromIterable(input)) {
      SModel modl = res.getModel();
      Path outputPath = getOutputPath(modl);
      if (outputPath == null) {
        continue;
      }
      TextGenResult textGenResult = res.getTextGenResult();
      for (TextUnit unit : ListSequence.fromList(textGenResult.getUnits())) {
        final SNode node = unit.getStartNode();
        final Path path = outputPath.resolve(unit.getFileName());
        textGenResult.getModel().getRepository().getModelAccess().runReadAction(() -> {
          for (_FunctionTypes._void_P2_E0<? super SNode, ? super Path> postprocessor : GeneratedFilesPostprocessorImpl.this.processors) {
            postprocessor.invoke(node, path);
          }
        });
      }
    }
  }

  protected Path getOutputPath(SModel model) {
    IFile outputLocation = SModelOperations.getOutputLocation(model);
    if (outputLocation == null) {
      return null;
    }
    return Paths.get(outputLocation.getPath());
  }

}
