package com.mbeddr.mpsutil.ecore.testing.runtime.main;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SModel;
import org.junit.Assert;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import org.jetbrains.mps.openapi.language.SLanguage;
import org.eclipse.emf.common.util.URI;
import java.io.File;
import java.io.IOException;
import com.mbeddr.mpsutil.ecoreimporter.runtime.importerruntime.EcoreModelExporter;
import jetbrains.mps.smodel.tempmodel.TemporaryModels;
import jetbrains.mps.smodel.tempmodel.TempModuleOptions;
import com.mbeddr.mpsutil.ecoreimporter.runtime.importerruntime.EcoreModelImporter;
import jetbrains.mps.project.SModuleOperations;
import de.itemis.mps.comparator.code.MPSNodeComparisonResult;
import de.itemis.mps.comparator.code.MPSNodeComparator;
import jetbrains.mps.internal.collections.runtime.Sequence;
import de.itemis.mps.comparator.code.NodeDifference;
import de.itemis.mps.comparator.code.IgnoredProperty;
import java.util.Collections;
import org.jetbrains.mps.openapi.module.SRepository;
import org.jetbrains.mps.openapi.module.SModuleReference;
import java.util.Objects;
import java.util.Collection;
import jetbrains.mps.smodel.language.LanguageRegistry;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import java.io.BufferedReader;
import java.io.FileReader;

public class ModelImporterExporterTestingUtil {

  public void calculateDifferences(String pathToEMFMetaModel, SModel mpsMetaModel, SModel mpsModelInstance) {
    Assert.assertEquals("Test model is required to have exactly one root node", Integer.valueOf(1), Integer.valueOf(ListSequence.fromList(SModelOperations.roots(mpsModelInstance, null)).count()));

    SLanguage language = findLanguageByModel(mpsMetaModel);
    URI XCoreURI = URI.createFileURI(pathToEMFMetaModel);

    // create temporary file and persist the MPS model as EMF model into it
    File tempFile;
    try {
      tempFile = File.createTempFile("tempModelInstance", ".xml");
    } catch (IOException e) {
      throw new RuntimeException(e);
    }
    URI instanceFileURI = URI.createFileURI(tempFile.toString());
    EcoreModelExporter exporter = new EcoreModelExporter(mpsModelInstance, XCoreURI, instanceFileURI);
    exporter.exportEcoreModel();

    // activate this to check the EMF xml file which has been created
    // TODO: in a later step, we should actually check the contents of the 
    //      exported file as part of the test.

    // now import the temporary file back into a new temporary MPS model
    SModel importedModel = TemporaryModels.getInstance().create(true, TempModuleOptions.forDefaultModule());
    EcoreModelImporter importer = new EcoreModelImporter(importedModel, language, XCoreURI, instanceFileURI);
    importer.importEcoreModel(SModuleOperations.getProjectForModule(mpsMetaModel.getModule()).getRepository());
    tempFile.delete();

    // the imported model should again have exactly one root node
    Assert.assertEquals("Imported model must have exactly one root node", Integer.valueOf(1), Integer.valueOf(ListSequence.fromList(SModelOperations.roots(importedModel, null)).count()));

    // do a detailed check on the single root nodes of input model and imported model
    MPSNodeComparisonResult result = MPSNodeComparator.compare(ListSequence.fromList(SModelOperations.roots(mpsModelInstance, null)).first(), ListSequence.fromList(SModelOperations.roots(importedModel, null)).first(), Sequence.fromIterable(propertiesToIgnore()).toList(), true, false);
    Iterable<NodeDifference> diffs = result.getDifferences();
    Sequence.fromIterable(diffs).visitAll((diff) -> System.out.println(diff.getDescription()));
    Assert.assertTrue("The imported model differs from the original test model", Sequence.fromIterable(diffs).isEmpty());
  }

  private static Iterable<IgnoredProperty> propertiesToIgnore() {
    // for the current tests we do not need to ignore properties
    return Sequence.fromIterable(Collections.<IgnoredProperty>emptyList());
  }


  private SLanguage findLanguageByModel(SModel mdl) {
    SRepository rep = mdl.getRepository();
    final SModuleReference ref = mdl.getModule().getModuleReference();
    System.out.println("findLanguageByModel mdl=" + mdl + " rep=" + rep + " ref=" + ref);
    if (!(Objects.equals(ref, null))) {
      System.out.println("    ref points to: " + ref.getModuleName());
    }
    Collection<SLanguage> languages = LanguageRegistry.getInstance(rep).getAllLanguages();
    System.out.println("   languages: " + CollectionSequence.fromCollection(languages).select((it) -> it.getQualifiedName()));
    return CollectionSequence.fromCollection(languages).findFirst((language) -> Objects.equals(language.getQualifiedName(), ref.getModuleName()));
  }

  private void dumpFile(File f) {
    try {
      System.out.println("DUMP OF FILE: " + f.getCanonicalPath());
      BufferedReader reader = new BufferedReader(new FileReader(f));
      String line;
      while ((line = reader.readLine()) != null) {
        System.out.println(">> " + line);
      }
      reader.close();
    } catch (Exception e) {
      System.out.println("EXCEPTION: " + e);
    }
  }
}
