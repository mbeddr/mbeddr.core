package com.mbeddr.mpsutil.actionsfilter.runtime;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.annotations.NotNull;
import com.intellij.openapi.actionSystem.DefaultActionGroup;
import com.intellij.openapi.actionSystem.ActionManager;
import com.intellij.openapi.actionSystem.IdeActions;
import com.intellij.openapi.actionSystem.AnAction;
import com.intellij.ide.ui.customization.CustomActionsSchema;
import com.intellij.openapi.actionSystem.Separator;

public class CustomToolBar {
  private static final Logger LOG = Logger.getLogger(CustomToolBar.class);

  private static CustomToolBar instance = new CustomToolBar();

  public List<ToolBarEntry> entries = ListSequence.fromList(new ArrayList<ToolBarEntry>());

  public final List<ToolBarEntry> defaultEntries = ListSequence.fromList(new ArrayList<ToolBarEntry>());

  public static CustomToolBar getInstance() {
    return instance;
  }

  private CustomToolBar() {
    initDefaultEntries();
  }

  private void initDefaultEntries() {
    Iterable<String> actions = ToolbarUtils.getActions();
    Sequence.fromIterable(actions).visitAll((it) -> {
      if ((it != null && it.length() > 0)) {
        ListSequence.fromList(defaultEntries).addElement(new ToolBarEntry(it, null, ToolBarEntry.EntryType.TOOLBAR_ACTION));
      } else {
        ListSequence.fromList(defaultEntries).addElement(new ToolBarEntry(ToolBarEntry.EntryType.TOOLBAR_GROUP_SEPARATOR));
      }
    });
  }

  public void setToolBarEntries(List<ToolBarEntry> entries) {
    cleanToolbar();
    ListSequence.fromList(this.entries).addSequence(ListSequence.fromList(entries));
    applyToolbar();
  }

  public void setToolBarEntries(@NotNull Model model) {
    Profile activeProfile = model.getActiveProfile();
    if (activeProfile == null) {
      if (ListSequence.fromList(entries).isEmpty()) {
        resetToMPSDefault();
      } else {
        applyToolbar();
      }
      return;
    }

    ToolbarSettings toolBarSettings = activeProfile.getToolBarSettings();
    if (toolBarSettings == null) {
      resetToMPSDefault();
      return;
    }

    setToolBarEntries(toolBarSettings.getEntries());
    applyToolbar();
  }

  public void applyToolbar() {
    final DefaultActionGroup toolBarActions = (DefaultActionGroup) ActionManager.getInstance().getAction(IdeActions.GROUP_MAIN_TOOLBAR);
    toolBarActions.removeAll();
    ListSequence.fromList(this.entries).visitAll((entry) -> {
      if (entry.getEntryType().equals(ToolBarEntry.EntryType.TOOLBAR_ACTION)) {
        String actionId = entry.getId();
        if ((actionId == null || actionId.length() == 0)) {
          if (LOG.isErrorLevel()) {
            LOG.error("Invalid action-id for entry: " + entry.toString() + ". Skipping it!");
          }
        } else {
          AnAction action = ActionManager.getInstance().getAction(actionId);
          if (action == null) {
            if (LOG.isErrorLevel()) {
              LOG.error("action not found for action-id: " + actionId + ". Skipping it!");
            }
          } else {
            toolBarActions.add(action);
            if (isNotEmptyString(entry.getIconPath())) {
              CustomActionsSchema.getInstance().addIconCustomization(entry.getId(), entry.getIconPath());
            }
          }
        }
      } else {
        toolBarActions.add(new Separator());
      }
    });
    CustomActionsSchema.getInstance().setCustomizationSchemaForCurrentProjects();
  }

  private void resetToMPSDefault() {
    setToolBarEntries(defaultEntries);
    applyToolbar();
  }

  private void cleanToolbar() {
    removeIconsCustomization();
    ListSequence.fromList(entries).clear();
  }

  private void removeIconsCustomization() {
    final CustomActionsSchema actionsSchema = CustomActionsSchema.getInstance();
    ListSequence.fromList(this.entries).where((it) -> isNotEmptyString(it.getId())).visitAll((it) -> actionsSchema.removeIconCustomization(it.getId()));
  }
  private static boolean isNotEmptyString(String str) {
    return str != null && str.length() > 0;
  }
}
