package com.mbeddr.mpsutil.actionsfilter.runtime;

/*Generated by MPS */

import javax.swing.JPanel;
import com.intellij.ui.SearchTextField;
import javax.swing.JComboBox;
import com.intellij.openapi.actionSystem.AnAction;
import com.mbeddr.mpsutil.actionsfilter.runtime.plugin.ActionsService;
import javax.swing.event.DocumentListener;
import javax.swing.event.DocumentEvent;
import java.awt.event.KeyListener;
import java.awt.event.KeyEvent;
import javax.swing.DefaultListCellRenderer;
import java.awt.Component;
import javax.swing.JList;
import java.beans.PropertyChangeEvent;
import javax.swing.JScrollPane;
import javax.swing.BorderFactory;
import java.awt.Color;
import java.awt.GridBagLayout;
import java.awt.GridBagConstraints;
import java.awt.Insets;
import com.intellij.openapi.actionSystem.ActionToolbar;
import java.awt.BorderLayout;
import com.intellij.icons.AllIcons;
import com.intellij.openapi.actionSystem.AnActionEvent;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.annotations.NotNull;
import com.intellij.openapi.actionSystem.ActionUpdateThread;
import com.intellij.openapi.ui.InputValidator;
import com.intellij.openapi.ui.Messages;
import com.intellij.openapi.actionSystem.DefaultActionGroup;
import com.intellij.openapi.actionSystem.ActionManager;
import java.util.Objects;
import java.awt.Graphics;
import javax.swing.DefaultComboBoxModel;
import com.intellij.openapi.ui.InputValidatorEx;
import com.intellij.openapi.util.NlsContexts;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.annotations.NonNls;

public class ActionFilterComponent extends JPanel {

  protected ActionMenuTree myTree;

  protected SearchTextField searchField;
  protected JComboBox<Profile> cboProfiles;

  protected AnAction addBtn;
  protected AnAction deleteBtn;
  protected AnAction renameBtn;
  protected AnAction copyBtn;

  public Model myModel;

  public ActionFilterComponent() {
    Model state = ActionsService.getInstance().getState();
    myModel = state.clone();
    initComponents();
    setOpaque(true);
  }

  public void dispose() {
  }

  public void initComponents() {

    myTree = new ActionMenuTree(myModel);
    searchField = new SearchTextField(false) {
      @Override
      protected void showPopup() {
      }
    };
    searchField.addDocumentListener(new DocumentListener() {
      public void insertUpdate(DocumentEvent event) {
        executeSearch(false);
      }
      public void removeUpdate(DocumentEvent p0) {
      }
      public void changedUpdate(DocumentEvent p0) {
        executeSearch(false);
      }
    });
    searchField.addKeyboardListener(new KeyListener() {
      public void keyTyped(KeyEvent e) {
      }
      public void keyPressed(KeyEvent e) {
        if (e.getKeyCode() == KeyEvent.VK_DOWN) {
          executeSearch(true);
          e.consume();
        }
      }
      public void keyReleased(KeyEvent e) {
      }
    });

    cboProfiles = new JComboBox();
    cboProfiles.setRenderer(new DefaultListCellRenderer() {
      @Override
      public Component getListCellRendererComponent(JList<?> list, Object value, int index, boolean isSelected, boolean cellHasFocus) {
        Component c = super.getListCellRendererComponent(list, value, index, isSelected, cellHasFocus);
        if (value != null) {
          // 
          if (as_gzn447_a0a1a1a0a0a0a7a71(value, Profile.class).isPredefined()) {
            setText(value.toString() + " ðŸ”’");
          } else {
            setText(value.toString());
          }
        } else {
          setText("");
        }
        return c;
      }
    });
    myModel.addPropertyChangeListener(Model.PROPERTY_ACTIVE_PROFILE, (PropertyChangeEvent e) -> updateValues());

    JScrollPane treeScrollPane = new JScrollPane(myTree);
    treeScrollPane.setBorder(BorderFactory.createLineBorder(Color.LIGHT_GRAY));

    JPanel north = new JPanel(new GridBagLayout());
    GridBagConstraints gbc = new GridBagConstraints();
    gbc.insets = new Insets(0, 0, 0, 0);
    // single row
    gbc.gridy = 0;
    gbc.weightx = 0;
    gbc.fill = 0;

    ActionToolbar toolbar = createToolbar();
    toolbar.setTargetComponent(north);
    gbc.gridx = 0;
    north.add(cboProfiles, gbc);
    gbc.gridx = 1;
    north.add(toolbar.getComponent(), gbc);

    gbc.gridx = 2;
    gbc.weightx = 1.0;
    gbc.fill = GridBagConstraints.HORIZONTAL;
    north.add(searchField, gbc);

    setLayout(new BorderLayout());
    add(north, BorderLayout.NORTH);
    add(treeScrollPane, BorderLayout.CENTER);

    updateValues();
  }

  public ActionToolbar createToolbar() {
    addBtn = new AnAction(() -> "New Profile", AllIcons.General.Add) {
      @Override
      public void actionPerformed(AnActionEvent e) {
        Profile newProfile = myModel.createProfile("New Profile (" + String.valueOf(ListSequence.fromList(myModel.getAllProfiles()).count()) + ")");
        myModel.setActiveProfile(newProfile);
      }

      @NotNull
      @Override
      public ActionUpdateThread getActionUpdateThread() {
        return ActionUpdateThread.EDT;
      }
    };
    deleteBtn = new AnAction(() -> "Remove Profile", AllIcons.General.Remove) {
      @Override
      public void actionPerformed(AnActionEvent e) {
        Profile activeProfile = myModel.getActiveProfile();
        myModel.removeProfile(activeProfile);
        updateValues();
      }

      @NotNull
      @Override
      public ActionUpdateThread getActionUpdateThread() {
        return ActionUpdateThread.EDT;
      }

      @Override
      public void update(@NotNull AnActionEvent e) {
        Profile activeProfile = myModel.getActiveProfile();
        e.getPresentation().setEnabled(activeProfile != null && !(activeProfile.isPredefined()));
      }
    };

    renameBtn = new AnAction(() -> "Rename Profile", AllIcons.Actions.Edit) {
      @Override
      public void actionPerformed(AnActionEvent e) {
        Profile profile = myModel.getActiveProfile();
        if (profile == null) {
          return;
        }
        String name = profile.getName();
        InputValidator validator = new GroupNameValidator(profile);
        String newName = Messages.showInputDialog("Rename Profile", "Enter a new name for " + name, null, "", validator);
        if (newName != null) {
          profile.setName(newName);
        }
        myModel.updateProfile(myModel.getActiveProfile(), profile);
        updateValues();
      }

      @NotNull
      @Override
      public ActionUpdateThread getActionUpdateThread() {
        return ActionUpdateThread.EDT;
      }

      @Override
      public void update(@NotNull AnActionEvent e) {
        Profile activeProfile = myModel.getActiveProfile();
        e.getPresentation().setEnabled(activeProfile != null && !(activeProfile.isPredefined()));
      }
    };
    copyBtn = new AnAction(() -> "Duplicate Profile", AllIcons.General.InlineCopy) {
      @Override
      public void actionPerformed(AnActionEvent e) {
        Profile profile = myModel.copyProfile();
        if (profile == null) {
          return;
        }
        String name = profile.getName();
        profile.setName(name + " (copy)");
        myModel.setActiveProfile(profile);
      }

      @NotNull
      @Override
      public ActionUpdateThread getActionUpdateThread() {
        return ActionUpdateThread.EDT;
      }
    };
    DefaultActionGroup group = new DefaultActionGroup();
    group.add(addBtn);
    group.add(deleteBtn);
    group.add(renameBtn);
    group.add(copyBtn);
    ActionManager actionManager = ActionManager.getInstance();
    ActionToolbar toolbar = actionManager.createActionToolbar("Action filter component toolbar", group, true);
    return toolbar;
  }

  public void executeSearch(boolean next) {
    myTree.selectMatching(searchField.getText(), next);
  }

  public void readModel(Model model) {
    myModel.load(model);
  }

  public boolean isModified(Model model) {
    return !(Objects.equals(myModel, model));
  }

  @Override
  protected void paintChildren(Graphics graphics) {
    super.paintChildren(graphics);
  }

  public DefaultComboBoxModel<?> updateValues() {
    DefaultComboBoxModel<Profile> model = new DefaultComboBoxModel<Profile>(ListSequence.fromList(myModel.getAllProfiles()).toGenericArray(Profile.class)) {
      @Override
      public void setSelectedItem(Object object) {
        super.setSelectedItem(object);
        Profile newActive = (Profile) object;
        myModel.setActiveProfile(newActive);
        myTree.load(newActive);
      }
    };
    cboProfiles.setModel(model);

    Profile activeProfile = myModel.getActiveProfile();
    cboProfiles.setSelectedItem(activeProfile);

    return model;
  }

  public class GroupNameValidator implements InputValidatorEx {
    private Profile profile;

    public GroupNameValidator(Profile profile) {
      this.profile = profile;
    }

    @NlsContexts.DetailedDescription
    @Nullable
    @Override
    public String getErrorText(@NonNls final String input) {
      if ((input == null || input.length() == 0)) {
        return "The name must not be empty";
      }

      if (ListSequence.fromList(myModel.getAllProfiles()).any((it) -> !(Objects.equals(it, profile)) && Objects.equals(it.getName(), input))) {
        return "Another profile already has the same name";
      }

      return null;
    }
  }
  private static <T> T as_gzn447_a0a1a1a0a0a0a7a71(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
