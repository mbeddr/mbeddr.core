package com.mbeddr.mpsutil.actionsfilter.runtime;

/*Generated by MPS */

import java.io.Serializable;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import java.beans.PropertyChangeSupport;
import java.beans.PropertyChangeListener;
import org.jetbrains.annotations.Nullable;
import com.intellij.util.xmlb.annotations.Transient;
import com.intellij.openapi.application.ApplicationInfo;
import java.util.Objects;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.LinkedHashSet;
import java.util.Iterator;

public class Model implements Serializable, Cloneable {
  public static final String PROPERTY_ACTIVE_PROFILE = "activeProfile";

  public List<Profile> myProfiles = ListSequence.fromList(new ArrayList<Profile>());
  public int myActiveProfileIndex = -1;
  public transient PropertyChangeSupport myPropertyChangeSupport;

  public Model() {
  }

  public boolean isEmpty() {
    return ListSequence.fromList(myProfiles).isEmpty();
  }

  protected PropertyChangeSupport getPropertyChangeSupport() {
    if (myPropertyChangeSupport == null) {
      myPropertyChangeSupport = new PropertyChangeSupport(this);
    }
    return myPropertyChangeSupport;
  }

  public void addPropertyChangeListener(String propertyName, PropertyChangeListener l) {
    getPropertyChangeSupport().addPropertyChangeListener(propertyName, l);
  }

  public void removePropertyChangeListener(String propertyName, PropertyChangeListener l) {
    getPropertyChangeSupport().removePropertyChangeListener(propertyName, l);
  }

  @Nullable
  @Transient
  public Profile getActiveProfile() {
    int activeProfileIndex = getActiveProfileIndex();
    List<Profile> profiles = getAllProfiles();
    if (activeProfileIndex >= 0) {
      return ListSequence.fromList(profiles).getElement(activeProfileIndex);
    }
    Profile activeByDefault = ListSequence.fromList(profiles).where((it) -> it.getActiveByDefault() && it.canBeActivatedByDefault(ApplicationInfo.getInstance())).sort((it) -> it.getDefaultPriority(), true).last();
    return activeByDefault;
  }

  @Nullable
  @Transient
  public Profile getActiveProfileOrFirst() {
    Profile activeProfile = getActiveProfile();
    return (activeProfile != null ? activeProfile : ListSequence.fromList(getAllProfiles()).first());
  }

  @Transient
  public int getActiveProfileIndex() {
    int allProfilesCount = ListSequence.fromList(getAllProfiles()).count();
    if (myActiveProfileIndex >= allProfilesCount) {
      myActiveProfileIndex = allProfilesCount - 1;
    }
    return myActiveProfileIndex;
  }

  @Transient
  public void setActiveProfile(@Nullable Profile newValue) {
    if (Objects.equals(getActiveProfile(), newValue)) {
      return;
    }

    setActiveProfileIndex(ListSequence.fromList(getAllProfiles()).indexOf(newValue));
  }

  @Transient
  public void setActiveProfileIndex(@Nullable int newIndex) {
    if (newIndex == myActiveProfileIndex) {
      return;
    }
    Profile oldProfile = getActiveProfile();
    myActiveProfileIndex = newIndex;
    if (newIndex == -1) {
      return;
    }
    Profile newProfile = getActiveProfile();
    getPropertyChangeSupport().firePropertyChange(Model.PROPERTY_ACTIVE_PROFILE, oldProfile, newProfile);
  }

  public void setProfiles(List<Profile> newProfiles) {
    List<Profile> profiles = ListSequence.fromList(new ArrayList<Profile>());

    for (Profile newProfile : ListSequence.fromList(newProfiles)) {
      if (!(newProfile.isPredefined())) {
        ListSequence.fromList(profiles).addElement(newProfile);
      }
    }
    myProfiles = profiles;
  }

  protected void addPredefinedProfiles(Set<Profile> list) {
    for (final Profile predefined : ListSequence.fromList(ActionsProfileRegistry.getInstance().getProfiles())) {
      boolean exists = SetSequence.fromSet(list).findFirst((it) -> Objects.equals(it.getName(), predefined.getName())) != null;
      if (!(exists)) {
        SetSequence.fromSet(list).addElement(predefined.clone());
      }
    }
  }

  public List<Profile> getAllProfiles() {
    Set<Profile> set = SetSequence.fromSet(new LinkedHashSet<Profile>());
    addPredefinedProfiles(set);
    SetSequence.fromSet(set).addSequence(ListSequence.fromList(myProfiles));
    return SetSequence.fromSet(set).toList();
  }

  public List<Profile> getUserDefinedProfiles() {
    return ListSequence.fromListWithValues(new ArrayList<Profile>(), myProfiles);
  }

  public Profile createProfile(String name) {
    Profile p = new Profile(name);
    addProfile(p);
    return p;
  }

  public void addProfile(Profile p) {
    List<Profile> newList = ListSequence.fromListWithValues(new ArrayList<Profile>(), myProfiles);
    ListSequence.fromList(newList).addElement(p);
    setProfiles(newList);
  }

  public void removeProfile(Profile profile) {
    List<Profile> newList = myProfiles;
    ListSequence.fromList(newList).removeElement(profile);
    setProfiles(newList);
    setActiveProfileIndex(myActiveProfileIndex);
  }

  public void updateProfile(Profile oldProfile, Profile newProfile) {
    if (oldProfile.equals(newProfile)) {
      return;
    }
    List<Profile> profiles = getAllProfiles();
    int profileIndex = ListSequence.fromList(profiles).indexOf(oldProfile);
    if (profileIndex >= 0) {
      ListSequence.fromList(profiles).setElement(profileIndex, newProfile);
    }
    setProfiles(profiles);
  }

  @Nullable
  public Profile copyProfile() {
    Profile activeProfile = getActiveProfile();
    if (activeProfile == null) {
      return null;
    }
    Profile copy = activeProfile.clone();
    copy.myIsPredefined = false;
    addProfile(copy);
    return copy;
  }

  public void load(Model source) {
    setProfiles(ListSequence.fromList(source.getUserDefinedProfiles()).select((it) -> it.clone()).toList());
  }

  @Override
  public Model clone() {
    try {
      Model clone = (Model) super.clone();
      clone.myProfiles = ListSequence.fromList(myProfiles).select((it) -> it.clone()).toList();
      return clone;
    } catch (CloneNotSupportedException e) {
      throw new RuntimeException(e);
    }
  }

  @Override
  public boolean equals(Object o) {
    if (this == o) {
      return true;
    }
    if (o == null || this.getClass() != o.getClass()) {
      return false;
    }

    Model that = (Model) o;
    if (myActiveProfileIndex != that.myActiveProfileIndex) {
      return false;
    }
    if (ListSequence.fromList(myProfiles).count() != ListSequence.fromList(that.myProfiles).count()) {
      return false;
    }
    {
      Iterator<Profile> p1_it = ListSequence.fromList(myProfiles).iterator();
      Iterator<Profile> p2_it = ListSequence.fromList(that.myProfiles).iterator();
      Profile p1_var;
      Profile p2_var;
      while (p1_it.hasNext() && p2_it.hasNext()) {
        p1_var = p1_it.next();
        p2_var = p2_it.next();
        if (!(Objects.equals(p1_var, p2_var))) {
          return false;
        }
      }
    }

    return true;
  }

  @Override
  public int hashCode() {
    int result = 0;
    result = 31 * result + myActiveProfileIndex;
    result = 31 * result + ((myProfiles != null ? ((Object) myProfiles).hashCode() : 0));
    return result;
  }
}
