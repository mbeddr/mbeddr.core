package com.mbeddr.mpsutil.actionsfilter.runtime;

/*Generated by MPS */

import java.io.Serializable;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import java.beans.PropertyChangeSupport;
import java.beans.PropertyChangeListener;
import org.jetbrains.annotations.Nullable;
import com.intellij.util.xmlb.annotations.Transient;
import java.util.Objects;
import com.intellij.openapi.application.ApplicationInfo;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.LinkedHashSet;
import java.util.Iterator;

public class Model implements Serializable, Cloneable {
  public static final String PROPERTY_ACTIVE_PROFILE = "activeProfile";

  public List<Profile> allProfiles = ListSequence.fromList(new ArrayList<Profile>());
  public String activeProfileId;
  public transient PropertyChangeSupport propertyChangeSupport;

  public Model() {
  }

  protected PropertyChangeSupport getPropertyChangeSupport() {
    if (propertyChangeSupport == null) {
      propertyChangeSupport = new PropertyChangeSupport(this);
    }
    return propertyChangeSupport;
  }

  public void addPropertyChangeListener(String propertyName, PropertyChangeListener l) {
    getPropertyChangeSupport().addPropertyChangeListener(propertyName, l);
  }

  public void removePropertyChangeListener(String propertyName, PropertyChangeListener l) {
    getPropertyChangeSupport().removePropertyChangeListener(propertyName, l);
  }

  @Nullable
  @Transient
  public Profile getActiveProfile() {
    List<Profile> profiles = getAllProfiles();
    if (activeProfileId != null) {
      Profile activeProfile = ListSequence.fromList(profiles).findFirst((it) -> Objects.equals(it.id, activeProfileId));
      if (activeProfile != null) {
        return activeProfile;
      }
    }
    Profile activeByDefault = ListSequence.fromList(profiles).where((it) -> it.getActiveByDefault() && it.canBeActivatedByDefault(ApplicationInfo.getInstance())).sort((it) -> it.getDefaultPriority(), true).last();
    if (activeByDefault != null) {
      return activeByDefault;
    }

    return ListSequence.fromList(profiles).first();
  }


  @Transient
  public void setActiveProfile(@Nullable Profile newValue) {
    if (Objects.equals(getActiveProfile(), newValue) || newValue == null) {
      return;
    }

    setActiveProfileId(newValue.id);
  }

  @Transient
  public void setActiveProfileId(@Nullable String newID) {
    if (newID == activeProfileId) {
      return;
    }
    Profile oldProfile = getActiveProfile();
    activeProfileId = newID;
    if (newID == null) {
      return;
    }
    Profile newProfile = getActiveProfile();
    getPropertyChangeSupport().firePropertyChange(Model.PROPERTY_ACTIVE_PROFILE, oldProfile, newProfile);
  }

  public void setProfiles(List<Profile> newProfiles) {
    allProfiles = newProfiles;
  }

  public static void addPredefinedProfilesTo(List<Profile> list) {
    for (final Profile predefined : ListSequence.fromList(ActionsProfileRegistry.getInstance().getProfiles())) {
      boolean exists = ListSequence.fromList(list).findFirst((it) -> Objects.equals(it.getName(), predefined.getName())) != null;
      if (!(exists)) {
        ListSequence.fromList(list).addElement(predefined.clone());
      }
    }
  }

  public List<Profile> getAllProfiles() {
    Set<Profile> set = SetSequence.fromSet(new LinkedHashSet<Profile>());
    addPredefinedProfilesTo(allProfiles);
    SetSequence.fromSet(set).addSequence(ListSequence.fromList(allProfiles));
    return SetSequence.fromSet(set).toList();
  }

  public Profile createProfile(String name) {
    Profile p = new Profile(name);
    addProfile(p);
    return p;
  }

  public void addProfile(Profile p) {
    List<Profile> newList = ListSequence.fromListWithValues(new ArrayList<Profile>(), allProfiles);
    ListSequence.fromList(newList).addElement(p);
    setProfiles(newList);
  }

  public void removeProfile(Profile profile) {
    List<Profile> newList = allProfiles;
    ListSequence.fromList(newList).removeElement(profile);
    setProfiles(newList);
    setActiveProfileId(activeProfileId);
  }

  public void updateProfile(Profile oldProfile, Profile newProfile) {
    if (oldProfile.equals(newProfile)) {
      return;
    }
    List<Profile> profiles = getAllProfiles();
    int profileIndex = ListSequence.fromList(profiles).indexOf(oldProfile);
    if (profileIndex >= 0) {
      ListSequence.fromList(profiles).setElement(profileIndex, newProfile);
    }
    setProfiles(profiles);
  }

  @Nullable
  public Profile copyProfile() {
    Profile activeProfile = getActiveProfile();
    if (activeProfile == null) {
      return null;
    }
    Profile copy = activeProfile.clone();
    copy.predefined = false;
    addProfile(copy);
    return copy;
  }

  public void load(Model source) {
    setProfiles(ListSequence.fromList(source.allProfiles).select((it) -> it.clone()).toList());
  }

  @Override
  public Model clone() {
    try {
      Model clone = (Model) super.clone();
      clone.allProfiles = ListSequence.fromList(allProfiles).select((it) -> it.clone()).toList();
      return clone;
    } catch (CloneNotSupportedException e) {
      throw new RuntimeException(e);
    }
  }

  @Override
  public boolean equals(Object o) {
    if (this == o) {
      return true;
    }
    if (o == null || this.getClass() != o.getClass()) {
      return false;
    }

    Model that = (Model) o;
    if (activeProfileId != that.activeProfileId) {
      return false;
    }
    if (ListSequence.fromList(allProfiles).count() != ListSequence.fromList(that.allProfiles).count()) {
      return false;
    }
    {
      Iterator<Profile> p1_it = ListSequence.fromList(allProfiles).iterator();
      Iterator<Profile> p2_it = ListSequence.fromList(that.allProfiles).iterator();
      Profile p1_var;
      Profile p2_var;
      while (p1_it.hasNext() && p2_it.hasNext()) {
        p1_var = p1_it.next();
        p2_var = p2_it.next();
        if (!(Objects.equals(p1_var, p2_var))) {
          return false;
        }
      }
    }

    return true;
  }

  @Override
  public int hashCode() {
    int result = 0;
    if (activeProfileId != null) {
      result = 31 * result + activeProfileId.hashCode();
    }
    result = 31 * result + ((allProfiles != null ? ((Object) allProfiles).hashCode() : 0));
    return result;
  }
}
