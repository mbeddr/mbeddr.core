package com.mbeddr.mpsutil.actionsfilter.runtime;

/*Generated by MPS */

import java.util.List;
import com.intellij.openapi.actionSystem.AnAction;
import jetbrains.mps.internal.collections.runtime.Sequence;
import com.intellij.openapi.actionSystem.ex.ActionManagerEx;
import jetbrains.mps.internal.collections.runtime.NotNullWhereFilter;
import java.util.Collections;
import java.util.ArrayList;
import com.intellij.openapi.actionSystem.ActionGroup;
import com.intellij.openapi.actionSystem.DefaultActionGroup;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import com.intellij.openapi.actionSystem.Presentation;

public class ActionHacks {

  public static List<AnAction> getActionsById(Iterable<String> ids) {
    return Sequence.fromIterable(ids).select((id) -> ActionManagerEx.getInstanceEx().getAction(id)).where(new NotNullWhereFilter()).toList();
  }

  public static void removeMenuActionId(String actionId) {
    AnAction action = ActionManagerEx.getInstanceEx().getAction(actionId);
    if (action != null) {
      removeMenuAction(action);
    }
  }

  public static void removeMenuActionsIds(Iterable<String> actionIds) {
    removeMenuActions(getActionsById(actionIds));
  }

  public static void removeMenuAction(AnAction group) {
    removeMenuActions(Collections.singletonList(group));
  }

  public static void removeMenuActions(List<AnAction> actions) {
    ActionManagerEx manager = ActionManagerEx.getInstanceEx();
    List<AnAction> mpsGroups = new ArrayList<AnAction>();
    for (AnAction action : actions) {
      mpsGroups.add(action);
    }
    // remove mps groups from IDEA groups
    for (String id : manager.getActionIds("")) {
      AnAction action = manager.getAction(id);
      if (action instanceof ActionGroup) {
        ActionGroup staticGroup = (ActionGroup) action;
        removeActionsFromGroup(staticGroup, mpsGroups);
      }
    }
  }

  public static void removeActionsFromGroup(ActionGroup group, List<AnAction> actions) {
    if ("com.intellij.util.xml.tree.actions.AddDomElementActionGroup".equals(group.getClass().getName())) {
      // workaround for a bug in IDEA XML plugin
      // TODO: remove the workaround
      return;
    }
    AnAction[] children = group.getChildren(null);
    for (AnAction child : children) {
      if (child instanceof ActionGroup) {
        removeActionsFromGroup((ActionGroup) child, actions);
      }
    }
    boolean groupIsDefaultActionGroup = group instanceof DefaultActionGroup;
    for (AnAction g : actions) {
      if (groupIsDefaultActionGroup) {
        ((DefaultActionGroup) group).remove(g);
      }
    }
  }

  public static List<String> getAllActionIds() {
    List<String> result = ListSequence.fromList(new ArrayList<String>());
    ListSequence.fromList(result).addSequence(Sequence.fromIterable(Sequence.fromArray(ActionManagerEx.getInstanceEx().getActionIds(""))));
    return ListSequence.fromList(result).sort((it) -> it, true).toList();
  }

  public static List<AnAction> getAllActions() {
    final ActionManagerEx manager = ActionManagerEx.getInstanceEx();
    return ListSequence.fromList(getAllActionIds()).select((it) -> manager.getAction(it)).toList();
  }

  public static List<String> getMainMenuActions() {
    List<String> result = ListSequence.fromList(new ArrayList<String>());
    collectActions(ActionManagerEx.getInstanceEx().getAction("MainMenu"), result, "");
    return result;
  }

  public static void collectActions(AnAction action, List<String> result, String indent) {
    String id = ActionManagerEx.getInstanceEx().getId(action);
    String text = check_qpgw9q_a0b0t(action.getTemplatePresentation());
    ListSequence.fromList(result).addElement(indent + text + " (" + id + ")");

    if (action instanceof ActionGroup) {
      ActionGroup group = ((ActionGroup) action);
      for (AnAction child : group.getChildren(null)) {
        collectActions(child, result, indent + "  ");
      }
    }

  }

  public static String getActionText(String actionId) {
    AnAction action = ActionManagerEx.getInstanceEx().getAction(actionId);
    return check_qpgw9q_a1a12(check_qpgw9q_a0b0v(action));
  }

  public static List<String> findRootGroups() {
    final ActionManagerEx manager = ActionManagerEx.getInstanceEx();
    String[] actionIds = manager.getActionIds("");
    List<AnAction> actions = getActionsById(Sequence.fromIterable(Sequence.fromArray(actionIds)).toList());
    final Map<AnAction, AnAction> parents = MapSequence.fromMap(new HashMap<AnAction, AnAction>());
    for (AnAction parent : ListSequence.fromList(actions)) {
      for (AnAction child : Sequence.fromIterable(Sequence.fromArray(check_qpgw9q_a0a0a4a32(as_qpgw9q_a0a0a0a4a32(parent, ActionGroup.class))))) {
        MapSequence.fromMap(parents).put(child, parent);
      }
    }

    return ListSequence.fromList(actions).where((it) -> MapSequence.fromMap(parents).get(it) == null).select((it) -> (String) manager.getId(it)).toList();
  }
  private static String check_qpgw9q_a0b0t(Presentation checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getText();
    }
    return null;
  }
  private static String check_qpgw9q_a1a12(Presentation checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getText();
    }
    return null;
  }
  private static Presentation check_qpgw9q_a0b0v(AnAction checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getTemplatePresentation();
    }
    return null;
  }
  private static AnAction[] check_qpgw9q_a0a0a4a32(ActionGroup checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getChildren(null);
    }
    return null;
  }
  private static <T> T as_qpgw9q_a0a0a0a4a32(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
