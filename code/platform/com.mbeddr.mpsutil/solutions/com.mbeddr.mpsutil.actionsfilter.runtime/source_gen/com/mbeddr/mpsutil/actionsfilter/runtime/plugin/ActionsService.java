package com.mbeddr.mpsutil.actionsfilter.runtime.plugin;

/*Generated by MPS */

import com.intellij.openapi.components.State;
import com.intellij.openapi.components.Storage;
import com.intellij.openapi.components.Service;
import com.intellij.openapi.components.PersistentStateComponent;
import com.mbeddr.mpsutil.actionsfilter.runtime.Model;
import com.intellij.openapi.application.ApplicationManager;
import com.intellij.serviceContainer.ComponentManagerImpl;
import com.intellij.openapi.util.Disposer;
import java.nio.file.Path;
import java.nio.file.Paths;
import com.intellij.openapi.application.PathManager;
import org.jdom.Element;
import com.intellij.openapi.util.JDOMUtil;
import com.intellij.util.xmlb.XmlSerializer;
import com.intellij.openapi.components.impl.stores.IComponentStore;
import com.intellij.openapi.components.impl.stores.IComponentStoreKt;
import com.mbeddr.mpsutil.actionsfilter.runtime.ActionFilter;
import com.mbeddr.mpsutil.actionsfilter.runtime.CustomToolBar;

@State(name = "ActionFilterSettings", storages = {@Storage(file = "actionFilter.xml")
})
@Service(Service.Level.APP)
public final class ActionsService implements PersistentStateComponent<Model> {

  public static final String FILENAME = "actionFilter.xml";

  /**
   * Updates are initially disabled because the service may be initialized earlier than the required services (e.g.
   * ActionManager) and are enabled from a post-startup project activity, i.e. as
   * soon as a project (including the "welcome Screen" project) is created.
   */
  public volatile boolean updatesEnabled = false;

  private Model state = new Model();

  public static ActionsService getInstance() {
    return ApplicationManager.getApplication().getService(ActionsService.class);
  }

  /**
   * Reload the service manually or otherwise we run into classloading issues in MPS because the old service is still active.
   * This means that we also have to manually load the state from actionFilter.xml.
   */
  public static void replace() {
    ComponentManagerImpl componentManager = as_a5fjik_a0a0a9(ApplicationManager.getApplication(), ComponentManagerImpl.class);
    ActionsService service = new ActionsService();
    service.loadState(read());
    componentManager.replaceServiceInstance(ActionsService.class, service, Disposer.newDisposable());
  }

  public static Model read() {
    try {
      Path configPath = Paths.get(PathManager.getConfigPath());
      Path xmlFile = configPath.resolve("options").resolve(FILENAME);
      Element root = JDOMUtil.load(xmlFile.toFile());
      Element component = root.getChild("component");
      return XmlSerializer.deserialize(component, Model.class);
    } catch (Exception e) {
      try {
        return new Model();
      } catch (Exception ex) {
      }
    }
    return null;
  }

  public void save() {
    IComponentStore store = IComponentStoreKt.getStateStore(ApplicationManager.getApplication());
    store.saveComponent(this);
  }

  public Model getState() {
    return state;
  }

  @Override
  public void noStateLoaded() {
    loadState(new Model());
  }

  public void loadState(Model model) {
    state = model;
    applyIfEnabled();
  }

  public void applyIfEnabled() {
    if (updatesEnabled) {
      applyFilter();
      applyToolbar();
    }
  }

  public void applyFilter() {
    ActionFilter.getInstance().setFilters(getState());
  }

  public void applyToolbar() {
    CustomToolBar.getInstance().setToolBarEntries(getState());
  }
  private static <T> T as_a5fjik_a0a0a9(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
