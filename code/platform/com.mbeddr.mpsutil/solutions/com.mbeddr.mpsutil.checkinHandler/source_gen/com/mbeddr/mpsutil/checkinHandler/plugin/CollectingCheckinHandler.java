package com.mbeddr.mpsutil.checkinHandler.plugin;

/*Generated by MPS */

import com.intellij.openapi.vcs.checkin.CheckinHandler;
import com.intellij.openapi.vcs.CheckinProjectPanel;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.LinkedList;
import java.util.Map;
import com.intellij.openapi.vcs.ui.RefreshableOnComponent;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import javax.swing.JPanel;
import com.intellij.openapi.vcs.changes.CommitContext;
import java.awt.GridLayout;
import org.jetbrains.annotations.Nullable;
import javax.swing.JComponent;
import com.intellij.openapi.vcs.checkin.CheckinHandlerFactory;
import org.jetbrains.annotations.NotNull;

public abstract class CollectingCheckinHandler<T extends BaseCheckinHandler> extends CheckinHandler {
  protected CheckinProjectPanel panel;
  protected List<T> handlers = ListSequence.fromList(new LinkedList<T>());
  protected Map<T, RefreshableOnComponent> refreshableOnComponents = MapSequence.fromMap(new HashMap<T, RefreshableOnComponent>());
  protected JPanel jpanel;

  public abstract List<T> queryHandlers();

  public CollectingCheckinHandler initialize(CheckinProjectPanel panel, CommitContext context) {
    this.panel = panel;
    handlers = ListSequence.fromList(queryHandlers()).sort((it) -> it.getPriority(), false).toList();
    for (T handler : ListSequence.fromList(handlers)) {
      handler.initialize(panel, context);
      MapSequence.fromMap(refreshableOnComponents).put(handler, handler.getBeforeCheckinConfigurationPanel());
    }
    int rows = ListSequence.fromList(handlers).count();
    if (rows == 0) {
      rows = 1;
    }
    jpanel = new JPanel(new GridLayout(rows, 0));
    ListSequence.fromList(getActiveHandlers()).visitAll((it) -> jpanel.add(MapSequence.fromMap(refreshableOnComponents).get(it).getComponent()));
    return this;
  }

  @Nullable
  @Override
  public RefreshableOnComponent getBeforeCheckinConfigurationPanel() {
    return new RefreshableOnComponent() {
      @Override
      public void saveState() {
        ListSequence.fromList(getActiveHandlers()).visitAll((it) -> MapSequence.fromMap(refreshableOnComponents).get(it).saveState());
      }

      @Override
      public void restoreState() {
        ListSequence.fromList(getActiveHandlers()).visitAll((it) -> MapSequence.fromMap(refreshableOnComponents).get(it).restoreState());
      }

      @Override
      public JComponent getComponent() {
        return jpanel;
      }
    };
  }

  public CheckinHandlerFactory createFactory() {
    return new CheckinHandlerFactory() {
      @NotNull
      @Override
      public CheckinHandler createHandler(@NotNull CheckinProjectPanel panel, @NotNull CommitContext context) {
        initialize(panel, context);
        return CollectingCheckinHandler.this;
      }
    };
  }

  public List<T> getActiveHandlers() {
    return ListSequence.fromList(handlers).where((it) -> !(it.isDisposed())).toList();
  }
}
