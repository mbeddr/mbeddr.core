package com.mbeddr.core.base.pluginSolution.plugin;

/*Generated by MPS */

import com.intellij.openapi.ui.SimpleToolWindowPanel;
import jetbrains.mps.logging.Logger;
import jetbrains.mps.project.Project;
import org.jetbrains.mps.openapi.module.SearchScope;
import com.intellij.ui.components.JBTextField;
import com.intellij.ui.table.JBTable;
import java.awt.BorderLayout;
import javax.swing.JPanel;
import com.intellij.ui.components.JBPanel;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;
import com.intellij.openapi.ui.ComponentValidator;
import com.intellij.openapi.util.Disposer;
import java.util.function.Supplier;
import com.intellij.openapi.ui.ValidationInfo;
import java.util.regex.Pattern;
import java.util.regex.PatternSyntaxException;
import com.intellij.ui.DocumentAdapter;
import org.jetbrains.annotations.NotNull;
import javax.swing.event.DocumentEvent;
import com.intellij.ui.components.JBScrollPane;
import javax.swing.JScrollPane;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import com.intellij.openapi.actionSystem.DefaultActionGroup;
import com.intellij.openapi.actionSystem.ActionToolbar;
import com.intellij.openapi.actionSystem.ActionManager;
import com.intellij.openapi.actionSystem.ActionPlaces;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import com.intellij.openapi.actionSystem.Separator;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.ide.findusages.model.scopes.ModelsScope;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.ide.findusages.model.scopes.ModulesScope;
import jetbrains.mps.ide.findusages.model.scopes.GlobalScope;
import com.intellij.openapi.application.ApplicationManager;
import javax.swing.table.TableColumn;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.openapi.navigation.EditorNavigator;
import jetbrains.mps.smodel.SNodePointer;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;

public class SearchViewer extends SimpleToolWindowPanel {
  private static final Logger LOG = Logger.getLogger(SearchViewer.class);
  private Project myProject;
  private SearchScope scope;
  private final JBTextField searchTerm = new JBTextField(200);
  private final JBTable resultTable = new SearchResultsTable();
  private boolean searchAll = false;
  private boolean approximateSearch = false;
  private boolean matchCase = false;
  private boolean matchRegex = false;

  public SearchViewer(final Project mpsProject, MbeddrSearchViewer_Tool tool) {
    super(false);
    myProject = mpsProject;
    setLayout(new BorderLayout());

    resultTable.setShowVerticalLines(true);

    JPanel topPanel = new JBPanel();
    this.add(topPanel, BorderLayout.NORTH);
    topPanel.setLayout(new BorderLayout());

    searchTerm.selectAll();
    searchTerm.addKeyListener(new KeyAdapter() {
      public void keyReleased(KeyEvent p0) {
        if (p0.getKeyCode() == KeyEvent.VK_ENTER) {
          runSearch(isSearchAll(), isApproximateSearch(), isMatchCase(), isMatchRegex());
        }
      }
    });
    new ComponentValidator(Disposer.newDisposable()).withValidator(new Supplier<ValidationInfo>() {
      @Override
      public ValidationInfo get() {
        if (matchRegex) {
          try {
            Pattern pattern = Pattern.compile(searchTerm.getText());
            if (LOG.isDebugLevel()) {
              LOG.debug("Validating pattern:" + pattern);
            }
            return null;
          } catch (PatternSyntaxException ex) {
            return new ValidationInfo("Invalid regular expression:" + ex.getMessage(), searchTerm);
          }
        }
        return null;
      }
    }).installOn(searchTerm);
    searchTerm.getDocument().addDocumentListener(new DocumentAdapter() {
      @Override
      protected void textChanged(@NotNull DocumentEvent e) {
        ComponentValidator.getInstance(searchTerm).ifPresent((v) -> v.revalidate());
      }
    });
    topPanel.add(searchTerm, BorderLayout.CENTER);

    JBScrollPane listScroller = new JBScrollPane(resultTable, JScrollPane.VERTICAL_SCROLLBAR_ALWAYS, JScrollPane.HORIZONTAL_SCROLLBAR_AS_NEEDED);
    this.add(listScroller, BorderLayout.CENTER);

    resultTable.addMouseListener(new MouseAdapter() {
      public void mouseClicked(MouseEvent p0) {
        if (p0.getClickCount() == 2) {
          openSelectionInEditor();
        }
      }
    });

    DefaultActionGroup group = new DefaultActionGroup();
    registerActions(group);
    ActionToolbar toolbar = ActionManager.getInstance().createActionToolbar(ActionPlaces.TOOLBAR, group, false);
    toolbar.setTargetComponent(this);
    setToolbar(toolbar.getComponent());
  }

  protected void registerActions(final DefaultActionGroup group) {
    group.add(new SearchAllNodePresentationsToggleAction());
    group.add(new ApproximateSearchToggleAction());
    group.add(new SearchMatchCaseToggleAction());
    group.add(new SearchMatchRegexToggleAction());
    group.add(new SearchAction());
    List<ISearchNodeFilter> filters = SearchNodeFilterConfig.getFilters();
    if (ListSequence.fromList(filters).isNotEmpty()) {
      group.add(new Separator());
      ListSequence.fromList(filters).visitAll((it) -> group.add(it.getAction()));
    }
  }

  public void dispose() {
  }

  public void setModelScope(SModel m) {
    scope = new ModelsScope(m);
    cleanUp();
  }

  public void setModuleScope(SModule module) {
    scope = new ModulesScope(module);
    cleanUp();
  }

  public void setGlobalScope() {
    scope = new GlobalScope(this.myProject);
    cleanUp();
  }

  public void setProjectScope() {
    scope = this.myProject.getScope();
    cleanUp();
  }

  private void cleanUp() {
    this.searchTerm.selectAll();

    ResultTableModel model = new ResultTableModel(this.myProject.getRepository(), null);
    model.fireTableDataChanged();

    this.resultTable.setModel(model);
    this.resultTable.revalidate();
    this.resultTable.repaint();
    this.searchTerm.requestFocus();
  }

  public void runSearch(boolean searchAll, boolean approximateSearch, boolean matchCase, boolean matchRegex) {
    SearchEngine helper = new SearchEngine(scope, myProject);
    helper.search(searchTerm.getText(), searchAll, approximateSearch, matchCase, matchRegex, new SearchCallback() {
      @Override
      public void resultsReceived(final List<SearchResult> results) {
        ApplicationManager.getApplication().invokeLater(() -> {
          ResultTableModel model = new ResultTableModel(SearchViewer.this.myProject.getRepository(), results);
          setTableModel(model);
          model.fireTableDataChanged();
          resultTable.revalidate();
          resultTable.repaint();
        });
      }
    });
  }

  public void setTableModel(ResultTableModel tm) {
    resultTable.setModel(tm);
    adjustColumnSizes();
  }

  private void adjustColumnSizes() {
    TableColumn iconColumn = resultTable.getColumnModel().getColumn(0);
    int iconColumnWidth = 40;
    iconColumn.setMaxWidth(iconColumnWidth);
    iconColumn.setPreferredWidth(iconColumnWidth);
    TableColumn conceptColumn = resultTable.getColumnModel().getColumn(3);
    Object longestValue = as_2z5w59_a0a0f0eb(resultTable.getModel(), ResultTableModel.class).getLongestValue(3);
    int conceptColumnWidth = (longestValue != null ? this.getFontMetrics(this.getFont()).stringWidth(longestValue.toString()) : -1);
    if (conceptColumnWidth != -1) {
      conceptColumn.setMaxWidth(conceptColumnWidth);
      conceptColumn.setPreferredWidth(conceptColumnWidth);
    }
    resultTable.invalidate();
  }

  private void openSelectionInEditor() {
    int selIdx = resultTable.getSelectedRow();
    if (selIdx >= 0) {
      ResultTableModel resultTM = ((ResultTableModel) resultTable.getModel());
      SNodeReference nodePointer = resultTM.getNodePointer(selIdx);
      SModel m = resultTM.getModelAt(selIdx);
      new EditorNavigator(myProject).shallFocus(true).shallSelect(true).open(new SNodePointer(SModelOperations.getPointer(m), nodePointer.getNodeId()));
    }
  }

  public boolean isSearchAll() {
    return searchAll;
  }

  public void toggleSearchAll(boolean flag) {
    searchAll = flag;
  }

  public boolean isApproximateSearch() {
    return approximateSearch;
  }

  public void toggleApproximateSearch(boolean flag) {
    approximateSearch = flag;
  }

  public boolean isMatchCase() {
    return matchCase;
  }

  public void toggleMatchCase(boolean flag) {
    matchCase = flag;
  }

  public boolean isMatchRegex() {
    return matchRegex;
  }

  public void toggleMatchRegex(boolean flag) {
    matchRegex = flag;
  }

  private static <T> T as_2z5w59_a0a0f0eb(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
