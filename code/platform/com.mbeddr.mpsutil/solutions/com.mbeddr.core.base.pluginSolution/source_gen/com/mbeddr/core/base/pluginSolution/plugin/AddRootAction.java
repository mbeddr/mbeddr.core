package com.mbeddr.core.base.pluginSolution.plugin;

/*Generated by MPS */

import jetbrains.mps.workbench.action.BaseAction;
import com.intellij.openapi.project.DumbAware;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.ide.icons.GlobalIconManager;
import com.intellij.openapi.actionSystem.AnActionEvent;
import java.util.Map;
import jetbrains.mps.ide.actions.MPSCommonDataKeys;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.smodel.action.NodeFactoryManager;
import org.jetbrains.mps.openapi.model.SNodeAccessUtil;
import jetbrains.mps.smodel.SNodeUtil;
import jetbrains.mps.ide.projectPane.CreateNodeExtension;
import jetbrains.mps.ide.projectPane.CreateRootFilterEP;
import jetbrains.mps.ide.projectPane.NewRootNodeAction;
import jetbrains.mps.openapi.navigation.NavigationSupport;
import java.util.Objects;

public class AddRootAction extends BaseAction implements DumbAware {
  private final SAbstractConcept myConcept;
  private final SModel myModel;
  private MPSProject myProject;
  private final String myPackage;
  public AddRootAction(final SAbstractConcept concept, SModel model, String caption, String packageName) {
    super(caption);
    myConcept = concept;
    myModel = model;
    myPackage = packageName;
    getTemplatePresentation().setIcon(GlobalIconManager.getInstance().getIconFor(concept));
  }


  @Override
  protected boolean collectActionData(AnActionEvent event, Map<String, Object> map) {
    if (!(super.collectActionData(event, map))) {
      return false;
    }
    myProject = MPSCommonDataKeys.MPS_PROJECT.getData(event.getDataContext());
    if (myProject == null) {
      return false;
    }
    return true;
  }
  protected void doExecute(AnActionEvent event, Map<String, Object> map) {
    final SNode node = NodeFactoryManager.createNode(myConcept, null, null, myModel);
    SNodeAccessUtil.setPropertyValue(node, SNodeUtil.property_BaseConcept_virtualPackage, myPackage);
    myModel.addRootNode(node);
    for (CreateNodeExtension ext : CreateRootFilterEP.getInstance().getCreateNodeExtensions()) {
      if (ext.isApplicable(myModel)) {
        ext.setupRoot(node);
      }
    }

    if (!(NewRootNodeAction.trySelectInCurrentPane(myProject, node))) {
      NavigationSupport.getInstance().selectInTree(myProject, node, false);
    }

    NavigationSupport.getInstance().openNode(myProject, node, true, false);
  }

  @Override
  public boolean equals(Object object) {
    if (object instanceof AddRootAction) {
      AddRootAction other = (AddRootAction) object;
      return Objects.equals(myConcept, other.myConcept);
    }
    return false;
  }

  @Override
  public int hashCode() {
    return (myConcept != null ? myConcept.hashCode() : 0);
  }
}
