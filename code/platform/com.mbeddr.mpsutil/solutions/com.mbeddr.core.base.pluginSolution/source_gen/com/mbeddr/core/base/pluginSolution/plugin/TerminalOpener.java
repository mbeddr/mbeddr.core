package com.mbeddr.core.base.pluginSolution.plugin;

/*Generated by MPS */

import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import java.util.LinkedList;
import java.io.File;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.application.ApplicationManager;
import com.intellij.openapi.ui.Messages;

public class TerminalOpener {
  private static boolean isOnWindows() {
    return System.getProperty("os.name").toLowerCase().contains("win");
  }
  private static boolean isOnMac() {
    return System.getProperty("os.name").equals("Mac OS X");
  }
  private static boolean isOnLinux() {
    String sysName = System.getProperty("os.name").toLowerCase();
    return sysName.contains("nux") || sysName.contains("nix") || sysName.contains("bsd");
  }
  public static List<String> getOSCommandWithParameters(String path) {
    List<String> commandWithParameters = ListSequence.fromList(new ArrayList<String>());
    if (isOnMac()) {
      ListSequence.fromList(commandWithParameters).addElement("/usr/bin/open");
      ListSequence.fromList(commandWithParameters).addElement("-a");
      ListSequence.fromList(commandWithParameters).addElement("Terminal");
      ListSequence.fromList(commandWithParameters).addElement(path);
    } else if (isOnWindows()) {
      ListSequence.fromList(commandWithParameters).addElement("cmd");
      ListSequence.fromList(commandWithParameters).addElement("/C");
      ListSequence.fromList(commandWithParameters).addElement("start");
    } else if (isOnLinux()) {
      List<String> terminals = ListSequence.fromList(new LinkedList<String>());
      ListSequence.fromList(terminals).addElement("/usr/bin/terminator");
      ListSequence.fromList(terminals).addElement("/usr/bin/konsole");
      ListSequence.fromList(terminals).addElement("/usr/bin/gnome-terminal");
      ListSequence.fromList(terminals).addElement("/usr/bin/xterm");

      // One for Unity?
      for (String term : terminals) {
        File f = new File(term);
        if (f.exists()) {
          ListSequence.fromList(commandWithParameters).addElement(term);
          if (term.endsWith("konsole")) {
            ListSequence.fromList(commandWithParameters).addElement("--workdir");
            ListSequence.fromList(commandWithParameters).addElement(path);
          }
          break;
        }
      }

    }
    return commandWithParameters;
  }
  public static void openTerminalInPath(final Project proj, File path) {
    List<String> commandWithParameters = getOSCommandWithParameters(path.getAbsolutePath());
    if (ListSequence.fromList(commandWithParameters).isEmpty()) {
      ApplicationManager.getApplication().invokeLater(() -> Messages.showErrorDialog(proj, "Don't know how to open a terminal for operating system '" + System.getProperty("os.name") + "'", "Error"));
    } else {
      try {

        File workingDir = path;
        if (!(workingDir.exists())) {
          ApplicationManager.getApplication().invokeLater(() -> Messages.showInfoMessage(proj, "Output folder does not exist, try building first", "Info"));
          return;
        }

        final String[] useDefaultEnvVar = null;
        Runtime.getRuntime().exec(ListSequence.fromList(commandWithParameters).toGenericArray(String.class), useDefaultEnvVar, workingDir);
      } catch (Exception ex) {
        final String m = "Cannot execute '" + ListSequence.fromList(commandWithParameters).first() + "'\n" + ex.getMessage();
        ApplicationManager.getApplication().invokeLater(() -> {
          Messages.showErrorDialog(proj, m, "Error");

        });
      }
    }

  }
}
