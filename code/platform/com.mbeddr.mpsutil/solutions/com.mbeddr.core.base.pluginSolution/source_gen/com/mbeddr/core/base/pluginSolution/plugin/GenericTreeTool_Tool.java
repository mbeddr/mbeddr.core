package com.mbeddr.core.base.pluginSolution.plugin;

/*Generated by MPS */

import jetbrains.mps.plugins.tool.GeneratedTool;
import javax.swing.Icon;
import com.intellij.icons.AllIcons;
import com.mbeddr.core.base.behavior.AbstractTreeViewNode;
import javax.swing.JTree;
import javax.swing.JTable;
import jetbrains.mps.project.Project;
import com.intellij.openapi.wm.ToolWindowAnchor;
import javax.swing.JComponent;
import javax.swing.JPanel;
import java.awt.BorderLayout;
import jetbrains.mps.workbench.action.BaseGroup;
import jetbrains.mps.workbench.action.ActionUtils;
import com.intellij.openapi.actionSystem.ActionManager;
import com.intellij.openapi.actionSystem.ActionPlaces;
import com.mbeddr.core.base.behavior.ICustomTreeBuilder;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.mbeddr.core.base.behavior.ITreeViewable__BehaviorDescriptor;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import javax.swing.tree.TreePath;
import com.mbeddr.core.base.behavior.NodeTreeViewNode;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.openapi.navigation.EditorNavigator;
import com.intellij.openapi.ui.JBPopupMenu;
import java.util.List;
import com.mbeddr.core.base.behavior.TreeViewAction;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import com.mbeddr.core.base.behavior.SeparatorAction;
import javax.swing.JMenuItem;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.Sequence;
import com.mbeddr.core.base.behavior.ITreeViewRoot__BehaviorDescriptor;
import com.mbeddr.core.base.behavior.ModelModifyingTreeViewAction;
import javax.swing.JScrollPane;
import javax.swing.JSplitPane;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class GenericTreeTool_Tool extends GeneratedTool {
  private static final Icon ICON = AllIcons.General.Tree;
  private AbstractTreeViewNode root;
  private JTree tree = new JTree();
  private JTable table;
  private GenericTreeModel treeModel;
  private Project project;
  private TreeHistory history = new TreeHistory();
  private AbstractChanceCategoryCallback callback;
  private CategoryComboboxModel categoryModel;
  public GenericTreeTool_Tool(com.intellij.openapi.project.Project project) {
    super(project, "Tree", null, ICON, ToolWindowAnchor.RIGHT, false);
  }
  /*package*/ void setRoot(AbstractTreeViewNode tvn, Project project) {
    GenericTreeTool_Tool.this.project = project;
    GenericTreeTool_Tool.this.changeRootTo(tvn);
  }
  private void changeRootTo(AbstractTreeViewNode newRoot) {
    if (newRoot == null) {
      return;
    }
    if (GenericTreeTool_Tool.this.history.getCurrent() != null) {
      TreeExpansionHelper h = new TreeExpansionHelper(GenericTreeTool_Tool.this.tree);
      h.captureExpansionState();
      GenericTreeTool_Tool.this.history.getCurrent().updateExpansionState(h.getExpansionState());
    }
    if (GenericTreeTool_Tool.this.categoryModel == null) {
      GenericTreeTool_Tool.this.categoryModel = new CategoryComboboxModel(GenericTreeTool_Tool.this.history);
    }
    GenericTreeTool_Tool.this.focusOn(newRoot);
  }
  private void focusOn(AbstractTreeViewNode newRoot) {
    if (newRoot == null) {
      return;
    }
    TreeExpansionHelper h = new TreeExpansionHelper(GenericTreeTool_Tool.this.tree);
    h.captureExpansionState();
    GenericTreeTool_Tool.this.history.add(newRoot);

    GenericTreeTool_Tool.this.categoryModel.setSelectedItem(newRoot.getCategory());
    int[] selection = GenericTreeTool_Tool.this.tree.getSelectionRows();
    GenericTreeTool_Tool.this.root = newRoot;
    GenericTreeTool_Tool.this.treeModel = new GenericTreeModel(newRoot);
    GenericTreeTool_Tool.this.getToolWindow().setTitle(": " + newRoot.getCategory() + " for " + newRoot.getLabel());
    GenericTreeTool_Tool.this.tree.setModel(GenericTreeTool_Tool.this.treeModel);
    h.resetExpansionState();
    GenericTreeTool_Tool.this.tree.setSelectionRows(selection);
    GenericTreeTool_Tool.this.tree.requestFocus();
  }
  public void showHistoryEntry(TreeHistory.HistoryElement element) {
    GenericTreeTool_Tool.this.focusOn(element.getTreeNode());
    TreeExpansionHelper h = new TreeExpansionHelper(GenericTreeTool_Tool.this.tree);
    h.resetExpansionState(element.getExpansionState());
  }
  public void refresh() {
    if (GenericTreeTool_Tool.this.root != null) {
      GenericTreeTool_Tool.this.focusOn(GenericTreeTool_Tool.this.root);
    }
  }
  public boolean canGoBack() {
    return GenericTreeTool_Tool.this.history.hasPrevious();
  }
  public boolean canGoForward() {
    return GenericTreeTool_Tool.this.history.hasNext();
  }
  public void goBack() {
    if (GenericTreeTool_Tool.this.history.getCurrent() != null) {
      TreeExpansionHelper h = new TreeExpansionHelper(GenericTreeTool_Tool.this.tree);
      h.captureExpansionState();
      GenericTreeTool_Tool.this.history.getCurrent().updateExpansionState(h.getExpansionState());
    }
    GenericTreeTool_Tool.this.showHistoryEntry(GenericTreeTool_Tool.this.history.moveToPrevious());
  }
  public void goForward() {
    if (GenericTreeTool_Tool.this.history.getCurrent() != null) {
      TreeExpansionHelper h = new TreeExpansionHelper(GenericTreeTool_Tool.this.tree);
      h.captureExpansionState();
      GenericTreeTool_Tool.this.history.getCurrent().updateExpansionState(h.getExpansionState());
    }
    GenericTreeTool_Tool.this.showHistoryEntry(GenericTreeTool_Tool.this.history.moveToNext());
  }
  public JComponent getComponent() {
    JPanel outerPanel = new JPanel();
    outerPanel.setLayout(new BorderLayout());


    BaseGroup group = ActionUtils.getGroup("com.mbeddr.core.base.pluginSolution.plugin.toolbackGroup_ActionGroup");
    JComponent toolbar = ActionManager.getInstance().createActionToolbar(ActionPlaces.TOOLBAR, group, true).getComponent();
    outerPanel.add(BorderLayout.NORTH, toolbar);


    GenericTreeTool_Tool.this.callback = new AbstractChanceCategoryCallback() {
      public void categoryChangedImpl(String newCat) {
        TreeHistory.HistoryElement curr = GenericTreeTool_Tool.this.history.getCurrent();
        if (curr != null && !(newCat.equals(curr.getTreeNode().getCategory()))) {
          ICustomTreeBuilder builder = curr.getTreeNode().getBuilder();
          if (builder != null) {
            GenericTreeTool_Tool.this.changeRootTo(builder.getTreeNode(newCat));
          } else {
            SNode pn = curr.getTreeNode().getProgramNode();
            if (pn != null && SNodeOperations.isInstanceOf(pn, CONCEPTS.ITreeViewRoot$wP)) {
              GenericTreeTool_Tool.this.changeRootTo(ITreeViewable__BehaviorDescriptor.getTreeNode_id7NyyyjNtbn2.invoke(SNodeOperations.cast(pn, CONCEPTS.ITreeViewRoot$wP), newCat));
            }
          }
        }
      }
    };
    GenericTreeTool_Tool.this.categoryModel = new CategoryComboboxModel(GenericTreeTool_Tool.this.history);
    group.add(new ChangeCategoryAction(GenericTreeTool_Tool.this.categoryModel, GenericTreeTool_Tool.this.callback));


    JPanel mainPanel = new JPanel();
    mainPanel.setLayout(new BorderLayout());
    outerPanel.add(mainPanel, BorderLayout.CENTER);


    GenericTreeTool_Tool.this.tree.setToggleClickCount(0);
    GenericTreeTool_Tool.this.tree.repaint();
    GenericTreeTool_Tool.this.tree.setRootVisible(true);


    GenericTreeTool_Tool.this.tree.addMouseListener(new MouseAdapter() {
      @Override
      public void mouseClicked(MouseEvent event) {
        TreePath selection = GenericTreeTool_Tool.this.tree.getSelectionPath();
        if (selection != null) {
          Object last = selection.getLastPathComponent();
          if (last instanceof AbstractTreeViewNode) {
            final AbstractTreeViewNode treeNode = ((AbstractTreeViewNode) last);
            if (treeNode instanceof NodeTreeViewNode) {
              if (event.getClickCount() == 2 && treeNode.selectOnDoubleClick()) {
                final Wrappers._T<SNode> programNode = new Wrappers._T<SNode>();
                Project mpsProject = GenericTreeTool_Tool.this.project;
                mpsProject.getRepository().getModelAccess().runReadAction(() -> programNode.value = ((NodeTreeViewNode) treeNode).getProgramNode());
                if (programNode.value != null) {
                  new EditorNavigator(mpsProject).shallFocus(true).shallSelect(true).open(SNodeOperations.getPointer(programNode.value));
                }
              }
            }
          }
        }
      }
      @Override
      public void mousePressed(MouseEvent event) {
        if (event.isPopupTrigger()) {
          showPopupMenu(event);
        }
      }

      @Override
      public void mouseReleased(MouseEvent event) {
        if (event.isPopupTrigger()) {
          showPopupMenu(event);
        }
      }


      public void createMenuActions(final JBPopupMenu menu, final AbstractTreeViewNode tvn, final List<TreeViewAction> actions) {
        for (TreeViewAction a : ListSequence.fromList(actions)) {
          if (a instanceof SeparatorAction) {
            menu.addSeparator();
          } else {
            final TreeViewAction finalA = a;
            JMenuItem i = new JMenuItem(finalA.getLabel());
            menu.add(i);
            i.addActionListener(new ActionListener() {
              public void actionPerformed(ActionEvent p0) {
                finalA.execute(tvn, GenericTreeTool_Tool.this.project);
              }
            });
          }
        }
      }

      private void showPopupMenu(MouseEvent event) {
        TreePath selection = GenericTreeTool_Tool.this.tree.getSelectionPath();
        if (selection == null) {
          return;
        }
        Object last = selection.getLastPathComponent();
        if (!(last instanceof AbstractTreeViewNode)) {
          return;
        }
        final AbstractTreeViewNode tvn = ((AbstractTreeViewNode) last);
        List<TreeViewAction> customActions = tvn.getActions();
        final List<TreeViewAction> defaultActions = ListSequence.fromList(new ArrayList<TreeViewAction>());

        if (customActions == null) {
          customActions = new ArrayList<TreeViewAction>();
        }
        if (tvn instanceof NodeTreeViewNode) {
          ListSequence.fromList(defaultActions).addElement(new TreeViewAction("Select in Editor", null) {
            public void execute(final AbstractTreeViewNode treeNode, final Project project) {
              final Wrappers._T<SNode> programNode = new Wrappers._T<SNode>();
              project.getRepository().getModelAccess().runReadAction(() -> programNode.value = ((NodeTreeViewNode) treeNode).getProgramNode());
              if (programNode.value != null) {
                new EditorNavigator(project).shallFocus(true).shallSelect(true).open(SNodeOperations.getPointer(programNode.value));
              }
            }
          });
        }
        ListSequence.fromList(defaultActions).addElement(new SeparatorAction());
        if (tvn instanceof NodeTreeViewNode && SNodeOperations.isInstanceOf(((NodeTreeViewNode) tvn).getProgramNode(), CONCEPTS.ITreeViewRoot$wP)) {
          if (GenericTreeTool_Tool.this.root != tvn) {
            ListSequence.fromList(defaultActions).addElement(new TreeViewAction("Use as Root", null) {
              public void execute(final AbstractTreeViewNode treeNode, final Project project) {
                GenericTreeTool_Tool.this.changeRootTo(((NodeTreeViewNode) tvn));
              }
            });
          }
        }
        GenericTreeTool_Tool.this.project.getRepository().getModelAccess().runReadAction(() -> {
          if (tvn instanceof NodeTreeViewNode && SNodeOperations.isInstanceOf(SNodeOperations.getParent(((NodeTreeViewNode) tvn).getProgramNode()), CONCEPTS.ITreeViewRoot$wP)) {
            if (GenericTreeTool_Tool.this.root == tvn) {
              SNode parent = SNodeOperations.cast(SNodeOperations.getParent(((NodeTreeViewNode) tvn).getProgramNode()), CONCEPTS.ITreeViewRoot$wP);
              final String currentCat = tvn.getCategory();
              if (Sequence.fromIterable(Sequence.fromArray(ITreeViewRoot__BehaviorDescriptor.getTreeCategories_id7NyyyjNtbmX.invoke(parent))).contains(currentCat)) {
                ListSequence.fromList(defaultActions).addElement(new ModelModifyingTreeViewAction("Use Parent as Root", null) {
                  protected void modifyModel(final AbstractTreeViewNode treeNode, final Project project) {
                    SNode parent = SNodeOperations.cast(SNodeOperations.getParent(((NodeTreeViewNode) tvn).getProgramNode()), CONCEPTS.ITreeViewRoot$wP);
                    GenericTreeTool_Tool.this.changeRootTo(ITreeViewable__BehaviorDescriptor.getTreeNode_id7NyyyjNtbn2.invoke(parent, currentCat));
                  }
                });
              }
            }
          }
        });
        if (tvn instanceof NodeTreeViewNode) {
          final NodeTreeViewNode ntvn = ((NodeTreeViewNode) tvn);
          final SNode programNode = ntvn.getProgramNode();
          if (SNodeOperations.isInstanceOf(programNode, CONCEPTS.ITreeViewRoot$wP)) {
            for (String cat : ITreeViewRoot__BehaviorDescriptor.getTreeCategories_id7NyyyjNtbmX.invoke(SNodeOperations.cast(programNode, CONCEPTS.ITreeViewRoot$wP))) {
              if (!(tvn.getCategory().equals(cat))) {
                final String finalCat = cat;
                ListSequence.fromList(defaultActions).addElement(new TreeViewAction("Use as Root in " + cat, null) {
                  public void execute(final AbstractTreeViewNode treeNode, final Project project) {
                    GenericTreeTool_Tool.this.project.getRepository().getModelAccess().runReadAction(() -> GenericTreeTool_Tool.this.changeRootTo(ITreeViewable__BehaviorDescriptor.getTreeNode_id7NyyyjNtbn2.invoke(SNodeOperations.cast(programNode, CONCEPTS.ITreeViewRoot$wP), finalCat)));
                  }
                });
              }
            }
          }
        }

        ListSequence.fromList(defaultActions).addElement(new SeparatorAction());
        ListSequence.fromList(defaultActions).addElement(new TreeViewAction("Refresh", null) {
          public void execute(final AbstractTreeViewNode treeNode, final Project project) {
            GenericTreeTool_Tool.this.refresh();
          }
        });
        JBPopupMenu menu = new JBPopupMenu();
        createMenuActions(menu, tvn, customActions);
        if (ListSequence.fromList(customActions).isNotEmpty()) {
          menu.addSeparator();
        }
        createMenuActions(menu, tvn, defaultActions);
        menu.show(GenericTreeTool_Tool.this.tree, event.getX(), event.getY());
      }
    });


    JScrollPane treeScroller = new JScrollPane(GenericTreeTool_Tool.this.tree);
    JScrollPane tableScroller = new JScrollPane(GenericTreeTool_Tool.this.table);

    boolean needsSplitter = false;
    if (needsSplitter) {
      JSplitPane splitter = new JSplitPane(JSplitPane.VERTICAL_SPLIT, treeScroller, tableScroller);
      splitter.setDividerLocation(300);
      mainPanel.add(splitter, BorderLayout.CENTER);
    } else {
      mainPanel.add(treeScroller, BorderLayout.CENTER);
    }

    GenericTreeTool_Tool.this.tree.setCellRenderer(new GenericTreeCellRenderer());

    return outerPanel;
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept ITreeViewRoot$wP = MetaAdapterFactory.getInterfaceConcept(0xd4280a54f6df4383L, 0xaa41d1b2bffa7eb1L, 0x2724a682b73d640L, "com.mbeddr.core.base.structure.ITreeViewRoot");
  }
}
