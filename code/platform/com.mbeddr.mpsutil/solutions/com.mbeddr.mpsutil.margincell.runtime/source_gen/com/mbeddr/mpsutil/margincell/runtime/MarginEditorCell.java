package com.mbeddr.mpsutil.margincell.runtime;

/*Generated by MPS */

import jetbrains.mps.nodeEditor.cells.EditorCell_Collection;
import jetbrains.mps.logging.Logger;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import java.awt.Graphics;
import jetbrains.mps.nodeEditor.cells.ParentSettings;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import com.mbeddr.mpsutil.margincell.behavior.IMarginCellContent__BehaviorDescriptor;
import jetbrains.mps.openapi.editor.selection.Selection;
import java.util.Iterator;
import jetbrains.mps.openapi.editor.cells.CellTraversalUtil;

public class MarginEditorCell extends EditorCell_Collection implements IUserObjectKeys {
  private static final Logger LOG_118854070 = Logger.getLogger(MarginEditorCell.class);
  private final MarginCellStyle style;

  public MarginEditorCell(EditorContext context, SNode contentNode, MarginCellStyle style) {
    super(context, contentNode, new MarginCellLayout(style), null);
    this.style = style;
  }


  @Override
  public void paintCell(Graphics graphics, ParentSettings settings) {
    super.paintCell(graphics, settings);
    paintCellDecorators(graphics, settings);
  }

  protected void paintCellDecorators(Graphics graphics, ParentSettings settings) {
    for (EditorCell child : ListSequence.fromList(ListSequence.fromListWithValues(new ArrayList<EditorCell>(), this.getContentCells())).tailListSequence(1).sort((a, b) -> {
      boolean aSelected = isSelected(a);
      boolean bSelected = isSelected(b);

      if (aSelected == bSelected) {
        return 0;
      } else if (aSelected) {
        return 1;
      } else {
        return -1;
      }
    }, true)) {
      paintCellAttachment(child, graphics, settings);
      paintCellBorder(child, graphics, settings);
      paintAttachedNodeShading(child, graphics, settings);
      paintConnections(child, graphics, settings);
    }
  }

  protected void paintCellAttachment(EditorCell contentCell, Graphics g_, ParentSettings settings) {
    Graphics g = g_.create();
    try {
      int sourceX = getIntUserObject(contentCell, ATTACHED_X_KEY);
      int sourceY = getIntUserObject(contentCell, ATTACHED_Y_KEY);

      int x = contentCell.getX();
      int y = contentCell.getY();

      style.setupAttachmentStyle(contentCell, g, isSelected(contentCell));

      int borderX = x - style.getBorderPadding(contentCell);

      g.drawPolyline(new int[]{borderX, style.getVerticalBound(contentCell), sourceX}, new int[]{y, sourceY, sourceY}, 3);
    } catch (NullPointerException e) {
      if (LOG_118854070.isWarningLevel()) {
        LOG_118854070.warning("error while drawing review annotations", e);
      }
    } finally {
      g.dispose();
    }
  }

  protected void paintCellBorder(EditorCell contentCell, Graphics graphics, ParentSettings settings) {
    int x = contentCell.getX();
    int y = contentCell.getY();

    style.setupBorderStyle(contentCell, graphics, isSelected(contentCell));

    int borderPadding = style.getBorderPadding(contentCell);
    int borderDiameter = style.getBorderDiameter(contentCell);
    graphics.drawRoundRect(x - borderPadding, y - borderPadding, contentCell.getWidth() + borderPadding, contentCell.getHeight() + borderPadding, borderDiameter, borderDiameter);
  }

  protected void paintAttachedNodeShading(EditorCell contentCell, Graphics graphics, ParentSettings settings) {
    try {
      int sourceX = getIntUserObject(contentCell, ATTACHED_X_KEY);
      int sourceY = getIntUserObject(contentCell, ATTACHED_Y_KEY);
      int sourceWidth = getIntUserObject(contentCell, ATTACHED_WIDTH_KEY);
      int sourceHeight = getIntUserObject(contentCell, ATTACHED_HEIGHT_KEY);

      style.setupOverlayStyle(contentCell, graphics, isSelected(contentCell));

      int borderDiameter = style.getBorderDiameter(contentCell);
      graphics.fillRoundRect(sourceX, sourceY, sourceWidth, sourceHeight, borderDiameter, borderDiameter);
    } catch (NullPointerException e) {
      if (LOG_118854070.isWarningLevel()) {
        LOG_118854070.warning("error while drawing review annotations", e);
      }
    }
  }


  protected void paintConnections(EditorCell contentCell, Graphics graphics, ParentSettings settings) {
    SNode node = (SNode) contentCell.getSNode();
    if (!((boolean) IMarginCellContent__BehaviorDescriptor.isConnectionAllowed_id10nVqVftAKg.invoke(node))) {
      return;
    }
    boolean someoneSelected = false;
    EditorCell currentCell = contentCell;
    while (currentCell.getUserObject(CONNECTED_CONTENT_NODE_KEY) != null) {
      if (isSelected(currentCell)) {
        someoneSelected = true;
        break;
      }
      currentCell = findConnectedCell(currentCell);
      if (currentCell == null) {
        return;
      }
    }

    EditorCell connectedCell = findConnectedCell(contentCell);
    if (connectedCell == null) {
      return;
    }

    style.setupConnectionStyle(contentCell, graphics, someoneSelected);

    int borderPadding = style.getBorderPadding(contentCell);
    int connectionMargin = style.getConnectionMargin(contentCell);

    int childY = contentCell.getY();
    int childRight = contentCell.getRight() + borderPadding;
    int childConnection = childRight + connectionMargin;

    int connectedY = connectedCell.getBottom() - borderPadding;
    int connectedRight = connectedCell.getRight() + borderPadding;
    int connectedConnection = connectedRight + connectionMargin;

    graphics.drawPolyline(new int[]{childRight, childConnection, connectedConnection, connectedRight}, new int[]{childY, childY, connectedY, connectedY}, 4);
  }

  protected EditorCell findConnectedCell(EditorCell cell) {
    SNode node = ((SNode) cell.getUserObject(CONNECTED_CONTENT_NODE_KEY));
    String cellId = ((String) cell.getUserObject(CONNECTED_CONTENT_CELL_ID_KEY));
    if (node == null || cellId == null) {
      return null;
    }
    return cell.getEditorComponent().findCellWithId(node, cellId);
  }

  protected boolean isSelected(EditorCell cell) {
    Selection selection = getEditorComponent().getSelectionManager().getSelection();
    if (selection == null) {
      return false;
    }
    Iterator<EditorCell> iterator = selection.getSelectedCells().iterator();
    if (iterator.hasNext()) {
      return CellTraversalUtil.isAncestor(cell, iterator.next());
    } else {
      return false;
    }
  }

  private int getIntUserObject(EditorCell cell, String key) {
    Object userObject = cell.getUserObject(key);
    if (userObject == null || !(userObject instanceof Integer)) {
      throw new NullPointerException("cannot get key '" + key + "' from cell " + cell.getCellId());
    }

    return ((Integer) userObject);
  }
}
