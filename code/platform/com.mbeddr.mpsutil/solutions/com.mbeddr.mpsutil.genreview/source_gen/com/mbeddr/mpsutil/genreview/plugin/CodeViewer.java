package com.mbeddr.mpsutil.genreview.plugin;

/*Generated by MPS */

import javax.swing.JTextPane;
import java.awt.Color;
import java.io.Reader;
import java.io.IOException;
import javax.swing.text.StyledDocument;
import javax.swing.text.BadLocationException;
import com.mbeddr.mpsutil.genreview.highlighting.HighlightingStrategyBase;
import com.mbeddr.mpsutil.genreview.highlighting.HighlightingStrategyManager;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import javax.swing.text.SimpleAttributeSet;
import java.util.List;
import java.util.regex.Pattern;
import java.util.regex.Matcher;

public class CodeViewer extends JTextPane {

  private String fileName;

  public CodeViewer() {
    setBackground(Color.WHITE);
    setEditable(false);
  }

  @Override
  public void read(Reader reader, Object object) throws IOException {
    super.read(reader, object);

    StyledDocument doc = getStyledDocument();
    String text = "";
    try {
      text = doc.getText(0, doc.getLength());
    } catch (BadLocationException e) {
      e.printStackTrace();
    }
    HighlightingStrategyBase hs = HighlightingStrategyManager.getHighlightingStrategyFor(fileName);
    if (hs == null) {
      return;
    }
    for (Tuples._2<Integer, Color> cPair : SetSequence.fromSet(MapSequence.fromMap(hs.getAttributes2KeywordsMap()).keySet())) {
      SimpleAttributeSet attr = HighlightingStrategyBase.toSwingTextAttribute(cPair);
      List<String> crtKeywords = MapSequence.fromMap(hs.getAttributes2KeywordsMap()).get(cPair);
      for (String word : crtKeywords) {
        Pattern pattern = Pattern.compile("(\\b|@|\n|^)" + word + "\\b");
        Matcher m = pattern.matcher(text);
        while (m.find()) {
          doc.setCharacterAttributes(m.start(), m.end() - m.start(), attr, false);
        }
      }
    }
  }

  public void setFileName(String fileName) {
    // used for the recognition of the file type for the highlighting
    this.fileName = fileName;
  }

  @Override
  public String getText() {
    StyledDocument doc = getStyledDocument();
    String text = "";
    try {
      text = doc.getText(0, doc.getLength());
    } catch (BadLocationException e) {
      e.printStackTrace();
    }
    return text;
  }
}
