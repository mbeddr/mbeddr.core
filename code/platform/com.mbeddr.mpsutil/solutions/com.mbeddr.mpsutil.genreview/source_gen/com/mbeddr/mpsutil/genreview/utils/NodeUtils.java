package com.mbeddr.mpsutil.genreview.utils;

/*Generated by MPS */

import java.io.File;
import java.io.LineNumberReader;
import java.io.FileReader;

/**
 * General utility methods.
 */
public class NodeUtils {

  /**
   * Returns the full unit name from a full path -- e.g. a.b.file from /Users/.../source_gen/a/b/file.c
   */
  private static String extractUnitName(String fullQualifiedFileName, String folderName) {
    String result;
    int startPos = fullQualifiedFileName.lastIndexOf(folderName);
    if (startPos >= 0) {
      String tmp = fullQualifiedFileName.substring(startPos + folderName.length());
      // under windows we have both slashes in path
      tmp = tmp.replaceAll("\\\\", ".");
      fullQualifiedFileName = tmp.replaceAll("/", ".");
      int lengthFileExtension = getFileExtension(fullQualifiedFileName).length() + 1;
      result = fullQualifiedFileName.substring(1, fullQualifiedFileName.length() - lengthFileExtension);
    } else {
      result = fullQualifiedFileName;
    }
    return result;
  }

  public static String getUnitNameFromPath(String path) {
    if (new File(path).isAbsolute()) {
      return getUnitName(path);
    }

    // the path is relative
    // under windows we have both slashes in path
    String tmp = path.replaceAll("\\\\", ".");
    tmp = tmp.replaceAll("/", ".");
    String res = tmp.substring(0, path.length() - 2);
    return res;
  }

  public static String getUnitName(String fullQualifiedFileName) throws IllegalArgumentException {
    if (fullQualifiedFileName == null) {
      throw new IllegalArgumentException("fullQualifiedFileName is null");
    }
    if (!(fullQualifiedFileName.contains("source_gen")) && !(fullQualifiedFileName.contains("classes_gen")) && !(fullQualifiedFileName.contains("test_gen"))) {
      throw new IllegalArgumentException(fullQualifiedFileName + " should reside in a source_gen, test_gen or classes_gen folder");
    }
    String result = null;
    if (fullQualifiedFileName.contains("source_gen")) {
      result = extractUnitName(fullQualifiedFileName, "source_gen");
    } else if (fullQualifiedFileName.contains("classes_gen")) {
      result = extractUnitName(fullQualifiedFileName, "classes_gen");
    } else if (fullQualifiedFileName.contains("test_gen")) {
      result = extractUnitName(fullQualifiedFileName, "test_gen");
    }
    return result;
  }

  public static String getFileName(String fullQualifiedName) throws IllegalArgumentException {
    if (fullQualifiedName == null) {
      throw new IllegalArgumentException("fullQualifiedName is null");
    }
    int winStartPos = fullQualifiedName.lastIndexOf('\\');
    int unixStartPos = fullQualifiedName.lastIndexOf('/');
    if (winStartPos >= 0) {
      return fullQualifiedName.substring(winStartPos + 1);
    } else if (unixStartPos >= 0) {
      return fullQualifiedName.substring(unixStartPos + 1);
    } else {
      return fullQualifiedName;
    }
  }

  public static String getFileExtension(String fileName) {
    int index = fileName.lastIndexOf(".");
    if (index != -1) {
      return fileName.substring(index + 1);
    } else {
      return "";
    }
  }

  public static int getLinesNumber(File file) {
    int lines = 0;
    try {
      LineNumberReader lnr = new LineNumberReader(new FileReader(file));
      lnr.skip(Long.MAX_VALUE);
      lines = lnr.getLineNumber() + 1;
      lnr.close();
    } catch (Exception e) {
      e.printStackTrace();
    }
    return lines;
  }
}
