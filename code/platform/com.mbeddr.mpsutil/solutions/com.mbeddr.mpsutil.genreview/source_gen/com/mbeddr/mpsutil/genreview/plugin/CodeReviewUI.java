package com.mbeddr.mpsutil.genreview.plugin;

/*Generated by MPS */

import javax.swing.JPanel;
import java.awt.event.ActionListener;
import com.intellij.openapi.project.Project;
import jetbrains.mps.project.MPSProject;
import javax.swing.JButton;
import javax.swing.JFileChooser;
import javax.swing.JScrollPane;
import java.io.File;
import java.util.List;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.ide.project.ProjectHelper;
import java.awt.GraphicsEnvironment;
import javax.swing.BoxLayout;
import java.awt.Toolkit;
import javax.swing.AbstractAction;
import java.awt.event.ActionEvent;
import javax.swing.KeyStroke;
import java.awt.Dimension;
import com.intellij.icons.AllIcons;
import jetbrains.mps.openapi.navigation.EditorNavigator;
import jetbrains.mps.smodel.SNodePointer;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import com.mbeddr.mpsutil.genreview.utils.NodeUtils;
import com.mbeddr.mpsutil.genreview.utils.NodesTracingFacade;
import javax.swing.text.Element;
import java.util.ArrayList;
import javax.swing.text.Highlighter;
import javax.swing.text.DefaultHighlighter;
import java.awt.Color;
import javax.swing.text.Utilities;
import javax.swing.text.BadLocationException;
import java.io.FileReader;
import java.io.BufferedReader;
import java.awt.Rectangle;
import java.awt.Point;
import javax.swing.event.MouseInputAdapter;
import java.awt.event.MouseEvent;

public class CodeReviewUI extends JPanel implements ActionListener {

  /*package*/ Project project;
  /*package*/ MPSProject mpsProject;
  /*package*/ CodeViewer textArea;
  /*package*/ JButton selectFileButton;
  /*package*/ JButton previousNodeButton;
  /*package*/ JButton nextNodeButton;
  /*package*/ JButton highlightButton;
  /*package*/ JButton refreshButton;
  /*package*/ JFileChooser fileChooser;
  /*package*/ JScrollPane scrollPane;
  /*package*/ File currentFile;
  /*package*/ List<SNode> nodesList;
  /*package*/ int nodesListIndex;
  /*package*/ int selectedLine;
  /*package*/ File modelFolder;
  /*package*/ SRepository repository;
  /*package*/ GenericSearchPanel searchPanel = new GenericSearchPanel();

  public void setCurrentProject(Project proj) {
    this.project = proj;
    mpsProject = ProjectHelper.fromIdeaProject(project);
  }

  public void setUI() {
    if (GraphicsEnvironment.isHeadless()) {
      // Try to avoid HeadlessException in tests
      return;
    }

    // sets the UI the first time the Code Review Tab is opened
    setLayout(new BoxLayout(this, BoxLayout.Y_AXIS));

    this.add(searchPanel);
    int menuShortcutKeyMask = Toolkit.getDefaultToolkit().getMenuShortcutKeyMask();
    this.registerKeyboardAction(new AbstractAction() {
      @Override
      public void actionPerformed(ActionEvent e) {
        searchPanel.activate();
      }
    }, KeyStroke.getKeyStroke('F', menuShortcutKeyMask), WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);

    fileChooser = new JFileChooser();
    textArea = new CodeViewer();
    searchPanel.setCurrentTextComponent(textArea);

    TextLineNumber tln = new TextLineNumber(textArea, 4);
    scrollPane = new JScrollPane(textArea, JScrollPane.VERTICAL_SCROLLBAR_AS_NEEDED, JScrollPane.HORIZONTAL_SCROLLBAR_AS_NEEDED);
    scrollPane.setRowHeaderView(tln);

    JPanel buttonPanel = new JPanel();
    buttonPanel.setMaximumSize(new Dimension(2500, 75));
    buttonPanel.setMinimumSize(new Dimension(2500, 75));
    buttonPanel.setPreferredSize(new Dimension(2500, 75));
    selectFileButton = new JButton(" Select file to review", AllIcons.General.OpenDisk);
    previousNodeButton = new JButton("", AllIcons.Actions.Back);
    nextNodeButton = new JButton("", AllIcons.Actions.Forward);
    highlightButton = new JButton("Highlight lines not linked");
    highlightButton.setEnabled(false);
    refreshButton = new JButton("Reload", AllIcons.Actions.Refresh);

    selectFileButton.addActionListener(this);
    previousNodeButton.addActionListener(this);
    nextNodeButton.addActionListener(this);
    highlightButton.addActionListener(this);
    refreshButton.addActionListener(this);
    textArea.addMouseListener(new CodeReviewMouseListener());

    buttonPanel.add(previousNodeButton);
    buttonPanel.add(nextNodeButton);
    buttonPanel.add(highlightButton);
    buttonPanel.add(selectFileButton);
    buttonPanel.add(refreshButton);
    this.add(scrollPane);
    this.add(buttonPanel);
  }

  @Override
  public void actionPerformed(ActionEvent event) {
    // Method performed when a button in the panel is pressed

    // Select File button
    if (event.getSource() == selectFileButton) {
      if (modelFolder != null) {
        fileChooser.setCurrentDirectory(modelFolder);
      }
      int returnVal = fileChooser.showOpenDialog(this);
      if (returnVal == JFileChooser.APPROVE_OPTION) {
        currentFile = fileChooser.getSelectedFile();
        readCurrentFileInTextArea();
        highlightButton.setEnabled(true);
      }
      // Previous Node button
    } else if (event.getSource() == previousNodeButton && nodesListIndex > 0) {
      nodesListIndex--;
      if (nodesListIndex == 0) {
        previousNodeButton.setEnabled(false);
      }
      nextNodeButton.setEnabled(true);
      if (mpsProject != null) {
        new EditorNavigator(mpsProject).shallFocus(true).selectIfChild().open(new SNodePointer(nodesList.get(nodesListIndex)));
      }
      // Next Node button
    } else if (event.getSource() == nextNodeButton && nodesListIndex < ListSequence.fromList(nodesList).count() - 1) {
      nodesListIndex++;
      previousNodeButton.setEnabled(true);
      if (nodesListIndex == ListSequence.fromList(nodesList).count() - 1) {
        nextNodeButton.setEnabled(false);
      }
      if (mpsProject != null) {
        new EditorNavigator(mpsProject).shallFocus(true).selectIfChild().open(new SNodePointer(nodesList.get(nodesListIndex)));
      }
      // highlights the lines which are not related to any node
    } else if (event.getSource() == highlightButton) {
      removeHighlight();
      final Wrappers._T<List<SNode>> list = new Wrappers._T<List<SNode>>();
      int lines = NodeUtils.getLinesNumber(currentFile);
      for (final Wrappers._int line = new Wrappers._int(0); line.value < lines; line.value++) {
        repository.getModelAccess().runReadAction(() -> {
          list.value = NodesTracingFacade.doFindAllPossibleOriginalNodes(currentFile.getAbsolutePath(), line.value, repository);
          if (ListSequence.fromList(list.value).count() == 0) {
            Element root = textArea.getDocument().getDefaultRootElement();
            int startOfLineOffset = root.getElement(line.value).getStartOffset();
            highlightLine(startOfLineOffset);
          }
        });
      }
    } else if (event.getSource() == refreshButton) {
      readCurrentFileInTextArea();
    }
  }


  private void setUniqueNodesList() {
    List<SNode> newList = new ArrayList<SNode>();
    previousNodeButton.setEnabled(false);
    for (SNode n : ListSequence.fromList(nodesList)) {
      if (!(ListSequence.fromList(newList).contains(n))) {
        newList.add(n);
      }
    }
    nodesList = newList;
  }

  private void removeHighlight() {
    textArea.getHighlighter().removeAllHighlights();
  }

  private void highlightLine(int offset) {
    Highlighter.HighlightPainter painter = new DefaultHighlighter.DefaultHighlightPainter(Color.LIGHT_GRAY);
    try {
      int startIndex = Utilities.getRowStart(textArea, offset);
      int endIndex = Utilities.getRowEnd(textArea, offset);
      textArea.getHighlighter().addHighlight(startIndex, endIndex, painter);
    } catch (BadLocationException e) {
      e.printStackTrace();
    }
  }

  public void setModelFolder(File folder) {
    this.modelFolder = folder;
  }

  /**
   * populate the CodeViewer window with the text of the currentFile
   */
  private void readCurrentFileInTextArea() {
    textArea.setFileName(currentFile.getName());
    try {
      FileReader in;
      BufferedReader br;
      in = new FileReader(currentFile);
      br = new BufferedReader(in);
      textArea.removeAll();
      textArea.read(br, null);
      scrollPane.getVerticalScrollBar().setValue(0);
      scrollPane.getHorizontalScrollBar().setValue(0);
      textArea.getHighlighter().removeAllHighlights();
    } catch (Exception e) {
      e.printStackTrace();
    }
  }

  public void setFileAndDisplayInTextArea(File f) {
    this.currentFile = f;
    readCurrentFileInTextArea();
  }

  /**
   * finds and highlights the lines of a selected node in the generated file
   */
  public void highlightLinesForNode(SNode node) {
    List<Integer> linesList = NodesTracingFacade.findLinesForNode(node, currentFile, repository);
    removeHighlight();
    Element root = textArea.getDocument().getDefaultRootElement();
    for (int line : linesList) {
      int startOfLineOffset = root.getElement(line).getStartOffset();
      highlightLine(startOfLineOffset - 1);
    }
    try {
      int startOffsetHighlight = root.getElement(ListSequence.fromList(linesList).first()).getStartOffset();
      Rectangle highlightViewRect;
      Rectangle shownViewRect = scrollPane.getViewport().getViewRect();
      Point firstLineShownPoint = shownViewRect.getLocation();
      int offsetFirstLineShown = textArea.viewToModel(firstLineShownPoint);
      if (offsetFirstLineShown > startOffsetHighlight) {
        highlightViewRect = textArea.modelToView(startOffsetHighlight - shownViewRect.height);
        if (highlightViewRect != null) {
          textArea.scrollRectToVisible(highlightViewRect);
        }
      } else if (offsetFirstLineShown + shownViewRect.height < startOffsetHighlight) {
        highlightViewRect = textArea.modelToView(startOffsetHighlight + shownViewRect.height);
        if (highlightViewRect != null) {
          textArea.scrollRectToVisible(highlightViewRect);
        }
      }
    } catch (BadLocationException e) {
      e.printStackTrace();
    }
  }
  private class CodeReviewMouseListener extends MouseInputAdapter {
    /**
     * opens the model file and highlight the right node when the mouse selects a line in the generated file
     */
    @Override
    public void mouseClicked(MouseEvent event) {

      if (event.getSource() == textArea) {
        final int offset = textArea.viewToModel(event.getPoint());
        final Wrappers._int clickedLineNumber = new Wrappers._int(-1);
        clickedLineNumber.value = textArea.getDocument().getDefaultRootElement().getElementIndex(offset);
        if (selectedLine != clickedLineNumber.value) {
          repository.getModelAccess().runReadAction(() -> {
            removeHighlight();
            highlightLine(offset);
            nodesList = NodesTracingFacade.doFindAllPossibleOriginalNodes(currentFile.getAbsolutePath(), clickedLineNumber.value + 1, repository);
            setUniqueNodesList();
            if (ListSequence.fromList(nodesList).count() == 1) {
              nextNodeButton.setEnabled(false);
            } else {
              nextNodeButton.setEnabled(true);
            }
            nodesListIndex = 0;
            if (mpsProject != null) {
              new EditorNavigator(mpsProject).shallFocus(true).selectIfChild().open(new SNodePointer(ListSequence.fromList(nodesList).first()));
            }
            selectedLine = clickedLineNumber.value;
          });
          // If one click on the the same line after is selected it becomes deselected
        } else {
          textArea.getHighlighter().removeAllHighlights();
          selectedLine = -1;
        }
      }
    }
  }
}
