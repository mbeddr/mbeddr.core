package com.mbeddr.mpsutil.genreview.plugin;

/*Generated by MPS */

import jetbrains.mps.project.MPSProject;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.List;
import com.mbeddr.mpsutil.genreview.utils.NodesTracingFacade;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import com.intellij.openapi.application.ApplicationManager;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import java.io.File;
import com.intellij.openapi.ui.Messages;

public class HighlightCodeForNodeHelper {

  public static void highlightCodeForNode(MPSProject proj, SNode n, final CodeReviewTool_Tool crt) {
    crt.setRepository(proj.getRepository());

    // if a file is already opened
    if (crt.getFile() != null) {
      List<Integer> foundLines = NodesTracingFacade.findLinesForNode(n, crt.getFile(), proj.getRepository());
      if (!(ListSequence.fromList(foundLines).isEmpty())) {
        ApplicationManager.getApplication().invokeLater(() -> crt.openTool(true));
        crt.highlightLinesForNode(n);
        return;
      }
    }

    // if some path is already selected, try to find lines there
    if (crt.getModelFolder() != null) {
      Tuples._2<File, List<Integer>> file2lines = NodesTracingFacade.findLinesForNodeFromPath(crt.getModelFolder(), n, proj.getRepository());
      if (file2lines != null) {
        ApplicationManager.getApplication().invokeLater(() -> crt.openTool(true));
        crt.setFile(file2lines._0());
        crt.highlightLinesForNode(n);
      } else {
        ApplicationManager.getApplication().invokeLater(() -> Messages.showMessageDialog("Please try to:\n    1) select another node,\n    2) select another directory where to look for, or\n    3) set the generated file manually.", "No lines found for selected node", null));
      }

    }

    // no file is opened, or node not found, we do our best - look in the output directory for the model containing the searched node
    Tuples._2<File, List<Integer>> file2lines = NodesTracingFacade.findLinesForNode(n, proj.getRepository());
    if (file2lines != null) {
      crt.openTool(true);
      crt.setFile(file2lines._0());
      crt.highlightLinesForNode(n);
    } else {
      ApplicationManager.getApplication().invokeLater(() -> Messages.showMessageDialog("Please try to:\n\t 1) select another node, or\n\t 2) set the generated file manually.", "No lines found for selected node", null));
    }
  }

}
