package com.mbeddr.mpsutil.multilingual.settings.runtime.plugin;

/*Generated by MPS */

import com.mbeddr.mpsutil.preferenceform.runtime.PreferenceFormProjectComponentBase;
import jetbrains.mps.logging.Logger;
import com.intellij.openapi.util.Key;
import com.intellij.openapi.project.Project;
import com.intellij.ide.util.PropertiesComponent;
import com.mbeddr.mpsutil.preferenceform.runtime.AbstractPreferenceFormConfigurable;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.project.MPSProject;
import com.mbeddr.mpsutil.multilingual.concept.runtime.plugin.MultilingualTranslationProvider;
import org.jetbrains.mps.openapi.model.SNode;
import com.mbeddr.mpsutil.multilingual.common.runtime.plugin.MultilingualLanguageProvider;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import java.util.List;
import java.util.ArrayList;
import com.mbeddr.mpsutil.preferenceform.runtime.AbstractPreferenceFormComponent;
import com.intellij.ide.util.PropertyName;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;

public class MultilingualSettings_PreferencesComponent extends PreferenceFormProjectComponentBase {
  private static final Logger LOG = Logger.getLogger(MultilingualSettings_PreferencesComponent.class);
  public static final Key PREF_COMP_KEY = Key.create("MultilingualSettings_PreferencesComponent");

  private static MultilingualSettings_PreferencesComponent instance = null;

  private MyState myState = new MyState();

  public MultilingualSettings_PreferencesComponent(Project project) {
    super(project);
    instance = this;
  }

  public static MultilingualSettings_PreferencesComponent getInstance() {
    return instance;
  }

  @Override
  public void loadState() {
    boolean loadFields = PropertiesComponent.getInstance(getProject()).loadFields(this.myState);
    if (LOG.isTraceLevel()) {
      LOG.trace("Multilingual Settings" + ": loadFields: " + loadFields);
    }

    this.afterRead(this.getMPSProject());
    for (AbstractPreferenceFormConfigurable page : ListSequence.fromList(this.getPages())) {
      page.reset();
    }
  }

  @Override
  public void saveState() {
    this.beforeWrite(this.getMPSProject());
    boolean saveFields = PropertiesComponent.getInstance(getProject()).saveFields(myState);
    if (LOG.isTraceLevel()) {
      LOG.trace("Multilingual Settings" + ": saveFields: " + saveFields);
    }
  }

  public void afterRead(MPSProject project) {
    MultilingualTranslationProvider translationProvider = MultilingualTranslationProvider.getInstance();
    MultilingualSettings_PreferencesComponent.this.getStateObject().showTranslations = translationProvider.isShowTranslations();
    MultilingualSettings_PreferencesComponent.this.getStateObject().showTranslationsIntentionEnabled = translationProvider.isShowTranslationsIntentionEnabled();

    final SNode currentLanguage = MultilingualLanguageProvider.getInstance().getCurrentLanguage();
    // current language may be null, so the repository can be null, as well
    final SRepository repository = check_6elzdk_a0g0o(check_6elzdk_a0a0g0o(currentLanguage));
    if (repository != null) {
      repository.getModelAccess().runReadAction(() -> MultilingualSettings_PreferencesComponent.this.getStateObject().currentLanguage = SPropertyOperations.getString(currentLanguage, PROPS.languageCode$o_oz) + "_" + SPropertyOperations.getString(currentLanguage, PROPS.countryCode$oEyT));
    }
  }

  public void beforeWrite(MPSProject project) {
    MultilingualTranslationProvider translationProvider = MultilingualTranslationProvider.getInstance();
    translationProvider.setShowTranslations(MultilingualSettings_PreferencesComponent.this.getStateObject().showTranslations());
    translationProvider.setShowTranslationsIntentionEnabled(MultilingualSettings_PreferencesComponent.this.getStateObject().showTranslationsIntentionEnabled());

    if (isEmptyString(MultilingualSettings_PreferencesComponent.this.getStateObject().currentLanguage())) {
      return;
    }

    final String[] parts = MultilingualSettings_PreferencesComponent.this.getStateObject().currentLanguage().split("_");
    if (parts == null || parts.length < 2) {
      return;
    }

    final SRepository repository = project.getRepository();
    repository.getModelAccess().runReadAction(() -> MultilingualLanguageProvider.getInstance().setCurrentLanguage(repository, parts[0], parts[1]));
  }

  public MyState getStateObject() {
    return this.myState;
  }

  public List<AbstractPreferenceFormConfigurable> createPages() {
    return ListSequence.fromListAndArray(new ArrayList<AbstractPreferenceFormConfigurable>(), new MultilingualSettings_Configurable(getProject(), this));
  }

  public static class MyState extends AbstractPreferenceFormComponent.AbstractMyState {
    @PropertyName(value = "com.mbeddr.mpsutil.multilingual.settings.runtime.plugin.showTranslations")
    public boolean showTranslations = false;
    @PropertyName(value = "com.mbeddr.mpsutil.multilingual.settings.runtime.plugin.showTranslationsIntentionEnabled")
    public boolean showTranslationsIntentionEnabled = true;
    @PropertyName(value = "com.mbeddr.mpsutil.multilingual.settings.runtime.plugin.currentLanguage")
    public String currentLanguage = "";
    public MyState() {
    }

    public boolean showTranslations() {
      return showTranslations;
    }
    public boolean showTranslationsIntentionEnabled() {
      return showTranslationsIntentionEnabled;
    }
    public String currentLanguage() {
      if ((currentLanguage == null || currentLanguage.length() == 0)) {
        currentLanguage = ((_FunctionTypes._return_P0_E0<String>) () -> {
          SNode currentLanguage = MultilingualLanguageProvider.getInstance().getCurrentLanguage();
          return SPropertyOperations.getString(currentLanguage, PROPS.languageCode$o_oz) + "_" + SPropertyOperations.getString(currentLanguage, PROPS.countryCode$oEyT);
        }).invoke();
      }
      return currentLanguage;
    }
  }
  private static SRepository check_6elzdk_a0g0o(SModel checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getRepository();
    }
    return null;
  }
  private static SModel check_6elzdk_a0a0g0o(SNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return SNodeOperations.getModel(checkedDotOperand);
    }
    return null;
  }
  private static boolean isEmptyString(String str) {
    return str == null || str.isEmpty();
  }

  private static final class PROPS {
    /*package*/ static final SProperty countryCode$oEyT = MetaAdapterFactory.getProperty(0x23f985f2965f4af1L, 0xaee8a32677429514L, 0x7e347dff5959facL, 0x7e347dff5959faeL, "countryCode");
    /*package*/ static final SProperty languageCode$o_oz = MetaAdapterFactory.getProperty(0x23f985f2965f4af1L, 0xaee8a32677429514L, 0x7e347dff5959facL, 0x7e347dff5959fadL, "languageCode");
  }
}
