package com.mbeddr.mpsutil.spreferences.runtime;

/*Generated by MPS */

import javax.swing.JPanel;
import jetbrains.mps.logging.Logger;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.nodeEditor.inspector.InspectorEditorComponent;
import org.jetbrains.mps.openapi.module.SRepository;
import com.intellij.openapi.ui.Splitter;
import javax.swing.JButton;
import org.jetbrains.mps.openapi.model.SNode;
import java.awt.FlowLayout;
import java.awt.event.ActionEvent;
import java.awt.BorderLayout;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.ide.ui.dialogs.properties.MPSPropertiesConfigurable;
import jetbrains.mps.ide.ui.dialogs.properties.ModulePropertiesConfigurable;
import com.intellij.openapi.options.ex.SingleConfigurableEditor;
import jetbrains.mps.ide.project.ProjectHelper;
import javax.swing.SwingUtilities;
import jetbrains.mps.ide.ui.dialogs.properties.ModelPropertiesConfigurable;
import jetbrains.mps.openapi.navigation.EditorNavigator;
import jetbrains.mps.smodel.SNodePointer;
import java.awt.Window;
import java.awt.Component;

public class SPreferencesPanel extends JPanel {
  private static final Logger LOG = Logger.getLogger(SPreferencesPanel.class);
  private MPSProject myProject;
  private SPreferencesEditorComponent nodeEditor;
  private InspectorEditorComponent inspector;
  private SRepository myRepository;
  private Splitter splitter;
  private JPanel toolbar;
  private JButton cmdModelProperties;
  private JButton cmdModuleProperties;
  private JButton cmdOpenInMainWindow;
  private SNode myNode;

  public SPreferencesPanel(SRepository repository, MPSProject project) {
    myRepository = repository;
    myProject = project;
    init();
  }

  private void init() {
    splitter = new Splitter(true, 0.7f);
    inspector = new InspectorEditorComponent(myRepository);
    nodeEditor = new SPreferencesEditorComponent(myRepository, inspector);
    toolbar = new JPanel(new FlowLayout(FlowLayout.LEFT));
    cmdModelProperties = new JButton("Model Properties");
    cmdModuleProperties = new JButton("Module Properties");
    cmdOpenInMainWindow = new JButton("Open in Main Window");

    cmdModelProperties.addActionListener((ActionEvent e) -> openModelProperties());
    cmdModuleProperties.addActionListener((ActionEvent e) -> openModuleProperties());
    cmdOpenInMainWindow.addActionListener((ActionEvent e) -> openInMainWindow());

    setLayout(new BorderLayout());
    add(toolbar, BorderLayout.NORTH);
    add(splitter, BorderLayout.CENTER);
    splitter.setFirstComponent(nodeEditor.getExternalComponent());
    splitter.setSecondComponent(inspector.getExternalComponent());

    toolbar.add(cmdModuleProperties);
    toolbar.add(cmdModelProperties);
    toolbar.add(cmdOpenInMainWindow);
  }

  public void dispose() {
    nodeEditor.dispose();
  }

  public void edit(SNode node) {
    myNode = node;
    nodeEditor.editNode(node);
  }

  public void openModuleProperties() {
    SNode editedNode = nodeEditor.getEditedNode();
    if (editedNode == null) {
      return;
    }
    SModel model = editedNode.getModel();
    if (model == null) {
      return;
    }
    try {
      MPSPropertiesConfigurable configurable = new ModulePropertiesConfigurable(model.getModule(), myProject);
      final SingleConfigurableEditor configurableEditor = new SingleConfigurableEditor(ProjectHelper.toIdeaProject(myProject), configurable, "#MPSPropertiesConfigurable");
      configurable.setParentForCallBack(configurableEditor);
      SwingUtilities.invokeLater(() -> configurableEditor.show());
    } catch (Throwable t) {
      if (LOG.isErrorLevel()) {
        LOG.error(t.getMessage(), t);
      }
    }
  }

  public void openModelProperties() {
    SNode editedNode = nodeEditor.getEditedNode();
    if (editedNode == null) {
      return;
    }
    try {
      MPSPropertiesConfigurable configurable = new ModelPropertiesConfigurable(editedNode.getModel(), myProject);
      final SingleConfigurableEditor configurableEditor = new SingleConfigurableEditor(ProjectHelper.toIdeaProject(myProject), configurable, "#MPSPropertiesConfigurable");
      configurable.setParentForCallBack(configurableEditor);
      SwingUtilities.invokeLater(() -> configurableEditor.show());
    } catch (Throwable t) {
      if (LOG.isErrorLevel()) {
        LOG.error(t.getMessage(), t);
      }
    }
  }

  public void openInMainWindow() {
    getEditorWindow().setVisible(false);
    new EditorNavigator(myProject).shallFocus(true).selectIfChild().open(new SNodePointer(myNode));
  }

  private Window getEditorWindow() {
    Component component = this;
    while (!(component instanceof Window) && component != null) {
      component = component.getParent();
    }
    return (Window) component;
  }

}
