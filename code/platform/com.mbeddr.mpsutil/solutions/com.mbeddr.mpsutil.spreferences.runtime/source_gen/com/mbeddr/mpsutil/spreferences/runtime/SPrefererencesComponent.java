package com.mbeddr.mpsutil.spreferences.runtime;

/*Generated by MPS */

import jetbrains.mps.plugins.prefs.BaseProjectPrefsComponent;
import com.mbeddr.mpsutil.spreferences.runtime.plugin.SPreferencesPage;
import org.jdom.Element;
import com.intellij.openapi.project.Project;
import java.util.List;
import jetbrains.mps.plugins.prefs.BasePrefsPage;
import java.util.Collections;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.ide.project.ProjectHelper;
import org.jetbrains.mps.openapi.language.SLanguage;
import jetbrains.mps.util.Reference;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.smodel.SModelOperations;
import java.util.Objects;
import org.jetbrains.mps.openapi.language.SAbstractConcept;

public abstract class SPrefererencesComponent extends BaseProjectPrefsComponent {

  private SPreferencesPage myPage;
  private Element myLoadedModelXml;
  private String myTitle;
  private String myId;
  private SPreferencesModelFactory myModelFactory;

  public SPrefererencesComponent(Project project, String title, String id, SPreferencesModelFactory modelFactory) {
    super(project);
    if (title == null) {
      throw new NullPointerException("title is null");
    }
    myTitle = title;
    myId = id;
    myModelFactory = modelFactory;
  }

  @Override
  protected List<BasePrefsPage> createPages() {
    return Collections.<BasePrefsPage>emptyList();
  }

  @Override
  public List<BasePrefsPage> getPages() {
    if (myPage == null) {
      return Collections.<BasePrefsPage>emptyList();
    } else {
      return Collections.<BasePrefsPage>singletonList(myPage);
    }
  }

  @Nullable
  public Element getState() {
    return myLoadedModelXml;
  }
  public void setState(Element element) {
    myLoadedModelXml = element;
  }
  public void loadState(Element element) {
    myLoadedModelXml = element;
  }

  @Override
  public void init() {
    super.init();
    updatePages();
  }

  @Override
  public void dispose() {
    super.dispose();
    check_p8hy82_a1a91(myPage);
  }

  public void updatePages() {
    boolean enabled = enabled();
    if (enabled) {
      if (myPage == null) {
        myPage = new SPreferencesPage(getProject(), this, myTitle, myId, myModelFactory);
        myPage.register();
      }
    } else {
      if (myPage != null) {
        myPage.dispose();
        myPage = null;
      }
    }
  }

  protected boolean enabled() {
    jetbrains.mps.project.Project mpsProject = ProjectHelper.fromIdeaProject(getProject());
    return isRootConceptLanguageUsed(mpsProject) && enabled(mpsProject);
  }

  protected boolean enabled(jetbrains.mps.project.Project project) {
    return true;
  }

  protected boolean isRootConceptLanguageUsed(final jetbrains.mps.project.Project project) {
    final SLanguage rootConceptLanguage = check_p8hy82_a0a0bb(getRootConcept(), this);
    if (rootConceptLanguage == null) {
      return false;
    }

    //  FIXME consider using finders, e.g.
    //    FindUtils.makeProvider(LanguageModelImportFinder).findResults(GenericHolder(rootConceptLanguage))
    //    there's also LanguageUsagesFinder that finds actual uses instead of imports
    final Reference<Boolean> result = new Reference(false);
    project.getModelAccess().runReadAction(() -> {
      for (SModel model : Sequence.fromIterable(project.getScope().getModels())) {
        for (SLanguage lang : SetSequence.fromSet(SModelOperations.getAllLanguageImports(model))) {
          if (Objects.equals(lang, rootConceptLanguage)) {
            result.set(true);
            return;
          }
        }
      }
    });
    return result.get();
  }

  protected abstract SAbstractConcept getRootConcept();
  private static void check_p8hy82_a1a91(SPreferencesPage checkedDotOperand) {
    if (null != checkedDotOperand) {
      checkedDotOperand.dispose();
    }

  }
  private static SLanguage check_p8hy82_a0a0bb(SAbstractConcept checkedDotOperand, SPrefererencesComponent checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getLanguage();
    }
    return null;
  }
}
