package com.mbeddr.mpsutil.nodediff.plugin;

/*Generated by MPS */

import jetbrains.mps.smodel.SNodePointer;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import com.intellij.openapi.project.Project;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.vcs.diff.ui.StructDifferenceDialog;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SProperty;

public class NodeDiffHelper {

  private static SNodePointer first = null;
  private static SNodePointer second = null;

  public static void markFirstNode(SNode n) {
    first = new SNodePointer(n);
  }

  public static void markSecondNode(SNode n) {
    second = new SNodePointer(n);
  }

  public static boolean hasFirst() {
    return first != null;
  }

  public static boolean isValid(final SNode secondNode) {
    if (secondNode == null || SNodeOperations.getModel(secondNode) == null) {
      return false;
    }
    final SRepository repo = SNodeOperations.getModel(secondNode).getRepository();
    if (repo == null) {
      return false;
    }
    final Wrappers._boolean res = new Wrappers._boolean(true);
    repo.getModelAccess().runReadAction(() -> {
      try {
        SNode n1 = first.resolve(repo);
        SNode n2 = secondNode;
        if (n1 == null || n2 == null) {
          res.value = false;
        } else {
          if (n1 == n2) {
            res.value = false;
          }
          if (SNodeOperations.getParent(n1) != null || SNodeOperations.getParent(n2) != null) {
            if (ListSequence.fromList(SNodeOperations.getNodeAncestors(n1, null, false)).contains(n2)) {
              res.value = false;
            }
            if (ListSequence.fromList(SNodeOperations.getNodeAncestors(n2, null, false)).contains(n1)) {
              res.value = false;
            }
          }
        }
      } catch (Throwable tp) {
        tp.printStackTrace();
      }
    });
    return res.value;
  }

  /**
   * 
   * @deprecated 
   */
  @Deprecated
  public static void diff(Project p) {
    diff(ProjectHelper.fromIdeaProject(p));
  }

  public static void diff(MPSProject mpsProject) {
    SRepository repo = mpsProject.getRepository();
    SNode n1 = first.resolve(repo);
    SNode n2 = second.resolve(repo);
    String s1 = SNodeOperations.getConcept(n1).getName();
    if (SNodeOperations.isInstanceOf(n1, CONCEPTS.INamedConcept$Kd)) {
      s1 += (" " + SPropertyOperations.getString(SNodeOperations.cast(n1, CONCEPTS.INamedConcept$Kd), PROPS.name$MnvL));
    }
    String s2 = SNodeOperations.getConcept(n2).getName();
    if (SNodeOperations.isInstanceOf(n2, CONCEPTS.INamedConcept$Kd)) {
      s2 += (" " + SPropertyOperations.getString(SNodeOperations.cast(n2, CONCEPTS.INamedConcept$Kd), PROPS.name$MnvL));
    }
    StructDifferenceDialog.showNodeDifference(mpsProject.getProject(), n1, n2, s1, s2);
    first = null;
    second = null;
  }


  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept INamedConcept$Kd = MetaAdapterFactory.getInterfaceConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, "jetbrains.mps.lang.core.structure.INamedConcept");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
  }
}
