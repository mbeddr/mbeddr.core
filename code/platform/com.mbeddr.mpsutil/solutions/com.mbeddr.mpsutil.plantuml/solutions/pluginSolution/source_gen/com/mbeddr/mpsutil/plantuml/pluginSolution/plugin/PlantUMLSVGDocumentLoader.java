package com.mbeddr.mpsutil.plantuml.pluginSolution.plugin;

/*Generated by MPS */

import org.apache.batik.swing.svg.SVGDocumentLoader;
import org.apache.batik.util.EventDispatcher;
import org.apache.batik.swing.svg.SVGDocumentLoaderListener;
import org.apache.batik.swing.svg.SVGDocumentLoaderEvent;
import org.apache.batik.bridge.DocumentLoader;
import net.sourceforge.plantuml.SourceStringReader;
import java.io.ByteArrayOutputStream;
import net.sourceforge.plantuml.FileFormatOption;
import net.sourceforge.plantuml.FileFormat;
import java.io.ByteArrayInputStream;
import org.w3c.dom.svg.SVGDocument;
import java.io.InterruptedIOException;

public class PlantUMLSVGDocumentLoader extends SVGDocumentLoader {
  /*package*/ static EventDispatcher.Dispatcher startedDispatcher = new EventDispatcher.Dispatcher() {
    public void dispatch(Object listener, Object event) {
      ((SVGDocumentLoaderListener) listener).documentLoadingStarted((SVGDocumentLoaderEvent) event);
    }
  };
  /*package*/ static EventDispatcher.Dispatcher completedDispatcher = new EventDispatcher.Dispatcher() {
    public void dispatch(Object listener, Object event) {
      ((SVGDocumentLoaderListener) listener).documentLoadingCompleted((SVGDocumentLoaderEvent) event);
    }
  };
  /*package*/ static EventDispatcher.Dispatcher cancelledDispatcher = new EventDispatcher.Dispatcher() {
    public void dispatch(Object listener, Object event) {
      ((SVGDocumentLoaderListener) listener).documentLoadingCancelled((SVGDocumentLoaderEvent) event);
    }
  };
  /*package*/ static EventDispatcher.Dispatcher failedDispatcher = new EventDispatcher.Dispatcher() {
    public void dispatch(Object listener, Object event) {
      ((SVGDocumentLoaderListener) listener).documentLoadingFailed((SVGDocumentLoaderEvent) event);
    }
  };
  private String plantUMLString;
  public PlantUMLSVGDocumentLoader(String url, DocumentLoader loader, String plantUMLString) {
    super(url, loader);
    this.plantUMLString = plantUMLString;
  }
  @Override
  public void run() {
    SVGDocumentLoaderEvent evt = null;
    try {
      ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();
      try {
        Thread.currentThread().setContextClassLoader(this.getClass().getClassLoader());
        evt = new SVGDocumentLoaderEvent(this, null);
        fireEvent(startedDispatcher, evt);
        if (isHalted()) {
          fireEvent(cancelledDispatcher, evt);
          return;
        }

        SourceStringReader reader = new SourceStringReader(plantUMLString);

        ByteArrayOutputStream bos = new ByteArrayOutputStream();
        reader.generateImage(bos, new FileFormatOption(FileFormat.SVG));
        bos.close();

        ByteArrayInputStream is = new ByteArrayInputStream(bos.toByteArray());
        try {
          SVGDocument svgDocument = (SVGDocument) loader.loadDocument(url, is);
          if (isHalted()) {
            fireEvent(cancelledDispatcher, evt);
            return;
          }
          evt = new SVGDocumentLoaderEvent(this, svgDocument);
        } finally {
          is.close();
        }
        fireEvent(completedDispatcher, evt);
      } finally {
        Thread.currentThread().setContextClassLoader(contextClassLoader);
      }
    } catch (InterruptedIOException e) {
      fireEvent(cancelledDispatcher, evt);
    } catch (Exception e) {
      exception = e;
      fireEvent(failedDispatcher, evt);
    } catch (ThreadDeath td) {
      exception = new Exception(td.getMessage());
      fireEvent(failedDispatcher, evt);
      throw td;
    } catch (Throwable t) {
      t.printStackTrace();
      exception = new Exception(t.getMessage());
      fireEvent(failedDispatcher, evt);
    }
  }
}
