package com.mbeddr.mpsutil.plantuml.pluginSolution.plugin;

/*Generated by MPS */

import org.apache.batik.swing.JSVGCanvas;
import org.apache.batik.swing.svg.SVGUserAgent;
import org.w3c.dom.svg.SVGPreserveAspectRatio;
import org.apache.batik.swing.gvt.AbstractPanInteractor;
import java.awt.event.InputEvent;
import java.awt.event.MouseEvent;
import org.apache.batik.swing.svg.GVTTreeBuilderAdapter;
import org.apache.batik.swing.svg.GVTTreeBuilderEvent;
import java.awt.geom.AffineTransform;
import org.w3c.dom.svg.SVGSVGElement;
import org.w3c.dom.svg.SVGRect;
import org.apache.batik.bridge.ViewBox;
import org.apache.batik.util.ParsedURL;
import org.apache.batik.bridge.DocumentLoader;
import java.util.Iterator;
import org.apache.batik.swing.svg.SVGDocumentLoaderListener;

public class PlantUMLSVGCanvas extends JSVGCanvas {

  /**
   * The type of scale
   */
  private short svgScale;
  /**
   * Image padding
   */
  private int svgPadding;


  public PlantUMLSVGCanvas(SVGUserAgent agent, boolean eventsEnabled, boolean selectableText) {
    super(agent, eventsEnabled, selectableText);

    this.svgScale = SVGPreserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMIDYMAX;
    this.svgPadding = 0;
    setEnablePanInteractor(false);
    panInteractor = new AbstractPanInteractor() {
      @Override
      public boolean startInteraction(InputEvent event) {
        int mods = event.getModifiersEx();
        return event.getID() == MouseEvent.MOUSE_PRESSED && (mods & InputEvent.BUTTON1_DOWN_MASK) != 0 && noModifiers(event);
      }
      private boolean noModifiers(InputEvent event) {
        return !(event.isAltDown()) && !(event.isAltGraphDown()) && !(event.isControlDown()) && !(event.isMetaDown()) && !(event.isShiftDown());
      }
    };
    setEnablePanInteractor(true);
    setRecenterOnResize(false);
    setDoubleBufferedRendering(true);
    // rotate to make text visible
    addGVTTreeBuilderListener(new GVTTreeBuilderAdapter() {
      @Override
      public void gvtBuildCompleted(GVTTreeBuilderEvent event) {
        PlantUMLSVGCanvas canvas = PlantUMLSVGCanvas.this;
        AffineTransform rotation = AffineTransform.getRotateInstance(0.001, canvas.getSize().getWidth() / 2, canvas.getHeight() / 2);
        rotation.concatenate(canvas.getRenderingTransform());
        canvas.setRenderingTransform(rotation);
        PlantUMLSVGCanvas.this.updateManager = null;
      }
    });
  }

  @Override
  protected AffineTransform calculateViewingTransform(String svgElementIdentifier, SVGSVGElement svgElement) {
    SVGRect svgElementBounds = svgElement.getBBox();
    float[] svgElementBoundsVector = new float[]{svgElementBounds.getX(), svgElementBounds.getY(), svgElementBounds.getWidth(), svgElementBounds.getHeight()};
    float svgEemenetScaleToHeight = getHeight() - svgPadding;
    float svgElementScaleToWidth = getWidth() - svgPadding;
    return ViewBox.getPreserveAspectRatioTransform(svgElementBoundsVector, svgScale, true, svgElementScaleToWidth, svgEemenetScaleToHeight);
  }
  public void setSvgScale(short svgScale) {
    this.svgScale = svgScale;
  }
  public void setSvgPadding(int svgPadding) {
    this.svgPadding = svgPadding;
  }


  @Override
  public void stopProcessing() {
    super.stopProcessing();
    if (updateManager != null) {
      updateManager.interrupt();
      updateManager = null;
    }
  }
  public void loadPlantUMLDiagram(String url, final String plantUMLString) {
    String oldURI = null;
    if (svgDocument != null) {
      oldURI = svgDocument.getURL();
    }
    final ParsedURL newURI = new ParsedURL(oldURI, url);
    stopThenRun(new Runnable() {
      public void run() {
        String url = newURI.toString();
        fragmentIdentifier = newURI.getRef();
        ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();
        try {
          Thread.currentThread().setContextClassLoader(PlantUMLSVGCanvas.this.getClass().getClassLoader());
          loader = new DocumentLoader(userAgent);
        } finally {
          Thread.currentThread().setContextClassLoader(contextClassLoader);
        }

        nextDocumentLoader = new PlantUMLSVGDocumentLoader(url, loader, plantUMLString);
        nextDocumentLoader.setPriority(Thread.MIN_PRIORITY);
        Iterator<Object> it = svgDocumentLoaderListeners.iterator();
        while (it.hasNext()) {
          nextDocumentLoader.addSVGDocumentLoaderListener((SVGDocumentLoaderListener) it.next());
        }
        startDocumentLoader();
      }
    });
  }
  private void startDocumentLoader() {
    documentLoader = nextDocumentLoader;
    nextDocumentLoader = null;
    documentLoader.start();
  }
}
