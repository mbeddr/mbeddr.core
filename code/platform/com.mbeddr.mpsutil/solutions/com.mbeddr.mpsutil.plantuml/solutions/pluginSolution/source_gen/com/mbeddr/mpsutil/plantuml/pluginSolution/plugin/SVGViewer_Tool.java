package com.mbeddr.mpsutil.plantuml.pluginSolution.plugin;

/*Generated by MPS */

import jetbrains.mps.plugins.tool.GeneratedTool;
import jetbrains.mps.logging.Logger;
import javax.swing.Icon;
import com.intellij.icons.AllIcons;
import jetbrains.mps.project.Project;
import javax.swing.MutableComboBoxModel;
import com.intellij.openapi.wm.ToolWindowAnchor;
import jetbrains.mps.ide.project.ProjectHelper;
import javax.swing.DefaultComboBoxModel;
import org.jetbrains.mps.openapi.model.SNode;
import com.mbeddr.mpsutil.plantuml.node.behavior.VisGraph;
import com.mbeddr.mpsutil.plantuml.node.behavior.IVisualizable__BehaviorDescriptor;
import java.awt.geom.AffineTransform;
import java.awt.Dimension;
import java.io.File;
import java.io.FileOutputStream;
import java.io.OutputStreamWriter;
import org.w3c.dom.svg.SVGDocument;
import org.apache.batik.dom.util.DOMUtilities;
import java.io.IOException;
import javax.swing.JComponent;
import javax.swing.JPanel;
import java.awt.BorderLayout;
import jetbrains.mps.workbench.action.BaseGroup;
import jetbrains.mps.workbench.action.ActionUtils;
import com.intellij.openapi.actionSystem.ActionManager;
import com.intellij.openapi.actionSystem.ActionPlaces;
import org.apache.batik.swing.JSVGScrollPane;

public class SVGViewer_Tool extends GeneratedTool {
  private static final Logger LOG = Logger.getLogger(SVGViewer_Tool.class);
  private static final Icon ICON = AllIcons.FileTypes.Diagram;
  private String SVG_EXTENSION = ".svg";
  private Project project;
  private MutableComboBoxModel<String> categoryModel;
  private AbstractChanceCategoryCallback categoryCallback;
  private PlantUMLSVGCanvas svgCanvas;
  private VisualisationHistory history;
  public SVGViewer_Tool(com.intellij.openapi.project.Project project) {
    super(project, "Visualization", null, ICON, ToolWindowAnchor.RIGHT, false);
  }
  public void init(com.intellij.openapi.project.Project project) {
    super.init(project);
    SVGViewer_Tool.this.project = ProjectHelper.fromIdeaProject(project);
    SVGViewer_Tool.this.categoryModel = new DefaultComboBoxModel<String>();
    SVGViewer_Tool.this.history = new VisualisationHistory(SVGViewer_Tool.this.project.getRepository());

    SVGViewer_Tool.this.categoryCallback = new AbstractChanceCategoryCallback() {
      public void categoryChangedImpl(String newCat) {
        VisualisationHistory.VisualizationHistoryElement current = SVGViewer_Tool.this.history.getCurrent();
        if (current != null && !(newCat.equals(current.getCategory()))) {
          SVGViewer_Tool.this.changeCategory(newCat);
        }
      }
    };
  }
  public void load(SNode node, String category) {
    SVGViewer_Tool.this.history.add(node, category);
    SVGViewer_Tool.this.showHistoryEntry(SVGViewer_Tool.this.history.getCurrent());
  }
  private void changeCategory(String category) {
    SVGViewer_Tool.this.history.add(category);
    SVGViewer_Tool.this.showHistoryEntry(SVGViewer_Tool.this.history.getCurrent());
  }
  public void zoomIn() {
    SVGViewer_Tool.this.zoom(2);
  }
  public void zoomOut() {
    SVGViewer_Tool.this.zoom(0.5);
  }
  public String getLatestPUMLString() {
    VisualisationHistory.VisualizationHistoryElement curr = SVGViewer_Tool.this.history.getCurrent();
    if (curr != null) {
      String cat = curr.getCategory();
      VisGraph graph = new VisGraph();
      IVisualizable__BehaviorDescriptor.getVisualization_id2N1CSrzPN_f.invoke(curr.resolvedNode(), cat, graph);
      return graph.toString();
    }
    return null;
  }
  public void showHistoryEntry(final VisualisationHistory.VisualizationHistoryElement element) {
    if (element == null) {
      return;
    }

    SVGViewer_Tool.this.categoryCallback.setEnabled(false);

    int size = SVGViewer_Tool.this.categoryModel.getSize();
    for (int i = 0; i < size; i++) {
      SVGViewer_Tool.this.categoryModel.removeElementAt(0);
    }
    SVGViewer_Tool.this.project.getRepository().getModelAccess().runReadAction(() -> {
      SNode node = element.resolvedNode();
      for (String cat : IVisualizable__BehaviorDescriptor.getCategories_id2N1CSrzPN_a.invoke(node)) {
        SVGViewer_Tool.this.categoryModel.addElement(cat);
      }
    });
    SVGViewer_Tool.this.categoryModel.setSelectedItem(element.getCategory());

    SVGViewer_Tool.this.categoryCallback.setEnabled(true);

    SVGViewer_Tool.this.project.getRepository().getModelAccess().runReadAction(() -> {
      SNode node = element.resolvedNode();
      VisGraph visualization = new VisGraph();
      IVisualizable__BehaviorDescriptor.getVisualization_id2N1CSrzPN_f.invoke(node, element.getCategory(), visualization);
      SVGViewer_Tool.this.getToolWindow().setTitle(visualization.getTitle());

      if (SVGViewer_Tool.this.svgCanvas != null) {
        String graphAsString = visualization.toString();
        String url = "file://" + System.getProperty("java.io.tmpdir") + "/" + node.getNodeId().toString();
        SVGViewer_Tool.this.svgCanvas.loadPlantUMLDiagram(url, graphAsString);
      }
    });
  }
  public void showCurrentHistoryEntry() {
    SVGViewer_Tool.this.showHistoryEntry(SVGViewer_Tool.this.history.getCurrent());
  }
  private void zoom(double scale) {
    AffineTransform at = AffineTransform.getScaleInstance(scale, scale);
    if (SVGViewer_Tool.this.svgCanvas.getGraphicsNode() == null) {
      return;
    }
    AffineTransform rat = SVGViewer_Tool.this.svgCanvas.getRenderingTransform();
    if (at != null) {
      Dimension dim = SVGViewer_Tool.this.svgCanvas.getSize();
      int x = dim.width / 2;
      int y = dim.height / 2;
      AffineTransform t = AffineTransform.getTranslateInstance(x, y);
      t.concatenate(at);
      t.translate(-x, -y);
      t.concatenate(rat);
      SVGViewer_Tool.this.svgCanvas.setRenderingTransform(t);
    }
  }
  public void saveTo(File destination) {
    File output = (destination.getName().toLowerCase().endsWith(SVGViewer_Tool.this.SVG_EXTENSION) ? destination : new File(destination.getAbsolutePath() + SVGViewer_Tool.this.SVG_EXTENSION));

    FileOutputStream fileOutputStream = null;
    OutputStreamWriter outputStreamWriter = null;

    try {
      SVGDocument svgDocument = SVGViewer_Tool.this.svgCanvas.getSVGDocument();
      fileOutputStream = new FileOutputStream(output);
      outputStreamWriter = new OutputStreamWriter(fileOutputStream, "UTF-8");
      DOMUtilities.writeDocument(svgDocument, outputStreamWriter);
    } catch (Exception e) {
      if (LOG.isErrorLevel()) {
        LOG.error("failed to save SVG document", e);
      }
    } finally {
      try {
        if (outputStreamWriter != null) {
          outputStreamWriter.close();
        }
        if (fileOutputStream != null) {
          fileOutputStream.close();
        }
      } catch (IOException e) {
        if (LOG.isErrorLevel()) {
          LOG.error("failed to close stream", e);
        }
      }
    }
  }
  public boolean hasNext() {
    return SVGViewer_Tool.this.history.hasNext();
  }
  public void next() {
    SVGViewer_Tool.this.showHistoryEntry(SVGViewer_Tool.this.history.next());
  }
  public boolean hasPrevious() {
    return SVGViewer_Tool.this.history.hasPrevious();
  }
  public void previous() {
    SVGViewer_Tool.this.showHistoryEntry(SVGViewer_Tool.this.history.previous());
  }
  public JComponent getComponent() {
    JPanel panel = new JPanel(new BorderLayout());

    BaseGroup group = ActionUtils.getGroup("com.mbeddr.mpsutil.plantuml.pluginSolution.plugin.ToolbarGroup_ActionGroup");
    group.add(new ChangeCategoryAction(SVGViewer_Tool.this.project, SVGViewer_Tool.this.categoryModel, SVGViewer_Tool.this.categoryCallback));
    JComponent toolbar = ActionManager.getInstance().createActionToolbar(ActionPlaces.TOOLBAR, group, true).getComponent();
    panel.add(BorderLayout.NORTH, toolbar);

    SVGViewer_Tool.this.svgCanvas = new PlantUMLSVGCanvas(new MbeddrUserAgent(panel), true, true);
    JSVGScrollPane scroll = new JSVGScrollerWithMouseWheelListener(SVGViewer_Tool.this.svgCanvas);
    panel.add(BorderLayout.CENTER, scroll);

    SVGViewer_Tool.this.showCurrentHistoryEntry();

    return panel;
  }
}
