package com.mbeddr.mpsutil.asynccell.plugin;

/*Generated by MPS */

import jetbrains.mps.nodeEditor.cells.EditorCell_Constant;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import java.util.concurrent.Callable;
import jetbrains.mps.openapi.editor.EditorContext;
import org.jetbrains.mps.openapi.model.SNode;
import javax.swing.SwingUtilities;
import jetbrains.mps.openapi.editor.style.Style;
import jetbrains.mps.nodeEditor.EditorComponent;

public class EditorCell_Async extends EditorCell_Constant {

  private static final List<String> COMPUTING_TEXT = ListSequence.fromListAndArray(new ArrayList<String>(), "[ - ]", "[ \\ ]", "[ | ]", "[ / ]");
  private static String getNextComputingText(int idx) {
    return ListSequence.fromList(COMPUTING_TEXT).getElement(idx % ListSequence.fromList(COMPUTING_TEXT).count());
  }

  private final Callable<AsyncCellValue> _valueCallable;

  private AsyncCellValue _value = null;
  private int _computingTextCtr = 1;

  public EditorCell_Async(EditorContext editorContext, SNode node, Callable<AsyncCellValue> valueCallable) {
    super(editorContext, node, getNextComputingText(0));
    _valueCallable = valueCallable;
  }

  public boolean isAsyncValueUpdateRequired() {
    return _value == null;
  }

  public Callable<AsyncCellValue> getAsyncValueCallable() {
    return _valueCallable;
  }

  public void setAsyncValue(AsyncCellValue value) {
    assert SwingUtilities.isEventDispatchThread();

    _value = value;
    if (_value == null) {
      setTextAndRepaint("<null>");
    } else {
      Style s = value.getStyle();
      if (s != null) {
        getStyle().putAll(s);
      }
      setTextAndRepaint(value.getText());
    }
    requestRelayout();
  }

  /**
   * Turn the spinning wheel.
   */
  public void turnSpinningWheel() {
    assert SwingUtilities.isEventDispatchThread();

    if (_value == null) {
      setTextAndRepaint(getNextComputingText(_computingTextCtr++));
    }
  }

  private void setTextAndRepaint(String value) {
    setText(value);
    EditorComponent ec = this.getEditor();
    if (ec != null && !(ec.isDisposed())) {
      ec.repaint(this);
    }
  }

}
