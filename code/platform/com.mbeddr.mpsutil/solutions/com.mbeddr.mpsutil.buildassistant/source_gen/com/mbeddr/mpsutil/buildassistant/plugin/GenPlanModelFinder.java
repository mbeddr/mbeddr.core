package com.mbeddr.mpsutil.buildassistant.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.module.SRepository;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.generator.CustomGenerationModuleFacet;
import org.jetbrains.mps.openapi.model.SModelReference;
import org.jetbrains.mps.openapi.module.SModuleReference;
import jetbrains.mps.smodel.SModelInternal;
import jetbrains.mps.project.DevKit;

public final class GenPlanModelFinder {
  private final SRepository myRepository;

  public GenPlanModelFinder(@NotNull SRepository repository) {
    myRepository = repository;
  }

  public boolean hasPlan(@NotNull SModel model) {
    return planModelFromCustomFacet(model) != null || planModelFromDevKit(model) != null;
  }
  @Nullable
  private SModel planModelFromCustomFacet(SModel model) {
    final SModule ownerModule = model.getModule();
    CustomGenerationModuleFacet facet = ownerModule.getFacet(CustomGenerationModuleFacet.class);
    if (facet != null) {
      SModelReference planModelRef = facet.getPlanModelReference();
      if (planModelRef != null) {
        return planModelRef.resolve(myRepository);
      }
    }
    return null;
  }
  @Nullable
  private SModel planModelFromDevKit(SModel model) {
    for (SModuleReference dkRef : ((SModelInternal) model).importedDevkits()) {
      final SModule dkModule = dkRef.resolve(myRepository);
      if (!(dkModule instanceof DevKit)) {
        continue;
      }
      final SModelReference dkPlan = ((DevKit) dkModule).getModuleDescriptor().getAssociatedGenPlan();
      if (dkPlan == null) {
        continue;
      }
      final SModel planModel = dkPlan.resolve(myRepository);
      return planModel;
    }
    return null;
  }
  @Nullable
  public SModel getPlanModel(@NotNull SModel model) throws IllegalArgumentException {
    SModel rv = planModelFromCustomFacet(model);
    if (rv != null) {
      return rv;
    }
    rv = planModelFromDevKit(model);
    if (rv != null) {
      return rv;
    }
    return null;
  }
}
