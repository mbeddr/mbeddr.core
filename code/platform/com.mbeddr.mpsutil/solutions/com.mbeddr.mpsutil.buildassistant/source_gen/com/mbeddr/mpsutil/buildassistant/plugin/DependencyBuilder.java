package com.mbeddr.mpsutil.buildassistant.plugin;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import jetbrains.mps.project.Project;
import java.util.Set;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import org.jetbrains.mps.openapi.model.SModel;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import javax.swing.SwingUtilities;
import jetbrains.mps.ide.make.actions.MakeActionImpl;
import jetbrains.mps.ide.make.actions.MakeActionParameters;
import org.jetbrains.mps.openapi.language.SLanguage;
import jetbrains.mps.smodel.SModelOperations;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import jetbrains.mps.lang.smodel.behavior.LanguageIdentity__BehaviorDescriptor;
import jetbrains.mps.lang.modelapi.behavior.ModuleIdentity__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.Generator;
import org.jetbrains.mps.openapi.module.SDependency;
import jetbrains.mps.smodel.Language;
import org.jetbrains.mps.openapi.module.SModuleReference;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;

public class DependencyBuilder {
  private static final Logger LOG = Logger.getLogger(DependencyBuilder.class);

  private Project myProject;
  private Set<SModule> visitedModules = SetSequence.fromSet(new HashSet<SModule>());
  private Set<SModel> visitedModels = SetSequence.fromSet(new HashSet<SModel>());
  private List<SModule> makeOrder = ListSequence.fromList(new ArrayList<SModule>());

  public DependencyBuilder(Project project) {
    myProject = project;
  }

  public void startBuild() {
    startBuild(false);
  }

  public void startRebuild() {
    startBuild(true);
  }

  public void startBuild(final boolean rebuild) {
    for (SModule module : ListSequence.fromList(makeOrder)) {
      System.out.println("make: " + module.getModuleName());
    }
    SwingUtilities.invokeLater(() -> new MakeActionImpl(new MakeActionParameters(myProject).modules(makeOrder).cleanMake(rebuild)).executeAction());
  }

  public DependencyBuilder with(SModel model) {
    try {
      collectDeps_(model);
    } catch (Exception ex) {
      LOG.error("Failed to calculate dependencies for model: " + model.getName(), ex);
    }
    return this;
  }

  public DependencyBuilder with(SModule module) {
    try {
      collectDeps_(module);
    } catch (Exception ex) {
      LOG.error("Failed to calculate dependencies for module: " + module.getModuleName(), ex);
    }
    return this;
  }

  public DependencyBuilder with(SLanguage lang) {
    try {
      collectDeps_(lang);
    } catch (Exception ex) {
      LOG.error("Failed to calculate dependencies for language: " + lang.getQualifiedName(), ex);
    }
    return this;
  }

  protected void collectDepsForCustomGenPlanSafe(SModel model) {
    try {
      collectDepsForCustomGenPlan(model);
    } catch (Exception ex) {
      LOG.error("Failed to calculate dependencies from custom generation plan for model: " + model.getName(), ex);
    }
  }

  protected void collectDeps_(SModel model) {
    if (model == null) {
      return;
    }
    if (SetSequence.fromSet(visitedModels).contains(model)) {
      return;
    }
    SetSequence.fromSet(visitedModels).addElement(model);

    for (SLanguage lang : SetSequence.fromSet(SModelOperations.getAllLanguageImports(model))) {
      with(lang);
    }

    collectDepsForCustomGenPlanSafe(model);
  }

  protected void collectDepsForCustomGenPlan(SModel model) {
    SModel genPlanModel = new GenPlanModelFinder(myProject.getRepository()).getPlanModel(model);
    if (genPlanModel == null) {
      return;
    }
    SNode plan = ListSequence.fromList(jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations.roots(genPlanModel, CONCEPTS.Plan$X1)).first();
    if (plan == null) {
      return;
    }

    collectDeps_(genPlanModel);

    for (SNode langId : ListSequence.fromList(SNodeOperations.getNodeDescendants(plan, CONCEPTS.LanguageId$UR, false, new SAbstractConcept[]{}))) {
      with(LanguageIdentity__BehaviorDescriptor.getLanguage_id34EJa6aIcyj.invoke(langId));
    }
    for (SNode modulePointer : ListSequence.fromList(SNodeOperations.getNodeDescendants(plan, CONCEPTS.ModuleIdentity$2y, false, new SAbstractConcept[]{}))) {
      SModule mod = ModuleIdentity__BehaviorDescriptor.toModuleReference_id1Bs_61$mqDd.invoke(modulePointer).resolve(myProject.getRepository());
      with(mod);
    }
    for (SNode mc : Sequence.fromIterable(SNodeOperations.ofConcept(ListSequence.fromList(SNodeOperations.getNodeDescendants(plan, CONCEPTS.BaseConcept$gP, false, new SAbstractConcept[]{})).translate((it) -> SNodeOperations.getReferences(it)).select((it) -> it.getTargetNode()), CONCEPTS.MappingConfiguration$7j))) {
      with(SNodeOperations.getModel(mc).getModule());
    }
  }

  protected void collectDeps_(SLanguage lang) {
    SModule langModule = lang.getSourceModule();
    with(langModule);
  }

  protected void collectDeps_(SModule module) {
    if (module instanceof Generator) {
      module = ((Generator) module).sourceLanguage().getSourceModuleReference().resolve(myProject.getRepository());
    }
    if (module == null) {
      return;
    }

    if (SetSequence.fromSet(visitedModules).contains(module)) {
      return;
    }
    SetSequence.fromSet(visitedModules).addElement(module);

    for (SDependency dependency : Sequence.fromIterable(module.getDeclaredDependencies())) {
      with(dependency.getTarget());
    }
    for (SLanguage usedLang : SetSequence.fromSet(module.getUsedLanguages())) {
      with(usedLang);
    }

    if (module instanceof Language) {
      Language language = ((Language) module);
      for (SModuleReference runtimeRef : CollectionSequence.fromCollection(language.getRuntimeModulesReferences())) {
        SModule runtime = runtimeRef.resolve(myProject.getRepository());
        with(runtime);
      }

      for (Generator generator : CollectionSequence.fromCollection(language.getGenerators())) {
        for (SDependency dependency : Sequence.fromIterable(generator.getDeclaredDependencies())) {
          with(dependency.getTarget());
        }
        for (SLanguage usedLang : SetSequence.fromSet(generator.getUsedLanguages())) {
          with(usedLang);
        }
      }
    }

    for (SModel model : Sequence.fromIterable(module.getModels())) {
      with(model);
    }

    enqueue(module);
  }

  public void enqueue(SModule module) {
    if (module.isPackaged()) {
      return;
    }

    ListSequence.fromList(makeOrder).addElement(module);
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept Plan$X1 = MetaAdapterFactory.getConcept(0x7ab1a6fa0a114b95L, 0x9e4875f363d6cb00L, 0x19443180a20717fbL, "jetbrains.mps.lang.generator.plan.structure.Plan");
    /*package*/ static final SConcept LanguageId$UR = MetaAdapterFactory.getConcept(0x7866978ea0f04cc7L, 0x81bc4d213d9375e1L, 0x312abca18ab8c8c0L, "jetbrains.mps.lang.smodel.structure.LanguageId");
    /*package*/ static final SInterfaceConcept ModuleIdentity$2y = MetaAdapterFactory.getInterfaceConcept(0x446c26eb2b7b4bf0L, 0x9b35f83fa582753eL, 0x96ca5405afc2bc9L, "jetbrains.mps.lang.modelapi.structure.ModuleIdentity");
    /*package*/ static final SConcept BaseConcept$gP = MetaAdapterFactory.getConcept(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x10802efe25aL, "jetbrains.mps.lang.core.structure.BaseConcept");
    /*package*/ static final SConcept MappingConfiguration$7j = MetaAdapterFactory.getConcept(0xb401a68083254110L, 0x8fd384331ff25befL, 0xff0bea0475L, "jetbrains.mps.lang.generator.structure.MappingConfiguration");
  }
}
