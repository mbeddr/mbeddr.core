package com.mbeddr.mpsutil.nodeaccess.plugin;

/*Generated by MPS */

import jetbrains.mps.ide.httpsupport.runtime.base.HttpRequestHandlerBase;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.project.Project;
import jetbrains.mps.ide.httpsupport.manager.plugin.HttpRequest;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.ide.httpsupport.runtime.base.HttpSupportUtil;
import jetbrains.mps.ide.httpsupport.nodeaccess.plugin.HandlerUtil;
import io.netty.handler.codec.http.HttpResponseStatus;
import io.netty.buffer.Unpooled;
import io.netty.util.CharsetUtil;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import org.jetbrains.mps.openapi.model.SNode;
import de.itemis.mps.utils.serializer.xml.serializer.NodeSerializer;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;

public class NodeAsXMLRequest_RequestHandler extends HttpRequestHandlerBase {
  private SNodeReference ref;
  private Project project;
  private String prefix;
  private Boolean shortForm;

  public NodeAsXMLRequest_RequestHandler(HttpRequest request) {
    super(request);
  }

  @Override
  public boolean init() {
    boolean correctRequest = true;
    {
      String ref_serialized = ListSequence.fromList(this.request.getParameterValue("ref")).getElement(0);
      if (ref_serialized != null) {
        this.ref = PersistenceFacade.getInstance().createNodeReference(ref_serialized);
      } else {
        correctRequest = false;
        this.ref = null;
      }
    }
    {
      String project_serialized = ListSequence.fromList(this.request.getParameterValue("project")).getElement(0);
      if (project_serialized != null) {
        this.project = HttpSupportUtil.getProjectByName(project_serialized);
      } else {
        this.project = HttpSupportUtil.getSomeProject();
      }
    }
    {
      String prefix_serialized = ListSequence.fromList(this.request.getParameterValue("prefix")).getElement(0);
      if (prefix_serialized != null) {
        this.prefix = prefix_serialized;
      } else {
        this.prefix = null;
      }
    }
    {
      String shortForm_serialized = ListSequence.fromList(this.request.getParameterValue("shortForm")).getElement(0);
      if (shortForm_serialized != null) {
        this.shortForm = Boolean_Converter.deserialize(shortForm_serialized);
      } else {
        this.shortForm = null;
      }
    }
    return correctRequest;
  }


  @Override
  public void handle() throws Exception {
    if (this.project == null) {
      String text = HandlerUtil.HEADER_RESPONCE + "No project is available";
      HandlerUtil.showNoProjectIsAvailablePopup();
      this.request.sendResponse(HttpResponseStatus.OK, "text/html", Unpooled.copiedBuffer(text, CharsetUtil.UTF_8));
      return;
    }

    final SRepository repository = this.project.getRepository();

    final Wrappers._T<SNode> resolveNode = new Wrappers._T<SNode>();
    repository.getModelAccess().runReadAction(() -> resolveNode.value = (NodeAsXMLRequest_RequestHandler.this.ref != null ? NodeAsXMLRequest_RequestHandler.this.ref.resolve(repository) : null));
    if ((resolveNode.value != null)) {
      String tagPrefix = this.prefix;

      if (tagPrefix == null) {
        tagPrefix = "";
      }

      boolean shortFormBool = Boolean.TRUE.equals(this.shortForm);
      final NodeSerializer s = new NodeSerializer(resolveNode.value, shortFormBool, tagPrefix);
      final Wrappers._T<String> xmlAsString = new Wrappers._T<String>();
      SNodeOperations.getModel(resolveNode.value).getRepository().getModelAccess().runReadAction(() -> xmlAsString.value = s.getXMLAsString());

      this.request.sendResponse(HttpResponseStatus.OK, "application/xml", Unpooled.copiedBuffer(xmlAsString.value, CharsetUtil.UTF_8));

    } else {
      String text = HandlerUtil.HEADER_RESPONCE + "The requested node has not been found<br><b>Node reference</b>: " + this.ref + "<br><b>Project</b>: " + this.project.getName();
      HandlerUtil.showNodeNotFoundPopup(this.project, this.ref);
      this.request.sendResponse(HttpResponseStatus.OK, "text/html", Unpooled.copiedBuffer(text, CharsetUtil.UTF_8));
    }
  }
}
