package com.mbeddr.mpsutil.nodeaccess.plugin;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import jetbrains.mps.ide.httpsupport.manager.plugin.MPSInternalPortManager;
import jetbrains.mps.project.Project;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.ide.httpsupport.runtime.base.HttpSupportUtil;
import jetbrains.mps.project.ProjectManager;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import org.jetbrains.mps.openapi.model.SModelId;
import org.jetbrains.mps.openapi.model.SNodeId;
import org.jetbrains.mps.openapi.model.SModel;
import com.intellij.openapi.application.ApplicationManager;
import com.intellij.openapi.ui.Messages;
import jetbrains.mps.openapi.navigation.NavigationSupport;
import java.util.concurrent.atomic.AtomicReference;
import org.jetbrains.mps.openapi.module.SRepository;

public class MbeddrURLHelper {
  private static final Logger LOG = Logger.getLogger(MbeddrURLHelper.class);

  public static String URL_PREFIX() {
    return "http://localhost:" + MPSInternalPortManager.getCurrentPort() + "/";
  }
  public static String DEFAULT_PROJECT_NAME() {
    return "DEFAULT";
  }

  /**
   * 
   * @deprecated  use .getURL from the jetbrains.mps.ide.httpsupport language
   */
  @Deprecated
  public static String createURLForNode(final Project project, String application, SNode n) {
    return HttpSupportUtil.getURL(n);
  }

  public static String extractURLFromText(String text) {
    int begin = text.indexOf(URL_PREFIX());
    if (begin < 0) {
      return null;
    }

    String url = text.substring(begin);
    int end = url.indexOf(" ");
    if (end > 0) {
      return text.substring(begin, end);
    }
    return url;
  }

  public static boolean isURL(String text) {
    return extractURLFromText(text) != null;
  }

  public static void openLink(final String projectName, final String modelIDAsString, final String nodeIDAsString) {
    Iterable<Project> allOpenProjects = ProjectManager.getInstance().getOpenedProjects();
    Project project;
    if (projectName.equalsIgnoreCase(DEFAULT_PROJECT_NAME())) {
      project = null;
    } else {
      project = Sequence.fromIterable(allOpenProjects).findFirst((it) -> it.getName().equals(projectName));
    }
    if (project == null) {
      project = Sequence.fromIterable(allOpenProjects).first();
      if (project != null) {
        if (LOG.isWarningLevel()) {
          LOG.warning("cannot open node in project named '" + projectName + "'. Using '" + project.getName() + "' instead.");
        }
      } else {
        if (LOG.isErrorLevel()) {
          LOG.error("No open MPS project available. Unable to open node.");
        }
        return;
      }
    }

    final PersistenceFacade facade = PersistenceFacade.getInstance();
    final SModelId modelID = facade.createModelId(modelIDAsString);
    final SNodeId nodeID = facade.createNodeId(nodeIDAsString);
    final Project fP = project;

    fP.getModelAccess().runWriteInEDT(new Runnable() {
      public void run() {
        SModel model = facade.createModelReference(null, modelID, "can be omitted").resolve(fP.getRepository());
        if (model == null) {
          ApplicationManager.getApplication().invokeLater(() -> Messages.showErrorDialog("Cannot find model with the ID " + modelID + "\nMaybe it is not part of the current project?", "Error"));
          return;
        }
        final SNode resolveNode = model.getNode(nodeID);

        if ((resolveNode == null)) {
          ApplicationManager.getApplication().invokeLater(() -> Messages.showErrorDialog("Cannot find node with the ID " + nodeID + "\nMaybe it is was deleted from the model?", "Error"));
          return;
        }

        if (resolveNode != null) {
          NavigationSupport.getInstance().openNode(fP, resolveNode, true, true);
        }
      }
    });
  }

  public static SModel resolveModelById(final String modelIDAsString) {
    final PersistenceFacade facade = PersistenceFacade.getInstance();
    final SModelId modelID = facade.createModelId(modelIDAsString);

    final AtomicReference<SModel> ref = new AtomicReference<SModel>();

    ProjectManager.getInstance().getOpenedProjects().get(0).getRepository().getModelAccess().runReadAction(() -> {
      SModel model = facade.createModelReference(null, modelID, "").resolve(null);
      ref.set(model);
    });

    return ref.get();
  }

  public static SModel resolveModelByName(final String modelFqName) {

    final AtomicReference<SModel> ref = new AtomicReference<SModel>();

    final SRepository repository = ProjectManager.getInstance().getOpenedProjects().get(0).getRepository();
    repository.getModelAccess().runReadAction(() -> {
      SModel model = PersistenceFacade.getInstance().createModelReference(modelFqName).resolve(repository);
      ref.set(model);
    });

    return ref.get();
  }

  public static SNode resolveNode(final String modelIDAsString, final String nodeIDAsString) {

    final SModel mdl = resolveModelById(modelIDAsString);
    final SNodeId nodeID = PersistenceFacade.getInstance().createNodeId(nodeIDAsString);

    final AtomicReference<SNode> ref = new AtomicReference<SNode>();
    ProjectManager.getInstance().getOpenedProjects().get(0).getRepository().getModelAccess().runReadAction(() -> ref.set(mdl.getNode(nodeID)));
    return ref.get();

  }
}
