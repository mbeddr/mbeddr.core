package com.mbeddr.mpsutil.userstyles.runtime.plugin;

/*Generated by MPS */

import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.smodel.language.LanguageRegistry;
import jetbrains.mps.smodel.language.LanguageRuntime;
import org.jetbrains.annotations.Nullable;
import java.util.Objects;

public class UserStylesDescriptors {
  public static List<IUserStylesDescriptor> findAllDescriptors() {
    final List<IUserStylesDescriptor> result = ListSequence.fromList(new ArrayList<IUserStylesDescriptor>());
    // FIXME please supply ComponentHost/Platform context here!
    LanguageRegistry.getInstance().withAvailableLanguages((LanguageRuntime rt) -> {
      IUserStylesDescriptor descriptor = getDescriptor(rt);
      if (descriptor != null) {
        ListSequence.fromList(result).addElement(descriptor);
      }
    });
    return result;
  }

  public static List<UserStyleItem> getAllUserStyleItems() {
    return ListSequence.fromList(UserStylesDescriptors.findAllDescriptors()).translate((it) -> it.getItems()).toList();
  }

  @Nullable
  public static UserStyleItem getUserStyleItem(final String id) {
    return ListSequence.fromList(getAllUserStyleItems()).findFirst((it) -> Objects.equals(it.getId(), id));
  }

  @Nullable
  private static IUserStylesDescriptor getDescriptor(LanguageRuntime language) {
    if (language == null) {
      return null;
    }
    String descriptorClassName = language.getNamespace() + ".editor." + IUserStylesDescriptor.CLASS_NAME;
    try {
      // FIXME here we imply LanguageRuntime is loaded with module classloader, which is true for present MPS implementation
      //       though might get changed once module runtime story shapes out.
      Class descriptorClass = language.getClass().getClassLoader().loadClass(descriptorClassName);
      IUserStylesDescriptor descriptor = ((IUserStylesDescriptor) descriptorClass.getField(IUserStylesDescriptor.INSTANCE_FIELD_NAME).get(null));
      return descriptor;
    } catch (ClassNotFoundException ex) {
    } catch (NoSuchFieldException e) {
    } catch (IllegalAccessException e) {
    }
    return null;
  }
}
