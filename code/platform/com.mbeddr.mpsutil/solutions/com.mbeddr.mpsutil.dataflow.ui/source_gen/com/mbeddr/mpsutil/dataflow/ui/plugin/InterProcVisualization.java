package com.mbeddr.mpsutil.dataflow.ui.plugin;

/*Generated by MPS */

import jetbrains.mps.ide.dataFlow.presentation.ControlFlowGraph;
import jetbrains.mps.ide.dataFlow.presentation.InstructionWrapper;
import jetbrains.mps.ide.dataFlow.presentation.IProgram;
import jetbrains.mps.ide.dataFlow.presentation.IGraphCreator;
import jetbrains.mps.ide.dataFlow.presentation.IBlock;
import jetbrains.mps.ide.dataFlow.presentation.Line;
import jetbrains.mps.ide.dataFlow.presentation.LineDirection;
import jetbrains.mps.lang.dataFlow.framework.instructions.Instruction;
import com.mbeddr.mpsutil.dataflow.runtime.plugin.FunctionCallInstruction;
import com.mbeddr.mpsutil.dataflow.runtime.plugin.NestedProgramInstruction;
import com.mbeddr.mpsutil.dataflow.runtime.plugin.InterProcEndInstruction;

public class InterProcVisualization extends ControlFlowGraph<InstructionWrapper> {

  public InterProcVisualization(IProgram<InstructionWrapper> program, IGraphCreator<InstructionWrapper> graphCreator) {
    super(program, graphCreator);
  }

  @Override
  protected void addSimpleLine(IBlock source, IBlock target) {
    super.addSimpleLine(source, target, new InterProcLineCreator(source, target));
  }

  @Override
  protected void addAdditionalLine(IBlock source, IBlock target) {
    super.addAdditionalLine(source, target, new InterProcLineCreator(source, target));
  }

  private static final class InterProcLineCreator implements ControlFlowGraph.LineCreator {

    private IInterProcVisualizationNode source;
    private IInterProcVisualizationNode target;

    public InterProcLineCreator(IBlock source, IBlock target) {
      this.source = (IInterProcVisualizationNode) source;
      this.target = (IInterProcVisualizationNode) target;
    }

    @Override
    public Line createLine(int first, int second, int level, LineDirection direction) {
      Instruction sourceInstruction = source.getInstruction();
      Instruction targetInstruction = target.getInstruction();

      if (sourceInstruction instanceof FunctionCallInstruction || sourceInstruction instanceof NestedProgramInstruction || sourceInstruction instanceof InterProcEndInstruction) {
        return new DashedLine(sourceInstruction, targetInstruction, first, second, level, direction);
      } else {
        return new Line(first, second, level, direction);
      }
    }

  }

}
