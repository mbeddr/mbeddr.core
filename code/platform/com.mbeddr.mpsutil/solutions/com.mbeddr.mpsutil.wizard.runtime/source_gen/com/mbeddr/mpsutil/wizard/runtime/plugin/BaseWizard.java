package com.mbeddr.mpsutil.wizard.runtime.plugin;

/*Generated by MPS */

import com.intellij.ide.wizard.AbstractWizardEx;
import java.util.List;
import com.intellij.openapi.util.AsyncResult;
import com.intellij.ide.wizard.AbstractWizardStepEx;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.structure.ExtensionPoint;
import com.mbeddr.mpsutil.common.util.ApplicationHelper;
import com.intellij.openapi.application.ex.ApplicationManagerEx;
import com.intellij.openapi.progress.ProgressIndicator;
import com.intellij.openapi.progress.ProgressManager;
import jetbrains.mps.progress.ProgressMonitorAdapter;
import org.jetbrains.mps.openapi.util.ProgressMonitor;

public abstract class BaseWizard<TResult> extends AbstractWizardEx {
  private List<BaseProcessStep<TResult>> mSteps;
  private TResult result_data;
  private final AsyncResult<TResult> async_result;
  private String myId;
  private boolean isInputReady = false;
  public BaseWizard(String titel, String id, TResult result, List<BaseProcessStep<TResult>> steps) {
    super(titel, null, applyExtension(id, steps));
    this.result_data = result;
    this.myId = id;
    async_result = new AsyncResult<TResult>();
  }

  private static List<? extends AbstractWizardStepEx> applyExtension(final String myId, List<? extends AbstractWizardStepEx> originalSteps) {
    List<AbstractWizardStepEx> result = ListSequence.fromList(originalSteps).select((it) -> ((AbstractWizardStepEx) it)).toList();

    Iterable<IWizardExtension> myExtensions = Sequence.fromIterable(new ExtensionPoint<ExtensionProvider>("com.mbeddr.mpsutil.wizard.runtime.wizardExtensions").getObjects()).translate((it) -> it.getExtensions()).where((it) -> it.forWizard().equals(myId));

    for (IWizardExtension ext : Sequence.fromIterable(myExtensions)) {
      result = ext.apply(result);
    }
    return result;
  }

  protected void setInputReady(boolean isInputReady) {
    this.isInputReady = isInputReady;
  }

  @Override
  protected void init() {
    List<AbstractWizardStepEx> list = mySteps;
    mSteps = ListSequence.fromList(list).select((it) -> ((BaseProcessStep<TResult>) it)).toList();
    ListSequence.fromList(mSteps).visitAll((it) -> it.setWizard(BaseWizard.this));
    super.init();
  }

  public BaseProcessStep<TResult> getStep(final String id) {
    return ListSequence.fromList(mSteps).findFirst((it) -> it.getStepId().equals(id));
  }
  @Override
  protected void updateStep() {
    if (isInputReady) {
      super.updateStep();
      BaseProcessStep<TResult> currentStep = ListSequence.fromList(mSteps).getElement(getCurrentStep());
      currentStep.updateUI();
    }
  }
  public BaseProcessStep<TResult> getNextStep(BaseProcessStep<TResult> current) {
    int i = ListSequence.fromList(mSteps).indexOf(current);

    if (i == -1) {
      return null;
    }

    BaseProcessStep<TResult> val = ListSequence.fromList(mSteps).skip(i + 1).findFirst((it) -> it.isApplicable());
    return val;
  }
  public BaseProcessStep<TResult> getPrevStep(BaseProcessStep<TResult> current) {
    int i = ListSequence.fromList(mSteps).indexOf(current);

    if (i == -1) {
      return null;
    }

    BaseProcessStep<TResult> val = ListSequence.fromList(mSteps).headListSequence(i).reversedList().findFirst((it) -> it.isApplicable());

    return val;
  }
  public void validate() {
    this.updateButtons();
  }
  public void finish() {
    if (!(isOK())) {
      this.async_result.setRejected();
      return;
    }
    ApplicationHelper.runWithProgressAsync(ApplicationManagerEx.getApplicationEx(), new Runnable() {
      public void run() {
        ProgressIndicator pi = ProgressManager.getInstance().getProgressIndicator();
        ProgressMonitorAdapter adapter = new ProgressMonitorAdapter(pi);
        adapter.start(BaseWizard.this.getTitle(), ListSequence.fromList(mSteps).count());
        for (BaseProcessStep<TResult> step : ListSequence.fromList(BaseWizard.this.mSteps)) {
          ProgressMonitor subTask = adapter.subTask(0);
          String title = (step != null ? step.getTitle() : "");
          if (title == null) {
            title = "";
          }
          subTask.start(title, 1);
          TResult executeResult = step.execute(BaseWizard.this.result_data, subTask);
          if (executeResult != null) {
            BaseWizard.this.result_data = executeResult;
          }
          adapter.advance(1);
        }
        adapter.done();
        BaseWizard.this.async_result.setDone(BaseWizard.this.result_data);
      }
    }, this.getTitle(), false, null);
  }
  public AsyncResult<TResult> getResult() {
    return this.async_result;
  }
  @Override
  public void doCancelAction() {
    super.doCancelAction();
    this.async_result.setRejected();
  }
  public TResult finishAndGetResult() {
    finish();
    return getResult().getResultSync();
  }

  public TResult ShowFinishAndGetResult() {
    boolean showAndGet = showAndGet();
    if (showAndGet) {
      finish();
      return getResult().getResultSync();
    }
    return null;
  }
  public String getId() {
    return myId;
  }
}
