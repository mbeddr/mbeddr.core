package com.mbeddr.mpsutil.smodule.runtime.lib;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import org.jetbrains.mps.openapi.model.SModel;
import java.util.List;
import jetbrains.mps.project.DevKit;
import jetbrains.mps.smodel.ModelImports;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.mps.openapi.language.SLanguage;
import jetbrains.mps.project.AbstractModule;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.NotNullWhereFilter;
import org.jetbrains.mps.openapi.persistence.ModelFactoryType;
import org.jetbrains.mps.openapi.module.SRepository;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.project.ProjectManager;
import java.util.Objects;
import jetbrains.mps.persistence.PreinstalledModelFactoryTypes;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.util.Reference;
import jetbrains.mps.ide.ThreadUtils;
import org.jetbrains.mps.openapi.persistence.ModelRoot;
import org.jetbrains.mps.openapi.model.EditableSModel;
import jetbrains.mps.persistence.DefaultModelRoot;
import org.jetbrains.mps.openapi.model.SModelName;
import jetbrains.mps.persistence.ModelCannotBeCreatedException;
import jetbrains.mps.project.Solution;
import jetbrains.mps.project.MPSProject;
import java.io.File;
import jetbrains.mps.project.modules.SolutionProducer;
import java.util.concurrent.CompletableFuture;

public class ModelHelper {
  private static final Logger LOG = Logger.getLogger(ModelHelper.class);
  public static SModel addDevkits(SModel model, List<DevKit> kits) {
    ModelImports mi = new ModelImports(model);
    for (DevKit kit : ListSequence.fromList(kits)) {
      mi.addUsedDevKit(kit.getModuleReference());
    }
    return model;
  }
  public static SModel addLanguages(SModel model, List<SLanguage> langs) {
    for (SLanguage lang : ListSequence.fromList(langs)) {
      addLanguage(model, lang);
    }
    return model;
  }
  public static SModel addLanguage(SModel model, SLanguage lang) {
    new ModelImports(model).addUsedLanguage(lang);
    return model;
  }

  public static SModel addDependency(SModel model, List<SModel> models) {
    ModelImports mi = new ModelImports(model);
    for (SModel m : ListSequence.fromList(models)) {
      mi.addModelImport(m.getReference());
      ((AbstractModule) model.getModule()).addDependency(m.getModule().getModuleReference(), false);
    }
    return model;
  }
  public static Iterable<Language> getLanguages(final SModel model) {
    return Sequence.fromIterable(((Iterable<SLanguage>) new ModelImports(model).getUsedLanguages())).select((it) -> it.getSourceModuleReference()).where(new NotNullWhereFilter()).select((it) -> it.resolve(model.getRepository())).ofType(Language.class);
  }

  /**
   * As GlobalModelAccess has no idea how to run commands we need to provide a project repository.
   * 
   * For not breaking all of the existing usages we for now try to get the project repository from
   * the opened projects.
   * 
   * New implementations should use the createModel() that takes a repository as parameter.
   * 
   * @see com.mbeddr.mpsutil.smodule.runtime.lib.ModelHelper#createModel(AbstractModule, ModelFactoryType, String, List<DevKit>, List<SLanguage>, List<SModel>, SRepository) 
   * @deprecated 
   */
  @Deprecated
  @Nullable
  public static SModel createModel(AbstractModule module, String storageType, final String name, final List<DevKit> devkits, final List<SLanguage> languages, final List<SModel> dependencies) {
    SRepository repository = ProjectManager.getInstance().getOpenedProjects().get(0).getRepository();
    ModelFactoryType type;
    if (Objects.equals(storageType, "mps")) {
      type = PreinstalledModelFactoryTypes.PLAIN_XML;
    } else if (Objects.equals(storageType, "model")) {
      type = PreinstalledModelFactoryTypes.PER_ROOT_XML;
    } else {
      throw new RuntimeException("unknown storage type: " + storageType);
    }
    return createModel(module, type, name, devkits, languages, dependencies, repository);
  }
  /**
   * As GlobalModelAccess has no idea how to run commands we need to provide a project repository.
   * 
   * For not breaking all of the existing usages we for now try to get the project repository from
   * the opened projects.
   * 
   * New implementations should use the createModel() that takes a repository as parameter.
   * 
   * @see com.mbeddr.mpsutil.smodule.runtime.lib.ModelHelper#createModel(AbstractModule, ModelFactoryType, String, List<DevKit>, List<SLanguage>, List<SModel>, SRepository) 
   * @deprecated 
   */
  @Deprecated
  @Nullable
  public static SModel createModel(AbstractModule module, ModelFactoryType storageType, final String name, final List<DevKit> devkits, final List<SLanguage> languages, final List<SModel> dependencies) {
    SRepository repository = ProjectManager.getInstance().getOpenedProjects().get(0).getRepository();
    return createModel(module, storageType, name, devkits, languages, dependencies, repository);
  }

  @Nullable
  public static SModel createModel(@NotNull final AbstractModule module, @NotNull final ModelFactoryType type, @NotNull final String name, @NotNull final List<DevKit> devkits, @NotNull final List<SLanguage> languages, @NotNull final List<SModel> dependencies, @NotNull final SRepository repository) {

    final Reference<SModel> res = new Reference<SModel>();
    Exception e = ThreadUtils.runInUIThreadAndWait(() -> {
      repository.getModelAccess().executeCommand(new Runnable() {
        public void run() {
          final ModelRoot mr = ModelHelper.getRoot4NewModels(module);
          EditableSModel model = null;
          try {
            if (mr instanceof DefaultModelRoot) {
              model = (EditableSModel) ((DefaultModelRoot) mr).createModel(new SModelName(name), null, null, type);
            } else {
              model = (EditableSModel) mr.createModel(name);
            }
            // XXX decide if you need model imports contributed through ModelsAutoImportsManager
          } catch (ModelCannotBeCreatedException e) {
            if (LOG.isErrorLevel()) {
              LOG.error("", e);
            }
          }

          if (model == null) {
            throw new RuntimeException("Can't create model");
          }
          ModelImports mi = new ModelImports(model);
          for (DevKit kit : ListSequence.fromList(devkits)) {
            mi.addUsedDevKit(kit.getModuleReference());
          }
          for (SLanguage lang : ListSequence.fromList(languages)) {
            mi.addUsedLanguage(lang);
          }
          for (SModel dep : ListSequence.fromList(dependencies)) {
            mi.addModelImport(dep.getReference());
          }
          // XXX code like new MissingDependenciesFixer(model).fixModuleDependencies() may help to get module
          //     dependencies match model imports.
          res.set(model);
        }
      });
    });
    if (e != null) {
      throw new RuntimeException(e);
    }

    return res.get();
  }
  private static ModelRoot getRoot4NewModels(AbstractModule module) {
    for (ModelRoot mr : module.getModelRoots()) {
      if (mr.canCreateModels()) {
        return mr;
      }
    }
    return null;
  }


  /**
   * Creates a new solution, might dispatch to EDT thread if not started in EDT. Will block until operation in EDT
   * is complete.
   */
  public static Solution createSolution(final MPSProject project, final String name, final String subdirectory) {
    final String rootPath = project.getProjectFile().getAbsolutePath() + File.separator + subdirectory + File.separator + name;

    return createSolution(project, name, new File(rootPath));
  }
  /**
   * Creates a new solution, might dispatch to EDT thread if not started in EDT. Will block until operation in EDT
   * is complete.
   */
  public static Solution createSolution(final MPSProject project, final String name, final File path) {
    final SolutionProducer sp = new SolutionProducer(project);
    final CompletableFuture<Solution> result = new CompletableFuture<>();
    Runnable rr = new Runnable() {
      public void run() {
        try {
          result.complete(sp.create(name, project.getFileSystem().getFile(path)));
        } catch (RuntimeException t) {
          result.completeExceptionally(t);
        }
      }
    };
    if (ThreadUtils.isInEDT()) {
      project.getModelAccess().runWriteAction(rr);
    } else {
      project.getModelAccess().runWriteInEDT(rr);
    }
    try {
      return result.get();
    } catch (Exception ex) {
      if (LOG.isErrorLevel()) {
        LOG.error("creating solution failed", ex.getCause());
      }
      return null;
    }
  }

}
