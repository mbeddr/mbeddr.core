package com.mbeddr.mpsutil.multilingual.common.runtime.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import java.util.Locale;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.mbeddr.mpsutil.multilingual.common.behavior.Language__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import org.jetbrains.mps.openapi.module.SRepository;
import java.util.List;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPointerOperations;
import jetbrains.mps.smodel.SNodePointer;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.Objects;
import org.jetbrains.mps.openapi.language.SProperty;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class MultilingualLanguageProvider {
  private static MultilingualLanguageProvider instance;

  private SNode currentLanguage;

  private MultilingualLanguageProvider() {
  }

  public static MultilingualLanguageProvider getInstance() {
    if (instance == null) {
      instance = new MultilingualLanguageProvider();
    }

    return instance;
  }

  public SNode getCurrentLanguage() {
    return currentLanguage;
  }

  public Locale getCurrentLanguageLocale() {
    final Wrappers._T<Locale> result = new Wrappers._T<Locale>();
    SNodeOperations.getModel(getCurrentLanguage()).getRepository().getModelAccess().runReadAction(() -> result.value = Language__BehaviorDescriptor.toLocale_id5Q1XZgMGEow.invoke(getCurrentLanguage()));
    return result.value;
  }

  public void setCurrentLanguage(SNode currentLanguage) {
    this.currentLanguage = currentLanguage;
    Locale.setDefault(MultilingualCommonUtil.findLocale(SPropertyOperations.getString(currentLanguage, PROPS.languageCode$o_oz), SPropertyOperations.getString(currentLanguage, PROPS.countryCode$oEyT)));
  }

  public void setCurrentLanguage(SRepository repository, Locale locale) {
    this.setCurrentLanguage(repository, locale.getLanguage(), locale.getCountry());
  }

  public void setCurrentLanguage(SRepository repository, String languageCode, String countryCode) {
    this.setCurrentLanguage(this.findLanguageForCodes(repository, languageCode, countryCode));
  }

  public SNode findLanguageForCodes(SRepository repository, final String languageCode, final String countryCode) {
    SNode result = null;
    List<SNode> languages = SLinkOperations.getChildren(SPointerOperations.resolveNode(new SNodePointer("r:28cd7e84-4784-462c-804c-1dae92004ef9(com.mbeddr.mpsutil.multilingual.common.languageRegistry)", "2510545900186942258"), repository), LINKS.languages$oFFz);
    if (countryCode == null) {
      result = ListSequence.fromList(languages).findFirst((it) -> Objects.equals(languageCode, SPropertyOperations.getString(it, PROPS.languageCode$o_oz)) && isEmptyString(SPropertyOperations.getString(it, PROPS.countryCode$oEyT)));
    }
    if ((result == null)) {
      result = ListSequence.fromList(languages).findFirst((it) -> Objects.equals(languageCode, SPropertyOperations.getString(it, PROPS.languageCode$o_oz)) && Objects.equals(countryCode, SPropertyOperations.getString(it, PROPS.countryCode$oEyT)));
    }
    if ((result == null)) {
      result = ListSequence.fromList(languages).findFirst((it) -> Objects.equals(languageCode, SPropertyOperations.getString(it, PROPS.languageCode$o_oz)));
    }
    return result;
  }
  private static boolean isEmptyString(String str) {
    return str == null || str.isEmpty();
  }

  private static final class PROPS {
    /*package*/ static final SProperty languageCode$o_oz = MetaAdapterFactory.getProperty(0x23f985f2965f4af1L, 0xaee8a32677429514L, 0x7e347dff5959facL, 0x7e347dff5959fadL, "languageCode");
    /*package*/ static final SProperty countryCode$oEyT = MetaAdapterFactory.getProperty(0x23f985f2965f4af1L, 0xaee8a32677429514L, 0x7e347dff5959facL, 0x7e347dff5959faeL, "countryCode");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink languages$oFFz = MetaAdapterFactory.getContainmentLink(0x23f985f2965f4af1L, 0xaee8a32677429514L, 0x7e347dff5959fb1L, 0x7e347dff5959fb2L, "languages");
  }
}
