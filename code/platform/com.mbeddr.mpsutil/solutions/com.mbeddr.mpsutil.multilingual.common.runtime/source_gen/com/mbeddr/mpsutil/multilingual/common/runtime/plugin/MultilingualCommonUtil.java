package com.mbeddr.mpsutil.multilingual.common.runtime.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.apache.commons.lang3.StringUtils;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import org.apache.commons.lang3.text.WordUtils;
import com.mbeddr.mpsutil.multilingual.common.behavior.MessageKey__BehaviorDescriptor;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import java.util.Objects;
import jetbrains.mps.internal.collections.runtime.IterableUtils;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.ResourceBundle;
import java.util.MissingResourceException;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import com.mbeddr.mpsutil.multilingual.common.behavior.ResourceBundle__BehaviorDescriptor;
import com.mbeddr.mpsutil.multilingual.common.behavior.Language__BehaviorDescriptor;
import java.util.Locale;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class MultilingualCommonUtil {
  public static SNode findResourceBundleNode(SModel referenceModel) {
    return ListSequence.fromList(SModelOperations.rootsIncludingImported(referenceModel, CONCEPTS.ResourceBundle$PN)).first();
  }

  public static SNode createKey(String text) {
    SNode key = SConceptOperations.createNewNode(MetaAdapterFactory.getConcept(0x23f985f2965f4af1L, 0xaee8a32677429514L, 0x7e347dff5959fd6L, "com.mbeddr.mpsutil.multilingual.common.structure.MessageKey"));
    if (!(StringUtils.isAlphanumeric(text))) {
      SPropertyOperations.assign(key, PROPS.name$MnvL, StringUtils.deleteWhitespace(WordUtils.capitalizeFully(StringUtils.replacePattern(text, "[^A-Za-z0-9]", " "))));

      if (!(MultilingualCommonUtil.startsWithUpperCase(text))) {
        SPropertyOperations.assign(key, PROPS.name$MnvL, StringUtils.uncapitalize(SPropertyOperations.getString(key, PROPS.name$MnvL)));
      }

      if (!(text.equals(MessageKey__BehaviorDescriptor.deductDefault_idvzhXZPAXZu.invoke(key)))) {
        SPropertyOperations.assign(key, PROPS.default$p9e4, text);
      }
    } else {
      SPropertyOperations.assign(key, PROPS.name$MnvL, text);
    }

    return key;
  }

  public static SNode findOrCreateKey(String text, SModel referenceModel) {
    final SNode createdKey = MultilingualCommonUtil.createKey(text);
    SNode resourceBundleNode = MultilingualCommonUtil.findResourceBundleNode(referenceModel);

    SNode existingKey = ListSequence.fromList(SLinkOperations.getChildren(resourceBundleNode, LINKS.keys$pac4)).findFirst((it) -> Objects.equals(SPropertyOperations.getString(it, PROPS.default$p9e4), SPropertyOperations.getString(createdKey, PROPS.default$p9e4)));

    if ((existingKey != null)) {
      return existingKey;
    } else {
      ListSequence.fromList(SLinkOperations.getChildren(resourceBundleNode, LINKS.keys$pac4)).addElement(createdKey);
      return createdKey;
    }
  }

  public static String deductDefaultText(String key) {
    String result = WordUtils.uncapitalize(IterableUtils.join(Sequence.fromIterable(Sequence.fromArray(StringUtils.splitByCharacterTypeCamelCase(key))).where((it) -> StringUtils.isNotBlank(it)), " "));

    if (MultilingualCommonUtil.startsWithUpperCase(key)) {
      return StringUtils.capitalize(result);
    } else {
      return result;
    }
  }

  protected static boolean startsWithUpperCase(String text) {
    return StringUtils.isAllUpperCase(StringUtils.substring(text, 0, 1));
  }

  public static String retrieveTranslation(String key, String defaultValue, ResourceBundle resourceBundle) {
    if (key == null || resourceBundle == null) {
      return defaultValue;
    }
    try {
      return resourceBundle.getString(key);
    } catch (MissingResourceException e) {
      return defaultValue;
    }
  }

  public static String retrieveFormattedTranslation(String key, String formattedDefaultValue, ResourceBundle resourceBundle, Object... parameters) {
    if (key == null || resourceBundle == null) {
      return String.format(formattedDefaultValue, parameters);
    }
    try {
      return String.format(resourceBundle.getString(key), parameters);
    } catch (MissingResourceException e) {
      return String.format(formattedDefaultValue, parameters);
    }
  }

  public static String retrieveTranslation(SNode messageKey) {
    SNode resourceBundleNode = findResourceBundleNode(SNodeOperations.getModel(messageKey));
    if (resourceBundleNode != null) {
      MultilingualResourceBundleProvider provider = ResourceBundle__BehaviorDescriptor.getResourceBundleProvider_id5Q1XZgMFUWw.invoke(resourceBundleNode);
      if (provider != null) {
        ResourceBundle resourceBundle = provider.getResourceBundle(Language__BehaviorDescriptor.toLocale_id5Q1XZgMGEow.invoke(MultilingualLanguageProvider.getInstance().getCurrentLanguage()));
        return retrieveTranslation(MessageKey__BehaviorDescriptor.getKey_idvzhXZPAXYT.invoke(messageKey), SPropertyOperations.getString(messageKey, PROPS.default$p9e4), resourceBundle);
      }
    }

    return SPropertyOperations.getString(messageKey, PROPS.default$p9e4);
  }

  public static String retrieveFormattedTranslation(SNode messageKey, Object... parameters) {
    SNode resourceBundleNode = findResourceBundleNode(SNodeOperations.getModel(messageKey));
    if (resourceBundleNode != null) {
      MultilingualResourceBundleProvider provider = ResourceBundle__BehaviorDescriptor.getResourceBundleProvider_id5Q1XZgMFUWw.invoke(resourceBundleNode);
      if (provider != null) {
        ResourceBundle resourceBundle = provider.getResourceBundle(Language__BehaviorDescriptor.toLocale_id5Q1XZgMGEow.invoke(MultilingualLanguageProvider.getInstance().getCurrentLanguage()));
        return retrieveFormattedTranslation(MessageKey__BehaviorDescriptor.getKey_idvzhXZPAXYT.invoke(messageKey), SPropertyOperations.getString(messageKey, PROPS.default$p9e4), resourceBundle, parameters);
      }
    }

    return String.format(SPropertyOperations.getString(messageKey, PROPS.default$p9e4), parameters);
  }

  public static Locale findLocale(final String languageCode, final String countryCode) {
    Iterable<Locale> availableLocalesInLanguage = Sequence.fromIterable(Sequence.fromArray(Locale.getAvailableLocales())).where((it) -> Objects.equals(it.getLanguage(), languageCode)).sort((it) -> ((isEmptyString(it.getVariant()) ? 0 : 1)) + ((isEmptyString(it.getScript()) ? 0 : 2)), true);

    // Try finding the exact match first
    Locale ret = Sequence.fromIterable(availableLocalesInLanguage).findFirst((it) -> (countryCode == null && isEmptyString(it.getCountry())) || Objects.equals(it.getCountry(), countryCode));

    if (ret == null && countryCode == null) {
      // Use the first one if no country code was given and no Locale was found without a country code
      ret = Sequence.fromIterable(availableLocalesInLanguage).first();
    }

    return ret;
  }
  private static boolean isEmptyString(String str) {
    return str == null || str.isEmpty();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept ResourceBundle$PN = MetaAdapterFactory.getConcept(0x23f985f2965f4af1L, 0xaee8a32677429514L, 0x7e347dff5959fdaL, "com.mbeddr.mpsutil.multilingual.common.structure.ResourceBundle");
  }

  private static final class PROPS {
    /*package*/ static final SProperty name$MnvL = MetaAdapterFactory.getProperty(0xceab519525ea4f22L, 0x9b92103b95ca8c0cL, 0x110396eaaa4L, 0x110396ec041L, "name");
    /*package*/ static final SProperty default$p9e4 = MetaAdapterFactory.getProperty(0x23f985f2965f4af1L, 0xaee8a32677429514L, 0x7e347dff5959fd6L, 0x7e347dff5959fd8L, "default");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink keys$pac4 = MetaAdapterFactory.getContainmentLink(0x23f985f2965f4af1L, 0xaee8a32677429514L, 0x7e347dff5959fdaL, 0x7e347dff5959fdcL, "keys");
  }
}
