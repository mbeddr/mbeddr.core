package com.mbeddr.mpsutil.contextactions.runtime;

/*Generated by MPS */

import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.openapi.editor.EditorContext;
import java.util.Collections;
import jetbrains.mps.intentions.IntentionsManager;
import java.util.List;
import jetbrains.mps.util.Pair;
import jetbrains.mps.openapi.intentions.IntentionExecutable;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import javax.swing.Icon;
import com.intellij.icons.AllIcons;
import jetbrains.mps.openapi.editor.EditorComponent;

public class IntentionActionSource extends AbstractActionSource {

  private Set<String> myIntentionsIds;

  public IntentionActionSource(String[] intentionIds) {
    myIntentionsIds = SetSequence.fromSetWithValues(new HashSet<String>(), Sequence.fromArray(intentionIds));
  }

  protected Set<String> getIntentionIds() {
    return myIntentionsIds;
  }

  @Override
  public Iterable<IContextAction> getActions(final IContext context) {
    final SNode snode = context.getSNode();
    final EditorContext editorContext = check_e9syr2_a0b0h(context.getEditorComponent());
    if (snode == null || editorContext == null) {
      return Sequence.fromIterable(Collections.<IContextAction>emptyList());
    }

    IntentionsManager.QueryDescriptor queryDescriptor = new IntentionsManager.QueryDescriptor();
    queryDescriptor.setEnabledOnly(true);
    queryDescriptor.setCurrentNodeOnly(false);
    queryDescriptor.setSurroundWith(false);

    List<Pair<IntentionExecutable, SNode>> intentions = ListSequence.fromList(new ArrayList<Pair<IntentionExecutable, SNode>>());
    ListSequence.fromList(intentions).addSequence(CollectionSequence.fromCollection(IntentionsManager.getInstance().getAvailableIntentions(queryDescriptor, snode, editorContext)));
    queryDescriptor.setSurroundWith(true);
    ListSequence.fromList(intentions).addSequence(CollectionSequence.fromCollection(IntentionsManager.getInstance().getAvailableIntentions(queryDescriptor, snode, editorContext)));

    final Set<String> intentionIds = getIntentionIds();
    return ListSequence.fromList(intentions).where((it) -> {
      String key = it.o1.getDescriptor().getPersistentStateKey();
      return SetSequence.fromSet(intentionIds).contains(key);
    }).select((it) -> {
      IntentionAdapter intentionAdapter = new IntentionAdapter(it.o1, it.o2, editorContext);
      String folder = getFolder(intentionAdapter, context);
      Icon icon = getIcon(intentionAdapter, context);
      IContextAction action = new IntentionAction(it.o1, it.o2, folder, context, icon, getLabel(intentionAdapter, context));
      return action;
    });
  }

  protected String getFolder(IIntention intention, IContext context) {
    return null;
  }

  protected Icon getIcon(IIntention intention, IContext context) {
    return AllIcons.Actions.IntentionBulb;
  }

  protected String getLabel(IIntention intention, IContext context) {
    return intention.getText();
  }
  private static EditorContext check_e9syr2_a0b0h(EditorComponent checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getEditorContext();
    }
    return null;
  }
}
