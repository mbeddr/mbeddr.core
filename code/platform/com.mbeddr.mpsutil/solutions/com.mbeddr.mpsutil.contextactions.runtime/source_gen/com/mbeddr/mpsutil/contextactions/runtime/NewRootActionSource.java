package com.mbeddr.mpsutil.contextactions.runtime;

/*Generated by MPS */

import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.model.SModel;
import java.util.Collections;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.constraints.ConstraintsCanBeFacade;
import jetbrains.mps.core.aspects.constraints.rules.kinds.CanBeRootContext;
import org.jetbrains.mps.openapi.language.SLanguage;
import jetbrains.mps.smodel.SModelOperations;
import org.jetbrains.annotations.NotNull;
import java.util.List;
import org.jetbrains.mps.openapi.model.EditableSModel;
import jetbrains.mps.smodel.SModelStereotype;

public class NewRootActionSource extends AbstractActionSource implements IContextActionSource {

  public NewRootActionSource() {
  }

  protected Iterable<SAbstractConcept> findRootConcepts(IContext context) {
    final SModel model = context.getModel();
    if (model == null) {
      return Collections.emptyList();
    }
    if (!(isCreateAllowed(model))) {
      return Collections.emptyList();
    }

    Iterable<SAbstractConcept> concepts = Sequence.fromIterable(getConceptsFromLanguages(context)).concat(Sequence.fromIterable(getAdditionalConcepts(context)));
    return Sequence.fromIterable(concepts).where((it) -> ConstraintsCanBeFacade.checkCanBeRoot(new CanBeRootContext(it, model)).isEmpty());
  }

  protected Iterable<SAbstractConcept> getAdditionalConcepts(IContext context) {
    return Sequence.fromIterable(Collections.<SAbstractConcept>emptyList());
  }

  protected Iterable<SAbstractConcept> getConceptsFromLanguages(IContext context) {
    return Sequence.fromIterable(getLanguages(context)).translate((it) -> it.getConcepts());
  }

  protected Iterable<SLanguage> getLanguages(IContext context) {
    return SModelOperations.getAllLanguageImports(context.getModel());
  }

  @Override
  public Iterable<IContextAction> getActions(IContext context) {
    SModel model = context.getModel();
    if (model == null) {
      return Collections.emptyList();
    }

    final String folder = getFolder(context);
    Iterable<SAbstractConcept> rootConcepts = findRootConcepts(context);
    Iterable<IContextAction> result = Sequence.fromIterable(rootConcepts).select((it) -> {
      return ((IContextAction) new NewRootContextAction(it) {
        @Override
        @NotNull
        public List<String> getFolders(IContext context) {
          return (folder == null ? super.getFolders(context) : Collections.singletonList(folder));
        }
      });
    });
    return result;
  }

  public String getFolder(IContext context) {
    return null;
  }

  protected boolean isCreateAllowed(SModel model) {
    if (!(model instanceof EditableSModel)) {
      return false;
    }
    if (model.isReadOnly()) {
      return false;
    }
    if (SModelStereotype.isStubModel(model)) {
      return false;
    }
    return true;
  }
}
