package com.mbeddr.mpsutil.contextactions.runtime;

/*Generated by MPS */

import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.smodel.action.NodeFactoryManager;
import jetbrains.mps.ide.projectPane.CreateNodeExtension;
import jetbrains.mps.ide.projectPane.CreateRootFilterEP;
import jetbrains.mps.smodel.SModelInternal;
import org.jetbrains.mps.openapi.language.SLanguage;
import jetbrains.mps.ide.projectPane.NewRootNodeAction;
import org.jetbrains.annotations.NotNull;
import java.util.List;
import java.util.Collections;
import javax.swing.Icon;
import jetbrains.mps.ide.icons.GlobalIconManager;
import org.jetbrains.annotations.Nullable;

public class NewRootContextAction extends AbstractContextAction implements IContextAction {
  private SAbstractConcept myRootConcept;

  public NewRootContextAction(SAbstractConcept rootConcept) {
    myRootConcept = rootConcept;
  }

  @Override
  public void execute(IContext context) {
    final SModel model = context.getModel();
    if (model == null) {
      return;
    }
    final Wrappers._T<SNode> newNode = new Wrappers._T<SNode>(null);
    context.getProject().getRepository().getModelAccess().executeCommand(() -> {
      newNode.value = NodeFactoryManager.createNode(myRootConcept, null, null, model);
      model.addRootNode(newNode.value);
      for (CreateNodeExtension ext : CreateRootFilterEP.getInstance().getCreateNodeExtensions()) {
        if (ext.isApplicable(model)) {
          ext.setupRoot(newNode.value);
        }
      }
      if (model instanceof SModelInternal) {
        SLanguage requiredLanguage = newNode.value.getConcept().getLanguage();
        ((SModelInternal) model).addLanguage(requiredLanguage);
      }
    });
    if (newNode.value != null) {
      NewRootNodeAction.trySelectInCurrentPane(context.getProject(), newNode.value);
    }
  }

  @Override
  @NotNull
  public List<String> getFolders(IContext context) {
    return Collections.emptyList();
  }

  @Override
  public Icon getIcon(IContext context) {
    return GlobalIconManager.getInstance().getIconFor(myRootConcept);
  }

  @Override
  @NotNull
  public String getLabel(IContext context) {
    return myRootConcept.getName();
  }

  @NotNull
  public ContextActionId getId() {
    return new ContextActionId(myRootConcept.getQualifiedName());
  }

  @Nullable
  @Override
  public String getTooltip(IContext context) {
    return "Create new root: " + getLabel(context);
  }

}
