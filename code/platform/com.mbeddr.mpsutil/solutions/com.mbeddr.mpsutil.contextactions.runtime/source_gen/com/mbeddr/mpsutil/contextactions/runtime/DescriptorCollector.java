package com.mbeddr.mpsutil.contextactions.runtime;

/*Generated by MPS */

import jetbrains.mps.classloading.DeployListener;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.LinkedHashSet;
import jetbrains.mps.classloading.ClassLoaderManager;
import jetbrains.mps.smodel.MPSModuleRepository;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.module.ReloadableModule;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.List;
import java.util.ArrayList;
import de.slisson.mps.reflection.runtime.ReflectionUtil;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import java.util.Objects;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;

public abstract class DescriptorCollector<E> implements DeployListener {

  private Class<E> myDescriptorType;
  private String myDescriptorClassName;
  private Set<E> myLoadedDescriptors = SetSequence.fromSet(new LinkedHashSet<E>());
  private String[] myModelNames;
  private boolean myIsDisposed = false;

  public DescriptorCollector(Class<E> descriptorType, String descriptorClassName, String[] modelNames) {
    myDescriptorClassName = descriptorClassName;
    myDescriptorType = descriptorType;
    myModelNames = modelNames;
  }

  public DescriptorCollector(Class<E> descriptorType, String descriptorClassName) {
    this(descriptorType, descriptorClassName, new String[]{"plugin"});
  }

  public void start() {
    ClassLoaderManager.getInstance().addListener(this);
    MPSModuleRepository.getInstance().getModelAccess().runReadAction(() -> {
      for (SModule module : Sequence.fromIterable(MPSModuleRepository.getInstance().getModules())) {
        if (module instanceof ReloadableModule) {
          loadModule((ReloadableModule) module);
        }
      }
    });
  }

  public void dispose() {
    if (myIsDisposed) {
      return;
    }
    ClassLoaderManager.getInstance().removeListener(this);
    for (E descriptor : SetSequence.fromSet(myLoadedDescriptors)) {
      unloadDescriptor(descriptor);
    }
    SetSequence.fromSet(myLoadedDescriptors).clear();
    myIsDisposed = true;
  }

  protected void loadModule(ReloadableModule module) {
    for (E descriptor : ListSequence.fromList(getDescriptors(module))) {
      loadDescriptor(descriptor);
      SetSequence.fromSet(myLoadedDescriptors).addElement(descriptor);
    }
  }

  protected void unloadModule(ReloadableModule module) {
    for (E descriptor : ListSequence.fromList(getDescriptors(module))) {
      unloadDescriptor(descriptor);
      SetSequence.fromSet(myLoadedDescriptors).removeElement(descriptor);
    }
  }

  protected List<Class<E>> getDescriptorClasses(ReloadableModule module) {
    List<Class<E>> descriptors = ListSequence.fromList(new ArrayList<Class<E>>());
    for (String modelName : myModelNames) {
      String className = module.getModuleName() + "." + modelName + "." + myDescriptorClassName;
      try {
        ListSequence.fromList(descriptors).addElement((Class<E>) module.getOwnClass(className));
      } catch (Exception e) {
      }
    }
    return descriptors;
  }

  protected List<E> getDescriptors(ReloadableModule module) {
    List<E> descriptors = ListSequence.fromList(new ArrayList<E>());
    for (Class<E> descriptorClass : ListSequence.fromList(getDescriptorClasses(module))) {
      ListSequence.fromList(descriptors).addElement((E) ReflectionUtil.readField(descriptorClass, null, "INSTANCE"));
    }
    return descriptors;
  }

  public abstract void loadDescriptor(E descriptor);
  public abstract void unloadDescriptor(E descriptor);
  @Override
  public void onLoaded(@NotNull Set<ReloadableModule> modules, @NotNull ProgressMonitor monitor) {
    for (ReloadableModule module : SetSequence.fromSet(modules)) {
      loadModule(module);
    }
  }
  @Override
  public void onUnloaded(@NotNull Set<ReloadableModule> unloadedModules, @NotNull ProgressMonitor monitor) {
    for (ReloadableModule module : SetSequence.fromSet(unloadedModules)) {
      if (Objects.equals(module.getModuleReference(), PersistenceFacade.getInstance().createModuleReference("28583149-5b6e-4663-9c02-b9a8fa3cb099(com.mbeddr.mpsutil.contextactions.runtime)"))) {
        dispose();
        return;
      }
      unloadModule(module);
    }
  }
}
