package com.mbeddr.mpsutil.targetchooser;

/*Generated by MPS */

import jetbrains.mps.ide.ui.tree.module.ProjectLanguageTreeNode;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.project.Project;
import de.slisson.mps.reflection.runtime.ReflectionUtil;
import jetbrains.mps.smodel.LanguageAspect;
import org.jetbrains.mps.openapi.model.SModel;
import java.util.List;
import jetbrains.mps.ide.ui.tree.TextTreeNode;
import jetbrains.mps.ide.ui.tree.module.AccessoriesModelTreeNode;
import jetbrains.mps.ide.ui.tree.SortUtil;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.ide.ui.tree.smodel.SModelReferenceTreeNode;
import jetbrains.mps.smodel.Generator;
import jetbrains.mps.ide.ui.tree.MPSTreeNode;
import jetbrains.mps.ide.ui.tree.module.SModelGroupTreeNode;
import com.intellij.icons.AllIcons;

public class TargetChooser_ProjectLanguageTreeNode extends ProjectLanguageTreeNode {
  private TargetChooser_SModelsSubtree mySubtreeFactory;

  public TargetChooser_ProjectLanguageTreeNode(@NotNull Language language, Project project, boolean shortNameOnly, TargetChooser_SModelsSubtree subtreeFactory) {
    super(language, project, shortNameOnly);
    mySubtreeFactory = subtreeFactory;
    init2();
  }

  @Override
  public void init() {
  }

  protected void init2() {
    populate();
    ReflectionUtil.writeField(ProjectLanguageTreeNode.class, ((ProjectLanguageTreeNode) this), "myInitialized", true);
  }

  protected void populate() {
    TargetChooserScope modelFilter = mySubtreeFactory.getOptions().getScope();

    // language aspect
    for (LanguageAspect aspect : LanguageAspect.values()) {
      SModel model = aspect.get(getModule());
      if (model != null && modelFilter.showModel(model)) {
        add(new TargetChooser_SModelTreeNode(model, null, false, mySubtreeFactory.getOptions().getScope()));
      }
    }
    // language accessory models
    List<SModel> accessoryModels = TargetChooserUtil.applyFilter(modelFilter, getModule().getAccessoryModels());
    if (accessoryModels.size() > 0) {
      TextTreeNode accessories = new AccessoriesModelTreeNode(this);
      List<SModel> sortedModels = SortUtil.sortModels(accessoryModels);
      for (SModel model : sortedModels) {
        SModule m = model.getModule();
        boolean currentModule = m == null || m == getModule();
        if (!(currentModule)) {
          accessories.add(new SModelReferenceTreeNode(model, mySubtreeFactory.getProject()));
        } else {
          accessories.add(new TargetChooser_SModelTreeNode(model, null, mySubtreeFactory.getOptions().getScope()));
        }
      }
      this.add(accessories);
    }
    for (Generator generator : getModule().getGenerators()) {
      MPSTreeNode generatorNode = new TargetChooser_GeneratorTreeNode(generator, mySubtreeFactory.getProject(), mySubtreeFactory);
      add(generatorNode);
    }
    // We don't need the runtime modules here
    List<SModel> utilModels = TargetChooserUtil.applyFilter(modelFilter, getModule().getUtilModels());
    if (utilModels.size() > 0) {
      TextTreeNode utilModelsNode = new SModelGroupTreeNode();
      mySubtreeFactory.create(utilModelsNode, getModule(), utilModels, false);
      this.add(utilModelsNode);
    }
    TextTreeNode allModels = new AllModelsTreeNode2();
    allModels.setIcon(AllIcons.Nodes.ModuleGroup);
    mySubtreeFactory.create(allModels, getModule());
    add(allModels);
  }

  public class AllModelsTreeNode2 extends TextTreeNode {
    public AllModelsTreeNode2() {
      super("all models");
    }
  }

}
