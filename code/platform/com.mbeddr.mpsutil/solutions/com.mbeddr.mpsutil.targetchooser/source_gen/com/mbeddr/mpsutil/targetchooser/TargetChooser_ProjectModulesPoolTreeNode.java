package com.mbeddr.mpsutil.targetchooser;

/*Generated by MPS */

import jetbrains.mps.ide.ui.tree.module.ProjectModulesPoolTreeNode;
import jetbrains.mps.project.Project;
import de.slisson.mps.reflection.runtime.ReflectionUtil;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.FilteredGlobalScope;
import jetbrains.mps.ide.ui.tree.TextTreeNode;
import jetbrains.mps.project.Solution;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.project.DevKit;
import jetbrains.mps.ide.ui.tree.module.DefaultNamespaceTreeBuilder;
import jetbrains.mps.ide.ui.tree.module.ProjectModuleTreeNode;
import jetbrains.mps.smodel.Generator;
import jetbrains.mps.util.NameUtil;

public class TargetChooser_ProjectModulesPoolTreeNode extends ProjectModulesPoolTreeNode {
  private final Project myProject;
  private final TargetChooser_SModelsSubtree mySubtreeFactory;

  public TargetChooser_ProjectModulesPoolTreeNode(Project project, TargetChooser_SModelsSubtree subtreeFactory) {
    super(project);
    myProject = project;
    mySubtreeFactory = subtreeFactory;
    init2();
  }

  @Override
  public void init() {
  }

  protected void init2() {
    populate();
    // XXX why not own field and override isInitialized()?
    ReflectionUtil.writeField(ProjectModulesPoolTreeNode.class, ((ProjectModulesPoolTreeNode) this), "myInitialized", true);
  }

  protected void populate() {
    Iterable<SModule> modules = new FilteredGlobalScope(myProject.getRepository()).getModules();
    {
      ModulePoolNamespaceBuilder builder = new ModulePoolNamespaceBuilder();
      TextTreeNode solutions = new TextTreeNode("Solutions");
      for (SModule s : modules) {
        if (s instanceof Solution) {
          builder.addNode(mySubtreeFactory.createProjectModuleTreeNode(s, true));
        }
      }
      builder.fillNode(solutions);
      add(solutions);
    }
    {
      ModulePoolNamespaceBuilder builder = new ModulePoolNamespaceBuilder();
      TextTreeNode languages = new TextTreeNode("Languages");
      for (SModule m : modules) {
        if (Language.class.isInstance(m)) {
          builder.addNode(mySubtreeFactory.createProjectModuleTreeNode(m, true));
        }
      }
      builder.fillNode(languages);
      add(languages);
    }
    {
      ModulePoolNamespaceBuilder builder = new ModulePoolNamespaceBuilder();
      TextTreeNode devkits = new TextTreeNode("DevKits");
      for (SModule m : modules) {
        if (DevKit.class.isInstance(m)) {
          builder.addNode(mySubtreeFactory.createProjectModuleTreeNode(m, true));
        }
      }
      builder.fillNode(devkits);
      add(devkits);
    }
  }

  private class ModulePoolNamespaceBuilder extends DefaultNamespaceTreeBuilder<ProjectModuleTreeNode> {
    @Override
    protected String getNamespace(ProjectModuleTreeNode node) {
      String fqName = node.getModule().getModuleName();
      if (node.getModule() instanceof Generator && fqName.indexOf('#') > 0) {
        fqName = fqName.substring(0, fqName.indexOf('#'));
      }
      return NameUtil.namespaceFromLongName(fqName);
    }
  }
}
