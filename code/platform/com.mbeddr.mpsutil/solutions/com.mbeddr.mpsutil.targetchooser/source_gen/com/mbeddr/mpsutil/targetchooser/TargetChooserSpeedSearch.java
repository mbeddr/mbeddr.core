package com.mbeddr.mpsutil.targetchooser;

/*Generated by MPS */

import com.intellij.ui.SpeedSearchBase;
import java.util.List;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.lang.core.behavior.BaseConcept__BehaviorDescriptor;
import jetbrains.mps.ide.ui.tree.smodel.SNodeTreeNode;
import java.util.Arrays;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.mps.openapi.module.SModule;
import javax.swing.tree.TreeNode;
import jetbrains.mps.ide.ui.tree.module.ProjectModuleTreeNode;
import jetbrains.mps.ide.ui.tree.smodel.SModelTreeNode;
import jetbrains.mps.ide.ui.tree.TreeScrollingUtil;
import javax.swing.tree.TreePath;
import javax.swing.JComponent;
import com.intellij.ui.speedSearch.SpeedSearchSupply;
import java.awt.event.KeyListener;
import de.slisson.mps.reflection.runtime.ReflectionUtil;
import java.awt.event.FocusListener;
import com.intellij.util.ui.UIUtil;
import com.intellij.openapi.actionSystem.AnAction;

public class TargetChooserSpeedSearch extends SpeedSearchBase {
  public static final int ELEMENTS_LIMIT = 10000;

  private LevelInfo levelInfo = new LevelInfo();

  protected TargetChooserSpeedSearch(TargetChooser_ProjectTree tree) {
    super(tree);
  }

  @Override
  public TargetChooser_ProjectTree getComponent() {
    return (TargetChooser_ProjectTree) super.getComponent();
  }

  protected Object[] getAllElements() {
    TargetChooser_ProjectTree tree = getComponent();
    final TargetChooserScope scope = tree.getOptions().getScope();

    List<SNode> roots;
    List<SNode> allNodes = ListSequence.fromList(new ArrayList<SNode>());
    do {
      roots = Sequence.fromIterable(scope.getModules(tree.getProject())).translate((it) -> it.getModels()).translate((it) -> scope.getRootNodes(it)).toList();
      ListSequence.fromList(allNodes).clear();
      if (levelInfo.deeperLevelAllowed(0)) {
        for (SNode root : ListSequence.fromList(roots)) {
          getNodeAndDescendants(root, scope, 1, levelInfo, allNodes);
        }
        if (ListSequence.fromList(allNodes).count() <= ELEMENTS_LIMIT) {
          break;
        }
      } else {
        allNodes = roots;
        break;
      }
      levelInfo.decreaseLimit();
    } while (true);

    return ListSequence.fromList(allNodes).toGenericArray(SNode.class);
  }

  private void getNodeAndDescendants(final SNode node, final TargetChooserScope scope, int currentLevel, final LevelInfo levelInfo, List<SNode> result) {
    levelInfo.levelReached(currentLevel);

    if (ListSequence.fromList(result).count() > ELEMENTS_LIMIT) {
      return;
    }

    ListSequence.fromList(result).addElement(node);
    if (levelInfo.deeperLevelAllowed(currentLevel)) {
      Iterable<SNode> children = scope.getChildNodes(node);
      for (SNode child : Sequence.fromIterable(scope.getChildNodes(node))) {
        getNodeAndDescendants(child, scope, currentLevel + 1, levelInfo, result);
      }
    }
  }

  @Nullable
  protected String getElementText(Object element) {
    return (String) BaseConcept__BehaviorDescriptor.getPresentation_idhEwIMiw.invoke(((SNode) element));
  }

  protected int getSelectedIndex() {
    Object selectedTreeNode = check_6x4g7m_a0a0o(getComponent().getSelectionPath(), this);
    if (selectedTreeNode instanceof SNodeTreeNode) {
      SNode selectedSNode = ((SNodeTreeNode) selectedTreeNode).getSNode();
      return Arrays.asList(getAllElements()).indexOf(selectedSNode);
    }

    return 0;
  }

  protected void selectElement(Object element, String selectedText) {
    final SNode snode = ((SNode) element);
    final Set<SNode> ancestors = SetSequence.fromSetWithValues(new HashSet<SNode>(), SNodeOperations.getNodeAncestors(snode, null, false));
    final SModel model = SNodeOperations.getModel(snode);
    final SModule module = model.getModule();
    getComponent().visit((TreeNode treeNode) -> {
      if (treeNode instanceof ProjectModuleTreeNode) {
        ProjectModuleTreeNode moduleTreeNode = ((ProjectModuleTreeNode) treeNode);
        if (moduleTreeNode.getModule() == module) {
          moduleTreeNode.init();
        }
      }
      if (treeNode instanceof SModelTreeNode) {
        SModelTreeNode modelTreeNode = ((SModelTreeNode) treeNode);
        if (modelTreeNode.getModel() == model) {
          modelTreeNode.init();
        }
      }
      if (treeNode instanceof SNodeTreeNode) {
        SNodeTreeNode snodeTreeNode = ((SNodeTreeNode) treeNode);
        if (SetSequence.fromSet(ancestors).contains(snodeTreeNode.getSNode())) {
          snodeTreeNode.init();
        }

        if (snodeTreeNode.getSNode() == snode) {
          TreeScrollingUtil.selectPath(getComponent(), buildPath(snodeTreeNode));
          return false;
        }
      }

      return true;
    });
  }

  private TreePath buildPath(TreeNode element) {
    List<Object> elements = ListSequence.fromList(new ArrayList<Object>());
    for (TreeNode current = element; current != null; current = current.getParent()) {
      ListSequence.fromList(elements).addElement(current);
    }
    return new TreePath(ListSequence.fromList(elements).reversedList().toGenericArray(Object.class));
  }

  public static void install(TargetChooser_ProjectTree tree) {
    uninstallExistingSpeedSearch(tree);
    new TargetChooserSpeedSearch(tree);
  }

  public static void uninstallExistingSpeedSearch(JComponent component) {
    SpeedSearchSupply existing = SpeedSearchSupply.getSupply(component, true);

    for (KeyListener l : component.getKeyListeners()) {
      try {
        Object speedSearch = ReflectionUtil.readField(l.getClass(), l, "this$0");
        if (speedSearch == existing) {
          component.removeKeyListener(l);
          break;
        }
      } catch (Exception ex) {
      }
    }
    for (FocusListener l : component.getFocusListeners()) {
      try {
        Object speedSearch = ReflectionUtil.readField(l.getClass(), l, "this$0");
        if (speedSearch == existing) {
          component.removeFocusListener(l);
          break;
        }
      } catch (Exception ex) {
      }
    }

    UIUtil.getClientProperty(component, AnAction.ACTIONS_KEY).clear();
  }

  protected class LevelInfo {
    private int limit = Integer.MAX_VALUE;
    private int deepest = 0;

    protected void levelReached(int level) {
      deepest = Math.max(deepest, level);
    }

    protected boolean deeperLevelAllowed(int level) {
      return level < limit;
    }

    protected void decreaseLimit() {
      if (limit > deepest) {
        limit = deepest;
      }
      limit--;
    }
  }
  private static Object check_6x4g7m_a0a0o(TreePath checkedDotOperand, TargetChooserSpeedSearch checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getLastPathComponent();
    }
    return null;
  }
}
