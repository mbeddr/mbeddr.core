package com.mbeddr.mpsutil.targetchooser;

/*Generated by MPS */

import jetbrains.mps.ide.ui.tree.smodel.SModelTreeNode;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.ide.ui.tree.smodel.SNodeTreeNode;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.util.Condition;
import de.slisson.mps.reflection.runtime.ReflectionUtil;
import java.util.Map;
import jetbrains.mps.ide.ui.tree.smodel.PackageNode;
import java.util.List;
import jetbrains.mps.ide.ui.tree.smodel.SNodeGroupTreeNode;
import javax.swing.tree.DefaultTreeModel;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.util.SNodePresentationComparator;
import jetbrains.mps.ide.ui.tree.MPSTreeNodeEx;
import jetbrains.mps.ide.ui.tree.MPSTreeNode;

public class TargetChooser_SModelTreeNode extends SModelTreeNode {

  private TargetChooserScope myScope;

  public TargetChooser_SModelTreeNode(SModel modelDescriptor, String label_UNUSED, boolean showLongName, TargetChooserScope scope, int countNamePart_UNUSED) {
    super(modelDescriptor, (showLongName ? new SModelTreeNode.LongModelNameText() : new SModelTreeNode.ShortModelNameText()));
    myScope = scope;
  }

  public TargetChooser_SModelTreeNode(SModel modelDescriptor, String label, boolean showLongName, TargetChooserScope scope) {
    this(modelDescriptor, label, showLongName, scope, 0);
  }

  public TargetChooser_SModelTreeNode(SModel modelDescriptor, String label, TargetChooserScope scope, int countNamePart) {
    this(modelDescriptor, label, true, scope, countNamePart);
  }

  public TargetChooser_SModelTreeNode(SModel modelDescriptor, String label, TargetChooserScope scope) {
    this(modelDescriptor, label, scope, 0);
  }

  @NotNull
  @Override
  public SNodeTreeNode createSNodeTreeNode(SNode node, String role, Condition<SNode> condition) {
    return new TargetChooser_SNodeTreeNode(node, role, myScope);
  }

  @Override
  protected void doInit() {
    try {
      ReflectionUtil.writeField(SModelTreeNode.class, ((SModelTreeNode) this), "myInitializing", true);
      removeAllChildren();
      ((Map<String, PackageNode>) ReflectionUtil.readField(SModelTreeNode.class, ((SModelTreeNode) this), "myPackageNodes")).clear();
      ((List<SNodeGroupTreeNode>) ReflectionUtil.readField(SModelTreeNode.class, ((SModelTreeNode) this), "myRootGroups")).clear();
      for (SModelTreeNode newChildModel : ((List<SModelTreeNode>) ReflectionUtil.readField(SModelTreeNode.class, ((SModelTreeNode) this), "myChildModelTreeNodes"))) {
        DefaultTreeModel treeModel = (DefaultTreeModel) getTree().getModel();
        int index = ((List<SModelTreeNode>) ReflectionUtil.readField(SModelTreeNode.class, ((SModelTreeNode) this), "myChildModelTreeNodes")).indexOf(newChildModel);
        treeModel.insertNodeInto(newChildModel, this, index);
      }
      SModel model = getModel();
      List<SNode> sortedRoots = new ArrayList<SNode>(Sequence.fromIterable(myScope.getRootNodes(model)).toList());
      sortedRoots.sort(new SNodePresentationComparator());
      for (SNode sortedRoot : sortedRoots) {
        MPSTreeNodeEx treeNode = createSNodeTreeNode(sortedRoot, new InvalidSNodeCondition());
        MPSTreeNode group = getNodeGroupFor(sortedRoot);
        if (group != null) {
          group.add(treeNode);
        } else {
          add(treeNode);
        }
      }
      DefaultTreeModel treeModel = (DefaultTreeModel) getTree().getModel();
      treeModel.nodeStructureChanged(this);
    } finally {
      ReflectionUtil.writeField(SModelTreeNode.class, ((SModelTreeNode) this), "myInitialized", true);
      ReflectionUtil.writeField(SModelTreeNode.class, ((SModelTreeNode) this), "myInitializing", false);
    }
  }

}
