package com.mbeddr.mpsutil.targetchooser;

/*Generated by MPS */

import jetbrains.mps.ide.projectPane.logicalview.ProjectTree;
import jetbrains.mps.project.Project;
import de.slisson.mps.reflection.runtime.ReflectionUtil;
import java.awt.event.KeyEvent;
import jetbrains.mps.ide.ui.tree.MPSTreeNode;
import jetbrains.mps.ide.ui.tree.TextTreeNode;
import jetbrains.mps.ide.ui.tree.module.ProjectTreeNode;
import java.util.List;
import java.util.ArrayList;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.ide.ui.tree.module.ProjectModulesPoolTreeNode;
import javax.swing.tree.TreeNode;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.ide.ui.tree.module.DefaultNamespaceTreeBuilder;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.ide.ui.tree.module.ProjectModuleTreeNode;
import jetbrains.mps.RuntimeFlags;
import jetbrains.mps.TestMode;

public class TargetChooser_ProjectTree extends ProjectTree {
  private Project myProject = ((Project) ReflectionUtil.readField(ProjectTree.class, ((ProjectTree) this), "myProject"));
  private TargetChooser_SModelsSubtree mySubtreeFactory;
  private TargetChooserOptions myOptions;

  public TargetChooser_ProjectTree(Project project, final TargetChooserOptions options) {
    super(project);
    myOptions = options;
    mySubtreeFactory = new TargetChooser_SModelsSubtree(project, options);
    TargetChooserSpeedSearch.install(this);
  }

  public TargetChooserOptions getOptions() {
    return myOptions;
  }

  @Override
  public void processKeyEvent(KeyEvent event) {
    super.processKeyEvent(event);
  }

  @Override
  protected MPSTreeNode rebuild() {
    if (myProject == null || myProject.isDisposed()) {
      return new TextTreeNode("Empty");
    }
    MPSTreeNode root = new TextTreeNode("Empty");
    ProjectTreeNode projectRoot = new ProjectTreeNode(myProject);
    setRootVisible(false);
    List<MPSTreeNode> moduleNodes = new ArrayList<MPSTreeNode>();
    for (SModule module : Sequence.fromIterable(myOptions.getScope().getModules(myProject))) {
      moduleNodes.add(mySubtreeFactory.createProjectModuleTreeNode(module));
    }
    ModulesNamespaceTreeBuilder builder = new ModulesNamespaceTreeBuilder(myProject);
    for (MPSTreeNode mtn : moduleNodes) {
      builder.addNode(mtn);
    }
    builder.fillNode(projectRoot);
    ReflectionUtil.writeField(ProjectTree.class, ((ProjectTree) this), "myModulesPoolTreeNode", new TargetChooser_ProjectModulesPoolTreeNode(myProject, mySubtreeFactory));
    root.add(projectRoot);
    if (myOptions.isShowModulesPool()) {
      root.add(((ProjectModulesPoolTreeNode) ReflectionUtil.readField(ProjectTree.class, ((ProjectTree) this), "myModulesPoolTreeNode")));
    }

    // Transient models are not allowed as a target

    ReflectionUtil.writeField(ProjectTree.class, ((ProjectTree) this), "myProjectTreeNode", projectRoot);
    return root;
  }

  protected boolean visit(TreeNode root, _FunctionTypes._return_P1_E0<? extends Boolean, ? super TreeNode> visitor) {
    if (!(visitor.invoke(root))) {
      return false;
    }
    for (int i = 0; i < root.getChildCount(); i++) {
      TreeNode child = root.getChildAt(i);
      if (!(visit(child, visitor))) {
        return false;
      }
    }
    return true;
  }

  public void visit(_FunctionTypes._return_P1_E0<? extends Boolean, ? super TreeNode> visitor) {
    visit(getRootNode(), visitor);
  }

  private static class ModulesNamespaceTreeBuilder extends DefaultNamespaceTreeBuilder {
    private MPSProject myProject;
    protected ModulesNamespaceTreeBuilder(Project project) {
      myProject = (MPSProject) project;
    }
    @Override
    protected String getNamespace(MPSTreeNode node) {
      String folder = null;
      if (node instanceof ProjectModuleTreeNode) {
        ProjectModuleTreeNode pmtn = (ProjectModuleTreeNode) node;
        folder = myProject.getVirtualFolder(pmtn.getModule());
      }
      if (folder != null) {
        return folder;
      }
      return "";
    }
  }

  public Project getProject() {
    return myProject;
  }

  @Override
  public void runRebuildAction(Runnable rebuildAction, boolean saveExpansion) {
    // make it work in unit tests
    if (RuntimeFlags.isTestMode()) {
      TestMode wasTestMode = RuntimeFlags.getTestMode();
      try {
        RuntimeFlags.setTestMode(TestMode.NONE);
        super.runRebuildAction(rebuildAction, saveExpansion);
      } finally {
        RuntimeFlags.setTestMode(wasTestMode);
      }
    } else {
      super.runRebuildAction(rebuildAction, saveExpansion);
    }
  }
}
