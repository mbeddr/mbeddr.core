package com.mbeddr.mpsutil.targetchooser;

/*Generated by MPS */

import com.intellij.ui.components.JBScrollPane;
import jetbrains.mps.ide.platform.refactoring.ModelElementTargetChooser;
import com.intellij.openapi.Disposable;
import jetbrains.mps.ide.projectPane.logicalview.ProjectTreeFindHelper;
import com.intellij.openapi.project.Project;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.ide.ThreadUtils;
import jetbrains.mps.ide.ui.tree.MPSTreeNode;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.ide.ui.tree.smodel.SNodeTreeNode;
import jetbrains.mps.ide.ui.tree.smodel.SModelTreeNode;
import javax.swing.JComponent;
import javax.swing.tree.TreePath;

public class TargetChooser extends JBScrollPane implements ModelElementTargetChooser, Disposable {

  private TargetChooser_ProjectTree myTree;
  private ProjectTreeFindHelper myHelper;

  public TargetChooser(Project project, final TargetChooserOptions options) {
    super();
    myTree = new TargetChooser_ProjectTree(ProjectHelper.toMPSProject(project), options);
    myHelper = new ProjectTreeFindHelper(myTree);
    setViewportView(myTree);
    ThreadUtils.runInUIThreadNoWait(new Runnable() {
      public void run() {
        myTree.rebuildNow();
        myTree.runWithoutExpansion(new Runnable() {
          public void run() {
            MPSTreeNode treeNode = null;
            if (options.getInitial() instanceof SNode) {
              treeNode = myHelper.findMostSuitableSNodeTreeNode(((SNode) options.getInitial()));
            } else
            if (options.getInitial() instanceof SModel) {
              treeNode = myHelper.findMostSuitableModelTreeNode(((SModel) options.getInitial()));
            }
            if (treeNode == null) {
              return;
            }
            myTree.selectNode(treeNode);
          }
        });
      }
    });
  }

  @Override
  public SelectedTarget getSelectedObject() {
    Object selection = check_vvj485_a0a0g(myTree.getSelectionPath());
    SelectedTarget result = null;
    if (selection instanceof SNodeTreeNode) {
      result = new SelectedTarget(((SNodeTreeNode) selection).getSNode());
    } else
    if (selection instanceof SModelTreeNode) {
      result = new SelectedTarget(((SModelTreeNode) selection).getModel());
    }
    return result;
  }

  @Override
  public JComponent getComponent() {
    return this;
  }

  @Override
  public JComponent getPreferredFocusedComponent() {
    return getTree();
  }


  public TargetChooser_ProjectTree getTree() {
    return myTree;
  }

  @Override
  public void dispose() {
    myTree.dispose();
  }
  private static Object check_vvj485_a0a0g(TreePath checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getLastPathComponent();
    }
    return null;
  }
}
