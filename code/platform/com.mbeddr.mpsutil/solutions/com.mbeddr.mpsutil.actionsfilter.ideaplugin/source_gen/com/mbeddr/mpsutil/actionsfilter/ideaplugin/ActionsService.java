package com.mbeddr.mpsutil.actionsfilter.ideaplugin;

/*Generated by MPS */

import com.intellij.openapi.components.State;
import com.intellij.openapi.components.Storage;
import com.intellij.openapi.components.Service;
import com.intellij.openapi.components.PersistentStateComponent;
import com.mbeddr.mpsutil.actionsfilter.runtime.Model;
import com.intellij.openapi.application.ApplicationManager;
import com.mbeddr.mpsutil.actionsfilter.runtime.ActionFilter;
import com.mbeddr.mpsutil.actionsfilter.runtime.CustomToolBar;

@State(name = "ActionFilterSettings", storages = {@Storage(file = "actionFilter.xml")
})
@Service(Service.Level.APP)
public final class ActionsService implements PersistentStateComponent<Model> {

  public static ActionsService getInstance() {
    ActionsService result = ApplicationManager.getApplication().getService(ActionsService.class);
    return result;
  }

  /**
   * Updates are initially disabled because the service may be initialized earlier than the required services (e.g.
   * ActionManager) and are enabled from a post-startup project activity ({@link com.mbeddr.mpsutil.actionsfilter.ideaplugin.EnableActionFilterUpdates }), i.e. as
   * soon as a project (including the "welcome Screen" project) is created.
   */
  private volatile boolean enabled;
  private Model myState = new Model();

  /*package*/ void enableUpdates() {
    enabled = true;
  }

  public Model getState() {
    return myState;
  }

  @Override
  public void noStateLoaded() {
    loadState(new Model());
  }

  public void loadState(Model model) {
    myState = model;
    applyIfEnabled();
  }

  /*package*/ void applyIfEnabled() {
    if (enabled) {
      applyFilter();
      applyToolbar();
    }
  }

  public void applyFilter() {
    ActionFilter.getInstance().setFilters(myState);
  }

  public void applyToolbar() {
    CustomToolBar.getInstance().setToolBarEntries(myState);
  }

}
