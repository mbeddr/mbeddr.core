package com.mbeddr.mpsutil.ecore.ui.plugin;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.project.MPSProject;
import org.jetbrains.mps.openapi.module.SModuleReference;
import jetbrains.mps.ide.ui.dialogs.properties.choosers.CommonChoosers;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import org.jetbrains.mps.openapi.language.SLanguage;
import com.mbeddr.mpsutil.ecoreimporter.runtime.importerruntime.EcoreModelImporter;
import org.eclipse.emf.common.util.URI;
import java.io.File;
import com.mbeddr.mpsutil.ecoreimporter.runtime.importerruntime.EcoreModelExporter;
import com.mbeddr.mpsutil.ecoreimporter.runtime.importerruntime.EcoreFileImporter;
import java.util.Collection;
import jetbrains.mps.smodel.language.LanguageRegistry;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import java.util.Objects;
import java.util.List;
import java.util.LinkedHashSet;
import java.util.Collections;
import java.util.ArrayList;
import org.jetbrains.annotations.NotNull;
import javax.swing.JFileChooser;
import javax.swing.filechooser.FileNameExtensionFilter;

public class EcoreImporterUI {

  public static void importEcoreModel(final SModel modelToImportInto, final MPSProject project) {
    final SModuleReference ref = CommonChoosers.showModuleChooser(project, "Choose Language", collectLanguageModules(project));
    if (ref == null) {
      return;
    }
    final Wrappers._T<SLanguage> chosenLanguage = new Wrappers._T<SLanguage>();
    project.getModelAccess().runReadAction(() -> chosenLanguage.value = findLanguageByReference(ref, project));
    String ecoreFilename = pathOf("Ecore/Xcore files", "ecore", "xcore");
    if ((ecoreFilename != null && ecoreFilename.length() > 0)) {
      String xmlFileName = pathOf("XML model instance", "xml");
      if ((xmlFileName != null && xmlFileName.length() > 0)) {
        // TODO: Pass the project.repo
        EcoreModelImporter importer = new EcoreModelImporter(modelToImportInto, chosenLanguage.value, URI.createFileURI(ecoreFilename), URI.createFileURI(xmlFileName));
        importer.importEcoreModel(project.getRepository());
      }
    }
  }

  public static void exportEcoreModel(final SModel currModel, MPSProject project) {
    final String ecoreFilename = pathOf("Ecore/Xcore files", "ecore", "xcore");
    if ((ecoreFilename != null && ecoreFilename.length() > 0)) {
      File file = new File(ecoreFilename);
      final String pathToStore = file.toPath().getParent().toString();
      project.getRepository().getModelAccess().executeCommand(() -> {
        String pathToInstance = pathToStore + File.separator + currModel.getName().getSimpleName() + "_instance.xml";
        EcoreModelExporter exporter = new EcoreModelExporter(currModel, URI.createFileURI(ecoreFilename), URI.createFileURI(pathToInstance));
        exporter.exportEcoreModel();
      });
    }
  }

  public static void importEcoreFile(final SModel currModel, MPSProject project) {
    final String ecoreFilename = pathOf("Ecore/Xcore files", "ecore", "xcore");
    if ((ecoreFilename != null && ecoreFilename.length() > 0)) {
      project.getRepository().getModelAccess().executeCommand(() -> {
        EcoreFileImporter fileImporter = new EcoreFileImporter(currModel, ecoreFilename);
        fileImporter.importEcoreModelFile();
      });
    }
  }

  private static SLanguage findLanguageByReference(final SModuleReference ref, MPSProject project) {
    Collection<SLanguage> languages = LanguageRegistry.getInstance(project.getRepository()).getAllLanguages();
    return CollectionSequence.fromCollection(languages).findFirst((language) -> Objects.equals(language.getQualifiedName(), ref.getModuleName()));
  }

  private static List<SModuleReference> collectLanguageModules(final MPSProject myMpsProject) {
    final Collection<SModuleReference> moduleRefs = new LinkedHashSet<SModuleReference>();
    myMpsProject.getModelAccess().runReadAction(() -> {
      for (SLanguage lang : LanguageRegistry.getInstance(myMpsProject.getRepository()).getAllLanguages()) {
        moduleRefs.add(lang.getSourceModuleReference());
      }
    });
    return Collections.unmodifiableList(new ArrayList<SModuleReference>(moduleRefs));
  }

  private static String pathOf(@NotNull String description, @NotNull String... extension) {
    JFileChooser fileChooser = new JFileChooser();
    fileChooser.setFileFilter(new FileNameExtensionFilter(description, extension));
    if (fileChooser.showOpenDialog(null) == JFileChooser.APPROVE_OPTION) {
      return fileChooser.getSelectedFile().getAbsolutePath();
    }
    return "";
  }
}
