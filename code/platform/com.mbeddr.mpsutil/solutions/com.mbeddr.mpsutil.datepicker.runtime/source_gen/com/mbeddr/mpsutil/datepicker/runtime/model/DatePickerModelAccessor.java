package com.mbeddr.mpsutil.datepicker.runtime.model;

/*Generated by MPS */

import jetbrains.mps.nodeEditor.cells.ModelAccessor;
import com.michaelbaranov.microba.calendar.DatePicker;
import java.beans.PropertyVetoException;
import java.text.SimpleDateFormat;
import java.time.format.DateTimeFormatter;
import java.util.Date;
import java.time.format.DateTimeParseException;
import java.time.LocalDateTime;
import java.util.GregorianCalendar;
import java.time.LocalDate;
import java.util.Calendar;
import com.michaelbaranov.microba.calendar.VetoPolicy;
import java.text.ParseException;

public class DatePickerModelAccessor implements ModelAccessor {
  private final DatePicker datePicker;
  private EditorCell_DatePickerEntryField entryField;

  public DatePickerModelAccessor(DatePicker datePicker) {
    this.datePicker = datePicker;
  }

  public String getText() {
    return getLastModelText();
  }

  public void setText(String newText) {
    setText(newText, false);
  }

  protected void setText(String newText, boolean fixFormat) {
    setLastModelText(newText);

    if (isValidText(newText)) {
      try {
        DatePickerModelAccessor.this.datePicker.setDate(getDateFromString(newText));
        if (fixFormat) {
          setLastModelText(getDateFormat().format(DatePickerModelAccessor.this.datePicker.getDate()));
        }
      } catch (PropertyVetoException e) {
      }
    }
  }

  private SimpleDateFormat getDateFormat() {
    return as_ugshyy_a0a0l(this.datePicker.getDateFormat(), SimpleDateFormat.class);
  }

  private DateTimeFormatter getFormatter() {
    SimpleDateFormat dateFormat = as_ugshyy_a0a0a31(this.datePicker.getDateFormat(), SimpleDateFormat.class);
    return DateTimeFormatter.ofPattern(dateFormat.toLocalizedPattern());
  }

  private Date getDateFromString(String text) throws DateTimeParseException {
    if (this.datePicker.isKeepTime()) {
      LocalDateTime localDateTime = LocalDateTime.parse(text, getFormatter());
      return new GregorianCalendar(localDateTime.getYear(), localDateTime.getMonthValue() - 1, localDateTime.getDayOfMonth(), localDateTime.getHour(), localDateTime.getMinute(), localDateTime.getSecond()).getTime();
    } else {
      LocalDate localDate = LocalDate.parse(text, getFormatter());
      return new GregorianCalendar(localDate.getYear(), localDate.getMonthValue() - 1, localDate.getDayOfMonth()).getTime();
    }
  }

  protected String getLastModelText() {
    if (this.entryField != null) {
      return this.entryField.getLastModelText();
    } else {
      return null;
    }
  }

  protected void setLastModelText(String newText) {
    if (this.entryField != null) {
      this.entryField.setLastModelText(newText);
    }
  }

  public boolean isValidText(String newText) {
    if (newText == null) {
      return false;
    }
    try {
      getDateFromString(newText);

      Calendar calendar = this.datePicker.getDateFormat().getCalendar();
      calendar.setLenient(false);
      calendar.setTime(this.datePicker.getDateFormat().parse(newText));

      VetoPolicy vetoPolicy = this.datePicker.getVetoPolicy();
      if (vetoPolicy != null) {
        return !(vetoPolicy.isRestricted(this.datePicker, calendar));
      }
      return true;
    } catch (ParseException e) {
      return false;
    } catch (DateTimeParseException e) {
      return false;
    }
  }

  protected void setEntryField(EditorCell_DatePickerEntryField entryField) {
    this.entryField = entryField;
  }
  private static <T> T as_ugshyy_a0a0l(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_ugshyy_a0a0a31(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
