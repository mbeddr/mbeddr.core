package com.mbeddr.mpsutil.ecoreimporter.runtime.importerruntime;

/*Generated by MPS */

import org.eclipse.emf.ecore.EPackage;
import org.eclipse.emf.common.util.URI;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.resource.ResourceSet;
import org.eclipse.emf.ecore.resource.impl.ResourceSetImpl;
import org.eclipse.emf.ecore.xmi.impl.EcoreResourceFactoryImpl;
import org.eclipse.emf.ecore.xcore.XcoreStandaloneSetup;
import java.io.IOException;
import com.google.inject.Injector;

public class EMFUtils {
  public static EPackage getEPackage(URI fileURI) {
    Resource retResource = null;
    // Uses the EMF Api to gather the Ecore model as an EPackage given a fully qualified path to an ecore file as input
    if (fileURI.fileExtension().endsWith("xcore")) {
      retResource = getXCoreMetaModelNew(fileURI);
    } else if (fileURI.fileExtension().endsWith("ecore")) {
      retResource = getEcoreMetaModel(fileURI);
    }
    // TODO: Remove hack. Ugly cast to EPackage and also hard coded return of the first element in the Resource Set.
    EPackage retPackage = null;
    try {
      for (EObject object : retResource.getContents()) {
        if (object instanceof EPackage) {
          retPackage = ((EPackage) object);
          break;
        }
      }
    } catch (Exception e) {
    }
    return retPackage;
  }

  public static Resource getEcoreMetaModel(URI fileUri) {
    // Uses the EMF Api to gather the Ecore meta model as an EMF Resource given a fully qualified path to an ecore file as input
    ResourceSet resourceSet = new ResourceSetImpl();
    resourceSet.getResourceFactoryRegistry().getExtensionToFactoryMap().put("ecore", new EcoreResourceFactoryImpl());
    return resourceSet.getResource(fileUri, true);
  }

  public static Resource getXCoreMetaModel(URI fileURI) {
    Resource retResource = null;
    ResourceSet rs = new ResourceSetImpl();
    XcoreStandaloneSetup.doSetup();
    retResource = rs.getResource(fileURI, true);
    try {
      retResource.load(null);
    } catch (IOException e) {
    }
    return retResource;
  }

  public static Resource getXCoreMetaModelNew(URI fileURI) {
    // This method exists in order to circumvent the conflict when Module Class loader does not load all the information required for the XCORE Standalone setup
    Injector i = new XcoreStandaloneSetupModuleClassLoader().createInjectorAndDoEMFRegistration();
    ResourceSet rs = i.getInstance(ResourceSet.class);
    Resource r = rs.getResource(fileURI, true);
    try {
      r.load(null);
    } catch (IOException e) {
    }
    return r;
  }
}
