package com.mbeddr.mpsutil.ecoreimporter.runtime.importerruntime;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import java.io.File;
import com.mbeddr.mpsutil.smodule.runtime.lib.ModelHelper;
import java.util.ArrayList;
import org.jetbrains.mps.openapi.language.SLanguage;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.apache.commons.io.FileUtils;
import java.io.IOException;
import jetbrains.mps.project.AbstractModule;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.smodel.builder.SNodeBuilder;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class EcoreFileImporter {

  private SModel structureModel;
  private String fqEcoreFilePath;
  private String ECORE_FOLDER_NAME = "ecorefile";
  private int versionNo;


  public void importEcoreModelFile() {
    versionNo = ListSequence.fromList(SModelOperations.roots(structureModel, CONCEPTS.EcoreFileInfo$R6)).count() + 1;
    ECORE_FOLDER_NAME += "_V" + versionNo;
    if (ListSequence.fromList(SModelOperations.roots(structureModel, null)).isEmpty()) {
      MetaModelFreshImporter importer = new MetaModelFreshImporter(structureModel, true, fqEcoreFilePath);
      importer.importIntoMPS();
      createEcoreInfo(copyEcoreFileToLanguage());
    } else {
      MetaModelReImporter importer = new MetaModelReImporter(structureModel, true, fqEcoreFilePath);
      importer.reImportIntoMPS();
      createEcoreInfo(copyEcoreFileToLanguage());
    }
  }

  private void createEcoreInfo(File ecoreFile) {
    // This creates a sub-folder for every re-imported version of the current xcore file
    SModelOperations.addRootNode(structureModel, createEcoreFileInfo_99r9jt_a0a1a9(String.valueOf(versionNo), ECORE_FOLDER_NAME + File.separator + ecoreFile.getName()));
    ModelHelper.addLanguages(structureModel, ListSequence.fromListAndArray(new ArrayList<SLanguage>(), MetaAdapterFactory.getLanguage(0x77948de36ef9452dL, 0xb392d01403e4086fL, "")));
  }

  private File copyEcoreFileToLanguage() {
    File languageLocation = getLanguageLocation();
    File ecoreFolder = new File(languageLocation, ECORE_FOLDER_NAME);
    ecoreFolder.mkdir();
    File ecoreFile = new File(fqEcoreFilePath);
    try {
      FileUtils.copyFileToDirectory(ecoreFile, ecoreFolder);
    } catch (IOException e) {
      System.out.println("Copying of ecore info file failed " + e.getMessage());
    }
    return new File(ecoreFolder, ecoreFile.getName());
  }

  private File getLanguageLocation() {
    assert structureModel.getModule() instanceof AbstractModule;
    AbstractModule module = (AbstractModule) (structureModel.getModule());
    File moduleSourceDir = new File(module.getModuleSourceDir().getPath());
    return moduleSourceDir;
  }
  public EcoreFileImporter(@NotNull SModel structModel, @NotNull String fqEcorFilePath) {
    structureModel = structModel;
    assert (fqEcorFilePath != null && fqEcorFilePath.length() > 0);
    fqEcoreFilePath = fqEcorFilePath;
  }
  private static SNode createEcoreFileInfo_99r9jt_a0a1a9(String p0, String p1) {
    SNodeBuilder n0 = new SNodeBuilder().init(CONCEPTS.EcoreFileInfo$R6);
    n0.setProperty(PROPS.version$jkEE, p0);
    {
      SNodeBuilder n1 = n0.forChild(LINKS.pathToEcoreFile$l64J).init(CONCEPTS.SolutionRelativeFilePicker$hz);
      n1.setProperty(PROPS.path$VaYg, p1);
    }
    return n0.getResult();
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept EcoreFileInfo$R6 = MetaAdapterFactory.getConcept(0x77948de36ef9452dL, 0xb392d01403e4086fL, 0x55c6b95ae38aa2edL, "com.mbeddr.mpsutil.ecore.structure.EcoreFileInfo");
    /*package*/ static final SConcept SolutionRelativeFilePicker$hz = MetaAdapterFactory.getConcept(0xd3a0fd26445a466cL, 0x900e10444ddfed52L, 0x55705e73a687136fL, "com.mbeddr.mpsutil.filepicker.structure.SolutionRelativeFilePicker");
  }

  private static final class PROPS {
    /*package*/ static final SProperty version$jkEE = MetaAdapterFactory.getProperty(0x77948de36ef9452dL, 0xb392d01403e4086fL, 0x55c6b95ae38aa2edL, 0x31c5c744474f102eL, "version");
    /*package*/ static final SProperty path$VaYg = MetaAdapterFactory.getProperty(0xd3a0fd26445a466cL, 0x900e10444ddfed52L, 0x55705e73a6773808L, 0x55705e73a6774a6eL, "path");
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink pathToEcoreFile$l64J = MetaAdapterFactory.getContainmentLink(0x77948de36ef9452dL, 0xb392d01403e4086fL, 0x55c6b95ae38aa2edL, 0x55c6b95ae38aa309L, "pathToEcoreFile");
  }
}
